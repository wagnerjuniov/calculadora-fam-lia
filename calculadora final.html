<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Financeira Pessoal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ===== IN√çCIO: ESTILOS_CSS ============================== -->
    <style>
        :root {
            /* Light Theme (default) */
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --primary-color: #007aff;
            --success-color: #34c759;
            --danger-color: #ff3b30;
            --warning-color: #ffcc00;
            --neutral-color: #8e8e93;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --hover-color: rgba(0, 0, 0, 0.03);
            --modal-backdrop: rgba(0, 0, 0, 0.5);
            --backdrop-blur: blur(10px);
            --transition-time: 0.3s;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-color: #121212;
            --card-bg: #1c1c1e;
            --text-color: #f2f2f2;
            --text-secondary: #ababab;
            --border-color: #2c2c2e;
            --primary-color: #0a84ff;
            --success-color: #30d158;
            --danger-color: #ff453a;
            --warning-color: #ffd60a;
            --neutral-color: #98989d;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            --hover-color: rgba(255, 255, 255, 0.05);
            --modal-backdrop: rgba(0, 0, 0, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-time), color var(--transition-time);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            line-height: 1.5;
        }

        /* Header Styles */
        header {
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            transition: background-color var(--transition-time);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .selectors-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .actions-container {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown select {
            appearance: none;
            -webkit-appearance: none;
            padding: 0.625rem 2rem 0.625rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            transition: border-color var(--transition-time), background-color var(--transition-time);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1rem;
        }

        .dropdown select:hover {
            border-color: var(--primary-color);
        }

        [data-theme="dark"] .dropdown select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23f2f2f2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            gap: 0.5rem;
            outline: none;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: transparent;
            color: var(--text-color);
        }

        .btn-icon:hover {
            background-color: var(--hover-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-neutral {
            background-color: var(--neutral-color);
            color: white;
        }

        .btn-neutral:hover {
            opacity: 0.9;
        }

        /* Main Container */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* KPI Cards Container */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        /* KPI Card */
        .kpi-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            padding: 1.25rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color var(--transition-time);
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .kpi-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .kpi-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .kpi-success {
            color: var(--success-color);
        }

        .kpi-danger {
            color: var(--danger-color);
        }

        .kpi-warning {
            color: var(--warning-color);
        }

        /* Table Styles */
        .table-container {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: background-color var(--transition-time);
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr {
            background-color: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] thead tr {
            background-color: rgba(255, 255, 255, 0.02);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 500;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            transition: color var(--transition-time);
        }

        td {
            padding: 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-time);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: var(--hover-color);
        }

        .transaction-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
            font-size: 1rem;
        }

        [data-theme="dark"] .transaction-icon {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .transaction-name {
            font-weight: 500;
        }

        .transaction-category {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-secondary);
        }

        [data-theme="dark"] .transaction-category {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .transaction-value {
            font-weight: 500;
        }

        .value-expense {
            color: var(--danger-color);
        }

        .value-income {
            color: var(--success-color);
        }

        .transaction-status {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-paid {
            background-color: rgba(52, 199, 89, 0.15);
            color: var(--success-color);
        }

        .status-pending {
            background-color: rgba(255, 204, 0, 0.15);
            color: var(--warning-color);
        }

        .status-scheduled {
            background-color: rgba(0, 122, 255, 0.15);
            color: var(--primary-color);
        }

        .transaction-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 0.375rem;
            border: none;
            background-color: var(--hover-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .action-btn.delete:hover {
            background-color: var(--danger-color);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Custom Checkbox */
        .custom-checkbox {
            position: relative;
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }

        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: all 0.2s ease;
        }

        .custom-checkbox input:checked ~ .checkmark {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .custom-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .custom-checkbox .checkmark:after {
            left: 8px;
            top: 3px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-backdrop);
            backdrop-filter: var(--backdrop-blur);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 90%;
            max-width: 500px;
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .modal-backdrop.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .modal-close:hover {
            background-color: var(--hover-color);
        }

        .modal-body {
            padding: 1.25rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.875rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            outline: none;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }

        .form-control-icon {
            position: relative;
        }

        .form-control-icon .form-control {
            padding-left: 2.5rem;
        }

        .form-control-icon .icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .form-select {
            appearance: none;
            -webkit-appearance: none;
            padding-right: 2rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        [data-theme="dark"] .form-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23f2f2f2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }

        /* Radio Buttons */
        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .radio-container {
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 1.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            user-select: none;
        }

        .radio-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .radio-checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 1rem;
            width: 1rem;
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: 50%;
        }

        .radio-container:hover input ~ .radio-checkmark {
            border-color: var(--primary-color);
        }

        .radio-container input:checked ~ .radio-checkmark {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .radio-checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .radio-container input:checked ~ .radio-checkmark:after {
            display: block;
        }

        .radio-container .radio-checkmark:after {
            top: 0.25rem;
            left: 0.25rem;
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: white;
        }

        /* Icon Picker */
        .icon-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .icon-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-option:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .icon-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 122, 255, 0.1);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.5rem;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 1.5rem;
        }

        .theme-toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0.125rem;
            bottom: 0.125rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .theme-toggle input:checked + .theme-toggle-slider {
            background-color: var(--primary-color);
        }

        .theme-toggle input:checked + .theme-toggle-slider:before {
            transform: translateX(1.5rem);
        }

        /* Credit Card Section */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .credit-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            padding: 1.25rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color var(--transition-time);
        }

        .credit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .credit-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .credit-card-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .credit-card-details {
            margin-bottom: 1rem;
        }

        .credit-card-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .credit-card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .credit-card-value {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .credit-card-dates {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .credit-card-date {
            display: flex;
            flex-direction: column;
        }

        .credit-card-bill {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        /* Responsive Styles */
        @media (max-width: 767px) {
            header {
                flex-direction: column;
                align-items: stretch;
            }

            .selectors-container {
                width: 100%;
                justify-content: space-between;
            }

            .actions-container {
                width: 100%;
                justify-content: space-between;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 800px;
            }

            .modal {
                width: 95%;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .kpi-container {
                grid-template-columns: 1fr;
            }

            .transaction-card {
                padding: 1rem;
            }

            .credit-card {
                padding: 1rem;
            }

            .icon-picker {
                grid-template-columns: repeat(6, 1fr);
            }

            .radio-group {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Alert Styles */
        .alert {
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background-color: rgba(52, 199, 89, 0.1);
            border-left: 4px solid var(--success-color);
            color: var(--success-color);
        }

        .alert-danger {
            background-color: rgba(255, 59, 48, 0.1);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
        }

        .alert-warning {
            background-color: rgba(255, 204, 0, 0.1);
            border-left: 4px solid var(--warning-color);
            color: var(--warning-color);
        }

        .alert-info {
            background-color: rgba(0, 122, 255, 0.1);
            border-left: 4px solid var(--primary-color);
            color: var(--primary-color);
        }
    </style>
    <!-- ===== FIM: ESTILOS_CSS ================================ -->

<!-- ===== IN√çCIO: HEADER ============================== -->
<header>
    <div class="selectors-container">
        <div class="dropdown">
            <select id="year-select" class="form-select">
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
            </select>
        </div>
        <div class="dropdown">
            <select id="month-select" class="form-select">
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Mar√ßo</option>
                <option value="4" selected>Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
                </select>
            </div>
        </div>
        <div class="actions-container">
            <button id="btn-new-income" class="btn btn-success">
                + Nova Receita
            </button>
            <button id="btn-new-expense" class="btn btn-danger">
                + Nova Despesa
            </button>
            <button id="btn-credit-cards" class="btn btn-primary">
                Cart√µes
            </button>
            <button id="theme-toggle-btn" class="btn-icon" title="Alternar tema">
                <span class="theme-icon">üåô</span>
            </button>
        </div>
    </header>
<!-- ===== FIM: HEADER ================================ -->

<!-- ===== IN√çCIO: CONTE√öDO_PRINCIPAL ============================== -->
<main class="container">
    <!-- KPI Cards -->
    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-title">Saldo Atual</div>
            <div class="kpi-value" id="balance">R$ 0,00</div>
            <div class="kpi-subtitle">
                <span id="balance-status" class="kpi-success">Saud√°vel</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Receitas</div>
            <div class="kpi-value" id="income-total">R$ 0,00</div>
            <div class="kpi-subtitle">
                <span id="income-received">R$ 0,00</span> recebidas | 
                <span id="income-pending">R$ 0,00</span> pendentes
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Despesas</div>
            <div class="kpi-value" id="expense-total">R$ 0,00</div>
            <div class="kpi-subtitle">
                <span id="expense-paid">R$ 0,00</span> pagas | 
                <span id="expense-pending">R$ 0,00</span> pendentes
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Fatura Atual</div>
            <div class="kpi-value" id="credit-card-bill">R$ 0,00</div>
            <div class="kpi-subtitle">
                <span id="credit-card-status">Nenhum cart√£o cadastrado</span>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="table-container">
        <div class="table-header">
            <div class="table-title">Transa√ß√µes</div>
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>√çcone</th>
                        <th>Nome</th>
                        <th>Categoria</th>
                        <th>Lan√ßamento</th>
                        <th>Vencimento</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Forma Pagamento</th>
                        <th>Pago?</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="transactions-table">
                    <!-- Transactions will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</main>
<!-- ===== FIM: CONTE√öDO_PRINCIPAL ================================ -->

<!-- ===== IN√çCIO: MODAIS ============================== -->
<!-- Modal Nova Receita -->
<div class="modal-backdrop" id="modal-new-income">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Nova Receita</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <form id="income-form">
                <div class="form-group">
                    <label class="form-label">√çcone</label>
                    <div class="icon-picker" id="income-icon-picker">
                        <div class="icon-option selected" data-icon="üí∞">üí∞</div>
                        <div class="icon-option" data-icon="üíº">üíº</div>
                        <div class="icon-option" data-icon="üè¶">üè¶</div>
                        <div class="icon-option" data-icon="üíµ">üíµ</div>
                        <div class="icon-option" data-icon="üè¢">üè¢</div>
                        <div class="icon-option" data-icon="üéì">üéì</div>
                        <div class="icon-option" data-icon="üöó">üöó</div>
                        <div class="icon-option" data-icon="üè†">üè†</div>
                        <div class="icon-option" data-icon="üì±">üì±</div>
                        <div class="icon-option" data-icon="üéÆ">üéÆ</div>
                        <div class="icon-option" data-icon="üìö">üìö</div>
                        <div class="icon-option" data-icon="üé®">üé®</div>
                    </div>
                    <input type="hidden" id="income-icon" name="icon" value="üí∞">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="income-name">Nome</label>
                        <input type="text" class="form-control" id="income-name" name="name" placeholder="Ex: Sal√°rio">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="income-value">Valor</label>
                        <input type="number" class="form-control" id="income-value" name="value" placeholder="0,00" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="income-category">Categoria</label>
                        <select class="form-control form-select" id="income-category" name="category">
                            <option value="Sal√°rio">Sal√°rio</option>
                            <option value="Freelance">Freelance</option>
                            <option value="Investimentos">Investimentos</option>
                            <option value="Aluguel">Aluguel</option>
                            <option value="Vendas">Vendas</option>
                            <option value="Presente">Presente</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="income-date">Data de Lan√ßamento</label>
                        <input type="date" class="form-control" id="income-date" name="date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="radio-group">
                        <label class="radio-container">
                            Recebido
                            <input type="radio" name="status" value="Recebido" checked>
                            <span class="radio-checkmark"></span>
                        </label>
                        <label class="radio-container">
                            A Receber
                            <input type="radio" name="status" value="A Receber">
                            <span class="radio-checkmark"></span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="income-payment-method">Forma de Recebimento</label>
                    <select class="form-control form-select" id="income-payment-method" name="paymentMethod">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Transfer√™ncia">Transfer√™ncia</option>
                        <option value="Dep√≥sito">Dep√≥sito</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="income-recurring" name="recurring">
                        <label class="form-check-label" for="income-recurring">Recorrente?</label>
                    </div>
                </div>
                <div class="form-group" id="income-installments-group" style="display: none;">
                    <label class="form-label" for="income-installments">N√∫mero de Parcelas</label>
                    <input type="number" class="form-control" id="income-installments" name="installments" min="2" max="60" value="2">
                </div>
                <div class="form-group">
                    <label class="form-label" for="income-notes">Observa√ß√£o (opcional)</label>
                    <textarea class="form-control" id="income-notes" name="notes" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-neutral" data-close-modal>Cancelar</button>
            <button class="btn btn-success" id="save-income">Salvar Receita</button>
        </div>
    </div>
</div>

<!-- Modal Nova Despesa -->
<div class="modal-backdrop" id="modal-new-expense">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Nova Despesa</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <form id="expense-form">
                <div class="form-group">
                    <label class="form-label">√çcone</label>
                    <div class="icon-picker" id="expense-icon-picker">
                        <div class="icon-option selected" data-icon="üõí">üõí</div>
                        <div class="icon-option" data-icon="üè†">üè†</div>
                        <div class="icon-option" data-icon="üöó">üöó</div>
                        <div class="icon-option" data-icon="üçî">üçî</div>
                        <div class="icon-option" data-icon="üíä">üíä</div>
                        <div class="icon-option" data-icon="üéì">üéì</div>
                        <div class="icon-option" data-icon="‚úàÔ∏è">‚úàÔ∏è</div>
                        <div class="icon-option" data-icon="üé≠">üé≠</div>
                        <div class="icon-option" data-icon="üèãÔ∏è">üèãÔ∏è</div>
                        <div class="icon-option" data-icon="üëï">üëï</div>
                        <div class="icon-option" data-icon="üì±">üì±</div>
                        <div class="icon-option" data-icon="üîå">üîå</div>
                    </div>
                    <input type="hidden" id="expense-icon" name="icon" value="üõí">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="expense-name">Nome</label>
                        <input type="text" class="form-control" id="expense-name" name="name" placeholder="Ex: Mercado">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expense-value">Valor</label>
                        <input type="number" class="form-control" id="expense-value" name="value" placeholder="0,00" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="expense-category">Categoria</label>
                        <select class="form-control form-select" id="expense-category" name="category">
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Moradia">Moradia</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Sa√∫de">Sa√∫de</option>
                            <option value="Educa√ß√£o">Educa√ß√£o</option>
                            <option value="Lazer">Lazer</option>
                            <option value="Vestu√°rio">Vestu√°rio</option>
                            <option value="Tecnologia">Tecnologia</option>
                            <option value="Servi√ßos">Servi√ßos</option>
                            <option value="Impostos">Impostos</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expense-date">Data de Lan√ßamento</label>
                        <input type="date" class="form-control" id="expense-date" name="date">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="expense-due-date">Data de Vencimento</label>
                        <input type="date" class="form-control" id="expense-due-date" name="dueDate">
                    </div>
                    <div class="form-group" id="expense-scheduled-date-group" style="display: none;">
                        <label class="form-label" for="expense-scheduled-date">Data de Agendamento</label>
                        <input type="date" class="form-control" id="expense-scheduled-date" name="scheduledDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="radio-group">
                        <label class="radio-container">
                            Pago
                            <input type="radio" name="status" value="Pago" checked>
                            <span class="radio-checkmark"></span>
                        </label>
                        <label class="radio-container">
                            Pendente
                            <input type="radio" name="status" value="Pendente">
                            <span class="radio-checkmark"></span>
                        </label>
                        <label class="radio-container">
                            Agendado
                            <input type="radio" name="status" value="Agendado">
                            <span class="radio-checkmark"></span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-payment-method">Forma de Pagamento</label>
                    <select class="form-control form-select" id="expense-payment-method" name="paymentMethod">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="D√©bito">D√©bito</option>
                        <option value="D√©bito em Conta">D√©bito em Conta</option>
                        <option value="Transfer√™ncia">Transfer√™ncia</option>
                        <option value="Boleto">Boleto</option>
                        <option value="Cr√©dito">Cr√©dito</option>
                    </select>
                </div>
                <div class="form-group" id="expense-credit-card-group" style="display: none;">
                    <label class="form-label" for="expense-credit-card">Cart√£o de Cr√©dito</label>
                    <select class="form-control form-select" id="expense-credit-card" name="creditCard">
                        <!-- Credit cards will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="expense-recurring" name="recurring">
                        <label class="form-check-label" for="expense-recurring">Recorrente?</label>
                    </div>
                </div>
                <div class="form-group" id="expense-installments-group" style="display: none;">
                    <label class="form-label" for="expense-installments">N√∫mero de Parcelas</label>
                    <input type="number" class="form-control" id="expense-installments" name="installments" min="2" max="60" value="2">
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-notes">Observa√ß√£o (opcional)</label>
                    <textarea class="form-control" id="expense-notes" name="notes" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-neutral" data-close-modal>Cancelar</button>
            <button class="btn btn-danger" id="save-expense">Salvar Despesa</button>
        </div>
    </div>
</div>

<!-- Modal Editar Transa√ß√£o -->
<div class="modal-backdrop" id="modal-edit-transaction">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="edit-modal-title">Editar Transa√ß√£o</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-type">
                <div class="form-group">
                    <label class="form-label">√çcone</label>
                    <div class="icon-picker" id="edit-icon-picker">
                        <!-- Icons will be loaded here -->
                    </div>
                    <input type="hidden" id="edit-icon" name="icon">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="edit-name">Nome</label>
                        <input type="text" class="form-control" id="edit-name" name="name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-value">Valor</label>
                        <input type="number" class="form-control" id="edit-value" name="value" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="edit-category">Categoria</label>
                        <select class="form-control form-select" id="edit-category" name="category">
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-date">Data de Lan√ßamento</label>
                        <input type="date" class="form-control" id="edit-date" name="date">
                    </div>
                </div>
                <div class="form-grid" id="edit-due-date-container">
                    <div class="form-group">
                        <label class="form-label" for="edit-due-date">Data de Vencimento</label>
                        <input type="date" class="form-control" id="edit-due-date" name="dueDate">
                    </div>
                    <div class="form-group" id="edit-scheduled-date-group" style="display: none;">
                        <label class="form-label" for="edit-scheduled-date">Data de Agendamento</label>
                        <input type="date" class="form-control" id="edit-scheduled-date" name="scheduledDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="radio-group" id="edit-status-group">
                        <!-- Status options will be loaded here -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-payment-method">Forma de Pagamento</label>
                    <select class="form-control form-select" id="edit-payment-method" name="paymentMethod">
                        <!-- Payment methods will be loaded here -->
                    </select>
                </div>
                <div class="form-group" id="edit-credit-card-group" style="display: none;">
                    <label class="form-label" for="edit-credit-card">Cart√£o de Cr√©dito</label>
                    <select class="form-control form-select" id="edit-credit-card" name="creditCard">
                        <!-- Credit cards will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="edit-recurring" name="recurring">
                        <label class="form-check-label" for="edit-recurring">Recorrente?</label>
                    </div>
                </div>
                <div class="form-group" id="edit-installments-group" style="display: none;">
                    <label class="form-label" for="edit-installments">N√∫mero de Parcelas</label>
                    <input type="number" class="form-control" id="edit-installments" name="installments" min="2" max="60" value="2">
                </div>
                <div class="form-group" id="edit-recurrence-options" style="display: none;">
                    <label class="form-label">Editar Recorr√™ncia</label>
                    <div class="radio-group">
                        <label class="radio-container">
                            Apenas esta parcela
                            <input type="radio" name="recurrenceEdit" value="single" checked>
                            <span class="radio-checkmark"></span>
                        </label>
                        <label class="radio-container">
                            Todas as parcelas futuras
                            <input type="radio" name="recurrenceEdit" value="all">
                            <span class="radio-checkmark"></span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-notes">Observa√ß√£o (opcional)</label>
                    <textarea class="form-control" id="edit-notes" name="notes" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-neutral" data-close-modal>Cancelar</button>
            <button class="btn btn-primary" id="save-edit">Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclus√£o -->
<div class="modal-backdrop" id="modal-confirm-delete">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Confirmar Exclus√£o</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <p>Voc√™ deseja realmente excluir esta transa√ß√£o? Esta a√ß√£o √© irrevers√≠vel.</p>
            <div id="delete-recurrence-options" style="display: none; margin-top: 1rem;">
                <label class="form-label">Op√ß√µes de Exclus√£o</label>
                <div class="radio-group">
                    <label class="radio-container">
                        Excluir apenas esta parcela
                        <input type="radio" name="recurrenceDelete" value="single" checked>
                        <span class="radio-checkmark"></span>
                    </label>
                    <label class="radio-container">
                        Excluir todas as parcelas futuras
                        <input type="radio" name="recurrenceDelete" value="all">
                        <span class="radio-checkmark"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-neutral" data-close-modal>Cancelar</button>
            <button class="btn btn-danger" id="confirm-delete">Excluir</button>
        </div>
    </div>
</div>

<!-- Modal Cart√µes de Cr√©dito -->
<div class="modal-backdrop" id="modal-credit-cards">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Cart√µes de Cr√©dito</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <div id="credit-cards-container" class="cards-container">
                <!-- Credit cards will be loaded here -->
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <button class="btn btn-primary" id="btn-new-card">+ Novo Cart√£o</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Cart√£o -->
<div class="modal-backdrop" id="modal-new-card">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Novo Cart√£o de Cr√©dito</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <form id="card-form">
                <div class="form-group">
                    <label class="form-label" for="card-name">Nome do Cart√£o</label>
                    <input type="text" class="form-control" id="card-name" name="name" placeholder="Ex: Nubank">
                </div>
                <div class="form-group">
                    <label class="form-label" for="card-limit">Limite Total</label>
                    <input type="number" class="form-control" id="card-limit" name="limit" placeholder="0,00" step="0.01" min="0">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="card-closing-day">Dia de Fechamento</label>
                        <input type="number" class="form-control" id="card-closing-day" name="closingDay" min="1" max="31" placeholder="Ex: 5">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="card-due-day">Dia de Vencimento</label>
                        <input type="number" class="form-control" id="card-due-day" name="dueDay" min="1" max="31" placeholder="Ex: 15">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-neutral" data-close-modal>Cancelar</button>
            <button class="btn btn-primary" id="save-card">Salvar Cart√£o</button>
        </div>
    </div>
</div>

<!-- Modal Fatura do Cart√£o -->
<div class="modal-backdrop" id="modal-card-bill">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="card-bill-title">Fatura do Cart√£o</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <div class="card-bill-details">
                <div class="form-group">
                    <div class="kpi-card">
                        <div class="kpi-title">Resumo da Fatura</div>
                        <div class="kpi-value" id="card-bill-value">R$ 0,00</div>
                        <div class="kpi-subtitle">
                            Vencimento: <span id="card-bill-due-date">--/--</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Despesas na Fatura</div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="card-bill-table">
                            <!-- Card bill expenses will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-neutral" data-close-modal>Cancelar</button>
            <button class="btn btn-primary" id="pay-card-bill">Pagar Fatura</button>
        </div>
    </div>
</div>

<!-- Modal Confirmar Pagamento -->
<div class="modal-backdrop" id="modal-confirm-payment">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Confirmar Pagamento</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <p>Confirmar pagamento de todas as despesas desta fatura?</p>
            <p>Valor total: <strong id="confirm-payment-value">R$ 0,00</strong></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-neutral" data-close-modal>Cancelar</button>
            <button class="btn btn-primary" id="confirm-payment">Pagar</button>
        </div>
    </div>
</div>

<!-- Modal Sucesso -->
<div class="modal-backdrop" id="modal-success">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Sucesso!</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <p id="success-message">Opera√ß√£o realizada com sucesso.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-success" data-close-modal>Ok</button>
        </div>
    </div>
</div>

<!-- Modal Erro -->
<div class="modal-backdrop" id="modal-error">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Erro!</div>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
            <p id="error-message">Algo deu errado. Por favor, tente novamente.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" data-close-modal>Fechar</button>
        </div>
    </div>
</div>
<!-- ===== FIM: MODAIS ================================ -->

    <!-- ===== IN√çCIO: SCRIPTS_FIREBASE ============================== -->
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJECT_ID.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJECT_ID.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        
        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    <!-- ===== FIM: SCRIPTS_FIREBASE ================================ -->

<!-- ===== IN√çCIO: SCRIPTS_APLICACAO ============================== -->
<script>
    // ===== Vari√°veis Globais e Estado da Aplica√ß√£o =====
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let currentTheme = 'light';
    let transactions = [];
    let creditCards = [];
    let selectedTransactionId = null;
    let selectedCardId = null;

    // ===== Seletores de Elementos DOM =====
    const yearSelect = document.getElementById('year-select');
    const monthSelect = document.getElementById('month-select');
    const btnNewIncome = document.getElementById('btn-new-income');
    const btnNewExpense = document.getElementById('btn-new-expense');
    const btnCreditCards = document.getElementById('btn-credit-cards');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const transactionsTable = document.getElementById('transactions-table');

    // Modais
    const modalBackdrops = document.querySelectorAll('.modal-backdrop');
    const modalNewIncome = document.getElementById('modal-new-income');
    const modalNewExpense = document.getElementById('modal-new-expense');
    const modalEditTransaction = document.getElementById('modal-edit-transaction');
    const modalConfirmDelete = document.getElementById('modal-confirm-delete');
    const modalCreditCards = document.getElementById('modal-credit-cards');
    const modalNewCard = document.getElementById('modal-new-card');
    const modalCardBill = document.getElementById('modal-card-bill');
    const modalConfirmPayment = document.getElementById('modal-confirm-payment');
    const modalSuccess = document.getElementById('modal-success');
    const modalError = document.getElementById('modal-error');

    // Bot√µes de Salvar
    const saveIncomeBtn = document.getElementById('save-income');
    const saveExpenseBtn = document.getElementById('save-expense');
    const saveEditBtn = document.getElementById('save-edit');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    const btnNewCard = document.getElementById('btn-new-card');
    const saveCardBtn = document.getElementById('save-card');
    const payCardBillBtn = document.getElementById('pay-card-bill');
    const confirmPaymentBtn = document.getElementById('confirm-payment');

    // Elementos de formul√°rio
    const incomeForm = document.getElementById('income-form');
    const expenseForm = document.getElementById('expense-form');
    const editForm = document.getElementById('edit-form');
    const cardForm = document.getElementById('card-form');

    // KPIs e Elementos de Visualiza√ß√£o
    const balanceElement = document.getElementById('balance');
    const balanceStatusElement = document.getElementById('balance-status');
    const incomeTotalElement = document.getElementById('income-total');
    const incomeReceivedElement = document.getElementById('income-received');
    const incomePendingElement = document.getElementById('income-pending');
    const expenseTotalElement = document.getElementById('expense-total');
    const expensePaidElement = document.getElementById('expense-paid');
    const expensePendingElement = document.getElementById('expense-pending');
    const creditCardBillElement = document.getElementById('credit-card-bill');
    const creditCardStatusElement = document.getElementById('credit-card-status');

    // ===== Inicializa√ß√£o da Aplica√ß√£o =====
    document.addEventListener('DOMContentLoaded', async () => {
        setupEventListeners();
        setupDateDefaults();
        loadInitialData();
        applyTheme();
    });

// ===== Setup de Event Listeners =====
    function setupEventListeners() {
        // Seletores de M√™s e Ano
        yearSelect.addEventListener('change', handlePeriodChange);
        monthSelect.addEventListener('change', handlePeriodChange);

        // Bot√µes de A√ß√µes Principais
        btnNewIncome.addEventListener('click', () => openModal(modalNewIncome));
        btnNewExpense.addEventListener('click', () => openModal(modalNewExpense));
        btnCreditCards.addEventListener('click', () => openCreditCardsModal());
        themeToggleBtn.addEventListener('click', toggleTheme);

        // Eventos de Formul√°rios
        document.getElementById('income-recurring').addEventListener('change', toggleRecurringFields);
        document.getElementById('expense-recurring').addEventListener('change', toggleRecurringFields);
        document.getElementById('edit-recurring').addEventListener('change', toggleRecurringFields);

        // Eventos de Status e Forma de Pagamento
        document.querySelectorAll('input[name="status"]').forEach(radio => {
            radio.addEventListener('change', handleStatusChange);
        });
        document.getElementById('expense-payment-method').addEventListener('change', handlePaymentMethodChange);
        document.getElementById('edit-payment-method').addEventListener('change', handlePaymentMethodChange);

        // Eventos de Sele√ß√£o de √çcones
        setupIconPickers();

        // Bot√µes de Salvar e Confirmar
        saveIncomeBtn.addEventListener('click', saveIncome);
        saveExpenseBtn.addEventListener('click', saveExpense);
        saveEditBtn.addEventListener('click', saveEdit);
        confirmDeleteBtn.addEventListener('click', deleteTransaction);
        btnNewCard.addEventListener('click', () => openModal(modalNewCard));
        saveCardBtn.addEventListener('click', saveCard);
        payCardBillBtn.addEventListener('click', preparePayCardBill);
        confirmPaymentBtn.addEventListener('click', payCardBill);

        // Fechar Modais
        document.querySelectorAll('[data-close-modal]').forEach(element => {
            element.addEventListener('click', closeCurrentModal);
        });

        // Fechar Modal ao Clicar Fora
        modalBackdrops.forEach(backdrop => {
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) {
                    closeCurrentModal();
                }
            });
        });

        // Pressionar ESC para fechar modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCurrentModal();
            }
        });
    }

    // ===== Configura√ß√£o de Datas Padr√£o =====
    function setupDateDefaults() {
        const today = new Date();
        const formattedDate = formatDateForInput(today);
        
        // Configurar datas para o m√™s atual
        yearSelect.value = today.getFullYear();
        monthSelect.value = today.getMonth() + 1;
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        
        // Configurar datas padr√£o para formul√°rios
        document.getElementById('income-date').value = formattedDate;
        document.getElementById('expense-date').value = formattedDate;
        document.getElementById('expense-due-date').value = formattedDate;
    }

    // ===== Carregamento de Dados Iniciais =====
    async function loadInitialData() {
        await Promise.all([
            loadTransactions(),
            loadCreditCards()
        ]);
        updateKPIs();
    }

    // ===== FUN√á√ïES DE CARREGAMENTO DE DADOS =====
    
    // Carregar Transa√ß√µes do Per√≠odo Atual
    async function loadTransactions() {
        try {
            const startDate = new Date(currentYear, currentMonth - 1, 1);
            const endDate = new Date(currentYear, currentMonth, 0);
            
            const snapshot = await db.collection("transactions")
                .where("date", ">=", startDate)
                .where("date", "<=", endDate)
                .get();
            
            transactions = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                transactions.push({
                    id: doc.id,
                    ...data,
                    date: data.date.toDate(),
                    dueDate: data.dueDate ? data.dueDate.toDate() : null,
                    scheduledDate: data.scheduledDate ? data.scheduledDate.toDate() : null
                });
            });
            
            renderTransactionsTable();
        } catch (error) {
            showError("Erro ao carregar transa√ß√µes: " + error.message);
        }
    }
    
    // Carregar Cart√µes de Cr√©dito
    async function loadCreditCards() {
        try {
            const snapshot = await db.collection("creditCards").get();
            
            creditCards = [];
            snapshot.forEach(doc => {
                creditCards.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            updateCreditCardSelects();
            updateCreditCardKPI();
        } catch (error) {
            showError("Erro ao carregar cart√µes: " + error.message);
        }
    }

// Carregar Fatura do Cart√£o
    async function loadCardBill(cardId) {
        try {
            const card = creditCards.find(card => card.id === cardId);
            if (!card) return [];
            
            const currentDate = new Date();
            const currentDay = currentDate.getDate();
            
            // Determinar o per√≠odo da fatura atual
            let billStartDate, billEndDate;
            
            if (currentDay >= card.closingDay) {
                // Estamos ap√≥s o fechamento deste m√™s, ent√£o a fatura atual √© do pr√≥ximo m√™s
                billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), card.closingDay);
                billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, card.closingDay - 1);
            } else {
                // Estamos antes do fechamento deste m√™s, ent√£o a fatura atual √© deste m√™s
                billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, card.closingDay);
                billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), card.closingDay - 1);
            }
            
            const snapshot = await db.collection("transactions")
                .where("type", "==", "expense")
                .where("paymentMethod", "==", "Cr√©dito")
                .where("creditCardId", "==", cardId)
                .where("date", ">=", billStartDate)
                .where("date", "<=", billEndDate)
                .get();
            
            const billItems = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                billItems.push({
                    id: doc.id,
                    ...data,
                    date: data.date.toDate(),
                    dueDate: data.dueDate ? data.dueDate.toDate() : null
                });
            });
            
            return {
                card,
                startDate: billStartDate,
                endDate: billEndDate,
                dueDate: new Date(billEndDate.getFullYear(), billEndDate.getMonth(), card.dueDay),
                items: billItems
            };
        } catch (error) {
            showError("Erro ao carregar fatura: " + error.message);
            return null;
        }
    }
    
    // ===== FUN√á√ïES DE RENDERIZA√á√ÉO =====
    
    // Renderizar Tabela de Transa√ß√µes
    function renderTransactionsTable() {
        transactionsTable.innerHTML = '';
        
        if (transactions.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="10" style="text-align: center;">Nenhuma transa√ß√£o encontrada para este per√≠odo.</td>
            `;
            transactionsTable.appendChild(emptyRow);
            return;
        }
        
        // Ordenar transa√ß√µes por data
        const sortedTransactions = [...transactions].sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });
        
        sortedTransactions.forEach(transaction => {
            const row = document.createElement('tr');
            
            // Determinar classe de valor baseado no tipo
            const valueClass = transaction.type === 'income' ? 'value-income' : 'value-expense';
            
            // Determinar classe de status
            let statusClass = '';
            if (transaction.status === 'Pago' || transaction.status === 'Recebido') {
                statusClass = 'status-paid';
            } else if (transaction.status === 'Pendente' || transaction.status === 'A Receber') {
                statusClass = 'status-pending';
            } else if (transaction.status === 'Agendado') {
                statusClass = 'status-scheduled';
            }
            
            // Formata√ß√£o de valores e datas
            const formattedValue = formatCurrency(transaction.value);
            const formattedDate = formatDate(transaction.date);
            const formattedDueDate = transaction.dueDate ? formatDate(transaction.dueDate) : '-';
            
            row.innerHTML = `
                <td>
                    <div class="transaction-icon">${transaction.icon}</div>
                </td>
                <td class="transaction-name">${transaction.name}</td>
                <td>
                    <div class="transaction-category">${transaction.category}</div>
                </td>
                <td>${formattedDate}</td>
                <td>${formattedDueDate}</td>
                <td class="transaction-value ${valueClass}">${formattedValue}</td>
                <td>
                    <div class="transaction-status ${statusClass}">${transaction.status}</div>
                </td>
                <td>${transaction.paymentMethod}</td>
                <td class="checkbox-container">
                    <label class="custom-checkbox">
                        <input type="checkbox" class="transaction-paid" data-id="${transaction.id}" 
                            ${(transaction.status === 'Pago' || transaction.status === 'Recebido') ? 'checked' : ''}>
                        <span class="checkmark"></span>
                    </label>
                </td>
                <td class="transaction-actions">
                    <button class="action-btn edit" data-id="${transaction.id}" title="Editar">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn delete" data-id="${transaction.id}" title="Excluir">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </td>
            `;
            
            transactionsTable.appendChild(row);
        });
        
        // Adicionar event listeners para os bot√µes de a√ß√£o
        document.querySelectorAll('.action-btn.edit').forEach(button => {
            button.addEventListener('click', () => {
                const id = button.getAttribute('data-id');
                openEditModal(id);
            });
        });
        
        document.querySelectorAll('.action-btn.delete').forEach(button => {
            button.addEventListener('click', () => {
                const id = button.getAttribute('data-id');
                openDeleteModal(id);
            });
        });
        
        // Adicionar event listeners para os checkboxes de "Pago/Recebido"
        document.querySelectorAll('.transaction-paid').forEach(checkbox => {
            checkbox.addEventListener('change', handlePaidStatusChange);
        });
    }

// Renderizar Lista de Cart√µes de Cr√©dito
    function renderCreditCards() {
        const container = document.getElementById('credit-cards-container');
        container.innerHTML = '';
        
        if (creditCards.length === 0) {
            container.innerHTML = '<p>Nenhum cart√£o cadastrado.</p>';
            return;
        }
        
        creditCards.forEach(card => {
            const availableLimit = calculateAvailableLimit(card);
            const currentBill = calculateCurrentBill(card);
            
            const cardElement = document.createElement('div');
            cardElement.className = 'credit-card';
            cardElement.innerHTML = `
                <div class="credit-card-header">
                    <div class="credit-card-name">üè¶ ${card.name}</div>
                </div>
                <div class="credit-card-details">
                    <div class="credit-card-info">
                        <div class="credit-card-label">üí≥ Limite Total</div>
                        <div class="credit-card-value">${formatCurrency(card.limit)}</div>
                    </div>
                    <div class="credit-card-info">
                        <div class="credit-card-label">üßæ Limite Dispon√≠vel</div>
                        <div class="credit-card-value">${formatCurrency(availableLimit)}</div>
                    </div>
                </div>
                <div class="credit-card-dates">
                    <div class="credit-card-date">
                        <div class="credit-card-label">üìÖ Fechamento</div>
                        <div class="credit-card-value">Dia ${card.closingDay}</div>
                    </div>
                    <div class="credit-card-date">
                        <div class="credit-card-label">üìÖ Vencimento</div>
                        <div class="credit-card-value">Dia ${card.dueDay}</div>
                    </div>
                </div>
                <div>
                    <div class="credit-card-label">üí≥ Fatura Atual</div>
                    <div class="credit-card-bill">${formatCurrency(currentBill)}</div>
                </div>
                <button class="btn btn-primary" data-card-id="${card.id}">Ver Fatura</button>
            `;
            
            container.appendChild(cardElement);
        });
        
        // Adicionar event listeners para os bot√µes de Ver Fatura
        document.querySelectorAll('[data-card-id]').forEach(button => {
            button.addEventListener('click', () => {
                const cardId = button.getAttribute('data-card-id');
                openCardBillModal(cardId);
            });
        });
    }
    
    // Renderizar Fatura do Cart√£o
    async function renderCardBill(cardId) {
        const billData = await loadCardBill(cardId);
        if (!billData) return;
        
        // Atualizar t√≠tulo do modal
        document.getElementById('card-bill-title').textContent = `Fatura do Cart√£o - ${billData.card.name}`;
        
        // Atualizar valor da fatura
        const billTotal = billData.items.reduce((total, item) => total + item.value, 0);
        document.getElementById('card-bill-value').textContent = formatCurrency(billTotal);
        
        // Atualizar data de vencimento
        document.getElementById('card-bill-due-date').textContent = formatDate(billData.dueDate);
        
        // Atualizar tabela de despesas
        const billTable = document.getElementById('card-bill-table');
        billTable.innerHTML = '';
        
        if (billData.items.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="4" style="text-align: center;">Nenhuma despesa nesta fatura.</td>
            `;
            billTable.appendChild(emptyRow);
            return;
        }
        
        // Ordenar itens por data
        const sortedItems = [...billData.items].sort((a, b) => {
            return new Date(a.date) - new Date(b.date);
        });
        
        sortedItems.forEach(item => {
            const isPaid = item.status === 'Pago';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td>${formatDate(item.date)}</td>
                <td>${formatCurrency(item.value)}</td>
                <td>
                    <div class="transaction-status ${isPaid ? 'status-paid' : 'status-pending'}">
                        ${isPaid ? 'Pago' : 'Pendente'}
                    </div>
                </td>
            `;
            billTable.appendChild(row);
        });
        
        // Desabilitar bot√£o de pagar se n√£o houver despesas ou todas estiverem pagas
        const payButton = document.getElementById('pay-card-bill');
        const hasPendingExpenses = billData.items.some(item => item.status !== 'Pago');
        
        if (!hasPendingExpenses || billData.items.length === 0) {
            payButton.disabled = true;
            payButton.classList.add('btn-neutral');
            payButton.classList.remove('btn-primary');
            payButton.textContent = 'N√£o h√° despesas a pagar';
        } else {
            payButton.disabled = false;
            payButton.classList.remove('btn-neutral');
            payButton.classList.add('btn-primary');
            payButton.textContent = 'Pagar Fatura';
        }
        
        // Armazenar dados da fatura para uso no pagamento
        payButton.setAttribute('data-bill-total', billTotal);
        payButton.setAttribute('data-card-id', cardId);
    }

// ===== FUN√á√ïES DE MANIPULA√á√ÉO DE FORMUL√ÅRIOS =====
    
    // Abrir Modal de Edi√ß√£o
    function openEditModal(id) {
        const transaction = transactions.find(t => t.id === id);
        if (!transaction) return;
        
        // Armazenar ID da transa√ß√£o selecionada
        selectedTransactionId = id;
        
        // Atualizar t√≠tulo do modal
        const modalTitle = document.getElementById('edit-modal-title');
        modalTitle.textContent = transaction.type === 'income' ? 'Editar Receita' : 'Editar Despesa';
        
        // Configurar o formul√°rio de edi√ß√£o
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-type').value = transaction.type;
        document.getElementById('edit-name').value = transaction.name;
        document.getElementById('edit-value').value = transaction.value;
        document.getElementById('edit-date').value = formatDateForInput(transaction.date);
        
        // Configurar campos espec√≠ficos por tipo de transa√ß√£o
        if (transaction.type === 'expense') {
            // Mostrar campos espec√≠ficos de despesa
            document.getElementById('edit-due-date-container').style.display = 'grid';
            document.getElementById('edit-due-date').value = formatDateForInput(transaction.dueDate);
            
            // Configurar categorias de despesa
            const categorySelect = document.getElementById('edit-category');
            categorySelect.innerHTML = `
                <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                <option value="Moradia">Moradia</option>
                <option value="Transporte">Transporte</option>
                <option value="Sa√∫de">Sa√∫de</option>
                <option value="Educa√ß√£o">Educa√ß√£o</option>
                <option value="Lazer">Lazer</option>
                <option value="Vestu√°rio">Vestu√°rio</option>
                <option value="Tecnologia">Tecnologia</option>
                <option value="Servi√ßos">Servi√ßos</option>
                <option value="Impostos">Impostos</option>
                <option value="Outros">Outros</option>
            `;
            categorySelect.value = transaction.category;
            
            // Configurar op√ß√µes de status para despesa
            const statusGroup = document.getElementById('edit-status-group');
            statusGroup.innerHTML = `
                <label class="radio-container">
                    Pago
                    <input type="radio" name="status" value="Pago">
                    <span class="radio-checkmark"></span>
                </label>
                <label class="radio-container">
                    Pendente
                    <input type="radio" name="status" value="Pendente">
                    <span class="radio-checkmark"></span>
                </label>
                <label class="radio-container">
                    Agendado
                    <input type="radio" name="status" value="Agendado">
                    <span class="radio-checkmark"></span>
                </label>
            `;
            
            // Selecionar o status atual
            document.querySelector(`input[name="status"][value="${transaction.status}"]`).checked = true;
            
            // Mostrar campo de data de agendamento se necess√°rio
            if (transaction.status === 'Agendado') {
                document.getElementById('edit-scheduled-date-group').style.display = 'block';
                document.getElementById('edit-scheduled-date').value = formatDateForInput(transaction.scheduledDate);
            }
            
            // Configurar op√ß√µes de formas de pagamento para despesa
            const paymentMethodSelect = document.getElementById('edit-payment-method');
            paymentMethodSelect.innerHTML = `
                <option value="Dinheiro">Dinheiro</option>
                <option value="Pix">Pix</option>
                <option value="D√©bito">D√©bito</option>
                <option value="D√©bito em Conta">D√©bito em Conta</option>
                <option value="Transfer√™ncia">Transfer√™ncia</option>
                <option value="Boleto">Boleto</option>
                <option value="Cr√©dito">Cr√©dito</option>
            `;
            paymentMethodSelect.value = transaction.paymentMethod;
            
            // Mostrar campo de cart√£o de cr√©dito se necess√°rio
            if (transaction.paymentMethod === 'Cr√©dito') {
                document.getElementById('edit-credit-card-group').style.display = 'block';
                document.getElementById('edit-credit-card').value = transaction.creditCardId;
            }
        } else {
            // Esconder campos espec√≠ficos de despesa
            document.getElementById('edit-due-date-container').style.display = 'none';
            
            // Configurar categorias de receita
            const categorySelect = document.getElementById('edit-category');
            categorySelect.innerHTML = `
                <option value="Sal√°rio">Sal√°rio</option>
                <option value="Freelance">Freelance</option>
                <option value="Investimentos">Investimentos</option>
                <option value="Aluguel">Aluguel</option>
                <option value="Vendas">Vendas</option>
                <option value="Presente">Presente</option>
                <option value="Outros">Outros</option>
            `;
            categorySelect.value = transaction.category;
            
            // Configurar op√ß√µes de status para receita
            const statusGroup = document.getElementById('edit-status-group');
            statusGroup.innerHTML = `
                <label class="radio-container">
                    Recebido
                    <input type="radio" name="status" value="Recebido">
                    <span class="radio-checkmark"></span>
                </label>
                <label class="radio-container">
                    A Receber
                    <input type="radio" name="status" value="A Receber">
                    <span class="radio-checkmark"></span>
                </label>
            `;
            
            // Selecionar o status atual
            document.querySelector(`input[name="status"][value="${transaction.status}"]`).checked = true;
            
            // Configurar op√ß√µes de formas de pagamento para receita
            const paymentMethodSelect = document.getElementById('edit-payment-method');
            paymentMethodSelect.innerHTML = `
                <option value="Dinheiro">Dinheiro</option>
                <option value="Pix">Pix</option>
                <option value="Transfer√™ncia">Transfer√™ncia</option>
                <option value="Dep√≥sito">Dep√≥sito</option>
                <option value="Outros">Outros</option>
            `;
            paymentMethodSelect.value = transaction.paymentMethod;
        }
        
        // Configurar campo de recorr√™ncia
        document.getElementById('edit-recurring').checked = transaction.recurring || false;
        if (transaction.recurring) {
            document.getElementById('edit-installments-group').style.display = 'block';
            document.getElementById('edit-installments').value = transaction.installments || 2;
            
            // Mostrar op√ß√µes de edi√ß√£o de recorr√™ncia
            document.getElementById('edit-recurrence-options').style.display = 'block';
        }
        
        // Configurar observa√ß√µes
        document.getElementById('edit-notes').value = transaction.notes || '';
        
        // Configurar seletor de √≠cones
        setupEditIconPicker(transaction.icon);
        
        // Adicionar event listeners espec√≠ficos do modal de edi√ß√£o
        document.querySelectorAll('#edit-form input[name="status"]').forEach(radio => {
            radio.addEventListener('change', handleEditStatusChange);
        });
        
        // Abrir o modal
        openModal(modalEditTransaction);
    }

// Abrir Modal de Exclus√£o
    function openDeleteModal(id) {
        const transaction = transactions.find(t => t.id === id);
        if (!transaction) return;
        
        // Armazenar ID da transa√ß√£o selecionada
        selectedTransactionId = id;
        
        // Verificar se √© uma transa√ß√£o recorrente
        if (transaction.recurring && transaction.recurrenceId) {
            document.getElementById('delete-recurrence-options').style.display = 'block';
        } else {
            document.getElementById('delete-recurrence-options').style.display = 'none';
        }
        
        // Abrir o modal
        openModal(modalConfirmDelete);
    }
    
    // Abrir Modal de Cart√µes de Cr√©dito
    function openCreditCardsModal() {
        renderCreditCards();
        openModal(modalCreditCards);
    }
    
    // Abrir Modal de Fatura do Cart√£o
    function openCardBillModal(cardId) {
        selectedCardId = cardId;
        renderCardBill(cardId);
        openModal(modalCardBill);
    }
    
    // Preparar Pagamento da Fatura
    function preparePayCardBill() {
        const payButton = document.getElementById('pay-card-bill');
        const cardId = payButton.getAttribute('data-card-id');
        const billTotal = parseFloat(payButton.getAttribute('data-bill-total'));
        
        document.getElementById('confirm-payment-value').textContent = formatCurrency(billTotal);
        
        selectedCardId = cardId;
        openModal(modalConfirmPayment);
    }
    
    // Toggle de campos de recorr√™ncia
    function toggleRecurringFields(e) {
        const isRecurring = e.target.checked;
        const formId = e.target.id;
        
        let installmentsGroupId;
        if (formId === 'income-recurring') {
            installmentsGroupId = 'income-installments-group';
        } else if (formId === 'expense-recurring') {
            installmentsGroupId = 'expense-installments-group';
        } else if (formId === 'edit-recurring') {
            installmentsGroupId = 'edit-installments-group';
            document.getElementById('edit-recurrence-options').style.display = isRecurring ? 'block' : 'none';
        }
        
        document.getElementById(installmentsGroupId).style.display = isRecurring ? 'block' : 'none';
    }
    
    // Handler para mudan√ßa de status
    function handleStatusChange(e) {
        const status = e.target.value;
        const isExpenseForm = e.target.form.id === 'expense-form';
        
        if (isExpenseForm && status === 'Agendado') {
            document.getElementById('expense-scheduled-date-group').style.display = 'block';
        } else {
            document.getElementById('expense-scheduled-date-group').style.display = 'none';
        }
    }
    
    // Handler para mudan√ßa de status no formul√°rio de edi√ß√£o
    function handleEditStatusChange(e) {
        const status = e.target.value;
        
        if (status === 'Agendado') {
            document.getElementById('edit-scheduled-date-group').style.display = 'block';
        } else {
            document.getElementById('edit-scheduled-date-group').style.display = 'none';
        }
    }
    
    // Handler para mudan√ßa de forma de pagamento
    function handlePaymentMethodChange(e) {
        const method = e.target.value;
        const formId = e.target.form.id;
        
        if (method === 'Cr√©dito') {
            if (formId === 'expense-form') {
                document.getElementById('expense-credit-card-group').style.display = 'block';
            } else if (formId === 'edit-form') {
                document.getElementById('edit-credit-card-group').style.display = 'block';
            }
        } else {
            if (formId === 'expense-form') {
                document.getElementById('expense-credit-card-group').style.display = 'none';
            } else if (formId === 'edit-form') {
                document.getElementById('edit-credit-card-group').style.display = 'none';
            }
        }
    }
    
    // Handler para mudan√ßa de status "Pago/Recebido"
    async function handlePaidStatusChange(e) {
        const id = e.target.getAttribute('data-id');
        const isPaid = e.target.checked;
        
        const transaction = transactions.find(t => t.id === id);
        if (!transaction) return;
        
        try {
            const newStatus = transaction.type === 'income' 
                ? (isPaid ? 'Recebido' : 'A Receber')
                : (isPaid ? 'Pago' : 'Pendente');
            
            await db.collection('transactions').doc(id).update({
                status: newStatus
            });
            
            // Atualizar o estado local
            transaction.status = newStatus;
            
            // Atualizar KPIs
            updateKPIs();
            
            // Mostrar mensagem de sucesso
            showSuccess('Status atualizado com sucesso!');
        } catch (error) {
            // Reverter o estado do checkbox
            e.target.checked = !isPaid;
            showError('Erro ao atualizar status: ' + error.message);
        }
    }

// Configurar seletores de √≠cones
    function setupIconPickers() {
        // Seletor de √≠cones para receita
        const incomeIconPicker = document.getElementById('income-icon-picker');
        const incomeIconInput = document.getElementById('income-icon');
        
        incomeIconPicker.querySelectorAll('.icon-option').forEach(option => {
            option.addEventListener('click', () => {
                // Remover classe 'selected' de todas as op√ß√µes
                incomeIconPicker.querySelectorAll('.icon-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Adicionar classe 'selected' √† op√ß√£o clicada
                option.classList.add('selected');
                
                // Atualizar valor do input hidden
                incomeIconInput.value = option.getAttribute('data-icon');
            });
        });
        
        // Seletor de √≠cones para despesa
        const expenseIconPicker = document.getElementById('expense-icon-picker');
        const expenseIconInput = document.getElementById('expense-icon');
        
        expenseIconPicker.querySelectorAll('.icon-option').forEach(option => {
            option.addEventListener('click', () => {
                // Remover classe 'selected' de todas as op√ß√µes
                expenseIconPicker.querySelectorAll('.icon-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Adicionar classe 'selected' √† op√ß√£o clicada
                option.classList.add('selected');
                
                // Atualizar valor do input hidden
                expenseIconInput.value = option.getAttribute('data-icon');
            });
        });
    }
    
    // Configurar seletor de √≠cones para edi√ß√£o
    function setupEditIconPicker(currentIcon) {
        const editIconPicker = document.getElementById('edit-icon-picker');
        const editIconInput = document.getElementById('edit-icon');
        
        // Definir os √≠cones dispon√≠veis
        const icons = [
            'üí∞', 'üíº', 'üè¶', 'üíµ', 'üè¢', 'üéì', 'üöó', 'üè†', 'üì±', 'üéÆ', 'üìö', 'üé®',
            'üõí', 'üçî', 'üíä', '‚úàÔ∏è', 'üé≠', 'üèãÔ∏è', 'üëï', 'üîå'
        ];
        
        // Limpar o picker existente
        editIconPicker.innerHTML = '';
        
        // Criar as op√ß√µes de √≠cones
        icons.forEach(icon => {
            const option = document.createElement('div');
            option.className = 'icon-option';
            option.setAttribute('data-icon', icon);
            option.textContent = icon;
            
            if (icon === currentIcon) {
                option.classList.add('selected');
                editIconInput.value = icon;
            }
            
            option.addEventListener('click', () => {
                // Remover classe 'selected' de todas as op√ß√µes
                editIconPicker.querySelectorAll('.icon-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Adicionar classe 'selected' √† op√ß√£o clicada
                option.classList.add('selected');
                
                // Atualizar valor do input hidden
                editIconInput.value = icon;
            });
            
            editIconPicker.appendChild(option);
        });
    }
    
    // Atualizar seletores de cart√£o de cr√©dito
    function updateCreditCardSelects() {
        const expenseCreditCardSelect = document.getElementById('expense-credit-card');
        const editCreditCardSelect = document.getElementById('edit-credit-card');
        
        // Limpar os selects
        expenseCreditCardSelect.innerHTML = '';
        editCreditCardSelect.innerHTML = '';
        
        if (creditCards.length === 0) {
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Nenhum cart√£o cadastrado';
            
            expenseCreditCardSelect.appendChild(defaultOption.cloneNode(true));
            editCreditCardSelect.appendChild(defaultOption);
            
            // Desabilitar op√ß√£o "Cr√©dito" no select de forma de pagamento
            const expensePaymentMethod = document.getElementById('expense-payment-method');
            const editPaymentMethod = document.getElementById('edit-payment-method');
            
            for (const select of [expensePaymentMethod, editPaymentMethod]) {
                const creditOption = select.querySelector('option[value="Cr√©dito"]');
                if (creditOption) {
                    creditOption.disabled = true;
                }
            }
            
            return;
        }
        
        // Habilitar op√ß√£o "Cr√©dito" no select de forma de pagamento
        const expensePaymentMethod = document.getElementById('expense-payment-method');
        const editPaymentMethod = document.getElementById('edit-payment-method');
        
        for (const select of [expensePaymentMethod, editPaymentMethod]) {
            const creditOption = select.querySelector('option[value="Cr√©dito"]');
            if (creditOption) {
                creditOption.disabled = false;
            }
        }
        
        // Adicionar os cart√µes aos selects
        creditCards.forEach(card => {
            const option = document.createElement('option');
            option.value = card.id;
            option.textContent = card.name;
            
            expenseCreditCardSelect.appendChild(option.cloneNode(true));
            editCreditCardSelect.appendChild(option);
        });
    }

// ===== FUN√á√ïES DE SALVAMENTO E ATUALIZA√á√ÉO =====
    
    // Salvar Nova Receita
    async function saveIncome() {
        try {
            const form = document.getElementById('income-form');
            const formData = new FormData(form);
            
            // Validar campos obrigat√≥rios (n√£o √© necess√°rio valida√ß√£o estrita conforme solicitado)
            
            // Converter dados do formul√°rio para objeto
            const income = {
                type: 'income',
                icon: formData.get('icon'),
                name: formData.get('name'),
                value: parseFloat(formData.get('value')),
                category: formData.get('category'),
                date: new Date(formData.get('date')),
                status: formData.get('status'),
                paymentMethod: formData.get('paymentMethod'),
                recurring: formData.get('recurring') === 'on',
                notes: formData.get('notes'),
                createdAt: new Date()
            };
            
            // Processar recorr√™ncia se necess√°rio
            if (income.recurring) {
                const installments = parseInt(formData.get('installments')) || 2;
                const recurrenceId = generateUUID();
                
                // Criar lan√ßamentos recorrentes
                for (let i = 0; i < installments; i++) {
                    const installmentDate = new Date(income.date);
                    installmentDate.setMonth(installmentDate.getMonth() + i);
                    
                    const installment = {
                        ...income,
                        installmentNumber: i + 1,
                        installments: installments,
                        date: installmentDate,
                        recurrenceId: recurrenceId
                    };
                    
                    await db.collection('transactions').add(installment);
                }
                
                showSuccess(`Receita recorrente salva com sucesso! ${installments} parcelas foram criadas.`);
            } else {
                // Salvar receita √∫nica
                await db.collection('transactions').add(income);
                showSuccess('Receita salva com sucesso!');
            }
            
            // Limpar formul√°rio
            form.reset();
            
            // Recarregar dados
            await loadTransactions();
            updateKPIs();
            
            // Fechar modal
            closeCurrentModal();
        } catch (error) {
            showError('Erro ao salvar receita: ' + error.message);
        }
    }
    
    // Salvar Nova Despesa
    async function saveExpense() {
        try {
            const form = document.getElementById('expense-form');
            const formData = new FormData(form);
            
            // Validar campos obrigat√≥rios (n√£o √© necess√°rio valida√ß√£o estrita conforme solicitado)
            
            // Converter dados do formul√°rio para objeto
            const expense = {
                type: 'expense',
                icon: formData.get('icon'),
                name: formData.get('name'),
                value: parseFloat(formData.get('value')),
                category: formData.get('category'),
                date: new Date(formData.get('date')),
                dueDate: new Date(formData.get('dueDate')),
                status: formData.get('status'),
                paymentMethod: formData.get('paymentMethod'),
                recurring: formData.get('recurring') === 'on',
                notes: formData.get('notes'),
                createdAt: new Date()
            };
            
            // Adicionar data de agendamento se status for "Agendado"
            if (expense.status === 'Agendado') {
                expense.scheduledDate = new Date(formData.get('scheduledDate'));
            }
            
            // Adicionar ID do cart√£o se forma de pagamento for "Cr√©dito"
            if (expense.paymentMethod === 'Cr√©dito') {
                expense.creditCardId = formData.get('creditCard');
            }
            
            // Processar recorr√™ncia se necess√°rio
            if (expense.recurring) {
                const installments = parseInt(formData.get('installments')) || 2;
                const recurrenceId = generateUUID();
                
                // Criar lan√ßamentos recorrentes
                for (let i = 0; i < installments; i++) {
                    const installmentDate = new Date(expense.date);
                    const installmentDueDate = new Date(expense.dueDate);
                    
                    installmentDate.setMonth(installmentDate.getMonth() + i);
                    installmentDueDate.setMonth(installmentDueDate.getMonth() + i);
                    
                    const installment = {
                        ...expense,
                        installmentNumber: i + 1,
                        installments: installments,
                        date: installmentDate,
                        dueDate: installmentDueDate,
                        recurrenceId: recurrenceId
                    };
                    
                    // Ajustar data de agendamento se necess√°rio
                    if (installment.status === 'Agendado' && installment.scheduledDate) {
                        const scheduledDate = new Date(expense.scheduledDate);
                        scheduledDate.setMonth(scheduledDate.getMonth() + i);
                        installment.scheduledDate = scheduledDate;
                    }
                    
                    await db.collection('transactions').add(installment);
                }
                
                showSuccess(`Despesa recorrente salva com sucesso! ${installments} parcelas foram criadas.`);
            } else {
                // Salvar despesa √∫nica
                await db.collection('transactions').add(expense);
                showSuccess('Despesa salva com sucesso!');
            }
            
            // Limpar formul√°rio
            form.reset();
            
            // Recarregar dados
            await loadTransactions();
            updateKPIs();
            
            // Fechar modal
            closeCurrentModal();
        } catch (error) {
            showError('Erro ao salvar despesa: ' + error.message);
        }
    }

// Salvar Edi√ß√£o de Transa√ß√£o
    async function saveEdit() {
        try {
            const form = document.getElementById('edit-form');
            const formData = new FormData(form);
            
            const id = formData.get('id');
            const type = formData.get('type');
            const transaction = transactions.find(t => t.id === id);
            
            if (!transaction) {
                throw new Error('Transa√ß√£o n√£o encontrada');
            }
            
            // Criar objeto de atualiza√ß√£o b√°sico
            const updateData = {
                icon: formData.get('icon'),
                name: formData.get('name'),
                value: parseFloat(formData.get('value')),
                category: formData.get('category'),
                date: new Date(formData.get('date')),
                status: formData.get('status'),
                paymentMethod: formData.get('paymentMethod'),
                recurring: formData.get('recurring') === 'on',
                notes: formData.get('notes'),
                updatedAt: new Date()
            };
            
            // Adicionar campos espec√≠ficos por tipo
            if (type === 'expense') {
                updateData.dueDate = new Date(formData.get('dueDate'));
                
                if (updateData.status === 'Agendado') {
                    updateData.scheduledDate = new Date(formData.get('scheduledDate'));
                }
                
                if (updateData.paymentMethod === 'Cr√©dito') {
                    updateData.creditCardId = formData.get('creditCard');
                } else {
                    // Se mudou de Cr√©dito para outra forma, remover o campo creditCardId
                    updateData.creditCardId = firebase.firestore.FieldValue.delete();
                }
            }
            
            // Verificar se √© uma transa√ß√£o recorrente
            const recurrenceEdit = transaction.recurring ? formData.get('recurrenceEdit') : 'single';
            
            if (recurrenceEdit === 'all' && transaction.recurrenceId) {
                // Atualizar todas as parcelas futuras
                const today = new Date();
                
                // Buscar todas as parcelas futuras
                const snapshot = await db.collection('transactions')
                    .where('recurrenceId', '==', transaction.recurrenceId)
                    .where('date', '>=', today)
                    .get();
                
                // Batch para atualiza√ß√µes m√∫ltiplas
                const batch = db.batch();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Manter as datas espec√≠ficas de cada parcela
                    const batchUpdate = {
                        ...updateData,
                        date: data.date,
                        dueDate: type === 'expense' ? data.dueDate : null
                    };
                    
                    batch.update(doc.ref, batchUpdate);
                });
                
                // Executar batch
                await batch.commit();
                
                showSuccess('Todas as parcelas futuras foram atualizadas com sucesso!');
            } else {
                // Atualizar apenas esta parcela
                await db.collection('transactions').doc(id).update(updateData);
                showSuccess('Transa√ß√£o atualizada com sucesso!');
            }
            
            // Recarregar dados
            await loadTransactions();
            updateKPIs();
            
            // Fechar modal
            closeCurrentModal();
        } catch (error) {
            showError('Erro ao atualizar transa√ß√£o: ' + error.message);
        }
    }
    
    // Excluir Transa√ß√£o
    async function deleteTransaction() {
        try {
            const id = selectedTransactionId;
            const transaction = transactions.find(t => t.id === id);
            
            if (!transaction) {
                throw new Error('Transa√ß√£o n√£o encontrada');
            }
            
            // Verificar se √© uma transa√ß√£o recorrente
            const recurrenceDeleteOptions = document.querySelector('input[name="recurrenceDelete"]:checked');
            const recurrenceDelete = recurrenceDeleteOptions ? recurrenceDeleteOptions.value : 'single';
            
            if (recurrenceDelete === 'all' && transaction.recurrenceId) {
                // Excluir todas as parcelas futuras
                const today = new Date();
                
                // Buscar todas as parcelas futuras
                const snapshot = await db.collection('transactions')
                    .where('recurrenceId', '==', transaction.recurrenceId)
                    .where('date', '>=', today)
                    .get();
                
                // Batch para exclus√µes m√∫ltiplas
                const batch = db.batch();
                
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // Executar batch
                await batch.commit();
                
                showSuccess('Todas as parcelas futuras foram exclu√≠das com sucesso!');
            } else {
                // Excluir apenas esta parcela
                await db.collection('transactions').doc(id).delete();
                showSuccess('Transa√ß√£o exclu√≠da com sucesso!');
            }
            
            // Recarregar dados
            await loadTransactions();
            updateKPIs();
            
            // Fechar modal
            closeCurrentModal();
        } catch (error) {
            showError('Erro ao excluir transa√ß√£o: ' + error.message);
        }
    }
    
    // Salvar Novo Cart√£o
    async function saveCard() {
        try {
            const form = document.getElementById('card-form');
            const formData = new FormData(form);
            
            // Validar campos obrigat√≥rios (n√£o √© necess√°rio valida√ß√£o estrita conforme solicitado)
            
            // Converter dados do formul√°rio para objeto
            const card = {
                name: formData.get('name'),
                limit: parseFloat(formData.get('limit')),
                closingDay: parseInt(formData.get('closingDay')),
                dueDay: parseInt(formData.get('dueDay')),
                createdAt: new Date()
            };
            
            // Salvar cart√£o
            await db.collection('creditCards').add(card);
            showSuccess('Cart√£o salvo com sucesso!');
            
            // Limpar formul√°rio
            form.reset();
            
            // Recarregar dados
            await loadCreditCards();
            renderCreditCards();
            
            // Fechar modal
            closeCurrentModal();
            
            // Abrir modal de cart√µes
            openModal(modalCreditCards);
        } catch (error) {
            showError('Erro ao salvar cart√£o: ' + error.message);
        }
    }

// Pagar Fatura do Cart√£o
    async function payCardBill() {
        try {
            const cardId = selectedCardId;
            const card = creditCards.find(card => card.id === cardId);
            
            if (!card) {
                throw new Error('Cart√£o n√£o encontrado');
            }
            
            // Carregar fatura
            const billData = await loadCardBill(cardId);
            
            if (!billData || billData.items.length === 0) {
                throw new Error('N√£o h√° despesas nesta fatura');
            }
            
            // Verificar se h√° despesas pendentes
            const pendingExpenses = billData.items.filter(item => item.status !== 'Pago');
            
            if (pendingExpenses.length === 0) {
                throw new Error('N√£o h√° despesas pendentes para pagar');
            }
            
            // Batch para atualiza√ß√µes m√∫ltiplas
            const batch = db.batch();
            
            // Marcar todas as despesas como pagas
            pendingExpenses.forEach(expense => {
                const ref = db.collection('transactions').doc(expense.id);
                batch.update(ref, {
                    status: 'Pago'
                });
            });
            
            // Executar batch
            await batch.commit();
            
            showSuccess('Fatura paga com sucesso! Todas as despesas foram marcadas como pagas.');
            
            // Recarregar dados
            await loadTransactions();
            updateKPIs();
            
            // Fechar modal
            closeCurrentModal();
            
            // Fechar modal de fatura
            closeModal(modalCardBill);
            
            // Atualizar modal de cart√µes
            renderCreditCards();
        } catch (error) {
            showError('Erro ao pagar fatura: ' + error.message);
        }
    }
    
    // ===== FUN√á√ïES DE C√ÅLCULO E ATUALIZA√á√ÉO DE KPIS =====
    
    // Atualizar KPIs
    function updateKPIs() {
        updateBalanceKPI();
        updateIncomeKPI();
        updateExpenseKPI();
        updateCreditCardKPI();
    }
    
    // Atualizar KPI de Saldo
    function updateBalanceKPI() {
        const incomeReceived = transactions
            .filter(t => t.type === 'income' && t.status === 'Recebido')
            .reduce((sum, t) => sum + t.value, 0);
        
        const expensePaid = transactions
            .filter(t => t.type === 'expense' && t.status === 'Pago')
            .reduce((sum, t) => sum + t.value, 0);
        
        const balance = incomeReceived - expensePaid;
        
        balanceElement.textContent = formatCurrency(balance);
        
        // Determinar status do saldo
        if (balance > 0) {
            balanceStatusElement.textContent = 'Saud√°vel';
            balanceStatusElement.className = 'kpi-success';
        } else if (balance === 0) {
            balanceStatusElement.textContent = 'Equilibrado';
            balanceStatusElement.className = '';
        } else {
            balanceStatusElement.textContent = 'Negativo';
            balanceStatusElement.className = 'kpi-danger';
        }
    }
    
    // Atualizar KPI de Receitas
    function updateIncomeKPI() {
        const incomeTotal = transactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + t.value, 0);
        
        const incomeReceived = transactions
            .filter(t => t.type === 'income' && t.status === 'Recebido')
            .reduce((sum, t) => sum + t.value, 0);
        
        const incomePending = incomeTotal - incomeReceived;
        
        incomeTotalElement.textContent = formatCurrency(incomeTotal);
        incomeReceivedElement.textContent = formatCurrency(incomeReceived);
        incomePendingElement.textContent = formatCurrency(incomePending);
    }
    
    // Atualizar KPI de Despesas
    function updateExpenseKPI() {
        const expenseTotal = transactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.value, 0);
        
        const expensePaid = transactions
            .filter(t => t.type === 'expense' && t.status === 'Pago')
            .reduce((sum, t) => sum + t.value, 0);
        
        const expensePending = expenseTotal - expensePaid;
        
        expenseTotalElement.textContent = formatCurrency(expenseTotal);
        expensePaidElement.textContent = formatCurrency(expensePaid);
        expensePendingElement.textContent = formatCurrency(expensePending);
    }

// Atualizar KPI de Cart√£o de Cr√©dito
    function updateCreditCardKPI() {
        if (creditCards.length === 0) {
            creditCardBillElement.textContent = formatCurrency(0);
            creditCardStatusElement.textContent = 'Nenhum cart√£o cadastrado';
            return;
        }
        
        // Calcular o valor total das faturas abertas
        let totalBill = 0;
        for (const card of creditCards) {
            totalBill += calculateCurrentBill(card);
        }
        
        creditCardBillElement.textContent = formatCurrency(totalBill);
        
        if (totalBill > 0) {
            creditCardStatusElement.textContent = `Total das faturas abertas`;
        } else {
            creditCardStatusElement.textContent = 'Sem faturas em aberto';
        }
    }
    
    // Calcular fatura atual de um cart√£o
    function calculateCurrentBill(card) {
        const currentDate = new Date();
        const currentDay = currentDate.getDate();
        
        // Determinar per√≠odo da fatura atual
        let billStartDate, billEndDate;
        
        if (currentDay >= card.closingDay) {
            // Estamos ap√≥s o fechamento deste m√™s, ent√£o a fatura atual √© do pr√≥ximo m√™s
            billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), card.closingDay);
            billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, card.closingDay - 1);
        } else {
            // Estamos antes do fechamento deste m√™s, ent√£o a fatura atual √© deste m√™s
            billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, card.closingDay);
            billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), card.closingDay - 1);
        }
        
        // Filtrar transa√ß√µes do per√≠odo da fatura
        const billExpenses = transactions.filter(t => 
            t.type === 'expense' && 
            t.paymentMethod === 'Cr√©dito' &&
            t.creditCardId === card.id &&
            t.date >= billStartDate &&
            t.date <= billEndDate
        );
        
        // Calcular soma das despesas
        return billExpenses.reduce((sum, t) => sum + t.value, 0);
    }
    
    // Calcular limite dispon√≠vel de um cart√£o
    function calculateAvailableLimit(card) {
        // Filtrar despesas n√£o pagas no cart√£o
        const unpaidExpenses = transactions.filter(t => 
            t.type === 'expense' && 
            t.paymentMethod === 'Cr√©dito' &&
            t.status !== 'Pago' &&
            t.creditCardId === card.id
        );
        
        // Calcular soma das despesas n√£o pagas
        const usedLimit = unpaidExpenses.reduce((sum, t) => sum + t.value, 0);
        
        // Calcular limite dispon√≠vel
        return card.limit - usedLimit;
    }
    
    // ===== FUN√á√ïES DE CONTROLE DE MODAIS =====
    
    // Abrir Modal
    function openModal(modal) {
        // Fechar qualquer modal aberto primeiro
        closeAllModals();
        
        // Abrir o modal solicitado
        modal.classList.add('active');
        
        // Adicionar classe ao body para evitar scroll
        document.body.style.overflow = 'hidden';
        
        // Timeout para anima√ß√£o de entrada
        setTimeout(() => {
            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.transform = 'translateY(0)';
                modalContent.style.opacity = '1';
            }
        }, 10);
    }
    
    // Fechar Modal
    function closeModal(modal) {
        // Reverter anima√ß√£o de entrada
        const modalContent = modal.querySelector('.modal');
        if (modalContent) {
            modalContent.style.transform = 'translateY(20px)';
            modalContent.style.opacity = '0';
        }
        
        // Timeout para anima√ß√£o de sa√≠da
        setTimeout(() => {
            modal.classList.remove('active');
            
            // Restaurar scroll do body apenas se n√£o houver outros modais ativos
            if (!document.querySelector('.modal-backdrop.active')) {
                document.body.style.overflow = '';
            }
        }, 300);
    }

// Fechar Todos os Modais
    function closeAllModals() {
        document.querySelectorAll('.modal-backdrop').forEach(modal => {
            modal.classList.remove('active');
            
            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.transform = 'translateY(20px)';
                modalContent.style.opacity = '0';
            }
        });
        
        // Restaurar scroll do body
        document.body.style.overflow = '';
    }
    
    // Fechar Modal Atual
    function closeCurrentModal() {
        const activeModal = document.querySelector('.modal-backdrop.active');
        if (activeModal) {
            closeModal(activeModal);
        }
    }
    
    // Mostrar Mensagem de Sucesso
    function showSuccess(message) {
        document.getElementById('success-message').textContent = message;
        openModal(document.getElementById('modal-success'));
    }
    
    // Mostrar Mensagem de Erro
    function showError(message) {
        document.getElementById('error-message').textContent = message;
        openModal(document.getElementById('modal-error'));
    }
    
    // ===== FUN√á√ïES UTILIT√ÅRIAS =====
    
    // Handler para Mudan√ßa de Per√≠odo
    function handlePeriodChange() {
        currentYear = parseInt(yearSelect.value);
        currentMonth = parseInt(monthSelect.value);
        loadTransactions();
    }
    
    // Toggle de Tema Claro/Escuro
    function toggleTheme() {
        const themeIcon = document.querySelector('.theme-icon');
        const htmlElement = document.documentElement;
        
        if (currentTheme === 'light') {
            htmlElement.setAttribute('data-theme', 'dark');
            themeIcon.textContent = '‚òÄÔ∏è';
            currentTheme = 'dark';
        } else {
            htmlElement.setAttribute('data-theme', 'light');
            themeIcon.textContent = 'üåô';
            currentTheme = 'light';
        }
    }
    
    // Aplicar Tema com Base nas Prefer√™ncias do Sistema
    function applyTheme() {
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const themeIcon = document.querySelector('.theme-icon');
        
        if (prefersDarkMode) {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeIcon.textContent = '‚òÄÔ∏è';
            currentTheme = 'dark';
        }
    }
    
    // Formatar Moeda
    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }
    
    // Formatar Data para Exibi√ß√£o
    function formatDate(date) {
        if (!date) return '-';
        
        return new Intl.DateTimeFormat('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        }).format(date);
    }
    
    // Formatar Data para Input
    function formatDateForInput(date) {
        if (!date) return '';
        
        const d = new Date(date);
        
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    }
    
    // Gerar UUID
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
</script>
<!-- ===== FIM: SCRIPTS_APLICACAO ================================ -->
