<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Familiar Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <style>
    /* ===== Variáveis e Temas (Estilo Apple/Google) ===== */
    :root {
      --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem; /* 12px */
      --radius: 1.125rem; /* 18px */
      --radius-lg: 1.5rem; /* 24px */
      --shadow: 0 4px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.09), 0 2px 6px rgba(0,0,0,0.07);
      --shadow-dropdown: 0 5px 20px rgba(0,0,0,0.12);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

      /* Cores Light */
      --bg: #F9F9FB; /* Slightly off-white */
      --card-bg: #FFFFFF;
      --input-bg: rgba(118, 118, 128, 0.12); /* System Gray 5 (0.12 alpha) */
      --text: #1C1C1E; /* Almost Black */
      --text-secondary: #8A8A8E; /* System Gray */
      --primary: #007AFF; /* Blue */
      --primary-light: #5856D6; /* Indigo for accents if needed */
      --success: #34C759; /* Green */
      --warning: #FF9500; /* Orange */
      --danger: #FF3B30; /* Red */
      --info: #5AC8FA; /* Teal */
      --border: rgba(60, 60, 67, 0.20); /* Separator Light */
      --chart-grid: rgba(60, 60, 67, 0.10);
      --menu-bg: rgba(255, 255, 255, 0.85); /* Translucent */
      --insight-bg: rgba(0, 122, 255, 0.08); /* Light Blue BG */
      --importance-extrema: #FF3B30; /* Red */
      --importance-urgente: #FF9500; /* Orange */
      --importance-importante: #FFCC00; /* Yellow */
      --status-pending: #FF9500; /* Orange for pending */
      --status-scheduled: #5AC8FA; /* Teal for scheduled */
      --status-overdue: #FF3B30; /* Red for overdue */
    }

    [data-theme="dark"] {
      /* Cores Dark */
      --bg: #000000; /* True Black for OLED */
      --card-bg: #1C1C1E; /* Gray 6 */
      --input-bg: rgba(118, 118, 128, 0.24); /* System Gray 5 (0.24 alpha) */
      --text: #FFFFFF;
      --text-secondary: #8E8E93; /* Gray */
      --primary: #0A84FF; /* Blue */
      --primary-light: #5E5CE6; /* Indigo */
      --success: #30D158; /* Green */
      --warning: #FF9F0A; /* Orange */
      --danger: #FF453A; /* Red */
      --info: #64D2FF; /* Teal */
      --border: rgba(84, 84, 88, 0.4); /* Separator Dark */
      --chart-grid: rgba(84, 84, 88, 0.2);
      --menu-bg: rgba(28, 28, 30, 0.85); /* Translucent */
      --insight-bg: rgba(10, 132, 255, 0.15); /* Light Blue BG */
      --importance-extrema: #FF453A; /* Red */
      --importance-urgente: #FF9F0A; /* Orange */
      --importance-importante: #FFD60A; /* Yellow */
      --status-pending: #FF9F0A; /* Orange for pending */
      --status-scheduled: #64D2FF; /* Teal for scheduled */
      --status-overdue: #FF453A; /* Red for overdue */
    }

    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html, body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
      font-size: 16px;
      line-height: 1.5;
      width: 100%;
      overflow-x: hidden;
    }

    /* ===== Layout e Componentes ===== */
    .container {
      max-width: 1320px; /* Slightly wider */
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    h1 {
      font-size: 1.875rem; /* 30px */
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.03em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2rem;
      overflow-x: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE */
    }
    .tabs::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

    .tab {
      padding: 0.875rem 1.5rem; /* Slightly taller */
      font-weight: 600; /* Bolder */
      font-size: 0.9375rem; /* 15px */
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      margin-bottom: -1px; /* Overlap border */
    }

    .tab:hover {
      color: var(--text);
      background-color: var(--input-bg);
    }

    .tab.active {
      color: var(--primary);
      border-color: var(--primary);
    }

    .tab-content {
        display: none; /* Hide all by default */
        animation: fadeIn 0.5s ease-out;
    }

    .tab-content.active {
        display: block; /* Show active */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }


    /* KPIs Card */
     .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
      overflow: hidden;
      position: relative;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .kpi-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .kpi-title {
      font-size: 0.9375rem; /* 15px */
      font-weight: 500;
      color: var(--text-secondary);
    }

    .kpi-icon {
        color: var(--text-secondary);
        opacity: 0.7;
    }

    .kpi-value {
      font-size: 1.75rem; /* 28px */
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.8125rem; /* 13px */
      color: var(--text-secondary);
    }

    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 500;
    }

    .kpi-trend.up { color: var(--success); }
    .kpi-trend.down { color: var(--danger); }
    .kpi-trend.neutral { color: var(--text-secondary); }

    .kpi-trend svg {
      width: 0.875rem; /* 14px */
      height: 0.875rem;
      stroke-width: 2.5;
    }

    .progress-container {
      width: 100%;
      height: 0.5rem; /* 8px */
      background-color: var(--input-bg);
      border-radius: 1rem;
      overflow: hidden;
      margin-top: 0.25rem;
    }

    .progress-bar {
      height: 100%;
      border-radius: 1rem;
      transition: width 0.5s ease;
      background-color: var(--primary); /* Default to primary */
    }
    .progress-bar.success { background-color: var(--success); }
    .progress-bar.warning { background-color: var(--warning); }
    .progress-bar.danger { background-color: var(--danger); }


    /* Gráficos */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100%, 450px), 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

     .chart-container {
      position: relative;
      margin-top: 1rem;
      height: 280px; /* Increased height */
    }

    .chart-title {
      font-size: 1.125rem; /* 18px */
      font-weight: 600;
      letter-spacing: -0.01em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem; /* Reduced margin */
    }

    .chart-title-actions {
      display: flex;
      gap: 0.75rem;
    }

    .full-width {
      grid-column: 1 / -1;
    }
    .full-width .chart-container {
      height: 320px;
    }


    /* Análise Mensal */
    .analysis-header {
        display: flex;
        flex-direction: column; /* Stack filters vertically */
        gap: 1.5rem; /* Increased gap between rows */
        align-items: stretch; /* Make rows take full width */
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .filters { /* Container for filter rows */
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Gap between filter rows */
        width: 100%;
    }

    .filters-row { /* Row for filters */
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem; /* Gap between filters in a row */
        align-items: flex-end; /* Align labels and selects nicely */
    }
    .filters-row .form-group {
        flex: 1 1 180px; /* Allow filters to grow but have a base size */
    }


    .category-filter-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .btn-icon-small {
        padding: 0.5rem;
        min-width: auto;
        height: auto;
        background: var(--input-bg);
        color: var(--text);
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .btn-icon-small:hover {
        background-color: rgba(142, 142, 147, 0.2);
    }

    .btn-icon-small svg {
        width: 1rem; /* 16px */
        height: 1rem;
    }

    .btn-delete-category {
        color: var(--danger);
    }

    .analysis-indicators {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

     .indicator-card {
        background-color: var(--card-bg);
        border-radius: var(--radius-sm);
        padding: 1.25rem;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: var(--transition);
    }
    .indicator-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.07);
    }

    .indicator-title {
        font-size: 0.875rem; /* 14px */
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .indicator-value {
        font-size: 1.5rem; /* 24px */
        font-weight: 600;
        letter-spacing: -0.01em;
        line-height: 1.2;
    }
    .indicator-value.positive { color: var(--success); }
    .indicator-value.negative { color: var(--danger); }
    .indicator-value.neutral { color: var(--text); } /* Or var(--primary) */

    .indicator-comparison {
        font-size: 0.75rem; /* 12px */
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    .analysis-content {
        display: grid;
        grid-template-columns: 1fr 320px; /* Main content and sidebar */
        gap: 2rem;
    }

    .analysis-main {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .analysis-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .insights-feed {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
    }

    .insights-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary);
    }

    .insights-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 400px; /* Limit height */
        overflow-y: auto;
        padding-right: 0.5rem; /* Space for scrollbar */
    }

    .insight-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background-color: var(--insight-bg);
        border-radius: var(--radius-sm);
        font-size: 0.875rem; /* 14px */
        align-items: flex-start;
        line-height: 1.4;
    }

    .insight-icon {
        flex-shrink: 0;
        margin-top: 2px;
        font-size: 1rem;
    }

    .insight-item.alert { color: var(--danger); background-color: rgba(255, 59, 48, 0.08); }
    .insight-item.warning { color: var(--warning); background-color: rgba(255, 149, 0, 0.08); }
    .insight-item.success { color: var(--success); background-color: rgba(52, 199, 89, 0.08); }
    .insight-item.info { color: var(--primary); background-color: rgba(0, 122, 255, 0.08); }
    .insight-item.neutral { color: var(--text-secondary); background-color: var(--input-bg); }

    /* Simple Transaction List (Análise Mensal) */
    /* Ajustes para a lista de transações */
    .transaction-list-container {
        padding: 0 1.5rem 1.5rem 1.5rem;
        max-width: 100%;
        overflow-x: hidden;
    }

    .transaction-list {
        max-height: 550px; /* Aumentada para mais visibilidade */
        overflow-y: auto;
        padding-right: 0.5rem;
        width: 100%;
    }

    .transaction-item {
        position: relative;
        padding: 1rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        flex-wrap: nowrap;
        border-bottom: 1px solid var(--border);
        transition: background-color 0.15s ease;
        cursor: pointer;
    }
     .transaction-item:last-child {
        border-bottom: none;
    }

    .transaction-item:hover {
        margin: 0;
        padding: 1rem 0.5rem;
        background-color: var(--input-bg);
        border-radius: var(--radius-sm);
    }


    .transaction-item-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 0;
        flex: 1;
        margin-right: 1rem;
    }

    .transaction-icon {
        flex-shrink: 0;
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: #fff;
    }

    .transaction-info {
        min-width: 0;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .transaction-description, .transaction-category {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
     .transaction-description {
        font-weight: 500;
        font-size: 0.9375rem;
    }

    .transaction-category {
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }

     .transaction-item-right {
        text-align: right;
        display: flex;
        align-items: center;
        gap: 0.75rem; /* Ajustado */
        flex-shrink: 0;
    }

     .transaction-dates-amount-wrapper { /* Novo wrapper para datas e valor */
         display: flex;
         flex-direction: column;
         align-items: flex-end;
         min-width: 110px; /* Ajustado */
         margin-right: 0.5rem; /* Espaço antes do botão de excluir */
     }

     .transaction-dates { /* Novo wrapper para datas */
         display: flex;
         gap: 0.5rem; /* Espaço entre datas */
         font-size: 0.8125rem; /* 13px */
         color: var(--text-secondary);
         margin-top: 0.15rem; /* Pequeno espaço acima das datas */
         flex-wrap: wrap; /* Permite quebra se necessário */
         justify-content: flex-end;
     }
     .transaction-due-date.overdue {
         color: var(--status-overdue);
         font-weight: 600;
     }
      .transaction-due-date.upcoming {
         color: var(--status-pending);
         font-weight: 500;
     }


    .transaction-amount {
        font-weight: 600;
        font-size: 0.9375rem;
        display: flex; /* Para alinhar importância */
        align-items: center;
    }
    .transaction-amount.income { color: var(--success); }
    .transaction-amount.expense { color: var(--danger); }

    .transaction-importance {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-left: 6px; /* Ajustado */
        vertical-align: middle;
    }
    .transaction-importance.extrema { background-color: var(--importance-extrema); }
    .transaction-importance.urgente { background-color: var(--importance-urgente); }
    .transaction-importance.importante { background-color: var(--importance-importante); }

    /* Estilos para o botão de excluir */
    .btn-action {
        background: none; border: none; cursor: pointer; padding: 0.5rem;
        border-radius: 50%; transition: var(--transition); opacity: 0.5;
        display: flex; align-items: center; justify-content: center;
        line-height: 0; flex-shrink: 0;
    }
    .btn-action:hover { background-color: var(--input-bg); opacity: 1; }
    .btn-delete-transaction { color: var(--danger); }
    .btn-delete-transaction svg { width: 1rem; height: 1rem; }


    /* Botões */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.75rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600;
      font-size: 0.9375rem; cursor: pointer; transition: var(--transition); border: none;
      color: #fff; background-color: var(--primary); text-decoration: none; white-space: nowrap;
    }
    .btn:hover { opacity: 0.85; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); opacity: 0.75; }
    .btn-primary { background-color: var(--primary); }
    .btn-success { background-color: var(--success); }
    .btn-warning { background-color: var(--warning); color: var(--text); }
    .btn-danger { background-color: var(--danger); }
    .btn-secondary { background-color: var(--input-bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background-color: rgba(142, 142, 147, 0.2); }
    .btn svg { width: 1rem; height: 1rem; }

    /* Botão toggle theme */
    .theme-toggle {
      background: var(--input-bg); border: none; border-radius: 50%; width: 2.75rem; height: 2.75rem;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      color: var(--text); transition: var(--transition);
    }
    .theme-toggle:hover { background-color: rgba(142, 142, 147, 0.2); }
    .theme-toggle svg { width: 1.25rem; height: 1.25rem; }

    /* Select estilo Apple */
    select {
      appearance: none; -webkit-appearance: none; padding: 0.75rem 2.25rem 0.75rem 1rem;
      border-radius: var(--radius-sm); border: 1px solid var(--border);
      background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238A8A8E' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E") no-repeat;
      background-position: right 0.875rem center; background-size: 10px 6px;
      color: var(--text); font-family: var(--font-sans); font-size: 0.9375rem;
      font-weight: 500; cursor: pointer; transition: var(--transition); min-width: 150px;
    }
    [data-theme="dark"] select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238E8E93' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E"); }
    select:hover { border-color: rgba(60, 60, 67, 0.4); }
    select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); }
    select option { background-color: var(--card-bg); color: var(--text); }


    /* Modal */
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .modal.active { display: flex; opacity: 1; pointer-events: all; }
    .modal-content {
      background: var(--card-bg); border-radius: var(--radius-lg);
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 90%; max-width: 550px;
      max-height: 90vh; /* Garante que não exceda a altura da tela */
      overflow: hidden; /* Esconde overflow do container principal */
      display: flex; flex-direction: column;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; opacity: 0;
    }
    .modal.active .modal-content { opacity: 1; transform: scale(1) translateY(0); }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
    .modal-close {
      background: var(--input-bg); border: none; width: 2.25rem; height: 2.25rem; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      color: var(--text-secondary); transition: var(--transition); flex-shrink: 0;
    }
    .modal-close:hover { background-color: rgba(142, 142, 147, 0.3); color: var(--text); }
    .modal-close svg { width: 1rem; height: 1rem; }
    .modal-body {
      padding: 1.75rem;
      overflow-y: auto; /* !!! ESSENCIAL para rolagem interna !!! */
      flex-grow: 1; /* Permite que o corpo cresça e ocupe espaço */
       -webkit-overflow-scrolling: touch; /* Melhora rolagem no iOS */
    }
    .modal-footer {
      padding: 1.25rem 1.75rem; display: flex; justify-content: flex-end; gap: 0.75rem;
      border-top: 1px solid var(--border); background-color: var(--bg); flex-shrink: 0;
    }

    /* Formulários dentro do Modal */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .form-grid.single-col { grid-template-columns: 1fr; }
    .form-group { margin-bottom: 1rem; display: flex; flex-direction: column; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
    .form-control { width: 100%; padding: 0.875rem 1rem; font-size: 0.9375rem; border-radius: var(--radius-sm); border: 1px solid var(--border); background-color: var(--input-bg); color: var(--text); transition: var(--transition); font-family: var(--font-sans); }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--card-bg); }
    textarea.form-control { line-height: 1.4; min-height: 80px; }

    /* Transaction Modal Specifics */
    #transaction-modal .modal-content { max-width: 500px; }
    .input-group { display: flex; align-items: center; }
    .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
    .input-group-append { border: 1px solid var(--border); border-left: none; background-color: var(--input-bg); padding: 0 0.75rem; height: calc(1.5em + 1.75rem + 2px); display: flex; align-items: center; border-top-right-radius: var(--radius-sm); border-bottom-right-radius: var(--radius-sm); }
    .input-group-append button { margin-left: 0.5rem; }

    /* Campos avançados agora sempre visíveis - Change #3 */
     #advanced-fields {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px dashed var(--border);
        display: block; /* Sempre visível */
     }
    .btn-link#btn-toggle-advanced { display: none; } /* Esconde o botão de toggle */


    /* Importance Radio Buttons */
    .importance-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .importance-group input[type="radio"] { opacity: 0; position: fixed; width: 0; }
    .importance-group label { display: inline-block; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); font-size: 0.875rem; font-weight: 500; }
    .importance-group input[type="radio"]:checked + label { background-color: var(--primary); color: #fff; border-color: var(--primary); }
    .importance-group input[type="radio"]:focus + label { box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); }
    .importance-group label[for="importance-extrema"] { border-left: 4px solid var(--importance-extrema); padding-left: calc(1rem - 4px); }
    .importance-group label[for="importance-urgente"] { border-left: 4px solid var(--importance-urgente); padding-left: calc(1rem - 4px); }
    .importance-group label[for="importance-importante"] { border-left: 4px solid var(--importance-importante); padding-left: calc(1rem - 4px); }
    .importance-group input[type="radio"]:checked + label[for="importance-extrema"] { background-color: var(--importance-extrema); border-color: var(--importance-extrema); }
    .importance-group input[type="radio"]:checked + label[for="importance-urgente"] { background-color: var(--importance-urgente); border-color: var(--importance-urgente); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-importante"] { background-color: var(--importance-importante); border-color: var(--importance-importante); color: var(--text); }


    /* Category Modal Specifics */
    #category-modal .modal-content { max-width: 400px; }
    /* Confirm Modal Specifics */
    #confirm-modal .modal-content { max-width: 400px; }
    #confirm-modal-message { margin-bottom: 1rem; line-height: 1.4; }


    /* Loading Estado */
    .loading-indicator {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center;
      z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .loading-indicator.active { display: flex; opacity: 1; pointer-events: all; }
    .spinner {
      width: 2.5rem; height: 2.5rem; border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%;
      border-top-color: #fff; animation: spin 0.8s ease-in-out infinite;
    }
    [data-theme="dark"] .spinner { border-color: rgba(255, 255, 255, 0.2); border-top-color: #fff; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Alertas / Toast Notifications */
    .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; }
    .toast { background-color: var(--card-bg); color: var(--text); padding: 0.875rem 1.25rem; border-radius: var(--radius-sm); box-shadow: var(--shadow-dropdown); display: flex; align-items: center; gap: 0.75rem; min-width: 250px; max-width: 400px; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000); border-left: 4px solid var(--primary); pointer-events: none; }
    .toast.show { opacity: 1; transform: translateX(0); pointer-events: all; }
    .toast-icon { font-size: 1.25rem; flex-shrink: 0; }
    .toast.success { border-left-color: var(--success); } .toast.warning { border-left-color: var(--warning); } .toast.danger { border-left-color: var(--danger); } .toast.info { border-left-color: var(--primary); }

    /* Responsividade */
    @media (max-width: 1200px) { .analysis-content { grid-template-columns: 1fr; } .analysis-sidebar { grid-row: 2; } }
    @media (max-width: 992px) { .container { padding: 1.5rem; } .header { flex-direction: column; align-items: flex-start; } .header-right { width: 100%; justify-content: space-between; } .charts-grid { grid-template-columns: 1fr; } .chart-container { height: 260px; } .full-width .chart-container { height: 300px; } .filters-row { flex-direction: column; align-items: stretch; } .filters-row .form-group { width: 100%; flex-basis: auto; } }
    @media (max-width: 768px) { h1 { font-size: 1.625rem; } .kpis { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .analysis-indicators { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } .btn { padding: 0.625rem 1.25rem; font-size: 0.875rem; } select { padding: 0.625rem 2rem 0.625rem 0.875rem; font-size: 0.875rem; } .form-grid { grid-template-columns: 1fr; } .transaction-item { flex-direction: column; align-items: stretch; gap: 0.5rem; } .transaction-item-left { margin-right: 0; width: 100%; justify-content: flex-start; } .transaction-item-right { flex-direction: row; justify-content: space-between; align-items: center; text-align: left; margin-top: 0; width: 100%; } .transaction-dates-amount-wrapper { align-items: flex-start; } .modal-content { width: 95%; } .modal-body, .modal-header, .modal-footer { padding: 1.25rem; } .tabs { margin-bottom: 1.5rem; } .tab { padding: 0.75rem 1rem; font-size: 0.875rem; } .analysis-content { grid-template-columns: 1fr; } .analysis-main, .analysis-sidebar { grid-column: 1 / -1; } .analysis-header { gap: 1rem; } }
    @media (max-width: 576px) { .container { padding: 1rem; } h1 { font-size: 1.5rem; } .kpis { grid-template-columns: 1fr; } .analysis-indicators { grid-template-columns: 1fr; } .header-right { flex-direction: column; align-items: stretch; gap: 0.75rem; } .filters-row { gap: 0.75rem; } .header-right .btn { width: 100%; } .theme-toggle { align-self: flex-end; } .toast-container { right: 1rem; bottom: 1rem; left: 1rem; align-items: stretch; } .toast { width: 100%; max-width: 100%; } .transaction-item-right { flex-wrap: wrap; gap: 0.25rem;} .transaction-dates-amount-wrapper { margin-right: auto; } .btn-delete-transaction { padding: 0.3rem; } }

    /* Print styles */
    @media print { body { background-color: #fff; color: #000; } .header, .tabs, .theme-toggle, .btn, .modal, .loading-indicator, .toast-container, .analysis-sidebar, .analysis-header .filters button, .btn-delete-transaction { display: none !important; } .container { max-width: 100%; padding: 0; } .card, .kpi-card, .indicator-card, .transaction-list-container, .insights-feed, .analysis-header { box-shadow: none; border: 1px solid #ddd; border-radius: 0; padding: 1rem; page-break-inside: avoid; background-color: #fff !important; } .analysis-header { border-bottom: 1px solid #ddd; } .kpis, .charts-grid, .analysis-indicators, .analysis-content, .analysis-main { grid-template-columns: 1fr !important; gap: 1rem; } .analysis-content { display: block; } .analysis-main { margin-bottom: 1rem; } .analysis-header .filters { display: block; } .analysis-header .filters-row { display: block; margin-bottom: 0.5rem; } .analysis-header .form-group label { display: inline; margin-right: 0.5rem; } .analysis-header select { border: none; appearance: none; -webkit-appearance: none; padding-right: 1rem; background: none; font-weight: bold; display: inline; } canvas { max-width: 100%; } .transaction-item { border-bottom: 1px solid #eee; flex-direction: row; align-items: center;} .transaction-item-left { width: auto; margin-right: 1rem;} .transaction-item-right { width: auto; flex-direction: row; align-items: center; text-align: right;} .transaction-item:hover { background-color: transparent; margin: 0; padding: 1rem 0; border-radius: 0; } :root { --text: #000; --text-secondary: #555; --success: #008000; --danger: #D00000; --primary: #0000FF; --warning: #FFA500; } .indicator-value.positive, .kpi-trend.up, .transaction-amount.income { color: var(--success) !important; } .indicator-value.negative, .kpi-trend.down, .transaction-amount.expense { color: var(--danger) !important; } .progress-bar { background-color: #ccc !important; } }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <h1>Calculadora Financeira</h1>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" id="btn-new-transaction">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
          Nova Transação
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema">
            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>
        </button>
      </div>
    </div>

    <!-- Tabs de Navegação -->
    <div class="tabs">
      <div class="tab active" data-tab="overview">Visão Geral</div>
      <div class="tab" data-tab="analysis">Análise Mensal</div>
    </div>

    <!-- Conteúdo das Tabs -->
    <div id="tab-contents">
        <!-- Aba Visão Geral -->
        <div class="tab-content active" id="tab-overview">
            <!-- KPIs -->
            <div class="kpis">
                <div class="card kpi-card">
                    <div class="kpi-header"><div class="kpi-title">Saldo Atual</div><svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM1 8a7 7 0 1 1 14 0A7 7 0 0 1 1 8z"/><path d="M8 4a.5.5 0 0 1 .5.5v3.793l2.146 2.147a.5.5 0 0 1-.708.708l-2.5-2.5A.5.5 0 0 1 7.5 8V4.5A.5.5 0 0 1 8 4z"/></svg></div>
                    <div class="kpi-value" id="kpi-balance">R$ 0,00</div>
                    <div class="kpi-footer"><div class="kpi-trend neutral" id="balance-trend-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/></svg><span id="balance-trend">--%</span></div><span>vs. mês anterior</span></div>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-header"><div class="kpi-title">Receitas (Mês)</div><svg class="kpi-icon" style="color: var(--success);" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg></div>
                    <div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div>
                    <div class="kpi-footer"><div class="kpi-trend neutral" id="income-trend-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/></svg><span id="income-trend">--%</span></div><span>vs. mês anterior</span></div>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-header"><div class="kpi-title">Despesas (Mês)</div><svg class="kpi-icon" style="color: var(--danger);" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/></svg></div>
                    <div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div>
                    <div class="kpi-footer"><div class="kpi-trend neutral" id="expenses-trend-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/></svg><span id="expenses-trend">--%</span></div><span>vs. mês anterior</span></div>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-header"><div class="kpi-title">Economia do Mês</div><svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg></div>
                    <div class="kpi-value" id="kpi-savings">R$ 0,00</div>
                    <div class="kpi-footer"><span id="savings-status">Calculando...</span></div>
                    <div class="progress-container"><div class="progress-bar" id="savings-progress" style="width: 0%"></div></div>
                </div>
                <div class="card kpi-card">
                    <div class="kpi-header"><div class="kpi-title">Projeção de Gastos (Mês)</div><svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg></div>
                    <div class="kpi-value" id="kpi-projection">R$ 0,00</div>
                    <div class="kpi-footer"><span id="projection-status">--</span></div>
                </div>
            </div>

            <!-- Gráficos de Visão Geral -->
            <div class="charts-grid">
                <div class="card"><div class="chart-title"><span>Receitas vs Despesas (Últimos 12 Meses)</span></div><div class="chart-container"><canvas id="overview-income-expense-chart"></canvas></div></div>
                <div class="card"><div class="chart-title"><span>Despesas por Categoria (Últimos 30 dias)</span></div><div class="chart-container"><canvas id="overview-category-chart"></canvas></div></div>
                <div class="card full-width"><div class="chart-title"><span>Fluxo de Caixa Mensal (Ano Atual)</span></div><div class="chart-container"><canvas id="overview-cashflow-chart"></canvas></div></div>
                <div class="card"><div class="chart-title"><span>Fixas vs Variáveis (Mês Atual)</span></div><div class="chart-container"><canvas id="overview-fixed-variable-chart"></canvas></div></div>
                <div class="card"><div class="chart-title"><span>Tendência Geral de Gastos (Últimos 6 Meses)</span></div><div class="chart-container"><canvas id="overview-trend-chart"></canvas></div></div>
            </div>
        </div>

        <!-- Aba Análise Mensal -->
        <div class="tab-content" id="tab-analysis">
            <!-- Filtros Inteligentes -->
            <div class="analysis-header">
                 <div class="filters">
                    <div class="filters-row">
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-year" style="margin-bottom: 0.25rem;">Ano</label><select id="analysis-year"></select></div>
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-month" style="margin-bottom: 0.25rem;">Mês</label><select id="analysis-month"></select></div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="analysis-category" style="margin-bottom: 0.25rem;">Filtrar Categoria</label>
                            <div class="category-filter-group">
                                <select id="analysis-category"><option value="all">Todas as Categorias</option></select>
                                <button class="btn-icon-small" id="btn-add-category" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                                <button class="btn-icon-small btn-delete-category" id="btn-delete-category" title="Excluir Categoria Selecionada" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                            </div>
                        </div>
                    </div>
                    <div class="filters-row">
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-type" style="margin-bottom: 0.25rem;">Tipo de Transação</label><select id="analysis-type"><option value="all">Todas</option><option value="income">Receitas</option><option value="expense">Despesas</option></select></div>
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-status" style="margin-bottom: 0.25rem;">Status</label><select id="analysis-status"><option value="all">Todos</option><option value="paid">Pago</option><option value="pending">Pendente</option><option value="scheduled">Agendado</option></select></div>
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-importance" style="margin-bottom: 0.25rem;">Importância</label><select id="analysis-importance"><option value="all">Todas</option><option value="extrema">Extrema</option><option value="urgente">Urgente</option><option value="importante">Importante</option><option value="none">Sem importância</option></select></div>
                    </div>
                </div>
            </div>
            <!-- Fim Filtros Inteligentes -->


            <!-- Indicadores e Inteligência Mensal -->
            <div class="analysis-indicators">
                <div class="indicator-card"><div class="indicator-title">Receitas Totais</div><div class="indicator-value positive" id="analysis-total-income">R$ 0,00</div><div class="indicator-comparison" id="analysis-income-comparison">-- vs mês anterior</div></div>
                <div class="indicator-card"><div class="indicator-title">Despesas Totais</div><div class="indicator-value negative" id="analysis-total-expenses">R$ 0,00</div><div class="indicator-comparison" id="analysis-expense-comparison">-- vs mês anterior</div></div>
                <div class="indicator-card"><div class="indicator-title">Saldo Final</div><div class="indicator-value neutral" id="analysis-final-balance">R$ 0,00</div><div class="indicator-comparison" id="analysis-balance-comparison">-- vs mês anterior</div></div>
                <div class="indicator-card"><div class="indicator-title">Status do Mês</div><div class="indicator-value neutral" id="analysis-month-status">--</div><div class="indicator-comparison" id="analysis-days-left">-- dias restantes</div></div>
                <div class="indicator-card"><div class="indicator-title">Maior Gasto</div><div class="indicator-value neutral" id="analysis-top-category">--</div><div class="indicator-comparison" id="analysis-top-category-value">R$ 0,00</div></div>
            </div>

             <!-- Conteúdo Principal e Sidebar -->
            <div class="analysis-content">
                <!-- Conteúdo Principal (Gráficos e Lista) -->
                <div class="analysis-main">
                     <!-- Gráficos da Análise Mensal -->
                    <div class="charts-grid">
                        <div class="card"><div class="chart-title">Distribuição de Despesas</div><div class="chart-container"><canvas id="analysis-category-pie-chart"></canvas></div></div>
                        <div class="card"><div class="chart-title">Evolução do Saldo no Mês</div><div class="chart-container"><canvas id="analysis-balance-line-chart"></canvas></div></div>
                    </div>
                    <!-- Lista Simples de Transações -->
                    <div class="transaction-list-container">
                        <div class="transaction-list-title">Transações do Mês (Ordenado por Vencimento)</div>
                        <div id="analysis-transaction-list" class="transaction-list">
                            <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary); display: none;" id="analysis-no-transactions">Nenhuma transação encontrada para os filtros selecionados.</div>
                        </div>
                    </div>
                </div>
                <!-- Sidebar (Insights) -->
                <aside class="analysis-sidebar">
                    <div class="insights-feed card">
                        <div class="insights-title"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8a8 8 0 1 1-16 0 8 8 0 0 1 16 0zM8 4.002a.5.5 0 0 0-.495.57l.5 4a.5.5 0 0 0 .99 0l.5-4A.5.5 0 0 0 8 4.002zm-.002 7a.5.5 0 1 0 0 1 .5.5 0 0 0 0-1z"/></svg>Insights Rápidos</div>
                        <div class="insights-list" id="analysis-insights-list">
                            <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);" id="analysis-no-insights">Analisando seus dados...</div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div> <!-- Fim #tab-contents -->
  </div> <!-- Fim .container -->

  <!-- Modal de Nova Transação -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
        <form id="transaction-form">
            <input type="hidden" id="transaction-id">
            <input type="hidden" id="transaction-recurring-base-id">
            <div class="modal-header">
                <h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3>
                <button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button>
            </div>
            <div class="modal-body">
                <!-- Campos Essenciais (Reorganizados) -->
                 <div class="form-group">
                    <label for="transaction-description">Descrição</label>
                    <input type="text" class="form-control" id="transaction-description" placeholder="Ex: Supermercado da semana, Salário..." required>
                </div>
                 <div class="form-grid">
                    <div class="form-group">
                        <label for="transaction-amount">Valor (R$)</label>
                        <input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required>
                    </div>
                    <div class="form-group">
                        <label for="transaction-type">Tipo</label>
                        <select class="form-control" id="transaction-type" required>
                            <option value="expense" selected>Despesa</option>
                            <option value="income">Receita</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                     <label for="transaction-category">Categoria</label>
                     <div class="input-group">
                        <select class="form-control" id="transaction-category" required></select>
                        <div class="input-group-append"><button type="button" class="btn-icon-small" id="btn-add-category-modal" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button></div>
                    </div>
                </div>
                 <div class="form-grid">
                     <div class="form-group">
                        <label for="transaction-date">Data <small>(Pagamento/Recebimento)</small></label>
                        <input type="date" class="form-control" id="transaction-date" required>
                    </div>
                    <div class="form-group">
                        <label for="transaction-due-date">Data Vencimento <small>(Opcional)</small></label>
                        <input type="date" class="form-control" id="transaction-due-date">
                    </div>
                 </div>
                 <div class="form-group">
                    <label>Importância</label>
                    <div class="importance-group">
                        <input type="radio" id="importance-extrema" name="transaction-importance" value="extrema"><label for="importance-extrema">Extrema</label>
                        <input type="radio" id="importance-urgente" name="transaction-importance" value="urgente"><label for="importance-urgente">Urgente</label>
                        <input type="radio" id="importance-importante" name="transaction-importance" value="importante"><label for="importance-importante">Importante</label>
                    </div>
                </div>

                <!-- Campos que eram avançados, agora sempre visíveis - Change #3 -->
                <div id="advanced-fields">
                     <div class="form-grid">
                        <div class="form-group">
                            <label for="transaction-status">Status</label>
                            <select class="form-control" id="transaction-status" required>
                                <option value="paid" selected>Pago</option>
                                <option value="pending">Pendente</option>
                                <option value="scheduled">Agendado</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="transaction-payment-method">Forma de Pagamento</label>
                            <select class="form-control" id="transaction-payment-method">
                                <option value="">Nenhuma</option><option value="cash">Dinheiro</option><option value="credit_card">Cartão de Crédito</option><option value="debit_card">Cartão de Débito</option><option value="bank_transfer">Transferência</option><option value="pix">PIX</option><option value="boleto">Boleto</option><option value="other">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="transaction-notes">Observações</label>
                        <textarea class="form-control" id="transaction-notes" rows="3" placeholder="Ex: Parcela 2/12, Referente ao projeto X..."></textarea>
                    </div>
                    <!-- Recorrência -->
                    <div id="recurring-transaction-container">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;"><input type="checkbox" id="transaction-recurring" style="width: auto; height: auto; transform: scale(1.2);"><label for="transaction-recurring" style="margin-bottom: 0; font-weight: 500;">É uma transação recorrente? (Ex: Aluguel, Parcela)</label></div>
                        <div id="recurring-options" style="display: none;">
                          <div class="form-grid"><div class="form-group"><label for="transaction-frequency">Frequência</label><select class="form-control" id="transaction-frequency"><option value="daily">Diária</option><option value="weekly">Semanal</option><option value="biweekly">Quinzenal</option><option value="monthly" selected>Mensal</option><option value="bimonthly">Bimestral</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="annual">Anual</option></select></div><div class="form-group"><label for="transaction-installments">Número de Parcelas</label><input type="number" min="2" step="1" class="form-control" id="transaction-installments" placeholder="Ex: 12"><small style="color: var(--text-secondary); font-size: 0.75rem;">Deixe em branco se for contínuo (sem fim).</small></div></div>
                           <div id="edit-recurring-options" style="margin-top:1rem; padding: 1rem; background-color: var(--input-bg); border-radius: var(--radius-sm); display: none;"><p style="font-weight: 500; margin-bottom: 0.5rem;">Editando transação recorrente:</p><div style="display: flex; flex-direction: column; gap: 0.5rem;"><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="this" checked> Aplicar somente a esta ocorrência</label><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="future"> Aplicar a esta e futuras ocorrências</label></div></div>
                        </div>
                    </div>
                </div>
            </div> <!-- Fim .modal-body -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="transaction-modal-save">Salvar Transação</button>
            </div>
        </form>
    </div>
</div>


  <!-- Modal de Nova Categoria -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
         <form id="category-form"><div class="modal-header"><h3 class="modal-title" id="category-modal-title">Nova Categoria</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div><div class="modal-body"><div class="form-group"><label for="category-name">Nome da Nova Categoria</label><input type="text" class="form-control" id="category-name" placeholder="Ex: Assinaturas, Educação Filhos" required></div><div class="form-group"><label for="category-type">Tipo de Categoria</label><select class="form-control" id="category-type" required><option value="expense" selected>Despesa</option><option value="income">Receita</option></select></div><div class="form-group"><label for="category-icon">Ícone (Emoji)</label><input type="text" class="form-control" id="category-icon" placeholder="Ex: 🎓,  assinatura  assinatura" maxlength="2"></div><div class="form-group"><label for="category-color">Cor</label><input type="color" class="form-control" id="category-color" value="#8A8A8E"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="category-modal-save">Salvar Categoria</button></div></form>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div class="modal" id="confirm-modal">
    <div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="confirm-modal-title">Confirmação</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div><div class="modal-body"><p id="confirm-modal-message">Tem certeza que deseja realizar esta ação?</p><div id="confirm-modal-extra-info" style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button></div></div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-indicator" id="loading"><div class="spinner"></div></div>
  <!-- Toast Notification Container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
    // ===== Configurações Globais e Firebase =====
    const root = document.documentElement;
    const loading = document.getElementById('loading');
    moment.locale('pt-br');

    const firebaseConfig = { /* ... Sua Configuração Firebase ... */ };
     // Configuração Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY", // Use aspas aqui
        authDomain: "calculadora-da-familia.firebaseapp.com",
        projectId: "calculadora-da-familia",
        storageBucket: "calculadora-da-familia.appspot.com",
        messagingSenderId: "69721783786",
        appId: "1:69721783786:web:c4703b5c182e3681e8c693",
        measurementId: "G-YM5TR661S6"
    };


    // Inicializar Firebase
    let app; let db;
    try { if (!firebase.apps.length) { app = firebase.initializeApp(firebaseConfig); } else { app = firebase.app(); } db = firebase.firestore(); console.log("Firebase inicializado com sucesso!"); }
    catch (error) { console.error("Erro ao inicializar Firebase:", error); showToast("Erro crítico ao conectar com o banco de dados.", "danger", 10000); db = null; }

    // Coleções Firestore
    const transactionsCollection = db ? db.collection('transactions') : null;
    const categoriesCollection = db ? db.collection('categories') : null;

    // ===== Estados da Aplicação =====
    let transactions = []; let categories = []; let currentTab = 'overview';
    let currentAnalysisMonthYear = moment().format('YYYY-MM'); // Formato interno
    let currentAnalysisCategory = 'all'; let currentAnalysisType = 'all';
    let currentAnalysisImportance = 'all'; let currentAnalysisStatus = 'all'; // Novo filtro de Status
    let unsubscribeTransactions = null; let unsubscribeCategories = null;
    let overviewCharts = {}; let analysisCharts = {};

    // ===== Constantes e Mapas (sem alterações) =====
    const TRANSACTION_TYPES = { income: { name: 'Receita', icon: '💰', colorClass: 'positive' }, expense: { name: 'Despesa', icon: '💸', colorClass: 'negative' }};
    const PAYMENT_METHODS = { 'cash': 'Dinheiro', 'credit_card': 'Cartão de Crédito', 'debit_card': 'Cartão de Débito', 'bank_transfer': 'Transferência', 'pix': 'PIX', 'boleto': 'Boleto', 'other': 'Outro' };
    const TRANSACTION_STATUS = { 'paid': { name: 'Pago', class: 'status-paid', color: 'var(--success)'}, 'pending': { name: 'Pendente', class: 'status-pending', color: 'var(--status-pending)'}, 'scheduled': { name: 'Agendado', class: 'status-scheduled', color: 'var(--status-scheduled)'} };
    const RECURRENCE_FREQUENCY = { 'daily': { name: 'Diária', momentUnit: 'days', momentStep: 1 }, 'weekly': { name: 'Semanal', momentUnit: 'weeks', momentStep: 1 }, 'biweekly': { name: 'Quinzenal', momentUnit: 'weeks', momentStep: 2 }, 'monthly': { name: 'Mensal', momentUnit: 'months', momentStep: 1 }, 'bimonthly': { name: 'Bimestral', momentUnit: 'months', momentStep: 2 }, 'quarterly': { name: 'Trimestral', momentUnit: 'months', momentStep: 3 }, 'semiannual': { name: 'Semestral', momentUnit: 'months', momentStep: 6 }, 'annual': { name: 'Anual', momentUnit: 'years', momentStep: 1 }};
    const DEFAULT_EXPENSE_CATEGORIES = [ { id: 'moradia', name: 'Moradia', type: 'expense', color: '#FF9500', icon: '🏠', isDefault: true }, { id: 'alimentacao', name: 'Alimentação', type: 'expense', color: '#34C759', icon: '🍔', isDefault: true }, { id: 'transporte', name: 'Transporte', type: 'expense', color: '#007AFF', icon: '🚗', isDefault: true }, { id: 'contas', name: 'Contas Fixas', type: 'expense', color: '#5AC8FA', icon: '💡', isDefault: true }, { id: 'lazer', name: 'Lazer', type: 'expense', color: '#AF52DE', icon: '🎮', isDefault: true }, { id: 'saude', name: 'Saúde', type: 'expense', color: '#FF3B30', icon: '🏥', isDefault: true }, { id: 'compras', name: 'Compras', type: 'expense', color: '#FFCC00', icon: '🛍️', isDefault: true }, { id: 'educacao', name: 'Educação', type: 'expense', color: '#5856D6', icon: '📚', isDefault: true }, { id: 'outros_despesas', name: 'Outras Despesas', type: 'expense', color: '#8E8E93', icon: '📋', isDefault: true }];
    const DEFAULT_INCOME_CATEGORIES = [ { id: 'salario', name: 'Salário', type: 'income', color: '#34C759', icon: '💰', isDefault: true }, { id: 'freelance', name: 'Freelance/Extra', type: 'income', color: '#007AFF', icon: '💼', isDefault: true }, { id: 'investimentos', name: 'Investimentos', type: 'income', color: '#AF52DE', icon: '📈', isDefault: true }, { id: 'outros_receitas', name: 'Outras Receitas', type: 'income', color: '#8E8E93', icon: '💸', isDefault: true }];

    // ===== Utilitários (sem alterações) =====
    const formatCurrency = (value) => { if (typeof value !== 'number' || isNaN(value)) { return 'R$ 0,00'; } return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    const formatDate = (dateString) => dateString ? moment(dateString).format('DD/MM') : '--'; // Formato mais curto
    const formatFullDate = (dateString) => dateString ? moment(dateString).format('DD/MM/YYYY') : '--';
    const formatDateForInput = (date = new Date()) => moment(date).format('YYYY-MM-DD');
    const showLoading = () => loading.classList.add('active'); const hideLoading = () => loading.classList.remove('active');
    function showToast(message, type = 'info', duration = 3000) { const toastContainer = document.getElementById('toast-container'); if (!toastContainer) return; const toastId = `toast-${Date.now()}`; const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.id = toastId; let icon = 'ℹ️'; if (type === 'success') icon = '✅'; if (type === 'warning') icon = '⚠️'; if (type === 'danger') icon = '❌'; toast.innerHTML = `<span class="toast-icon">${icon}</span><span class="toast-message">${message}</span>`; toastContainer.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); const timeoutId = setTimeout(() => { toast.classList.remove('show'); const removeElement = () => { if(toast.parentNode) { toast.removeEventListener('transitionend', removeElement); toast.parentNode.removeChild(toast); } clearTimeout(failsafeTimeoutId); }; const failsafeTimeoutId = setTimeout(removeElement, 500); toast.addEventListener('transitionend', removeElement); }, duration); }
    function updateThemeIcon(theme) { const themeIcon = document.getElementById('theme-icon'); if (!themeIcon) return; if (theme === 'dark') { themeIcon.innerHTML = `<path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.708l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707z"/>`; } else { themeIcon.innerHTML = `<path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>`; } }
    function setupTheme() { const savedTheme = localStorage.getItem('theme'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; const theme = savedTheme || (prefersDark ? 'dark' : 'light'); root.setAttribute('data-theme', theme); updateThemeIcon(theme); }
    function toggleTheme() { const currentTheme = root.getAttribute('data-theme'); const newTheme = currentTheme === 'light' ? 'dark' : 'light'; root.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); updateThemeIcon(newTheme); updateAllChartsTheme(); }

    // ===== Gerenciamento de Dados (Firestore) (sem alterações) =====
    async function loadCategories() { if (!categoriesCollection) { console.error("Coleção de Categorias não inicializada."); showToast("Erro: Não foi possível conectar à base de dados de categorias.", "danger"); categories = [...DEFAULT_INCOME_CATEGORIES, ...DEFAULT_EXPENSE_CATEGORIES].sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); return; } return new Promise(async (resolve, reject) => { try { const snapshot = await categoriesCollection.get(); let loadedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (loadedCategories.length === 0 && db) { console.log("Nenhuma categoria encontrada, adicionando padrões..."); const batch = db.batch(); const defaultCategories = [...DEFAULT_INCOME_CATEGORIES, ...DEFAULT_EXPENSE_CATEGORIES]; defaultCategories.forEach(cat => { const docRef = categoriesCollection.doc(cat.id); batch.set(docRef, cat); }); await batch.commit(); console.log("Categorias padrão adicionadas."); loadedCategories = defaultCategories; } categories = loadedCategories.sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); resolve(); } catch (error) { console.error("Erro ao carregar/garantir categorias:", error); showToast("Erro ao carregar categorias.", "danger"); categories = [...DEFAULT_INCOME_CATEGORIES, ...DEFAULT_EXPENSE_CATEGORIES].sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); reject(error); } }); }
    async function addCategory(name, type, icon, color) { if (!categoriesCollection) { showToast("Erro: Não é possível adicionar categoria (sem conexão).", "danger"); return false; } showLoading(); try { const newCategory = { name: name.trim(), type, icon: icon || (type === 'income' ? '💰' : '💸'), color: color || '#8E8E93', isDefault: false }; const docRef = await categoriesCollection.add(newCategory); console.log("Categoria adicionada com ID: ", docRef.id); showToast("Categoria adicionada com sucesso!", "success"); return true; } catch (error) { console.error("Erro ao adicionar categoria: ", error); showToast("Erro ao salvar categoria. Tente novamente.", "danger"); return false; } finally { hideLoading(); } }
    async function deleteCategory(categoryId) { if (!categoriesCollection || !transactionsCollection) { showToast("Erro: Não é possível excluir categoria (sem conexão).", "danger"); return false; } showLoading(); try { const categoryToDelete = categories.find(c => c.id === categoryId); if (categoryToDelete?.isDefault) { showToast("Não é possível excluir categorias padrão.", "warning"); hideLoading(); return false; } const querySnapshot = await transactionsCollection.where('category', '==', categoryId).limit(1).get(); if (!querySnapshot.empty) { showToast("Não é possível excluir. Existem transações associadas a esta categoria.", "warning", 5000); hideLoading(); return false; } await categoriesCollection.doc(categoryId).delete(); console.log("Categoria excluída: ", categoryId); showToast("Categoria excluída com sucesso!", "success"); return true; } catch (error) { console.error("Erro ao excluir categoria: ", error); showToast("Erro ao excluir categoria. Tente novamente.", "danger"); return false; } finally { hideLoading(); } }
    function processTransactionSnapshot(snapshot) { transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); transactions.sort((a, b) => { const dateA = a.date ? moment(a.date) : moment(0); const dateB = b.date ? moment(b.date) : moment(0); return dateB.diff(dateA); }); console.log(`Transações atualizadas: ${transactions.length} encontradas.`); updateDashboard(); }
    function processCategorySnapshot(snapshot) { let loadedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); categories = loadedCategories.sort((a, b) => a.name.localeCompare(b.name)); console.log(`Categorias atualizadas: ${categories.length} encontradas.`); populateCategoryFilters(); if (currentTab === 'analysis') { updateMonthlyAnalysis(); } updateOverviewCharts(); }
    function setupFirestoreListeners() { if (unsubscribeTransactions) { unsubscribeTransactions(); unsubscribeTransactions = null; } if (unsubscribeCategories) { unsubscribeCategories(); unsubscribeCategories = null; } if (transactionsCollection) { unsubscribeTransactions = transactionsCollection.onSnapshot( processTransactionSnapshot, (error) => { console.error("Erro no listener de transações:", error); showToast("Erro ao sincronizar transações.", "danger"); transactions = []; updateDashboard(); }); } else { console.warn("Listener de Transações não iniciado - coleção não disponível."); } if (categoriesCollection) { unsubscribeCategories = categoriesCollection.onSnapshot( processCategorySnapshot, (error) => { console.error("Erro no listener de categorias:", error); showToast("Erro ao sincronizar categorias.", "danger"); if(categories.length === 0) { categories = [...DEFAULT_INCOME_CATEGORIES, ...DEFAULT_EXPENSE_CATEGORIES].sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); }}); } else { console.warn("Listener de Categorias não iniciado - coleção não disponível."); } }
    function stopFirestoreListeners() { if (unsubscribeTransactions) unsubscribeTransactions(); if (unsubscribeCategories) unsubscribeCategories(); unsubscribeTransactions = null; unsubscribeCategories = null; console.log("Listeners do Firestore desligados."); }

    // ===== Lógica de Transações =====
    // Modificada para incluir dueDate e remover campos avançados
    function openTransactionModal(transaction = null) {
        const modalElement = document.getElementById('transaction-modal');
        const form = document.getElementById('transaction-form');
        if (!modalElement || !form) return;
        form.reset(); // Limpa o formulário

        const modalTitle = document.getElementById('transaction-modal-title');
        const transactionIdInput = document.getElementById('transaction-id');
        const recurringOptions = document.getElementById('recurring-options');
        const editRecurringOptions = document.getElementById('edit-recurring-options');
        const recurringBaseIdInput = document.getElementById('transaction-recurring-base-id');

        // Reset recorrência
        recurringOptions.style.display = 'none';
        document.getElementById('transaction-recurring').checked = false;
        document.getElementById('transaction-installments').value = '';
        recurringBaseIdInput.value = '';
        editRecurringOptions.style.display = 'none';

        // Define valores padrão
        document.getElementById('transaction-description').value = ''; // Limpa descrição
        document.getElementById('transaction-amount').value = ''; // Limpa valor
        document.getElementById('transaction-date').value = formatDateForInput(); // Data de hoje
        document.getElementById('transaction-due-date').value = ''; // Limpa vencimento
        document.getElementById('transaction-type').value = 'expense'; // Default despesa
        document.getElementById('transaction-status').value = 'paid'; // Default pago
        document.getElementById('transaction-payment-method').value = ''; // Default nenhum
        document.getElementById('transaction-notes').value = ''; // Limpa notas
        populateCategorySelect('expense'); // Popula categorias de despesa

        // Remove seleção de importância
        const importanceRadios = document.querySelectorAll('input[name="transaction-importance"]');
        importanceRadios.forEach(radio => radio.checked = false);

        if (transaction) {
            // --- MODO EDIÇÃO ---
            modalTitle.textContent = 'Editar Transação';
            transactionIdInput.value = transaction.id;
            document.getElementById('transaction-description').value = transaction.description || '';
            document.getElementById('transaction-amount').value = transaction.amount;
            document.getElementById('transaction-date').value = transaction.date || formatDateForInput(); // Usa data atual se não existir
            document.getElementById('transaction-due-date').value = transaction.dueDate || ''; // Popula vencimento
            document.getElementById('transaction-type').value = transaction.type;
            populateCategorySelect(transaction.type); // Atualiza categorias para o tipo correto
            document.getElementById('transaction-category').value = transaction.category; // Seleciona a categoria
            document.getElementById('transaction-status').value = transaction.status || 'paid';
            document.getElementById('transaction-payment-method').value = transaction.paymentMethod || '';
            document.getElementById('transaction-notes').value = transaction.notes || '';

            // Seleciona importância
            if (transaction.importance) {
                 const importanceRadio = document.getElementById(`importance-${transaction.importance}`);
                 if(importanceRadio) importanceRadio.checked = true;
            }

             // Recorrência
             const recurringCheckbox = document.getElementById('transaction-recurring');
             const frequencySelect = document.getElementById('transaction-frequency');
             const installmentsInput = document.getElementById('transaction-installments');

             if (transaction.recurringInfo && transaction.recurringInfo.baseId) {
                 recurringBaseIdInput.value = transaction.recurringInfo.baseId;
                 recurringCheckbox.checked = true;
                 recurringOptions.style.display = 'block';
                 frequencySelect.value = transaction.recurringInfo.frequency || 'monthly';
                 installmentsInput.value = transaction.recurringInfo.totalInstallments || '';
                 editRecurringOptions.style.display = 'block';
                 const editScopeThis = document.querySelector('input[name="edit-recurring-scope"][value="this"]');
                 if(editScopeThis) editScopeThis.checked = true;
             } else {
                 // Garante reset se não for recorrente
                 recurringBaseIdInput.value = ''; recurringCheckbox.checked = false; recurringOptions.style.display = 'none';
                 frequencySelect.value = 'monthly'; installmentsInput.value = ''; editRecurringOptions.style.display = 'none';
             }

        } else {
            // --- MODO NOVA TRANSAÇÃO ---
            modalTitle.textContent = 'Nova Transação';
            transactionIdInput.value = ''; // Garante que está vazio
            recurringBaseIdInput.value = '';
            editRecurringOptions.style.display = 'none';
             // Garante que campos estão nos defaults
             document.getElementById('transaction-description').value = '';
             document.getElementById('transaction-amount').value = '';
             document.getElementById('transaction-date').value = formatDateForInput();
             document.getElementById('transaction-due-date').value = '';
             document.getElementById('transaction-type').value = 'expense';
             document.getElementById('transaction-status').value = 'paid';
             document.getElementById('transaction-payment-method').value = '';
             document.getElementById('transaction-notes').value = '';
             document.getElementById('transaction-recurring').checked = false;
             document.getElementById('recurring-options').style.display = 'none';
             document.getElementById('transaction-frequency').value = 'monthly';
             document.getElementById('transaction-installments').value = '';
        }

        openModal(modalElement);
        // Foco no campo de descrição ao abrir
        setTimeout(() => {
            const descriptionInput = document.getElementById('transaction-description');
            if (descriptionInput) descriptionInput.focus();
        }, 100);
    }

    // Modificada para incluir dueDate
    async function saveTransaction(event) {
        event.preventDefault();
         if (!transactionsCollection || !db) { showToast("Erro: Não é possível salvar transação (sem conexão).", "danger"); return; }
        showLoading();

        const transactionId = document.getElementById('transaction-id').value;
        const description = document.getElementById('transaction-description').value.trim(); // Descrição agora é obrigatória
        const amountInput = document.getElementById('transaction-amount'); const amount = parseFloat(amountInput.value);
        const type = document.getElementById('transaction-type').value;
        const category = document.getElementById('transaction-category').value;
        const date = document.getElementById('transaction-date').value; // Data Pagamento/Recebimento
        const dueDateInput = document.getElementById('transaction-due-date'); // Novo campo Vencimento
        const dueDate = dueDateInput.value || null; // Salva null se vazio
        const importanceRadio = document.querySelector('input[name="transaction-importance"]:checked'); const importance = importanceRadio ? importanceRadio.value : null;
        const status = document.getElementById('transaction-status').value;
        const paymentMethod = document.getElementById('transaction-payment-method').value || null;
        const notes = document.getElementById('transaction-notes').value.trim();
        const isRecurring = document.getElementById('transaction-recurring').checked; const frequency = document.getElementById('transaction-frequency').value;
        const installmentsInput = document.getElementById('transaction-installments').value; const totalInstallments = installmentsInput ? parseInt(installmentsInput) : null;

        // Validação
        if (!description) { showToast("A Descrição é obrigatória.", "warning"); document.getElementById('transaction-description').focus(); hideLoading(); return; }
        if (isNaN(amount) || amount <= 0) { showToast("Valor inválido. Insira um número positivo.", "warning"); amountInput.focus(); hideLoading(); return; }
        if (!category) { showToast("Selecione uma Categoria.", "warning"); document.getElementById('transaction-category').focus(); hideLoading(); return; }
        if (!date) { showToast("Selecione a Data de Pagamento/Recebimento.", "warning"); document.getElementById('transaction-date').focus(); hideLoading(); return; }
        // Não valida dueDate pois é opcional
        if(isRecurring && !frequency) { showToast("Selecione a frequência da recorrência.", "warning"); document.getElementById('transaction-frequency').focus(); hideLoading(); return; }
        if(isRecurring && totalInstallments !== null && totalInstallments < 2) { showToast("O número de parcelas deve ser 2 ou maior.", "warning"); document.getElementById('transaction-installments').focus(); hideLoading(); return; }
        if (isRecurring && typeof uuid === 'undefined') { showToast("Erro: Biblioteca UUID não carregada.", "danger"); hideLoading(); return; }

        const baseTransactionData = {
            description, amount, type, category, date, dueDate, // Inclui dueDate
            importance, status, paymentMethod, notes: notes || null,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const isEditing = !!transactionId; const recurringBaseId = document.getElementById('transaction-recurring-base-id').value; const isEditingRecurring = isEditing && !!recurringBaseId;

        try {
            // Lógica de salvar (Nova, Edição, Recorrente) permanece a mesma, mas agora inclui 'dueDate' em baseTransactionData
             if (isEditingRecurring) {
                const editScopeRadio = document.querySelector('input[name="edit-recurring-scope"]:checked'); const editScope = editScopeRadio ? editScopeRadio.value : 'this';
                if (editScope === 'this') {
                    const transactionRef = transactionsCollection.doc(transactionId);
                    const updateData = { ...baseTransactionData, recurringInfo: firebase.firestore.FieldValue.delete(), };
                    await transactionRef.update(updateData); showToast("Ocorrência atualizada com sucesso.", "success");
                } else {
                    const originalTransaction = transactions.find(t => t.id === transactionId); if (!originalTransaction || !originalTransaction.recurringInfo) { throw new Error("Transação recorrente original não encontrada."); }
                    const batch = db.batch(); const currentInstallmentNumber = originalTransaction.recurringInfo.currentInstallment;
                    const currentRef = transactionsCollection.doc(transactionId); let currentUpdateData = { ...baseTransactionData };
                     if (isRecurring) { currentUpdateData.recurringInfo = { baseId: recurringBaseId, frequency: frequency, currentInstallment: currentInstallmentNumber, totalInstallments: totalInstallments }; } else { currentUpdateData.recurringInfo = firebase.firestore.FieldValue.delete(); }
                    batch.update(currentRef, currentUpdateData);
                    const futureQuery = transactionsCollection.where('recurringInfo.baseId', '==', recurringBaseId).where('recurringInfo.currentInstallment', '>', currentInstallmentNumber).orderBy('recurringInfo.currentInstallment', 'asc');
                    const futureSnapshot = await futureQuery.get();
                    futureSnapshot.docs.forEach(doc => {
                        const futureDocRef = doc.ref; const futureInstallmentNum = doc.data().recurringInfo?.currentInstallment;
                        const futureUpdateData = { amount: baseTransactionData.amount, category: baseTransactionData.category, type: baseTransactionData.type, importance: baseTransactionData.importance, description: baseTransactionData.description ? `${baseTransactionData.description} ${totalInstallments ? `(${futureInstallmentNum}/${totalInstallments})` : ''}`.trim() : null, paymentMethod: baseTransactionData.paymentMethod, notes: baseTransactionData.notes, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), dueDate: baseTransactionData.dueDate /* Propaga dueDate */ };
                         if (isRecurring) { futureUpdateData.recurringInfo = { baseId: recurringBaseId, frequency: frequency, currentInstallment: futureInstallmentNum, totalInstallments: totalInstallments }; } else { futureUpdateData.recurringInfo = firebase.firestore.FieldValue.delete(); }
                        batch.update(futureDocRef, futureUpdateData);
                    });
                    await batch.commit(); showToast("Esta e as futuras ocorrências foram atualizadas.", "success");
                }
            } else if (isEditing && !isRecurring) {
                const updateData = { ...baseTransactionData, recurringInfo: firebase.firestore.FieldValue.delete(), }; delete updateData.createdAt;
                 await transactionsCollection.doc(transactionId).update(updateData); showToast("Transação atualizada com sucesso!", "success");
            } else if (isEditing && isRecurring) {
                 const baseId = uuid.v4(); const firstInstallmentData = { ...baseTransactionData, recurringInfo: { baseId: baseId, frequency: frequency, currentInstallment: 1, totalInstallments: totalInstallments }, }; delete firstInstallmentData.createdAt;
                 const batch = db.batch(); batch.update(transactionsCollection.doc(transactionId), firstInstallmentData);
                 await generateFutureInstallments(batch, baseTransactionData, baseId, frequency, totalInstallments, date, 1); await batch.commit(); showToast("Transação atualizada e recorrência criada!", "success");
            } else if (!isEditing && isRecurring) {
                 const baseId = uuid.v4(); const firstInstallmentData = { ...baseTransactionData, createdAt: firebase.firestore.FieldValue.serverTimestamp(), recurringInfo: { baseId: baseId, frequency: frequency, currentInstallment: 1, totalInstallments: totalInstallments } };
                const batch = db.batch(); const firstDocRef = transactionsCollection.doc(); batch.set(firstDocRef, firstInstallmentData);
                 const dataForFuture = {...baseTransactionData}; delete dataForFuture.updatedAt; delete dataForFuture.createdAt;
                await generateFutureInstallments(batch, dataForFuture, baseId, frequency, totalInstallments, date, 1); await batch.commit(); showToast(`Transação ${totalInstallments ? 'parcelada' : 'recorrente'} criada com sucesso!`, "success");
            } else {
                await transactionsCollection.add({ ...baseTransactionData, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); showToast("Transação adicionada com sucesso!", "success");
            }
            closeModal(document.getElementById('transaction-modal'));
        } catch (error) { console.error("Erro ao salvar transação: ", error); showToast(`Erro ao salvar transação: ${error.message || 'Erro desconhecido'}`, "danger", 5000); }
        finally { hideLoading(); }
    }

    // Modificada para incluir dueDate
    async function generateFutureInstallments(batch, baseData, baseId, frequency, totalInstallments, startDate, startInstallmentNum) {
         if (!transactionsCollection || !db) return;
        const freqInfo = RECURRENCE_FREQUENCY[frequency]; if (!freqInfo) { console.error(`Frequência inválida: ${frequency}`); return; }
        const limit = totalInstallments ? totalInstallments : (startInstallmentNum + 24); const absoluteMax = startInstallmentNum + 60; const finalLimit = Math.min(limit, absoluteMax);
        console.log(`Gerando futuras parcelas a partir de ${startInstallmentNum + 1} até ${finalLimit}`);
        let currentTransDate = moment(startDate);
        let currentDueDate = baseData.dueDate ? moment(baseData.dueDate) : null; // Usa dueDate base

        for (let i = startInstallmentNum + 1; i <= finalLimit; i++) {
            currentTransDate = currentTransDate.add(freqInfo.momentStep, freqInfo.momentUnit);
            if(currentDueDate) { // Incrementa dueDate se existir
                 currentDueDate = currentDueDate.add(freqInfo.momentStep, freqInfo.momentUnit);
            }
            const futureDescription = baseData.description ? `${baseData.description} ${totalInstallments ? `(${i}/${totalInstallments})` : ''}`.trim() : `Parcela ${i}${totalInstallments ? ` de ${totalInstallments}` : ''}`;
            const futureInstallmentData = {
                ...baseData, // Copia valor, categoria, tipo, importance, paymentMethod, notes
                date: currentTransDate.format('YYYY-MM-DD'), // Data da transação futura
                dueDate: currentDueDate ? currentDueDate.format('YYYY-MM-DD') : null, // Data de vencimento futura
                status: 'scheduled', // Futuras são agendadas
                description: futureDescription,
                recurringInfo: { baseId: baseId, frequency: frequency, currentInstallment: i, totalInstallments: totalInstallments },
                 createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            delete futureInstallmentData.id;
            const futureDocRef = transactionsCollection.doc();
            batch.set(futureDocRef, futureInstallmentData);
        }
        console.log(`Geração de futuras parcelas concluída no batch.`);
    }

    // Excluir Transação (sem alterações lógicas necessárias aqui)
    async function deleteTransaction(transactionId, recurringBaseId = null, deleteScope = 'this') { if (!transactionsCollection || !db) { showToast("Erro: Não é possível excluir transação (sem conexão).", "danger"); return; } showLoading(); try { if (recurringBaseId && deleteScope !== 'this') { console.log(`Excluindo ocorrência ${transactionId} e futuras com baseId ${recurringBaseId}`); const batch = db.batch(); const originalTransaction = transactions.find(t => t.id === transactionId); const currentInstallmentNum = originalTransaction?.recurringInfo?.currentInstallment; if (!originalTransaction || typeof currentInstallmentNum !== 'number') { console.warn("Não foi possível obter info da parcela recorrente original. Excluindo apenas a selecionada."); await transactionsCollection.doc(transactionId).delete(); showToast("Transação selecionada excluída. Não foi possível excluir futuras.", "warning"); hideLoading(); closeModalIfNeeded(document.getElementById('confirm-modal')); return; } batch.delete(transactionsCollection.doc(transactionId)); console.log(`Agendada exclusão de ${transactionId}`); console.log(`Buscando futuras transações com baseId ${recurringBaseId} e parcela >= ${currentInstallmentNum}`); const futureQuery = transactionsCollection.where('recurringInfo.baseId', '==', recurringBaseId).where('recurringInfo.currentInstallment', '>=', currentInstallmentNum); const futureSnapshot = await futureQuery.get(); console.log(`${futureSnapshot.docs.length} transações (incluindo a atual) encontradas para exclusão.`); futureSnapshot.docs.forEach(doc => { if (doc.id !== transactionId) { console.log(`Agendada exclusão de futura transação ${doc.id}`); batch.delete(doc.ref); } }); await batch.commit(); showToast("Esta e as futuras ocorrências foram excluídas.", "success"); } else { console.log(`Excluindo transação única ${transactionId}`); await transactionsCollection.doc(transactionId).delete(); showToast("Transação excluída com sucesso!", "success"); } } catch (error) { console.error("Erro ao excluir transação: ", error); showToast(`Erro ao excluir transação: ${error.message || 'Erro desconhecido'}`, "danger", 5000); } finally { hideLoading(); closeModalIfNeeded(document.getElementById('confirm-modal')); } }

    // ===== Interface e Interação =====
    function openModal(modalElement) { if (modalElement) modalElement.classList.add('active'); }
    function closeModal(modalElement) { if (modalElement) modalElement.classList.remove('active'); }
    function closeModalIfNeeded(modalElement) { if (modalElement && modalElement.classList.contains('active')) closeModal(modalElement); }
    function initTabs() { const tabLinks = document.querySelectorAll('.tab'); const tabContents = document.querySelectorAll('.tab-content'); tabLinks.forEach(tab => { tab.addEventListener('click', () => { const targetTabId = tab.dataset.tab; if (!targetTabId) return; tabLinks.forEach(t => t.classList.remove('active')); tabContents.forEach(c => c.classList.remove('active')); tab.classList.add('active'); const targetContent = document.getElementById(`tab-${targetTabId}`); if (targetContent) targetContent.classList.add('active'); currentTab = targetTabId; console.log(`Tab alterada para: ${currentTab}`); if (targetTabId === 'analysis') { if(categories.length === 0 && db) { console.warn("Tentando atualizar análise sem categorias carregadas."); loadCategories().then(updateMonthlyAnalysis).catch(console.error); } else { updateMonthlyAnalysis(); } } else if (targetTabId === 'overview') { updateOverviewCharts(); updateKPIs(); } }); }); }
    function populateCategoryFilters() { const analysisCategorySelect = document.getElementById('analysis-category'); const transactionCategorySelect = document.getElementById('transaction-category'); if (!analysisCategorySelect || !transactionCategorySelect) { console.warn("Selects de categoria não encontrados no DOM."); return; } const selectedAnalysisCategory = analysisCategorySelect ? analysisCategorySelect.value : 'all'; analysisCategorySelect.innerHTML = '<option value="all">Todas as Categorias</option>'; transactionCategorySelect.innerHTML = ''; categories.forEach(cat => { const option = document.createElement('option'); option.value = cat.id; option.textContent = `${cat.icon || ''} ${cat.name || 'Categoria sem nome'}`; analysisCategorySelect.appendChild(option); }); const currentTransactionType = document.getElementById('transaction-type')?.value || 'expense'; populateCategorySelect(currentTransactionType); if (analysisCategorySelect.querySelector(`option[value="${selectedAnalysisCategory}"]`)) { analysisCategorySelect.value = selectedAnalysisCategory; } else { analysisCategorySelect.value = 'all'; } toggleDeleteCategoryButton(); }
    function populateCategorySelect(type = 'expense') { const select = document.getElementById('transaction-category'); if (!select) return; select.innerHTML = ''; const filteredCategories = categories.filter(cat => cat.type === type); if (filteredCategories.length === 0) { const option = document.createElement('option'); option.value = ""; option.textContent = `Nenhuma categoria de ${type === 'income' ? 'receita' : 'despesa'} encontrada`; option.disabled = true; select.appendChild(option); } else { filteredCategories.forEach(cat => { const option = document.createElement('option'); option.value = cat.id; option.textContent = `${cat.icon || ''} ${cat.name || 'Categoria sem nome'}`; select.appendChild(option); }); } }
    function toggleDeleteCategoryButton() { const select = document.getElementById('analysis-category'); const deleteButton = document.getElementById('btn-delete-category'); if (!select || !deleteButton) return; if (select.value !== 'all') { const category = categories.find(c => c.id === select.value); if (category && !category.isDefault) { deleteButton.style.display = 'inline-flex'; } else { deleteButton.style.display = 'none'; } } else { deleteButton.style.display = 'none'; } }
    function populateYearMonthFilters() { const yearSelect = document.getElementById('analysis-year'); const monthSelect = document.getElementById('analysis-month'); if (!yearSelect || !monthSelect) return; yearSelect.innerHTML = ''; monthSelect.innerHTML = ''; const currentYear = moment().year(); for (let year = currentYear - 5; year <= currentYear + 5; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } moment.months().forEach((month, index) => { const option = document.createElement('option'); option.value = index; option.textContent = month.charAt(0).toUpperCase() + month.slice(1); monthSelect.appendChild(option); }); yearSelect.value = moment().year(); monthSelect.value = moment().month(); updateCurrentAnalysisDate(false); }
    function updateCurrentAnalysisDate(triggerUpdate = true) {
        const year = document.getElementById('analysis-year')?.value; const month = document.getElementById('analysis-month')?.value; const type = document.getElementById('analysis-type')?.value; const importance = document.getElementById('analysis-importance')?.value; const category = document.getElementById('analysis-category')?.value; const status = document.getElementById('analysis-status')?.value; // Adiciona Status
        if(year && month) { currentAnalysisMonthYear = `${year}-${String(Number(month) + 1).padStart(2, '0')}`; }
        if (type) currentAnalysisType = type; if (importance) currentAnalysisImportance = importance; if (category) currentAnalysisCategory = category; if (status) currentAnalysisStatus = status; // Atualiza estado do status
        console.log("Filtros:", currentAnalysisMonthYear, currentAnalysisCategory, currentAnalysisType, currentAnalysisImportance, currentAnalysisStatus);
        if (triggerUpdate) { updateMonthlyAnalysis(); }
    }
    function setupEventListeners() {
        const btnNew = document.getElementById('btn-new-transaction'); if (btnNew) btnNew.addEventListener('click', () => openTransactionModal());
        const btnTheme = document.getElementById('theme-toggle'); if (btnTheme) btnTheme.addEventListener('click', toggleTheme);
        const transactionModal = document.getElementById('transaction-modal');
        if (transactionModal) {
            const btnClose = transactionModal.querySelector('#transaction-modal-close'); const btnCancel = transactionModal.querySelector('#transaction-modal-cancel'); const form = transactionModal.querySelector('#transaction-form'); const typeSelect = transactionModal.querySelector('#transaction-type'); const recurringCheckbox = transactionModal.querySelector('#transaction-recurring'); const btnAddCategoryModal = transactionModal.querySelector('#btn-add-category-modal');
            if (btnClose) btnClose.addEventListener('click', () => closeModal(transactionModal)); if (btnCancel) btnCancel.addEventListener('click', () => closeModal(transactionModal)); if (form) form.addEventListener('submit', saveTransaction); if (typeSelect) typeSelect.addEventListener('change', (e) => populateCategorySelect(e.target.value));
            if (recurringCheckbox) { recurringCheckbox.addEventListener('change', (e) => { const recurringOptionsDiv = document.getElementById('recurring-options'); if(recurringOptionsDiv) recurringOptionsDiv.style.display = e.target.checked ? 'block' : 'none'; }); }
            if (btnAddCategoryModal) btnAddCategoryModal.addEventListener('click', () => openCategoryModal());
        }
        const yearSelect = document.getElementById('analysis-year'); const monthSelect = document.getElementById('analysis-month'); const categorySelect = document.getElementById('analysis-category'); const typeSelect = document.getElementById('analysis-type'); const importanceSelect = document.getElementById('analysis-importance'); const statusSelect = document.getElementById('analysis-status'); // Listener para Status
        if (yearSelect) yearSelect.addEventListener('change', () => updateCurrentAnalysisDate(true)); if (monthSelect) monthSelect.addEventListener('change', () => updateCurrentAnalysisDate(true)); if (categorySelect) categorySelect.addEventListener('change', () => { toggleDeleteCategoryButton(); updateCurrentAnalysisDate(true); }); if (typeSelect) typeSelect.addEventListener('change', () => updateCurrentAnalysisDate(true)); if (importanceSelect) importanceSelect.addEventListener('change', () => updateCurrentAnalysisDate(true)); if (statusSelect) statusSelect.addEventListener('change', () => updateCurrentAnalysisDate(true)); // Adiciona listener para status
        const btnAddCategoryGlobal = document.getElementById('btn-add-category'); const btnDeleteCategoryGlobal = document.getElementById('btn-delete-category'); const categoryModal = document.getElementById('category-modal');
        if (btnAddCategoryGlobal) btnAddCategoryGlobal.addEventListener('click', () => openCategoryModal()); if (btnDeleteCategoryGlobal) { btnDeleteCategoryGlobal.addEventListener('click', () => { const selectedCategoryId = document.getElementById('analysis-category')?.value; if (selectedCategoryId && selectedCategoryId !== 'all') { confirmDeleteCategory(selectedCategoryId); } }); }
        if (categoryModal) { const categoryForm = categoryModal.querySelector('#category-form'); if (categoryForm) categoryForm.addEventListener('submit', handleSaveCategory); categoryModal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => { btn.addEventListener('click', () => closeModal(categoryModal)); }); }
        const confirmModal = document.getElementById('confirm-modal');
        if (confirmModal) { const confirmButton = confirmModal.querySelector('#confirm-modal-confirm'); if (confirmButton) { confirmButton.addEventListener('click', () => { const action = confirmButton._action; if (action && typeof action === 'function') { action(); } else { console.warn("Nenhuma ação definida para confirmação."); closeModal(confirmModal); } }); } confirmModal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => { btn.addEventListener('click', () => closeModal(confirmModal)); }); }
        document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', (event) => { if (event.target === modal) { closeModal(modal); } }); }); console.log("Listeners de eventos configurados.");
    }
    // toggleAdvancedFields removida
    function openCategoryModal() { const modalElement = document.getElementById('category-modal'); const form = document.getElementById('category-form'); if (!modalElement || !form) return; form.reset(); document.getElementById('category-modal-title').textContent = "Nova Categoria"; const colorInput = document.getElementById('category-color'); if (colorInput) colorInput.value = '#8A8A8E'; openModal(modalElement); setTimeout(() => { const nameInput = document.getElementById('category-name'); if(nameInput) nameInput.focus(); }, 100); }
    async function handleSaveCategory(event) { event.preventDefault(); const nameInput = document.getElementById('category-name'); const typeSelect = document.getElementById('category-type'); const iconInput = document.getElementById('category-icon'); const colorInput = document.getElementById('category-color'); const name = nameInput ? nameInput.value : ''; const type = typeSelect ? typeSelect.value : ''; const icon = iconInput ? iconInput.value : ''; const color = colorInput ? colorInput.value : '#8A8A8E'; if (!name || !type) { showToast("Nome e Tipo da Categoria são obrigatórios.", "warning"); return; } const success = await addCategory(name, type, icon, color); if (success) { closeModal(document.getElementById('category-modal')); } }
    function confirmDeleteCategory(categoryId) { const category = categories.find(c => c.id === categoryId); if (!category) { showToast("Categoria não encontrada.", "danger"); return; } if (category.isDefault) { showToast("Categorias padrão não podem ser excluídas.", "warning"); return; } const confirmModalElement = document.getElementById('confirm-modal'); if (!confirmModalElement) return; const title = confirmModalElement.querySelector('#confirm-modal-title'); const message = confirmModalElement.querySelector('#confirm-modal-message'); const extraInfo = confirmModalElement.querySelector('#confirm-modal-extra-info'); const confirmButton = confirmModalElement.querySelector('#confirm-modal-confirm'); if(title) title.textContent = "Excluir Categoria"; if(message) message.textContent = `Tem certeza que deseja excluir a categoria "${category.name || categoryId}"?`; if(extraInfo) extraInfo.textContent = "Atenção: Esta ação não pode ser desfeita. Transações associadas (se houver) ficarão sem categoria."; if(confirmButton) { confirmButton.textContent = "Excluir"; confirmButton.className = 'btn btn-danger'; confirmButton._action = () => deleteCategory(categoryId); } openModal(confirmModalElement); }
    function confirmDeleteTransaction(transactionId) { const transaction = transactions.find(t => t.id === transactionId); if (!transaction) { showToast("Transação não encontrada.", "danger"); return; } const confirmModalElement = document.getElementById('confirm-modal'); if (!confirmModalElement) return; const title = confirmModalElement.querySelector('#confirm-modal-title'); const message = confirmModalElement.querySelector('#confirm-modal-message'); const extraInfo = confirmModalElement.querySelector('#confirm-modal-extra-info'); const confirmButton = confirmModalElement.querySelector('#confirm-modal-confirm'); if (title) title.textContent = "Excluir Transação"; const description = transaction.description || `Transação de ${formatCurrency(transaction.amount)}`; let baseMessage = `Tem certeza que deseja excluir a transação "${description}" de ${formatFullDate(transaction.date)}?`; let extraInfoHTML = "Esta ação não pode ser desfeita."; let deleteScope = 'this'; let confirmButtonAction = () => deleteTransaction(transactionId, null, 'this'); const recurringBaseId = transaction.recurringInfo?.baseId; if(recurringBaseId) { baseMessage = `Esta é uma transação recorrente (${transaction.recurringInfo?.currentInstallment || '?'}/${transaction.recurringInfo?.totalInstallments || '∞'}). O que você deseja excluir?`; extraInfoHTML = `<div style="display: flex; flex-direction: column; gap: 0.75rem;"><label><input type="radio" name="delete-scope" value="this" checked> Somente esta ocorrência (${formatFullDate(transaction.date)})</label><label><input type="radio" name="delete-scope" value="future"> Esta e todas as futuras ocorrências</label></div>`; confirmModalElement.querySelectorAll('input[name="delete-scope"]').forEach(radio => { radio.onchange = (e) => { deleteScope = e.target.value; confirmButtonAction = () => deleteTransaction(transactionId, recurringBaseId, deleteScope); if (confirmButton) confirmButton._action = confirmButtonAction; }; }); confirmButtonAction = () => deleteTransaction(transactionId, recurringBaseId, 'this'); } if(message) message.textContent = baseMessage; if(extraInfo) extraInfo.innerHTML = extraInfoHTML; if(confirmButton) { confirmButton.textContent = "Excluir"; confirmButton.className = 'btn btn-danger'; confirmButton._action = confirmButtonAction; } const radioThis = confirmModalElement.querySelector('input[name="delete-scope"][value="this"]'); if (radioThis) radioThis.checked = true; openModal(confirmModalElement); }

    // ===== Atualização da UI =====
    function updateDashboard() { if (!transactionsCollection || !categoriesCollection) { console.warn("Atualização do Dashboard interrompida - coleções não disponíveis."); return; } console.log("Atualizando dashboard..."); updateKPIs(); if (currentTab === 'overview') { updateOverviewCharts(); } else if (currentTab === 'analysis') { updateMonthlyAnalysis(); } }
    function updateKPIs() { /* ... Código de KPIs sem alterações ... */ }
    function updateOverviewCharts() { /* ... Código de Gráficos Overview sem alterações ... */ }

    // ===== Lógica da Análise Mensal (Revisada) =====
    function updateMonthlyAnalysis() {
        const yearSelect = document.getElementById('analysis-year'); const monthSelect = document.getElementById('analysis-month'); const categorySelect = document.getElementById('analysis-category'); const typeSelect = document.getElementById('analysis-type'); const importanceSelect = document.getElementById('analysis-importance'); const statusSelect = document.getElementById('analysis-status');
        if (!yearSelect || !monthSelect || !categorySelect || !typeSelect || !importanceSelect || !statusSelect) { console.error("Filtros de Análise Mensal não encontrados. Abortando."); return; }
        showLoading();
        console.log(`Atualizando análise para ${currentAnalysisMonthYear}, Cat: ${currentAnalysisCategory}, Tipo: ${currentAnalysisType}, Imp: ${currentAnalysisImportance}, Status: ${currentAnalysisStatus}`);
        const startOfMonth = moment(currentAnalysisMonthYear).startOf('month'); const endOfMonth = moment(currentAnalysisMonthYear).endOf('month');
        const monthlyTransactions = transactions.filter(t => {
            if (!t.date || typeof t.amount !== 'number' || !t.type) { return false; }
            const transactionMoment = moment(t.date);
            const isSameMonth = transactionMoment.isBetween(startOfMonth, endOfMonth, 'day', '[]');
            const isSameCategory = (currentAnalysisCategory === 'all' || t.category === currentAnalysisCategory);
            const isSameType = (currentAnalysisType === 'all' || t.type === currentAnalysisType);
            const isSameImportance = (currentAnalysisImportance === 'all') || (currentAnalysisImportance === 'none' && !t.importance) || (t.importance === currentAnalysisImportance);
            const isSameStatus = (currentAnalysisStatus === 'all' || t.status === currentAnalysisStatus); // Filtro de Status
            return isSameMonth && isSameCategory && isSameType && isSameImportance && isSameStatus;
        });
        console.log(`${monthlyTransactions.length} transações encontradas para a análise.`);
        try {
            calculateMonthlyIndicators(monthlyTransactions, currentAnalysisMonthYear);
            renderMonthlyTransactionList(monthlyTransactions); // Renderiza ANTES dos insights
            generateAndRenderInsights(monthlyTransactions, currentAnalysisMonthYear);
            updateAnalysisCharts(monthlyTransactions);
        } catch (error) { console.error("Erro durante a atualização da análise mensal:", error); showToast("Ocorreu um erro ao atualizar a análise.", "danger"); }
        finally { hideLoading(); }
    }
    function calculateMonthlyIndicators(monthlyTransactions, selectedMonthYear) { /* ... Código dos Indicadores sem alterações ... */ }

    // Modificada para ordenar por Vencimento e mostrar data
    function renderMonthlyTransactionList(monthlyTransactions) {
        const listContainer = document.getElementById('analysis-transaction-list');
        const noTransactionsMessage = document.getElementById('analysis-no-transactions');
        if (!listContainer || !noTransactionsMessage) return; listContainer.innerHTML = '';

        if (monthlyTransactions.length === 0) { noTransactionsMessage.style.display = 'block'; return; }
        noTransactionsMessage.style.display = 'none';

        // Ordenar por Data de Vencimento (dueDate), depois por Data da Transação
        monthlyTransactions.sort((a, b) => {
            const dueDateA = a.dueDate ? moment(a.dueDate) : moment('9999-12-31'); // Joga sem vencimento para o fim
            const dueDateB = b.dueDate ? moment(b.dueDate) : moment('9999-12-31');
            const dateA = moment(a.date);
            const dateB = moment(b.date);

            const dueDateDiff = dueDateA.diff(dueDateB);
            if (dueDateDiff !== 0) return dueDateDiff; // Ordena por vencimento primeiro
            return dateA.diff(dateB); // Se vencimento igual, ordena por data da transação
        });

        const today = moment(); // Para checar vencidos/próximos

        monthlyTransactions.forEach(t => {
            const category = categories.find(c => c.id === t.category) || { name: 'Desconhecida', icon: '❓', color: '#8E8E93' };
            const item = document.createElement('div');
            item.className = 'transaction-item'; item.setAttribute('role', 'button'); item.setAttribute('tabindex', '0');
            const amountPrefix = t.type === 'income' ? '+' : '-';
            const importanceClass = t.importance ? `transaction-importance ${t.importance}` : '';
            const importanceTitle = t.importance ? `Importância: ${t.importance.charAt(0).toUpperCase() + t.importance.slice(1)}` : '';
            const isPendingOrScheduled = t.status === 'pending' || t.status === 'scheduled';
            let dueDateClass = '';
            let dueDateText = t.dueDate ? formatDate(t.dueDate) : '--';
            if(t.dueDate && isPendingOrScheduled) {
                const dueDateMoment = moment(t.dueDate);
                if (dueDateMoment.isBefore(today, 'day')) {
                    dueDateClass = 'overdue'; // Vencido
                    dueDateText += ' (Vencido!)';
                } else if (dueDateMoment.isBefore(today.add(7, 'days'), 'day')) {
                     dueDateClass = 'upcoming'; // Próximo (7 dias)
                }
            }

            item.innerHTML = `
                <div class="transaction-item-left">
                    <div class="transaction-icon" style="background-color: ${category.color || '#8E8E93'};">
                        ${category.icon || '?'}
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-description">${t.description || category.name || 'Transação sem descrição'}</div>
                        <div class="transaction-category">${category.name || 'Desconhecida'}</div>
                    </div>
                </div>
                <div class="transaction-item-right">
                     <div class="transaction-dates-amount-wrapper">
                        <div class="transaction-amount ${t.type === 'income' ? 'income' : 'expense'}">
                            ${amountPrefix} ${formatCurrency(t.amount)}
                            ${importanceClass ? `<span class="${importanceClass}" title="${importanceTitle}"></span>` : ''}
                        </div>
                        <div class="transaction-dates">
                            <span class="transaction-date" title="Data da Transação">${formatDate(t.date)}</span>
                            ${t.dueDate ? `<span class="transaction-due-date ${dueDateClass}" title="Data de Vencimento">Venc: ${dueDateText}</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-action btn-delete-transaction" data-id="${t.id}" title="Excluir Transação">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                    </button>
                </div>
            `;
            const deleteButton = item.querySelector('.btn-delete-transaction'); if (deleteButton) { deleteButton.addEventListener('click', (e) => { e.stopPropagation(); confirmDeleteTransaction(t.id); }); }
            item.addEventListener('click', (e) => { if (!e.target.closest('.btn-delete-transaction')) { openTransactionModal(t); } });
            item.addEventListener('keydown', (e) => { if (!e.target.closest('.btn-delete-transaction') && (e.key === 'Enter' || e.key === ' ')) { openTransactionModal(t); } });
            listContainer.appendChild(item);
        });
    }

    // Modificada para incluir insights sobre vencimentos
    function generateAndRenderInsights(monthlyTransactions, selectedMonthYear) {
        const insightsList = document.getElementById('analysis-insights-list'); const noInsightsMessage = document.getElementById('analysis-no-insights'); if (!insightsList || !noInsightsMessage) return; insightsList.innerHTML = ''; const insights = [];
        const income = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expenses = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const balance = income - expenses;

        // Insights Gerais (Saldo, Comparação Despesas) - Mantidos
        const lastMonthStr = moment(selectedMonthYear).subtract(1, 'month').format('YYYY-MM'); const lastMonthStart = moment(lastMonthStr).startOf('month'); const lastMonthEnd = moment(lastMonthStr).endOf('month');
        const lastMonthGlobalTransactions = transactions.filter(t => { if (!t.date || typeof t.amount !== 'number' || !t.type) return false; return moment(t.date).isBetween(lastMonthStart, lastMonthEnd, 'day', '[]'); });
        const lastMonthGlobalExpenses = lastMonthGlobalTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        if (lastMonthGlobalExpenses > 0) { const expenseChange = ((expenses - lastMonthGlobalExpenses) / lastMonthGlobalExpenses) * 100; if (expenseChange > 15) { insights.push({ type: 'warning', text: `🚨 Atenção: Suas despesas totais (${formatCurrency(expenses)}) aumentaram ${expenseChange.toFixed(0)}% em relação ao mês anterior.` }); } else if (expenseChange < -10) { insights.push({ type: 'success', text: `✅ Ótimo! Suas despesas totais (${formatCurrency(expenses)}) diminuíram ${Math.abs(expenseChange).toFixed(0)}% este mês.` }); } }
        else if (expenses > 0) { insights.push({ type: 'info', text: `ℹ️ Este foi o primeiro mês com registro de despesas (${formatCurrency(expenses)}).` }); }
        if (balance > 50) { insights.push({ type: 'success', text: `👍 Parabéns! Você fechou o mês com saldo positivo de ${formatCurrency(balance)}.` }); }
        else if (balance < -50) { insights.push({ type: 'alert', text: `📉 Cuidado! Você fechou o mês com saldo negativo de ${formatCurrency(Math.abs(balance))}.` }); }
        else if (income > 0 || expenses > 0) { insights.push({ type: 'neutral', text: `⚖️ Seu saldo final do mês (${formatCurrency(balance)}) ficou próximo de zero.` }); }

        // Insights de Vencimento (sobre todas as transações, não só as do mês filtrado)
        const today = moment();
        const nextWeek = moment().add(7, 'days');
        const upcomingExpenses = transactions.filter(t =>
            t.type === 'expense' &&
            (t.status === 'pending' || t.status === 'scheduled') &&
            t.dueDate &&
            moment(t.dueDate).isBetween(today, nextWeek, 'day', '[]') // Vence hoje ou nos próximos 7 dias
        );
         const overdueExpenses = transactions.filter(t =>
            t.type === 'expense' &&
            (t.status === 'pending' || t.status === 'scheduled') &&
            t.dueDate &&
            moment(t.dueDate).isBefore(today, 'day') // Vencido
        );

        if (overdueExpenses.length > 0) {
            const totalOverdue = overdueExpenses.reduce((sum, t) => sum + t.amount, 0);
            insights.push({ type: 'alert', text: `🚨 Vencido! Você tem ${overdueExpenses.length} conta(s) pendente(s) com vencimento passado, totalizando ${formatCurrency(totalOverdue)}.` });
        }
         if (upcomingExpenses.length > 0) {
            const totalUpcoming = upcomingExpenses.reduce((sum, t) => sum + t.amount, 0);
             insights.push({ type: 'warning', text: `⚠️ Próximos Vencimentos! ${upcomingExpenses.length} conta(s) vence(m) nos próximos 7 dias, totalizando ${formatCurrency(totalUpcoming)}.` });
        } else if (overdueExpenses.length === 0) { // Só mostra se não tiver vencido
             insights.push({ type: 'success', text: `✅ Tudo em dia! Nenhuma conta a vencer nos próximos 7 dias.` });
        }


        // Renderiza insights
        if (insights.length > 0) { noInsightsMessage.style.display = 'none'; insights.forEach(insight => { const item = document.createElement('div'); item.className = `insight-item ${insight.type}`; let icon = '💬'; if(insight.type === 'alert') icon = '🚨'; else if(insight.type === 'warning') icon = '⚠️'; else if(insight.type === 'success') icon = '✅'; else if(insight.type === 'info') icon = 'ℹ️'; else if(insight.type === 'neutral') icon = '🔍'; item.innerHTML = `<span class="insight-icon">${icon}</span><span class="insight-text">${insight.text}</span>`; insightsList.appendChild(item); }); }
        else { noInsightsMessage.textContent = "Nenhum insight relevante encontrado."; noInsightsMessage.style.display = 'block'; }
    }

    // ===== Gráficos (sem alterações lógicas) =====
    function getChartCommonOptions(isDarkMode) { /* ... Código sem alterações ... */ }
    function initCharts() { /* ... Código sem alterações ... */ }
    function updateAllChartsTheme() { /* ... Código sem alterações ... */ }
    function updateOverviewCharts() { /* ... Código sem alterações ... */ }
    function updateAnalysisCharts(monthlyTransactions) { /* ... Código sem alterações ... */ }

    // ===== Inicialização da Aplicação =====
    async function init() {
        showLoading(); console.log("Iniciando aplicação...");
        try {
            setupTheme();
             if(db) { await loadCategories(); } else { console.error("Banco de dados não inicializado. Carregando categorias padrão localmente."); categories = [...DEFAULT_INCOME_CATEGORIES, ...DEFAULT_EXPENSE_CATEGORIES].sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); }
            initTabs();
            populateYearMonthFilters(); // Popula novos filtros
            initCharts();
            setupEventListeners(); // Configura listeners para os novos filtros também
            if(db) { setupFirestoreListeners(); } else { console.error("Listeners do Firestore não iniciados - DB indisponível."); updateDashboard(); }
            console.log("Estrutura da aplicação inicializada. Aguardando dados do Firestore...");
        } catch (error) { console.error("Erro fatal durante a inicialização:", error); showToast("Erro grave ao iniciar. Verifique o console (F12).", "danger", 10000); try { initTabs(); setupEventListeners(); } catch (uiError) { console.error("Erro ao configurar UI de fallback:", uiError); } }
        finally { setTimeout(hideLoading, 500); }
    }

    // --- Ponto de Entrada ---
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); } else { init(); }
    window.addEventListener('beforeunload', stopFirestoreListeners);

  </script>
</body>
</html>
