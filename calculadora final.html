<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Controle Financeiro Familiar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
  <!-- Firebase App -->
  <script type="module">
    // Importar módulos do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      query, 
      where, 
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configuração específica do seu projeto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY",
      authDomain: "calculadora-da-familia.firebaseapp.com",
      projectId: "calculadora-da-familia",
      storageBucket: "calculadora-da-familia.appspot.com",
      messagingSenderId: "69721783786",
      appId: "1:69721783786:web:c4703b5c182e3681e8c693",
      measurementId: "G-YM5TR661S6"
    };

    // Inicializar Firebase e acessar Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Tornar o db acessível globalmente
    window.db = db;
    window.firestore = {
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      query, 
      where, 
      orderBy
    };
  </script>
  <style>
    /* ===== Variáveis e Temas Apple ===== */
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem;
      --radius: 1.125rem;
      --radius-lg: 1.5rem;
      --shadow: 0 2px 14px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.04);
      --shadow-hover: 0 4px 18px rgba(0,0,0,0.08), 0 10px 28px rgba(0,0,0,0.06);
      --shadow-dropdown: 0 4px 20px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* Cores iOS/macOS Light */
      --bg: #F5F5F7;
      --card-bg: #FFFFFF;
      --input-bg: rgba(142, 142, 147, 0.12);
      --text: #1D1D1F;
      --text-secondary: #86868B;
      --primary: #0066CC;
      --primary-light: #147CE5;
      --success: #34C759;
      --warning: #FF9F0A;
      --danger: #FF3B30;
      --info: #5AC8FA;
      --purple: #AF52DE;
      --teal: #64D2FF;
      --border: rgba(0,0,0,0.08);
      --chart-grid: rgba(0,0,0,0.04);
      --menu-bg: rgba(255, 255, 255, 0.9);
      --receipt-bg: #FBFBFD;
    }
    
    [data-theme="dark"] {
      /* Cores iOS/macOS Dark */
      --bg: #1D1D1F;
      --card-bg: #2C2C2E;
      --input-bg: rgba(142, 142, 147, 0.18);
      --text: #F5F5F7;
      --text-secondary: #98989D;
      --primary: #0A84FF;
      --primary-light: #5AC8FA;
      --success: #30D158;
      --warning: #FF9F0A;
      --danger: #FF453A;
      --info: #64D2FF;
      --purple: #BF5AF2;
      --teal: #6AC4DC;
      --border: rgba(255,255,255,0.12);
      --chart-grid: rgba(255,255,255,0.06);
      --menu-bg: rgba(44, 44, 46, 0.9);
      --receipt-bg: #323234;
    }
    
    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    html, body { 
      font-family: var(--font-sans); 
      background: var(--bg); 
      color: var(--text); 
      transition: var(--transition);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 16px;
      line-height: 1.5;
      width: 100%;
      overflow-x: hidden;
    }
    
    /* ===== Layout e Componentes ===== */
    .container { 
      max-width: 1280px; 
      margin: 0 auto; 
      padding: 2rem; 
    }
    
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 2rem; 
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    h1 { 
      font-size: 1.75rem; 
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.025em;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .filters { 
      display: flex; 
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    /* Select estilo Apple */
    select { 
      appearance: none;
      -webkit-appearance: none;
      padding: 0.625rem 2rem 0.625rem 1rem;
      border-radius: var(--radius-sm); 
      border: none;
      background: var(--input-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='6' fill='none'%3E%3Cpath fill='%2386868b' d='M6 6 0 0h12L6 6Z'/%3E%3C/svg%3E") no-repeat;
      background-position: right 0.75rem center;
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    select:hover {
      background-color: rgba(142, 142, 147, 0.18);
    }
    
    select option {
      background-color: var(--card-bg);
      color: var(--text);
    }
    
    /* Botões */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      color: #fff;
      background-color: var(--primary);
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary {
      background-color: var(--primary);
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-danger {
      background-color: var(--danger);
    }
    
    .btn-icon {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      border-radius: 50%;
      background: var(--input-bg);
      color: var(--text);
    }
    
    .btn-icon:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .btn-icon svg {
      width: 1.25rem;
      height: 1.25rem;
    }
    
    /* Botão toggle theme */
    .theme-toggle {
      background: var(--input-bg);
      border: none;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .theme-toggle:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .theme-toggle svg {
      width: 1.25rem;
      height: 1.25rem;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Cards de KPIs */
    .kpis { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
      gap: 1rem; 
      margin-bottom: 2rem; 
    }
    
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
      overflow: hidden;
      position: relative;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .kpi-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kpi-title {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .kpi-value {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    
    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .kpi-trend.up {
      color: var(--success);
    }
    
    .kpi-trend.down {
      color: var(--danger);
    }
    
    .kpi-trend svg {
      width: 0.875rem;
      height: 0.875rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .kpi-meta {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .tabs::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      padding: 0.75rem 1.25rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }
    
    .tab:hover {
      color: var(--text);
    }
    
    .tab.active {
      color: var(--primary);
      border-color: var(--primary);
    }
    
    /* Gráficos */
    .charts-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
      gap: 1.5rem; 
      margin-bottom: 2rem;
    }
    
    .chart-container {
      position: relative;
      margin-top: 0.5rem;
      height: 260px;
    }
    
    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      letter-spacing: -0.01em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chart-title-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-legend-color {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
    }
    
    .full-width { 
      grid-column: 1 / -1; 
    }
    
    .full-width .chart-container {
      height: 300px;
    }
    
    /* Tabelas */
    .table-container {
      overflow-x: auto;
      margin-bottom: 2rem;
      border-radius: var(--radius);
      background: var(--card-bg);
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9375rem;
    }
    
    thead {
      background-color: var(--input-bg);
    }
    
    th {
      padding: 1rem;
      font-weight: 600;
      text-align: left;
      color: var(--text-secondary);
    }
    
    td {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }
    
    tr:hover td {
      background-color: var(--input-bg);
    }
    
    .table-actions {
      display: flex;
      gap: 0.5rem;
      opacity: 0.5;
      transition: var(--transition);
    }
    
    tr:hover .table-actions {
      opacity: 1;
    }
    
    .table-action-btn {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--input-bg);
      border: none;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .table-action-btn:hover {
      background-color: rgba(142, 142, 147, 0.3);
    }
    
    .table-action-btn svg {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Status e Tags */
    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status.status-paid {
      background-color: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }
    
    .status.status-pending {
      background-color: rgba(255, 159, 10, 0.1);
      color: var(--warning);
    }
    
    .status.status-overdue {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }
    
    .status.status-scheduled {
      background-color: rgba(90, 200, 250, 0.1);
      color: var(--info);
    }
    
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: var(--input-bg);
      color: var(--text-secondary);
    }
    
    /* Formulário Nova Transação */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.9375rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background-color: var(--input-bg);
      color: var(--text);
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.1);
    }
    
    /* Loading Estado */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .loading-indicator.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .spinner {
      width: 2.5rem;
      height: 2.5rem;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modais */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
      letter-spacing: -0.01em;
    }
    
    .modal-close {
      background: var(--input-bg);
      border: none;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .modal-close:hover {
      background-color: rgba(142, 142, 147, 0.3);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      border-top: 1px solid var(--border);
    }
    
    /* Alertas */
    .alert {
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    
    .alert-info {
      background-color: rgba(10, 132, 255, 0.1);
      color: var(--primary);
    }
    
    .alert-success {
      background-color: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }
    
    .alert-warning {
      background-color: rgba(255, 159, 10, 0.1);
      color: var(--warning);
    }
    
    .alert-danger {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }
    
    .alert-icon {
      flex-shrink: 0;
      width: 1.25rem;
      height: 1.25rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .alert-content {
      flex: 1;
    }
    
    .alert-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    /* Menu Contexto */
    .context-menu {
      position: absolute;
      min-width: 200px;
      background: var(--menu-bg);
      backdrop-filter: blur(8px);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-dropdown);
      z-index: 100;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: all 0.2s ease;
    }
    
    .context-menu.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    
    .context-menu-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .context-menu-item:hover {
      background-color: var(--input-bg);
    }
    
    .context-menu-item svg {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .context-menu-divider {
      height: 1px;
      background-color: var(--border);
      margin: 0.25rem 0;
    }
    
    /* Fluxo de Caixa */
    .cash-flow-card {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .cash-flow-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .cash-flow-title {
      font-size: 1.125rem;
      font-weight: 600;
    }
    
    .cash-flow-balance {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .cash-flow-items {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .flow-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background-color: var(--input-bg);
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    
    .flow-item:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .flow-item-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .flow-item-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    
    .flow-item-icon.income {
      background-color: var(--success);
    }
    
    .flow-item-icon.expense {
      background-color: var(--danger);
    }
    
    .flow-item-info {
      display: flex;
      flex-direction: column;
    }
    
    .flow-item-title {
      font-weight: 500;
    }
    
    .flow-item-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .flow-item-amount {
      font-weight: 600;
    }
    
    .flow-item-amount.income {
      color: var(--success);
    }
    
    .flow-item-amount.expense {
      color: var(--danger);
    }

/* Recibo / Modal de Detalhes */
.receipt {
  background-color: var(--receipt-bg);
  border-radius: var(--radius);
  padding: 2rem;
  max-width: 400px;
  margin: 0 auto;
}

.receipt-header {
  text-align: center;
  margin-bottom: 2rem;
}

.receipt-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.receipt-date {
  color: var(--text-secondary);
  font-size: 0.875rem;
}

.receipt-body {
  margin-bottom: 2rem;
}

.receipt-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}

.receipt-item-label {
  color: var(--text-secondary);
}

.receipt-item-value {
  font-weight: 500;
}

.receipt-divider {
  height: 1px;
  background: var(--border);
  margin: 1rem 0;
}

.receipt-total {
  display: flex;
  justify-content: space-between;
  font-weight: 700;
  font-size: 1.125rem;
  margin-top: 1rem;
}

.receipt-footer {
  text-align: center;
  color: var(--text-secondary);
  font-size: 0.875rem;
  margin-top: 2rem;
}

/* Menus e Navegação */
.nav {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}

.nav-item:hover, 
.nav-item.active {
  background-color: var(--input-bg);
}

.nav-item.active {
  color: var(--primary);
}

.nav-item svg {
  width: 1.25rem;
  height: 1.25rem;
  stroke: currentColor;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* Progress & Metas */
.progress-container {
  width: 100%;
  height: 0.5rem;
  background-color: var(--input-bg);
  border-radius: 1rem;
  overflow: hidden;
  margin-top: 0.5rem;
}

.progress-bar {
  height: 100%;
  border-radius: 1rem;
  transition: width 0.5s ease;
}

.progress-bar.success {
  background-color: var(--success);
}

.progress-bar.warning {
  background-color: var(--warning);
}
 
.progress-bar.danger {
  background-color: var(--danger);
}

/* Gerenciamento de categorias */
.category-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: var(--input-bg);
  border-radius: var(--radius-sm);
  margin-bottom: 0.75rem;
}

.category-item-color {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  color: white;
  flex-shrink: 0;
}

.category-item-info {
  flex: 1;
}

.category-item-actions {
  display: flex;
  gap: 0.5rem;
}

.color-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.color-item {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
}

.color-item:hover, 
.color-item.selected {
  transform: scale(1.1);
}

.color-item.selected {
  border-color: var(--text);
}

.icon-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.icon-item {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--input-bg);
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
}

.icon-item:hover, 
.icon-item.selected {
  background-color: rgba(142, 142, 147, 0.3);
}

.icon-item.selected {
  border-color: var(--primary);
}

/* Análise mensal */
.month-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.month-selector {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.month-nav-arrow {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--input-bg);
  border: none;
  cursor: pointer;
  color: var(--text);
  transition: var(--transition);
}

.month-nav-arrow:hover {
  background-color: rgba(142, 142, 147, 0.3);
}

.month-nav-arrow svg {
  width: 1.25rem;
  height: 1.25rem;
}

.month-title {
  font-size: 1.5rem;
  font-weight: 700;
}

.month-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.month-summary-item {
  padding: 1.5rem;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.month-summary-title {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.month-summary-value {
  font-size: 1.75rem;
  font-weight: 700;
}

.month-transactions {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.month-transaction {
  display: flex;
  justify-content: space-between;
  padding: 1rem;
  background-color: var(--input-bg);
  border-radius: var(--radius-sm);
  align-items: center;
}

.month-transaction-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.month-transaction-icon {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.month-transaction-info {
  display: flex;
  flex-direction: column;
}

.month-transaction-title {
  font-weight: 500;
}

.month-transaction-date {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.month-transaction-amount {
  font-weight: 600;
}

/* Responsividade */
@media (max-width: 1024px) {
  .container {
    padding: 1.5rem;
  }
  
  .header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-right {
    width: 100%;
    justify-content: space-between;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .kpis {
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .month-summary {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 576px) {
  .container {
    padding: 1rem;
  }
  
  .kpis {
    grid-template-columns: 1fr;
  }
  
  .flow-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .flow-item-left {
    width: 100%;
    justify-content: space-between;
  }
  
  .month-transaction {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .month-transaction-left {
    width: 100%;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header e Filtros -->
    <div class="header">
      <div class="header-title">
        <h1>Controle Financeiro Familiar</h1>
      </div>
      <div class="header-right">
        <div class="filters">
          <select id="filter-year">
            <!-- Anos serão inseridos via JavaScript -->
          </select>
          <select id="filter-month">
            <!-- Meses serão inseridos via JavaScript -->
          </select>
          <select id="filter-category">
            <option value="all">Todas Categorias</option>
          </select>
          <select id="filter-type">
            <option value="all">Todos Tipos</option>
            <option value="income">Receitas</option>
            <option value="expense">Despesas</option>
          </select>
        </div>
        <button class="btn btn-primary" id="btn-new-transaction">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nova Transação
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema">
          <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" />
          </svg>
        </button>
      </div>
    </div>
<!-- KPIs -->
<div class="kpis">
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Saldo Atual</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    </div>
    <div class="kpi-value" id="kpi-balance">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span id="balance-trend">0%</span>
      </div>
      <span>vs. mês anterior</span>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Receitas</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="5 12 12 5 19 12"></polyline>
      </svg>
    </div>
    <div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span id="income-trend">0%</span>
      </div>
      <span>vs. mês anterior</span>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Despesas</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <polyline points="19 12 12 19 5 12"></polyline>
      </svg>
    </div>
    <div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
          <polyline points="17 18 23 18 23 12"></polyline>
        </svg>
        <span id="expenses-trend">0%</span>
      </div>
      <span>vs. mês anterior</span>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Economia do Mês</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="8 12 12 16 16 12"></polyline>
        <line x1="12" y1="8" x2="12" y2="16"></line>
      </svg>
    </div>
    <div class="kpi-value" id="kpi-savings">R$ 0,00</div>
    <div class="kpi-meta">
      <div>Meta: R$ <span id="savings-goal">1.000,00</span></div>
      <div class="progress-container">
        <div class="progress-bar success" id="savings-progress" style="width: 0%"></div>
      </div>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Projeção de Gastos</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    </div>
    <div class="kpi-value" id="kpi-projection">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend" id="projection-status">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span>No orçamento</span>
      </div>
    </div>
  </div>
</div>

<!-- Tabs de Navegação -->
<div class="tabs">
  <div class="tab active" data-tab="overview">Visão Geral</div>
  <div class="tab" data-tab="transactions">Transações</div>
  <div class="tab" data-tab="budget">Orçamento</div>
  <div class="tab" data-tab="goals">Metas</div>
  <div class="tab" data-tab="monthly">Análise Mensal</div>
  <div class="tab" data-tab="categories">Categorias</div>
  <div class="tab" data-tab="reports">Relatórios</div>
</div>

<!-- Conteúdo das Tabs -->
<div class="tab-content" id="tab-overview">
  <!-- Gráficos de Visão Geral -->
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">
        <span>Receitas vs Despesas</span>
        <div class="chart-title-actions">
          <select id="income-expense-chart-period">
            <option value="6">Últimos 6 meses</option>
            <option value="12" selected>Últimos 12 meses</option>
            <option value="24">Últimos 24 meses</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="income-expense-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Despesas por Categoria</span>
        <div class="chart-title-actions">
          <select id="category-chart-period">
            <option value="current" selected>Mês Atual</option>
            <option value="last">Mês Anterior</option>
            <option value="average">Média Anual</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="category-chart"></canvas>
      </div>
    </div>
    
    <div class="card full-width">
      <div class="chart-title">
        <span>Fluxo de Caixa Mensal</span>
        <div class="chart-title-actions">
          <select id="cashflow-chart-year">
            <!-- Anos serão inseridos via JavaScript -->
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="cashflow-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Gastos Fixos vs Variáveis</span>
      </div>
      <div class="chart-container">
        <canvas id="fixed-variable-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Tendência de Gastos</span>
        <div class="chart-title-actions">
          <select id="trend-chart-category">
            <option value="all" selected>Todas Categorias</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="trend-chart"></canvas>
      </div>
    </div>
  </div>

<!-- Atividade Recente -->
  <div class="card">
    <div class="chart-title">Transações Recentes</div>
    <div class="cash-flow-items" id="recent-transactions">
      <!-- Transações recentes serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando transações recentes...
      </div>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-transactions" style="display: none;">
  <!-- Filtros e Pesquisa -->
  <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      <select id="transactions-filter-year">
        <!-- Anos serão inseridos via JavaScript -->
      </select>
      
      <select id="transactions-filter-month">
        <!-- Meses serão inseridos via JavaScript -->
      </select>
      
      <select id="transactions-filter-type">
        <option value="all" selected>Todos Tipos</option>
        <option value="income">Receitas</option>
        <option value="expense">Despesas</option>
      </select>
      
      <select id="transactions-filter-category">
        <option value="all" selected>Todas Categorias</option>
      </select>
      
      <select id="transactions-filter-status">
        <option value="all" selected>Todos Status</option>
        <option value="paid">Pago</option>
        <option value="pending">Pendente</option>
        <option value="scheduled">Agendado</option>
      </select>
    </div>
    
    <div style="position: relative; min-width: 250px;">
      <input type="text" class="form-control" id="transactions-search" placeholder="Pesquisar transações...">
    </div>
  </div>
  
  <!-- Tabela de Transações -->
  <div class="table-container">
    <table id="transactions-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Descrição</th>
          <th>Categoria</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="transactions-table-body">
        <!-- Transações serão inseridas via JavaScript -->
        <tr>
          <td colspan="6" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Carregando transações...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
<!-- Paginação -->  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
    <div>
      <span id="transactions-showing">Mostrando 0 de 0 transações</span>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button class="btn btn-icon" id="transactions-prev">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="btn btn-icon" id="transactions-next">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-budget" style="display: none;">
  <!-- Gráficos de Orçamento -->
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">Orçamento vs Real (Mês Atual)</div>
      <div class="chart-container">
        <canvas id="budget-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">Progresso do Orçamento</div>
      <div id="budget-progress-container">
        <!-- Progresso de orçamento será inserido via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Carregando dados de orçamento...
        </div>
      </div>
    </div>
  </div>
  
<!-- Tabela de Orçamento -->  
  <div class="card">
    <div class="chart-title">
      <span>Planejamento de Orçamento</span>
      <button class="btn btn-primary" id="btn-edit-budget">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        Editar Orçamento
      </button>
    </div>
    <div class="table-container">
      <table id="budget-table">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Orçamento</th>
            <th>Gasto Atual</th>
            <th>Restante</th>
            <th>Progresso</th>
          </tr>
        </thead>
        <tbody id="budget-table-body">
          <!-- Orçamento será inserido via JavaScript -->
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
              Carregando dados de orçamento...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-goals" style="display: none;">
  <!-- Metas Financeiras -->
  <div class="charts-grid">
    <div class="card" style="grid-column: span 2;">
      <div class="chart-title">
        <span>Progresso das Metas</span>
        <button class="btn btn-primary" id="btn-add-goal">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nova Meta
        </button>
      </div>
      <div id="goals-container">
        <!-- Metas serão inseridas via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Carregando metas...
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">Projeção de Economia</div>
      <div class="chart-container">
        <canvas id="savings-projection-chart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Nova Tab: Análise Mensal -->
<div class="tab-content" id="tab-monthly" style="display: none;">
  <div class="month-nav">
    <button class="month-nav-arrow" id="prev-month">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    
    <div class="month-selector">
      <select id="monthly-analysis-year">
        <!-- Anos serão inseridos via JavaScript -->
      </select>
      <select id="monthly-analysis-month">
        <!-- Meses serão inseridos via JavaScript -->
      </select>
    </div>
    
    <button class="month-nav-arrow" id="next-month">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>
  
  <div class="month-summary">
    <div class="card">
      <div class="month-summary-title">Receitas Totais</div>
      <div class="month-summary-value" id="monthly-income" style="color: var(--success);">R$ 0,00</div>
      <div class="kpi-footer">
        <span id="monthly-income-count">0 transações</span>
      </div>
    </div>
    
    <div class="card">
      <div class="month-summary-title">Despesas Totais</div>
      <div class="month-summary-value" id="monthly-expense" style="color: var(--danger);">R$ 0,00</div>
      <div class="kpi-footer">
        <span id="monthly-expense-count">0 transações</span>
      </div>
    </div>
    
    <div class="card">
      <div class="month-summary-title">Saldo do Mês</div>
      <div class="month-summary-value" id="monthly-balance">R$ 0,00</div>
      <div class="kpi-footer">
        <span id="monthly-balance-status">Equilibrado</span>
      </div>
    </div>
  </div>
  
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">Principais Despesas por Categoria</div>
      <div class="chart-container">
        <canvas id="monthly-category-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">Distribuição Diária</div>
      <div class="chart-container">
        <canvas id="monthly-daily-chart"></canvas>
      </div>
    </div>
  </div>
  
  <div class="card" style="margin-bottom: 2rem;">
    <div class="chart-title">
      <span>Lista de Receitas</span>
      <button class="btn btn-success" id="btn-add-income">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nova Receita
      </button>
    </div>
    <div id="monthly-income-list" class="month-transactions">
      <!-- Receitas serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando receitas...
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="chart-title">
      <span>Lista de Despesas</span>
      <button class="btn btn-danger" id="btn-add-expense">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nova Despesa
      </button>
    </div>
    <div id="monthly-expense-list" class="month-transactions">
      <!-- Despesas serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando despesas...
      </div>
    </div>
  </div>
</div>

<!-- Nova Tab: Categorias -->
<div class="tab-content" id="tab-categories" style="display: none;">
  <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
    <h2 style="font-size: 1.5rem; margin: 0;">Gerenciamento de Categorias</h2>
    <div>
      <button class="btn btn-primary" id="btn-add-category">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nova Categoria
      </button>
    </div>
  </div>
  
  <div class="card" style="margin-bottom: 2rem;">
    <div class="chart-title">Categorias de Receita</div>
    <div id="income-categories-list">
      <!-- Categorias de receita serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando categorias de receita...
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="chart-title">Categorias de Despesa</div>
    <div id="expense-categories-list">
      <!-- Categorias de despesa serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando categorias de despesa...
      </div>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-reports" style="display: none;">
  <!-- Relatórios -->
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">
        <span>Relatório Mensal</span>
        <div class="chart-title-actions">
          <select id="report-year">
            <!-- Anos serão inseridos via JavaScript -->
          </select>
          <select id="report-month">
            <!-- Meses serão inseridos via JavaScript -->
          </select>
          <button class="btn btn-primary" id="btn-export-report">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Exportar
          </button>
        </div>
      </div>
      <div id="monthly-report-container">
        <!-- Relatório mensal será inserido via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Selecione um mês para gerar o relatório.
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Análise de Gastos</span>
        <div class="chart-title-actions">
          <select id="analysis-type">
            <option value="category">Por Categoria</option>
            <option value="monthly">Mensal</option>
            <option value="yearly">Anual</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="analysis-chart"></canvas>
      </div>
    </div>
  </div>
</div>
  </div>

<!-- Modal de Nova Transação -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3>
        <button class="modal-close" id="transaction-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="transaction-form">
          <input type="hidden" id="transaction-id">
      <div class="form-grid">
        <div class="form-group">
          <label for="transaction-type">Tipo</label>
          <select class="form-control" id="transaction-type" required>
            <option value="income">Receita</option>
            <option value="expense">Despesa</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="transaction-date">Data</label>
          <input type="date" class="form-control" id="transaction-date" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="transaction-description">Descrição</label>
        <input type="text" class="form-control" id="transaction-description" placeholder="Ex: Salário, Mercado, Conta de Luz..." required>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="transaction-amount">Valor (R$)</label>
          <input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required>
        </div>
        
        <div class="form-group">
          <label for="transaction-category">Categoria</label>
          <select class="form-control" id="transaction-category" required>
            <!-- Categorias serão inseridas via JavaScript -->
          </select>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="transaction-status">Status</label>
          <select class="form-control" id="transaction-status" required>
            <option value="paid">Pago</option>
            <option value="pending">Pendente</option>
            <option value="scheduled">Agendado</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="transaction-payment-method">Forma de Pagamento</label>
          <select class="form-control" id="transaction-payment-method">
            <option value="">Selecione...</option>
            <option value="cash">Dinheiro</option>
            <option value="credit_card">Cartão de Crédito</option>
            <option value="debit_card">Cartão de Débito</option>
            <option value="bank_transfer">Transferência Bancária</option>
            <option value="pix">PIX</option>
            <option value="other">Outro</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="transaction-notes">Observações</label>
        <textarea class="form-control" id="transaction-notes" rows="3" placeholder="Detalhes adicionais..."></textarea>
      </div>
      
      <div id="recurring-transaction-container">
        <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
          <input type="checkbox" id="transaction-recurring" style="width: auto;">
          <label for="transaction-recurring" style="margin-bottom: 0;">Transação Recorrente</label>
        </div>
        
        <div id="recurring-options" style="margin-top: 1rem; display: none;">
          <div class="form-grid">
            <div class="form-group">
              <label for="transaction-frequency">Frequência</label>
              <select class="form-control" id="transaction-frequency">
                <option value="weekly">Semanal</option>
                <option value="biweekly">Quinzenal</option>
                <option value="monthly" selected>Mensal</option>
                <option value="quarterly">Trimestral</option>
                <option value="semiannual">Semestral</option>
                <option value="annual">Anual</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="transaction-end-date">Data de Término (opcional)</label>
              <input type="date" class="form-control" id="transaction-end-date">
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="transaction-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="transaction-modal-save">Salvar</button>
  </div>
</div>
  </div>

<!-- Modal de Edição de Orçamento -->
  <div class="modal" id="budget-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Orçamento</h3>
        <button class="modal-close" id="budget-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="budget-form">
          <div class="form-group">
            <label for="budget-year">Ano</label>
            <select class="form-control" id="budget-year" required>
              <!-- Anos serão inseridos via JavaScript -->
            </select>
          </div>
      <div class="form-group">
        <label for="budget-month">Mês</label>
        <select class="form-control" id="budget-month" required>
          <!-- Meses serão inseridos via JavaScript -->
        </select>
      </div>
      
      <div id="budget-categories-container">
        <!-- Categorias de orçamento serão inseridas via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Carregando categorias...
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="budget-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="budget-modal-save">Salvar</button>
  </div>
</div>
  </div>
  <!-- Modal de Nova Meta -->
  <div class="modal" id="goal-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="goal-modal-title">Nova Meta</h3>
        <button class="modal-close" id="goal-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="goal-form">
          <input type="hidden" id="goal-id">
      <div class="form-group">
        <label for="goal-name">Nome da Meta</label>
        <input type="text" class="form-control" id="goal-name" placeholder="Ex: Férias, Novo Carro, Reforma..." required>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="goal-target">Valor Alvo (R$)</label>
          <input type="number" step="0.01" min="0.01" class="form-control" id="goal-target" placeholder="0,00" required>
        </div>
        
        <div class="form-group">
          <label for="goal-current">Valor Atual (R$)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="goal-current" placeholder="0,00" required>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="goal-date">Data Alvo</label>
          <input type="date" class="form-control" id="goal-date" required>
        </div>
        
        <div class="form-group">
          <label for="goal-category">Categoria</label>
          <select class="form-control" id="goal-category" required>
            <option value="savings">Economia</option>
            <option value="investment">Investimento</option>
            <option value="debt">Pagamento de Dívida</option>
            <option value="purchase">Compra</option>
            <option value="travel">Viagem</option>
            <option value="education">Educação</option>
            <option value="other">Outro</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="goal-notes">Observações</label>
        <textarea class="form-control" id="goal-notes" rows="3" placeholder="Detalhes adicionais..."></textarea>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="goal-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="goal-modal-save">Salvar</button>
  </div>
</div>
  </div>
  <!-- Modal de Nova Categoria -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="category-modal-title">Nova Categoria</h3>
        <button class="modal-close" id="category-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <input type="hidden" id="category-id">
      <div class="form-group">
        <label for="category-name">Nome da Categoria</label>
        <input type="text" class="form-control" id="category-name" placeholder="Ex: Alimentação, Transporte, Investimentos..." required>
      </div>
      
      <div class="form-group">
        <label for="category-type">Tipo</label>
        <select class="form-control" id="category-type" required>
          <option value="expense">Despesa</option>
          <option value="income">Receita</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Cor</label>
        <div class="color-grid" id="color-grid">
          <!-- Cores serão inseridas via JavaScript -->
        </div>
      </div>
      
      <div class="form-group">
        <label>Ícone</label>
        <div class="icon-grid" id="icon-grid">
          <!-- Ícones serão inseridos via JavaScript -->
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="category-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="category-modal-save">Salvar</button>
  </div>
</div>
  </div>
  <!-- Modal de Detalhes da Transação -->
  <div class="modal" id="transaction-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Detalhes da Transação</h3>
        <button class="modal-close" id="transaction-details-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="receipt" id="transaction-receipt">
          <!-- Detalhes da transação serão inseridos via JavaScript -->
          <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Carregando detalhes da transação...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="transaction-details-delete">Excluir</button>
        <button class="btn btn-primary" id="transaction-details-edit">Editar</button>
      </div>
    </div>
  </div>
  <!-- Modal de Confirmação -->
  <div class="modal" id="confirm-modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title" id="confirm-modal-title">Confirmação</h3>
        <button class="modal-close" id="confirm-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message">Tem certeza que deseja realizar esta ação?</p>
      </div>
      <div class="modal-footer">
        <button class="btn" id="confirm-modal-cancel">Cancelar</button>
        <button class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button>
      </div>
    </div>
  </div>

<!-- Loading Indicator -->
  <div class="loading-indicator" id="loading">
    <div class="spinner"></div>
  </div>

<!-- SUBSTITUA TODO O CONTEÚDO ENTRE <script> E </script> PELO BLOCO ABAIXO -->
<script>
    // ===== Configurações e Variáveis Globais =====
    const root = document.documentElement;
    // Seletores DOM Globais (acessados frequentemente) - Inicializados como null, definidos após DOMContentLoaded
    let themeToggle = null;
    let themeIcon = null;
    let loading = null;
    let tabs = null;
    let tabContents = null;
    let transactionModal = null;
    let transactionForm = null;
    let budgetModal = null;
    let goalModal = null;
    let categoryModal = null;
    let transactionDetailsModal = null;
    let confirmModal = null;
    let btnNewTransaction = null;
    let btnEditBudget = null;
    let btnAddGoal = null;
    let btnAddCategory = null;
    let btnAddIncome = null;
    let btnAddExpense = null;

    // Estados da Aplicação
    let transactions = [];
    let categories = [];
    let budgets = [];
    let goals = [];
    let currentTab = 'overview'; // Aba inicial padrão

    // Instâncias dos Gráficos
    let incomeExpenseChart = null;
    let categoryChart = null;
    let cashflowChart = null;
    let fixedVariableChart = null;
    let trendChart = null;
    let budgetChart = null;
    let savingsProjectionChart = null;
    let analysisChart = null;
    let monthlyCategoryChart = null;
    let monthlyDailyChart = null;
    let reportPieChart = null;

    // Paginação da Tabela de Transações
    let currentTransactionsPage = 1;
    const transactionsPerPage = 10;
    let currentFilteredTransactions = [];

    // Configurações e Constantes
    const TRANSACTION_TYPES = { /* ... (mantido como na Parte 1) ... */ };
    const DEFAULT_EXPENSE_CATEGORIES = [ /* ... (mantido como na Parte 1) ... */ ];
    const AVAILABLE_COLORS = [ /* ... (mantido como na Parte 1) ... */ ];
    const AVAILABLE_ICONS = [ /* ... (mantido como na Parte 1) ... */ ];
    const PAYMENT_METHODS = { /* ... (mantido como na Parte 1) ... */ };
    const TRANSACTION_STATUS = { /* ... (mantido como na Parte 1) ... */ };

    // ===== Firebase Integration =====
    let db;
    let firestore;

    function waitForFirebase() {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 50; // Tenta por 5 segundos
            const checkFirebase = () => {
                if (window.db && window.firestore) {
                    db = window.db;
                    firestore = window.firestore;
                    console.log("Conexão Firebase estabelecida.");
                    resolve();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(checkFirebase, 100);
                } else {
                    console.error("Falha ao conectar ao Firebase após várias tentativas.");
                    reject(new Error("Não foi possível inicializar o Firebase. Verifique a configuração e a conexão."));
                }
            };
            checkFirebase();
        });
    }

    // --- Funções CRUD Firebase (load, save, update, delete) ---
    // (Mantidas como nos blocos anteriores, com verificações e show/hideLoading)

    async function saveTransactionToFirestore(transaction) {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        const transactionData = { ...transaction }; // Clona para não modificar o original
        const firestoreId = transactionData.firestoreId;
        delete transactionData.firestoreId; // Remove antes de salvar

        try {
            showLoading();
            const transactionsRef = firestore.collection(db, 'transactions');
            let docId;
            if (firestoreId) { // Atualização
                await firestore.updateDoc(firestore.doc(db, 'transactions', firestoreId), transactionData);
                docId = firestoreId;
            } else { // Criação
                const docRef = await firestore.addDoc(transactionsRef, transactionData);
                docId = docRef.id;
            }
            hideLoading();
            return docId; // Retorna o ID do Firestore
        } catch (error) {
            console.error('Erro ao salvar transação no Firestore:', error);
            hideLoading();
            showAlert('Erro ao salvar transação. Tente novamente.', 'danger');
            throw error; // Re-lança para o chamador tratar se necessário
        }
    }

    async function loadTransactionsFromFirestore() {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        try {
            showLoading();
            const transactionsRef = firestore.collection(db, 'transactions');
            // Ordenar por data no Firestore pode melhorar performance inicial, mas faremos no cliente por enquanto
            // const q = firestore.query(transactionsRef, firestore.orderBy("date", "desc"));
            const snapshot = await firestore.getDocs(transactionsRef);
            const loadedTransactions = snapshot.docs.map(doc => ({
                ...doc.data(),
                firestoreId: doc.id
            }));
            hideLoading();
            return loadedTransactions;
        } catch (error) {
            console.error('Erro ao carregar transações do Firestore:', error);
            hideLoading();
            showAlert('Erro ao carregar transações. Tente novamente.', 'danger');
            return []; // Retorna array vazio em caso de erro
        }
    }

    async function deleteTransactionFromFirestore(firestoreId) {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
         if (!firestoreId) throw new Error("ID do Firestore inválido para exclusão.");
        try {
            showLoading();
            await firestore.deleteDoc(firestore.doc(db, 'transactions', firestoreId));
            hideLoading();
            return true;
        } catch (error) {
            console.error('Erro ao excluir transação do Firestore:', error);
            hideLoading();
            showAlert('Erro ao excluir transação. Tente novamente.', 'danger');
            return false;
        }
    }

    async function saveCategoryToFirestore(category) {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        const categoryData = { ...category };
        const firestoreId = categoryData.firestoreId;
        delete categoryData.firestoreId;

        try {
            showLoading();
            const categoriesRef = firestore.collection(db, 'categories');
            let docId;
            if (firestoreId) {
                await firestore.updateDoc(firestore.doc(db, 'categories', firestoreId), categoryData);
                docId = firestoreId;
            } else {
                // Antes de adicionar, verifica se já existe uma categoria com o mesmo 'id' (UUID)
                // Embora o Firestore gere seu próprio ID, usamos nosso 'id' para lógica interna
                 const q = firestore.query(categoriesRef, firestore.where('id', '==', category.id));
                 const existingSnapshot = await firestore.getDocs(q);
                 if (!existingSnapshot.empty) {
                     // Já existe, apenas atualiza (caso raro, mas seguro)
                     const existingDoc = existingSnapshot.docs[0];
                     await firestore.updateDoc(existingDoc.ref, categoryData);
                     docId = existingDoc.id;
                     console.warn(`Categoria com id ${category.id} já existia. Atualizando.`);
                 } else {
                     const docRef = await firestore.addDoc(categoriesRef, categoryData);
                     docId = docRef.id;
                 }
            }
            hideLoading();
            return docId;
        } catch (error) {
            console.error('Erro ao salvar categoria no Firestore:', error);
            hideLoading();
            showAlert('Erro ao salvar categoria. Tente novamente.', 'danger');
            throw error;
        }
    }


    async function loadCategoriesFromFirestore() {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        try {
            showLoading();
            const categoriesRef = firestore.collection(db, 'categories');
            const snapshot = await firestore.getDocs(categoriesRef);
            let loadedCategories = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
            hideLoading();

            if (loadedCategories.length === 0) {
                console.log("Nenhuma categoria encontrada, criando padrões...");
                // Passa as definições padrão para a função criar
                const defaultCats = [
                    { id: 'housing', name: 'Moradia', color: '#FF9F0A', icon: '🏠', type: 'expense' },
                    { id: 'food', name: 'Alimentação', color: '#30D158', icon: '🍔', type: 'expense' },
                    { id: 'transportation', name: 'Transporte', color: '#0A84FF', icon: '🚗', type: 'expense' },
                    { id: 'health', name: 'Saúde', color: '#FF453A', icon: '🏥', type: 'expense' },
                    { id: 'leisure', name: 'Lazer', color: '#BF5AF2', icon: '🎮', type: 'expense' },
                    { id: 'education', name: 'Educação', color: '#5E5CE6', icon: '📚', type: 'expense' },
                    { id: 'shopping', name: 'Compras', color: '#FF375F', icon: '🛍️', type: 'expense' },
                    { id: 'bills', name: 'Contas', color: '#64D2FF', icon: '📝', type: 'expense' },
                    { id: 'unexpected', name: 'Inesperadas', color: '#FF2D55', icon: '⚠️', type: 'expense' },
                    { id: 'other_expenses', name: 'Outras Despesas', color: '#A0A0A0', icon: '💼', type: 'expense' },
                    { id: 'salary', name: 'Salário', color: '#30D158', icon: '💰', type: 'income' },
                    { id: 'bonus', name: 'Bônus', color: '#5E5CE6', icon: '🎁', type: 'income' },
                    { id: 'investments', name: 'Investimentos', color: '#0A84FF', icon: '📊', type: 'income' },
                    { id: 'other_income', name: 'Outras Receitas', color: '#FF9F0A', icon: '💸', type: 'income' }
                 ];
                loadedCategories = await createDefaultCategories(defaultCats);
            }
            return loadedCategories;
        } catch (error) {
            console.error('Erro ao carregar categorias do Firestore:', error);
            hideLoading();
            showAlert('Erro ao carregar categorias. Tente novamente.', 'danger');
            return [];
        }
    }


    async function deleteCategoryFromFirestore(firestoreId) {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        if (!firestoreId) throw new Error("ID do Firestore inválido para exclusão de categoria.");
        try {
            showLoading();
            await firestore.deleteDoc(firestore.doc(db, 'categories', firestoreId));
            hideLoading();
            return true;
        } catch (error) {
            console.error('Erro ao excluir categoria do Firestore:', error);
            hideLoading();
            showAlert('Erro ao excluir categoria. Tente novamente.', 'danger');
            return false;
        }
    }

    async function saveBudgetToFirestore(budget) {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        const budgetDataToSave = { ...budget };
        delete budgetDataToSave.firestoreId;

        try {
            showLoading();
            const budgetsRef = firestore.collection(db, 'budgets');
            const q = firestore.query(budgetsRef, firestore.where('year', '==', budget.year), firestore.where('month', '==', budget.month));
            const querySnapshot = await firestore.getDocs(q);
            let docId;
            if (!querySnapshot.empty) {
                const existingBudgetDoc = querySnapshot.docs[0];
                await firestore.updateDoc(existingBudgetDoc.ref, budgetDataToSave);
                docId = existingBudgetDoc.id;
            } else {
                const docRef = await firestore.addDoc(budgetsRef, budgetDataToSave);
                docId = docRef.id;
            }
            hideLoading();
            return docId;
        } catch (error) {
            console.error('Erro ao salvar orçamento no Firestore:', error);
            hideLoading();
            showAlert('Erro ao salvar orçamento. Tente novamente.', 'danger');
            throw error;
        }
    }

    async function loadBudgetsFromFirestore() {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        try {
            showLoading();
            const budgetsRef = firestore.collection(db, 'budgets');
            const snapshot = await firestore.getDocs(budgetsRef);
            const loadedBudgets = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
            hideLoading();
            return loadedBudgets;
        } catch (error) {
            console.error('Erro ao carregar orçamentos do Firestore:', error);
            hideLoading();
            showAlert('Erro ao carregar orçamentos. Tente novamente.', 'danger');
            return [];
        }
    }

    async function getBudgetForMonthAndYear(month, year) {
        // Prioriza cache local
        const localBudget = budgets.find(b => b.month === month && b.year === year);
        if (localBudget) return localBudget;

        // Busca no Firestore se não estiver no cache
         if (!db || !firestore) throw new Error("Firestore não inicializado.");
        try {
            // showLoading(); // Evita loading excessivo aqui
            const budgetsRef = firestore.collection(db, 'budgets');
            const q = firestore.query(budgetsRef, firestore.where('year', '==', year), firestore.where('month', '==', month));
            const querySnapshot = await firestore.getDocs(q);
            // hideLoading();

            if (!querySnapshot.empty) {
                const budgetDoc = querySnapshot.docs[0];
                const budgetData = { ...budgetDoc.data(), firestoreId: budgetDoc.id };
                budgets.push(budgetData); // Adiciona ao cache local
                return budgetData;
            }
            return null;
        } catch (error) {
            console.error('Erro ao obter orçamento específico do Firestore:', error);
            // hideLoading();
            return null;
        }
    }


    async function saveGoalToFirestore(goal) {
         if (!db || !firestore) throw new Error("Firestore não inicializado.");
         const goalDataToSave = { ...goal };
         const firestoreId = goalDataToSave.firestoreId;
         delete goalDataToSave.firestoreId;

         try {
             showLoading();
             const goalsRef = firestore.collection(db, 'goals');
             let docId;
             if (firestoreId) {
                 await firestore.updateDoc(firestore.doc(db, 'goals', firestoreId), goalDataToSave);
                 docId = firestoreId;
             } else {
                 const docRef = await firestore.addDoc(goalsRef, goalDataToSave);
                 docId = docRef.id;
             }
             hideLoading();
             return docId;
         } catch (error) {
             console.error('Erro ao salvar meta no Firestore:', error);
             hideLoading();
             showAlert('Erro ao salvar meta. Tente novamente.', 'danger');
             throw error;
         }
    }

    async function loadGoalsFromFirestore() {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        try {
            showLoading();
            const goalsRef = firestore.collection(db, 'goals');
            const snapshot = await firestore.getDocs(goalsRef);
            const loadedGoals = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
            hideLoading();
            return loadedGoals;
        } catch (error) {
            console.error('Erro ao carregar metas do Firestore:', error);
            hideLoading();
            showAlert('Erro ao carregar metas. Tente novamente.', 'danger');
            return [];
        }
    }

    async function deleteGoalFromFirestore(firestoreId) {
        if (!db || !firestore) throw new Error("Firestore não inicializado.");
        if (!firestoreId) throw new Error("ID do Firestore inválido para exclusão de meta.");
        try {
            showLoading();
            await firestore.deleteDoc(firestore.doc(db, 'goals', firestoreId));
            hideLoading();
            return true;
        } catch (error) {
            console.error('Erro ao excluir meta do Firestore:', error);
            hideLoading();
            showAlert('Erro ao excluir meta. Tente novamente.', 'danger');
            return false;
        }
    }

    async function createDefaultCategories(defaultCategoryList) {
        console.log("Tentando criar categorias padrão...");
        const savedCategories = [];
        showLoading();

        try {
            for (const category of defaultCategoryList) {
                // Garante que cada categoria tenha um ID interno (UUID)
                const categoryToSave = { ...category, id: category.id || uuid.v4() };
                const firestoreId = await saveCategoryToFirestore(categoryToSave);
                savedCategories.push({ ...categoryToSave, firestoreId });
                console.log(`Categoria padrão "${category.name}" criada.`);
            }
        } catch (error) {
            console.error('Erro durante a criação das categorias padrão:', error);
            // showAlert já é chamado por saveCategoryToFirestore
        } finally {
            hideLoading();
        }
        console.log("Criação de categorias padrão concluída.");
        return savedCategories;
    }


    // ===== Utilitários e Helpers =====
    // (Mantidas como no bloco 2)
    function formatCurrency(value) { /* ... */ }
    function formatDate(dateString) { /* ... */ }
    function formatDateForInput(dateString) { /* ... */ }
    function showLoading() { /* ... */ }
    function hideLoading() { /* ... */ }
    function showAlert(message, type = 'info', duration = 4000) { /* ... */ }
    function formatNumber(num, digits = 1) { /* ... */ }
    function debounce(func, wait) { /* ... */ }

    // ===== Lógica de Tema =====
    // (Mantidas como no bloco 2)
    function updateThemeIcon(theme) { /* ... */ }
    function setupTheme() { /* ... */ }
    // Listener do themeToggle é movido para init()

    // ===== Gerenciamento de Dados e Cálculos =====
    // (Mantidas como no bloco 3)
    function populateYearSelects() { /* ... */ }
    function populateMonthSelects() { /* ... */ }
    function filterTransactions(filters = {}) { /* ... */ }
    function getFinanceSummary(filteredTransactions) { /* ... */ }
    function getExpensesByCategory(filteredTransactions) { /* ... */ }
    function getIncomeVsExpensesByMonth(numberOfMonths = 12) { /* ... */ }
    function getCashFlowData(year) { /* ... */ }
    async function getCurrentBudget() { /* ... */ }
    function getCurrentExpensesByCategory() { /* ... */ }
    function calculateGoalProgress(goal) { /* ... */ }

    // ===== Inicialização e Manipulação de Componentes =====
    // (Mantidas como no bloco 4, mas os listeners são adicionados aqui ou em init)
    function initFilters() { /* ... */ } // Adiciona listeners aqui
    function updateCategorySelects() { /* ... */ }
    function updateCategorySelectForForm() { /* ... */ }
    function initModals() { /* ... */ } // Adiciona listeners aqui
    function initColorGrid() { /* ... */ }
    function initIconGrid() { /* ... */ }
    function selectColorOrIcon(itemElement, itemSelector) { /* ... */ }
    function openModal(modalElement) { /* ... */ }
    function closeModal(modalElement) { /* ... */ }
    function openTransactionModal(transaction = null, defaultType = null) { /* ... */ }
    async function saveTransaction() { /* ... */ }
    async function openBudgetModal() { /* ... */ }
    async function populateBudgetModalCategories() { /* ... */ }
    async function saveBudget() { /* ... */ }
    function openGoalModal(goal = null) { /* ... */ }
    async function saveGoal() { /* ... */ }
    function openCategoryModal(category = null) { /* ... */ }
    async function saveCategory() { /* ... */ }

    // ===== Inicialização e Atualização de Gráficos =====
    // (Mantidas como no bloco 5)
    function destroyChart(chartInstance) { /* ... */ }
    function getChartCommonOptions() { /* ... */ }
    function updateIncomeExpenseChart() { /* ... */ }
    function updateCategoryChart() { /* ... */ }
    function updateCashFlowChart() { /* ... */ }
    function updateFixedVariableChart() { /* ... */ }
    function updateTrendChart() { /* ... */ }
    async function updateBudgetChart() { /* ... */ }
    function updateSavingsProjectionChart() { /* ... */ }
    function updateAnalysisChart() { /* ... */ }
    function updateMonthlyAnalysisCharts() { /* ... */ }
    function updateReportPieChart() { /* ... */ }
    async function initCharts() { /* ... */ }
    async function updateCharts() { /* ... */ }

    // ===== Interface e Interação =====
    // (Mantidas como no bloco 6, mas listeners são adicionados aqui ou em init)
    function initTabs() { /* ... */ } // Adiciona listeners aqui
    function updateKPIs() { /* ... */ }
    async function updateProjectionStatus(projectedExpenses, filterYear, filterMonth) { /* ... */ }
    function updateRecentTransactions() { /* ... */ }
    function updateTransactionsTable() { /* ... */ } // Contém listeners de paginação
    async function updateBudgetTab() { /* ... */ }
    async function updateBudgetProgress() { /* ... */ }
    function updateGoalsTab() { /* ... */ }
    function openUpdateGoalBalanceModal(goal) { /* ... */ }
    async function updateGoalBalance(goalId, newAmount) { /* ... */ }
    function updateMonthlyAnalysis() { /* ... */ }
    function updateMonthlyTransactionLists(monthTransactions) { /* ... */ }
    function navigateToPreviousMonth() { /* ... */ }
    function navigateToNextMonth() { /* ... */ }
    function updateCategoriesTab() { /* ... */ }
    function updateReportsTab() { /* ... */ }
    function generateMonthlyReport() { /* ... */ }
    function exportMonthlyReport() { /* ... */ }

    // --- Funções de Exclusão com Confirmação ---
    // (Funções que chamam o modal de confirmação e depois a exclusão real)

    async function showTransactionDetails(transactionId) {
        const transaction = transactions.find(t => t.id === transactionId);
        if (!transaction) {
            showAlert('Transação não encontrada.', 'warning');
            return;
        }

        const receiptContainer = document.getElementById('transaction-receipt');
        const detailsModal = document.getElementById('transaction-details-modal');
        const editBtn = document.getElementById('transaction-details-edit');
        const deleteBtn = document.getElementById('transaction-details-delete');

        if (!receiptContainer || !detailsModal || !editBtn || !deleteBtn) {
            console.error("Elementos do modal de detalhes não encontrados.");
            return;
        }

        receiptContainer.innerHTML = '<div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">Carregando...</div>'; // Feedback

        // Preencher o recibo (lógica movida para cá)
        const categoryData = categories.find(c => c.id === transaction.category) || { name: '?', color: '#ccc', icon: '?' };
        const date = new Date(transaction.date);
        const formattedDateLong = new Intl.DateTimeFormat('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }).format(date);
        const statusInfo = TRANSACTION_STATUS[transaction.status] || { name: '?', class: '' };
        const paymentMethodText = PAYMENT_METHODS[transaction.paymentMethod] || transaction.paymentMethod || 'N/A';

        let recurringText = '';
        if (transaction.recurring && transaction.frequency) {
            const frequencies = { weekly: 'Semanal', biweekly: 'Quinzenal', monthly: 'Mensal', quarterly: 'Trimestral', semiannual: 'Semestral', annual: 'Anual' };
            recurringText = frequencies[transaction.frequency] || transaction.frequency;
            if (transaction.endDate) {
                 recurringText += ` até ${formatDate(transaction.endDate)}`;
            }
        }


        receiptContainer.innerHTML = `
            <div class="receipt-header">
              <div class="receipt-title">${transaction.type === 'income' ? 'Receita' : 'Despesa'} Recebida</div>
              <div class="receipt-date">${formattedDateLong}</div>
            </div>
            <div class="receipt-body">
              <div class="receipt-item">
                <span class="receipt-item-label">Descrição:</span>
                <span class="receipt-item-value">${transaction.description}</span>
              </div>
               <div class="receipt-item">
                <span class="receipt-item-label">Categoria:</span>
                <span class="receipt-item-value" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${categoryData.color}; display: inline-block;"></span>
                    ${categoryData.name}
                </span>
              </div>
              <div class="receipt-item">
                 <span class="receipt-item-label">Data Lançamento:</span>
                 <span class="receipt-item-value">${formatDate(transaction.date)}</span>
              </div>
              <div class="receipt-item">
                 <span class="receipt-item-label">Status:</span>
                 <span class="receipt-item-value status ${statusInfo.class}" style="background: none; padding: 0; color: inherit;">${statusInfo.name}</span>
              </div>
              ${transaction.paymentMethod ? `<div class="receipt-item"><span class="receipt-item-label">Pagamento:</span><span class="receipt-item-value">${paymentMethodText}</span></div>` : ''}
              ${recurringText ? `<div class="receipt-item"><span class="receipt-item-label">Recorrência:</span><span class="receipt-item-value">${recurringText}</span></div>` : ''}
              ${transaction.notes ? `<div class="receipt-item" style="flex-direction: column; align-items: flex-start;"><span class="receipt-item-label">Notas:</span><span class="receipt-item-value" style="margin-top: 0.25rem; white-space: pre-wrap;">${transaction.notes}</span></div>` : ''}
              <div class="receipt-divider"></div>
              <div class="receipt-total">
                <span>Total:</span>
                <span style="color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                    ${formatCurrency(transaction.amount)}
                </span>
              </div>
            </div>
            <div class="receipt-footer">
              ID: ${transaction.id.substring(0, 8)}...
            </div>
        `;

        // Configura botões do modal de detalhes (remove listeners antigos clonando)
        const newEditBtn = editBtn.cloneNode(true);
        editBtn.parentNode.replaceChild(newEditBtn, editBtn);
        newEditBtn.onclick = () => {
            closeModal(detailsModal);
            openTransactionModal(transaction);
        };

        const newDeleteBtn = deleteBtn.cloneNode(true);
        deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
        newDeleteBtn.onclick = () => {
            // Não fecha o modal de detalhes ainda, espera a confirmação
            confirmDeleteTransaction(transaction.id);
        };

        openModal(detailsModal);
    }


    function confirmDeleteTransaction(transactionId) {
        const transaction = transactions.find(t => t.id === transactionId);
        if (!transaction) {
            showAlert('Transação não encontrada para exclusão.', 'warning');
            return;
        }

        const confirmModalElement = document.getElementById('confirm-modal');
        const title = document.getElementById('confirm-modal-title');
        const message = document.getElementById('confirm-modal-message');
        const confirmBtn = document.getElementById('confirm-modal-confirm');
        const cancelBtn = document.getElementById('confirm-modal-cancel');

        if (!confirmModalElement || !title || !message || !confirmBtn || !cancelBtn) return;

        title.textContent = 'Excluir Transação';
        message.textContent = `Tem certeza que deseja excluir a transação "${transaction.description}" (${formatCurrency(transaction.amount)})? Esta ação não pode ser desfeita.`;
        confirmBtn.textContent = 'Excluir';
        confirmBtn.className = 'btn btn-danger'; // Botão vermelho

        // Clona botões para remover listeners antigos
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = async () => {
            closeModal(confirmModalElement); // Fecha confirmação primeiro
            await deleteTransaction(transactionId); // Tenta excluir
            // Fecha modal de detalhes SE ele ainda estiver aberto após a exclusão
             if (transactionDetailsModal?.classList.contains('active')) {
                 closeModal(transactionDetailsModal);
             }
        };

        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.onclick = () => closeModal(confirmModalElement);

        openModal(confirmModalElement);
    }

    async function deleteTransaction(transactionId) {
        try {
            const index = transactions.findIndex(t => t.id === transactionId);
            if (index === -1) throw new Error("Transação não encontrada localmente.");

            const firestoreId = transactions[index].firestoreId;
            if (!firestoreId) throw new Error("ID do Firestore não encontrado para esta transação.");

            const success = await deleteTransactionFromFirestore(firestoreId);
            if (success) {
                transactions.splice(index, 1); // Remove do array local
                showAlert('Transação excluída com sucesso!', 'success');
                updateDashboard(); // Atualiza a interface
            }
            // Se falhar, deleteTransactionFromFirestore já mostra alerta
        } catch (error) {
            console.error("Erro ao excluir transação:", error);
            showAlert(error.message || 'Erro ao excluir transação.', 'danger');
        }
    }


    function confirmDeleteCategory(categoryId) {
        const category = categories.find(c => c.id === categoryId);
        if (!category) {
            showAlert('Categoria não encontrada.', 'warning');
            return;
        }

        // Verifica uso antes de excluir
        const isUsed = transactions.some(t => t.category === categoryId);
        if (isUsed) {
             showAlert(`Categoria "${category.name}" está em uso e não pode ser excluída.`, 'warning');
             return;
        }
        // Verifica se é uma categoria padrão essencial? (Opcional)

        const confirmModalElement = document.getElementById('confirm-modal');
        // ... (configura título, mensagem, botões como em confirmDeleteTransaction) ...
         document.getElementById('confirm-modal-title').textContent = 'Excluir Categoria';
         document.getElementById('confirm-modal-message').textContent = `Tem certeza que deseja excluir a categoria "${category.name}"? Esta ação não pode ser desfeita.`;
         const confirmBtn = document.getElementById('confirm-modal-confirm');
         confirmBtn.textContent = 'Excluir';
         confirmBtn.className = 'btn btn-danger';

         const newConfirmBtn = confirmBtn.cloneNode(true);
         confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
         newConfirmBtn.onclick = async () => {
             closeModal(confirmModalElement);
             await deleteCategory(categoryId);
         };
          // Configura botão cancelar também
         const cancelBtn = document.getElementById('confirm-modal-cancel');
         const newCancelBtn = cancelBtn.cloneNode(true);
         cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
         newCancelBtn.onclick = () => closeModal(confirmModalElement);


        openModal(confirmModalElement);
    }

    async function deleteCategory(categoryId) {
         try {
            const index = categories.findIndex(c => c.id === categoryId);
            if (index === -1) throw new Error("Categoria não encontrada localmente.");

             // Re-verifica uso (segurança)
             if (transactions.some(t => t.category === categoryId)) {
                  showAlert(`Categoria "${categories[index].name}" ainda está em uso.`, 'warning');
                  return;
             }

            const firestoreId = categories[index].firestoreId;
             if (!firestoreId) throw new Error("ID do Firestore não encontrado para esta categoria.");

            const success = await deleteCategoryFromFirestore(firestoreId);
            if (success) {
                categories.splice(index, 1);
                showAlert('Categoria excluída com sucesso!', 'success');
                updateCategorySelects(); // Atualiza selects dependentes
                updateDashboard(); // Atualiza a interface
            }
        } catch (error) {
            console.error("Erro ao excluir categoria:", error);
            showAlert(error.message || 'Erro ao excluir categoria.', 'danger');
        }
    }

    function confirmDeleteGoal(goalId) {
        const goal = goals.find(g => g.id === goalId);
        if (!goal) {
            showAlert('Meta não encontrada.', 'warning');
            return;
        }

        const confirmModalElement = document.getElementById('confirm-modal');
        // ... (configura título, mensagem, botões) ...
        document.getElementById('confirm-modal-title').textContent = 'Excluir Meta';
        document.getElementById('confirm-modal-message').textContent = `Tem certeza que deseja excluir a meta "${goal.name}"?`;
        const confirmBtn = document.getElementById('confirm-modal-confirm');
        confirmBtn.textContent = 'Excluir';
        confirmBtn.className = 'btn btn-danger';

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = async () => {
            closeModal(confirmModalElement);
            await deleteGoal(goalId);
        };
         // Configura botão cancelar também
        const cancelBtn = document.getElementById('confirm-modal-cancel');
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.onclick = () => closeModal(confirmModalElement);

        openModal(confirmModalElement);
    }

    async function deleteGoal(goalId) {
        try {
            const index = goals.findIndex(g => g.id === goalId);
            if (index === -1) throw new Error("Meta não encontrada localmente.");

            const firestoreId = goals[index].firestoreId;
             if (!firestoreId) throw new Error("ID do Firestore não encontrado para esta meta.");

            const success = await deleteGoalFromFirestore(firestoreId);
            if (success) {
                goals.splice(index, 1);
                showAlert('Meta excluída com sucesso!', 'success');
                 // Atualiza a UI se a aba de metas estiver ativa
                 if (currentTab === 'goals') {
                     updateGoalsTab();
                 } else {
                    updateDashboard(); // Atualiza geral se não estiver na aba
                 }
            }
        } catch (error) {
            console.error("Erro ao excluir meta:", error);
            showAlert(error.message || 'Erro ao excluir meta.', 'danger');
        }
    }


    // ===== Lógica Principal da Aplicação =====
    async function updateDashboard() {
        console.log("Atualizando dashboard...");
        showLoading();
        try {
            // A ordem aqui pode ser importante
            updateKPIs(); // Atualiza KPIs com base nos filtros

             if (currentTab === 'overview') {
                 updateRecentTransactions(); // Atualiza recentes apenas na visão geral
             }

            // Atualiza gráficos que dependem dos filtros globais ou dados gerais
            await updateCharts(); // Atualiza todos os gráficos

            // Atualiza conteúdo específico da tab ATIVA
            switch (currentTab) {
                case 'transactions': updateTransactionsTable(); break;
                case 'budget': await updateBudgetTab(); break; // É async
                case 'goals': updateGoalsTab(); break;
                case 'monthly': updateMonthlyAnalysis(); break;
                case 'categories': updateCategoriesTab(); break;
                case 'reports': updateReportsTab(); break;
            }
            console.log("Dashboard atualizado.");
        } catch (error) {
            console.error("Erro durante updateDashboard:", error);
            showAlert("Erro ao atualizar dados do dashboard.", "danger");
        } finally {
            hideLoading();
        }
    }

    // ===== Inicialização da Aplicação =====
    async function init() {
        console.log("Iniciando aplicação...");
        showLoading();
        moment.locale('pt-br'); // Define locale do Moment.js

        // Seleciona elementos DOM principais APÓS DOMContentLoaded
        themeToggle = document.getElementById('theme-toggle');
        themeIcon = document.getElementById('theme-icon');
        loading = document.getElementById('loading');
        tabs = document.querySelectorAll('.tab');
        tabContents = document.querySelectorAll('.tab-content');
        transactionModal = document.getElementById('transaction-modal');
        transactionForm = document.getElementById('transaction-form');
        budgetModal = document.getElementById('budget-modal');
        goalModal = document.getElementById('goal-modal');
        categoryModal = document.getElementById('category-modal');
        transactionDetailsModal = document.getElementById('transaction-details-modal');
        confirmModal = document.getElementById('confirm-modal');
        btnNewTransaction = document.getElementById('btn-new-transaction');
        btnEditBudget = document.getElementById('btn-edit-budget');
        btnAddGoal = document.getElementById('btn-add-goal');
        btnAddCategory = document.getElementById('btn-add-category');
        btnAddIncome = document.getElementById('btn-add-income');
        btnAddExpense = document.getElementById('btn-add-expense');

        // Verifica se elementos essenciais foram encontrados
        if (!themeToggle || !loading || !tabs.length || !transactionModal || !btnNewTransaction) {
             console.error("Erro Crítico: Elementos essenciais da UI não encontrados!");
             showAlert("Erro ao carregar a interface. Recarregue a página.", "danger", 10000);
             hideLoading();
             return; // Impede a continuação da inicialização
        }


        try {
            setupTheme(); // Configura tema inicial
            // Adiciona listener do tema AGORA que o elemento existe
            themeToggle.addEventListener('click', () => {
                const newTheme = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                root.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                updateCharts(); // Atualiza gráficos ao mudar tema
            });
            console.log("Tema configurado.");

            await waitForFirebase(); // Espera conexão Firebase

            // Carrega dados na ordem correta
            categories = await loadCategoriesFromFirestore();
            console.log(`${categories.length} categorias carregadas.`);
            transactions = await loadTransactionsFromFirestore();
            console.log(`${transactions.length} transações carregadas.`);
            budgets = await loadBudgetsFromFirestore();
            console.log(`${budgets.length} orçamentos carregados.`);
            goals = await loadGoalsFromFirestore();
            console.log(`${goals.length} metas carregadas.`);


            populateYearSelects();
            populateMonthSelects();
            console.log("Selects de data populados.");

            initFilters(); // Inicializa filtros e listeners DEPOIS de popular selects
            console.log("Filtros inicializados.");

            initModals(); // Inicializa modais e listeners DEPOIS de carregar dados (categorias)
            console.log("Modais inicializados.");

            await initCharts(); // Inicializa gráficos DEPOIS de carregar dados
            console.log("Gráficos inicializados.");

            initTabs(); // Inicializa tabs e ativa a primeira (overview), o que dispara updateDashboard
            console.log("Tabs inicializadas, ativando Visão Geral.");

            // Não precisa chamar updateDashboard() aqui explicitamente,
            // pois initTabs() clica na primeira tab, que por sua vez
            // chama updateDashboard() através do seu listener.

            console.log("Aplicação inicializada com sucesso!");

        } catch (error) {
            console.error("Erro crítico durante a inicialização:", error);
            showAlert(`Falha ao inicializar: ${error.message}`, "danger", 10000);
        } finally {
            hideLoading(); // Garante que o loading saia
        }
    }

    // Ponto de Entrada: Inicia quando o DOM está pronto
    document.addEventListener('DOMContentLoaded', init);

</script>
<!-- FIM DA SEÇÃO PARA SUBSTITUIR -->
