<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Familiar Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <style>
    /* ===== Variáveis e Temas (Estilo Apple/Google) ===== */
    :root {
      --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem; /* 12px */
      --radius: 1.125rem; /* 18px */
      --radius-lg: 1.5rem; /* 24px */
      --shadow: 0 4px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.09), 0 2px 6px rgba(0,0,0,0.07);
      --shadow-dropdown: 0 5px 20px rgba(0,0,0,0.12);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

      /* Cores Light */
      --bg: #F9F9FB; /* Slightly off-white */
      --card-bg: #FFFFFF;
      --input-bg: rgba(118, 118, 128, 0.12); /* System Gray 5 (0.12 alpha) */
      --text: #1C1C1E; /* Almost Black */
      --text-secondary: #8A8A8E; /* System Gray */
      --primary: #007AFF; /* Blue */
      --primary-light: #5856D6; /* Indigo for accents if needed */
      --success: #34C759; /* Green */
      --warning: #FF9500; /* Orange */
      --danger: #FF3B30; /* Red */
      --info: #5AC8FA; /* Teal */
      --border: rgba(60, 60, 67, 0.20); /* Separator Light */
      --chart-grid: rgba(60, 60, 67, 0.10);
      --menu-bg: rgba(255, 255, 255, 0.85); /* Translucent */
      --insight-bg: rgba(0, 122, 255, 0.08); /* Light Blue BG */
      --importance-extrema: #FF3B30; /* Red */
      --importance-urgente: #FF9500; /* Orange */
      --importance-importante: #FFCC00; /* Yellow */
      --status-pending: #FF9500; /* Orange for pending */
      --status-scheduled: #5AC8FA; /* Teal for scheduled */
      --status-overdue: #FF3B30; /* Red for overdue */
    }

    [data-theme="dark"] {
      /* Cores Dark */
      --bg: #000000; /* True Black for OLED */
      --card-bg: #1C1C1E; /* Gray 6 */
      --input-bg: rgba(118, 118, 128, 0.24); /* System Gray 5 (0.24 alpha) */
      --text: #FFFFFF;
      --text-secondary: #8E8E93; /* Gray */
      --primary: #0A84FF; /* Blue */
      --primary-light: #5E5CE6; /* Indigo */
      --success: #30D158; /* Green */
      --warning: #FF9F0A; /* Orange */
      --danger: #FF453A; /* Red */
      --info: #64D2FF; /* Teal */
      --border: rgba(84, 84, 88, 0.4); /* Separator Dark */
      --chart-grid: rgba(84, 84, 88, 0.2);
      --menu-bg: rgba(28, 28, 30, 0.85); /* Translucent */
      --insight-bg: rgba(10, 132, 255, 0.15); /* Light Blue BG */
      --importance-extrema: #FF453A; /* Red */
      --importance-urgente: #FF9F0A; /* Orange */
      --importance-importante: #FFD60A; /* Yellow */
      --status-pending: #FF9F0A; /* Orange for pending */
      --status-scheduled: #64D2FF; /* Teal for scheduled */
      --status-overdue: #FF453A; /* Red for overdue */
    }

    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html, body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
      font-size: 16px;
      line-height: 1.5;
      width: 100%;
      overflow-x: hidden;
    }

    /* ===== Layout e Componentes ===== */
    .container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    h1 {
      font-size: 1.875rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.03em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .tabs::-webkit-scrollbar { display: none; }

    .tab {
      padding: 0.875rem 1.5rem;
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      margin-bottom: -1px;
    }

    .tab:hover {
      color: var(--text);
      background-color: var(--input-bg);
    }

    .tab.active {
      color: var(--primary);
      border-color: var(--primary);
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }


    /* KPIs Card */
     .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
      overflow: hidden;
      position: relative;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .kpi-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .kpi-title {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .kpi-icon {
        color: var(--text-secondary);
        opacity: 0.7;
    }

    .kpi-value {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 500;
    }

    .kpi-trend.up { color: var(--success); }
    .kpi-trend.down { color: var(--danger); }
    .kpi-trend.neutral { color: var(--text-secondary); }

    .kpi-trend svg {
      width: 0.875rem;
      height: 0.875rem;
      stroke-width: 2.5;
    }

    .progress-container {
      width: 100%;
      height: 0.5rem;
      background-color: var(--input-bg);
      border-radius: 1rem;
      overflow: hidden;
      margin-top: 0.25rem;
    }

    .progress-bar {
      height: 100%;
      border-radius: 1rem;
      transition: width 0.5s ease;
      background-color: var(--primary);
    }
    .progress-bar.success { background-color: var(--success); }
    .progress-bar.warning { background-color: var(--warning); }
    .progress-bar.danger { background-color: var(--danger); }


    /* Gráficos */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100%, 450px), 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

     .chart-container {
      position: relative;
      margin-top: 1rem;
      height: 280px;
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .chart-title-actions {
      display: flex;
      gap: 0.75rem;
    }

    .full-width {
      grid-column: 1 / -1;
    }
    .full-width .chart-container {
      height: 320px;
    }


    /* Análise Mensal */
    .analysis-header {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: stretch;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .filters {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }

    .filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: flex-end;
    }
     .filters-row .form-group {
        flex: 1 1 180px;
    }

    .category-filter-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .btn-icon-small {
        padding: 0.5rem; min-width: auto; height: auto; background: var(--input-bg); color: var(--text);
        border: none; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center;
        justify-content: center; transition: var(--transition);
    }
    .btn-icon-small:hover { background-color: rgba(142, 142, 147, 0.2); }
    .btn-icon-small svg { width: 1rem; height: 1rem; }
    .btn-delete-category { color: var(--danger); }

    .analysis-indicators {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;
    }
     .indicator-card { background-color: var(--card-bg); border-radius: var(--radius-sm); padding: 1.25rem; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: var(--transition); }
    .indicator-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.07); }
    .indicator-title { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .indicator-value { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.01em; line-height: 1.2; }
    .indicator-value.positive { color: var(--success); } .indicator-value.negative { color: var(--danger); } .indicator-value.neutral { color: var(--text); }
    .indicator-comparison { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem; }

    .analysis-content { display: grid; grid-template-columns: 1fr 320px; gap: 2rem; }
    /* Ajuste Layout Análise - Coloca Lista Acima */
    .analysis-main { display: flex; flex-direction: column-reverse; gap: 1.5rem; }
    .analysis-sidebar { display: flex; flex-direction: column; gap: 1.5rem; }

    .insights-feed { background: var(--card-bg); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); }
    .insights-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--primary); }
    .insights-list { display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem; }
    .insight-item { display: flex; gap: 0.75rem; padding: 0.75rem 1rem; background-color: var(--insight-bg); border-radius: var(--radius-sm); font-size: 0.875rem; align-items: flex-start; line-height: 1.4; }
    .insight-icon { flex-shrink: 0; margin-top: 2px; font-size: 1rem; }
    .insight-item.alert { color: var(--danger); background-color: rgba(255, 59, 48, 0.08); } .insight-item.warning { color: var(--warning); background-color: rgba(255, 149, 0, 0.08); } .insight-item.success { color: var(--success); background-color: rgba(52, 199, 89, 0.08); } .insight-item.info { color: var(--primary); background-color: rgba(0, 122, 255, 0.08); } .insight-item.neutral { color: var(--text-secondary); background-color: var(--input-bg); }

    /* Simple Transaction List (Análise Mensal) */
    .transaction-list-container {
        /* Estilos do container - Removido padding-top */
        padding: 0 1.5rem 1.5rem 1.5rem; max-width: 100%; overflow-x: hidden;
        /* Adicionado do .card para consistência visual */
        border: 1px solid var(--border); border-radius: var(--radius);
        background: var(--card-bg); box-shadow: var(--shadow);
        margin-bottom: 1.5rem; /* Espaçamento inferior */
    }
    .transaction-list-title {
        font-size: 1.125rem; font-weight: 600; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);
    }
    .transaction-list { max-height: 550px; overflow-y: auto; padding-right: 0.5rem; width: 100%; }
    .transaction-item { position: relative; padding: 1rem 0.5rem; display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: nowrap; border-bottom: 1px solid var(--border); transition: background-color 0.15s ease; cursor: pointer; }
    .transaction-item:last-child { border-bottom: none; }
    .transaction-item:hover { margin: 0; padding: 1rem 0.5rem; background-color: var(--input-bg); border-radius: var(--radius-sm); }
    .transaction-item-left { display: flex; align-items: center; gap: 1rem; min-width: 0; flex: 1; margin-right: 1rem; }
    .transaction-icon { flex-shrink: 0; width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: #fff; }
    .transaction-info { min-width: 0; flex: 1; display: flex; flex-direction: column; }
    .transaction-description, .transaction-category { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    .transaction-description { font-weight: 500; font-size: 0.9375rem; }
    .transaction-category { font-size: 0.8125rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; } /* Flex para alinhar status */
    .transaction-item-right { text-align: right; display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
    .transaction-dates-amount-wrapper { display: flex; flex-direction: column; align-items: flex-end; min-width: 110px; margin-right: 0.5rem; }
    .transaction-dates { display: flex; gap: 0.5rem; font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.15rem; flex-wrap: wrap; justify-content: flex-end; }
    /* Estilos para destacar datas de vencimento */
    .transaction-due-date.near-due { color: var(--status-pending); font-weight: 600; }
    .transaction-due-date.overdue { color: var(--status-overdue); font-weight: 600; }
    .transaction-amount { font-weight: 600; font-size: 0.9375rem; display: flex; align-items: center; }
    .transaction-amount.income { color: var(--success); } .transaction-amount.expense { color: var(--danger); }
    .transaction-importance { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 6px; vertical-align: middle; }
    .transaction-importance.extrema { background-color: var(--importance-extrema); } .transaction-importance.urgente { background-color: var(--importance-urgente); } .transaction-importance.importante { background-color: var(--importance-importante); }
    .btn-action { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: var(--transition); opacity: 0.5; display: flex; align-items: center; justify-content: center; line-height: 0; flex-shrink: 0; }
    .btn-action:hover { background-color: var(--input-bg); opacity: 1; }
    .btn-delete-transaction { color: var(--danger); } .btn-delete-transaction svg { width: 1rem; height: 1rem; }
    /* Estilos para status de pagamento */
    .transaction-status { display: inline-block; font-size: 0.75rem; padding: 0.125rem 0.375rem; border-radius: 1rem; /* margin-left: 0.5rem; */ background-color: var(--input-bg); }
    .transaction-status.status-paid { background-color: var(--success); color: white; }
    .transaction-status.status-pending { background-color: var(--status-pending); color: var(--text); }
    .transaction-status.status-scheduled { background-color: var(--status-scheduled); color: white; }
    .transaction-status.status-overdue { background-color: var(--status-overdue); color: white; } /* Status visual para vencidos */


    /* Botões */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.9375rem; cursor: pointer; transition: var(--transition); border: none; color: #fff; background-color: var(--primary); text-decoration: none; white-space: nowrap; }
    .btn:hover { opacity: 0.85; transform: translateY(-1px); } .btn:active { transform: translateY(0); opacity: 0.75; }
    .btn-primary { background-color: var(--primary); } .btn-success { background-color: var(--success); } .btn-warning { background-color: var(--warning); color: var(--text); } .btn-danger { background-color: var(--danger); } .btn-secondary { background-color: var(--input-bg); color: var(--text); border: 1px solid var(--border); } .btn-secondary:hover { background-color: rgba(142, 142, 147, 0.2); } .btn svg { width: 1rem; height: 1rem; }

    /* Botão toggle theme */
    .theme-toggle { background: var(--input-bg); border: none; border-radius: 50%; width: 2.75rem; height: 2.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); transition: var(--transition); }
    .theme-toggle:hover { background-color: rgba(142, 142, 147, 0.2); } .theme-toggle svg { width: 1.25rem; height: 1.25rem; }

    /* Select estilo Apple */
    select { appearance: none; -webkit-appearance: none; padding: 0.75rem 2.25rem 0.75rem 1rem; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238A8A8E' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E") no-repeat; background-position: right 0.875rem center; background-size: 10px 6px; color: var(--text); font-family: var(--font-sans); font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: var(--transition); min-width: 150px; }
    [data-theme="dark"] select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238E8E93' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E"); }
    select:hover { border-color: rgba(60, 60, 67, 0.4); } select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); } select option { background-color: var(--card-bg); color: var(--text); }

    /* Modal */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal.active { display: flex; opacity: 1; pointer-events: all; }
    .modal-content { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 90%; max-width: 550px; max-height: 90vh; /* Ajuste para Rolagem */ overflow: hidden; /* Ajuste para Rolagem */ display: flex; flex-direction: column; transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; opacity: 0; }
    .modal.active .modal-content { opacity: 1; transform: scale(1) translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
    .modal-close { background: var(--input-bg); border: none; width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: var(--transition); flex-shrink: 0; }
    .modal-close:hover { background-color: rgba(142, 142, 147, 0.3); color: var(--text); } .modal-close svg { width: 1rem; height: 1rem; }
    /* Ajuste CSS para Rolagem do Modal */
    .modal-body { padding: 1.75rem; overflow-y: auto !important; /* Força rolagem vertical */ max-height: calc(90vh - 140px); /* Altura Max: 90% Tela - Header - Footer (Ajustar valor se necessário)*/ flex-grow: 1; -webkit-overflow-scrolling: touch; }
    .modal-footer { padding: 1.25rem 1.75rem; display: flex; justify-content: flex-end; gap: 0.75rem; border-top: 1px solid var(--border); background-color: var(--bg); flex-shrink: 0; }

    /* Formulários dentro do Modal */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .form-grid.single-col { grid-template-columns: 1fr; } .form-group { margin-bottom: 1rem; display: flex; flex-direction: column; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
    .form-control { width: 100%; padding: 0.875rem 1rem; font-size: 0.9375rem; border-radius: var(--radius-sm); border: 1px solid var(--border); background-color: var(--input-bg); color: var(--text); transition: var(--transition); font-family: var(--font-sans); }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--card-bg); }
    textarea.form-control { line-height: 1.4; min-height: 80px; }

    /* Transaction Modal Specifics */
    #transaction-modal .modal-content { max-width: 500px; }
    .input-group { display: flex; align-items: center; } .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; } .input-group-append { border: 1px solid var(--border); border-left: none; background-color: var(--input-bg); padding: 0 0.75rem; height: calc(1.5em + 1.75rem + 2px); display: flex; align-items: center; border-top-right-radius: var(--radius-sm); border-bottom-right-radius: var(--radius-sm); } .input-group-append button { margin-left: 0.5rem; }

    /* Campos avançados agora sempre visíveis */
     #advanced-fields { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border); display: block; }
    .btn-link#btn-toggle-advanced { display: none; } /* Esconde o botão de toggle */

    /* Importance Radio Buttons */
    .importance-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; } .importance-group input[type="radio"] { opacity: 0; position: fixed; width: 0; } .importance-group label { display: inline-block; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); font-size: 0.875rem; font-weight: 500; } .importance-group input[type="radio"]:checked + label { background-color: var(--primary); color: #fff; border-color: var(--primary); } .importance-group input[type="radio"]:focus + label { box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); } .importance-group label[for="importance-extrema"] { border-left: 4px solid var(--importance-extrema); padding-left: calc(1rem - 4px); } .importance-group label[for="importance-urgente"] { border-left: 4px solid var(--importance-urgente); padding-left: calc(1rem - 4px); } .importance-group label[for="importance-importante"] { border-left: 4px solid var(--importance-importante); padding-left: calc(1rem - 4px); } .importance-group input[type="radio"]:checked + label[for="importance-extrema"] { background-color: var(--importance-extrema); border-color: var(--importance-extrema); } .importance-group input[type="radio"]:checked + label[for="importance-urgente"] { background-color: var(--importance-urgente); border-color: var(--importance-urgente); color: #fff;} .importance-group input[type="radio"]:checked + label[for="importance-importante"] { background-color: var(--importance-importante); border-color: var(--importance-importante); color: var(--text); }

    /* Category Modal Specifics */ #category-modal .modal-content { max-width: 400px; }
    /* Confirm Modal Specifics */ #confirm-modal .modal-content { max-width: 400px; } #confirm-modal-message { margin-bottom: 1rem; line-height: 1.4; }

    /* Loading Estado */
    .loading-indicator { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .loading-indicator.active { display: flex; opacity: 1; pointer-events: all; } .spinner { width: 2.5rem; height: 2.5rem; border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s ease-in-out infinite; } [data-theme="dark"] .spinner { border-color: rgba(255, 255, 255, 0.2); border-top-color: #fff; } @keyframes spin { to { transform: rotate(360deg); } }

    /* Alertas / Toast Notifications */
    .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; } .toast { background-color: var(--card-bg); color: var(--text); padding: 0.875rem 1.25rem; border-radius: var(--radius-sm); box-shadow: var(--shadow-dropdown); display: flex; align-items: center; gap: 0.75rem; min-width: 250px; max-width: 400px; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000); border-left: 4px solid var(--primary); pointer-events: none; } .toast.show { opacity: 1; transform: translateX(0); pointer-events: all; } .toast-icon { font-size: 1.25rem; flex-shrink: 0; } .toast.success { border-left-color: var(--success); } .toast.warning { border-left-color: var(--warning); } .toast.danger { border-left-color: var(--danger); } .toast.info { border-left-color: var(--primary); }

    /* Responsividade (Ajustes finais) */
    @media (max-width: 1200px) { .analysis-content { grid-template-columns: 1fr; } .analysis-sidebar { grid-row: 2; } }
    @media (max-width: 992px) { .container { padding: 1.5rem; } .header { flex-direction: column; align-items: flex-start; } .header-right { width: 100%; justify-content: space-between; } .charts-grid { grid-template-columns: 1fr; } .chart-container { height: 260px; } .full-width .chart-container { height: 300px; } .filters-row { flex-direction: column; align-items: stretch; } .filters-row .form-group { width: 100%; flex-basis: auto; } }
    @media (max-width: 768px) { h1 { font-size: 1.625rem; } .kpis { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .analysis-indicators { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } .btn { padding: 0.625rem 1.25rem; font-size: 0.875rem; } select { padding: 0.625rem 2rem 0.625rem 0.875rem; font-size: 0.875rem; } .form-grid { grid-template-columns: 1fr; } .transaction-item { flex-direction: column; align-items: stretch; gap: 0.5rem; } .transaction-item-left { margin-right: 0; width: 100%; justify-content: flex-start; } .transaction-item-right { flex-direction: row; justify-content: space-between; align-items: center; text-align: left; margin-top: 0; width: 100%; } .transaction-dates-amount-wrapper { align-items: flex-start; } .modal-content { width: 95%; } .modal-body, .modal-header, .modal-footer { padding: 1.25rem; } .tabs { margin-bottom: 1.5rem; } .tab { padding: 0.75rem 1rem; font-size: 0.875rem; } .analysis-content { grid-template-columns: 1fr; } .analysis-main, .analysis-sidebar { grid-column: 1 / -1; } .analysis-header { gap: 1rem; } }
    @media (max-width: 576px) { .container { padding: 1rem; } h1 { font-size: 1.5rem; } .kpis { grid-template-columns: 1fr; } .analysis-indicators { grid-template-columns: 1fr; } .header-right { flex-direction: column; align-items: stretch; gap: 0.75rem; } .filters-row { gap: 0.75rem; } .header-right .btn { width: 100%; } .theme-toggle { align-self: flex-end; } .toast-container { right: 1rem; bottom: 1rem; left: 1rem; align-items: stretch; } .toast { width: 100%; max-width: 100%; } .transaction-item-right { flex-wrap: wrap; gap: 0.25rem;} .transaction-dates-amount-wrapper { margin-right: auto; } .btn-delete-transaction { padding: 0.3rem; } }

    /* Print styles (Revisado) */
    @media print { body { background-color: #fff; color: #000; } .header, .tabs, .theme-toggle, .btn, .modal, .loading-indicator, .toast-container, .analysis-sidebar, .analysis-header .filters button, .btn-delete-transaction { display: none !important; } .container { max-width: 100%; padding: 0; } .card, .kpi-card, .indicator-card, .transaction-list-container, .insights-feed, .analysis-header { box-shadow: none; border: 1px solid #ddd; border-radius: 0; padding: 1rem; page-break-inside: avoid; background-color: #fff !important; } .analysis-header { border-bottom: 1px solid #ddd; } .kpis, .charts-grid, .analysis-indicators, .analysis-content, .analysis-main { grid-template-columns: 1fr !important; gap: 1rem; } .analysis-content { display: block; } .analysis-main { margin-bottom: 1rem; flex-direction: column; /* Mantem ordem normal no print */ } .analysis-header .filters { display: block; } .analysis-header .filters-row { display: block; margin-bottom: 0.5rem; } .analysis-header .form-group label { display: inline; margin-right: 0.5rem; } .analysis-header select { border: none; appearance: none; -webkit-appearance: none; padding-right: 1rem; background: none; font-weight: bold; display: inline; } canvas { max-width: 100%; } .transaction-item { border-bottom: 1px solid #eee; flex-direction: row; align-items: center;} .transaction-item-left { width: auto; margin-right: 1rem;} .transaction-item-right { width: auto; flex-direction: row; align-items: center; text-align: right;} .transaction-item:hover { background-color: transparent; margin: 0; padding: 1rem 0; border-radius: 0; } :root { --text: #000; --text-secondary: #555; --success: #008000; --danger: #D00000; --primary: #0000FF; --warning: #FFA500; } .indicator-value.positive, .kpi-trend.up, .transaction-amount.income { color: var(--success) !important; } .indicator-value.negative, .kpi-trend.down, .transaction-amount.expense { color: var(--danger) !important; } .progress-bar { background-color: #ccc !important; } }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title"><h1>Calculadora Financeira</h1></div>
      <div class="header-right">
        <button class="btn btn-primary" id="btn-new-transaction"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>Nova Transação</button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema"><svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg></button>
      </div>
    </div>

    <!-- Tabs de Navegação -->
    <div class="tabs"><div class="tab active" data-tab="overview">Visão Geral</div><div class="tab" data-tab="analysis">Análise Mensal</div></div>

    <!-- Conteúdo das Tabs -->
    <div id="tab-contents">
        <!-- Aba Visão Geral -->
        <div class="tab-content active" id="tab-overview">
            <!-- KPIs -->
            <div class="kpis">
                <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Saldo Atual</div><svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM1 8a7 7 0 1 1 14 0A7 7 0 0 1 1 8z"/><path d="M8 4a.5.5 0 0 1 .5.5v3.793l2.146 2.147a.5.5 0 0 1-.708.708l-2.5-2.5A.5.5 0 0 1 7.5 8V4.5A.5.5 0 0 1 8 4z"/></svg></div><div class="kpi-value" id="kpi-balance">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="balance-trend-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/></svg><span id="balance-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Receitas (Mês)</div><svg class="kpi-icon" style="color: var(--success);" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg></div><div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="income-trend-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/></svg><span id="income-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Despesas (Mês)</div><svg class="kpi-icon" style="color: var(--danger);" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/></svg></div><div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="expenses-trend-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/></svg><span id="expenses-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Economia do Mês</div><svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg></div><div class="kpi-value" id="kpi-savings">R$ 0,00</div><div class="kpi-footer"><span id="savings-status">Calculando...</span></div><div class="progress-container"><div class="progress-bar" id="savings-progress" style="width: 0%"></div></div></div>
                <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Projeção de Gastos (Mês)</div><svg class="kpi-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg></div><div class="kpi-value" id="kpi-projection">R$ 0,00</div><div class="kpi-footer"><span id="projection-status">--</span></div></div>
            </div>
            <!-- Gráficos de Visão Geral -->
            <div class="charts-grid">
                <div class="card"><div class="chart-title"><span>Receitas vs Despesas (Últimos 12 Meses)</span></div><div class="chart-container"><canvas id="overview-income-expense-chart"></canvas></div></div>
                <div class="card"><div class="chart-title"><span>Despesas por Categoria (Últimos 30 dias)</span></div><div class="chart-container"><canvas id="overview-category-chart"></canvas></div></div>
                <div class="card full-width"><div class="chart-title"><span>Fluxo de Caixa Mensal (Ano Atual)</span></div><div class="chart-container"><canvas id="overview-cashflow-chart"></canvas></div></div>
                <div class="card"><div class="chart-title"><span>Fixas vs Variáveis (Mês Atual)</span></div><div class="chart-container"><canvas id="overview-fixed-variable-chart"></canvas></div></div>
                <div class="card"><div class="chart-title"><span>Tendência Geral de Gastos (Últimos 6 Meses)</span></div><div class="chart-container"><canvas id="overview-trend-chart"></canvas></div></div>
            </div>
        </div>

        <!-- Aba Análise Mensal -->
        <div class="tab-content" id="tab-analysis">
            <!-- Filtros Inteligentes -->
            <div class="analysis-header">
                 <div class="filters">
                    <div class="filters-row">
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-year" style="margin-bottom: 0.25rem;">Ano</label><select id="analysis-year"></select></div>
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-month" style="margin-bottom: 0.25rem;">Mês</label><select id="analysis-month"></select></div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="analysis-category" style="margin-bottom: 0.25rem;">Filtrar Categoria</label>
                            <div class="category-filter-group">
                                <select id="analysis-category"><option value="all">Todas as Categorias</option></select>
                                <button class="btn-icon-small" id="btn-add-category" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                                <button class="btn-icon-small btn-delete-category" id="btn-delete-category" title="Excluir Categoria Selecionada" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                            </div>
                        </div>
                    </div>
                    <div class="filters-row">
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-type" style="margin-bottom: 0.25rem;">Tipo de Transação</label><select id="analysis-type"><option value="all">Todas</option><option value="income">Receitas</option><option value="expense">Despesas</option></select></div>
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-status" style="margin-bottom: 0.25rem;">Status</label><select id="analysis-status"><option value="all">Todos</option><option value="paid">Pago</option><option value="pending">Pendente</option><option value="scheduled">Agendado</option></select></div>
                        <div class="form-group" style="margin-bottom: 0;"><label for="analysis-importance" style="margin-bottom: 0.25rem;">Importância</label><select id="analysis-importance"><option value="all">Todas</option><option value="extrema">Extrema</option><option value="urgente">Urgente</option><option value="importante">Importante</option><option value="none">Sem importância</option></select></div>
                    </div>
                </div>
            </div>
            <!-- Fim Filtros Inteligentes -->

            <!-- Indicadores e Inteligência Mensal -->
            <div class="analysis-indicators">
                <div class="indicator-card"><div class="indicator-title">Receitas Totais</div><div class="indicator-value positive" id="analysis-total-income">R$ 0,00</div><div class="indicator-comparison" id="analysis-income-comparison">-- vs mês anterior</div></div>
                <div class="indicator-card"><div class="indicator-title">Despesas Totais</div><div class="indicator-value negative" id="analysis-total-expenses">R$ 0,00</div><div class="indicator-comparison" id="analysis-expense-comparison">-- vs mês anterior</div></div>
                <div class="indicator-card"><div class="indicator-title">Saldo Final</div><div class="indicator-value neutral" id="analysis-final-balance">R$ 0,00</div><div class="indicator-comparison" id="analysis-balance-comparison">-- vs mês anterior</div></div>
                <div class="indicator-card"><div class="indicator-title">Status do Mês</div><div class="indicator-value neutral" id="analysis-month-status">--</div><div class="indicator-comparison" id="analysis-days-left">-- dias restantes</div></div>
                <div class="indicator-card"><div class="indicator-title">Maior Gasto</div><div class="indicator-value neutral" id="analysis-top-category">--</div><div class="indicator-comparison" id="analysis-top-category-value">R$ 0,00</div></div>
            </div>

             <!-- Conteúdo Principal e Sidebar -->
            <div class="analysis-content">
                <!-- Conteúdo Principal (Lista e Gráficos - Ordem invertida com CSS) -->
                <div class="analysis-main">
                     <!-- Lista Simples de Transações -->
                     <div class="transaction-list-container">
                         <div class="transaction-list-title">Transações do Mês (Ordenado por Vencimento)</div>
                         <div id="analysis-transaction-list" class="transaction-list">
                             <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary); display: none;" id="analysis-no-transactions">Nenhuma transação encontrada para os filtros selecionados.</div>
                         </div>
                     </div>
                     <!-- Gráficos da Análise Mensal -->
                    <div class="charts-grid">
                        <div class="card"><div class="chart-title">Distribuição de Despesas</div><div class="chart-container"><canvas id="analysis-category-pie-chart"></canvas></div></div>
                        <div class="card"><div class="chart-title">Evolução do Saldo no Mês</div><div class="chart-container"><canvas id="analysis-balance-line-chart"></canvas></div></div>
                    </div>
                </div>
                <!-- Sidebar (Insights) -->
                <aside class="analysis-sidebar">
                    <div class="insights-feed card">
                        <div class="insights-title"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8a8 8 0 1 1-16 0 8 8 0 0 1 16 0zM8 4.002a.5.5 0 0 0-.495.57l.5 4a.5.5 0 0 0 .99 0l.5-4A.5.5 0 0 0 8 4.002zm-.002 7a.5.5 0 1 0 0 1 .5.5 0 0 0 0-1z"/></svg>Insights Rápidos</div>
                        <div class="insights-list" id="analysis-insights-list">
                            <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);" id="analysis-no-insights">Analisando seus dados...</div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div> <!-- Fim #tab-contents -->
  </div> <!-- Fim .container -->

  <!-- Modal de Nova Transação -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
        <form id="transaction-form">
            <input type="hidden" id="transaction-id">
            <input type="hidden" id="transaction-recurring-base-id">
            <div class="modal-header"><h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div>
            <div class="modal-body">
                 <div class="form-group"><label for="transaction-description">Descrição</label><input type="text" class="form-control" id="transaction-description" placeholder="Ex: Supermercado da semana, Salário..." required></div>
                 <div class="form-grid"><div class="form-group"><label for="transaction-amount">Valor (R$)</label><input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required></div><div class="form-group"><label for="transaction-type">Tipo</label><select class="form-control" id="transaction-type" required><option value="expense" selected>Despesa</option><option value="income">Receita</option></select></div></div>
                <div class="form-group"><label for="transaction-category">Categoria</label><div class="input-group"><select class="form-control" id="transaction-category" required></select><div class="input-group-append"><button type="button" class="btn-icon-small" id="btn-add-category-modal" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button></div></div></div>
                 <div class="form-grid"><div class="form-group"><label for="transaction-date">Data <small>(Pagamento/Recebimento)</small></label><input type="date" class="form-control" id="transaction-date" required></div><div class="form-group"><label for="transaction-due-date">Data Vencimento <small>(Opcional)</small></label><input type="date" class="form-control" id="transaction-due-date"></div></div>
                 <div class="form-group"><label>Importância</label><div class="importance-group"><input type="radio" id="importance-extrema" name="transaction-importance" value="extrema"><label for="importance-extrema">Extrema</label><input type="radio" id="importance-urgente" name="transaction-importance" value="urgente"><label for="importance-urgente">Urgente</label><input type="radio" id="importance-importante" name="transaction-importance" value="importante"><label for="importance-importante">Importante</label></div></div>
                <!-- Botão toggle removido com CSS -->
                <button type="button" class="btn-link" id="btn-toggle-advanced" style="margin-top: 1rem; display: none;"><!-- Conteúdo oculto --></button>
                <!-- Campos que eram avançados, agora sempre visíveis -->
                <div id="advanced-fields">
                     <div class="form-grid"><div class="form-group"><label for="transaction-status">Status</label><select class="form-control" id="transaction-status" required><option value="paid" selected>Pago</option><option value="pending">Pendente</option><option value="scheduled">Agendado</option></select></div><div class="form-group"><label for="transaction-payment-method">Forma de Pagamento</label><select class="form-control" id="transaction-payment-method"><option value="">Nenhuma</option><option value="cash">Dinheiro</option><option value="credit_card">Cartão de Crédito</option><option value="debit_card">Cartão de Débito</option><option value="bank_transfer">Transferência</option><option value="pix">PIX</option><option value="boleto">Boleto</option><option value="other">Outro</option></select></div></div>
                    <div class="form-group"><label for="transaction-notes">Observações</label><textarea class="form-control" id="transaction-notes" rows="3" placeholder="Ex: Parcela 2/12, Referente ao projeto X..."></textarea></div>
                    <div id="recurring-transaction-container"><div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;"><input type="checkbox" id="transaction-recurring" style="width: auto; height: auto; transform: scale(1.2);"><label for="transaction-recurring" style="margin-bottom: 0; font-weight: 500;">É uma transação recorrente?</label></div><div id="recurring-options" style="display: none;"><div class="form-grid"><div class="form-group"><label for="transaction-frequency">Frequência</label><select class="form-control" id="transaction-frequency"><option value="daily">Diária</option><option value="weekly">Semanal</option><option value="biweekly">Quinzenal</option><option value="monthly" selected>Mensal</option><option value="bimonthly">Bimestral</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="annual">Anual</option></select></div><div class="form-group"><label for="transaction-installments">Número de Parcelas</label><input type="number" min="2" step="1" class="form-control" id="transaction-installments" placeholder="Ex: 12"><small style="color: var(--text-secondary); font-size: 0.75rem;">Deixe em branco se for contínuo.</small></div></div><div id="edit-recurring-options" style="margin-top:1rem; padding: 1rem; background-color: var(--input-bg); border-radius: var(--radius-sm); display: none;"><p style="font-weight: 500; margin-bottom: 0.5rem;">Editando transação recorrente:</p><div style="display: flex; flex-direction: column; gap: 0.5rem;"><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="this" checked> Aplicar somente a esta</label><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="future"> Aplicar a esta e futuras</label></div></div></div></div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="transaction-modal-save">Salvar Transação</button></div>
        </form>
    </div>
</div>

  <!-- Modal de Nova Categoria -->
  <div class="modal" id="category-modal"> <div class="modal-content"> <form id="category-form"><div class="modal-header"><h3 class="modal-title" id="category-modal-title">Nova Categoria</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div><div class="modal-body"><div class="form-group"><label for="category-name">Nome da Nova Categoria</label><input type="text" class="form-control" id="category-name" placeholder="Ex: Assinaturas, Educação Filhos" required></div><div class="form-group"><label for="category-type">Tipo de Categoria</label><select class="form-control" id="category-type" required><option value="expense" selected>Despesa</option><option value="income">Receita</option></select></div><div class="form-group"><label for="category-icon">Ícone (Emoji)</label><input type="text" class="form-control" id="category-icon" placeholder="Ex: 🎓, 💻" maxlength="2"></div><div class="form-group"><label for="category-color">Cor</label><input type="color" class="form-control" id="category-color" value="#8A8A8E"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="category-modal-save">Salvar Categoria</button></div></form> </div> </div>
  <!-- Modal de Confirmação -->
  <div class="modal" id="confirm-modal"> <div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="confirm-modal-title">Confirmação</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div><div class="modal-body"><p id="confirm-modal-message">Tem certeza?</p><div id="confirm-modal-extra-info" style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button></div></div> </div>
  <!-- Loading Indicator --> <div class="loading-indicator" id="loading"><div class="spinner"></div></div> <!-- Toast Notification Container --> <div class="toast-container" id="toast-container"></div>

  <script>
    // ===== Configurações Globais e Firebase =====
    const root = document.documentElement; const loading = document.getElementById('loading'); moment.locale('pt-br');
    const firebaseConfig = { apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY", authDomain: "calculadora-da-familia.firebaseapp.com", projectId: "calculadora-da-familia", storageBucket: "calculadora-da-familia.appspot.com", messagingSenderId: "69721783786", appId: "1:69721783786:web:c4703b5c182e3681e8c693", measurementId: "G-YM5TR661S6" };
    let app; let db; try { if (!firebase.apps.length) { app = firebase.initializeApp(firebaseConfig); } else { app = firebase.app(); } db = firebase.firestore(); console.log("Firebase inicializado."); } catch (error) { console.error("Erro Firebase:", error); showToast("Erro crítico DB.", "danger", 10000); db = null; }
    const transactionsCollection = db ? db.collection('transactions') : null; const categoriesCollection = db ? db.collection('categories') : null;
    // ===== Estados =====
    let transactions = []; let categories = []; let currentTab = 'overview'; let currentAnalysisMonthYear = moment().format('YYYY-MM'); let currentAnalysisCategory = 'all'; let currentAnalysisType = 'all'; let currentAnalysisImportance = 'all'; let currentAnalysisStatus = 'all'; let unsubscribeTransactions = null; let unsubscribeCategories = null; let overviewCharts = {}; let analysisCharts = {};
    // ===== Constantes e Mapas =====
    const TRANSACTION_TYPES = { income: { name: 'Receita', icon: '💰', colorClass: 'positive' }, expense: { name: 'Despesa', icon: '💸', colorClass: 'negative' }};
    const PAYMENT_METHODS = { 'cash': 'Dinheiro', 'credit_card': 'Cartão de Crédito', 'debit_card': 'Cartão de Débito', 'bank_transfer': 'Transferência', 'pix': 'PIX', 'boleto': 'Boleto', 'other': 'Outro' };
    const TRANSACTION_STATUS = { 'paid': { name: 'Pago', class: 'status-paid', color: 'var(--success)'}, 'pending': { name: 'Pendente', class: 'status-pending', color: 'var(--status-pending)'}, 'scheduled': { name: 'Agendado', class: 'status-scheduled', color: 'var(--status-scheduled)'} };
    const RECURRENCE_FREQUENCY = { 'daily': { name: 'Diária', momentUnit: 'days', momentStep: 1 }, 'weekly': { name: 'Semanal', momentUnit: 'weeks', momentStep: 1 }, 'biweekly': { name: 'Quinzenal', momentUnit: 'weeks', momentStep: 2 }, 'monthly': { name: 'Mensal', momentUnit: 'months', momentStep: 1 }, 'bimonthly': { name: 'Bimestral', momentUnit: 'months', momentStep: 2 }, 'quarterly': { name: 'Trimestral', momentUnit: 'months', momentStep: 3 }, 'semiannual': { name: 'Semestral', momentUnit: 'months', momentStep: 6 }, 'annual': { name: 'Anual', momentUnit: 'years', momentStep: 1 }};
    const DEFAULT_EXPENSE_CATEGORIES = [ { id: 'moradia', name: 'Moradia', type: 'expense', color: '#FF9500', icon: '🏠', isDefault: true }, { id: 'alimentacao', name: 'Alimentação', type: 'expense', color: '#34C759', icon: '🍔', isDefault: true }, { id: 'transporte', name: 'Transporte', type: 'expense', color: '#007AFF', icon: '🚗', isDefault: true }, { id: 'contas', name: 'Contas Fixas', type: 'expense', color: '#5AC8FA', icon: '💡', isDefault: true }, { id: 'lazer', name: 'Lazer', type: 'expense', color: '#AF52DE', icon: '🎮', isDefault: true }, { id: 'saude', name: 'Saúde', type: 'expense', color: '#FF3B30', icon: '🏥', isDefault: true }, { id: 'compras', name: 'Compras', type: 'expense', color: '#FFCC00', icon: '🛍️', isDefault: true }, { id: 'educacao', name: 'Educação', type: 'expense', color: '#5856D6', icon: '📚', isDefault: true }, { id: 'outros_despesas', name: 'Outras Despesas', type: 'expense', color: '#8E8E93', icon: '📋', isDefault: true }];
    const DEFAULT_INCOME_CATEGORIES = [ { id: 'salario', name: 'Salário', type: 'income', color: '#34C759', icon: '💰', isDefault: true }, { id: 'freelance', name: 'Freelance/Extra', type: 'income', color: '#007AFF', icon: '💼', isDefault: true }, { id: 'investimentos', name: 'Investimentos', type: 'income', color: '#AF52DE', icon: '📈', isDefault: true }, { id: 'outros_receitas', name: 'Outras Receitas', type: 'income', color: '#8E8E93', icon: '💸', isDefault: true }];

    // ===== Utilitários =====
    const formatCurrency = (v) => (typeof v!=='number'||isNaN(v))?'R$ 0,00':v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const formatDate = (d) => d?moment(d).format('DD/MM'):'--';
    const formatFullDate = (d) => d?moment(d).format('DD/MM/YYYY'):'--';
    const formatDateForInput = (d=new Date()) => moment(d).format('YYYY-MM-DD');
    const showLoading = () => loading.classList.add('active'); const hideLoading = () => loading.classList.remove('active');
    function showToast(msg,type='info',dur=3000){const c=document.getElementById('toast-container');if(!c)return;const id=`toast-${Date.now()}`;const t=document.createElement('div');t.className=`toast ${type}`;t.id=id;let i='ℹ️';if(type==='success')i='✅';if(type==='warning')i='⚠️';if(type==='danger')i='❌';t.innerHTML=`<span class="toast-icon">${i}</span><span class="toast-message">${msg}</span>`;c.appendChild(t);setTimeout(()=>t.classList.add('show'),10);const tid=setTimeout(()=>{t.classList.remove('show');const rm=()=>{if(t.parentNode){t.removeEventListener('transitionend',rm);t.parentNode.removeChild(t);}clearTimeout(fid);};const fid=setTimeout(rm,500);t.addEventListener('transitionend',rm);},dur);}
    function updateThemeIcon(theme){const i=document.getElementById('theme-icon');if(!i)return;if(theme==='dark'){i.innerHTML=`<path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.708l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707z"/>`;}else{i.innerHTML=`<path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>`;}}
    function setupTheme(){const s=localStorage.getItem('theme');const p=window.matchMedia('(prefers-color-scheme: dark)').matches;const t=s||(p?'dark':'light');root.setAttribute('data-theme',t);updateThemeIcon(t);}
    function toggleTheme(){const c=root.getAttribute('data-theme');const n=c==='light'?'dark':'light';root.setAttribute('data-theme',n);localStorage.setItem('theme',n);updateThemeIcon(n);updateAllChartsTheme();}

    // ===== Gerenciamento de Dados (Firestore) =====
    async function loadCategories(){if(!categoriesCollection){console.error("DB Categorias indisponível.");showToast("Erro: DB categorias.","danger");categories=[...DEFAULT_INCOME_CATEGORIES,...DEFAULT_EXPENSE_CATEGORIES].sort((a,b)=>a.name.localeCompare(b.name));populateCategoryFilters();return;}return new Promise(async(res,rej)=>{try{const s=await categoriesCollection.get();let l=s.docs.map(d=>({id:d.id,...d.data()}));if(l.length===0&&db){console.log("Adicionando categorias padrão...");const b=db.batch();const d=[...DEFAULT_INCOME_CATEGORIES,...DEFAULT_EXPENSE_CATEGORIES];d.forEach(c=>{const r=categoriesCollection.doc(c.id);b.set(r,c);});await b.commit();console.log("Categorias padrão adicionadas.");l=d;}categories=l.sort((a,b)=>a.name.localeCompare(b.name));populateCategoryFilters();res();}catch(e){console.error("Erro load/add categorias:",e);showToast("Erro load categorias.","danger");categories=[...DEFAULT_INCOME_CATEGORIES,...DEFAULT_EXPENSE_CATEGORIES].sort((a,b)=>a.name.localeCompare(b.name));populateCategoryFilters();rej(e);}});}
    async function addCategory(n,t,i,c){if(!categoriesCollection){showToast("Erro: DB categorias.","danger");return false;}showLoading();try{const cat={name:n.trim(),type:t,icon:i||(t==='income'?'💰':'💸'),color:c||'#8E8E93',isDefault:false};const d=await categoriesCollection.add(cat);console.log("Categoria adicionada:",d.id);showToast("Categoria salva!","success");return true;}catch(e){console.error("Erro add categoria:",e);showToast("Erro salvar categoria.","danger");return false;}finally{hideLoading();}}
    async function deleteCategory(id){if(!categoriesCollection||!transactionsCollection){showToast("Erro: DB.","danger");return false;}showLoading();try{const c=categories.find(c=>c.id===id);if(c?.isDefault){showToast("Não pode excluir padrão.","warning");hideLoading();return false;}const q=await transactionsCollection.where('category','==',id).limit(1).get();if(!q.empty){showToast("Existem transações nesta categoria.","warning",5000);hideLoading();return false;}await categoriesCollection.doc(id).delete();console.log("Categoria excluída:",id);showToast("Categoria excluída!","success");return true;}catch(e){console.error("Erro del categoria:",e);showToast("Erro excluir categoria.","danger");return false;}finally{hideLoading();}}
    function processTransactionSnapshot(s){transactions=s.docs.map(d=>({id:d.id,...d.data()}));transactions.sort((a,b)=>{const dA=a.date?moment(a.date):moment(0);const dB=b.date?moment(b.date):moment(0);return dB.diff(dA);});console.log(`Trans. atualizadas: ${transactions.length}`);updateDashboard();}
    function processCategorySnapshot(s){let l=s.docs.map(d=>({id:d.id,...d.data()}));categories=l.sort((a,b)=>a.name.localeCompare(b.name));console.log(`Cat. atualizadas: ${categories.length}`);populateCategoryFilters();if(currentTab==='analysis'){updateMonthlyAnalysis();}updateOverviewCharts();}
    function setupFirestoreListeners(){if(unsubscribeTransactions){unsubscribeTransactions();unsubscribeTransactions=null;}if(unsubscribeCategories){unsubscribeCategories();unsubscribeCategories=null;}if(transactionsCollection){unsubscribeTransactions=transactionsCollection.onSnapshot(processTransactionSnapshot,(e)=>{console.error("Erro listener trans.:",e);showToast("Erro sync trans.","danger");transactions=[];updateDashboard();});}else{console.warn("Listener trans. não iniciado.");}if(categoriesCollection){unsubscribeCategories=categoriesCollection.onSnapshot(processCategorySnapshot,(e)=>{console.error("Erro listener cat.:",e);showToast("Erro sync cat.","danger");if(categories.length===0){categories=[...DEFAULT_INCOME_CATEGORIES,...DEFAULT_EXPENSE_CATEGORIES].sort((a,b)=>a.name.localeCompare(b.name));populateCategoryFilters();}});}else{console.warn("Listener cat. não iniciado.");}}
    function stopFirestoreListeners(){if(unsubscribeTransactions)unsubscribeTransactions();if(unsubscribeCategories)unsubscribeCategories();unsubscribeTransactions=null;unsubscribeCategories=null;console.log("Listeners Firestore desligados.");}

    // ===== Lógica de Transações =====
    function openTransactionModal(t=null){const m=document.getElementById('transaction-modal');const f=document.getElementById('transaction-form');if(!m||!f)return;f.reset();const title=document.getElementById('transaction-modal-title');const idInput=document.getElementById('transaction-id');const recOpts=document.getElementById('recurring-options');const editRecOpts=document.getElementById('edit-recurring-options');const recBaseId=document.getElementById('transaction-recurring-base-id');const advFields=document.getElementById('advanced-fields');const toggleAdvBtn=document.getElementById('btn-toggle-advanced');
    advFields.style.display='block'; advFields.classList.add('visible'); if(toggleAdvBtn)toggleAdvBtn.style.display='none'; // Garante campos visíveis e esconde botão
    recOpts.style.display='none';document.getElementById('transaction-recurring').checked=false;document.getElementById('transaction-installments').value='';recBaseId.value='';editRecOpts.style.display='none';
    document.getElementById('transaction-description').value='';document.getElementById('transaction-amount').value='';document.getElementById('transaction-date').value=formatDateForInput();document.getElementById('transaction-due-date').value='';document.getElementById('transaction-type').value='expense';document.getElementById('transaction-status').value='paid';document.getElementById('transaction-payment-method').value='';document.getElementById('transaction-notes').value='';populateCategorySelect('expense');
    document.querySelectorAll('input[name="transaction-importance"]').forEach(r=>r.checked=false);
    if(t){title.textContent='Editar Transação';idInput.value=t.id;document.getElementById('transaction-description').value=t.description||'';document.getElementById('transaction-amount').value=t.amount;document.getElementById('transaction-date').value=t.date||formatDateForInput();document.getElementById('transaction-due-date').value=t.dueDate||'';document.getElementById('transaction-type').value=t.type;populateCategorySelect(t.type);document.getElementById('transaction-category').value=t.category;document.getElementById('transaction-status').value=t.status||'paid';document.getElementById('transaction-payment-method').value=t.paymentMethod||'';document.getElementById('transaction-notes').value=t.notes||'';if(t.importance){const r=document.getElementById(`importance-${t.importance}`);if(r)r.checked=true;}
    const recChk=document.getElementById('transaction-recurring');const freqSel=document.getElementById('transaction-frequency');const instInp=document.getElementById('transaction-installments');
    if(t.recurringInfo&&t.recurringInfo.baseId){recBaseId.value=t.recurringInfo.baseId;recChk.checked=true;recOpts.style.display='block';freqSel.value=t.recurringInfo.frequency||'monthly';instInp.value=t.recurringInfo.totalInstallments||'';editRecOpts.style.display='block';const r=document.querySelector('input[name="edit-recurring-scope"][value="this"]');if(r)r.checked=true;}else{recBaseId.value='';recChk.checked=false;recOpts.style.display='none';freqSel.value='monthly';instInp.value='';editRecOpts.style.display='none';}
    }else{title.textContent='Nova Transação';idInput.value='';recBaseId.value='';editRecOpts.style.display='none';
    document.getElementById('transaction-description').value='';document.getElementById('transaction-amount').value='';document.getElementById('transaction-date').value=formatDateForInput();document.getElementById('transaction-due-date').value='';document.getElementById('transaction-type').value='expense';document.getElementById('transaction-status').value='paid';document.getElementById('transaction-payment-method').value='';document.getElementById('transaction-notes').value='';document.getElementById('transaction-recurring').checked=false;document.getElementById('recurring-options').style.display='none';document.getElementById('transaction-frequency').value='monthly';document.getElementById('transaction-installments').value='';}
    openModal(m);setTimeout(()=>{const i=document.getElementById('transaction-description');if(i)i.focus();},100);}

    async function saveTransaction(e){e.preventDefault();if(!transactionsCollection||!db){showToast("Erro: DB indisponível.","danger");return;}showLoading();
    const id=document.getElementById('transaction-id').value;const desc=document.getElementById('transaction-description').value.trim();const amtInp=document.getElementById('transaction-amount');const amt=parseFloat(amtInp.value);const type=document.getElementById('transaction-type').value;const cat=document.getElementById('transaction-category').value;const date=document.getElementById('transaction-date').value;const dueInp=document.getElementById('transaction-due-date');const dueDate=dueInp.value||null;const impRad=document.querySelector('input[name="transaction-importance"]:checked');const imp=impRad?impRad.value:null;const status=document.getElementById('transaction-status').value;const payM=document.getElementById('transaction-payment-method').value||null;const notes=document.getElementById('transaction-notes').value.trim();const isRec=document.getElementById('transaction-recurring').checked;const freq=document.getElementById('transaction-frequency').value;const instInp=document.getElementById('transaction-installments').value;const totalInst=instInp?parseInt(instInp):null;
    if(!desc){showToast("Descrição obrigatória.","warning");document.getElementById('transaction-description').focus();hideLoading();return;}if(isNaN(amt)||amt<=0){showToast("Valor inválido.","warning");amtInp.focus();hideLoading();return;}if(!cat){showToast("Selecione Categoria.","warning");document.getElementById('transaction-category').focus();hideLoading();return;}if(!date){showToast("Selecione Data.","warning");document.getElementById('transaction-date').focus();hideLoading();return;}if(isRec&&!freq){showToast("Selecione Frequência.","warning");document.getElementById('transaction-frequency').focus();hideLoading();return;}if(isRec&&totalInst!==null&&totalInst<2){showToast("Parcelas >= 2.","warning");document.getElementById('transaction-installments').focus();hideLoading();return;}if(isRec&&typeof uuid==='undefined'){showToast("Erro: UUID.","danger");hideLoading();return;}
    const baseData={description:desc,amount:amt,type:type,category:cat,date:date,dueDate:dueDate,importance:imp,status:status,paymentMethod:payM,notes:notes||null,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
    const isEdit=!!id;const recBaseId=document.getElementById('transaction-recurring-base-id').value;const isEditRec=isEdit&&!!recBaseId;
    try{if(isEditRec){const scopeRad=document.querySelector('input[name="edit-recurring-scope"]:checked');const scope=scopeRad?scopeRad.value:'this';if(scope==='this'){const ref=transactionsCollection.doc(id);const data={...baseData,recurringInfo:firebase.firestore.FieldValue.delete()};await ref.update(data);showToast("Ocorrência atualizada.","success");}else{const orig=transactions.find(t=>t.id===id);if(!orig||!orig.recurringInfo){throw new Error("Trans. recorrente original não encontrada.");}const batch=db.batch();const currNum=orig.recurringInfo.currentInstallment;const currRef=transactionsCollection.doc(id);let currData={...baseData};if(isRec){currData.recurringInfo={baseId:recBaseId,frequency:freq,currentInstallment:currNum,totalInstallments:totalInst};}else{currData.recurringInfo=firebase.firestore.FieldValue.delete();}batch.update(currRef,currData);const futQ=transactionsCollection.where('recurringInfo.baseId','==',recBaseId).where('recurringInfo.currentInstallment','>',currNum).orderBy('recurringInfo.currentInstallment','asc');const futS=await futQ.get();futS.docs.forEach(d=>{const futRef=d.ref;const futNum=d.data().recurringInfo?.currentInstallment;const futData={amount:baseData.amount,category:baseData.category,type:baseData.type,importance:baseData.importance,description:baseData.description?`${baseData.description} ${totalInst?`(${futNum}/${totalInst})`:''}`.trim():null,paymentMethod:baseData.paymentMethod,notes:baseData.notes,updatedAt:firebase.firestore.FieldValue.serverTimestamp(),dueDate:baseData.dueDate};if(isRec){futData.recurringInfo={baseId:recBaseId,frequency:freq,currentInstallment:futNum,totalInstallments:totalInst};}else{futData.recurringInfo=firebase.firestore.FieldValue.delete();}batch.update(futRef,futData);});await batch.commit();showToast("Esta e futuras atualizadas.","success");}}else if(isEdit&&!isRec){const data={...baseData,recurringInfo:firebase.firestore.FieldValue.delete(),};delete data.createdAt;await transactionsCollection.doc(id).update(data);showToast("Transação atualizada.","success");}else if(isEdit&&isRec){const bId=uuid.v4();const firstData={...baseData,recurringInfo:{baseId:bId,frequency:freq,currentInstallment:1,totalInstallments:totalInst},};delete firstData.createdAt;const batch=db.batch();batch.update(transactionsCollection.doc(id),firstData);await generateFutureInstallments(batch,baseData,bId,freq,totalInst,date,1);await batch.commit();showToast("Recorrência criada.","success");}else if(!isEdit&&isRec){const bId=uuid.v4();const firstData={...baseData,createdAt:firebase.firestore.FieldValue.serverTimestamp(),recurringInfo:{baseId:bId,frequency:freq,currentInstallment:1,totalInstallments:totalInst}};const batch=db.batch();const firstRef=transactionsCollection.doc();batch.set(firstRef,firstData);const dataFut={...baseData};delete dataFut.updatedAt;delete dataFut.createdAt;await generateFutureInstallments(batch,dataFut,bId,freq,totalInst,date,1);await batch.commit();showToast(`Recorrência salva.`,"success");}else{await transactionsCollection.add({...baseData,createdAt:firebase.firestore.FieldValue.serverTimestamp()});showToast("Transação adicionada.","success");}closeModal(document.getElementById('transaction-modal'));}catch(e){console.error("Erro salvar trans.:",e);showToast(`Erro salvar: ${e.message||'Erro desconhecido'}`,"danger",5000);}finally{hideLoading();}}
    async function generateFutureInstallments(batch,baseData,baseId,freq,totalInst,startDate,startNum){if(!transactionsCollection||!db)return;const freqInfo=RECURRENCE_FREQUENCY[freq];if(!freqInfo){console.error(`Freq. inválida: ${freq}`);return;}const limit=totalInst?totalInst:(startNum+24);const absMax=startNum+60;const finalLimit=Math.min(limit,absMax);console.log(`Gerando futuras: ${startNum+1} a ${finalLimit}`);let currTransDate=moment(startDate);let currDueDate=baseData.dueDate?moment(baseData.dueDate):null;for(let i=startNum+1;i<=finalLimit;i++){currTransDate=currTransDate.add(freqInfo.momentStep,freqInfo.momentUnit);if(currDueDate){currDueDate=currDueDate.add(freqInfo.momentStep,freqInfo.momentUnit);}const futDesc=baseData.description?`${baseData.description} ${totalInst?`(${i}/${totalInst})`:''}`.trim():`Parcela ${i}${totalInst?` de ${totalInst}`:''}`;const futData={...baseData,date:currTransDate.format('YYYY-MM-DD'),dueDate:currDueDate?currDueDate.format('YYYY-MM-DD'):null,status:'scheduled',description:futDesc,recurringInfo:{baseId:baseId,frequency:freq,currentInstallment:i,totalInstallments:totalInst},createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};delete futData.id;const futRef=transactionsCollection.doc();batch.set(futRef,futData);}console.log(`Geração futuras batch OK.`);}
    async function deleteTransaction(id,recBaseId=null,scope='this'){if(!transactionsCollection||!db){showToast("Erro: DB.","danger");return;}showLoading();try{if(recBaseId&&scope!=='this'){console.log(`Excluindo ${id} e futuras ${recBaseId}`);const batch=db.batch();const orig=transactions.find(t=>t.id===id);const currNum=orig?.recurringInfo?.currentInstallment;if(!orig||typeof currNum!=='number'){console.warn("Info recorrência não encontrada. Excluindo só selecionada.");await transactionsCollection.doc(id).delete();showToast("Trans. selecionada excluída.","warning");hideLoading();closeModalIfNeeded(document.getElementById('confirm-modal'));return;}batch.delete(transactionsCollection.doc(id));console.log(`Agendada exclusão ${id}`);console.log(`Buscando futuras >= ${currNum}`);const futQ=transactionsCollection.where('recurringInfo.baseId','==',recBaseId).where('recurringInfo.currentInstallment','>=',currNum);const futS=await futQ.get();console.log(`${futS.docs.length} encontradas.`);futS.docs.forEach(d=>{if(d.id!==id){console.log(`Agendada exclusão futura ${d.id}`);batch.delete(d.ref);}});await batch.commit();showToast("Esta e futuras excluídas.","success");}else{console.log(`Excluindo trans. única ${id}`);await transactionsCollection.doc(id).delete();showToast("Transação excluída.","success");}}catch(e){console.error("Erro del trans.:",e);showToast(`Erro excluir: ${e.message||'Erro'}`,"danger",5000);}finally{hideLoading();closeModalIfNeeded(document.getElementById('confirm-modal'));}}

    // ===== Interface e Interação =====
    function openModal(m){if(m)m.classList.add('active');} function closeModal(m){if(m)m.classList.remove('active');} function closeModalIfNeeded(m){if(m&&m.classList.contains('active'))closeModal(m);}
    function initTabs(){const l=document.querySelectorAll('.tab');const c=document.querySelectorAll('.tab-content');l.forEach(t=>{t.addEventListener('click',()=>{const id=t.dataset.tab;if(!id)return;l.forEach(t=>t.classList.remove('active'));c.forEach(c=>c.classList.remove('active'));t.classList.add('active');const tc=document.getElementById(`tab-${id}`);if(tc)tc.classList.add('active');currentTab=id;console.log(`Tab: ${currentTab}`);if(id==='analysis'){if(categories.length===0&&db){console.warn("Análise sem categorias.");loadCategories().then(updateMonthlyAnalysis).catch(console.error);}else{updateMonthlyAnalysis();}}else if(id==='overview'){updateOverviewCharts();updateKPIs();}});});}
    function populateCategoryFilters(){const anSel=document.getElementById('analysis-category');const trSel=document.getElementById('transaction-category');if(!anSel||!trSel){console.warn("Selects categoria não encontrados.");return;}const selAnCat=anSel?anSel.value:'all';anSel.innerHTML='<option value="all">Todas as Categorias</option>';trSel.innerHTML='';categories.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`${c.icon||''} ${c.name||'S/ Nome'}`;anSel.appendChild(o.cloneNode(true));});const currTrType=document.getElementById('transaction-type')?.value||'expense';populateCategorySelect(currTrType);if(anSel.querySelector(`option[value="${selAnCat}"]`)){anSel.value=selAnCat;}else{anSel.value='all';}toggleDeleteCategoryButton();}
    function populateCategorySelect(type='expense'){const s=document.getElementById('transaction-category');if(!s)return;s.innerHTML='';const f=categories.filter(c=>c.type===type);if(f.length===0){const o=document.createElement('option');o.value="";o.textContent=`Nenhuma categoria de ${type==='income'?'receita':'despesa'}`;o.disabled=true;s.appendChild(o);}else{console.log(`Populando select com ${f.length} categorias de ${type}`);f.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`${c.icon||''} ${c.name||'S/ Nome'}`;s.appendChild(o);});}}
    function toggleDeleteCategoryButton(){const s=document.getElementById('analysis-category');const b=document.getElementById('btn-delete-category');if(!s||!b)return;if(s.value!=='all'){const c=categories.find(c=>c.id===s.value);if(c&&!c.isDefault){b.style.display='inline-flex';}else{b.style.display='none';}}else{b.style.display='none';}}
    function populateYearMonthFilters(){const yS=document.getElementById('analysis-year');const mS=document.getElementById('analysis-month');if(!yS||!mS)return;yS.innerHTML='';mS.innerHTML='';const cy=moment().year();for(let y=cy-5;y<=cy+5;y++){const o=document.createElement('option');o.value=y;o.textContent=y;yS.appendChild(o);}moment.months().forEach((m,i)=>{const o=document.createElement('option');o.value=i;o.textContent=m.charAt(0).toUpperCase()+m.slice(1);mS.appendChild(o);});yS.value=moment().year();mS.value=moment().month();updateCurrentAnalysisDate(false);}
    function updateCurrentAnalysisDate(triggerUpdate=true){const y=document.getElementById('analysis-year')?.value;const m=document.getElementById('analysis-month')?.value;const t=document.getElementById('analysis-type')?.value;const i=document.getElementById('analysis-importance')?.value;const c=document.getElementById('analysis-category')?.value;const s=document.getElementById('analysis-status')?.value;if(y&&m){currentAnalysisMonthYear=`${y}-${String(Number(m)+1).padStart(2,'0')}`;};if(t)currentAnalysisType=t;if(i)currentAnalysisImportance=i;if(c)currentAnalysisCategory=c;if(s)currentAnalysisStatus=s;console.log("Filtros:",currentAnalysisMonthYear,currentAnalysisCategory,currentAnalysisType,currentAnalysisImportance,currentAnalysisStatus);if(triggerUpdate){updateMonthlyAnalysis();}}
    function setupEventListeners(){const btnN=document.getElementById('btn-new-transaction');if(btnN)btnN.addEventListener('click',()=>openTransactionModal());const btnT=document.getElementById('theme-toggle');if(btnT)btnT.addEventListener('click',toggleTheme);const trM=document.getElementById('transaction-modal');if(trM){const btnCl=trM.querySelector('#transaction-modal-close');const btnCa=trM.querySelector('#transaction-modal-cancel');const frm=trM.querySelector('#transaction-form');const typeSel=trM.querySelector('#transaction-type');const recChk=trM.querySelector('#transaction-recurring');const btnAddCatM=trM.querySelector('#btn-add-category-modal');if(btnCl)btnCl.addEventListener('click',()=>closeModal(trM));if(btnCa)btnCa.addEventListener('click',()=>closeModal(trM));if(frm)frm.addEventListener('submit',saveTransaction);if(typeSel)typeSel.addEventListener('change',(e)=>populateCategorySelect(e.target.value));if(recChk){recChk.addEventListener('change',(e)=>{const rO=document.getElementById('recurring-options');if(rO)rO.style.display=e.target.checked?'block':'none';});}if(btnAddCatM)btnAddCatM.addEventListener('click',()=>openCategoryModal());}
    const yS=document.getElementById('analysis-year');const mS=document.getElementById('analysis-month');const catS=document.getElementById('analysis-category');const typeS=document.getElementById('analysis-type');const impS=document.getElementById('analysis-importance');const statS=document.getElementById('analysis-status');if(yS)yS.addEventListener('change',()=>updateCurrentAnalysisDate(true));if(mS)mS.addEventListener('change',()=>updateCurrentAnalysisDate(true));if(catS)catS.addEventListener('change',()=>{toggleDeleteCategoryButton();updateCurrentAnalysisDate(true);});if(typeS)typeS.addEventListener('change',()=>updateCurrentAnalysisDate(true));if(impS)impS.addEventListener('change',()=>updateCurrentAnalysisDate(true));if(statS)statS.addEventListener('change',()=>updateCurrentAnalysisDate(true));
    const btnAddCatG=document.getElementById('btn-add-category');const btnDelCatG=document.getElementById('btn-delete-category');const catM=document.getElementById('category-modal');if(btnAddCatG)btnAddCatG.addEventListener('click',()=>openCategoryModal());if(btnDelCatG){btnDelCatG.addEventListener('click',()=>{const selCatId=document.getElementById('analysis-category')?.value;if(selCatId&&selCatId!=='all'){confirmDeleteCategory(selCatId);}});}if(catM){const catF=catM.querySelector('#category-form');if(catF)catF.addEventListener('submit',handleSaveCategory);catM.querySelectorAll('[data-dismiss="modal"]').forEach(b=>{b.addEventListener('click',()=>closeModal(catM));});}
    const confM=document.getElementById('confirm-modal');if(confM){const confBtn=confM.querySelector('#confirm-modal-confirm');if(confBtn){confBtn.addEventListener('click',()=>{const act=confBtn._action;if(act&&typeof act==='function'){act();}else{console.warn("Ação confirmação indefinida.");closeModal(confM);}});}confM.querySelectorAll('[data-dismiss="modal"]').forEach(b=>{b.addEventListener('click',()=>closeModal(confM));});}
    document.querySelectorAll('.modal').forEach(m=>{m.addEventListener('click',(e)=>{if(e.target===m){closeModal(m);}});});console.log("Listeners configurados.");}
    function openCategoryModal(){const m=document.getElementById('category-modal');const f=document.getElementById('category-form');if(!m||!f)return;f.reset();document.getElementById('category-modal-title').textContent="Nova Categoria";const c=document.getElementById('category-color');if(c)c.value='#8A8A8E';openModal(m);setTimeout(()=>{const n=document.getElementById('category-name');if(n)n.focus();},100);}
    async function handleSaveCategory(e){e.preventDefault();const nI=document.getElementById('category-name');const tS=document.getElementById('category-type');const iI=document.getElementById('category-icon');const cI=document.getElementById('category-color');const n=nI?nI.value:'';const t=tS?tS.value:'';const i=iI?iI.value:'';const c=cI?cI.value:'#8A8A8E';if(!n||!t){showToast("Nome e Tipo são obrigatórios.","warning");return;}const s=await addCategory(n,t,i,c);if(s){closeModal(document.getElementById('category-modal'));}}
    function confirmDeleteCategory(id){const c=categories.find(c=>c.id===id);if(!c){showToast("Categoria não encontrada.","danger");return;}if(c.isDefault){showToast("Não pode excluir padrão.","warning");return;}const cm=document.getElementById('confirm-modal');if(!cm)return;const ti=cm.querySelector('#confirm-modal-title');const msg=cm.querySelector('#confirm-modal-message');const xtr=cm.querySelector('#confirm-modal-extra-info');const btn=cm.querySelector('#confirm-modal-confirm');if(ti)ti.textContent="Excluir Categoria";if(msg)msg.textContent=`Excluir categoria "${c.name||id}"?`;if(xtr)xtr.textContent="Ação não pode ser desfeita.";if(btn){btn.textContent="Excluir";btn.className='btn btn-danger';btn._action=()=>deleteCategory(id);}openModal(cm);}
    function confirmDeleteTransaction(id){const t=transactions.find(t=>t.id===id);if(!t){showToast("Transação não encontrada.","danger");return;}const cm=document.getElementById('confirm-modal');if(!cm)return;const ti=cm.querySelector('#confirm-modal-title');const msg=cm.querySelector('#confirm-modal-message');const xtr=cm.querySelector('#confirm-modal-extra-info');const btn=cm.querySelector('#confirm-modal-confirm');if(ti)ti.textContent="Excluir Transação";const d=t.description||`Transação de ${formatCurrency(t.amount)}`;let baseMsg=`Excluir transação "${d}" de ${formatFullDate(t.date)}?`;let xtrHTML="Ação não pode ser desfeita.";let scope='this';let action=()=>deleteTransaction(id,null,'this');const recId=t.recurringInfo?.baseId;if(recId){baseMsg=`Trans. recorrente (${t.recurringInfo?.currentInstallment||'?'}/${t.recurringInfo?.totalInstallments||'∞'}). Excluir?`;xtrHTML=`<div style="display:flex;flex-direction:column;gap:0.75rem;"><label><input type="radio" name="delete-scope" value="this" checked> Somente esta (${formatFullDate(t.date)})</label><label><input type="radio" name="delete-scope" value="future"> Esta e futuras</label></div>`;cm.querySelectorAll('input[name="delete-scope"]').forEach(r=>{r.onchange=(e)=>{scope=e.target.value;action=()=>deleteTransaction(id,recId,scope);if(btn)btn._action=action;};});action=()=>deleteTransaction(id,recId,'this');}if(msg)msg.textContent=baseMsg;if(xtr)xtr.innerHTML=xtrHTML;if(btn){btn.textContent="Excluir";btn.className='btn btn-danger';btn._action=action;}const rThis=cm.querySelector('input[name="delete-scope"][value="this"]');if(rThis)rThis.checked=true;openModal(cm);}

    // ===== Atualização da UI =====
    function updateDashboard(){if(!transactionsCollection||!categoriesCollection){console.warn("Update Dashboard: DB não disponível.");return;}console.log("Atualizando dashboard...");updateKPIs();if(currentTab==='overview'){updateOverviewCharts();}else if(currentTab==='analysis'){updateMonthlyAnalysis();}}
    function updateKPIs(){const bE=document.getElementById('kpi-balance');const iE=document.getElementById('kpi-income');const eE=document.getElementById('kpi-expenses');const sE=document.getElementById('kpi-savings');const pE=document.getElementById('kpi-projection');const bTE=document.getElementById('balance-trend');const iTE=document.getElementById('income-trend');const eTE=document.getElementById('expenses-trend');const bTI=document.getElementById('balance-trend-indicator');const iTI=document.getElementById('income-trend-indicator');const eTI=document.getElementById('expenses-trend-indicator');const sSE=document.getElementById('savings-status');const sP=document.getElementById('savings-progress');const pSE=document.getElementById('projection-status');if(!bE||!iE||!eE||!sE||!pE||!bTE||!iTE||!eTE||!bTI||!iTI||!eTI||!sSE||!sP||!pSE){console.warn("KPIs não encontrados.");return;}const tI=transactions.filter(t=>t.type==='income'&&t.status==='paid'&&typeof t.amount==='number').reduce((s,t)=>s+t.amount,0);const tE=transactions.filter(t=>t.type==='expense'&&t.status==='paid'&&typeof t.amount==='number').reduce((s,t)=>s+t.amount,0);const cB=tI-tE;bE.textContent=formatCurrency(cB);const cMS=moment().startOf('month');const cME=moment().endOf('month');const cMI=transactions.filter(t=>t.type==='income'&&typeof t.amount==='number'&&moment(t.date).isBetween(cMS,cME,'day','[]')).reduce((s,t)=>s+t.amount,0);const cME=transactions.filter(t=>t.type==='expense'&&typeof t.amount==='number'&&moment(t.date).isBetween(cMS,cME,'day','[]')).reduce((s,t)=>s+t.amount,0);iE.textContent=formatCurrency(cMI);eE.textContent=formatCurrency(cME);const cMSa=cMI-cME;sE.textContent=formatCurrency(cMSa);sE.style.color=cMSa>=0?'var(--success)':'var(--danger)';let sPc=0;if(cMI>0){sPc=Math.max(0,(cMSa/cMI)*100);sP.style.width=`${Math.min(100,sPc)}%`;sP.className=`progress-bar ${cMSa>=0?'success':'danger'}`;sSE.textContent=`${cMSa>=0?'Positiva':'Negativa'} (${sPc.toFixed(0)}% receita)`;}else{sP.style.width='0%';sP.className='progress-bar';sSE.textContent=cME>0?'Apenas despesas':'Sem movimento';}const scE=transactions.filter(t=>t.type==='expense'&&typeof t.amount==='number'&&t.status!=='paid'&&moment(t.date).isBetween(cMS,cME,'day','[]')).reduce((s,t)=>s+t.amount,0);const eP=transactions.filter(t=>t.type==='expense'&&typeof t.amount==='number'&&t.status==='paid'&&moment(t.date).isBetween(cMS,cME,'day','[]')).reduce((s,t)=>s+t.amount,0);const pEx=eP+scE;pE.textContent=formatCurrency(pEx);pSE.textContent=`Realizado: ${formatCurrency(eP)} | Previsto: ${formatCurrency(scE)}`;const lMS=moment().subtract(1,'month').startOf('month');const lME=moment().subtract(1,'month').endOf('month');const lMI=transactions.filter(t=>t.type==='income'&&typeof t.amount==='number'&&moment(t.date).isBetween(lMS,lME,'day','[]')).reduce((s,t)=>s+t.amount,0);const lME=transactions.filter(t=>t.type==='expense'&&typeof t.amount==='number'&&moment(t.date).isBetween(lMS,lME,'day','[]')).reduce((s,t)=>s+t.amount,0);const lMB=lMI-lME;const cMPB=transactions.filter(t=>t.status==='paid'&&typeof t.amount==='number'&&moment(t.date).isBetween(cMS,cME,'day','[]')).reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount),0);const uT=(curr,prev,valEl,indEl)=>{let perc=0;let cls='neutral';let icon=`<path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/>`;if(prev!==0){perc=((curr-prev)/Math.abs(prev))*100;}else if(curr!==0){perc=100*Math.sign(curr);}const isExp=indEl.id.includes('expenses');if(perc>1){cls=isExp?'down':'up';icon=`<path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>`;}else if(perc<-1){cls=isExp?'up':'down';icon=`<path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>`;}valEl.textContent=`${Math.abs(perc).toFixed(0)}%`;indEl.className=`kpi-trend ${cls}`;const svg=indEl.querySelector('svg');if(svg)svg.innerHTML=icon;};uT(cMPB,lMB,bTE,bTI);uT(cMI,lMI,iTE,iTI);uT(cME,lME,eTE,eTI);}
    // ===== Lógica da Análise Mensal =====
    function updateMonthlyAnalysis(){const yS=document.getElementById('analysis-year');const mS=document.getElementById('analysis-month');const cS=document.getElementById('analysis-category');const tS=document.getElementById('analysis-type');const iS=document.getElementById('analysis-importance');const sS=document.getElementById('analysis-status');if(!yS||!mS||!cS||!tS||!iS||!sS){console.error("Filtros Análise não encontrados.");return;}showLoading();console.log(`Análise: ${currentAnalysisMonthYear}, Cat: ${currentAnalysisCategory}, Tipo: ${currentAnalysisType}, Imp: ${currentAnalysisImportance}, Status: ${currentAnalysisStatus}`);const start=moment(currentAnalysisMonthYear).startOf('month');const end=moment(currentAnalysisMonthYear).endOf('month');const monthlyT=transactions.filter(t=>{if(!t.date||typeof t.amount!=='number'||!t.type){return false;}const tM=moment(t.date);const sMonth=tM.isBetween(start,end,'day','[]');const sCat=(currentAnalysisCategory==='all'||t.category===currentAnalysisCategory);const sType=(currentAnalysisType==='all'||t.type===currentAnalysisType);const sImp=(currentAnalysisImportance==='all')||(currentAnalysisImportance==='none'&&!t.importance)||(t.importance===currentAnalysisImportance);const sStat=(currentAnalysisStatus==='all'||t.status===currentAnalysisStatus);return sMonth&&sCat&&sType&&sImp&&sStat;});console.log(`${monthlyT.length} trans. encontradas.`);try{calculateMonthlyIndicators(monthlyT,currentAnalysisMonthYear);renderMonthlyTransactionList(monthlyT);generateAndRenderInsights(monthlyT,currentAnalysisMonthYear);updateAnalysisCharts(monthlyT);}catch(e){console.error("Erro update análise:",e);showToast("Erro ao atualizar análise.","danger");}finally{hideLoading();}}
    function calculateMonthlyIndicators(mTs,selMY){const tIE=document.getElementById('analysis-total-income');const tEE=document.getElementById('analysis-total-expenses');const fBE=document.getElementById('analysis-final-balance');const mSE=document.getElementById('analysis-month-status');const dLE=document.getElementById('analysis-days-left');const iCE=document.getElementById('analysis-income-comparison');const eCE=document.getElementById('analysis-expense-comparison');const bCE=document.getElementById('analysis-balance-comparison');const topCE=document.getElementById('analysis-top-category');const topCVE=document.getElementById('analysis-top-category-value');if(!tIE||!tEE||!fBE||!mSE||!dLE||!iCE||!eCE||!bCE||!topCE||!topCVE){console.warn("Indicadores Análise não encontrados.");return;}const inc=mTs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);const exp=mTs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);const bal=inc-exp;tIE.textContent=formatCurrency(inc);tEE.textContent=formatCurrency(exp);fBE.textContent=formatCurrency(bal);fBE.className=`indicator-value ${bal>=0?'positive':'negative'}`;const today=moment();const startM=moment(selMY);const endM=startM.endOf('month');const dLeft=endM.diff(today,'days');if(startM.isSame(today,'month')){mSE.textContent='Em Andamento';dLE.textContent=`${Math.max(0,dLeft)} dias restantes`;}else if(startM.isBefore(today,'month')){mSE.textContent='Fechado';dLE.textContent='Mês encerrado';}else{mSE.textContent='Futuro';dLE.textContent='Mês futuro';}const lMS=moment(selMY).subtract(1,'month').format('YYYY-MM');const lMSS=moment(lMS).startOf('month');const lMSE=moment(lMS).endOf('month');const lMT=transactions.filter(t=>{if(!t.date||typeof t.amount!=='number'||!t.type)return false;const tM=moment(t.date);const isSM=tM.isBetween(lMSS,lMSE,'day','[]');const isSC=(currentAnalysisCategory==='all'||t.category===currentAnalysisCategory);const isST=(currentAnalysisType==='all'||t.type===currentAnalysisType);const isSI=(currentAnalysisImportance==='all')||(currentAnalysisImportance==='none'&&!t.importance)||(t.importance===currentAnalysisImportance);const isSS=(currentAnalysisStatus==='all'||t.status===currentAnalysisStatus);return isSM&&isSC&&isST&&isSI&&isSS;});const lMI=lMT.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);const lME=lMT.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);const lMB=lMI-lME;const fmtC=(curr,prev)=>{if(prev===0&&curr===0)return"--";if(prev===0)return`${curr>0?'+':''}100% vs mês anterior`;const diff=curr-prev;const perc=((diff/Math.abs(prev))*100);return`${perc>=0?'+':''}${perc.toFixed(0)}% vs mês anterior`;};iCE.textContent=fmtC(inc,lMI);eCE.textContent=fmtC(exp,lME);bCE.textContent=fmtC(bal,lMB);const expBC=mTs.filter(t=>t.type==='expense').reduce((a,t)=>{const cId=t.category||'unknown';a[cId]=(a[cId]||0)+t.amount;return a;},{});const topE=Object.entries(expBC).sort(([,a],[,b])=>b-a)[0];if(topE){const[cId,amt]=topE;const cat=categories.find(c=>c.id===cId);topCE.textContent=cat?`${cat.icon||''} ${cat.name}`:'Desconhecida';topCVE.textContent=formatCurrency(amt);}else{topCE.textContent='--';topCVE.textContent=formatCurrency(0);}}
    function renderMonthlyTransactionList(mTs){const lC=document.getElementById('analysis-transaction-list');const noMsg=document.getElementById('analysis-no-transactions');if(!lC||!noMsg)return;lC.innerHTML='';if(mTs.length===0){noMsg.style.display='block';return;}noMsg.style.display='none';
    mTs.sort((a,b)=>{const dDA=a.dueDate?moment(a.dueDate):moment('9999-12-31');const dDB=b.dueDate?moment(b.dueDate):moment('9999-12-31');const dA=moment(a.date);const dB=moment(b.date);const dDiff=dDA.diff(dDB);if(dDiff!==0)return dDiff;return dA.diff(dB);});const today=moment();
    mTs.forEach(t=>{const cat=categories.find(c=>c.id===t.category)||{name:'Desconhecida',icon:'❓',color:'#8E8E93'};const item=document.createElement('div');item.className='transaction-item';item.setAttribute('role','button');item.setAttribute('tabindex','0');const amtP=t.type==='income'?'+':'-';const impC=t.importance?`transaction-importance ${t.importance}`:'';const impT=t.importance?`Importância: ${t.importance.charAt(0).toUpperCase()+t.importance.slice(1)}`:'';const isPaid=t.status==='paid';const statInfo=TRANSACTION_STATUS[t.status]||{name:t.status,class:`status-${t.status}`,color:'var(--text-secondary)'};const statTxt=statInfo.name;const statCls=statInfo.class;
    let dDClass='';let dDTxt=t.dueDate?formatDate(t.dueDate):'--';if(t.dueDate&&!isPaid){const dDM=moment(t.dueDate);if(dDM.isBefore(today,'day')){dDClass='overdue';statCls='status-overdue';statTxt='Vencido!';}else if(dDM.isSame(today,'day')){dDClass='near-due';statTxt='Vence Hoje';}else if(dDM.diff(today,'days')<=7){dDClass='near-due';}}
    item.innerHTML=`<div class="transaction-item-left"><div class="transaction-icon" style="background-color:${cat.color||'#8E8E93'};">${cat.icon||'?'}</div><div class="transaction-info"><div class="transaction-description">${t.description||cat.name||'S/ Descrição'}</div><div class="transaction-category">${cat.name||'Desconhecida'} <span class="transaction-status ${statCls}">${statTxt}</span></div></div></div><div class="transaction-item-right"><div class="transaction-dates-amount-wrapper"><div class="transaction-amount ${t.type==='income'?'income':'expense'}">${amtP} ${formatCurrency(t.amount)}${impC?`<span class="${impC}" title="${impT}"></span>`:''}</div><div class="transaction-dates"><span class="transaction-date" title="Data Transação">${formatDate(t.date)}</span>${t.dueDate?`<span class="transaction-due-date ${dDClass}" title="Vencimento">Venc: ${dDTxt}</span>`:''}</div></div><button class="btn-action btn-delete-transaction" data-id="${t.id}" title="Excluir Transação"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div>`;
    const delBtn=item.querySelector('.btn-delete-transaction');if(delBtn){delBtn.addEventListener('click',(e)=>{e.stopPropagation();confirmDeleteTransaction(t.id);});}item.addEventListener('click',(e)=>{if(!e.target.closest('.btn-delete-transaction')){openTransactionModal(t);}});item.addEventListener('keydown',(e)=>{if(!e.target.closest('.btn-delete-transaction')&&(e.key==='Enter'||e.key===' ')){openTransactionModal(t);}});lC.appendChild(item);});}

    function generateAndRenderInsights(mTs,selMY){const iL=document.getElementById('analysis-insights-list');const noMsg=document.getElementById('analysis-no-insights');if(!iL||!noMsg)return;iL.innerHTML='';const insights=[];const inc=mTs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);const exp=mTs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);const bal=inc-exp;
    const lMS=moment(selMY).subtract(1,'month').format('YYYY-MM');const lMSS=moment(lMS).startOf('month');const lMSE=moment(lMS).endOf('month');const lMGT=transactions.filter(t=>{if(!t.date||typeof t.amount!=='number'||!t.type)return false;return moment(t.date).isBetween(lMSS,lMSE,'day','[]');});const lMGE=lMGT.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);if(lMGE>0){const chg=((exp-lMGE)/lMGE)*100;if(chg>15){insights.push({type:'warning',text:`🚨 Atenção: Despesas (${formatCurrency(exp)}) aumentaram ${chg.toFixed(0)}% vs mês anterior.`});}else if(chg<-10){insights.push({type:'success',text:`✅ Ótimo! Despesas (${formatCurrency(exp)}) diminuíram ${Math.abs(chg).toFixed(0)}% este mês.`});}}else if(exp>0){insights.push({type:'info',text:`ℹ️ Primeiro mês com registro de despesas (${formatCurrency(exp)}).`});}
    if(bal>50){insights.push({type:'success',text:`👍 Parabéns! Saldo positivo de ${formatCurrency(bal)}.`});}else if(bal<-50){insights.push({type:'alert',text:`📉 Cuidado! Saldo negativo de ${formatCurrency(Math.abs(bal))}.`});}else if(inc>0||exp>0){insights.push({type:'neutral',text:`⚖️ Saldo final (${formatCurrency(bal)}) próximo de zero.`});}
    const today=moment();const nextWeek=moment().add(7,'days');
    const upcoming=transactions.filter(t=>t.type==='expense'&&(t.status==='pending'||t.status==='scheduled')&&t.dueDate&&moment(t.dueDate).isBetween(today,nextWeek,'day','[]'));
    const overdue=transactions.filter(t=>t.type==='expense'&&(t.status==='pending'||t.status==='scheduled')&&t.dueDate&&moment(t.dueDate).isBefore(today,'day'));
    if(overdue.length>0){const tot=overdue.reduce((s,t)=>s+t.amount,0);insights.push({type:'alert',text:`🚨 Vencido! ${overdue.length} conta(s) passada(s), total ${formatCurrency(tot)}.`});}
    if(upcoming.length>0){const tot=upcoming.reduce((s,t)=>s+t.amount,0);insights.push({type:'warning',text:`⚠️ Próximos 7 dias! ${upcoming.length} conta(s) a vencer, total ${formatCurrency(tot)}.`});}else if(overdue.length===0){insights.push({type:'success',text:`✅ Tudo em dia! Nenhuma conta a vencer nos próximos 7 dias.`});}
    if(insights.length>0){noMsg.style.display='none';insights.forEach(i=>{const item=document.createElement('div');item.className=`insight-item ${i.type}`;let icon='💬';if(i.type==='alert')icon='🚨';else if(i.type==='warning')icon='⚠️';else if(i.type==='success')icon='✅';else if(i.type==='info')icon='ℹ️';else if(i.type==='neutral')icon='🔍';item.innerHTML=`<span class="insight-icon">${icon}</span><span class="insight-text">${i.text}</span>`;iL.appendChild(item);});}else{noMsg.textContent="Nenhum insight relevante.";noMsg.style.display='block';}}

    // ===== Gráficos (sem alterações) =====
    function getChartCommonOptions(isDark){const tC=isDark?'rgba(235,235,245,0.8)':'#3C3C43';const gC=isDark?'rgba(84,84,88,0.4)':'rgba(60,60,67,0.15)';const ttB=isDark?'rgba(44,44,46,0.9)':'rgba(249,249,249,0.9)';const ttT=isDark?'#FFFFFF':'#1C1C1E';return{responsive:true,maintainAspectRatio:false,color:tC,plugins:{legend:{position:'bottom',align:'center',labels:{color:tC,boxWidth:12,padding:20,font:{size:13,family:'var(--font-sans)'}}},tooltip:{enabled:true,backgroundColor:ttB,titleColor:ttT,bodyColor:ttT,borderColor:gC,borderWidth:0.5,padding:10,cornerRadius:8,usePointStyle:true,boxPadding:4,titleFont:{weight:'600',family:'var(--font-sans)'},bodyFont:{family:'var(--font-sans)'},footerFont:{family:'var(--font-sans)',size:11},callbacks:{label:function(ctx){let l=ctx.dataset.label||ctx.label||'';if(l){l+=': ';}let v=ctx.parsed.y??ctx.parsed.x??ctx.parsed;if(v!==null&&typeof v==='number'){l+=formatCurrency(v);}else if(ctx.formattedValue){l+=ctx.formattedValue;}return l;},footer:function(items){if(items.length>0&&items[0].chart.config.type.match(/pie|doughnut/)){const ch=items[0].chart;const dIdx=items[0].datasetIndex;const iIdx=items[0].dataIndex;const dSet=ch.data.datasets[dIdx];const sum=Array.isArray(dSet.data)?dSet.data.reduce((a,b)=>a+(typeof b==='number'?b:0),0):0;const v=items[0].parsed;if(sum>0&&typeof v==='number'){const p=((v/sum)*100).toFixed(1)+'%';return`Percentual: ${p}`;}}return'';}}}},scales:{x:{grid:{color:gC,drawBorder:false,},ticks:{color:tC,font:{size:12,family:'var(--font-sans)'},maxRotation:0,autoSkipPadding:10}},y:{grid:{color:gC,drawBorder:false},ticks:{color:tC,font:{size:12,family:'var(--font-sans)'},callback:function(v){if(Math.abs(v)>=1e6)return formatCurrency(v/1e6)+'M';if(Math.abs(v)>=1e3)return formatCurrency(v/1e3)+'k';return formatCurrency(v);}},beginAtZero:true}},layout:{padding:{top:10,bottom:0,left:0,right:10}}};}
    function initCharts(){console.log("Init charts...");const isD=root.getAttribute('data-theme')==='dark';const opts=getChartCommonOptions(isD);Object.values(overviewCharts).forEach(c=>c?.destroy());Object.values(analysisCharts).forEach(c=>c?.destroy());overviewCharts={};analysisCharts={};try{const c1=document.getElementById('overview-income-expense-chart')?.getContext('2d');if(c1)overviewCharts.incomeExpense=new Chart(c1,{type:'bar',data:{labels:[],datasets:[]},options:{...opts}});const c2=document.getElementById('overview-category-chart')?.getContext('2d');if(c2){const dOpt={...opts};delete dOpt.scales;dOpt.cutout='65%';overviewCharts.category=new Chart(c2,{type:'doughnut',data:{labels:[],datasets:[]},options:dOpt});}const c3=document.getElementById('overview-cashflow-chart')?.getContext('2d');if(c3)overviewCharts.cashflow=new Chart(c3,{type:'bar',data:{labels:[],datasets:[]},options:{...opts}});const c4=document.getElementById('overview-fixed-variable-chart')?.getContext('2d');if(c4){const pOpt={...opts};delete pOpt.scales;overviewCharts.fixedVariable=new Chart(c4,{type:'pie',data:{labels:[],datasets:[]},options:pOpt});}const c5=document.getElementById('overview-trend-chart')?.getContext('2d');if(c5){const lOpt={...opts};lOpt.tension=0.3;lOpt.pointRadius=3;lOpt.pointHoverRadius=5;overviewCharts.trend=new Chart(c5,{type:'line',data:{labels:[],datasets:[]},options:lOpt});}}catch(e){console.error("Erro init Overview charts:",e);}try{const a1=document.getElementById('analysis-category-pie-chart')?.getContext('2d');if(a1){const pOpt={...opts};delete pOpt.scales;analysisCharts.categoryPie=new Chart(a1,{type:'pie',data:{labels:[],datasets:[]},options:pOpt});}const a2=document.getElementById('analysis-balance-line-chart')?.getContext('2d');if(a2){const lOpt={...opts};lOpt.tension=0.1;lOpt.pointRadius=3;lOpt.pointHoverRadius=5;analysisCharts.balanceLine=new Chart(a2,{type:'line',data:{labels:[],datasets:[]},options:lOpt});}}catch(e){console.error("Erro init Analysis charts:",e);}console.log("Gráficos inicializados.");}
    function updateAllChartsTheme(){const isD=root.getAttribute('data-theme')==='dark';const baseOpts=getChartCommonOptions(isD);console.log("Update chart themes:",isD?"Dark":"Light");const update=(chart,spec={})=>{if(chart&&chart.options&&chart.config){const keep={tension:chart.options.tension,cutout:chart.options.cutout};const hasScales=chart.config.type==='bar'||chart.config.type==='line';let newOpts={...baseOpts};if(!hasScales){delete newOpts.scales;}chart.options={...newOpts,...spec,...keep};try{chart.update();}catch(e){console.error("Erro update chart:",chart.canvas?.id,e);}}};if(overviewCharts.incomeExpense)update(overviewCharts.incomeExpense);if(overviewCharts.category)update(overviewCharts.category,{cutout:'65%'});if(overviewCharts.cashflow)update(overviewCharts.cashflow);if(overviewCharts.fixedVariable)update(overviewCharts.fixedVariable);if(overviewCharts.trend)update(overviewCharts.trend,{tension:0.3});if(analysisCharts.categoryPie)update(analysisCharts.categoryPie);if(analysisCharts.balanceLine)update(analysisCharts.balanceLine,{tension:0.1});console.log("Chart themes updated.");}
    function updateOverviewCharts(){if(!overviewCharts||Object.keys(overviewCharts).length===0){console.warn("Overview charts não init.");return;}console.log("Update Overview charts...");const isD=root.getAttribute('data-theme')==='dark';
    if(overviewCharts.incomeExpense){const lbls=[];const iData=[];const eData=[];for(let i=11;i>=0;i--){const m=moment().subtract(i,'months');lbls.push(m.format('MMM/YY'));const s=m.startOf('month');const e=m.endOf('month');const mI=transactions.filter(t=>t.type==='income'&&t.status==='paid'&&typeof t.amount==='number'&&moment(t.date).isBetween(s,e,'day','[]')).reduce((sm,t)=>sm+t.amount,0);const mE=transactions.filter(t=>t.type==='expense'&&t.status==='paid'&&typeof t.amount==='number'&&moment(t.date).isBetween(s,e,'day','[]')).reduce((sm,t)=>sm+t.amount,0);iData.push(mI);eData.push(mE);}overviewCharts.incomeExpense.data={labels:lbls,datasets:[{label:'Receitas',data:iData,backgroundColor:isD?'#30D158':'#34C759',borderRadius:4},{label:'Despesas',data:eData,backgroundColor:isD?'#FF453A':'#FF3B30',borderRadius:4}]};overviewCharts.incomeExpense.update();}
    if(overviewCharts.category){const start=moment().subtract(30,'days').startOf('day');const exp30=transactions.filter(t=>t.type==='expense'&&typeof t.amount==='number'&&t.date&&moment(t.date).isSameOrAfter(start));const expBC=exp30.reduce((a,t)=>{const cId=t.category||'unknown';const cat=categories.find(c=>c.id===cId)||{id:'unknown',name:'Desconhecida',color:'#8E8E93',icon:'❓'};a[cat.id]=(a[cat.id]||{name:`${cat.icon} ${cat.name}`,value:0,color:cat.color});a[cat.id].value+=t.amount;return a;},{});const sorted=Object.values(expBC).sort((a,b)=>b.value-a.value);overviewCharts.category.data={labels:sorted.map(c=>c.name),datasets:[{data:sorted.map(c=>c.value),backgroundColor:sorted.map(c=>c.color),borderColor:isD?'#000000':'#FFFFFF',borderWidth:2}]};overviewCharts.category.update();}
    if(overviewCharts.cashflow){const y=moment().year();const lbls=[];const bData=[];for(let i=0;i<12;i++){const m=moment().year(y).month(i);lbls.push(m.format('MMM'));const s=m.startOf('month');const e=m.endOf('month');const mI=transactions.filter(t=>t.type==='income'&&t.status==='paid'&&typeof t.amount==='number'&&moment(t.date).isBetween(s,e,'day','[]')).reduce((sm,t)=>sm+t.amount,0);const mE=transactions.filter(t=>t.type==='expense'&&t.status==='paid'&&typeof t.amount==='number'&&moment(t.date).isBetween(s,e,'day','[]')).reduce((sm,t)=>sm+t.amount,0);bData.push(mI-mE);}overviewCharts.cashflow.data={labels:lbls,datasets:[{label:'Saldo Mensal (Pago)',data:bData,backgroundColor:bData.map(b=>b>=0?(isD?'#30D158':'#34C759'):(isD?'#FF453A':'#FF3B30')),borderRadius:4}]};overviewCharts.cashflow.update();}
    if(overviewCharts.fixedVariable){const s=moment().startOf('month');const e=moment().endOf('month');const mE=transactions.filter(t=>t.type==='expense'&&typeof t.amount==='number'&&t.date&&moment(t.date).isBetween(s,e,'day','[]'));const f=mE.filter(t=>t.recurringInfo?.baseId).reduce((sm,t)=>sm+t.amount,0);const v=mE.filter(t=>!t.recurringInfo?.baseId).reduce((sm,t)=>sm+t.amount,0);overviewCharts.fixedVariable.data={labels:['Fixas (Recorrentes)','Variáveis'],datasets:[{data:[f,v],backgroundColor:[isD?'#0A84FF':'#007AFF',isD?'#BF5AF2':'#AF52DE'],borderColor:isD?'#000000':'#FFFFFF',borderWidth:2}]};overviewCharts.fixedVariable.update();}
    if(overviewCharts.trend){const lbls=[];const data=[];for(let i=5;i>=0;i--){const m=moment().subtract(i,'months');lbls.push(m.format('MMM/YY'));const s=m.startOf('month');const e=m.endOf('month');const mE=transactions.filter(t=>t.type==='expense'&&t.status==='paid'&&typeof t.amount==='number'&&t.date&&moment(t.date).isBetween(s,e,'day','[]')).reduce((sm,t)=>sm+t.amount,0);data.push(mE);}overviewCharts.trend.data={labels:lbls,datasets:[{label:'Despesas Pagas',data:data,borderColor:isD?'#FF9F0A':'#FF9500',backgroundColor:isD?'rgba(255,159,10,0.15)':'rgba(255,149,0,0.1)',fill:true}]};overviewCharts.trend.update();}console.log("Overview charts updated.");}
    function updateAnalysisCharts(mTs){if(!analysisCharts||Object.keys(analysisCharts).length===0){console.warn("Analysis charts não init.");return;}console.log("Update Analysis charts...");const isD=root.getAttribute('data-theme')==='dark';
    if(analysisCharts.categoryPie){const expBC=mTs.filter(t=>t.type==='expense').reduce((a,t)=>{const cId=t.category||'unknown';const cat=categories.find(c=>c.id===cId)||{id:'unknown',name:'Desconhecida',color:'#8E8E93',icon:'❓'};a[cat.id]=(a[cat.id]||{name:`${cat.icon} ${cat.name}`,value:0,color:cat.color});a[cat.id].value+=t.amount;return a;},{});const sorted=Object.values(expBC).sort((a,b)=>b.value-a.value);const maxC=7;let dLbls=sorted.slice(0,maxC).map(c=>c.name);let dData=sorted.slice(0,maxC).map(c=>c.value);let dCols=sorted.slice(0,maxC).map(c=>c.color);if(sorted.length>maxC){const otherV=sorted.slice(maxC).reduce((s,c)=>s+c.value,0);if(otherV>0){dLbls.push("Outros");dData.push(otherV);dCols.push(isD?'#48484A':'#C7C7CC');}}analysisCharts.categoryPie.data={labels:dLbls,datasets:[{data:dData,backgroundColor:dCols,borderColor:isD?'#000000':'#FFFFFF',borderWidth:2}]};analysisCharts.categoryPie.update();}
    if(analysisCharts.balanceLine){const selM=moment(currentAnalysisMonthYear);const days=selM.daysInMonth();const lbls=Array.from({length:days},(_,i)=>(i+1).toString());const dBal=[];let cBal=0;const startM=selM.startOf('month');const initB=transactions.filter(t=>t.status==='paid'&&typeof t.amount==='number'&&t.date&&moment(t.date).isBefore(startM,'day')).reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount),0);cBal=initB;for(let d=1;d<=days;d++){const currD=moment(currentAnalysisMonthYear).date(d);const balChg=mTs.filter(t=>t.status==='paid'&&moment(t.date).isSame(currD,'day')).reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount),0);cBal+=balChg;dBal.push(cBal);}analysisCharts.balanceLine.data={labels:lbls,datasets:[{label:'Saldo Acumulado (Pago)',data:dBal,borderColor:isD?'#0A84FF':'#007AFF',backgroundColor:isD?'rgba(10,132,255,0.15)':'rgba(0,122,255,0.1)',fill:true}]};analysisCharts.balanceLine.update();}console.log("Analysis charts updated.");}

    // ===== Inicialização da Aplicação =====
    async function init(){showLoading();console.log("Iniciando app...");try{setupTheme();if(db){await loadCategories();}else{console.error("DB não init. Load categorias padrão.");categories=[...DEFAULT_INCOME_CATEGORIES,...DEFAULT_EXPENSE_CATEGORIES].sort((a,b)=>a.name.localeCompare(b.name));populateCategoryFilters();}initTabs();populateYearMonthFilters();initCharts();setupEventListeners();if(db){setupFirestoreListeners();}else{console.error("Listeners Firestore não iniciados.");updateDashboard();}console.log("App inicializado. Aguardando dados...");}catch(e){console.error("Erro fatal init:",e);showToast("Erro grave ao iniciar. F12.","danger",10000);try{initTabs();setupEventListeners();}catch(uiE){console.error("Erro UI fallback:",uiE);}}finally{setTimeout(hideLoading,500);}}
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
    window.addEventListener('beforeunload',stopFirestoreListeners);

  </script>
</body>
</html>
