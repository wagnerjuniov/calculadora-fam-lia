<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Controle Financeiro Familiar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js, Moment.js, UUID - Carregados via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.v4.min.js"></script> <!-- Usando uuid.v4 diretamente -->

  <!-- Firebase App (M√≥dulo) -->
  <script type="module">
    // Importar m√≥dulos do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configura√ß√£o Firebase (Substitua com suas credenciais reais se necess√°rio)
    const firebaseConfig = {
      apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY", // Mantenha como string
      authDomain: "calculadora-da-familia.firebaseapp.com",
      projectId: "calculadora-da-familia",
      storageBucket: "calculadora-da-familia.appspot.com",
      messagingSenderId: "69721783786",
      appId: "1:69721783786:web:c4703b5c182e3681e8c693",
      measurementId: "G-YM5TR661S6"
    };

    try {
        // Inicializar Firebase e acessar Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        console.log("Firebase App inicializado com sucesso no m√≥dulo.");

        // Tornar db e fun√ß√µes do Firestore acess√≠veis globalmente
        // √â crucial que isso aconte√ßa ANTES do script principal tentar us√°-los
        window.db = db;
        window.firestore = {
            collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy
        };
        // Dispara um evento personalizado para sinalizar que o Firebase est√° pronto
        window.dispatchEvent(new CustomEvent('firebaseReady'));
        console.log("Vari√°veis Firebase expostas globalmente e evento 'firebaseReady' disparado.");
    } catch (error) {
        console.error("Erro Cr√≠tico ao inicializar Firebase:", error);
        // Exibe uma mensagem de erro vis√≠vel para o usu√°rio no corpo da p√°gina
         document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-family: sans-serif;">
             <h1>Erro Cr√≠tico</h1>
             <p>N√£o foi poss√≠vel conectar ao banco de dados (Firebase). Verifique a configura√ß√£o e a conex√£o com a internet.</p>
             <p>Detalhes: ${error.message}</p>
         </div>`;
    }

  </script>

  <style>
    /* ===== Estilos CSS (Inalterados) ===== */
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem; /* ... demais vari√°veis ... */
      --receipt-bg: #FBFBFD;
    }
    [data-theme="dark"] {
      --bg: #1D1D1F; /* ... demais vari√°veis dark ... */
      --receipt-bg: #323234;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { /* ... estilos base ... */ }
    .container { /* ... estilos container ... */ }
    .header { /* ... estilos header ... */ }
    h1 { /* ... estilos h1 ... */ }
    .header-right { /* ... */ }
    .filters { /* ... */ }
    select { /* ... */ }
    .btn { /* ... */ }
    .btn-icon { /* ... */ }
    .theme-toggle { /* ... */ }
    .kpis { /* ... */ }
    .card { /* ... */ }
    .kpi-card { /* ... */ }
    .kpi-header { /* ... */ }
    .kpi-title { /* ... */ }
    .kpi-value { /* ... */ }
    .kpi-footer { /* ... */ }
    .kpi-trend { /* ... */ }
    .kpi-meta { /* ... */ }
    .tabs { /* ... */ }
    .tab { /* ... */ }
    .charts-grid { /* ... */ }
    .chart-container { /* ... */ }
    .chart-title { /* ... */ }
    .chart-title-actions { /* ... */ }
    .chart-legend { /* ... */ }
    .full-width { /* ... */ }
    .table-container { /* ... */ }
    table { /* ... */ }
    /* ... (Todos os outros estilos CSS permanecem inalterados) ... */
    .month-transaction-amount { font-weight: 600; }
    @media (max-width: 1024px) { /* ... */ }
    @media (max-width: 768px) { /* ... */ }
    @media (max-width: 576px) { /* ... */ }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header e Filtros -->
    <div class="header">
      <div class="header-title">
        <h1>Controle Financeiro Familiar</h1>
      </div>
      <div class="header-right">
        <div class="filters">
          <select id="filter-year"> <!-- Op√ß√µes preenchidas por JS --> </select>
          <select id="filter-month"> <!-- Op√ß√µes preenchidas por JS --> </select>
          <select id="filter-category"> <option value="all">Todas Categorias</option> <!-- Op√ß√µes preenchidas por JS --> </select>
          <select id="filter-type"> <option value="all">Todos Tipos</option> <option value="income">Receitas</option> <option value="expense">Despesas</option> </select>
        </div>
        <button class="btn btn-primary" id="btn-new-transaction">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Nova Transa√ß√£o
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema">
          <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <!-- √çcone inicial (ser√° atualizado por JS) -->
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
        <div class="card kpi-card">
            <div class="kpi-header"><div class="kpi-title">Saldo Atual</div><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div>
            <div class="kpi-value" id="kpi-balance">R$ 0,00</div>
            <div class="kpi-footer"><div class="kpi-trend"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg><span id="balance-trend">--%</span></div><span>vs. per√≠odo anterior</span></div>
        </div>
        <div class="card kpi-card">
            <div class="kpi-header"><div class="kpi-title">Receitas</div><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></div>
            <div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div>
            <div class="kpi-footer"><div class="kpi-trend"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg><span id="income-trend">--%</span></div><span>vs. per√≠odo anterior</span></div>
        </div>
        <div class="card kpi-card">
            <div class="kpi-header"><div class="kpi-title">Despesas</div><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg></div>
            <div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div>
            <div class="kpi-footer"><div class="kpi-trend"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg><span id="expenses-trend">--%</span></div><span>vs. per√≠odo anterior</span></div>
        </div>
        <div class="card kpi-card">
            <div class="kpi-header"><div class="kpi-title">Economia Per√≠odo</div><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="8 12 12 16 16 12"></polyline><line x1="12" y1="8" x2="12" y2="16"></line></svg></div>
            <div class="kpi-value" id="kpi-savings">R$ 0,00</div>
            <div class="kpi-meta"><div>Meta: R$ <span id="savings-goal">1.000,00</span></div><div class="progress-container"><div class="progress-bar success" id="savings-progress" style="width: 0%"></div></div></div>
        </div>
        <div class="card kpi-card">
             <div class="kpi-header"><div class="kpi-title">Proje√ß√£o Gastos</div><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div>
             <div class="kpi-value" id="kpi-projection">R$ 0,00</div>
             <div class="kpi-footer"><div class="kpi-trend" id="projection-status"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><span>Verificando...</span></div></div>
        </div>
    </div>

    <!-- Tabs de Navega√ß√£o -->
    <div class="tabs">
      <div class="tab active" data-tab="overview">Vis√£o Geral</div>
      <div class="tab" data-tab="transactions">Transa√ß√µes</div>
      <div class="tab" data-tab="budget">Or√ßamento</div>
      <div class="tab" data-tab="goals">Metas</div>
      <div class="tab" data-tab="monthly">An√°lise Mensal</div>
      <div class="tab" data-tab="categories">Categorias</div>
      <div class="tab" data-tab="reports">Relat√≥rios</div>
    </div>

    <!-- Conte√∫do das Tabs (Estrutura HTML Mantida) -->
    <div class="tab-content" id="tab-overview">
        <div class="charts-grid">
            <div class="card"><div class="chart-title"><span>Receitas vs Despesas</span><div class="chart-title-actions"><select id="income-expense-chart-period"><option value="6">√öltimos 6</option><option value="12" selected>√öltimos 12</option><option value="24">√öltimos 24</option></select></div></div><div class="chart-container"><canvas id="income-expense-chart"></canvas></div></div>
            <div class="card"><div class="chart-title"><span>Despesas por Categoria</span><div class="chart-title-actions"><select id="category-chart-period"><option value="current" selected>M√™s Atual</option><option value="last">M√™s Anterior</option><option value="average">Ano Atual</option></select></div></div><div class="chart-container"><canvas id="category-chart"></canvas></div></div>
            <div class="card full-width"><div class="chart-title"><span>Fluxo de Caixa Mensal</span><div class="chart-title-actions"><select id="cashflow-chart-year"></select></div></div><div class="chart-container"><canvas id="cashflow-chart"></canvas></div></div>
            <div class="card"><div class="chart-title"><span>Fixos vs Vari√°veis (M√™s Atual)</span></div><div class="chart-container"><canvas id="fixed-variable-chart"></canvas></div></div>
            <div class="card"><div class="chart-title"><span>Tend√™ncia Gastos (6 meses)</span><div class="chart-title-actions"><select id="trend-chart-category"><option value="all" selected>Todas Categorias</option></select></div></div><div class="chart-container"><canvas id="trend-chart"></canvas></div></div>
        </div>
        <div class="card"><div class="chart-title">Transa√ß√µes Recentes</div><div class="cash-flow-items" id="recent-transactions"><div class="loading-placeholder">Carregando...</div></div></div>
    </div>
    <div class="tab-content" id="tab-transactions" style="display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;"><div style="display: flex; gap: 0.75rem; flex-wrap: wrap;"><select id="transactions-filter-year"></select><select id="transactions-filter-month"></select><select id="transactions-filter-type"><option value="all" selected>Todos Tipos</option><option value="income">Receitas</option><option value="expense">Despesas</option></select><select id="transactions-filter-category"><option value="all" selected>Todas Categorias</option></select><select id="transactions-filter-status"><option value="all" selected>Todos Status</option><option value="paid">Pago</option><option value="pending">Pendente</option><option value="scheduled">Agendado</option></select></div><div style="position: relative; min-width: 250px;"><input type="text" class="form-control" id="transactions-search" placeholder="Pesquisar transa√ß√µes..."></div></div>
        <div class="table-container"><table id="transactions-table"><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="transactions-table-body"><tr class="loading-placeholder"><td colspan="6">Carregando...</td></tr></tbody></table></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;"><div><span id="transactions-showing">Mostrando 0-0 de 0</span></div><div style="display: flex; gap: 0.5rem;"><button class="btn btn-icon" id="transactions-prev" disabled><svg width="16" height="16" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button><button class="btn btn-icon" id="transactions-next" disabled><svg width="16" height="16" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg></button></div></div>
    </div>
    <div class="tab-content" id="tab-budget" style="display: none;">
        <div class="charts-grid"><div class="card"><div class="chart-title">Or√ßamento vs Real (M√™s Atual)</div><div class="chart-container"><canvas id="budget-chart"></canvas></div></div><div class="card"><div class="chart-title">Progresso do Or√ßamento</div><div id="budget-progress-container"><div class="loading-placeholder">Carregando...</div></div></div></div>
        <div class="card"><div class="chart-title"><span>Planejamento de Or√ßamento</span><button class="btn btn-primary" id="btn-edit-budget"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Editar Or√ßamento</button></div><div class="table-container"><table id="budget-table"><thead><tr><th>Categoria</th><th>Or√ßamento</th><th>Gasto Atual</th><th>Restante</th><th>Progresso</th></tr></thead><tbody id="budget-table-body"><tr class="loading-placeholder"><td colspan="5">Carregando...</td></tr></tbody></table></div></div>
    </div>
    <div class="tab-content" id="tab-goals" style="display: none;">
        <div class="charts-grid"><div class="card" style="grid-column: span 2;"><div class="chart-title"><span>Progresso das Metas</span><button class="btn btn-primary" id="btn-add-goal"><svg width="16" height="16" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Nova Meta</button></div><div id="goals-container"><div class="loading-placeholder">Carregando...</div></div></div><div class="card"><div class="chart-title">Proje√ß√£o de Economia</div><div class="chart-container"><canvas id="savings-projection-chart"></canvas></div></div></div>
    </div>
    <div class="tab-content" id="tab-monthly" style="display: none;">
        <div class="month-nav"><button class="month-nav-arrow" id="prev-month"><svg width="16" height="16" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button><div class="month-selector"><select id="monthly-analysis-year"></select><select id="monthly-analysis-month"></select></div><button class="month-nav-arrow" id="next-month"><svg width="16" height="16" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg></button></div>
        <div class="month-summary"><div class="card"><div class="month-summary-title">Receitas Totais</div><div class="month-summary-value" id="monthly-income" style="color: var(--success);">R$ 0,00</div><div class="kpi-footer"><span id="monthly-income-count">0 transa√ß√µes</span></div></div><div class="card"><div class="month-summary-title">Despesas Totais</div><div class="month-summary-value" id="monthly-expense" style="color: var(--danger);">R$ 0,00</div><div class="kpi-footer"><span id="monthly-expense-count">0 transa√ß√µes</span></div></div><div class="card"><div class="month-summary-title">Saldo do M√™s</div><div class="month-summary-value" id="monthly-balance">R$ 0,00</div><div class="kpi-footer"><span id="monthly-balance-status">Equilibrado</span></div></div></div>
        <div class="charts-grid"><div class="card"><div class="chart-title">Principais Despesas</div><div class="chart-container"><canvas id="monthly-category-chart"></canvas></div></div><div class="card"><div class="chart-title">Distribui√ß√£o Di√°ria</div><div class="chart-container"><canvas id="monthly-daily-chart"></canvas></div></div></div>
        <div class="card" style="margin-bottom: 2rem;"><div class="chart-title"><span>Lista de Receitas</span><button class="btn btn-success" id="btn-add-income"><svg width="16" height="16" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Nova Receita</button></div><div id="monthly-income-list" class="month-transactions"><div class="loading-placeholder">Carregando...</div></div></div>
        <div class="card"><div class="chart-title"><span>Lista de Despesas</span><button class="btn btn-danger" id="btn-add-expense"><svg width="16" height="16" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Nova Despesa</button></div><div id="monthly-expense-list" class="month-transactions"><div class="loading-placeholder">Carregando...</div></div></div>
    </div>
    <div class="tab-content" id="tab-categories" style="display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;"><h2 style="font-size: 1.5rem; margin: 0;">Gerenciamento de Categorias</h2><div><button class="btn btn-primary" id="btn-add-category"><svg width="16" height="16" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Nova Categoria</button></div></div>
        <div class="card" style="margin-bottom: 2rem;"><div class="chart-title">Categorias de Receita</div><div id="income-categories-list"><div class="loading-placeholder">Carregando...</div></div></div>
        <div class="card"><div class="chart-title">Categorias de Despesa</div><div id="expense-categories-list"><div class="loading-placeholder">Carregando...</div></div></div>
    </div>
    <div class="tab-content" id="tab-reports" style="display: none;">
        <div class="charts-grid"><div class="card"><div class="chart-title"><span>Relat√≥rio Mensal</span><div class="chart-title-actions"><select id="report-year"></select><select id="report-month"></select><button class="btn btn-primary" id="btn-export-report"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>Exportar</button></div></div><div id="monthly-report-container"><div class="loading-placeholder">Selecione para gerar.</div></div></div><div class="card"><div class="chart-title"><span>An√°lise de Gastos</span><div class="chart-title-actions"><select id="analysis-type"><option value="category">Por Categoria</option><option value="monthly">Mensal</option><option value="yearly">Anual</option></select></div></div><div class="chart-container"><canvas id="analysis-chart"></canvas></div></div></div>
    </div>

    <!-- Modais (Estrutura HTML Mantida) -->
    <div class="modal" id="transaction-modal"> <div class="modal-content"> <div class="modal-header"><h3 class="modal-title" id="transaction-modal-title">Nova Transa√ß√£o</h3><button class="modal-close" id="transaction-modal-close">√ó</button></div><div class="modal-body"><form id="transaction-form"><input type="hidden" id="transaction-id"><div class="form-grid"><div class="form-group"><label for="transaction-type">Tipo</label><select class="form-control" id="transaction-type" required><option value="expense">Despesa</option><option value="income">Receita</option></select></div><div class="form-group"><label for="transaction-date">Data</label><input type="date" class="form-control" id="transaction-date" required></div></div><div class="form-group"><label for="transaction-description">Descri√ß√£o</label><input type="text" class="form-control" id="transaction-description" placeholder="Ex: Sal√°rio..." required></div><div class="form-grid"><div class="form-group"><label for="transaction-amount">Valor (R$)</label><input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required></div><div class="form-group"><label for="transaction-category">Categoria</label><select class="form-control" id="transaction-category" required><option value="">Carregando...</option></select></div></div><div class="form-grid"><div class="form-group"><label for="transaction-status">Status</label><select class="form-control" id="transaction-status" required><option value="paid">Pago</option><option value="pending">Pendente</option><option value="scheduled">Agendado</option></select></div><div class="form-group"><label for="transaction-payment-method">Forma Pagamento</label><select class="form-control" id="transaction-payment-method"><option value="">Selecione...</option><option value="cash">Dinheiro</option><option value="credit_card">Cart√£o Cr√©dito</option><option value="debit_card">Cart√£o D√©bito</option><option value="bank_transfer">Transfer√™ncia</option><option value="pix">PIX</option><option value="other">Outro</option></select></div></div><div class="form-group"><label for="transaction-notes">Observa√ß√µes</label><textarea class="form-control" id="transaction-notes" rows="3"></textarea></div><div id="recurring-transaction-container"><div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;"><input type="checkbox" id="transaction-recurring" style="width: auto;"><label for="transaction-recurring" style="margin-bottom: 0;">Recorrente</label></div><div id="recurring-options" style="display: none; margin-top: 1rem;"><div class="form-grid"><div class="form-group"><label for="transaction-frequency">Frequ√™ncia</label><select class="form-control" id="transaction-frequency"><option value="weekly">Semanal</option><option value="biweekly">Quinzenal</option><option value="monthly" selected>Mensal</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="annual">Anual</option></select></div><div class="form-group"><label for="transaction-end-date">Data Fim (opc.)</label><input type="date" class="form-control" id="transaction-end-date"></div></div></div></div></form></div><div class="modal-footer"><button class="btn" id="transaction-modal-cancel">Cancelar</button><button class="btn btn-primary" id="transaction-modal-save">Salvar</button></div></div></div>
    <div class="modal" id="budget-modal"> <div class="modal-content"><div class="modal-header"><h3 class="modal-title">Editar Or√ßamento</h3><button class="modal-close" id="budget-modal-close">√ó</button></div><div class="modal-body"><form id="budget-form"><div class="form-group"><label for="budget-year">Ano</label><select class="form-control" id="budget-year" required></select></div><div class="form-group"><label for="budget-month">M√™s</label><select class="form-control" id="budget-month" required></select></div><div id="budget-categories-container"><div class="loading-placeholder">Carregando categorias...</div></div></form></div><div class="modal-footer"><button class="btn" id="budget-modal-cancel">Cancelar</button><button class="btn btn-primary" id="budget-modal-save">Salvar</button></div></div></div>
    <div class="modal" id="goal-modal"> <div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="goal-modal-title">Nova Meta</h3><button class="modal-close" id="goal-modal-close">√ó</button></div><div class="modal-body"><form id="goal-form"><input type="hidden" id="goal-id"><div class="form-group"><label for="goal-name">Nome da Meta</label><input type="text" class="form-control" id="goal-name" required></div><div class="form-grid"><div class="form-group"><label for="goal-target">Valor Alvo (R$)</label><input type="number" step="0.01" min="0.01" class="form-control" id="goal-target" required></div><div class="form-group"><label for="goal-current">Valor Atual (R$)</label><input type="number" step="0.01" min="0" class="form-control" id="goal-current" required></div></div><div class="form-grid"><div class="form-group"><label for="goal-date">Data Alvo</label><input type="date" class="form-control" id="goal-date" required></div><div class="form-group"><label for="goal-category">Tipo</label><select class="form-control" id="goal-category" required><option value="savings">Economia</option><option value="investment">Investimento</option><option value="debt">D√≠vida</option><option value="purchase">Compra</option><option value="travel">Viagem</option><option value="education">Educa√ß√£o</option><option value="other">Outro</option></select></div></div><div class="form-group"><label for="goal-notes">Observa√ß√µes</label><textarea class="form-control" id="goal-notes" rows="3"></textarea></div></form></div><div class="modal-footer"><button class="btn" id="goal-modal-cancel">Cancelar</button><button class="btn btn-primary" id="goal-modal-save">Salvar</button></div></div></div>
    <div class="modal" id="category-modal"> <div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="category-modal-title">Nova Categoria</h3><button class="modal-close" id="category-modal-close">√ó</button></div><div class="modal-body"><form id="category-form"><input type="hidden" id="category-id"><div class="form-group"><label for="category-name">Nome</label><input type="text" class="form-control" id="category-name" required></div><div class="form-group"><label for="category-type">Tipo</label><select class="form-control" id="category-type" required><option value="expense">Despesa</option><option value="income">Receita</option></select></div><div class="form-group"><label>Cor</label><div class="color-grid" id="color-grid"></div></div><div class="form-group"><label>√çcone</label><div class="icon-grid" id="icon-grid"></div></div></form></div><div class="modal-footer"><button class="btn" id="category-modal-cancel">Cancelar</button><button class="btn btn-primary" id="category-modal-save">Salvar</button></div></div></div>
    <div class="modal" id="transaction-details-modal"> <div class="modal-content"><div class="modal-header"><h3 class="modal-title">Detalhes da Transa√ß√£o</h3><button class="modal-close" id="transaction-details-modal-close">√ó</button></div><div class="modal-body"><div class="receipt" id="transaction-receipt"><div class="loading-placeholder">Carregando...</div></div></div><div class="modal-footer"><button class="btn btn-danger" id="transaction-details-delete">Excluir</button><button class="btn btn-primary" id="transaction-details-edit">Editar</button></div></div></div>
    <div class="modal" id="confirm-modal"> <div class="modal-content" style="max-width: 400px;"><div class="modal-header"><h3 class="modal-title" id="confirm-modal-title">Confirma√ß√£o</h3><button class="modal-close" id="confirm-modal-close">√ó</button></div><div class="modal-body"><p id="confirm-modal-message">Tem certeza?</p></div><div class="modal-footer"><button class="btn" id="confirm-modal-cancel">Cancelar</button><button class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button></div></div></div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loading">
      <div class="spinner"></div>
    </div>
  </div> <!-- Fim .container -->

  <!-- ======================= JAVASCRIPT CORRIGIDO ======================= -->
  <script>
    // ===== Configura√ß√µes e Vari√°veis Globais =====
    const root = document.documentElement;
    // Seletores DOM Globais (acessados frequentemente) - Definidos ap√≥s DOMContentLoaded
    let themeToggle = null;
    let themeIcon = null;
    let loading = null;
    let tabs = null;
    let tabContents = null;
    let transactionModal = null;
    let transactionForm = null;
    let budgetModal = null;
    let goalModal = null;
    let categoryModal = null;
    let transactionDetailsModal = null;
    let confirmModal = null;
    let btnNewTransaction = null;
    let btnEditBudget = null;
    let btnAddGoal = null;
    let btnAddCategory = null;
    let btnAddIncome = null;
    let btnAddExpense = null;

    // Estados da Aplica√ß√£o (Arrays que guardam os dados carregados)
    let transactions = [];
    let categories = [];
    let budgets = [];
    let goals = [];
    let currentTab = 'overview'; // Aba inicial padr√£o

    // Inst√¢ncias dos Gr√°ficos (para poder destruir/atualizar)
    let incomeExpenseChart = null;
    let categoryChart = null;
    let cashflowChart = null;
    let fixedVariableChart = null;
    let trendChart = null;
    let budgetChart = null;
    let savingsProjectionChart = null;
    let analysisChart = null;
    let monthlyCategoryChart = null;
    let monthlyDailyChart = null;
    let reportPieChart = null;

    // Pagina√ß√£o da Tabela de Transa√ß√µes
    let currentTransactionsPage = 1;
    const transactionsPerPage = 10;
    let currentFilteredTransactions = []; // Cache dos resultados filtrados para pagina√ß√£o

    // Configura√ß√µes e Constantes (Definidas para refer√™ncia, se necess√°rio)
    const TRANSACTION_TYPES = {
        income: { name: 'Receita', color: 'var(--success)' },
        expense: { name: 'Despesa', color: 'var(--danger)' }
    };
    const AVAILABLE_COLORS = ['#FF453A', '#FF9F0A', '#FFD60A', '#30D158', '#64D2FF', '#0A84FF', '#5E5CE6', '#BF5AF2', '#FF375F', '#AC8E68', '#A0A0A0', '#8E8E93']; // Adicionei um cinza diferente
    const AVAILABLE_ICONS = ['üí∞', 'üí≥', 'üè†', 'üçî', 'üöó', 'üè•', 'üéÆ', 'üìö', 'üõçÔ∏è', 'üìù', '‚ö†Ô∏è', '‚úàÔ∏è', 'üë™', 'üéµ', 'üíª', 'üì±', 'üßæ', 'üéÅ', 'üí°', 'üéì', '‚õΩ', 'üè¶', 'üëï', 'üçé', 'üèãÔ∏è', 'üîß', 'üìä', 'üíº', 'üí≤', 'üé≠', 'üè¢', 'üöø', 'üì∫', '‚òï', 'üßπ', 'üíä', 'üë∂', 'üê∂', 'üíß', 'üõí'];
    const PAYMENT_METHODS = { 'cash': 'Dinheiro', 'credit_card': 'Cart√£o Cr√©dito', 'debit_card': 'Cart√£o D√©bito', 'bank_transfer': 'Transfer√™ncia', 'pix': 'PIX', 'other': 'Outro' };
    const TRANSACTION_STATUS = { 'paid': { name: 'Pago', class: 'status-paid' }, 'pending': { name: 'Pendente', class: 'status-pending' }, 'scheduled': { name: 'Agendado', class: 'status-scheduled' }, 'overdue': { name: 'Atrasado', class: 'status-overdue' } }; // Adicionei Atrasado se precisar

    // ===== Firebase Integration =====
    let db; // Inst√¢ncia do Firestore
    let firestore; // Objeto com fun√ß√µes do Firestore
    let isFirebaseReady = false; // Flag para controlar se o Firebase inicializou

    // Espera o evento personalizado 'firebaseReady' ser disparado pelo script type="module"
    function waitForFirebase() {
        return new Promise((resolve, reject) => {
             if (window.db && window.firestore) {
                 console.log("Firebase j√° estava pronto.");
                 db = window.db;
                 firestore = window.firestore;
                 isFirebaseReady = true;
                 resolve();
                 return;
             }
             // Adiciona listener para o evento personalizado
            const firebaseReadyListener = () => {
                 console.log("Evento 'firebaseReady' recebido.");
                 if (window.db && window.firestore) {
                     db = window.db;
                     firestore = window.firestore;
                     isFirebaseReady = true;
                     window.removeEventListener('firebaseReady', firebaseReadyListener); // Limpa o listener
                     resolve();
                 } else {
                     console.error("'firebaseReady' disparado, mas window.db ou window.firestore n√£o definidos!");
                     reject(new Error("Falha na inicializa√ß√£o do Firebase no m√≥dulo."));
                 }
            };
            window.addEventListener('firebaseReady', firebaseReadyListener);
             console.log("Aguardando evento 'firebaseReady'...");

            // Timeout de seguran√ßa
            setTimeout(() => {
                if (!isFirebaseReady) {
                    window.removeEventListener('firebaseReady', firebaseReadyListener);
                    console.error("Timeout esperando pelo Firebase.");
                     reject(new Error("Timeout esperando pelo Firebase. Verifique a configura√ß√£o do m√≥dulo e a conex√£o."));
                 }
            }, 10000); // Espera 10 segundos
         });
    }


    // --- Fun√ß√µes CRUD Firebase ---
    async function saveTransactionToFirestore(transaction) {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        const transactionData = { ...transaction };
        const firestoreId = transactionData.firestoreId;
        delete transactionData.firestoreId;
        // Garante que dados num√©ricos sejam salvos como n√∫meros
        transactionData.amount = Number(transactionData.amount) || 0;

        try {
            showLoading();
            const transactionsRef = firestore.collection(db, 'transactions');
            let docId;
            if (firestoreId) {
                await firestore.updateDoc(firestore.doc(db, 'transactions', firestoreId), transactionData);
                docId = firestoreId;
            } else {
                const docRef = await firestore.addDoc(transactionsRef, transactionData);
                docId = docRef.id;
            }
            hideLoading();
            return docId;
        } catch (error) {
            console.error('Erro Firebase (saveTransaction):', error); hideLoading();
            showAlert(`Erro ao salvar transa√ß√£o${error.code ? ` (${error.code})` : ''}. Verifique permiss√µes/conex√£o.`, 'danger');
            throw error;
        }
    }

    async function loadTransactionsFromFirestore() {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        try {
            showLoading();
            const transactionsRef = firestore.collection(db, 'transactions');
            const snapshot = await firestore.getDocs(transactionsRef);
            const loadedTransactions = snapshot.docs.map(doc => ({
                ...doc.data(),
                amount: Number(doc.data().amount) || 0, // Garante que amount seja n√∫mero
                firestoreId: doc.id
            }));
            hideLoading();
            return loadedTransactions;
        } catch (error) {
            console.error('Erro Firebase (loadTransactions):', error); hideLoading();
            showAlert('Erro ao carregar transa√ß√µes. Verifique permiss√µes/conex√£o.', 'danger');
            return [];
        }
    }

    async function deleteTransactionFromFirestore(firestoreId) {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        if (!firestoreId) throw new Error("ID inv√°lido para exclus√£o.");
        try {
            showLoading();
            await firestore.deleteDoc(firestore.doc(db, 'transactions', firestoreId));
            hideLoading();
            return true;
        } catch (error) {
            console.error('Erro Firebase (deleteTransaction):', error); hideLoading();
            showAlert('Erro ao excluir transa√ß√£o. Verifique permiss√µes/conex√£o.', 'danger');
            return false;
        }
    }

     // ... (Fun√ß√µes saveCategoryToFirestore, loadCategoriesFromFirestore, deleteCategoryFromFirestore,
     //      saveBudgetToFirestore, loadBudgetsFromFirestore, getBudgetForMonthAndYear,
     //      saveGoalToFirestore, loadGoalsFromFirestore, deleteGoalFromFirestore)
     //      Mantidas como estavam nos blocos anteriores, mas adicionando a verifica√ß√£o isFirebaseReady no in√≠cio.

     async function saveCategoryToFirestore(category) {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        const categoryData = { ...category }; const firestoreId = categoryData.firestoreId; delete categoryData.firestoreId;
        try {
            showLoading(); const categoriesRef = firestore.collection(db, 'categories'); let docId;
            if (firestoreId) { await firestore.updateDoc(firestore.doc(db, 'categories', firestoreId), categoryData); docId = firestoreId; }
            else {
                const q = firestore.query(categoriesRef, firestore.where('id', '==', category.id)); const existingSnapshot = await firestore.getDocs(q);
                if (!existingSnapshot.empty) { const existingDoc = existingSnapshot.docs[0]; await firestore.updateDoc(existingDoc.ref, categoryData); docId = existingDoc.id; }
                else { const docRef = await firestore.addDoc(categoriesRef, categoryData); docId = docRef.id; }
            }
            hideLoading(); return docId;
        } catch (error) { console.error('Erro Firebase (saveCategory):', error); hideLoading(); showAlert('Erro ao salvar categoria.', 'danger'); throw error; }
    }

    async function loadCategoriesFromFirestore() {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        try {
            showLoading(); const categoriesRef = firestore.collection(db, 'categories'); const snapshot = await firestore.getDocs(categoriesRef);
            let loadedCategories = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id })); hideLoading();
            if (loadedCategories.length === 0) {
                 const defaultCats = [
                     { id: 'housing', name: 'Moradia', color: '#FF9F0A', icon: 'üè†', type: 'expense' }, { id: 'food', name: 'Alimenta√ß√£o', color: '#30D158', icon: 'üçî', type: 'expense' },
                     { id: 'transportation', name: 'Transporte', color: '#0A84FF', icon: 'üöó', type: 'expense' }, { id: 'health', name: 'Sa√∫de', color: '#FF453A', icon: 'üè•', type: 'expense' },
                     { id: 'leisure', name: 'Lazer', color: '#BF5AF2', icon: 'üéÆ', type: 'expense' }, { id: 'education', name: 'Educa√ß√£o', color: '#5E5CE6', icon: 'üìö', type: 'expense' },
                     { id: 'shopping', name: 'Compras', color: '#FF375F', icon: 'üõçÔ∏è', type: 'expense' }, { id: 'bills', name: 'Contas', color: '#64D2FF', icon: 'üìù', type: 'expense' },
                     { id: 'unexpected', name: 'Inesperadas', color: '#FF2D55', icon: '‚ö†Ô∏è', type: 'expense' }, { id: 'other_expenses', name: 'Outras Despesas', color: '#A0A0A0', icon: 'üíº', type: 'expense' },
                     { id: 'salary', name: 'Sal√°rio', color: '#30D158', icon: 'üí∞', type: 'income' }, { id: 'bonus', name: 'B√¥nus', color: '#5E5CE6', icon: 'üéÅ', type: 'income' },
                     { id: 'investments', name: 'Investimentos', color: '#0A84FF', icon: 'üìä', type: 'income' }, { id: 'other_income', name: 'Outras Receitas', color: '#FF9F0A', icon: 'üí∏', type: 'income' }
                 ];
                loadedCategories = await createDefaultCategories(defaultCats);
            } return loadedCategories;
        } catch (error) { console.error('Erro Firebase (loadCategories):', error); hideLoading(); showAlert('Erro ao carregar categorias.', 'danger'); return []; }
    }

    async function deleteCategoryFromFirestore(firestoreId) {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado."); if (!firestoreId) throw new Error("ID inv√°lido.");
        try { showLoading(); await firestore.deleteDoc(firestore.doc(db, 'categories', firestoreId)); hideLoading(); return true; }
        catch (error) { console.error('Erro Firebase (deleteCategory):', error); hideLoading(); showAlert('Erro ao excluir categoria.', 'danger'); return false; }
    }

    async function saveBudgetToFirestore(budget) {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        const budgetData = { ...budget, categories: budget.categories.map(c => ({...c, amount: Number(c.amount) || 0})) }; // Garante amount num√©rico
        delete budgetData.firestoreId;
        try {
            showLoading(); const budgetsRef = firestore.collection(db, 'budgets');
            const q = firestore.query(budgetsRef, firestore.where('year', '==', budget.year), firestore.where('month', '==', budget.month));
            const querySnapshot = await firestore.getDocs(q); let docId;
            if (!querySnapshot.empty) { const docRef = querySnapshot.docs[0].ref; await firestore.updateDoc(docRef, budgetData); docId = docRef.id; }
            else { const docRef = await firestore.addDoc(budgetsRef, budgetData); docId = docRef.id; }
            hideLoading(); return docId;
        } catch (error) { console.error('Erro Firebase (saveBudget):', error); hideLoading(); showAlert('Erro ao salvar or√ßamento.', 'danger'); throw error; }
    }

    async function loadBudgetsFromFirestore() {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        try {
            showLoading(); const budgetsRef = firestore.collection(db, 'budgets'); const snapshot = await firestore.getDocs(budgetsRef);
            const loadedBudgets = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id })); hideLoading(); return loadedBudgets;
        } catch (error) { console.error('Erro Firebase (loadBudgets):', error); hideLoading(); showAlert('Erro ao carregar or√ßamentos.', 'danger'); return []; }
    }

     async function getBudgetForMonthAndYear(month, year) {
        const localBudget = budgets.find(b => b.month === month && b.year === year); if (localBudget) return localBudget;
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        try {
            const budgetsRef = firestore.collection(db, 'budgets');
            const q = firestore.query(budgetsRef, firestore.where('year', '==', year), firestore.where('month', '==', month));
            const querySnapshot = await firestore.getDocs(q);
            if (!querySnapshot.empty) { const d = querySnapshot.docs[0]; const data = { ...d.data(), firestoreId: d.id }; budgets.push(data); return data; }
            return null;
        } catch (error) { console.error('Erro Firebase (getBudget):', error); return null; }
    }

     async function saveGoalToFirestore(goal) {
         if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
         const goalData = { ...goal, targetAmount: Number(goal.targetAmount) || 0, currentAmount: Number(goal.currentAmount) || 0 }; // Garante num√©rico
         const firestoreId = goalData.firestoreId; delete goalData.firestoreId;
         try {
             showLoading(); const goalsRef = firestore.collection(db, 'goals'); let docId;
             if (firestoreId) { await firestore.updateDoc(firestore.doc(db, 'goals', firestoreId), goalData); docId = firestoreId; }
             else { const docRef = await firestore.addDoc(goalsRef, goalData); docId = docRef.id; }
             hideLoading(); return docId;
         } catch (error) { console.error('Erro Firebase (saveGoal):', error); hideLoading(); showAlert('Erro ao salvar meta.', 'danger'); throw error; }
     }

    async function loadGoalsFromFirestore() {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado.");
        try {
            showLoading(); const goalsRef = firestore.collection(db, 'goals'); const snapshot = await firestore.getDocs(goalsRef);
            const loadedGoals = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id })); hideLoading(); return loadedGoals;
        } catch (error) { console.error('Erro Firebase (loadGoals):', error); hideLoading(); showAlert('Erro ao carregar metas.', 'danger'); return []; }
    }

    async function deleteGoalFromFirestore(firestoreId) {
        if (!isFirebaseReady) throw new Error("Firestore n√£o inicializado."); if (!firestoreId) throw new Error("ID inv√°lido.");
        try { showLoading(); await firestore.deleteDoc(firestore.doc(db, 'goals', firestoreId)); hideLoading(); return true; }
        catch (error) { console.error('Erro Firebase (deleteGoal):', error); hideLoading(); showAlert('Erro ao excluir meta.', 'danger'); return false; }
    }

    async function createDefaultCategories(defaultCategoryList) {
        // Implementa√ß√£o movida para dentro de loadCategoriesFromFirestore para garantir que s√≥ rode se necess√°rio
        console.log("Criando categorias padr√£o no Firestore...");
        const savedCategories = []; showLoading();
        try {
            const categoriesRef = firestore.collection(db, 'categories');
            for (const category of defaultCategoryList) {
                const categoryToSave = { ...category, id: category.id || uuid.v4() };
                // Verifica novamente se j√° existe (precau√ß√£o extra)
                const q = firestore.query(categoriesRef, firestore.where('id', '==', categoryToSave.id));
                const existingSnapshot = await firestore.getDocs(q);
                if (existingSnapshot.empty) {
                    const docRef = await firestore.addDoc(categoriesRef, categoryToSave);
                    savedCategories.push({ ...categoryToSave, firestoreId: docRef.id });
                    console.log(`Categoria padr√£o "${category.name}" criada.`);
                } else {
                     const existingData = { ...existingSnapshot.docs[0].data(), firestoreId: existingSnapshot.docs[0].id };
                     savedCategories.push(existingData); // Adiciona a existente
                }
            }
        } catch (error) { console.error('Erro Firebase (createDefaultCategories):', error); showAlert('Erro ao criar categorias padr√£o.', 'danger');
        } finally { hideLoading(); }
        return savedCategories;
    }


    // ===== Utilit√°rios e Helpers =====
    function formatCurrency(value) {
        if (typeof value !== 'number') value = Number(value) || 0;
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    function formatDate(dateString) {
        if (!dateString) return '--'; // Retorna algo neutro
        try {
            // Tenta tratar como YYYY-MM-DD ou timestamp
            let date = new Date(dateString);
            // Verifica se a data √© v√°lida E se o ano √© razo√°vel (evita 1970 de timestamps inv√°lidos)
            if (isNaN(date.getTime()) || date.getUTCFullYear() < 1990) {
                 // Tenta interpretar como DD/MM/YYYY se o formato anterior falhou
                 const parts = dateString.split('/');
                 if (parts.length === 3) {
                     date = new Date(parts[2], parts[1] - 1, parts[0]);
                 }
            }
             if (isNaN(date.getTime())) return 'Inv√°lida';
             // Usa UTC para consist√™ncia
            const adjustedDate = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            return adjustedDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch (e) { console.error("Erro formatar data:", dateString, e); return 'Erro'; }
    }
    function formatDateForInput(dateString) {
        if (!dateString) return '';
        try {
            const date = new Date(dateString);
             if (isNaN(date.getTime())) return '';
             const year = date.getFullYear(); // Usa o ano local para input
             const month = String(date.getMonth() + 1).padStart(2, '0');
             const day = String(date.getDate()).padStart(2, '0');
             return `${year}-${month}-${day}`;
        } catch (e) { console.error("Erro formatar p/ input:", dateString, e); return ''; }
    }
    function showLoading() { if(loading) loading.classList.add('active'); }
    function hideLoading() { if(loading) loading.classList.remove('active'); }
    function showAlert(message, type = 'info', duration = 4000) {
        // Cria o container de alertas dinamicamente se n√£o existir
        const containerId = 'alert-container-dynamic';
        let container = document.getElementById(containerId);
        if (!container) {
            container = document.createElement('div');
            container.id = containerId;
            Object.assign(container.style, {
                position: 'fixed', bottom: '20px', right: '20px', zIndex: '10001',
                display: 'flex', flexDirection: 'column', gap: '10px', alignItems: 'flex-end'
            });
            document.body.appendChild(container);
        }

        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${type}`; // Usa classes CSS existentes
        Object.assign(alertElement.style, {
            opacity: '0', transform: 'translateX(110%)', transition: 'all 0.4s ease-out',
            cursor: 'pointer', minWidth: '280px', maxWidth: '450px',
            boxShadow: 'var(--shadow-dropdown)', display: 'flex', alignItems: 'center'
        });

        let iconSvg = ''; /* ... (l√≥gica do SVG mantida) ... */
         switch(type) {
             case 'success': iconSvg = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'; break;
             case 'warning': case 'danger': iconSvg = '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>'; break;
             default: iconSvg = '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>'; break;
         }

        alertElement.innerHTML = `
          <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.75rem;">${iconSvg}</svg>
          <div class="alert-content" style="flex-grow: 1;">${message}</div>
          <button class="alert-close-btn" style="background: none; border: none; color: inherit; cursor: pointer; margin-left: 1rem; font-size: 1.4em; line-height: 1; padding: 0 0.5rem;">√ó</button>
        `;
        container.appendChild(alertElement);

        requestAnimationFrame(() => { alertElement.style.opacity = '1'; alertElement.style.transform = 'translateX(0)'; });

        const removeAlert = () => {
            alertElement.style.opacity = '0'; alertElement.style.transform = 'translateX(110%)';
            setTimeout(() => {
                if (alertElement.parentNode === container) container.removeChild(alertElement);
                if (container && container.children.length === 0 && container.parentNode === document.body) document.body.removeChild(container);
            }, 400);
        };
        const timeoutId = setTimeout(removeAlert, duration);
        alertElement.addEventListener('click', () => { clearTimeout(timeoutId); removeAlert(); });
    }
    function formatNumber(num, digits = 1) { const n = Number(num); return isNaN(n) ? 'N/A' : n.toFixed(digits); }
    function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }

    // ===== L√≥gica de Tema =====
    function updateThemeIcon(theme) { /* ... (implementa√ß√£o mantida) ... */ }
    function setupTheme() { /* ... (implementa√ß√£o mantida) ... */ }

    // ===== Gerenciamento de Dados e C√°lculos =====
    function populateYearSelects() { /* ... (implementa√ß√£o mantida) ... */ }
    function populateMonthSelects() { /* ... (implementa√ß√£o mantida) ... */ }
    function filterTransactions(filters = {}) { /* ... (implementa√ß√£o mantida) ... */ }
    function getFinanceSummary(filteredTransactions) { /* ... (implementa√ß√£o mantida) ... */ }
    function getExpensesByCategory(filteredTransactions) { /* ... (implementa√ß√£o mantida) ... */ }
    function getIncomeVsExpensesByMonth(numberOfMonths = 12) { /* ... (implementa√ß√£o mantida) ... */ }
    function getCashFlowData(year) { /* ... (implementa√ß√£o mantida) ... */ }
    async function getCurrentBudget() { /* ... (implementa√ß√£o mantida e corrigida) ... */ }
    function getCurrentExpensesByCategory() { /* ... (implementa√ß√£o mantida) ... */ }
    function calculateGoalProgress(goal) { /* ... (implementa√ß√£o mantida) ... */ }

    // ===== Inicializa√ß√£o e Manipula√ß√£o de Componentes =====
    function initFilters() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateCategorySelects() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateCategorySelectForForm() { /* ... (implementa√ß√£o mantida) ... */ }
    function initModals() { /* ... (implementa√ß√£o mantida) ... */ }
    function initColorGrid() { /* ... (implementa√ß√£o mantida) ... */ }
    function initIconGrid() { /* ... (implementa√ß√£o mantida) ... */ }
    function selectColorOrIcon(itemElement, itemSelector) { /* ... (implementa√ß√£o mantida) ... */ }
    function openModal(modalElement) { /* ... (implementa√ß√£o mantida) ... */ }
    function closeModal(modalElement) { /* ... (implementa√ß√£o mantida) ... */ }
    function openTransactionModal(transaction = null, defaultType = null) { /* ... (implementa√ß√£o mantida) ... */ }
    async function saveTransaction() { /* ... (implementa√ß√£o mantida) ... */ }
    async function openBudgetModal() { /* ... (implementa√ß√£o mantida) ... */ }
    async function populateBudgetModalCategories() { /* ... (implementa√ß√£o mantida) ... */ }
    async function saveBudget() { /* ... (implementa√ß√£o mantida) ... */ }
    function openGoalModal(goal = null) { /* ... (implementa√ß√£o mantida) ... */ }
    async function saveGoal() { /* ... (implementa√ß√£o mantida) ... */ }
    function openCategoryModal(category = null) { /* ... (implementa√ß√£o mantida) ... */ }
    async function saveCategory() { /* ... (implementa√ß√£o mantida) ... */ }

    // ===== Inicializa√ß√£o e Atualiza√ß√£o de Gr√°ficos =====
    function destroyChart(chartInstance) { /* ... (implementa√ß√£o mantida) ... */ }
    function getChartCommonOptions() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateIncomeExpenseChart() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateCategoryChart() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateCashFlowChart() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateFixedVariableChart() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateTrendChart() { /* ... (implementa√ß√£o mantida) ... */ }
    async function updateBudgetChart() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateSavingsProjectionChart() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateAnalysisChart() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateMonthlyAnalysisCharts() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateReportPieChart() { /* ... (implementa√ß√£o mantida) ... */ }
    async function initCharts() { /* ... (implementa√ß√£o mantida) ... */ }
    async function updateCharts() { /* ... (implementa√ß√£o mantida) ... */ }

    // ===== Interface e Intera√ß√£o =====
    function initTabs() { /* ... (implementa√ß√£o mantida e corrigida) ... */ }
    function updateKPIs() { /* ... (implementa√ß√£o mantida) ... */ }
    async function updateProjectionStatus(projectedExpenses, filterYear, filterMonth) { /* ... (implementa√ß√£o mantida) ... */ }
    function updateRecentTransactions() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateTransactionsTable() { /* ... (implementa√ß√£o mantida) ... */ }
    async function updateBudgetTab() { /* ... (implementa√ß√£o mantida) ... */ }
    async function updateBudgetProgress() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateGoalsTab() { /* ... (implementa√ß√£o mantida) ... */ }
    function openUpdateGoalBalanceModal(goal) { /* ... (implementa√ß√£o mantida) ... */ }
    async function updateGoalBalance(goalId, newAmount) { /* ... (implementa√ß√£o mantida) ... */ }
    function updateMonthlyAnalysis() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateMonthlyTransactionLists(monthTransactions) { /* ... (implementa√ß√£o mantida) ... */ }
    function navigateToPreviousMonth() { /* ... (implementa√ß√£o mantida) ... */ }
    function navigateToNextMonth() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateCategoriesTab() { /* ... (implementa√ß√£o mantida) ... */ }
    function updateReportsTab() { /* ... (implementa√ß√£o mantida) ... */ }
    function generateMonthlyReport() { /* ... (implementa√ß√£o mantida) ... */ }
    function exportMonthlyReport() { /* ... (implementa√ß√£o mantida) ... */ }
    async function showTransactionDetails(transactionId) { /* ... (implementa√ß√£o mantida) ... */ }
    function confirmDeleteTransaction(transactionId) { /* ... (implementa√ß√£o mantida) ... */ }
    async function deleteTransaction(transactionId) { /* ... (implementa√ß√£o mantida) ... */ }
    function confirmDeleteCategory(categoryId) { /* ... (implementa√ß√£o mantida) ... */ }
    async function deleteCategory(categoryId) { /* ... (implementa√ß√£o mantida) ... */ }
    function confirmDeleteGoal(goalId) { /* ... (implementa√ß√£o mantida) ... */ }
    async function deleteGoal(goalId) { /* ... (implementa√ß√£o mantida) ... */ }

    // ===== L√≥gica Principal da Aplica√ß√£o =====
    async function updateDashboard() {
        // Apenas atualiza KPIs e a tab atual para otimizar
        console.log(`Atualizando dashboard (Tab: ${currentTab})...`);
        showLoading();
        try {
            updateKPIs();
            // Atualiza gr√°ficos relevantes para a vis√£o geral ou a tab atual
            if (currentTab === 'overview') {
                await updateCharts(); // Atualiza todos na overview
                updateRecentTransactions();
            } else {
                // Atualiza apenas o necess√°rio para a tab espec√≠fica
                 switch (currentTab) {
                    case 'transactions': updateTransactionsTable(); break;
                    case 'budget': await updateBudgetTab(); break;
                    case 'goals': updateGoalsTab(); updateSavingsProjectionChart(); break; // Atualiza proje√ß√£o tbm
                    case 'monthly': updateMonthlyAnalysis(); break; // J√° atualiza seus gr√°ficos
                    case 'categories': updateCategoriesTab(); break;
                    case 'reports': updateReportsTab(); break; // J√° atualiza seus gr√°ficos
                }
            }
            console.log("Dashboard atualizado.");
        } catch (error) { console.error("Erro updateDashboard:", error); showAlert("Erro ao atualizar dados.", "danger");
        } finally { hideLoading(); }
    }

    // ===== Inicializa√ß√£o da Aplica√ß√£o =====
    async function init() {
        console.log("App Init: Iniciando...");
        showLoading();
        moment.locale('pt-br');

        // 1. Seleciona elementos DOM
        themeToggle = document.getElementById('theme-toggle');
        themeIcon = document.getElementById('theme-icon');
        loading = document.getElementById('loading');
        tabs = document.querySelectorAll('.tab');
        tabContents = document.querySelectorAll('.tab-content');
        transactionModal = document.getElementById('transaction-modal');
        transactionForm = document.getElementById('transaction-form');
        budgetModal = document.getElementById('budget-modal');
        goalModal = document.getElementById('goal-modal');
        categoryModal = document.getElementById('category-modal');
        transactionDetailsModal = document.getElementById('transaction-details-modal');
        confirmModal = document.getElementById('confirm-modal');
        btnNewTransaction = document.getElementById('btn-new-transaction');
        btnEditBudget = document.getElementById('btn-edit-budget');
        btnAddGoal = document.getElementById('btn-add-goal');
        btnAddCategory = document.getElementById('btn-add-category');
        btnAddIncome = document.getElementById('btn-add-income');
        btnAddExpense = document.getElementById('btn-add-expense');

        // Verifica elementos cruciais
        if (!themeToggle || !loading || !tabs.length || !btnNewTransaction || !document.body) {
             console.error("Erro Cr√≠tico: Elementos essenciais da UI n√£o encontrados!");
             hideLoading();
             document.body.innerHTML = "<p style='color:red; padding: 2em;'>Erro ao carregar a interface. Recarregue.</p>";
             return;
        }
        console.log("App Init: Elementos DOM selecionados.");

        try {
            // 2. Configura tema
            setupTheme();
            themeToggle.addEventListener('click', () => {
                const newTheme = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                root.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme); updateCharts();
            });
            console.log("App Init: Tema configurado.");

            // 3. Espera Firebase (agora espera o evento)
            await waitForFirebase();
            console.log("App Init: Firebase pronto.");

            // 4. Carrega dados
            categories = await loadCategoriesFromFirestore();
            transactions = await loadTransactionsFromFirestore();
            budgets = await loadBudgetsFromFirestore();
            goals = await loadGoalsFromFirestore();
            console.log("App Init: Dados carregados.");

            // 5. Popula Selects
            populateYearSelects();
            populateMonthSelects();
            console.log("App Init: Selects populados.");

            // 6. Inicializa Filtros (adiciona listeners)
            initFilters();
            console.log("App Init: Filtros inicializados.");

            // 7. Inicializa Modais (adiciona listeners)
            initModals();
            console.log("App Init: Modais inicializados.");

            // 8. Inicializa Gr√°ficos (cria inst√¢ncias)
            await initCharts();
            console.log("App Init: Gr√°ficos inicializados.");

            // 9. Inicializa Tabs (adiciona listeners e ativa a primeira)
            initTabs();
            console.log("App Init: Tabs inicializadas.");

            // A ativa√ß√£o da tab inicial em initTabs() j√° dispara a primeira renderiza√ß√£o completa.

            console.log("Aplica√ß√£o inicializada com SUCESSO!");

        } catch (error) {
            console.error("Erro CR√çTICO durante a inicializa√ß√£o:", error);
            showAlert(`Falha grave ao inicializar: ${error.message}. Recarregue a p√°gina.`, "danger", 30000);
        } finally {
            hideLoading(); // Garante que o loading saia
        }
    }

    // Ponto de Entrada: Inicia quando o DOM est√° pronto
    document.addEventListener('DOMContentLoaded', init);

  </script>
  <!-- ================= FIM DO JAVASCRIPT CORRIGIDO ====================== -->

</body>
</html>
