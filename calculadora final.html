<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Familiar Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <style>
    /* ===== Variáveis e Temas (Estilo Apple/Google) ===== */
    :root {
      --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem; /* 12px */
      --radius: 1.125rem; /* 18px */
      --radius-lg: 1.5rem; /* 24px */
      --shadow: 0 4px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.09), 0 2px 6px rgba(0,0,0,0.07);
      --shadow-dropdown: 0 5px 20px rgba(0,0,0,0.12);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

      /* Cores Light */
      --bg: #F9F9FB; /* Slightly off-white */
      --bg-rgb: 249, 249, 251; /* Para usar com opacidade */
      --card-bg: #FFFFFF;
      --input-bg: rgba(118, 118, 128, 0.12); /* System Gray 5 (0.12 alpha) */
      --text: #1C1C1E; /* Almost Black */
      --text-secondary: #8A8A8E; /* System Gray */
      --primary: #007AFF; /* Blue */
      --primary-light: #5856D6; /* Indigo for accents if needed */
      --success: #34C759; /* Green */
      --warning: #FF9500; /* Orange */
      --danger: #FF3B30; /* Red */
      --info: #5AC8FA; /* Teal */
      --border: rgba(60, 60, 67, 0.15); /* Lighter border */
      --chart-grid: rgba(60, 60, 67, 0.08); /* Lighter grid */
      --menu-bg: rgba(255, 255, 255, 0.9); /* More opaque */
      --insight-bg: rgba(0, 122, 255, 0.06); /* Subtler blue */
      --importance-extrema: #FF3B30; /* Red */
      --importance-urgente: #FF9500; /* Orange */
      --importance-importante: #FFCC00; /* Yellow */
      --hover-bg: rgba(0, 0, 0, 0.03); /* Subtle hover */
    }

    [data-theme="dark"] {
      /* Cores Dark */
      --bg: #000000; /* True Black for OLED */
      --bg-rgb: 0, 0, 0; /* Para usar com opacidade */
      --card-bg: #1C1C1E; /* Gray 6 */
      --input-bg: rgba(118, 118, 128, 0.24); /* System Gray 5 (0.24 alpha) */
      --text: #FFFFFF;
      --text-secondary: #8E8E93; /* Gray */
      --primary: #0A84FF; /* Blue */
      --primary-light: #5E5CE6; /* Indigo */
      --success: #30D158; /* Green */
      --warning: #FF9F0A; /* Orange */
      --danger: #FF453A; /* Red */
      --info: #64D2FF; /* Teal */
      --border: rgba(84, 84, 88, 0.35); /* Lighter border */
      --chart-grid: rgba(84, 84, 88, 0.15); /* Lighter grid */
      --menu-bg: rgba(28, 28, 30, 0.9); /* More opaque */
      --insight-bg: rgba(10, 132, 255, 0.12); /* Subtler blue */
      --importance-extrema: #FF453A; /* Red */
      --importance-urgente: #FF9F0A; /* Orange */
      --importance-importante: #FFD60A; /* Yellow */
      --hover-bg: rgba(255, 255, 255, 0.05); /* Subtle hover */
    }

    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
    html { font-size: 16px; }
    body { font-family: var(--font-sans); background: var(--bg); color: var(--text); transition: background 0.3s ease, color 0.3s ease; line-height: 1.5; width: 100%; overflow-x: hidden;}

    /* ===== Layout e Componentes ===== */
    .container { max-width: 1360px; margin: 0 auto; padding: 2rem; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .header-title { display: flex; align-items: center; gap: 0.75rem; }
    h1 { font-size: 1.875rem; font-weight: 700; margin: 0; letter-spacing: -0.03em; }
    .header-right { display: flex; align-items: center; gap: 1rem; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 2rem; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;}
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 0.875rem 1.5rem; font-weight: 600; font-size: 0.9375rem; color: var(--text-secondary); cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; transition: var(--transition); margin-bottom: -1px; border-radius: 6px 6px 0 0; }
    .tab:hover { color: var(--text); background-color: var(--hover-bg); }
    .tab.active { color: var(--primary); border-color: var(--primary); background-color: var(--card-bg); }
    [data-theme="dark"] .tab.active { background-color: var(--card-bg); }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* KPIs Card */
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; transition: var(--transition); overflow: hidden; position: relative; }
    .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .kpi-card { display: flex; flex-direction: column; gap: 0.5rem; min-height: 150px; }
    .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
    .kpi-title { font-size: 0.9375rem; font-weight: 500; color: var(--text-secondary); }
    .kpi-icon { color: var(--text-secondary); opacity: 0.6; flex-shrink: 0; width: 22px; height: 22px; }
    .kpi-icon svg { display: block; width: 100%; height: 100%; }
    .kpi-value { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.02em; line-height: 1.2; margin-top: 0.25rem; }
    .kpi-footer { display: flex; align-items: center; gap: 0.5rem; margin-top: auto; padding-top: 0.75rem; font-size: 0.8125rem; color: var(--text-secondary); }
    .kpi-trend { display: flex; align-items: center; gap: 0.25rem; font-weight: 500; }
    .kpi-trend.up { color: var(--success); } .kpi-trend.down { color: var(--danger); } .kpi-trend.neutral { color: var(--text-secondary); }
    .kpi-trend svg { width: 14px; height: 14px; flex-shrink: 0; }
    .kpi-trend svg .up-path { fill: currentColor; stroke: none; }
    .kpi-trend svg .down-path { fill: currentColor; stroke: none; }
    .kpi-trend svg .neutral-path { stroke: currentColor; stroke-width: 2.5; fill: none; }

    /* Progress container/bar */
    .progress-container { width: 100%; height: 6px; background-color: var(--input-bg); border-radius: 3px; overflow: hidden; margin-top: 0.5rem; }
    .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; background-color: var(--primary); }
    .progress-bar.success { background-color: var(--success); } .progress-bar.warning { background-color: var(--warning); } .progress-bar.danger { background-color: var(--danger); }

    /* Gráficos */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .chart-container { position: relative; margin-top: 1rem; height: 280px; min-height: 280px; }
    .chart-title { font-size: 1.125rem; font-weight: 600; letter-spacing: -0.01em; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .chart-title-actions { display: flex; gap: 0.75rem; }
    .full-width { grid-column: 1 / -1; }
    .full-width .chart-container { height: 320px; min-height: 320px; }

    /* Análise Mensal - Filtros Atualizados */
    .analysis-header { display: flex; flex-wrap: wrap; gap: 1rem 1.5rem; align-items: flex-end; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    .filters { display: flex; flex-wrap: wrap; gap: 1rem 1.5rem; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .filter-group label { font-size: 0.8125rem; color: var(--text-secondary); font-weight: 500; padding-left: 0.25rem; }
    .category-filter-group { display: flex; gap: 0.5rem; align-items: center; }
    .category-filter-group select { min-width: 200px; }
    .btn-icon-small { padding: 0.5rem; min-width: auto; height: calc(1.5em + 1.5rem + 2px); background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
    .btn-icon-small:hover { background-color: var(--hover-bg); border-color: rgba(60, 60, 67, 0.4); }
    .btn-icon-small svg { width: 1rem; height: 1rem; flex-shrink: 0; }
    .btn-delete-category { color: var(--danger); }
    .btn-delete-category:hover { background-color: rgba(255, 59, 48, 0.1); }

    /* Indicadores */
    .analysis-indicators { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .indicator-card { background-color: var(--card-bg); border-radius: var(--radius); padding: 1.25rem; text-align: center; box-shadow: var(--shadow); transition: var(--transition); display: flex; flex-direction: column; justify-content: center; min-height: 120px; }
    .indicator-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .indicator-title { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .indicator-value { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.01em; line-height: 1.2; margin-bottom: 0.25rem; }
    .indicator-value.positive { color: var(--success); } .indicator-value.negative { color: var(--danger); } .indicator-value.neutral { color: var(--text); }
    .indicator-comparison { font-size: 0.75rem; color: var(--text-secondary); margin-top: auto; }

    /* Conteúdo Análise */
    .analysis-content { display: grid; grid-template-columns: 1fr 320px; gap: 2rem; }
    .analysis-main { display: flex; flex-direction: column; gap: 1.5rem; }
    .analysis-sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
    .insights-feed { background: var(--card-bg); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); }
    .insights-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--primary); }
    .insights-title svg { flex-shrink: 0; }
    .insights-list { display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem; }
    .insight-item { display: flex; gap: 0.75rem; padding: 0.75rem 1rem; background-color: var(--insight-bg); border-radius: var(--radius-sm); font-size: 0.875rem; align-items: flex-start; line-height: 1.4; border-left-width: 3px; border-left-style: solid; }
    .insight-icon { flex-shrink: 0; margin-top: 2px; font-size: 1rem; }
    .insight-item.alert { color: var(--danger); background-color: rgba(255, 59, 48, 0.08); border-left-color: var(--danger); }
    .insight-item.warning { color: var(--warning); background-color: rgba(255, 149, 0, 0.08); border-left-color: var(--warning); }
    .insight-item.success { color: var(--success); background-color: rgba(52, 199, 89, 0.08); border-left-color: var(--success); }
    .insight-item.info { color: var(--primary); background-color: rgba(0, 122, 255, 0.08); border-left-color: var(--primary); }
    .insight-item.neutral { color: var(--text-secondary); background-color: var(--input-bg); border-left-color: var(--text-secondary); }

    /* Transaction List Refined */
    .transaction-list-container { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0; display: flex; flex-direction: column; }
    .transaction-list-title { font-size: 1.125rem; font-weight: 600; padding: 1.5rem 1.5rem 1rem 1.5rem; flex-shrink: 0; border-bottom: 1px solid var(--border); }
    .transaction-list { display: flex; flex-direction: column; gap: 0px; max-height: 500px; overflow-y: auto; padding: 0 0.5rem 0 1.5rem; flex-grow: 1; }
    #analysis-no-transactions { padding: 2rem 1.5rem; text-align: center; color: var(--text-secondary); }
    .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 0.875rem 1rem 0.875rem 0; border-bottom: 1px solid var(--border); transition: background-color 0.15s ease; cursor: pointer; position: relative; }
    .transaction-item:last-child { border-bottom: none; }
    .transaction-item:hover { background-color: var(--hover-bg); border-radius: var(--radius-sm); }
    .transaction-item .delete-transaction-btn { display: none; position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); padding: 0.3rem; border-radius: 50%; background: var(--input-bg); border: 1px solid var(--border); cursor: pointer; color: var(--text-secondary); line-height: 0; transition: var(--transition); }
    .transaction-item:hover .delete-transaction-btn { display: inline-flex; align-items: center; justify-content: center; }
    .transaction-item .delete-transaction-btn:hover { background: rgba(255, 59, 48, 0.1); color: var(--danger); border-color: rgba(255, 59, 48, 0.2); }
    .transaction-item .delete-transaction-btn svg { width: 14px; height: 14px; }
    .transaction-item:hover .transaction-item-right { padding-right: 3rem; }
    .transaction-item-left { display: flex; align-items: center; gap: 1rem; flex-grow: 1; min-width: 0; }
    .transaction-icon { width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; color: #fff; }
    .transaction-info { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; gap: 0.1rem; }
    .transaction-description { font-weight: 500; font-size: 0.9375rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
    .transaction-category { font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.3; }
    .transaction-item-right { text-align: right; flex-shrink: 0; padding-left: 1rem; transition: padding-right 0.15s ease; }
    .transaction-amount { font-weight: 600; font-size: 0.9375rem; white-space: nowrap; display: flex; align-items: center; justify-content: flex-end; gap: 0.3rem; }
    .transaction-amount.income { color: var(--success); } .transaction-amount.expense { color: var(--danger); }
    .transaction-date { font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.1rem; }
    .transaction-importance { display: inline-block; width: 8px; height: 8px; border-radius: 50%; vertical-align: middle; flex-shrink: 0; }
    .transaction-importance.extrema { background-color: var(--importance-extrema); } .transaction-importance.urgente { background-color: var(--importance-urgente); } .transaction-importance.importante { background-color: var(--importance-importante); }

    /* Botões */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.9375rem; cursor: pointer; transition: var(--transition); border: none; color: #fff; background-color: var(--primary); text-decoration: none; white-space: nowrap; }
    .btn:hover { opacity: 0.85; transform: translateY(-1px); } .btn:active { transform: translateY(0); opacity: 0.75; } .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-primary { background-color: var(--primary); } .btn-success { background-color: var(--success); } .btn-warning { background-color: var(--warning); color: #333; } .btn-danger { background-color: var(--danger); }
    .btn-secondary { background-color: var(--input-bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background-color: var(--hover-bg); }
    .btn svg { width: 1rem; height: 1rem; flex-shrink: 0; }

    /* Theme Toggle */
    .theme-toggle { background: var(--input-bg); border: none; border-radius: 50%; width: 2.75rem; height: 2.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); transition: var(--transition); flex-shrink: 0; }
    .theme-toggle:hover { background-color: var(--hover-bg); }
    .theme-toggle svg { width: 1.25rem; height: 1.25rem; }

    /* Select */
    select { appearance: none; -webkit-appearance: none; padding: 0.75rem 2.25rem 0.75rem 1rem; height: calc(1.5em + 1.5rem + 2px); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238A8A8E' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E") no-repeat; background-position: right 0.875rem center; color: var(--text); font-family: var(--font-sans); font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: var(--transition); min-width: 120px; line-height: 1.5; }
    [data-theme="dark"] select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238E8E93' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E"); background-color: var(--card-bg); }
    select:hover { border-color: rgba(60, 60, 67, 0.4); }
    select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); }
    select option { background-color: var(--card-bg); color: var(--text); }

    /* Modal */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; padding: 1rem; }
    .modal.active { opacity: 1; pointer-events: all; }
    .modal-content { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 550px; max-height: calc(100vh - 4rem); overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; opacity: 0; }
    .modal.active .modal-content { opacity: 1; transform: scale(1) translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
    .modal-close { background: var(--input-bg); border: none; width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: var(--transition); flex-shrink: 0; }
    .modal-close:hover { background-color: var(--hover-bg); color: var(--text); }
    .modal-close svg { width: 1rem; height: 1rem; flex-shrink: 0; }
    .modal-body { padding: 1.75rem; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
    .modal-footer { padding: 1.25rem 1.75rem; display: flex; justify-content: flex-end; gap: 0.75rem; border-top: 1px solid var(--border); background-color: rgba(var(--bg-rgb), 0.8); flex-shrink: 0; backdrop-filter: blur(3px); }
    [data-theme="dark"] .modal-footer { background-color: rgba(var(--bg-rgb), 0.8); }

    /* Forms in Modal */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; } .form-grid.single-col { grid-template-columns: 1fr; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
    .form-control { width: 100%; padding: 0.875rem 1rem; font-size: 0.9375rem; height: calc(1.5em + 1.75rem + 2px); border-radius: var(--radius-sm); border: 1px solid var(--border); background-color: var(--input-bg); color: var(--text); transition: var(--transition); font-family: var(--font-sans); line-height: 1.5; }
    input[type="color"].form-control { padding: 0.25rem; height: calc(1.5em + 1.75rem + 2px); }
    input[type="date"].form-control { line-height: normal; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--card-bg); }
    textarea.form-control { line-height: 1.4; min-height: 80px; height: auto; }

    /* Transaction Modal */
    #transaction-modal .modal-content { max-width: 500px; }
    .input-group { display: flex; align-items: center; }
    .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; flex-grow: 1; height: calc(1.5em + 1.75rem + 2px); }
    .input-group-append { flex-shrink: 0; }
    .input-group-append .btn-icon-small { border-top-left-radius: 0; border-bottom-left-radius: 0; height: calc(1.5em + 1.75rem + 2px); margin-left: -1px; }
    #advanced-fields { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border); display: none; animation: slideDown 0.3s ease-out forwards; }
    #advanced-fields.visible { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); max-height: 0; overflow: hidden;} to { opacity: 1; transform: translateY(0); max-height: 1000px; overflow: visible;} }
    .btn-link { background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; font-size: 0.875rem; font-weight: 500; text-align: left; display: inline-flex; align-items: center; gap: 0.25rem; }
    .btn-link:hover { text-decoration: underline; } .btn-link svg { transition: transform 0.2s ease; }
    #advanced-fields.visible + .btn-link svg { transform: rotate(180deg); }
    .importance-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .importance-group input[type="radio"] { opacity: 0; position: fixed; width: 0; }
    .importance-group label { display: inline-block; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); font-size: 0.875rem; font-weight: 500; border-left-width: 4px; border-left-color: transparent; margin-bottom: 0; }
    .importance-group input[type="radio"]:checked + label { background-color: var(--primary); color: #fff; border-color: var(--primary); }
    .importance-group input[type="radio"]:focus-visible + label { box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); outline: none; }
    .importance-group label[for="importance-extrema"] { border-left-color: var(--importance-extrema); } .importance-group label[for="importance-urgente"] { border-left-color: var(--importance-urgente); } .importance-group label[for="importance-importante"] { border-left-color: var(--importance-importante); }
    .importance-group input[type="radio"]:checked + label[for="importance-extrema"] { background-color: var(--importance-extrema); border-color: var(--importance-extrema); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-urgente"] { background-color: var(--importance-urgente); border-color: var(--importance-urgente); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-importante"] { background-color: var(--importance-importante); border-color: var(--importance-importante); color: #333; }

    /* Category & Confirm Modals */
    #category-modal .modal-content { max-width: 400px; }
    #confirm-modal .modal-content { max-width: 450px; }
    #confirm-modal-message { margin-bottom: 1rem; line-height: 1.4; font-weight: 500; }
    #confirm-modal-extra-info { margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary); }
    #confirm-modal-extra-info label { display: block; margin-bottom: 0.75rem; cursor: pointer; }
    #confirm-modal-extra-info input[type="radio"] { margin-right: 0.5rem; accent-color: var(--primary); }

    /* Loading Indicator */
    .loading-indicator { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(3px); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .loading-indicator.active { opacity: 1; pointer-events: all; }
    .spinner { width: 2.5rem; height: 2.5rem; border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; }
    [data-theme="dark"] .spinner { border-color: rgba(255, 255, 255, 0.1); border-top-color: #aaa; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast Notifications */
    .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; }
    .toast { background-color: var(--card-bg); color: var(--text); padding: 0.875rem 1.25rem; border-radius: var(--radius-sm); box-shadow: var(--shadow-dropdown); display: flex; align-items: center; gap: 0.75rem; min-width: 250px; max-width: 400px; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000); border-left: 4px solid var(--primary); }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast-icon { font-size: 1.25rem; flex-shrink: 0; }
    .toast.success { border-left-color: var(--success); } .toast.warning { border-left-color: var(--warning); } .toast.danger { border-left-color: var(--danger); } .toast.info { border-left-color: var(--primary); }

    /* Responsividade */
    @media (max-width: 1200px) { .analysis-content { grid-template-columns: 1fr; } .analysis-sidebar { grid-row: 2; } }
    @media (max-width: 992px) { .container { padding: 1.5rem; } .header { flex-direction: column; align-items: flex-start; } .header-right { width: 100%; justify-content: space-between; } .charts-grid { grid-template-columns: 1fr; } .chart-container { height: 260px; } .full-width .chart-container { height: 300px; } .analysis-header, .filters { gap: 1rem; } }
    @media (max-width: 768px) { h1 { font-size: 1.625rem; } .kpis { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .analysis-indicators { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } .btn { padding: 0.625rem 1.25rem; font-size: 0.875rem; } select, .form-control, .btn-icon-small { height: calc(1.5em + 1.25rem + 2px); } select { padding: 0.625rem 2rem 0.625rem 0.875rem; font-size: 0.875rem; } .form-grid { grid-template-columns: 1fr; } .transaction-item { flex-direction: column; align-items: flex-start; gap: 0.25rem; padding: 0.75rem 0.75rem 0.75rem 0; } .transaction-item-left { width: 100%; } .transaction-item-right { text-align: left; margin-top: 0.25rem; width: 100%; display: flex; justify-content: space-between; align-items: center; padding-left: 0; } .transaction-list { padding: 0 0.5rem 0 1rem; } .modal-content { width: 95%; max-height: calc(100vh - 2rem); } .modal-body, .modal-header, .modal-footer { padding: 1.25rem; } .tabs { margin-bottom: 1.5rem; } .tab { padding: 0.75rem 1rem; font-size: 0.875rem; } .analysis-content { grid-template-columns: 1fr; gap: 1.5rem; } .analysis-sidebar { order: 1; } .analysis-main { order: 2; } }
    @media (max-width: 576px) { .container { padding: 1rem; } h1 { font-size: 1.5rem; } .kpis { grid-template-columns: 1fr; } .analysis-indicators { grid-template-columns: 1fr; } .header-right { flex-direction: column; align-items: stretch; gap: 0.75rem; } .analysis-header { padding-bottom: 1rem; margin-bottom: 1rem;} .filters { flex-direction: column; align-items: stretch; gap: 0.75rem; } .filter-group { width: 100%; } select { width: 100%; } .category-filter-group { width: 100%; } .category-filter-group select { flex-grow: 1; } .header-right .btn { width: 100%; } .theme-toggle { align-self: flex-end; margin-top: 0.5rem; } .importance-group { gap: 0.25rem; } .importance-group label { padding: 0.4rem 0.8rem; } .toast-container { right: 1rem; bottom: 1rem; left: 1rem; align-items: stretch; } .toast { width: 100%; } .transaction-description { font-size: 0.875rem;} .transaction-amount { font-size: 0.875rem;} .transaction-item:hover .transaction-item-right { padding-right: 2.5rem; } .transaction-item .delete-transaction-btn { right: 0.5rem; } }

    /* Print styles */
    @media print { body { background-color: #fff; color: #000; } .header, .tabs, .theme-toggle, .btn, .modal, .loading-indicator, .toast-container, .analysis-sidebar, .delete-transaction-btn { display: none !important; } .container { max-width: 100%; padding: 0; } .card, .kpi-card, .indicator-card, .transaction-list-container, .insights-feed { box-shadow: none; border: 1px solid #ddd; border-radius: 0; padding: 1rem; page-break-inside: avoid; background-color: #fff !important; } .kpis, .charts-grid, .analysis-indicators, .analysis-content, .analysis-main { grid-template-columns: 1fr !important; gap: 1rem; } canvas { max-width: 100%; } select { border: none; appearance: none; -webkit-appearance: none; padding-right: 1rem; background: none; } .transaction-item { border-bottom: 1px solid #eee; } .transaction-item:hover { background-color: transparent; margin: 0; padding: 1rem 0; border-radius: 0; } .transaction-item-right { padding-right: 0 !important; } :root { --text: #000; --text-secondary: #555; --success: #008000; --danger: #D00000; --primary: #0000FF; --warning: #FFA500; --bg: #fff; --card-bg: #fff; --input-bg: #eee; } .indicator-value.positive, .kpi-trend.up, .transaction-amount.income { color: var(--success) !important; } .indicator-value.negative, .kpi-trend.down, .transaction-amount.expense { color: var(--danger) !important; } .progress-bar { background-color: #ccc !important; } }

  </style>
</head>
<body>
    <!-- O HTML é idêntico à versão anterior, apenas com a adição do filtro de importância -->
     <!-- HTML Estrutural (Container, Header, Tabs, Tab Contents, Modais, Loading, Toast) -->
     <div class="container">
         <!-- Header -->
         <div class="header">
             <div class="header-title"><h1>Calculadora Financeira</h1></div>
             <div class="header-right">
                 <button class="btn btn-primary" id="btn-new-transaction">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                         <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                     </svg>
                     Nova Transação
                 </button>
                 <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema"><svg id="theme-icon"><!-- Icon --></svg></button>
             </div>
         </div>
         <!-- Tabs -->
         <div class="tabs">
             <div class="tab active" data-tab="overview">Visão Geral</div>
             <div class="tab" data-tab="analysis">Análise Mensal</div>
         </div>
         <!-- Conteúdo Tabs -->
         <div id="tab-contents">
              <!-- Aba Visão Geral -->
              <div class="tab-content active" id="tab-overview">
                 <div class="kpis" id="overview-kpis">
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Saldo Atual</div><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-wallet2" viewBox="0 0 16 16"><path d="M12.136.326A1.5 1.5 0 0 1 14 1.78V3h.5A1.5 1.5 0 0 1 16 4.5v7a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 11.5v-7A1.5 1.5 0 0 1 1.5 3H2V1.78a1.5 1.5 0 0 1 1.404-1.454l8.732 0zM13 3v-.22c0-.414-.18-.74-.368-.834l-8.646 0c-.188.094-.36.42-.36.834V3h9.374z"/><path d="M1 4.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5H1z"/></svg></div></div><div class="kpi-value" id="kpi-balance">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="balance-trend-indicator"><svg viewBox="0 0 24 24" width="14" height="14"><path class="neutral-path"></path></svg><span id="balance-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Receitas (Mês)</div><div class="kpi-icon" style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-arrow-up-circle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"/></svg></div></div><div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="income-trend-indicator"><svg viewBox="0 0 24 24" width="14" height="14"><path class="neutral-path"></path></svg><span id="income-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Despesas (Mês)</div><div class="kpi-icon" style="color: var(--danger);"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-arrow-down-circle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/></svg></div></div><div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="expenses-trend-indicator"><svg viewBox="0 0 24 24" width="14" height="14"><path class="neutral-path"></path></svg><span id="expenses-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Economia do Mês</div><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-piggy-bank" viewBox="0 0 16 16"><path d="M5 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0zm1.138-1.496A6.613 6.613 0 0 1 7.964 4.5c.666 0 1.303.097 1.893.273a.5.5 0 0 0 .286-.958A7.602 7.602 0 0 0 7.964 3.5c-.734 0-1.441.103-2.102.292a.5.5 0 1 0 .276.962z"/><path fill-rule="evenodd" d="M7.964 1.527c-2.977 0-5.571 1.704-6.32 4.125h-.55A1 1 0 0 0 .11 6.824l.254 1.46a1.5 1.5 0 0 0 1.478 1.243h.263c.3.513.688.978 1.145 1.382l-.729 2.477a.5.5 0 0 0 .48.641h2a.5.5 0 0 0 .471-.332l.482-1.351c.635.173 1.31.267 2.011.267.707 0 1.388-.095 2.028-.272l.543 1.372a.5.5 0 0 0 .465.316h2a.5.5 0 0 0 .478-.645l-.761-2.506C13.81 9.895 14.5 8.559 14.5 7.069c0-.145-.007-.29-.02-.431.261-.11.508-.266.705-.444.315.306.815.306.815-.417 0 .223-.5.223-.461-.026a.95.95 0 0 0 .09-.255.7.7 0 0 0-.202-.645.58.58 0 0 0-.707-.098.735.735 0 0 0-.375.562c-.024.243.082.48.32.654a2.112 2.112 0 0 1-.259.153c-.534-2.664-3.284-4.595-6.442-4.595zM2.516 6.26c.455-2.066 2.667-3.733 5.448-3.733 3.146 0 5.536 2.114 5.536 4.542 0 1.254-.624 2.41-1.67 3.248a.5.5 0 0 0-.165.535l.66 2.175h-.985l-.59-1.487a.5.5 0 0 0-.629-.288c-.661.23-1.39.359-2.158.359-.761 0-1.484-.128-2.118-.355a.5.5 0 0 0-.635.304l-.525 1.471h-.979l.633-2.15a.5.5 0 0 0-.17-.534 4.649 4.649 0 0 1-1.284-1.541H1.518l-.254-1.46h.933a.5.5 0 1 0 0-1H1.518l-.044-.254C1.588 6.84 2.053 6.42 2.516 6.26z"/></svg></div></div><div class="kpi-value" id="kpi-savings">R$ 0,00</div><div class="progress-container"><div class="progress-bar" id="savings-progress" style="width: 0%"></div></div><div class="kpi-footer"><span id="savings-status">Calculando...</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Projeção de Gastos (Mês)</div><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-calendar-check" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg></div></div><div class="kpi-value" id="kpi-projection">R$ 0,00</div><div class="kpi-footer"><span id="projection-status">--</span></div></div>
                 </div>
                  <!-- Gráficos Visão Geral -->
                  <div class="charts-grid">
                      <div class="card"><div class="chart-title"><span>Receitas vs Despesas (Últimos 12 Meses)</span></div><div class="chart-container"><canvas id="overview-income-expense-chart"></canvas></div></div>
                      <div class="card"><div class="chart-title"><span>Despesas por Categoria (Últimos 30 dias)</span></div><div class="chart-container"><canvas id="overview-category-chart"></canvas></div></div>
                      <div class="card full-width"><div class="chart-title"><span>Fluxo de Caixa Mensal (Ano Atual)</span></div><div class="chart-container"><canvas id="overview-cashflow-chart"></canvas></div></div>
                      <div class="card"><div class="chart-title"><span>Fixas vs Variáveis (Mês Atual)</span></div><div class="chart-container"><canvas id="overview-fixed-variable-chart"></canvas></div></div>
                      <div class="card"><div class="chart-title"><span>Tendência Geral de Gastos (Últimos 6 Meses)</span></div><div class="chart-container"><canvas id="overview-trend-chart"></canvas></div></div>
                  </div>
              </div>
              <!-- Aba Análise Mensal -->
              <div class="tab-content" id="tab-analysis">
                  <!-- Filtros -->
                  <div class="analysis-header">
                      <div class="filters">
                          <div class="filter-group"><label for="analysis-year">Ano</label><select id="analysis-year"></select></div>
                          <div class="filter-group"><label for="analysis-month">Mês</label><select id="analysis-month"></select></div>
                          <div class="filter-group"><label for="analysis-category">Categoria</label><div class="category-filter-group"><select id="analysis-category"><option value="all">Todas</option></select><button class="btn-icon-small" id="btn-add-category" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/></svg></button><button class="btn-icon-small btn-delete-category" id="btn-delete-category" title="Excluir Categoria" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div></div>
                          <div class="filter-group"><label for="analysis-importance">Importância</label><select id="analysis-importance"><option value="all">Todas</option><option value="extrema">Extrema</option><option value="urgente">Urgente</option><option value="importante">Importante</option><option value="none">Nenhuma</option></select></div>
                      </div>
                  </div>
                  <!-- Indicadores -->
                  <div class="analysis-indicators">
                      <div class="indicator-card"><div class="indicator-title">Receitas Totais</div><div class="indicator-value positive" id="analysis-total-income">R$ 0,00</div><div class="indicator-comparison" id="analysis-income-comparison">-- vs mês anterior</div></div>
                      <div class="indicator-card"><div class="indicator-title">Despesas Totais</div><div class="indicator-value negative" id="analysis-total-expenses">R$ 0,00</div><div class="indicator-comparison" id="analysis-expense-comparison">-- vs mês anterior</div></div>
                      <div class="indicator-card"><div class="indicator-title">Saldo Final</div><div class="indicator-value neutral" id="analysis-final-balance">R$ 0,00</div><div class="indicator-comparison" id="analysis-balance-comparison">-- vs mês anterior</div></div>
                      <div class="indicator-card"><div class="indicator-title">Status do Mês</div><div class="indicator-value neutral" id="analysis-month-status">--</div><div class="indicator-comparison" id="analysis-days-left">-- dias restantes</div></div>
                      <div class="indicator-card"><div class="indicator-title">Maior Gasto</div><div class="indicator-value neutral" id="analysis-top-category">--</div><div class="indicator-comparison" id="analysis-top-category-value">R$ 0,00</div></div>
                  </div>
                  <!-- Conteúdo Principal e Sidebar -->
                  <div class="analysis-content">
                      <div class="analysis-main">
                          <div class="charts-grid">
                              <div class="card"><div class="chart-title">Distribuição de Despesas</div><div class="chart-container"><canvas id="analysis-category-pie-chart"></canvas></div></div>
                              <div class="card"><div class="chart-title">Evolução do Saldo no Mês</div><div class="chart-container"><canvas id="analysis-balance-line-chart"></canvas></div></div>
                          </div>
                          <div class="transaction-list-container">
                              <div class="transaction-list-title">Transações do Mês</div>
                              <div id="analysis-transaction-list" class="transaction-list">
                                  <div id="analysis-no-transactions" style="display: block; text-align: center; padding: 2rem 1.5rem; color: var(--text-secondary);">Carregando transações...</div>
                                  <!-- Itens carregados via JS -->
                              </div>
                          </div>
                      </div>
                      <aside class="analysis-sidebar">
                          <div class="insights-feed card">
                              <div class="insights-title"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16"><path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13h-5a.5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6 8.5a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1h.5a.5.5 0 0 1 .5.5z"/></svg>Insights Rápidos</div>
                              <div class="insights-list" id="analysis-insights-list">
                                  <div id="analysis-no-insights" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">Analisando seus dados...</div>
                                  <!-- Insights carregados via JS -->
                              </div>
                          </div>
                      </aside>
                  </div>
              </div>
         </div>
     </div>

     <!-- Modais (Transaction, Category, Confirm) -->
      <div class="modal" id="transaction-modal"><!-- Modal Content --></div>
      <div class="modal" id="category-modal"><!-- Modal Content --></div>
      <div class="modal" id="confirm-modal"><!-- Modal Content --></div>

      <!-- Loading Indicator -->
      <div class="loading-indicator" id="loading"><div class="spinner"></div></div>
      <!-- Toast Container -->
      <div class="toast-container" id="toast-container"></div>

    <script>
    // ===== Configurações Globais e Firebase =====
    const root = document.documentElement;
    const loading = document.getElementById('loading');
    moment.locale('pt-br');

    // Configuração Firebase - COPIADA DO SEU ARQUIVO .TXT FUNCIONAL
     const firebaseConfig = {
        apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY",
        authDomain: "calculadora-da-familia.firebaseapp.com",
        projectId: "calculadora-da-familia",
        storageBucket: "calculadora-da-familia.appspot.com",
        messagingSenderId: "69721783786",
        appId: "1:69721783786:web:c4703b5c182e3681e8c693",
        measurementId: "G-YM5TR661S6"
    };

    // Inicializar Firebase - MANTENDO A LÓGICA DO SEU ARQUIVO .TXT FUNCIONAL
    let app;
    let db;
    try {
         console.log("Tentando inicializar Firebase com a config:", firebaseConfig); // Log da config
         if (!firebaseConfig.projectId) {
             throw new Error("FirebaseError: 'projectId' não está presente no objeto firebaseConfig.");
         }
         // Verifica se já foi inicializado para evitar erros de re-inicialização
         if (!firebase.apps.length) {
             app = firebase.initializeApp(firebaseConfig);
         } else {
             app = firebase.app(); // Pega a instância existente
         }
         db = firebase.firestore();
         console.log("Firebase inicializado com sucesso!");
     } catch (error) {
         console.error("Erro CRÍTICO ao inicializar Firebase:", error);
         const loadingIndicator = document.getElementById('loading');
         if (loadingIndicator) {
              loadingIndicator.innerHTML = `<div style="color: white; text-align: center; padding: 1rem; background: var(--danger); border-radius: var(--radius-sm);">Erro ao conectar: ${error.message}. Verifique o console e a configuração.</div>`;
              // Mantém o loading visível com a mensagem de erro
              loadingIndicator.classList.add('active');
         } else {
              alert(`Erro crítico ao conectar com o banco de dados: ${error.message}. A aplicação não funcionará corretamente.`);
         }
         // Impede a execução do restante do script se o Firebase falhar
         throw new Error("Falha na inicialização do Firebase. Execução interrompida.");
     }

    // Coleções Firestore (só define se db foi inicializado com sucesso)
    const transactionsCollection = db.collection('transactions');
    const categoriesCollection = db.collection('categories');

    // ===== Estados da Aplicação =====
    let transactions = [];
    let categories = [];
    let currentTab = 'overview';
    let currentAnalysisMonth = moment().month(); // 0-11
    let currentAnalysisYear = moment().year();
    let currentAnalysisCategory = 'all';
    let currentAnalysisImportance = 'all';
    let unsubscribeTransactions = null;
    let unsubscribeCategories = null;
    let isUpdatingAnalysis = false;
    let chartInstances = {}; // Mover declaração para escopo global

    // ===== Constantes e Mapas =====
    // ... (Constantes inalteradas: TRANSACTION_TYPES, PAYMENT_METHODS, etc.) ...
    const TRANSACTION_TYPES = { income: { name: 'Receita', icon: '💰', colorClass: 'positive' }, expense: { name: 'Despesa', icon: '💸', colorClass: 'negative' } };
    const PAYMENT_METHODS = { 'cash': 'Dinheiro', 'credit_card': 'Cartão de Crédito', 'debit_card': 'Cartão de Débito', 'bank_transfer': 'Transferência', 'pix': 'PIX', 'boleto': 'Boleto', 'other': 'Outro' };
    const TRANSACTION_STATUS = { 'paid': { name: 'Pago', class: 'status-paid' }, 'pending': { name: 'Pendente', class: 'status-pending' }, 'scheduled': { name: 'Agendado', class: 'status-scheduled' } };
    const RECURRENCE_FREQUENCY = { 'daily': { name: 'Diária', momentUnit: 'days', momentStep: 1 }, 'weekly': { name: 'Semanal', momentUnit: 'weeks', momentStep: 1 }, 'biweekly': { name: 'Quinzenal', momentUnit: 'weeks', momentStep: 2 }, 'monthly': { name: 'Mensal', momentUnit: 'months', momentStep: 1 }, 'bimonthly': { name: 'Bimestral', momentUnit: 'months', momentStep: 2 }, 'quarterly': { name: 'Trimestral', momentUnit: 'months', momentStep: 3 }, 'semiannual': { name: 'Semestral', momentUnit: 'months', momentStep: 6 }, 'annual': { name: 'Anual', momentUnit: 'years', momentStep: 1 } };
    const DEFAULT_EXPENSE_CATEGORIES = [ { id: 'moradia', name: 'Moradia', type: 'expense', color: '#FF9500', icon: '🏠', isDefault: true }, { id: 'alimentacao', name: 'Alimentação', type: 'expense', color: '#34C759', icon: '🍔', isDefault: true }, { id: 'transporte', name: 'Transporte', type: 'expense', color: '#007AFF', icon: '🚗', isDefault: true }, { id: 'contas', name: 'Contas Fixas', type: 'expense', color: '#5AC8FA', icon: '💡', isDefault: true }, { id: 'lazer', name: 'Lazer', type: 'expense', color: '#AF52DE', icon: '🎮', isDefault: true }, { id: 'saude', name: 'Saúde', type: 'expense', color: '#FF3B30', icon: '🏥', isDefault: true }, { id: 'compras', name: 'Compras', type: 'expense', color: '#FFCC00', icon: '🛍️', isDefault: true }, { id: 'educacao', name: 'Educação', type: 'expense', color: '#5856D6', icon: '📚', isDefault: true }, { id: 'outros_despesas', name: 'Outras Despesas', type: 'expense', color: '#8E8E93', icon: '📋', isDefault: true } ];
    const DEFAULT_INCOME_CATEGORIES = [ { id: 'salario', name: 'Salário', type: 'income', color: '#34C759', icon: '💰', isDefault: true }, { id: 'freelance', name: 'Freelance/Extra', type: 'income', color: '#007AFF', icon: '💼', isDefault: true }, { id: 'investimentos', name: 'Investimentos', type: 'income', color: '#AF52DE', icon: '📈', isDefault: true }, { id: 'outros_receitas', name: 'Outras Receitas', type: 'income', color: '#8E8E93', icon: '💸', isDefault: true } ];

    // ===== Utilitários =====
    // ... (Funções utilitárias inalteradas: formatCurrency, formatDate, etc.) ...
     const formatCurrency = (value) => value?.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) ?? 'R$ 0,00';
     const formatDate = (dateString) => dateString ? moment(dateString).format('DD/MM/YYYY') : '--';
     const formatDateForInput = (date = new Date()) => moment(date).format('YYYY-MM-DD');
     const showLoading = () => loading?.classList.add('active');
     const hideLoading = () => loading?.classList.remove('active');
     function showToast(message, type = 'info', duration = 3000) { /* ... */ }
     function updateThemeIcon(theme) { /* ... */ }
     function setupTheme() { /* ... */ }
     function toggleTheme() { /* ... */ }

    // ===== Gerenciamento de Dados (Firestore) =====
    // ... (Funções inalteradas, mas agora usam 'db' inicializado) ...
     async function loadCategories() { if (!db) return Promise.reject("DB not init"); return new Promise(async (resolve, reject) => { try { /* ... */ } catch(e){/* ... */} }); }
     async function addCategory(name, type, icon, color) { if (!db) return Promise.reject("DB not init"); showLoading(); try { /* ... */ } catch(e){/* ... */} finally { hideLoading();} }
     async function deleteCategory(categoryId) { if (!db) return Promise.reject("DB not init"); showLoading(); try { /* ... */ } catch(e){/* ... */} finally { hideLoading();} }
     function processTransactionSnapshot(snapshot) { transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); transactions.sort((a, b) => moment(b.date).diff(moment(a.date))); updateDashboard(); }
     function processCategorySnapshot(snapshot) { categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); categories.sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); if (currentTab === 'analysis') { updateMonthlyAnalysis(); } else if (currentTab === 'overview') { updateOverviewCharts(); } }
     function setupFirestoreListeners() { if (!db) { console.error("DB not init for listeners"); return; } stopFirestoreListeners(); unsubscribeTransactions = transactionsCollection.onSnapshot(processTransactionSnapshot, handleListenerError("transações")); unsubscribeCategories = categoriesCollection.onSnapshot(processCategorySnapshot, handleListenerError("categorias")); }
     function stopFirestoreListeners() { if (unsubscribeTransactions) unsubscribeTransactions(); if (unsubscribeCategories) unsubscribeCategories(); unsubscribeTransactions = null; unsubscribeCategories = null; }
     function handleListenerError(collectionName) { return (error) => { console.error(`Erro no listener de ${collectionName}:`, error); showToast(`Erro ao sincronizar ${collectionName}.`, "danger"); }; }

    // ===== Lógica de Transações =====
    // ... (Funções inalteradas, mas agora usam 'db' inicializado) ...
    function openTransactionModal(transaction = null) { /* ... (Verificar 'categories') ... */ }
    async function saveTransaction(event) { if (!db) return; event.preventDefault(); showLoading(); try { /* ... */ } catch(e){/* ... */} finally { hideLoading();} }
    async function generateFutureInstallments(batch, baseData, baseId, frequency, totalInstallments, startDate, startInstallmentNum) { if (!db) return; /* ... */ }
    async function deleteTransaction(transactionId, recurringBaseId = null, deleteScope = 'this') { if (!db) return; showLoading(); try { /* ... */ } catch(e){/* ... */} finally { hideLoading(); /* ... fechar modal ... */ } }

    // ===== Interface e Interação =====
    // ... (Funções inalteradas: openModal, closeModal, etc.) ...
    function openModal(modalElement) { /* ... */ }
    function closeModal(modalElement) { /* ... */ }
    function initTabs() { /* ... (Lógica aprimorada mantida) ... */ }
    function populateCategoryFilters() { /* ... */ }
    function populateCategorySelect(type = 'expense') { /* ... */ }
    function toggleDeleteCategoryButton() { /* ... */ }
    function populateMonthYearFilter() { /* ... (Separado já estava OK) ... */ }
    function setupEventListeners() { /* ... (Incluindo importance) ... */ }
    function toggleAdvancedFields() { /* ... */ }
    function openCategoryModal() { /* ... */ }
    async function handleSaveCategory(event) { /* ... */ }
    function confirmDeleteCategory(categoryId) { /* ... */ }
    function confirmDeleteTransaction(transactionId) { /* ... (Botão delete já integrado) ... */ }

    // ===== Atualização da UI =====
    // ... (Funções inalteradas: updateDashboard, updateKPIs) ...
     function updateDashboard() { updateKPIs(); if (currentTab === 'overview') { updateOverviewCharts(); } else if (currentTab === 'analysis' && !isUpdatingAnalysis) { updateMonthlyAnalysis(); } }
     function updateKPIs() { /* ... (Revisado no CSS, JS inalterado) ... */ }

    // ===== Lógica da Análise Mensal =====
    // ... (Funções inalteradas: updateMonthlyAnalysis, calculateMonthlyIndicators, renderMonthlyTransactionList, generateAndRenderInsights) ...
    // updateMonthlyAnalysis agora usa a flag isUpdatingAnalysis e try/finally
     async function updateMonthlyAnalysis() { if (isUpdatingAnalysis) return; isUpdatingAnalysis = true; showLoading(); const selectedMonth = currentAnalysisMonth; const selectedYear = currentAnalysisYear; const selectedCategory = currentAnalysisCategory; const selectedImportance = currentAnalysisImportance; const selectedMonthMoment = moment().year(selectedYear).month(selectedMonth); const startOfMonth = selectedMonthMoment.startOf('month'); const endOfMonth = selectedMonthMoment.endOf('month'); console.log(`Atualizando análise para: ${selectedMonthMoment.format("MMMM YYYY")}, Categoria: ${selectedCategory}, Importância: ${selectedImportance}`); try { const monthlyTransactions = transactions.filter(t => { const transactionMoment = moment(t.date); const isSameMonth = transactionMoment.isBetween(startOfMonth, endOfMonth, 'day', '[]'); const isSameCategory = (selectedCategory === 'all' || t.category === selectedCategory); const isSameImportance = ( selectedImportance === 'all' || (selectedImportance === 'none' && !t.importance) || t.importance === selectedImportance ); return isSameMonth && isSameCategory && isSameImportance; }); calculateMonthlyIndicators(monthlyTransactions, selectedMonthMoment); renderMonthlyTransactionList(monthlyTransactions); generateAndRenderInsights(monthlyTransactions, selectedMonthMoment); updateAnalysisCharts(monthlyTransactions); } catch (error) { console.error("Erro durante a atualização da análise mensal:", error); showToast("Ocorreu um erro ao processar os dados da análise.", "danger"); } finally { hideLoading(); isUpdatingAnalysis = false; } }
     function calculateMonthlyIndicators(monthlyTransactions, selectedMonthMoment) { /* ... */ }
     function renderMonthlyTransactionList(monthlyTransactions) { /* ... (Botão delete já estava aqui) ... */ }
     function generateAndRenderInsights(monthlyTransactions, selectedMonthMoment) { /* ... */ }

    // ===== Gráficos =====
    // ... (Funções inalteradas: getChartCommonOptions, initCharts, updateAllChartsTheme, updateOverviewCharts, updateAnalysisCharts) ...
     // Usar chartInstances para armazenar gráficos
     function getChartCommonOptions(isDarkMode) { /* ... */ }
     function initCharts() { /* ... (Usa chartInstances) ... */ }
     function getChartInstance(canvasId) { return chartInstances[canvasId]; }
     function updateAllChartsTheme() { /* ... (Usa chartInstances) ... */ }
     function updateOverviewCharts() { /* ... (Usa getChartInstance) ... */ }
     function updateAnalysisCharts(monthlyTransactions) { /* ... (Usa getChartInstance) ... */ }

    // ===== Inicialização da Aplicação =====
    async function init() {
        showLoading(); // Mostra o loading imediatamente
        console.log("Iniciando aplicação...");

         // A inicialização do Firebase agora está no topo e lança erro se falhar

         if (!db) {
             console.error("Inicialização abortada: Firestore não disponível.");
             // Mensagem de erro já foi exibida no catch da inicialização
             return; // Não prossegue
         }

        try {
            setupTheme();
            await loadCategories(); // Espera carregar categorias
            initTabs();
            populateMonthYearFilter();
            initCharts(); // Inicializa gráficos *antes* dos listeners para que existam
            setupEventListeners();
            setupFirestoreListeners(); // Inicia a escuta e o carregamento inicial de dados
            // Não chama updateDashboard aqui, pois os listeners farão isso quando os dados chegarem.

            console.log("Configuração inicial da UI concluída. Aguardando dados do Firebase...");
             // Esconder o loading inicial após um tempo razoável,
             // mesmo que os listeners ainda não tenham retornado (evita ficar preso)
             setTimeout(hideLoading, 1500); // Aumentado ligeiramente o tempo

        } catch (error) {
            console.error("Erro durante a inicialização pós-Firebase:", error);
            showToast("Ocorreu um erro ao carregar alguns componentes da aplicação.", "danger", 10000);
            hideLoading(); // Garante que esconde se der erro aqui
        }
        // Removido o finally daqui, pois o loading é escondido dentro do try ou pelo timeout
    }

    // --- Ponto de Entrada ---
    document.addEventListener('DOMContentLoaded', init);

    // --- Limpeza ao Sair ---
    window.addEventListener('beforeunload', stopFirestoreListeners);

    </script>

</body>
</html>
