<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark"> <!-- Começa com tema escuro como padrão -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Calculadora da Família - Controle financeiro com estilo Apple">
  <title>Calculadora da Família</title>
  
  <!-- Fonte Inter via Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Scripts CDN: Chart.js 4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Scripts CDN: Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
  
  <!-- ===== INÍCIO: BLOCO 1 - CSS Completo (Estilo Apple) ===== -->
  <style>
    /* Design-tokens :root (Tema Claro - será sobrescrito pelo [data-theme="dark"]) */
    :root {
      /* Cores Neutras (Light Mode) */
      --color-background: #ffffff;
      --color-surface: #f5f5f7; /* Fundo de cards, modais */
      --color-surface-variant: #e8e8ed; /* Fundo sutil (botão tema, hover tabela) */
      --color-on-surface: #1d1d1f; /* Texto principal */
      --color-on-surface-variant: #6e6e73; /* Texto secundário/ícones */
      --color-outline: #d2d2d7; /* Bordas sutis */
      
      /* Cores Semânticas */
      --color-primary: #007aff; /* Azul Apple */
      --color-on-primary: #ffffff;
      --color-success: #34c759; /* Verde Apple */
      --color-on-success: #ffffff;
      --color-error: #ff3b30; /* Vermelho Apple */
      --color-on-error: #ffffff;
      --color-info: #5ac8fa; /* Azul claro info */
      --color-on-info: #000000; /* Texto escuro para azul claro */
      --color-warning: #ff9500; /* Laranja warning */
      --color-on-warning: #ffffff;

      /* Cores Indicadores (KPIs, Gráficos) */
      --color-income: var(--color-success);
      --color-expense: var(--color-error);
      --color-balance: var(--color-primary);
      --color-invoice: #ffcc00; /* Amarelo para fatura */
      
      /* Tipografia */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      --font-size-xs: 0.75rem;  /* 12px */
      --font-size-sm: 0.875rem; /* 14px */
      --font-size-md: 1.0625rem;/* 17px (Comum no iOS) */
      --font-size-lg: 1.25rem;  /* 20px */
      --font-size-xl: 1.75rem;  /* 28px */
      --font-size-2xl: 2.125rem; /* 34px */
      --font-weight-regular: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Espaçamento */
      --spacing-xs: 0.5rem;  /* 8px */
      --spacing-sm: 0.75rem; /* 12px */
      --spacing-md: 1rem;    /* 16px */
      --spacing-lg: 1.5rem;  /* 24px */
      --spacing-xl: 2rem;    /* 32px */
      --spacing-2xl: 3rem;   /* 48px */
      
      /* Bordas e Raios */
      --radius-sm: 0.5rem;   /* 8px */
      --radius-md: 0.75rem;  /* 12px */
      --radius-lg: 1rem;     /* 16px */
      --radius-xl: 1.25rem;  /* 20px */
      --radius-full: 9999px;
      
      /* Sombras */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.08);
      
      /* Animações */
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Tema Escuro */
    [data-theme="dark"] {
      --color-background: #000000;
      --color-surface: #1c1c1e;
      --color-surface-variant: #333333;
      --color-on-surface: #ffffff;
      --color-on-surface-variant: #8e8e93;
      --color-outline: #38383a;
      
      /* Ajuste de cores semânticas para contraste no escuro */
      --color-primary: #0a84ff; /* Azul mais vibrante */
      --color-success: #30d158; /* Verde mais vibrante */
      --color-error: #ff453a;   /* Vermelho mais vibrante */
      --color-info: #64d2ff;    /* Azul info mais vibrante */
      --color-on-info: #000000;
      --color-warning: #ff9f0a; /* Laranja warning mais vibrante */
      --color-invoice: #ffd60a; /* Amarelo fatura mais vibrante */

      /* Sombras no modo escuro */
      --shadow-sm: 0 1px 1px rgba(255, 255, 255, 0.05);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    /* Reset Básico */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent; /* Remove highlight azul no toque mobile */
    }
    
    html { font-size: 100%; }

    body {
      min-height: 100vh;
      font-family: var(--font-family);
      background-color: var(--color-background);
      color: var(--color-on-surface);
      font-size: var(--font-size-md);
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }

    img, picture, video, canvas, svg { display: block; max-width: 100%; }
    input, button, textarea, select { font: inherit; color: inherit; }
    button { background: none; border: none; cursor: pointer; padding: 0; }
    a { color: inherit; text-decoration: none; }
    table { border-collapse: collapse; width: 100%; }

    /* Layout Principal */
    .container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: var(--spacing-lg) var(--spacing-md);
    }
  
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm) 0;
      margin-bottom: var(--spacing-xl);
      /* position: sticky; top: 0; z-index: 100; background-color: var(--color-background); */ /* Sticky opcional */
    }
    .header-filters { /* Container para selects de data */
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
    }
    .header-actions { /* Container para botões */
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      flex-wrap: wrap; /* Permite que botões quebrem linha */
    }
    
    /* Botão de Tema */
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      cursor: pointer;
      background-color: var(--color-surface-variant);
      border: none;
      transition: background-color var(--transition-normal);
      flex-shrink: 0;
    }
    .theme-toggle:hover { filter: brightness(0.9); }
    .theme-toggle svg { width: 18px; height: 18px; color: var(--color-on-surface-variant); transition: color var(--transition-normal); }
    [data-theme="light"] .theme-toggle .icon-moon { display: none; }
    [data-theme="dark"] .theme-toggle .icon-sun { display: none; }

    /* Grid de KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }
    
    /* Cards de KPI */
    .kpi-card {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md) var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-outline);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      transition: background-color var(--transition-normal), border-color var(--transition-normal), box-shadow var(--transition-normal);
    }
    .kpi-card::before { /* Linha colorida */
        content: ''; display: block; height: 4px;
        margin: calc(-1 * var(--spacing-md)) calc(-1 * var(--spacing-lg)) var(--spacing-sm);
        border-top-left-radius: var(--radius-lg); border-top-right-radius: var(--radius-lg);
        transition: background-color var(--transition-normal);
    }
    .kpi-balance::before { background-color: var(--color-balance); }
    .kpi-income::before { background-color: var(--color-income); }
    .kpi-expense::before { background-color: var(--color-expense); }
    .kpi-card-invoice::before { background-color: var(--color-invoice); } /* Para fatura */

    .kpi-title { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-on-surface-variant); transition: color var(--transition-normal); }
    .kpi-value { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); color: var(--color-on-surface); line-height: 1.2; transition: color var(--transition-normal); }
    .kpi-subtitle { font-size: var(--font-size-xs); color: var(--color-on-surface-variant); transition: color var(--transition-normal); display: flex; align-items: center; gap: var(--spacing-xs); }
    .kpi-subtitle svg { width: 14px; height: 14px; } /* Ícone no subtítulo */

    /* Insights Banner */
    .insights-banner { margin-bottom: var(--spacing-xl); } /* Apenas margem */
    .insight-banner { /* Estilo individual do insight */
      display: flex; align-items: center; gap: var(--spacing-md);
      padding: var(--spacing-md); border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-md); border-left-width: 4px; border-left-style: solid;
      transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }
    .insight-icon { font-size: 1.5rem; color: var(--color-on-surface-variant); }
    .insight-icon svg { width: 24px; height: 24px; }
    .insight-content { flex: 1; }
    .insight-title { font-weight: var(--font-weight-medium); color: var(--color-on-surface); transition: color var(--transition-normal); }
    .insight-action { margin-left: auto; /* Empurra botão para a direita */ }

    .insight-danger { background-color: rgba(255, 59, 48, 0.1); border-left-color: var(--color-error); }
    .insight-warning { background-color: rgba(255, 149, 0, 0.1); border-left-color: var(--color-warning); }
    .insight-info { background-color: rgba(90, 200, 250, 0.1); border-left-color: var(--color-info); }
    .insight-success { background-color: rgba(52, 199, 89, 0.1); border-left-color: var(--color-success); }

    /* Grid de Gráficos */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }
    
    /* Container do Gráfico */
    .chart-container {
      position: relative; height: 300px;
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-outline);
      transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }
    .chart-container h3 {
        font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);
        color: var(--color-on-surface); margin-bottom: var(--spacing-md);
        text-align: center; transition: color var(--transition-normal);
    }

    /* Compromissos Longos */
    .commitments {
      margin-bottom: var(--spacing-xl); background-color: var(--color-surface);
      border-radius: var(--radius-lg); padding: var(--spacing-md);
      box-shadow: var(--shadow-sm); border: 1px solid var(--color-outline);
      transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }
    .commitments-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: var(--spacing-md); cursor: pointer;
    }
    .commitments-header h3 { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-on-surface); transition: color var(--transition-normal); margin: 0; }
    .commitments-header svg { color: var(--color-on-surface-variant); transition: transform var(--transition-normal); }
    .commitments-header svg use { transition: href var(--transition-normal); } /* Anima troca de ícone */
    .commitments-content { overflow: hidden; transition: max-height var(--transition-normal); max-height: 0; } /* Começa fechado */
    .commitment-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md) 0; border-bottom: 1px solid var(--color-outline); }
    .commitment-item:last-child { border-bottom: none; }
    .commitment-progress { flex: 1; height: 6px; background-color: var(--color-surface-variant); border-radius: var(--radius-full); overflow: hidden; }
    .commitment-progress-bar { height: 100%; transition: width var(--transition-normal); }

    /* Filtros (Select) */
    .transaction-filters { /* Renomeado de filter-controls */
        display: flex; flex-wrap: wrap; gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }
    .select-wrapper { position: relative; display: inline-block; flex-grow: 1; }
    .select {
      appearance: none; -webkit-appearance: none; width: 100%;
      padding: var(--spacing-sm) var(--spacing-xl) var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md); border: 1px solid var(--color-outline);
      background-color: var(--color-surface); color: var(--color-on-surface);
      font-size: var(--font-size-sm); cursor: pointer;
      transition: border-color var(--transition-normal), background-color var(--transition-normal);
    }
    .select:focus { outline: none; border-color: var(--color-primary); }
    .select-icon { position: absolute; right: var(--spacing-md); top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--color-on-surface-variant); transition: color var(--transition-normal); }
    .select-icon svg { width: 16px; height: 16px; }

    /* Tabela de Transações */
    .transactions { margin-bottom: var(--spacing-xl); }
    .transactions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); }
    .transactions-header h3 { font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-on-surface); transition: color var(--transition-normal); margin: 0; }
    
    .transactions-table-wrapper {
        background-color: var(--color-surface); border-radius: var(--radius-lg);
        overflow: hidden; border: 1px solid var(--color-outline);
        box-shadow: var(--shadow-sm);
        transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }
    .transactions-table { width: 100%; }
    .transactions-table th {
      text-align: left; padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);
      color: var(--color-on-surface-variant); background-color: var(--color-surface);
      border-bottom: 1px solid var(--color-outline);
      transition: color var(--transition-normal), background-color var(--transition-normal), border-color var(--transition-normal);
      white-space: nowrap; user-select: none;
    }
    .transactions-table th.sortable { cursor: pointer; }
    .transactions-table th.sortable:hover { background-color: var(--color-surface-variant); }
    .transaction-sort-icon { display: inline-block; margin-left: var(--spacing-xs); width: 14px; height: 14px; vertical-align: middle; }
    .transaction-sort-icon svg { display: block; } /* Garante que SVG interno preencha */

    .transactions-table td {
      padding: var(--spacing-md); border-top: 1px solid var(--color-outline);
      font-size: var(--font-size-sm); color: var(--color-on-surface);
      transition: color var(--transition-normal), border-color var(--transition-normal);
      vertical-align: middle;
    }
    .transactions-table tr:hover td { background-color: var(--color-surface-variant); transition: background-color var(--transition-fast); }
    
    .transaction-icon {
      display: inline-flex; justify-content: center; align-items: center;
      width: 32px; height: 32px; border-radius: var(--radius-sm);
      font-size: 1rem; margin-right: var(--spacing-sm);
      background-color: var(--color-surface-variant); /* Fundo padrão */
      color: var(--color-on-surface); /* Cor padrão */
    }
    /* Cores específicas para ícones de receita/despesa */
    .transaction-icon.income { background-color: rgba(52, 199, 89, 0.1); color: var(--color-income); }
    .transaction-icon.expense { background-color: rgba(255, 59, 48, 0.1); color: var(--color-expense); }

    .actions-cell { display: flex; gap: var(--spacing-xs); justify-content: flex-end; }
    .actions-cell .btn-icon {
        width: 32px; height: 32px; padding: 0; border-radius: var(--radius-sm);
        background-color: var(--color-surface-variant); color: var(--color-on-surface-variant);
        border: 1px solid var(--color-outline);
        transition: background-color var(--transition-fast), border-color var(--transition-fast), filter var(--transition-fast);
    }
    .actions-cell .btn-icon:hover { filter: brightness(0.9); }
    .actions-cell .btn-icon svg { width: 16px; height: 16px; }

    /* Checkbox personalizado (Estilo iOS) */
    .checkbox-wrapper { position: relative; display: inline-block; vertical-align: middle; }
    .checkbox { position: absolute; opacity: 0; width: 0; height: 0; }
    .checkbox-label {
      display: inline-block; width: 22px; height: 22px;
      border-radius: var(--radius-full); border: 1px solid var(--color-outline);
      background-color: var(--color-surface); cursor: pointer;
      transition: all var(--transition-fast); position: relative;
    }
    .checkbox:checked + .checkbox-label {
      background-color: var(--color-primary); border-color: var(--color-primary);
    }
    .checkbox:checked + .checkbox-label:after { /* Checkmark */
      content: ''; position: absolute;
      left: 7px; top: 4px; width: 5px; height: 10px;
      border: solid var(--color-on-primary); border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* Radio buttons (Estilo iOS Segmented Control simulado com labels) */
    .radio-group { display: flex; gap: 0; margin-bottom: var(--spacing-md); flex-wrap: wrap; border: 1px solid var(--color-outline); border-radius: var(--radius-md); overflow: hidden; }
    .radio-wrapper { position: relative; flex-grow: 1; } /* Ocupa espaço igual */
    .radio { position: absolute; opacity: 0; width: 0; height: 0; }
    .radio-label {
      display: flex; align-items: center; justify-content: center; gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-md);
      border: none; border-right: 1px solid var(--color-outline); /* Divisor vertical */
      cursor: pointer; transition: all var(--transition-fast);
      background-color: var(--color-surface); color: var(--color-on-surface-variant);
      font-size: var(--font-size-sm); text-align: center;
    }
    .radio-wrapper:last-child .radio-label { border-right: none; } /* Remove último divisor */
    .radio:checked + .radio-label {
      background-color: var(--color-primary); color: var(--color-on-primary);
      font-weight: var(--font-weight-medium);
    }
    .radio-label .radio-circle { display: none; } /* Esconde círculo padrão */

    /* Badge (Estilo iOS) */
    .badge {
      display: inline-block; padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-full); font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .badge-success { background-color: rgba(52, 199, 89, 0.15); color: var(--color-success); }
    .badge-warning { background-color: rgba(255, 149, 0, 0.15); color: var(--color-warning); }
    .badge-danger { background-color: rgba(255, 59, 48, 0.15); color: var(--color-error); }
    .badge-info { background-color: rgba(90, 200, 250, 0.15); color: var(--color-info); }

    /* Botões Gerais */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: var(--spacing-xs); padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md); font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium); transition: all var(--transition-fast);
      white-space: nowrap; border: none;
    }
    .btn svg { width: 16px; height: 16px; }
    .btn-primary { background-color: var(--color-primary); color: var(--color-on-primary); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-primary:active { filter: brightness(0.9); }
    .btn-success { background-color: var(--color-success); color: var(--color-on-success); }
    .btn-success:hover { filter: brightness(1.1); }
    .btn-success:active { filter: brightness(0.9); }
    .btn-danger { background-color: var(--color-error); color: var(--color-on-error); }
    .btn-danger:hover { filter: brightness(1.1); }
    .btn-danger:active { filter: brightness(0.9); }
    .btn-outline {
      background-color: transparent; color: var(--color-primary);
      border: 1px solid var(--color-primary);
    }
    .btn-outline:hover { background-color: rgba(0, 122, 255, 0.1); }
    .btn-outline:active { background-color: rgba(0, 122, 255, 0.2); }
    .btn-icon { /* Reutilizado nas actions da tabela */
        width: 32px; height: 32px; padding: 0; border-radius: var(--radius-sm);
        background-color: var(--color-surface-variant); color: var(--color-on-surface-variant);
        border: 1px solid var(--color-outline);
        transition: background-color var(--transition-fast), border-color var(--transition-fast), filter var(--transition-fast);
    }
    .btn-icon:hover { filter: brightness(0.9); }
    .btn-icon svg { width: 16px; height: 16px; }

    /* Modais */
    .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
      backdrop-filter: blur(5px);
    }
    .modal-backdrop.active { opacity: 1; visibility: visible; }
    .modal {
      width: 90%; max-width: 500px; background-color: var(--color-surface);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-lg);
      opacity: 0; transform: scale(0.95) translateY(10px);
      transition: opacity var(--transition-normal), transform var(--transition-normal);
      border: 1px solid var(--color-outline); overflow: hidden;
    }
    .modal-backdrop.active .modal { opacity: 1; transform: scale(1) translateY(0); }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-outline);
      background-color: rgba(128, 128, 128, 0.05);
    }
    .modal-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-on-surface); }
    .modal-close { color: var(--color-on-surface-variant); cursor: pointer; padding: var(--spacing-xs); }
    .modal-close svg { width: 18px; height: 18px; }
    .modal-body { padding: var(--spacing-lg); max-height: 70vh; overflow-y: auto; }
    .modal-footer {
      display: flex; justify-content: flex-end; gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg); border-top: 1px solid var(--color-outline);
      background-color: rgba(128, 128, 128, 0.05);
    }

    /* Formulários dentro do Modal */
    .form-group { margin-bottom: var(--spacing-lg); }
    .form-label { display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-on-surface-variant); margin-bottom: var(--spacing-xs); }
    .form-control {
      width: 100%; padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md); border: 1px solid var(--color-outline);
      background-color: var(--color-background); color: var(--color-on-surface);
      transition: border-color var(--transition-normal), background-color var(--transition-normal);
    }
    .form-control:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); }
    textarea.form-control { min-height: 80px; line-height: 1.5; }

    /* Abas no Modal de Categorias */
    .nav-tabs { display: flex; list-style: none; padding: 0; margin: 0 0 var(--spacing-md) 0; border-bottom: 1px solid var(--color-outline); }
    .nav-item { margin-bottom: -1px; }
    .nav-link {
      display: block; padding: var(--spacing-sm) var(--spacing-md); text-decoration: none;
      color: var(--color-on-surface-variant); border: 1px solid transparent;
      border-bottom: 2px solid transparent; border-top-left-radius: var(--radius-md);
      border-top-right-radius: var(--radius-md); transition: all var(--transition-normal);
      margin-right: var(--spacing-xs); font-size: var(--font-size-sm);
    }
    .nav-link:hover { color: var(--color-primary); background-color: var(--color-surface-variant); }
    .nav-link.active {
      color: var(--color-primary); border-color: var(--color-outline);
      border-bottom-color: var(--color-surface); background-color: var(--color-surface);
      font-weight: var(--font-weight-medium);
    }
    .tab-content { position: relative; padding: var(--spacing-md); border: 1px solid var(--color-outline); border-top: none; border-radius: 0 0 var(--radius-lg) var(--radius-lg); background-color: var(--color-surface); }
    .tab-pane { display: none; opacity: 0; transition: opacity var(--transition-normal); }
    .tab-pane.active { display: block; }
    .tab-pane.show { opacity: 1; }

    /* Lista de Categorias/Métodos no Modal */
    .category-list { max-height: 200px; overflow-y: auto; margin-bottom: var(--spacing-md); border: 1px solid var(--color-outline); border-radius: var(--radius-md); background-color: var(--color-background); }
    .category-item { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-sm) var(--spacing-md); border-bottom: 1px solid var(--color-outline); }
    .category-item:last-child { border-bottom: none; }
    .category-item-content { display: flex; align-items: center; gap: var(--spacing-sm); font-size: var(--font-size-sm); }
    .category-item-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .category-item-actions { display: flex; gap: var(--spacing-xs); }
    .add-category-form { display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md); }
    .add-category-form .form-control { flex: 1; }
    .add-category-form .btn { flex-shrink: 0; } /* Impede botão de encolher */

    /* Input de Ícone Personalizado */
    .custom-icon-input { display: flex; align-items: center; gap: var(--spacing-sm); border: 1px solid var(--color-outline); border-radius: var(--radius-md); padding: var(--spacing-xs); background-color: var(--color-background); flex-shrink: 0; width: 80px; /* Largura fixa para ícone */ }
    .custom-icon-preview { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .custom-icon-input input { border: none; background: none; outline: none; flex: 1; padding: 0; text-align: center; }

    /* Toast */
    .toast-container { position: fixed; top: var(--spacing-md); right: var(--spacing-md); z-index: 2000; }
    .toast {
      display: flex; align-items: center; gap: var(--spacing-sm);
      background-color: var(--color-surface); border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow-md); min-width: 280px; max-width: 350px;
      transform: translateX(120%); transition: transform var(--transition-normal);
      border-left-width: 4px; border-left-style: solid;
    }
    .toast.show { transform: translateX(0); }
    .toast-icon { font-size: 1.2rem; }
    .toast-icon svg { width: 20px; height: 20px; }
    .toast-content { flex: 1; font-size: var(--font-size-sm); }
    .toast-close { font-size: var(--font-size-lg); color: var(--color-on-surface-variant); cursor: pointer; padding: var(--spacing-xs); margin-left: auto; }
    .toast-close svg { width: 14px; height: 14px; }
    .toast-success { border-left-color: var(--color-success); }
    .toast-error { border-left-color: var(--color-error); }
    .toast-warning { border-left-color: var(--color-warning); }
    .toast-info { border-left-color: var(--color-info); }

    /* Responsividade Adicional */
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; gap: var(--spacing-md); }
      .header-filters { width: 100%; }
      .header-actions { width: 100%; justify-content: flex-start; }
      .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .charts-grid { grid-template-columns: 1fr; }
      .transaction-filters { flex-direction: column; align-items: stretch; }
      .transactions-table-wrapper { border-radius: 0; border-left: none; border-right: none; margin: 0 calc(-1 * var(--spacing-md)); }
      .transactions-table th, .transactions-table td { font-size: var(--font-size-xs); padding: var(--spacing-sm); }
      .modal { max-width: 95%; border-radius: var(--radius-lg); }
      .add-category-form { flex-direction: column; } /* Empilha no mobile */
      .custom-icon-input { width: 100%; } /* Ocupa largura total no mobile */
    }
    @media (max-width: 576px) {
        .header-filters { flex-direction: column; align-items: stretch; }
        .select-date-container { flex-direction: column; gap: var(--spacing-sm); }
        .header-actions .btn { flex-grow: 1; justify-content: center; } /* Botões ocupam largura */
        .kpi-grid { grid-template-columns: 1fr; } /* KPIs empilhados */
        .kpi-value { font-size: var(--font-size-lg); } /* Reduz valor do KPI */
    }

    /* Classe auxiliar para forçar recálculo de cores */
    [data-recolor] {
      color: var(--color-on-surface);
      transition: color var(--transition-normal);
    }
    .repaint-trigger * { transform: scale(1); } /* Para forçar repaint */

  </style>
  <!-- ===== FIM: BLOCO 1 - CSS Completo (Estilo Apple) ===== -->

</head>
<body>
  <!-- ===== INÍCIO: BLOCO 2 - SVG Sprite (Completo) ===== -->
  <svg style="display: none;">
    <!-- Ícones de navegação -->
    <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></symbol>
    <symbol id="icon-credit-card" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></symbol>
    <!-- Ícones de ações -->
    <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></symbol>
    <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></symbol>
    <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></symbol>
    <symbol id="icon-chevron-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></symbol>
    <!-- Ícones tema claro/escuro -->
    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></symbol>
    <!-- Ícones para categorias padrão -->
    <symbol id="icon-shopping" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></symbol>
    <symbol id="icon-food" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></symbol>
    <symbol id="icon-home-category" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></symbol>
    <symbol id="icon-bill" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></symbol>
    <symbol id="icon-default" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>
    <symbol id="icon-money" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>
    <!-- Ícones para alertas e notificações -->
    <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></symbol>
    <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>
    <!-- Ícones para ordenação -->
    <symbol id="icon-sort-asc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></symbol>
    <symbol id="icon-sort-desc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></symbol>
  </svg>
  <!-- ===== FIM: BLOCO 2 - SVG Sprite (Completo) ===== -->

  <!-- ===== INÍCIO: BLOCO 3 - Conteúdo Principal ===== -->
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-filters">
        <div class="select-wrapper">
          <select id="yearSelect" class="select"><!-- Options via JS --></select>
          <span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span>
        </div>
        <div class="select-wrapper">
          <select id="monthSelect" class="select">
            <option value="0">Janeiro</option> <option value="1">Fevereiro</option> <option value="2">Março</option>
            <option value="3">Abril</option> <option value="4">Maio</option> <option value="5">Junho</option>
            <option value="6">Julho</option> <option value="7">Agosto</option> <option value="8">Setembro</option>
            <option value="9">Outubro</option> <option value="10">Novembro</option> <option value="11">Dezembro</option>
          </select>
          <span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span>
        </div>
      </div>
      <div class="header-actions">
        <button id="newIncomeBtn" class="btn btn-success"><svg><use href="#icon-plus"></use></svg> Receita</button>
        <button id="newExpenseBtn" class="btn btn-danger"><svg><use href="#icon-plus"></use></svg> Despesa</button>
        <button id="cardsBtn" class="btn btn-outline"><svg><use href="#icon-credit-card"></use></svg> Cartões</button>
        <button id="categoriesBtn" class="btn btn-outline"><svg><use href="#icon-settings"></use></svg> Categorias</button>
        <div id="themeToggle" class="theme-toggle" role="button" aria-label="Alternar tema">
          <svg class="icon-sun"><use href="#icon-sun"></use></svg>
          <svg class="icon-moon"><use href="#icon-moon"></use></svg>
        </div>
      </div>
    </header>
    
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card kpi-balance">
        <div class="kpi-title" data-recolor>Saldo Atual</div>
        <div class="kpi-value" id="balanceValue" data-recolor>R$ 0,00</div>
        <div class="kpi-subtitle" data-recolor><svg><use href="#icon-info"></use></svg> <span>Receitas recebidas - Despesas pagas</span></div>
      </div>
      <div class="kpi-card kpi-income">
        <div class="kpi-title" data-recolor>Receitas</div>
        <div class="kpi-value" id="incomeValue" data-recolor>R$ 0,00</div>
        <div class="kpi-subtitle" data-recolor><span id="incomeReceivedValue">R$ 0,00 recebidos</span> / <span id="incomePendingValue">R$ 0,00 pendentes</span></div>
      </div>
      <div class="kpi-card kpi-expense">
        <div class="kpi-title" data-recolor>Despesas</div>
        <div class="kpi-value" id="expenseValue" data-recolor>R$ 0,00</div>
        <div class="kpi-subtitle" data-recolor><span id="expensePaidValue">R$ 0,00 pagos</span> / <span id="expensePendingValue">R$ 0,00 pendentes</span></div>
      </div>
      <div class="kpi-card kpi-invoice"> <!-- Usando a classe correta para a cor -->
        <div class="kpi-title" data-recolor>Fatura do Mês</div>
        <div class="kpi-value" id="invoiceValue" data-recolor>R$ 0,00</div>
        <div class="kpi-subtitle" data-recolor><svg><use href="#icon-credit-card"></use></svg> <span>Vencimento: <span id="invoiceDueDate">--/--/----</span></span></div>
      </div>
    </div>
    
    <!-- Insights Banner -->
    <div class="insights-banner" id="insightsBanner"><!-- Insights via JS --></div>
    
    <!-- Gráficos -->
    <div class="charts-grid">
      <div class="chart-container">
        <h3 data-recolor>Despesas por Categoria</h3>
        <canvas id="catPie"></canvas>
      </div>
      <div class="chart-container">
        <h3 data-recolor>Receitas x Despesas (Ano)</h3>
        <canvas id="annualBars"></canvas>
      </div>
    </div>

    <!-- Compromissos Longos -->
    <div class="commitments">
      <div class="commitments-header" id="commitmentsHeader">
        <h3 data-recolor>Compromissos Futuros</h3>
        <svg width="20" height="20"><use href="#icon-chevron-down"></use></svg>
      </div>
      <div class="commitments-content" id="commitmentsContent"><!-- Compromissos via JS --></div>
    </div>
    
    <!-- Tabela de Transações -->
    <div class="transactions">
      <div class="transactions-header">
        <h3 data-recolor>Transações do Mês</h3>
      </div>
      <div id="transaction-filters" class="transaction-filters"><!-- Filtros via JS --></div>
      <div class="transactions-table-wrapper">
        <table class="transactions-table" id="transactionsTable">
          <thead>
            <tr>
              <th></th> <!-- Ícone -->
              <th class="sortable" data-sort="name" data-recolor>Nome <span class="transaction-sort-icon"></span></th>
              <th class="sortable" data-sort="category" data-recolor>Categoria <span class="transaction-sort-icon"></span></th>
              <th class="sortable" data-sort="date" data-recolor>Data <span class="transaction-sort-icon"></span></th>
              <th class="sortable" data-sort="dueDate" data-recolor>Vencimento <span class="transaction-sort-icon"></span></th>
              <th class="sortable" data-sort="amount" data-recolor>Valor <span class="transaction-sort-icon"></span></th>
              <th class="sortable" data-sort="status" data-recolor>Status <span class="transaction-sort-icon"></span></th>
              <th class="sortable" data-sort="paymentMethod" data-recolor>Pagamento <span class="transaction-sort-icon"></span></th>
              <th data-recolor>Pago?</th>
              <th data-recolor>Ações</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody"><!-- Transações via JS --></tbody>
        </table>
      </div>
    </div>

  </div>
  <!-- ===== FIM: BLOCO 3 - Conteúdo Principal ===== -->

  <!-- ===== INÍCIO: BLOCO 4 - Modais ===== -->
  <!-- Modal de Nova Receita -->
  <div class="modal-backdrop" id="incomeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" data-recolor>Nova Receita</h2>
        <span class="modal-close" id="closeIncomeModal"><svg><use href="#icon-x"></use></svg></span>
      </div>
      <div class="modal-body">
        <form id="incomeForm">
          <div class="form-group"><label class="form-label" for="incomeName" data-recolor>Nome</label><input type="text" class="form-control" id="incomeName" placeholder="Nome da receita" required></div>
          <div class="form-group"><label class="form-label" for="incomeAmount" data-recolor>Valor</label><input type="number" class="form-control" id="incomeAmount" placeholder="0,00" min="0" step="0.01" required></div>
          <div class="form-group"><label class="form-label" for="incomeCategory" data-recolor>Categoria</label><div class="select-wrapper"><select class="select" id="incomeCategory" required><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group"><label class="form-label" for="incomeDate" data-recolor>Data de Lançamento</label><input type="date" class="form-control" id="incomeDate" required></div>
          <div class="form-group"><label class="form-label" data-recolor>Status</label><div class="radio-group"><div class="radio-wrapper"><input type="radio" class="radio" id="incomeStatusReceived" name="incomeStatus" value="received" checked><label class="radio-label" for="incomeStatusReceived" data-recolor>Recebido</label></div><div class="radio-wrapper"><input type="radio" class="radio" id="incomeStatusPending" name="incomeStatus" value="pending"><label class="radio-label" for="incomeStatusPending" data-recolor>A Receber</label></div></div></div>
          <div class="form-group"><label class="form-label" for="incomePaymentMethod" data-recolor>Forma de Recebimento</label><div class="select-wrapper"><select class="select" id="incomePaymentMethod" required><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group"><div class="checkbox-wrapper"><input type="checkbox" class="checkbox" id="incomeIsRecurrent"><label class="checkbox-label" for="incomeIsRecurrent"></label></div><label class="form-label" for="incomeIsRecurrent" style="display: inline-block; margin-left: 8px;" data-recolor>Receita Recorrente</label></div>
          <div class="form-group" id="incomeRecurrenceGroup" style="display: none;"><label class="form-label" for="incomeInstallments" data-recolor>Quantidade de Parcelas</label><input type="number" class="form-control" id="incomeInstallments" min="2" value="2"></div>
          <div class="form-group"><label class="form-label" for="incomeNotes" data-recolor>Observação (opcional)</label><textarea class="form-control" id="incomeNotes" rows="3"></textarea></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="cancelIncomeBtn" data-recolor>Cancelar</button><button type="submit" form="incomeForm" class="btn btn-success" id="saveIncomeBtn">Salvar Receita</button></div>
    </div>
  </div>
  
  <!-- Modal de Nova Despesa -->
  <div class="modal-backdrop" id="expenseModal">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title" data-recolor>Nova Despesa</h2><span class="modal-close" id="closeExpenseModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body">
        <form id="expenseForm">
          <div class="form-group"><label class="form-label" for="expenseName" data-recolor>Nome</label><input type="text" class="form-control" id="expenseName" placeholder="Nome da despesa" required></div>
          <div class="form-group"><label class="form-label" for="expenseAmount" data-recolor>Valor</label><input type="number" class="form-control" id="expenseAmount" placeholder="0,00" min="0" step="0.01" required></div>
          <div class="form-group"><label class="form-label" for="expenseCategory" data-recolor>Categoria</label><div class="select-wrapper"><select class="select" id="expenseCategory" required><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group"><label class="form-label" for="expenseDate" data-recolor>Data de Lançamento</label><input type="date" class="form-control" id="expenseDate" required></div>
          <div class="form-group" id="expenseDueDateGroup"><label class="form-label" for="expenseDueDate" data-recolor>Data de Vencimento</label><input type="date" class="form-control" id="expenseDueDate"></div>
          <div class="form-group"><label class="form-label" data-recolor>Status</label><div class="radio-group"><div class="radio-wrapper"><input type="radio" class="radio" id="expenseStatusPaid" name="expenseStatus" value="paid"><label class="radio-label" for="expenseStatusPaid" data-recolor>Pago</label></div><div class="radio-wrapper"><input type="radio" class="radio" id="expenseStatusPending" name="expenseStatus" value="pending" checked><label class="radio-label" for="expenseStatusPending" data-recolor>Pendente</label></div><div class="radio-wrapper"><input type="radio" class="radio" id="expenseStatusScheduled" name="expenseStatus" value="scheduled"><label class="radio-label" for="expenseStatusScheduled" data-recolor>Agendado</label></div></div></div>
          <div class="form-group" id="scheduledDateGroup" style="display: none;"><label class="form-label" for="expenseScheduledDate" data-recolor>Data de Agendamento</label><input type="date" class="form-control" id="expenseScheduledDate"></div>
          <div class="form-group"><label class="form-label" for="expensePaymentMethod" data-recolor>Forma de Pagamento</label><div class="select-wrapper"><select class="select" id="expensePaymentMethod" required><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group" id="creditCardGroup" style="display: none;"><label class="form-label" for="expenseCreditCard" data-recolor>Cartão de Crédito</label><div class="select-wrapper"><select class="select" id="expenseCreditCard"><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group"><div class="checkbox-wrapper"><input type="checkbox" class="checkbox" id="expenseIsRecurrent"><label class="checkbox-label" for="expenseIsRecurrent"></label></div><label class="form-label" for="expenseIsRecurrent" style="display: inline-block; margin-left: 8px;" data-recolor>Despesa Recorrente</label></div>
          <div class="form-group" id="expenseRecurrenceGroup" style="display: none;"><label class="form-label" for="expenseInstallments" data-recolor>Quantidade de Parcelas</label><input type="number" class="form-control" id="expenseInstallments" min="2" value="2"></div>
          <div class="form-group"><label class="form-label" for="expenseNotes" data-recolor>Observação (opcional)</label><textarea class="form-control" id="expenseNotes" rows="3"></textarea></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="cancelExpenseBtn" data-recolor>Cancelar</button><button type="submit" form="expenseForm" class="btn btn-danger" id="saveExpenseBtn">Salvar Despesa</button></div>
    </div>
  </div>

  <!-- Modal de Edição de Transação -->
  <div class="modal-backdrop" id="editModal">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title" id="editModalTitle" data-recolor>Editar Transação</h2><span class="modal-close" id="closeEditModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="editTransactionId"><input type="hidden" id="editTransactionType">
          <div class="form-group"><label class="form-label" for="editName" data-recolor>Nome</label><input type="text" class="form-control" id="editName" required></div>
          <div class="form-group"><label class="form-label" for="editAmount" data-recolor>Valor</label><input type="number" class="form-control" id="editAmount" min="0" step="0.01" required></div>
          <div class="form-group"><label class="form-label" for="editCategory" data-recolor>Categoria</label><div class="select-wrapper"><select class="select" id="editCategory" required><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group"><label class="form-label" for="editDate" data-recolor>Data de Lançamento</label><input type="date" class="form-control" id="editDate" required></div>
          <div class="form-group" id="editDueDateGroup"><label class="form-label" for="editDueDate" data-recolor>Data de Vencimento</label><input type="date" class="form-control" id="editDueDate"></div>
          <div class="form-group"><label class="form-label" data-recolor>Status</label><div class="radio-group" id="editStatusGroup"><!-- Options via JS --></div></div>
          <div class="form-group" id="editScheduledDateGroup" style="display: none;"><label class="form-label" for="editScheduledDate" data-recolor>Data de Agendamento</label><input type="date" class="form-control" id="editScheduledDate"></div>
          <div class="form-group"><label class="form-label" for="editPaymentMethod" data-recolor>Forma de Pagamento</label><div class="select-wrapper"><select class="select" id="editPaymentMethod" required><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group" id="editCreditCardGroup" style="display: none;"><label class="form-label" for="editCreditCard" data-recolor>Cartão de Crédito</label><div class="select-wrapper"><select class="select" id="editCreditCard"><!-- Options via JS --></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span></div></div>
          <div class="form-group"><div class="checkbox-wrapper"><input type="checkbox" class="checkbox" id="editIsRecurrent"><label class="checkbox-label" for="editIsRecurrent"></label></div><label class="form-label" for="editIsRecurrent" style="display: inline-block; margin-left: 8px;" data-recolor>Transação Recorrente</label></div>
          <div class="form-group" id="editRecurrenceGroup" style="display: none;"><label class="form-label" for="editInstallments" data-recolor>Quantidade de Parcelas</label><input type="number" class="form-control" id="editInstallments" min="2" value="2"></div>
          <div class="form-group"><label class="form-label" for="editNotes" data-recolor>Observação (opcional)</label><textarea class="form-control" id="editNotes" rows="3"></textarea></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="cancelEditBtn" data-recolor>Cancelar</button><button type="submit" form="editForm" class="btn btn-primary" id="saveEditBtn">Salvar Alterações</button></div>
    </div>
  </div>
 
  <!-- Modal de Cartões -->
  <div class="modal-backdrop" id="cardsListModal">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title" data-recolor>Cartões</h2><span class="modal-close" id="closeCardsListModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body"><div id="cardsList"><!-- Cards via JS --></div><button class="btn btn-primary" id="newCardBtn" style="margin-top: var(--spacing-md);"><svg><use href="#icon-plus"></use></svg> Novo Cartão</button></div>
    </div>
  </div>
 
  <!-- Modal de Novo/Editar Cartão -->
  <div class="modal-backdrop" id="newCardModal">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title" data-recolor>Novo Cartão</h2><span class="modal-close" id="closeNewCardModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body">
        <form id="cardForm">
          <div class="form-group"><label class="form-label" for="cardName" data-recolor>Nome do Cartão</label><input type="text" class="form-control" id="cardName" placeholder="Ex: Nubank" required></div>
          <div class="form-group"><label class="form-label" for="cardLimit" data-recolor>Limite Total</label><input type="number" class="form-control" id="cardLimit" placeholder="0,00" min="0" step="0.01" required></div>
          <div class="form-group"><label class="form-label" for="cardClosingDay" data-recolor>Dia de Fechamento</label><input type="number" class="form-control" id="cardClosingDay" placeholder="1-31" min="1" max="31" required></div>
          <div class="form-group"><label class="form-label" for="cardDueDay" data-recolor>Dia de Vencimento</label><input type="number" class="form-control" id="cardDueDay" placeholder="1-31" min="1" max="31" required></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="cancelCardBtn" data-recolor>Cancelar</button><button type="submit" form="cardForm" class="btn btn-primary" id="saveCardBtn">Salvar Cartão</button></div>
    </div>
  </div>

  <!-- Modal de Fatura do Cartão -->
  <div class="modal-backdrop" id="cardInvoiceModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header"><h2 class="modal-title" id="cardInvoiceTitle" data-recolor>Fatura do Cartão</h2><span class="modal-close" id="closeCardInvoiceModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body">
        <div class="card" style="margin-bottom: var(--spacing-md);"><div id="cardInvoiceDetails" data-recolor><!-- Detalhes via JS --></div></div>
        <h3 data-recolor style="margin-bottom: var(--spacing-sm);">Despesas desta Fatura</h3>
        <div class="transactions-table-wrapper"><table class="transactions-table" id="cardInvoiceTable"><thead><tr><th></th><th data-recolor>Nome</th><th data-recolor>Data</th><th data-recolor>Valor</th><th data-recolor>Pago?</th></tr></thead><tbody id="cardInvoiceTableBody"><!-- Despesas via JS --></tbody></table></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="backToCardsBtn" data-recolor>Voltar</button><button type="button" class="btn btn-primary" id="payInvoiceBtn">Pagar Fatura</button></div>
    </div>
  </div>
 
  <!-- Modal de Confirmação de Exclusão -->
  <div class="modal-backdrop" id="deleteConfirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header"><h2 class="modal-title" data-recolor><svg width="20" height="20" style="vertical-align: -3px; margin-right: 8px;"><use href="#icon-alert"></use></svg>Confirmar Exclusão</h2><span class="modal-close" id="closeDeleteConfirmModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body">
        <p data-recolor>Você deseja realmente excluir esta transação? Esta ação é irreversível.</p>
        <div id="recurrenceDeleteOptions" style="display: none; margin-top: var(--spacing-md);">
          <p data-recolor><strong>Esta é uma transação recorrente. O que deseja fazer?</strong></p>
          <div class="radio-group" style="flex-direction: column; gap: var(--spacing-sm); border: none; border-radius: 0; overflow: visible;"> <!-- Ajuste para radios verticais -->
            <div class="radio-wrapper"><input type="radio" class="radio" id="deleteSingle" name="deleteOption" value="single" checked><label class="radio-label" for="deleteSingle" data-recolor style="border: 1px solid var(--color-outline); border-radius: var(--radius-md);"><span class="radio-circle" style="display: inline-block; margin-right: var(--spacing-sm);"></span> Excluir apenas esta parcela</label></div>
            <div class="radio-wrapper"><input type="radio" class="radio" id="deleteAllFuture" name="deleteOption" value="future"><label class="radio-label" for="deleteAllFuture" data-recolor style="border: 1px solid var(--color-outline); border-radius: var(--radius-md);"><span class="radio-circle" style="display: inline-block; margin-right: var(--spacing-sm);"></span> Excluir esta e as futuras</label></div>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="cancelDeleteBtn" data-recolor>Cancelar</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button></div>
    </div>
  </div>
 
  <!-- Modal de Confirmação de Pagamento de Fatura -->
  <div class="modal-backdrop" id="payInvoiceConfirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header"><h2 class="modal-title" data-recolor><svg width="20" height="20" style="vertical-align: -3px; margin-right: 8px;"><use href="#icon-credit-card"></use></svg>Pagar Fatura</h2><span class="modal-close" id="closePayInvoiceConfirmModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body">
        <p data-recolor>Confirmar pagamento de todas as despesas pendentes desta fatura?</p>
        <p style="margin-top: var(--spacing-xs);" data-recolor>Total a pagar: <strong id="invoiceConfirmAmount" data-recolor>R$ 0,00</strong></p>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="cancelPayInvoiceBtn" data-recolor>Cancelar</button><button type="button" class="btn btn-primary" id="confirmPayInvoiceBtn">Pagar</button></div>
    </div>
  </div>
 
  <!-- Modal de Categorias -->
  <div class="modal-backdrop" id="categoriesModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header"><h2 class="modal-title" data-recolor>Gerenciar Categorias</h2><span class="modal-close" id="closeCategoriesModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body" style="padding-top: 0;"> <!-- Remove padding top para colar abas -->
        <ul class="nav-tabs" id="categoryTabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" id="income-cat-tab" data-toggle="tab" href="#income-cat" role="tab" data-recolor>Receita</a></li>
          <li class="nav-item"><a class="nav-link" id="expense-cat-tab" data-toggle="tab" href="#expense-cat" role="tab" data-recolor>Despesa</a></li>
          <li class="nav-item"><a class="nav-link" id="payment-methods-tab" data-toggle="tab" href="#payment-methods" role="tab" data-recolor>Pagamento</a></li>
        </ul>
        <div class="tab-content" id="categoryTabContent">
          <div class="tab-pane fade show active" id="income-cat" role="tabpanel"><div class="category-list" id="incomeCategoriesList"><!-- Lista via JS --></div><form class="add-category-form" id="addIncomeCategoryForm"><div class="custom-icon-input"><div class="custom-icon-preview" id="newIncomeCategoryIconPreview"><svg width="24" height="24"><use href="#icon-money"></use></svg></div><input type="text" class="form-control" id="newIncomeCategoryIconInput" placeholder="Ícone"></div><input type="text" class="form-control" id="newIncomeCategoryInput" placeholder="Nova categoria de receita" required><button type="submit" class="btn btn-primary">Adicionar</button></form></div>
          <div class="tab-pane fade" id="expense-cat" role="tabpanel"><div class="category-list" id="expenseCategoriesList"><!-- Lista via JS --></div><form class="add-category-form" id="addExpenseCategoryForm"><div class="custom-icon-input"><div class="custom-icon-preview" id="newExpenseCategoryIconPreview"><svg width="24" height="24"><use href="#icon-shopping"></use></svg></div><input type="text" class="form-control" id="newExpenseCategoryIconInput" placeholder="Ícone"></div><input type="text" class="form-control" id="newExpenseCategoryInput" placeholder="Nova categoria de despesa" required><button type="submit" class="btn btn-primary">Adicionar</button></form></div>
          <div class="tab-pane fade" id="payment-methods" role="tabpanel"><div class="category-list" id="paymentMethodsList"><!-- Lista via JS --></div><form class="add-category-form" id="addPaymentMethodForm"><div class="custom-icon-input"><div class="custom-icon-preview" id="newPaymentMethodIconPreview"><svg width="24" height="24"><use href="#icon-money"></use></svg></div><input type="text" class="form-control" id="newPaymentMethodIconInput" placeholder="Ícone"></div><input type="text" class="form-control" id="newPaymentMethodInput" placeholder="Nova forma de pagamento" required><button type="submit" class="btn btn-primary">Adicionar</button></form></div>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="closeCategoriesBtn" data-recolor>Fechar</button></div>
    </div>
  </div>

  <!-- Modal de Edição de Categoria/Método -->
  <div class="modal-backdrop" id="editCategoryModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header"><h2 class="modal-title" id="editCategoryTitle" data-recolor>Editar</h2><span class="modal-close" id="closeEditCategoryModal"><svg><use href="#icon-x"></use></svg></span></div>
      <div class="modal-body">
        <form id="editCategoryForm">
          <input type="hidden" id="editCategoryId"><input type="hidden" id="editCategoryType">
          <div class="form-group"><label class="form-label" data-recolor>Ícone</label><div class="custom-icon-input"><div class="custom-icon-preview" id="editCategoryIconPreview"><svg width="24" height="24"><use href="#icon-default"></use></svg></div><input type="text" class="form-control" id="editCategoryIconInput" placeholder="Ícone (emoji)"></div></div>
          <div class="form-group"><label class="form-label" for="editCategoryName" data-recolor>Nome</label><input type="text" class="form-control" id="editCategoryName" placeholder="Nome" required></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline" id="cancelEditCategoryBtn" data-recolor>Cancelar</button><button type="submit" form="editCategoryForm" class="btn btn-primary" id="saveEditCategoryBtn">Salvar</button></div>
    </div>
  </div>
 
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"><!-- Toasts via JS --></div>
  <!-- ===== FIM: BLOCO 4 - Modais ===== -->

  <!-- ===== INÍCIO: BLOCO 5 - JavaScript Completo ===== -->
  <script>
    // ===== INÍCIO: BLOCO 5.1 - Helpers e Estado Global =====
    const $ = selector => document.querySelector(selector);
    const $$ = selector => Array.from(document.querySelectorAll(selector));
    
    const state = {
      year: new Date().getFullYear(), month: new Date().getMonth(),
      transactions: [], cards: [], filteredTransactions: [], insights: [],
      sortColumn: 'date', sortDirection: 'desc',
      filters: { category: '', status: '', paymentMethod: '' },
      categories: { income: [], expense: [] }, // Carregadas do Firebase
      paymentMethods: [], // Carregados do Firebase
      currentTransaction: null, currentCard: null, currentCategory: null,
      themePreference: 'dark' // Padrão escuro
    };
    // ===== FIM: BLOCO 5.1 - Helpers e Estado Global =====

    // ===== INÍCIO: BLOCO 5.2 - Formatadores e Utilitários =====
    const formatCurrency = value => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
    const parseLocalDateString = (dateInput) => { /* ... (código mantido igual) ... */ 
        if (!dateInput) return null;
        if (dateInput instanceof Date && !isNaN(dateInput)) return dateInput;
        if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
            const parts = dateInput.split('-');
            return new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
        }
        if (dateInput && typeof dateInput.toDate === 'function') return dateInput.toDate();
        console.warn("Formato de data inválido:", dateInput); return null;
    };
    const formatDate = (date, options = {}) => { /* ... (código mantido igual) ... */ 
        const dateObj = parseLocalDateString(date); if (!dateObj) return '-';
        const defaultOptions = { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric' };
        return dateObj.toLocaleDateString('pt-BR', { ...defaultOptions, ...options });
    };
    const localDateToISOString = (date) => { /* ... (código mantido igual) ... */ 
        if (!date || !(date instanceof Date) || isNaN(date)) return null;
        const year = date.getUTCFullYear(); const month = String(date.getUTCMonth() + 1).padStart(2, '0'); const day = String(date.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    const calcularMesReferenciaCartao = (dataLancamento, cartao) => { /* ... (código corrigido mantido igual) ... */ 
        const lancamento = parseLocalDateString(dataLancamento);
        if (!lancamento || !cartao || !cartao.closingDay) {
            console.error("Dados inválidos para calcular mês de referência:", dataLancamento, cartao);
            const fallbackDate = lancamento || new Date(); const mes = fallbackDate.getUTCMonth(); const ano = fallbackDate.getUTCFullYear();
            return { mesReferencia: mes, anoReferencia: ano, tagReferencia: `${ano}-${String(mes + 1).padStart(2, '0')}` };
        }
        const dia = lancamento.getUTCDate(); const mes = lancamento.getUTCMonth(); const ano = lancamento.getUTCFullYear();
        const fechamento = parseInt(cartao.closingDay); let mesReferencia, anoReferencia;
        if (dia > fechamento) { mesReferencia = mes + 1; } else { mesReferencia = mes; }
        if (mesReferencia > 11) { mesReferencia = 0; anoReferencia = ano + 1; } else { anoReferencia = ano; }
        return { mesReferencia, anoReferencia, tagReferencia: `${anoReferencia}-${String(mesReferencia + 1).padStart(2, '0')}` };
    };
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    // ===== FIM: BLOCO 5.2 - Formatadores e Utilitários =====

    // ===== INÍCIO: BLOCO 5.3 - Tema e Firebase =====
    const toggleTheme = () => { /* ... (código mantido igual, chama updateChartsAppearance) ... */ 
        const htmlElement = document.documentElement; const currentTheme = htmlElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        htmlElement.setAttribute('data-theme', newTheme); state.themePreference = newTheme; localStorage.setItem('themePreference', newTheme);
        document.querySelectorAll('[data-recolor]').forEach(el => { el.style.transition = 'none'; el.style.color = ''; void el.offsetWidth; el.style.transition = ''; });
        updateChartsAppearance(); // Atualiza cores dos gráficos
    };
    const initTheme = () => { /* ... (código mantido igual, padrão escuro) ... */ 
        const savedTheme = localStorage.getItem('themePreference'); const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initialTheme = savedTheme || 'dark'; document.documentElement.setAttribute('data-theme', initialTheme); state.themePreference = initialTheme;
        $('#themeToggle')?.addEventListener('click', toggleTheme);
    };
    const firebaseConfig = { /* ... (código mantido igual) ... */ 
        apiKey: "AIzaSyDvL_nYWhv_8rPouejiWbDZtDCKHYOQyEY", authDomain: "calculadora-da-familia.firebaseapp.com", projectId: "calculadora-da-familia",
        storageBucket: "calculadora-da-familia.appspot.com", messagingSenderId: "69721783786", appId: "1:69721783786:web:c4703b5c182e3681e8c693", measurementId: "G-YM5TR661S6"
    };
    let db; try { /* ... (código mantido igual) ... */ 
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore();
        db.enablePersistence({experimentalForceOwningTab: true}).catch(err => { console.warn('Persistência Firebase:', err.code); });
        console.log('Firebase inicializado.');
    } catch (error) { /* ... (código mantido igual) ... */ 
        console.error('Erro Firebase:', error); showToast('Erro de conexão com DB.', 'error');
        db = { collection: () => ({ get: () => Promise.resolve({ docs: [], empty: true, forEach: () => {} }), doc: () => ({ get: () => Promise.resolve({ exists: false, data: () => ({}) }), set: () => Promise.resolve(), update: () => Promise.resolve(), delete: () => Promise.resolve() }), add: () => Promise.resolve({ id: 'temp-id-' + generateId() }) }), batch: () => ({ set: () => {}, update: () => {}, delete: () => {}, commit: () => Promise.resolve() }) };
    }
    // ===== FIM: BLOCO 5.3 - Tema e Firebase =====

    // ===== INÍCIO: BLOCO 5.4 - Notificações (Toast) e Modais =====
    const showToast = (message, type = 'success') => { /* ... (código mantido igual) ... */ 
        const toastContainer = $('#toastContainer'); if (!toastContainer) return;
        const toast = document.createElement('div'); toast.className = `toast toast-${type}`;
        const iconName = type === 'success' ? 'icon-check' : type === 'error' ? 'icon-x' : type === 'warning' ? 'icon-alert' : 'icon-info';
        toast.innerHTML = `<div class="toast-icon"><svg><use href="#${iconName}"></use></svg></div><div class="toast-content" data-recolor>${message}</div><span class="toast-close"><svg><use href="#icon-x"></use></svg></span>`;
        toastContainer.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10);
        const closeAction = () => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); };
        toast.querySelector('.toast-close').addEventListener('click', closeAction); setTimeout(closeAction, 5000);
    };
    const openModal = modalId => { /* ... (código mantido igual) ... */ 
        const modal = $(`#${modalId}`); if (!modal) return; modal.classList.add('active'); document.body.style.overflow = 'hidden';
    };
    const closeModal = modalId => { /* ... (código mantido igual) ... */ 
        const modal = $(`#${modalId}`); if (!modal) return; modal.classList.remove('active');
        if (!$$('.modal-backdrop.active').length) { document.body.style.overflow = ''; }
    };
    const closeAllModals = () => { /* ... (código mantido igual) ... */ 
        $$('.modal-backdrop.active').forEach(modal => modal.classList.remove('active')); document.body.style.overflow = '';
    };
    // ===== FIM: BLOCO 5.4 - Notificações (Toast) e Modais =====

    // ===== INÍCIO: BLOCO 5.5 - Manipulação de Datas e Seletores =====
    const setDateInputValue = (inputId, date) => { /* ... (código mantido igual) ... */ 
        const input = $(`#${inputId}`); if (!input) return; input.value = localDateToISOString(parseLocalDateString(date));
    };
    const getDateInputValue = inputId => { /* ... (código mantido igual) ... */ 
        const input = $(`#${inputId}`); return input ? parseLocalDateString(input.value) : null;
    };
    const updateYearOptions = () => { /* ... (código mantido igual) ... */ 
        const yearSelect = $('#yearSelect'); if (!yearSelect) return; const currentYear = new Date().getFullYear();
        const startYear = 2023; const endYear = currentYear + 5; yearSelect.innerHTML = '';
        for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; option.selected = year === state.year; yearSelect.appendChild(option); }
    };
    const setMonthYearSelectors = () => { /* ... (código mantido igual) ... */ 
        const yearSelect = $('#yearSelect'); const monthSelect = $('#monthSelect');
        if (yearSelect) yearSelect.value = state.year; if (monthSelect) monthSelect.value = state.month;
    };
    // ===== FIM: BLOCO 5.5 - Manipulação de Datas e Seletores =====

    // ===== INÍCIO: BLOCO 5.6 - Carregamento e Atualização de Dados (Categorias, Métodos, Cartões) =====
    const loadCategoriesAndPaymentMethods = async () => { /* ... (código mantido igual) ... */ 
        try {
            const categoriesSnapshot = await db.collection('categories').get();
            if (!categoriesSnapshot.empty) { state.categories.income = []; state.categories.expense = []; categoriesSnapshot.forEach(doc => { const category = { id: doc.id, ...doc.data() }; if (category.type === 'income') state.categories.income.push(category); else if (category.type === 'expense') state.categories.expense.push(category); }); } 
            else { const batch = db.batch(); [...state.categories.income, ...state.categories.expense].forEach(cat => { const type = state.categories.income.includes(cat) ? 'income' : 'expense'; batch.set(db.collection('categories').doc(cat.id), { ...cat, type }); }); await batch.commit(); }
            const paymentMethodsSnapshot = await db.collection('paymentMethods').get();
            if (!paymentMethodsSnapshot.empty) { state.paymentMethods = []; paymentMethodsSnapshot.forEach(doc => state.paymentMethods.push({ id: doc.id, ...doc.data() })); } 
            else { const batch = db.batch(); state.paymentMethods.forEach(method => batch.set(db.collection('paymentMethods').doc(method.id), method)); await batch.commit(); }
            updateCategorySelects(); updatePaymentMethodSelects(); renderCategoriesList(); renderPaymentMethodsList();
        } catch (error) { console.error('Erro load config:', error); showToast('Erro ao carregar config.', 'error'); }
    };
    const updateCategorySelects = () => { /* ... (código mantido igual) ... */ 
        const selects = [$('#incomeCategory'), $('#expenseCategory'), $('#editCategory')];
        selects.forEach(select => { if (!select) return; const currentType = select.id === 'editCategory' ? select.dataset.type : select.id === 'incomeCategory' ? 'income' : 'expense'; const currentValue = select.value; select.innerHTML = ''; const categories = currentType === 'income' ? state.categories.income : state.categories.expense; categories.forEach(category => { const option = document.createElement('option'); option.value = category.id; option.textContent = `${category.icon || ''} ${category.name}`; select.appendChild(option); }); if (currentValue && categories.some(c => c.id === currentValue)) { select.value = currentValue; } });
    };
    const updatePaymentMethodSelects = () => { /* ... (código mantido igual) ... */ 
        const selects = [$('#incomePaymentMethod'), $('#expensePaymentMethod'), $('#editPaymentMethod')];
        selects.forEach(select => { if (!select) return; const currentValue = select.value; select.innerHTML = ''; state.paymentMethods.forEach(method => { const option = document.createElement('option'); option.value = method.id; option.textContent = `${method.icon || ''} ${method.name}`; select.appendChild(option); }); if (currentValue && state.paymentMethods.some(m => m.id === currentValue)) { select.value = currentValue; } });
    };
    const loadCards = async () => { /* ... (código mantido igual) ... */ 
        try { const snapshot = await db.collection('cards').get(); state.cards = []; snapshot.forEach(doc => { const card = { id: doc.id, ...doc.data() }; card.availableLimit = card.availableLimit ?? card.limit; card.currentInvoice = card.currentInvoice ?? 0; state.cards.push(card); }); updateCardsList(); updateCreditCardSelects(); updateKPIs(); } catch (error) { console.error('Erro load cards:', error); showToast('Erro ao carregar cartões.', 'error'); }
    };
    const saveCard = async (cardData, cardId = null) => { /* ... (código mantido igual) ... */ 
        try { const card = { ...cardData, availableLimit: cardId ? state.cards.find(c => c.id === cardId)?.availableLimit ?? cardData.limit : cardData.limit, currentInvoice: cardId ? state.cards.find(c => c.id === cardId)?.currentInvoice ?? 0 : 0, createdAt: cardId ? state.cards.find(c => c.id === cardId)?.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() }; if (cardId) { await db.collection('cards').doc(cardId).update(card); const index = state.cards.findIndex(c => c.id === cardId); if (index !== -1) state.cards[index] = { ...state.cards[index], ...card }; showToast('Cartão atualizado!', 'success'); } else { const docRef = await db.collection('cards').add(card); card.id = docRef.id; state.cards.push(card); showToast('Cartão adicionado!', 'success'); } updateCardsList(); updateCreditCardSelects(); updateKPIs(); } catch (error) { console.error('Erro save card:', error); showToast(`Erro ao ${cardId ? 'atualizar' : 'adicionar'} cartão.`, 'error'); }
    };
    const deleteCard = async (cardId) => { /* ... (código mantido igual) ... */ 
        try { const transactionsWithCard = state.transactions.filter(t => t.creditCardId === cardId); if (transactionsWithCard.length > 0) { if (!confirm(`Este cartão tem ${transactionsWithCard.length} transações. Excluir mesmo assim?`)) { return; } } await db.collection('cards').doc(cardId).delete(); state.cards = state.cards.filter(c => c.id !== cardId); updateCardsList(); updateCreditCardSelects(); filterTransactionsByMonth(); showToast('Cartão excluído!', 'success'); } catch (error) { console.error('Erro delete card:', error); showToast('Erro ao excluir cartão.', 'error'); }
    };
    const payCardInvoice = async (cardId) => { /* ... (código mantido igual) ... */ 
        try { const card = state.cards.find(c => c.id === cardId); if (!card) throw new Error('Cartão não encontrado.'); const today = new Date(); const currentYear = today.getFullYear(); const currentMonth = today.getMonth(); let invoiceRefMonth, invoiceRefYear; if (today.getDate() < card.dueDay) { const prevMonthDate = new Date(currentYear, currentMonth - 1, 1); invoiceRefMonth = prevMonthDate.getMonth(); invoiceRefYear = prevMonthDate.getFullYear(); } else { invoiceRefMonth = currentMonth; invoiceRefYear = currentYear; } const invoiceTransactions = state.transactions.filter(t => t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === card.id && t.mesReferencia === invoiceRefMonth && t.anoReferencia === invoiceRefYear && t.status !== 'paid'); if (invoiceTransactions.length === 0) { showToast('Nenhuma despesa pendente nesta fatura.', 'info'); closeModal('payInvoiceConfirmModal'); return; } const batch = db.batch(); let totalPaid = 0; invoiceTransactions.forEach(transaction => { const docRef = db.collection('transactions').doc(transaction.id); batch.update(docRef, { status: 'paid' }); totalPaid += parseFloat(transaction.amount); const index = state.transactions.findIndex(t => t.id === transaction.id); if (index !== -1) state.transactions[index].status = 'paid'; }); const cardRef = db.collection('cards').doc(cardId); const newAvailableLimit = Math.min(card.limit, card.availableLimit + totalPaid); batch.update(cardRef, { availableLimit: newAvailableLimit }); const cardIndex = state.cards.findIndex(c => c.id === cardId); if (cardIndex !== -1) { state.cards[cardIndex].availableLimit = newAvailableLimit; } await batch.commit(); updateCardsList(); filterTransactionsByMonth(); closeModal('payInvoiceConfirmModal'); showToast('Fatura paga!', 'success'); } catch (error) { console.error('Erro pay invoice:', error); showToast('Erro ao pagar fatura.', 'error'); }
    };
    const updateCreditCardSelects = () => { /* ... (código mantido igual) ... */ 
        const selects = [$('#expenseCreditCard'), $('#editCreditCard')]; selects.forEach(select => { if (!select) return; const currentValue = select.value; select.innerHTML = ''; if (state.cards.length === 0) { select.innerHTML = '<option value="" disabled selected>Nenhum cartão</option>'; } else { select.innerHTML = '<option value="" disabled selected>Selecione</option>'; state.cards.forEach(card => { const option = document.createElement('option'); option.value = card.id; option.textContent = `${card.name} (Disp: ${formatCurrency(card.availableLimit)})`; select.appendChild(option); }); } if (currentValue && state.cards.some(c => c.id === currentValue)) { select.value = currentValue; } });
    };
    // ===== FIM: BLOCO 5.6 - Carregamento e Atualização de Dados (Categorias, Métodos, Cartões) =====

    // ===== INÍCIO: BLOCO 5.7 - Manipulação de Transações (CRUD) =====
    const loadTransactions = async () => { /* ... (código mantido igual) ... */ 
        try { const snapshot = await db.collection('transactions').orderBy('date', 'desc').get(); state.transactions = []; snapshot.forEach(doc => { const transaction = { id: doc.id, ...doc.data() }; transaction.date = parseLocalDateString(transaction.date); transaction.dueDate = parseLocalDateString(transaction.dueDate); transaction.scheduledDate = parseLocalDateString(transaction.scheduledDate); state.transactions.push(transaction); }); filterTransactionsByMonth(); } catch (error) { console.error('Erro load transactions:', error); showToast('Erro ao carregar transações.', 'error'); }
    };
    const filterTransactionsByMonth = () => { /* ... (código mantido igual) ... */ 
        state.filteredTransactions = state.transactions.filter(transaction => { if (transaction.paymentMethod === 'credito' && transaction.mesReferencia !== undefined && transaction.anoReferencia !== undefined) { return transaction.mesReferencia === state.month && transaction.anoReferencia === state.year; } const date = transaction.date; return date && date.getUTCMonth() === state.month && date.getUTCFullYear() === state.year; });
        applySortingAndFilters(); updateKPIs(); updateCharts(); renderCommitments(); generateInsights();
    };
    const applySortingAndFilters = () => { /* ... (código mantido igual) ... */ 
        let transactionsToDisplay = [...state.filteredTransactions]; if (state.filters.category) { transactionsToDisplay = transactionsToDisplay.filter(t => t.category === state.filters.category); } if (state.filters.status) { transactionsToDisplay = transactionsToDisplay.filter(t => t.status === state.filters.status); } if (state.filters.paymentMethod) { transactionsToDisplay = transactionsToDisplay.filter(t => t.paymentMethod === state.filters.paymentMethod); }
        transactionsToDisplay.sort((a, b) => { let valueA, valueB; switch(state.sortColumn) { case 'name': valueA = a.name?.toLowerCase() || ''; valueB = b.name?.toLowerCase() || ''; break; case 'category': valueA = a.categoryName?.toLowerCase() || ''; valueB = b.categoryName?.toLowerCase() || ''; break; case 'date': valueA = a.date || 0; valueB = b.date || 0; break; case 'dueDate': valueA = a.dueDate || 0; valueB = b.dueDate || 0; break; case 'amount': valueA = parseFloat(a.amount || 0); valueB = parseFloat(b.amount || 0); break; case 'status': valueA = a.status?.toLowerCase() || ''; valueB = b.status?.toLowerCase() || ''; break; case 'paymentMethod': valueA = a.paymentMethodName?.toLowerCase() || ''; valueB = b.paymentMethodName?.toLowerCase() || ''; break; default: valueA = a.date || 0; valueB = b.date || 0; } if (valueA instanceof Date || valueB instanceof Date) { valueA = valueA instanceof Date ? valueA.getTime() : (state.sortDirection === 'asc' ? Infinity : -Infinity); valueB = valueB instanceof Date ? valueB.getTime() : (state.sortDirection === 'asc' ? Infinity : -Infinity); } let comparison = 0; if (valueA < valueB) comparison = -1; else if (valueA > valueB) comparison = 1; return state.sortDirection === 'desc' ? (comparison * -1) : comparison; });
        renderTransactionsTable(transactionsToDisplay);
    };
    const addTransaction = async (transactionData) => { /* ... (código mantido igual, usa calcularMesReferenciaCartao corrigido) ... */ 
        try { const now = new Date(); const type = transactionData.type; const category = (type === 'income' ? state.categories.income : state.categories.expense).find(c => c.id === transactionData.category); const paymentMethod = state.paymentMethods.find(m => m.id === transactionData.paymentMethod); let creditCardData = {}; let referenciaData = {}; let cardToUpdate = null; if (type === 'expense' && transactionData.paymentMethod === 'credito' && transactionData.creditCardId) { const card = state.cards.find(c => c.id === transactionData.creditCardId); if (card) { creditCardData = { creditCardId: card.id, creditCardName: card.name }; referenciaData = calcularMesReferenciaCartao(transactionData.date, card); cardToUpdate = card; } else { showToast('Cartão não encontrado.', 'error'); return; } } const isRecurrent = transactionData.isRecurrent && transactionData.installments > 1; const recurrenceId = isRecurrent ? generateId() : null; const originalAmount = parseFloat(transactionData.amount); const installments = isRecurrent ? parseInt(transactionData.installments) : 1; const installmentAmount = isRecurrent ? parseFloat((originalAmount / installments).toFixed(2)) : originalAmount; const batch = db.batch(); const transactionsToAddLocally = []; let totalCardAmountUpdate = 0;
        for (let i = 0; i < installments; i++) { const isFirstInstallment = i === 0; const currentInstallmentNumber = i + 1; const installmentDate = new Date(transactionData.date); installmentDate.setUTCMonth(installmentDate.getUTCMonth() + i); let installmentDueDate = null; if (transactionData.dueDate) { installmentDueDate = new Date(transactionData.dueDate); installmentDueDate.setUTCMonth(installmentDueDate.getUTCMonth() + i); } let installmentScheduledDate = null; if (transactionData.scheduledDate) { installmentScheduledDate = new Date(transactionData.scheduledDate); installmentScheduledDate.setUTCMonth(installmentScheduledDate.getUTCMonth() + i); } let installmentReferenciaData = {}; if (cardToUpdate) { installmentReferenciaData = calcularMesReferenciaCartao(installmentDate, cardToUpdate); }
        const parcelData = { ...transactionData, amount: installmentAmount, date: installmentDate, dueDate: installmentDueDate, scheduledDate: installmentScheduledDate, status: isFirstInstallment ? transactionData.status : (type === 'income' ? 'pending' : (installmentScheduledDate ? 'scheduled' : 'pending')), categoryName: category?.name, categoryIcon: category?.icon, paymentMethodName: paymentMethod?.name, paymentMethodIcon: paymentMethod?.icon, ...creditCardData, ...installmentReferenciaData, isRecurrent: isRecurrent, recurrenceId: recurrenceId, installments: installments, installmentNumber: currentInstallmentNumber, createdAt: now, dateString: localDateToISOString(installmentDate), dueDateString: localDateToISOString(installmentDueDate), scheduledDateString: localDateToISOString(installmentScheduledDate), }; delete parcelData.date; delete parcelData.dueDate; delete parcelData.scheduledDate; delete parcelData.type;
        const docRef = db.collection('transactions').doc(); batch.set(docRef, { ...parcelData, type: type, date: parcelData.dateString, dueDate: parcelData.dueDateString, scheduledDate: parcelData.scheduledDateString, createdAt: firebase.firestore.Timestamp.fromDate(now) }); transactionsToAddLocally.push({ ...parcelData, id: docRef.id, type: type, date: installmentDate, dueDate: installmentDueDate, scheduledDate: installmentScheduledDate, createdAt: now }); if (cardToUpdate && type === 'expense') { totalCardAmountUpdate += installmentAmount; } }
        if (cardToUpdate && totalCardAmountUpdate > 0) { const cardRef = db.collection('cards').doc(cardToUpdate.id); const newAvailableLimit = Math.max(0, cardToUpdate.availableLimit - totalCardAmountUpdate); const newCurrentInvoice = (cardToUpdate.currentInvoice || 0) + totalCardAmountUpdate; batch.update(cardRef, { availableLimit: newAvailableLimit, currentInvoice: newCurrentInvoice }); const cardIndex = state.cards.findIndex(c => c.id === cardToUpdate.id); if (cardIndex !== -1) { state.cards[cardIndex].availableLimit = newAvailableLimit; state.cards[cardIndex].currentInvoice = newCurrentInvoice; } }
        await batch.commit(); state.transactions.push(...transactionsToAddLocally); filterTransactionsByMonth(); if (cardToUpdate) { updateCardsList(); updateCreditCardSelects(); } showToast(`${type === 'income' ? 'Receita' : 'Despesa'} ${isRecurrent ? ' recorrente' : ''} adicionada!`, 'success');
        } catch (error) { console.error('Erro add transaction:', error); showToast('Erro ao adicionar transação.', 'error'); }
    };
    const updateTransaction = async (transactionId, updates) => { /* ... (código mantido igual, usa calcularMesReferenciaCartao corrigido) ... */ 
        try { const transactionIndex = state.transactions.findIndex(t => t.id === transactionId); if (transactionIndex === -1) throw new Error('Transação não encontrada.'); const originalTransaction = state.transactions[transactionIndex]; const type = originalTransaction.type; const dataToUpdate = { ...updates };
        if (updates.category && updates.category !== originalTransaction.category) { const category = (type === 'income' ? state.categories.income : state.categories.expense).find(c => c.id === updates.category); dataToUpdate.categoryName = category?.name; dataToUpdate.categoryIcon = category?.icon; } if (updates.paymentMethod && updates.paymentMethod !== originalTransaction.paymentMethod) { const paymentMethod = state.paymentMethods.find(m => m.id === updates.paymentMethod); dataToUpdate.paymentMethodName = paymentMethod?.name; dataToUpdate.paymentMethodIcon = paymentMethod?.icon; }
        let oldCardUpdate = null; let newCardUpdate = null; const originalAmount = parseFloat(originalTransaction.amount); const newAmount = parseFloat(updates.amount ?? originalTransaction.amount); const amountDifference = newAmount - originalAmount; const originalWasCredit = originalTransaction.paymentMethod === 'credito'; const newIsCredit = updates.paymentMethod === 'credito' || (originalWasCredit && !updates.paymentMethod); const originalCardId = originalTransaction.creditCardId; const newCardId = updates.creditCardId ?? (newIsCredit ? originalCardId : null);
        if (originalWasCredit && (!newIsCredit || (newIsCredit && newCardId !== originalCardId))) { const oldCard = state.cards.find(c => c.id === originalCardId); if (oldCard) { oldCardUpdate = { id: oldCard.id, availableLimit: Math.min(oldCard.limit, oldCard.availableLimit + originalAmount), currentInvoice: Math.max(0, (oldCard.currentInvoice || 0) - originalAmount) }; } if (!newIsCredit) { dataToUpdate.creditCardId = null; dataToUpdate.creditCardName = null; dataToUpdate.mesReferencia = null; dataToUpdate.anoReferencia = null; dataToUpdate.tagReferencia = null; } }
        if (newIsCredit && newCardId && (newCardId !== originalCardId || amountDifference !== 0)) { const newCard = state.cards.find(c => c.id === newCardId); if (newCard) { let adjustment = 0; if (newCardId === originalCardId) { adjustment = amountDifference; } else { adjustment = newAmount; } newCardUpdate = { id: newCard.id, availableLimit: Math.max(0, newCard.availableLimit - adjustment), currentInvoice: (newCard.currentInvoice || 0) + adjustment }; dataToUpdate.creditCardId = newCard.id; dataToUpdate.creditCardName = newCard.name; const dateForRef = updates.date || originalTransaction.date; const ref = calcularMesReferenciaCartao(dateForRef, newCard); dataToUpdate.mesReferencia = ref.mesReferencia; dataToUpdate.anoReferencia = ref.anoReferencia; dataToUpdate.tagReferencia = ref.tagReferencia; } else { showToast('Novo cartão não encontrado.', 'error'); return false; } }
        const finalDataForFirestore = { ...dataToUpdate }; if (finalDataForFirestore.date) finalDataForFirestore.date = localDateToISOString(finalDataForFirestore.date); if (finalDataForFirestore.dueDate) finalDataForFirestore.dueDate = localDateToISOString(finalDataForFirestore.dueDate); if (finalDataForFirestore.scheduledDate) finalDataForFirestore.scheduledDate = localDateToISOString(finalDataForFirestore.scheduledDate); finalDataForFirestore.updatedAt = firebase.firestore.Timestamp.now();
        const batch = db.batch(); const transactionRef = db.collection('transactions').doc(transactionId); batch.update(transactionRef, finalDataForFirestore); if (oldCardUpdate) { batch.update(db.collection('cards').doc(oldCardUpdate.id), { availableLimit: oldCardUpdate.availableLimit, currentInvoice: oldCardUpdate.currentInvoice }); } if (newCardUpdate) { batch.update(db.collection('cards').doc(newCardUpdate.id), { availableLimit: newCardUpdate.availableLimit, currentInvoice: newCardUpdate.currentInvoice }); } await batch.commit();
        state.transactions[transactionIndex] = { ...originalTransaction, ...updates, categoryName: dataToUpdate.categoryName ?? originalTransaction.categoryName, categoryIcon: dataToUpdate.categoryIcon ?? originalTransaction.categoryIcon, paymentMethodName: dataToUpdate.paymentMethodName ?? originalTransaction.paymentMethodName, paymentMethodIcon: dataToUpdate.paymentMethodIcon ?? originalTransaction.paymentMethodIcon, creditCardId: dataToUpdate.creditCardId !== undefined ? dataToUpdate.creditCardId : originalTransaction.creditCardId, creditCardName: dataToUpdate.creditCardName !== undefined ? dataToUpdate.creditCardName : originalTransaction.creditCardName, mesReferencia: dataToUpdate.mesReferencia !== undefined ? dataToUpdate.mesReferencia : originalTransaction.mesReferencia, anoReferencia: dataToUpdate.anoReferencia !== undefined ? dataToUpdate.anoReferencia : originalTransaction.anoReferencia, tagReferencia: dataToUpdate.tagReferencia !== undefined ? dataToUpdate.tagReferencia : originalTransaction.tagReferencia, updatedAt: new Date() };
        if (oldCardUpdate) { const idx = state.cards.findIndex(c => c.id === oldCardUpdate.id); if (idx !== -1) { state.cards[idx].availableLimit = oldCardUpdate.availableLimit; state.cards[idx].currentInvoice = oldCardUpdate.currentInvoice; } } if (newCardUpdate) { const idx = state.cards.findIndex(c => c.id === newCardUpdate.id); if (idx !== -1) { state.cards[idx].availableLimit = newCardUpdate.availableLimit; state.cards[idx].currentInvoice = newCardUpdate.currentInvoice; } }
        filterTransactionsByMonth(); if (oldCardUpdate || newCardUpdate) { updateCardsList(); updateCreditCardSelects(); } return true;
        } catch (error) { console.error('Erro update transaction:', error); showToast('Erro ao atualizar transação.', 'error'); return false; }
    };
    const updateTransactionStatus = async (transactionId, status) => { /* ... (código mantido igual) ... */ 
        try { const success = await updateTransaction(transactionId, { status }); if (success) { showToast(`Status atualizado!`, 'success'); } } catch (error) { /* Erro já tratado */ }
    };
    const deleteTransaction = async (transactionId, deleteOption = 'single') => { /* ... (código mantido igual) ... */ 
        try { const transactionIndex = state.transactions.findIndex(t => t.id === transactionId); if (transactionIndex === -1) throw new Error('Transação não encontrada.'); const transactionToDelete = state.transactions[transactionIndex]; const batch = db.batch(); let transactionsToRemoveLocally = [transactionId];
        if (transactionToDelete.isRecurrent && transactionToDelete.recurrenceId && deleteOption === 'future') { const futureParcels = state.transactions.filter(t => t.recurrenceId === transactionToDelete.recurrenceId && t.installmentNumber >= transactionToDelete.installmentNumber); futureParcels.forEach(parcel => { batch.delete(db.collection('transactions').doc(parcel.id)); if (parcel.id !== transactionId) { transactionsToRemoveLocally.push(parcel.id); } if (parcel.type === 'expense' && parcel.paymentMethod === 'credito' && parcel.creditCardId) { const card = state.cards.find(c => c.id === parcel.creditCardId); if (card) { const amount = parseFloat(parcel.amount); const cardRef = db.collection('cards').doc(card.id); const newAvailableLimit = Math.min(card.limit, card.availableLimit + amount); const newCurrentInvoice = Math.max(0, (card.currentInvoice || 0) - amount); batch.update(cardRef, { availableLimit: newAvailableLimit, currentInvoice: newCurrentInvoice }); const cardIndex = state.cards.findIndex(c => c.id === card.id); if (cardIndex !== -1) { state.cards[cardIndex].availableLimit = newAvailableLimit; state.cards[cardIndex].currentInvoice = newCurrentInvoice; } } } }); } 
        else { batch.delete(db.collection('transactions').doc(transactionId)); if (transactionToDelete.type === 'expense' && transactionToDelete.paymentMethod === 'credito' && transactionToDelete.creditCardId) { const card = state.cards.find(c => c.id === transactionToDelete.creditCardId); if (card) { const amount = parseFloat(transactionToDelete.amount); const cardRef = db.collection('cards').doc(card.id); const newAvailableLimit = Math.min(card.limit, card.availableLimit + amount); const newCurrentInvoice = Math.max(0, (card.currentInvoice || 0) - amount); batch.update(cardRef, { availableLimit: newAvailableLimit, currentInvoice: newCurrentInvoice }); const cardIndex = state.cards.findIndex(c => c.id === card.id); if (cardIndex !== -1) { state.cards[cardIndex].availableLimit = newAvailableLimit; state.cards[cardIndex].currentInvoice = newCurrentInvoice; } } } }
        await batch.commit(); state.transactions = state.transactions.filter(t => !transactionsToRemoveLocally.includes(t.id)); filterTransactionsByMonth(); updateCardsList(); updateCreditCardSelects(); showToast(`Transação${deleteOption === 'future' ? ' e futuras' : ''} excluída(s)!`, 'success');
        } catch (error) { console.error('Erro delete transaction:', error); showToast('Erro ao excluir transação.', 'error'); }
    };
    // ===== FIM: BLOCO 5.7 - Manipulação de Transações (CRUD) =====

    // ===== INÍCIO: BLOCO 5.8 - Gerenciamento de Categorias e Métodos (CRUD) =====
    const saveCategoryOrMethod = async (data, id = null, type) => { /* ... (código mantido igual) ... */ 
        try { const collectionName = type === 'payment' ? 'paymentMethods' : 'categories'; const stateKey = type === 'payment' ? 'paymentMethods' : (type === 'income' ? 'income' : 'expense'); const stateList = type === 'payment' ? state.paymentMethods : state.categories[stateKey]; if (!id && stateList.some(item => item.name.toLowerCase() === data.name.toLowerCase())) { showToast(`${type === 'payment' ? 'Forma de pagamento' : 'Categoria'} "${data.name}" já existe.`, 'warning'); return; } const dataToSave = { ...data }; if (type !== 'payment') dataToSave.type = type;
        if (id) { await db.collection(collectionName).doc(id).update(dataToSave); const index = stateList.findIndex(item => item.id === id); if (index !== -1) stateList[index] = { ...stateList[index], ...dataToSave }; const batch = db.batch(); const fieldPrefix = type === 'payment' ? 'paymentMethod' : 'category'; const transactionsToUpdate = state.transactions.filter(t => t[fieldPrefix] === id); transactionsToUpdate.forEach(transaction => { const docRef = db.collection('transactions').doc(transaction.id); batch.update(docRef, { [`${fieldPrefix}Name`]: dataToSave.name, [`${fieldPrefix}Icon`]: dataToSave.icon }); const tIndex = state.transactions.findIndex(t => t.id === transaction.id); if (tIndex !== -1) { state.transactions[tIndex][`${fieldPrefix}Name`] = dataToSave.name; state.transactions[tIndex][`${fieldPrefix}Icon`] = dataToSave.icon; } }); if (transactionsToUpdate.length > 0) await batch.commit(); showToast(`${type === 'payment' ? 'Forma de pagamento' : 'Categoria'} atualizada!`, 'success'); } 
        else { dataToSave.id = generateId(); await db.collection(collectionName).doc(dataToSave.id).set(dataToSave); stateList.push(dataToSave); showToast(`${type === 'payment' ? 'Forma de pagamento' : 'Categoria'} adicionada!`, 'success'); }
        if (type === 'payment') { updatePaymentMethodSelects(); renderPaymentMethodsList(); } else { updateCategorySelects(); renderCategoriesList(); } if (id && type !== 'payment') { applySortingAndFilters(); }
        } catch (error) { console.error(`Erro save ${type}:`, error); showToast(`Erro ao salvar ${type === 'payment' ? 'forma de pagamento' : 'categoria'}.`, 'error'); }
    };
    const deleteCategoryOrMethod = async (id, type) => { /* ... (código mantido igual) ... */ 
        try { const collectionName = type === 'payment' ? 'paymentMethods' : 'categories'; const stateKey = type === 'payment' ? 'paymentMethods' : (type === 'income' ? 'income' : 'expense'); const stateList = type === 'payment' ? state.paymentMethods : state.categories[stateKey]; const index = stateList.findIndex(item => item.id === id); if (index === -1) throw new Error('Item não encontrado.'); const itemToDelete = stateList[index]; const fieldPrefix = type === 'payment' ? 'paymentMethod' : 'category'; const transactionsWithItem = state.transactions.filter(t => t[fieldPrefix] === id); let defaultItemId, defaultItem; if (type === 'payment') { defaultItemId = 'dinheiro'; defaultItem = state.paymentMethods.find(m => m.id === defaultItemId); } else { defaultItemId = type === 'income' ? 'outros_income' : 'outros_expense'; defaultItem = state.categories[type].find(c => c.id === defaultItemId); } if (!defaultItem) { showToast(`Item padrão "${defaultItemId}" não encontrado.`, 'error'); return; }
        if (transactionsWithItem.length > 0) { if (!confirm(`"${itemToDelete.name}" possui ${transactionsWithItem.length} transações. Excluir e mover para "${defaultItem.name}"?`)) { return; } const batch = db.batch(); transactionsWithItem.forEach(transaction => { const docRef = db.collection('transactions').doc(transaction.id); batch.update(docRef, { [fieldPrefix]: defaultItemId, [`${fieldPrefix}Name`]: defaultItem.name, [`${fieldPrefix}Icon`]: defaultItem.icon }); const tIndex = state.transactions.findIndex(t => t.id === transaction.id); if (tIndex !== -1) { state.transactions[tIndex][fieldPrefix] = defaultItemId; state.transactions[tIndex][`${fieldPrefix}Name`] = defaultItem.name; state.transactions[tIndex][`${fieldPrefix}Icon`] = defaultItem.icon; } }); await batch.commit(); }
        await db.collection(collectionName).doc(id).delete(); stateList.splice(index, 1); if (type === 'payment') { updatePaymentMethodSelects(); renderPaymentMethodsList(); } else { updateCategorySelects(); renderCategoriesList(); } if (transactionsWithItem.length > 0) { applySortingAndFilters(); } showToast(`${type === 'payment' ? 'Forma de pagamento' : 'Categoria'} excluída!`, 'success');
        } catch (error) { console.error(`Erro delete ${type}:`, error); showToast(`Erro ao excluir ${type === 'payment' ? 'forma de pagamento' : 'categoria'}.`, 'error'); }
    };
    // ===== FIM: BLOCO 5.8 - Gerenciamento de Categorias e Métodos (CRUD) =====

    // ===== INÍCIO: BLOCO 5.9 - Renderização da UI (Tabela, KPIs, Gráficos, etc.) =====
    const updateKPIs = () => { /* ... (código mantido igual) ... */ 
        const currentMonthTransactions = state.filteredTransactions; const totalIncome = currentMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); const totalExpense = currentMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); const incomeReceived = currentMonthTransactions.filter(t => t.type === 'income' && t.status === 'received').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); const incomePending = totalIncome - incomeReceived; const expensePaid = currentMonthTransactions.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); const expensePending = totalExpense - expensePaid; const balance = incomeReceived - expensePaid;
        $('#balanceValue').textContent = formatCurrency(balance); $('#incomeValue').textContent = formatCurrency(totalIncome); $('#incomeReceivedValue').textContent = `${formatCurrency(incomeReceived)} recebidos`; $('#incomePendingValue').textContent = `${formatCurrency(incomePending)} pendentes`; $('#expenseValue').textContent = formatCurrency(totalExpense); $('#expensePaidValue').textContent = `${formatCurrency(expensePaid)} pagos`; $('#expensePendingValue').textContent = `${formatCurrency(expensePending)} pendentes`;
        const monthlyInvoiceTotal = currentMonthTransactions.filter(t => t.type === 'expense' && t.paymentMethod === 'credito' && t.status !== 'paid').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); $('#invoiceValue').textContent = formatCurrency(monthlyInvoiceTotal);
        let dueDateText = '--/--/----'; if (state.cards.length > 0) { const card = state.cards[0]; const dueDate = new Date(Date.UTC(state.year, state.month, card.dueDay)); const today = new Date(); if (state.year === today.getFullYear() && state.month === today.getMonth() && today.getDate() > card.dueDay) { dueDate.setUTCMonth(dueDate.getUTCMonth() + 1); } dueDateText = formatDate(dueDate); } $('#invoiceDueDate').textContent = dueDateText;
    };
    const renderTransactionsTable = (transactionsToRender) => { /* ... (código mantido igual, usa classes income/expense no ícone) ... */ 
        const tableBody = $('#transactionsTableBody'); if (!tableBody) return; tableBody.innerHTML = '';
        if (transactionsToRender.length === 0) { tableBody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: var(--spacing-xl);" data-recolor>Nenhuma transação encontrada.</td></tr>`; return; }
        transactionsToRender.forEach(transaction => { const row = document.createElement('tr'); const isIncome = transaction.type === 'income'; const iconClass = isIncome ? 'income' : 'expense'; const categoryIcon = transaction.categoryIcon || (isIncome ? '💰' : '📦'); const categoryName = transaction.categoryName || '-'; const paymentMethodName = transaction.paymentMethodName || '-'; const isPaid = isIncome ? transaction.status === 'received' : transaction.status === 'paid'; let statusText, statusClass; if (isIncome) { statusText = isPaid ? 'Recebido' : 'A Receber'; statusClass = isPaid ? 'badge-success' : 'badge-warning'; } else { if (isPaid) { statusText = 'Pago'; statusClass = 'badge-success'; } else if (transaction.status === 'scheduled') { statusText = 'Agendado'; statusClass = 'badge-info'; } else { statusText = 'Pendente'; statusClass = 'badge-warning'; } } const installmentText = transaction.isRecurrent && transaction.installments > 1 ? ` (${transaction.installmentNumber}/${transaction.installments})` : '';
        row.innerHTML = `<td><div class="transaction-icon ${iconClass}">${categoryIcon}</div></td> <td data-recolor>${transaction.name}${installmentText}</td> <td data-recolor>${categoryName}</td> <td data-recolor>${formatDate(transaction.date)}</td> <td data-recolor>${transaction.dueDate ? formatDate(transaction.dueDate) : '-'}</td> <td data-recolor>${formatCurrency(transaction.amount)}</td> <td><span class="badge ${statusClass}" data-recolor>${statusText}</span></td> <td data-recolor>${paymentMethodName}</td> <td><div class="checkbox-wrapper"><input type="checkbox" class="checkbox transaction-paid-checkbox" id="paid-${transaction.id}" ${isPaid ? 'checked' : ''} data-id="${transaction.id}"><label class="checkbox-label" for="paid-${transaction.id}"></label></div></td> <td class="actions-cell"><button class="btn btn-icon edit-transaction-btn" data-id="${transaction.id}" title="Editar"><svg><use href="#icon-edit"></use></svg></button><button class="btn btn-icon delete-transaction-btn" data-id="${transaction.id}" title="Excluir"><svg><use href="#icon-trash"></use></svg></button></td>`; tableBody.appendChild(row); });
        setupTableActionListeners();
    };
    const updateCardsList = () => { /* ... (código mantido igual) ... */ 
        const cardsList = $('#cardsList'); if (!cardsList) return; cardsList.innerHTML = ''; if (state.cards.length === 0) { cardsList.innerHTML = '<p style="text-align: center; padding: var(--spacing-md);" data-recolor>Nenhum cartão.</p>'; return; }
        if (state.cards.length > 1) { const totalLimit = state.cards.reduce((sum, card) => sum + parseFloat(card.limit || 0), 0); const totalAvailable = state.cards.reduce((sum, card) => sum + parseFloat(card.availableLimit || 0), 0); const totalInvoice = state.filteredTransactions.filter(t => t.type === 'expense' && t.paymentMethod === 'credito' && t.status !== 'paid').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); const limitPercentage = totalLimit > 0 ? ((totalLimit - totalAvailable) / totalLimit) * 100 : 0; const summaryElement = document.createElement('div'); summaryElement.className = 'card'; summaryElement.style.marginBottom = 'var(--spacing-xl)'; summaryElement.style.backgroundColor = 'var(--color-surface-variant)'; summaryElement.style.borderLeft = '4px solid var(--color-primary)'; summaryElement.innerHTML = `<h3 style="margin-bottom: var(--spacing-md);" data-recolor>Resumo Cartões</h3><div style="margin-bottom: var(--spacing-xs);"><div style="display: flex; justify-content: space-between;"><span data-recolor>Limite Total:</span><strong data-recolor>${formatCurrency(totalLimit)}</strong></div><div style="display: flex; justify-content: space-between;"><span data-recolor>Disponível:</span><strong data-recolor>${formatCurrency(totalAvailable)}</strong></div><div style="display: flex; justify-content: space-between; margin-top: var(--spacing-xs);"><span data-recolor>Fatura Atual:</span><strong data-recolor>${formatCurrency(totalInvoice)}</strong></div></div><div class="commitment-progress" style="margin-top: var(--spacing-md);"><div class="commitment-progress-bar" style="width: ${limitPercentage.toFixed(1)}%; background-color: ${limitPercentage > 80 ? 'var(--color-error)' : limitPercentage > 60 ? 'var(--color-warning)' : 'var(--color-primary)'}"></div></div>`; cardsList.appendChild(summaryElement); }
        state.cards.forEach(card => { const cardElement = document.createElement('div'); cardElement.className = 'card'; cardElement.style.marginBottom = 'var(--spacing-md)'; const today = new Date(); const currentYear = today.getFullYear(); const currentMonth = today.getMonth(); let nextClosingDate = new Date(Date.UTC(currentYear, currentMonth, card.closingDay)); if (today.getUTCDate() > card.closingDay) { nextClosingDate.setUTCMonth(nextClosingDate.getUTCMonth() + 1); } let nextDueDate = new Date(Date.UTC(currentYear, currentMonth, card.dueDay)); if (card.dueDay <= card.closingDay) { nextDueDate = new Date(nextClosingDate); nextDueDate.setUTCMonth(nextClosingDate.getUTCMonth() + 1); nextDueDate.setUTCDate(card.dueDay); } else { if (today.getUTCDate() > card.dueDay) { nextDueDate.setUTCMonth(nextDueDate.getUTCMonth() + 1); } } const { mesReferencia, anoReferencia } = calcularMesReferenciaCartao(today, card); const currentInvoiceValue = state.transactions.filter(t => t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === card.id && t.mesReferencia === mesReferencia && t.anoReferencia === anoReferencia && t.status !== 'paid').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); const limitPercentage = card.limit > 0 ? ((card.limit - card.availableLimit) / card.limit) * 100 : 0;
        cardElement.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);"><h3 data-recolor>${card.name}</h3><div style="display: flex; gap: var(--spacing-xs);"><button class="btn btn-icon edit-card-btn" data-id="${card.id}" title="Editar"><svg><use href="#icon-edit"></use></svg></button><button class="btn btn-icon delete-card-btn" data-id="${card.id}" title="Excluir"><svg><use href="#icon-trash"></use></svg></button></div></div><div style="margin-bottom: var(--spacing-xs);"><div style="display: flex; justify-content: space-between;"><span data-recolor>Limite:</span><strong data-recolor>${formatCurrency(card.limit)}</strong></div><div style="display: flex; justify-content: space-between;"><span data-recolor>Disponível:</span><strong data-recolor>${formatCurrency(card.availableLimit)}</strong></div></div><div class="commitment-progress" style="margin-bottom: var(--spacing-md);"><div class="commitment-progress-bar" style="width: ${limitPercentage.toFixed(1)}%; background-color: ${limitPercentage > 80 ? 'var(--color-error)' : limitPercentage > 60 ? 'var(--color-warning)' : 'var(--color-primary)'}"></div></div><div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md); font-size: var(--font-size-sm);"><div><small data-recolor>Fecha:</small><div data-recolor>${formatDate(nextClosingDate)}</div></div><div><small data-recolor>Vence:</small><div data-recolor>${formatDate(nextDueDate)}</div></div></div><div style="display: flex; justify-content: space-between; align-items: center;"><div><small data-recolor>Fatura (Ref: ${String(mesReferencia + 1).padStart(2, '0')}/${anoReferencia}):</small><div data-recolor><strong>${formatCurrency(currentInvoiceValue)}</strong></div></div><button class="btn btn-primary view-invoice-btn" data-id="${card.id}">Ver Fatura</button></div>`; cardsList.appendChild(cardElement); });
        setupCardActionListeners();
    };
    const renderCategoriesList = () => { /* ... (código mantido igual) ... */ 
        const incomeList = $('#incomeCategoriesList'); const expenseList = $('#expenseCategoriesList');
        const renderList = (listElement, categories, type) => { if (!listElement) return; listElement.innerHTML = ''; categories.forEach(category => { const item = document.createElement('div'); item.className = 'category-item'; item.innerHTML = `<div class="category-item-content"><div class="category-item-icon">${category.icon || (type === 'income' ? '💰' : '📦')}</div><div data-recolor>${category.name}</div></div><div class="category-item-actions"><button class="btn btn-icon edit-category-btn" data-id="${category.id}" data-type="${type}" title="Editar"><svg><use href="#icon-edit"></use></svg></button><button class="btn btn-icon delete-category-btn" data-id="${category.id}" data-type="${type}" title="Excluir"><svg><use href="#icon-trash"></use></svg></button></div>`; listElement.appendChild(item); }); };
        renderList(incomeList, state.categories.income, 'income'); renderList(expenseList, state.categories.expense, 'expense'); setupCategoryActionListeners();
    };
    const renderPaymentMethodsList = () => { /* ... (código mantido igual) ... */ 
        const methodsList = $('#paymentMethodsList'); if (!methodsList) return; methodsList.innerHTML = ''; state.paymentMethods.forEach(method => { const item = document.createElement('div'); item.className = 'category-item'; item.innerHTML = `<div class="category-item-content"><div class="category-item-icon">${method.icon || '💵'}</div><div data-recolor>${method.name}</div></div><div class="category-item-actions"><button class="btn btn-icon edit-payment-method-btn" data-id="${method.id}" title="Editar"><svg><use href="#icon-edit"></use></svg></button><button class="btn btn-icon delete-payment-method-btn" data-id="${method.id}" title="Excluir"><svg><use href="#icon-trash"></use></svg></button></div>`; methodsList.appendChild(item); }); setupPaymentMethodActionListeners();
    };
    const renderCommitments = () => { /* ... (código mantido igual) ... */ 
        const content = $('#commitmentsContent'); const headerIcon = $('#commitmentsHeader svg use'); if (!content || !headerIcon) return; const futureRecurrent = state.transactions.filter(t => t.isRecurrent && t.installments > 1 && t.installmentNumber < t.installments && t.date >= new Date()); const grouped = futureRecurrent.reduce((acc, t) => { if (!acc[t.recurrenceId]) { const nextInstallment = futureRecurrent.filter(p => p.recurrenceId === t.recurrenceId).sort((a, b) => a.installmentNumber - b.installmentNumber)[0]; acc[t.recurrenceId] = { ...nextInstallment, totalInstallments: t.installments, paidInstallments: nextInstallment.installmentNumber - 1 }; } return acc; }, {}); const commitments = Object.values(grouped).sort((a, b) => a.date - b.date); content.innerHTML = ''; if (commitments.length === 0) { content.innerHTML = '<p style="text-align: center; padding: var(--spacing-md);" data-recolor>Nenhum compromisso futuro.</p>'; content.style.maxHeight = null; headerIcon.setAttribute('href', '#icon-chevron-down'); return; }
        commitments.forEach(commitment => { const progress = (commitment.paidInstallments / commitment.totalInstallments) * 100; const color = commitment.type === 'income' ? 'var(--color-income)' : 'var(--color-expense)'; const icon = commitment.categoryIcon || (commitment.type === 'income' ? '💰' : '📦'); const item = document.createElement('div'); item.className = 'commitment-item'; item.innerHTML = `<div class="transaction-icon" style="background-color: ${commitment.type === 'income' ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; color: ${color};">${icon}</div><div style="flex: 1;"><div style="display: flex; justify-content: space-between;"><div data-recolor>${commitment.name}</div><div data-recolor>${formatCurrency(commitment.amount)}</div></div><div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-on-surface-variant);"><div data-recolor>${commitment.categoryName || '-'}</div><div data-recolor>Próx: ${formatDate(commitment.date)} (${commitment.installmentNumber}/${commitment.totalInstallments})</div></div><div class="commitment-progress" style="margin-top: var(--spacing-xs);"><div class="commitment-progress-bar" style="width: ${progress.toFixed(1)}%; background-color: ${color};"></div></div></div>`; content.appendChild(item); });
        if (content.style.maxHeight && content.style.maxHeight !== '0px') { content.style.maxHeight = content.scrollHeight + 'px'; headerIcon.setAttribute('href', '#icon-chevron-up'); } else { headerIcon.setAttribute('href', '#icon-chevron-down'); }
    };
    const generateInsights = () => { /* ... (código mantido igual) ... */ 
        state.insights = []; const today = new Date(); today.setUTCHours(0, 0, 0, 0); const overdue = state.transactions.filter(t => t.type === 'expense' && t.status !== 'paid' && t.dueDate && t.dueDate < today); if (overdue.length > 0) { state.insights.push({ id: 'overdue', level: 'danger', icon: 'icon-alert', message: `Você tem ${overdue.length} conta(s) vencida(s).`, actionText: 'Ver', action: () => filterByStatus('pending') }); } const soonDate = new Date(today); soonDate.setUTCDate(today.getUTCDate() + 7); const upcoming = state.transactions.filter(t => t.type === 'expense' && t.status !== 'paid' && t.dueDate && t.dueDate >= today && t.dueDate <= soonDate); if (upcoming.length > 0) { state.insights.push({ id: 'upcoming', level: 'warning', icon: 'icon-calendar', message: `${upcoming.length} conta(s) a vencer nos próximos 7 dias.`, actionText: 'Ver', action: () => filterByStatus('pending') }); } const lowLimitCards = state.cards.filter(c => c.limit > 0 && (c.availableLimit / c.limit) < 0.2); if (lowLimitCards.length > 0) { state.insights.push({ id: 'low-limit', level: 'warning', icon: 'icon-credit-card', message: `Limite baixo no cartão ${lowLimitCards[0].name}.`, actionText: 'Ver Cartões', action: () => openModal('cardsListModal') }); } const pendingIncome = state.transactions.filter(t => t.type === 'income' && t.status === 'pending'); if (pendingIncome.length > 0) { state.insights.push({ id: 'pending-income', level: 'info', icon: 'icon-money', message: `Você tem ${pendingIncome.length} receita(s) pendente(s).`, actionText: 'Ver', action: () => filterByStatus('pending') }); } renderInsights();
    };
    const renderInsights = () => { /* ... (código mantido igual) ... */ 
        const container = $('#insightsBanner'); if (!container) return; container.innerHTML = ''; if (state.insights.length === 0) { return; }
        state.insights.slice(0, 2).forEach(insight => { const el = document.createElement('div'); el.className = `insight-banner insight-${insight.level}`; el.innerHTML = `<div class="insight-icon"><svg><use href="#${insight.icon}"></use></svg></div><div class="insight-content"><div class="insight-title" data-recolor>${insight.message}</div></div><button class="btn btn-outline insight-action" data-id="${insight.id}" data-recolor>${insight.actionText}</button>`; container.appendChild(el); });
        $$('.insight-action').forEach(btn => { btn.addEventListener('click', e => { const id = e.currentTarget.dataset.id; const insight = state.insights.find(i => i.id === id); insight?.action?.(); }); });
    };
    const filterByStatus = (statusValue) => { /* ... (código mantido igual) ... */ 
        const statusSelect = $('#filter-status'); if (statusSelect) { statusSelect.value = statusValue; statusSelect.dispatchEvent(new Event('change')); } $('#transactionsTable')?.scrollIntoView({ behavior: 'smooth' });
    };
    const createTransactionFilters = () => { /* ... (código mantido igual) ... */ 
        const filtersContainer = $('#transaction-filters'); if (!filtersContainer || filtersContainer.innerHTML.trim() !== '') return;
        const categorySelectWrapper = document.createElement('div'); categorySelectWrapper.className = 'select-wrapper'; categorySelectWrapper.innerHTML = `<select id="filter-category" class="select"><option value="">Todas as categorias</option><optgroup label="Receitas">${state.categories.income.map(cat => `<option value="${cat.id}">${cat.icon || ''} ${cat.name}</option>`).join('')}</optgroup><optgroup label="Despesas">${state.categories.expense.map(cat => `<option value="${cat.id}">${cat.icon || ''} ${cat.name}</option>`).join('')}</optgroup></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span>`;
        const statusSelectWrapper = document.createElement('div'); statusSelectWrapper.className = 'select-wrapper'; statusSelectWrapper.innerHTML = `<select id="filter-status" class="select"><option value="">Todos os status</option><option value="received">Recebido</option><option value="paid">Pago</option><option value="pending">Pendente/A Receber</option><option value="scheduled">Agendado</option></select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span>`;
        const paymentMethodSelectWrapper = document.createElement('div'); paymentMethodSelectWrapper.className = 'select-wrapper'; paymentMethodSelectWrapper.innerHTML = `<select id="filter-payment-method" class="select"><option value="">Todas as formas</option>${state.paymentMethods.map(method => `<option value="${method.id}">${method.icon || ''} ${method.name}</option>`).join('')}</select><span class="select-icon"><svg width="16" height="16"><use href="#icon-chevron-down"></use></svg></span>`;
        filtersContainer.appendChild(categorySelectWrapper); filtersContainer.appendChild(statusSelectWrapper); filtersContainer.appendChild(paymentMethodSelectWrapper);
        $('#filter-category').addEventListener('change', e => { state.filters.category = e.target.value; applySortingAndFilters(); }); $('#filter-status').addEventListener('change', e => { state.filters.status = e.target.value; applySortingAndFilters(); }); $('#filter-payment-method').addEventListener('change', e => { state.filters.paymentMethod = e.target.value; applySortingAndFilters(); });
        $$('th.sortable').forEach(header => { header.addEventListener('click', () => { const column = header.dataset.sort; if (!column) return; if (state.sortColumn === column) { state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc'; } else { state.sortColumn = column; state.sortDirection = ['date', 'dueDate'].includes(column) ? 'desc' : 'asc'; } updateSortIcons(); applySortingAndFilters(); }); }); updateSortIcons();
    };
    const updateSortIcons = () => { /* ... (código mantido igual) ... */ 
        $$('th.sortable .transaction-sort-icon').forEach(icon => icon.innerHTML = ''); const activeHeader = $(`th[data-sort="${state.sortColumn}"] .transaction-sort-icon`); if (activeHeader) { const iconName = state.sortDirection === 'asc' ? 'icon-sort-asc' : 'icon-sort-desc'; activeHeader.innerHTML = `<svg width="14" height="14"><use href="#${iconName}"></use></svg>`; }
    };
    // ===== FIM: BLOCO 5.9 - Renderização da UI =====

    // ===== INÍCIO: BLOCO 5.10 - Gráficos (Chart.js) =====
    let pieChart = null; let barChart = null; // Instâncias dos gráficos

    // Função para obter cores do tema atual para os gráficos
    const getChartColors = () => {
        const isDark = state.themePreference === 'dark';
        // Função auxiliar para obter valor da variável CSS
        const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        return {
            textColor: getCssVar('--color-on-surface'),
            gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)',
            tooltipBg: isDark ? 'rgba(40, 40, 40, 0.85)' : 'rgba(255, 255, 255, 0.85)',
            tooltipColor: getCssVar('--color-on-surface'),
            pieBorder: getCssVar('--color-background'), // Borda da cor do fundo
            incomeColor: getCssVar('--color-income'),
            expenseColor: getCssVar('--color-expense'),
            categoryColors: [ getCssVar('--color-primary'), getCssVar('--color-success'), getCssVar('--color-warning'), getCssVar('--color-error'), '#af52de', '#5ac8fa' ] // Cores base + exemplos
        };
    };

    const createCharts = () => {
      const pieCtx = $('#catPie')?.getContext('2d');
      const barCtx = $('#annualBars')?.getContext('2d');
      if (!pieCtx || !barCtx) return; // Sai se canvas não existem

      const colors = getChartColors();

      // Configurações globais do Chart.js para o estilo Apple
      Chart.defaults.font.family = "'Inter', sans-serif";
      Chart.defaults.plugins.legend.display = false; // Remove legenda padrão, faremos customizada se necessário
      Chart.defaults.plugins.tooltip.backgroundColor = colors.tooltipBg;
      Chart.defaults.plugins.tooltip.titleColor = colors.tooltipColor;
      Chart.defaults.plugins.tooltip.bodyColor = colors.tooltipColor;
      Chart.defaults.plugins.tooltip.borderColor = colors.gridColor;
      Chart.defaults.plugins.tooltip.borderWidth = 1;
      Chart.defaults.plugins.tooltip.padding = 10;
      Chart.defaults.plugins.tooltip.usePointStyle = true;
      Chart.defaults.plugins.tooltip.boxPadding = 3;
      Chart.defaults.plugins.tooltip.multiKeyBackground = 'transparent'; // Fundo da cor no tooltip
      Chart.defaults.plugins.tooltip.titleFont = { weight: '600' };
      Chart.defaults.plugins.tooltip.bodyFont = { weight: '400' };

      if (!pieChart) {
        pieChart = new Chart(pieCtx, {
          type: 'doughnut',
          data: { labels: [], datasets: [{ data: [], backgroundColor: colors.categoryColors, borderColor: colors.pieBorder, borderWidth: 2, hoverOffset: 8 }] },
          options: { 
            responsive: true, maintainAspectRatio: false, cutout: '65%',
            plugins: { 
                tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.parsed)} (${((c.parsed / c.dataset.data.reduce((a, b) => a + b, 1)) * 100).toFixed(0)}%)` } }, // Evita divisão por zero
                legend: { display: true, position: 'bottom', labels: { color: colors.textColor, padding: 15, usePointStyle: true, pointStyle: 'circle', font: { size: 12 } } }
            } 
          }
        });
      }
      if (!barChart) {
        barChart = new Chart(barCtx, {
          type: 'bar',
          data: { labels: [], datasets: [ { label: 'Receitas', data: [], backgroundColor: colors.incomeColor, borderRadius: 4 }, { label: 'Despesas', data: [], backgroundColor: colors.expenseColor, borderRadius: 4 } ] },
          options: { 
            responsive: true, maintainAspectRatio: false, 
            scales: { 
                x: { grid: { display: false }, ticks: { color: colors.textColor } }, 
                y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.textColor, callback: v => formatCurrency(v).replace(/\s/g, '') } } 
            }, 
            plugins: { 
                tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.parsed.y)}` } },
                legend: { display: true, position: 'top', align: 'end', labels: { color: colors.textColor, usePointStyle: true, pointStyle: 'rectRounded', boxWidth: 10, boxHeight: 10, padding: 10, font: { size: 12 } } }
            } 
          }
        });
      }
    };

    // Atualiza dados e aparência dos gráficos
    const updateCharts = () => {
        if (!pieChart || !barChart) createCharts(); // Garante que foram criados
        if (!pieChart || !barChart) return;

        const colors = getChartColors(); // Pega cores atuais do tema

        // Atualiza cores globais e específicas dos gráficos
        Chart.defaults.color = colors.textColor;
        Chart.defaults.borderColor = colors.gridColor;
        Chart.defaults.plugins.tooltip.backgroundColor = colors.tooltipBg;
        Chart.defaults.plugins.tooltip.titleColor = colors.tooltipColor;
        Chart.defaults.plugins.tooltip.bodyColor = colors.tooltipColor;
        Chart.defaults.plugins.tooltip.borderColor = colors.gridColor;

        // 1. Gráfico de Pizza (Despesas por Categoria - Mês Atual)
        const categoryTotals = state.filteredTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { const name = t.categoryName || 'Sem Categoria'; acc[name] = (acc[name] || 0) + parseFloat(t.amount || 0); return acc; }, {});
        pieChart.data.labels = Object.keys(categoryTotals);
        pieChart.data.datasets[0].data = Object.values(categoryTotals);
        pieChart.data.datasets[0].backgroundColor = colors.categoryColors; // Atualiza cores se necessário
        pieChart.data.datasets[0].borderColor = colors.pieBorder;
        pieChart.options.plugins.legend.labels.color = colors.textColor;
        pieChart.update();

        // 2. Gráfico de Barras (Receitas x Despesas - Últimos 12 meses)
        const annualData = {}; const endDate = new Date(state.year, state.month + 1, 0);
        for (let i = 0; i < 12; i++) { const date = new Date(endDate); date.setUTCMonth(endDate.getUTCMonth() - i); const year = date.getUTCFullYear(); const month = date.getUTCMonth(); const key = `${year}-${String(month).padStart(2, '0')}`; annualData[key] = { income: 0, expense: 0, label: date.toLocaleString('pt-BR', { month: 'short', year: '2-digit', timeZone: 'UTC' }) }; }
        state.transactions.forEach(t => { const date = t.date; if (!date) return; const year = date.getUTCFullYear(); const month = date.getUTCMonth(); const key = `${year}-${String(month).padStart(2, '0')}`; if (annualData[key]) { if (t.type === 'income') annualData[key].income += parseFloat(t.amount || 0); else annualData[key].expense += parseFloat(t.amount || 0); } });
        const sortedKeys = Object.keys(annualData).sort();
        barChart.data.labels = sortedKeys.map(key => annualData[key].label);
        barChart.data.datasets[0].data = sortedKeys.map(key => annualData[key].income);
        barChart.data.datasets[0].backgroundColor = colors.incomeColor; // Atualiza cor
        barChart.data.datasets[1].data = sortedKeys.map(key => annualData[key].expense);
        barChart.data.datasets[1].backgroundColor = colors.expenseColor; // Atualiza cor
        barChart.options.scales.x.ticks.color = colors.textColor;
        barChart.options.scales.y.ticks.color = colors.textColor;
        barChart.options.scales.y.grid.color = colors.gridColor;
        barChart.options.plugins.legend.labels.color = colors.textColor;
        barChart.update();
    };

    // Função separada para atualizar apenas a aparência (chamada no toggleTheme)
    const updateChartsAppearance = () => {
        if (!pieChart || !barChart) return;
        const colors = getChartColors();
        // Atualiza cores globais e específicas como em updateCharts
        Chart.defaults.color = colors.textColor; Chart.defaults.borderColor = colors.gridColor; Chart.defaults.plugins.tooltip.backgroundColor = colors.tooltipBg; Chart.defaults.plugins.tooltip.titleColor = colors.tooltipColor; Chart.defaults.plugins.tooltip.bodyColor = colors.tooltipColor; Chart.defaults.plugins.tooltip.borderColor = colors.gridColor;
        if (pieChart) { pieChart.data.datasets[0].borderColor = colors.pieBorder; pieChart.options.plugins.legend.labels.color = colors.textColor; pieChart.update('none'); } // 'none' para evitar re-animação
        if (barChart) { barChart.options.scales.x.ticks.color = colors.textColor; barChart.options.scales.y.ticks.color = colors.textColor; barChart.options.scales.y.grid.color = colors.gridColor; barChart.options.plugins.legend.labels.color = colors.textColor; barChart.data.datasets[0].backgroundColor = colors.incomeColor; barChart.data.datasets[1].backgroundColor = colors.expenseColor; barChart.update('none'); }
    };
    // ===== FIM: BLOCO 5.10 - Gráficos (Chart.js) =====

    // ===== INÍCIO: BLOCO 5.11 - Funções de Abertura de Modais =====
    const openNewIncomeModal = () => { /* ... (código mantido igual) ... */ 
        $('#incomeForm').reset(); setDateInputValue('incomeDate', new Date()); updateCategorySelects(); updatePaymentMethodSelects(); $('#incomeRecurrenceGroup').style.display = 'none'; openModal('incomeModal');
    };
    const openNewExpenseModal = () => { /* ... (código mantido igual) ... */ 
        $('#expenseForm').reset(); const today = new Date(); setDateInputValue('expenseDate', today); setDateInputValue('expenseDueDate', today); updateCategorySelects(); updatePaymentMethodSelects(); updateCreditCardSelects(); $('#creditCardGroup').style.display = 'none'; $('#expenseDueDateGroup').style.display = 'block'; $('#scheduledDateGroup').style.display = 'none'; $('#expenseRecurrenceGroup').style.display = 'none'; $('input[name="expenseStatus"][value="pending"]').checked = true; openModal('expenseModal');
    };
    const openEditTransactionModal = (transaction) => { /* ... (código mantido igual) ... */ 
        state.currentTransaction = transaction; const form = $('#editForm'); if (!form) return; const isIncome = transaction.type === 'income'; $('#editModalTitle').textContent = `Editar ${isIncome ? 'Receita' : 'Despesa'}`; $('#editTransactionId').value = transaction.id; $('#editTransactionType').value = transaction.type; $('#editName').value = transaction.name; $('#editAmount').value = transaction.amount; const editCategorySelect = $('#editCategory'); editCategorySelect.dataset.type = transaction.type; updateCategorySelects(); editCategorySelect.value = transaction.category; setDateInputValue('editDate', transaction.date); const editDueDateGroup = $('#editDueDateGroup'); const editScheduledDateGroup = $('#editScheduledDateGroup'); const statusGroup = $('#editStatusGroup'); statusGroup.innerHTML = '';
        if (isIncome) { statusGroup.innerHTML = `<div class="radio-wrapper"><input type="radio" class="radio" id="editStatusReceived" name="editStatus" value="received" ${transaction.status === 'received' ? 'checked' : ''}><label class="radio-label" for="editStatusReceived" data-recolor>Recebido</label></div><div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPendingIncome" name="editStatus" value="pending" ${transaction.status === 'pending' ? 'checked' : ''}><label class="radio-label" for="editStatusPendingIncome" data-recolor>A Receber</label></div>`; editDueDateGroup.style.display = 'none'; editScheduledDateGroup.style.display = 'none'; } 
        else { statusGroup.innerHTML = `<div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPaid" name="editStatus" value="paid" ${transaction.status === 'paid' ? 'checked' : ''}><label class="radio-label" for="editStatusPaid" data-recolor>Pago</label></div><div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPendingExpense" name="editStatus" value="pending" ${transaction.status === 'pending' ? 'checked' : ''}><label class="radio-label" for="editStatusPendingExpense" data-recolor>Pendente</label></div><div class="radio-wrapper"><input type="radio" class="radio" id="editStatusScheduled" name="editStatus" value="scheduled" ${transaction.status === 'scheduled' ? 'checked' : ''}><label class="radio-label" for="editStatusScheduled" data-recolor>Agendado</label></div>`; $$('input[name="editStatus"]').forEach(radio => { radio.addEventListener('change', e => { editScheduledDateGroup.style.display = e.target.value === 'scheduled' ? 'block' : 'none'; }); }); editScheduledDateGroup.style.display = transaction.status === 'scheduled' ? 'block' : 'none'; setDateInputValue('editScheduledDate', transaction.scheduledDate); editDueDateGroup.style.display = transaction.paymentMethod !== 'credito' ? 'block' : 'none'; setDateInputValue('editDueDate', transaction.dueDate); }
        const paymentMethodSelect = $('#editPaymentMethod'); const creditCardGroup = $('#editCreditCardGroup'); updatePaymentMethodSelects(); paymentMethodSelect.value = transaction.paymentMethod; updateCreditCardSelects(); $('#editCreditCard').value = transaction.creditCardId; creditCardGroup.style.display = transaction.paymentMethod === 'credito' ? 'block' : 'none'; paymentMethodSelect.removeEventListener('change', handleEditPaymentMethodChange); paymentMethodSelect.addEventListener('change', handleEditPaymentMethodChange);
        const isRecurrentCheckbox = $('#editIsRecurrent'); const recurrenceGroup = $('#editRecurrenceGroup'); isRecurrentCheckbox.checked = transaction.isRecurrent || false; recurrenceGroup.style.display = transaction.isRecurrent ? 'block' : 'none'; $('#editInstallments').value = transaction.installments || 2; isRecurrentCheckbox.removeEventListener('change', handleEditRecurrenceChange); isRecurrentCheckbox.addEventListener('change', handleEditRecurrenceChange); $('#editNotes').value = transaction.notes || ''; openModal('editModal');
    };
    const handleEditPaymentMethodChange = (e) => { /* ... (código mantido igual) ... */ 
        const isCredit = e.target.value === 'credito'; $('#editCreditCardGroup').style.display = isCredit ? 'block' : 'none'; const type = $('#editTransactionType').value; $('#editDueDateGroup').style.display = (type === 'expense' && !isCredit) ? 'block' : 'none';
    };
    const handleEditRecurrenceChange = (e) => { /* ... (código mantido igual) ... */ 
        $('#editRecurrenceGroup').style.display = e.target.checked ? 'block' : 'none';
    };
    const openNewCardModal = () => { /* ... (código mantido igual) ... */ 
        state.currentCard = null; $('#cardForm').reset(); $('.modal-title', $('#newCardModal')).textContent = 'Novo Cartão'; openModal('newCardModal');
    };
    const openEditCardModal = (card) => { /* ... (código mantido igual) ... */ 
        state.currentCard = card; $('#cardName').value = card.name; $('#cardLimit').value = card.limit; $('#cardClosingDay').value = card.closingDay; $('#cardDueDay').value = card.dueDay; $('.modal-title', $('#newCardModal')).textContent = 'Editar Cartão'; openModal('newCardModal');
    };
    const openCardInvoiceModal = cardId => { /* ... (código mantido igual) ... */ 
        const card = state.cards.find(c => c.id === cardId); if (!card) return; state.currentCard = card; const today = new Date(); const { mesReferencia, anoReferencia } = calcularMesReferenciaCartao(today, card); const invoiceRefTag = `${String(mesReferencia + 1).padStart(2, '0')}/${anoReferencia}`; const closingDate = new Date(Date.UTC(anoReferencia, mesReferencia, card.closingDay)); let dueDate = new Date(Date.UTC(anoReferencia, mesReferencia, card.dueDay)); if (card.dueDay <= card.closingDay) { dueDate.setUTCMonth(dueDate.getUTCMonth() + 1); } const previousClosing = new Date(closingDate); previousClosing.setUTCMonth(previousClosing.getUTCMonth() - 1); const startDate = new Date(previousClosing); startDate.setUTCDate(startDate.getUTCDate() + 1);
        const invoiceTransactions = state.transactions.filter(t => t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === card.id && t.mesReferencia === mesReferencia && t.anoReferencia === anoReferencia).sort((a, b) => b.date - a.date); const invoiceTotal = invoiceTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        $('#cardInvoiceTitle').textContent = `Fatura ${card.name} - Ref: ${invoiceRefTag}`; $('#cardInvoiceDetails').innerHTML = `<div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);"><div data-recolor><strong>Período:</strong> ${formatDate(startDate)} - ${formatDate(closingDate)}</div><div data-recolor><strong>Vencimento:</strong> ${formatDate(dueDate)}</div></div><div style="display: flex; justify-content: space-between;"><div data-recolor><strong>Limite:</strong> ${formatCurrency(card.limit)}</div><div data-recolor><strong>Disponível:</strong> ${formatCurrency(card.availableLimit)}</div></div><div style="margin-top: var(--spacing-xs);" data-recolor><strong>Total Fatura: ${formatCurrency(invoiceTotal)}</strong></div>`;
        const tableBody = $('#cardInvoiceTableBody'); tableBody.innerHTML = ''; if (invoiceTransactions.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: var(--spacing-xl);" data-recolor>Nenhuma despesa.</td></tr>`; } else { invoiceTransactions.forEach(t => { const row = document.createElement('tr'); const isPaid = t.status === 'paid'; row.innerHTML = `<td><div class="transaction-icon expense">${t.categoryIcon || '📦'}</div></td><td data-recolor>${t.name}</td><td data-recolor>${formatDate(t.date)}</td><td data-recolor>${formatCurrency(t.amount)}</td><td><div class="checkbox-wrapper"><input type="checkbox" class="checkbox invoice-paid-checkbox" id="invoice-paid-${t.id}" ${isPaid ? 'checked' : ''} data-id="${t.id}"><label class="checkbox-label" for="invoice-paid-${t.id}"></label></div></td>`; tableBody.appendChild(row); }); $$('.invoice-paid-checkbox').forEach(checkbox => { checkbox.addEventListener('change', e => { const id = e.target.dataset.id; updateTransactionStatus(id, e.target.checked ? 'paid' : 'pending'); }); }); }
        $('#invoiceConfirmAmount').textContent = formatCurrency(invoiceTotal); $('#payInvoiceBtn').disabled = invoiceTransactions.filter(t => t.status !== 'paid').length === 0; closeModal('cardsListModal'); openModal('cardInvoiceModal');
    };
    const openCategoriesModal = () => { /* ... (código mantido igual) ... */ 
        renderCategoriesList(); renderPaymentMethodsList(); handleToggleCategoryTab('income-cat'); openModal('categoriesModal');
    };
    const openEditCategoryModal = (item, type) => { /* ... (código mantido igual) ... */ 
        state.currentCategory = { ...item, type }; $('#editCategoryId').value = item.id; $('#editCategoryType').value = type; $('#editCategoryName').value = item.name; $('#editCategoryIconInput').value = item.icon || ''; $('#editCategoryIconPreview').innerHTML = item.icon || '<svg width="24" height="24"><use href="#icon-default"></use></svg>'; const titlePrefix = type === 'payment' ? 'Forma de Pagamento' : 'Categoria'; $('#editCategoryTitle').textContent = `Editar ${titlePrefix}`; openModal('editCategoryModal');
    };
    const openDeleteConfirmModal = (transaction) => { /* ... (código mantido igual) ... */ 
        state.currentTransaction = transaction; const isRecurrent = transaction.isRecurrent && transaction.installments > 1; const recurrenceOptions = $('#recurrenceDeleteOptions'); if (recurrenceOptions) { recurrenceOptions.style.display = isRecurrent ? 'block' : 'none'; if (isRecurrent) { $('#deleteSingle').checked = true; } } openModal('deleteConfirmModal');
    };
    // ===== FIM: BLOCO 5.10 - Funções de Abertura de Modais =====

    // ===== INÍCIO: BLOCO 5.11 - Handlers de Eventos (Cliques, Submits, Changes) =====
    const handleSaveIncome = async (event) => { /* ... (código mantido igual) ... */ 
        event.preventDefault(); const name = $('#incomeName').value.trim(); const amount = parseFloat($('#incomeAmount').value); const category = $('#incomeCategory').value; const date = getDateInputValue('incomeDate'); if (!name || !amount || isNaN(amount) || amount <= 0 || !category || !date) { showToast('Preencha nome, valor, categoria e data.', 'error'); return; } const incomeData = { name, amount, category, date, status: $('input[name="incomeStatus"]:checked').value, paymentMethod: $('#incomePaymentMethod').value, isRecurrent: $('#incomeIsRecurrent').checked, installments: parseInt($('#incomeInstallments').value) || 1, notes: $('#incomeNotes').value.trim(), type: 'income' }; await addTransaction(incomeData); closeModal('incomeModal');
    };
    const handleSaveExpense = async (event) => { /* ... (código mantido igual) ... */ 
        event.preventDefault(); const name = $('#expenseName').value.trim(); const amount = parseFloat($('#expenseAmount').value); const category = $('#expenseCategory').value; const date = getDateInputValue('expenseDate'); const paymentMethod = $('#expensePaymentMethod').value; const isCredit = paymentMethod === 'credito'; const dueDate = isCredit ? null : getDateInputValue('expenseDueDate'); const status = $('input[name="expenseStatus"]:checked').value; const scheduledDate = status === 'scheduled' ? getDateInputValue('expenseScheduledDate') : null; const creditCardId = isCredit ? $('#expenseCreditCard').value : null; if (!name || !amount || isNaN(amount) || amount <= 0 || !category || !date) { showToast('Preencha nome, valor, categoria e data.', 'error'); return; } if (!isCredit && !dueDate) { showToast('Informe a data de vencimento.', 'error'); return; } if (status === 'scheduled' && !scheduledDate) { showToast('Informe a data de agendamento.', 'error'); return; } if (isCredit && !creditCardId) { showToast('Selecione um cartão.', 'error'); return; } const expenseData = { name, amount, category, date, dueDate, status, paymentMethod, creditCardId, scheduledDate, isRecurrent: $('#expenseIsRecurrent').checked, installments: parseInt($('#expenseInstallments').value) || 1, notes: $('#expenseNotes').value.trim(), type: 'expense' }; await addTransaction(expenseData); closeModal('expenseModal');
    };
    const handleSaveEdit = async (event) => { /* ... (código mantido igual) ... */ 
        event.preventDefault(); if (!state.currentTransaction) return; const id = state.currentTransaction.id; const type = state.currentTransaction.type; const name = $('#editName').value.trim(); const amount = parseFloat($('#editAmount').value); const category = $('#editCategory').value; const date = getDateInputValue('editDate'); const paymentMethod = $('#editPaymentMethod').value; const isCredit = paymentMethod === 'credito'; const status = $('input[name="editStatus"]:checked').value; const dueDate = (type === 'expense' && !isCredit) ? getDateInputValue('editDueDate') : null; const scheduledDate = (type === 'expense' && status === 'scheduled') ? getDateInputValue('editScheduledDate') : null; const creditCardId = (type === 'expense' && isCredit) ? $('#editCreditCard').value : null; if (!name || !amount || isNaN(amount) || amount <= 0 || !category || !date) { showToast('Preencha nome, valor, categoria e data.', 'error'); return; } if (type === 'expense' && !isCredit && !dueDate) { showToast('Informe data de vencimento.', 'error'); return; } if (type === 'expense' && status === 'scheduled' && !scheduledDate) { showToast('Informe data de agendamento.', 'error'); return; } if (type === 'expense' && isCredit && !creditCardId) { showToast('Selecione um cartão.', 'error'); return; } const updates = { name, amount, category, date, status, paymentMethod, dueDate, scheduledDate, creditCardId, isRecurrent: $('#editIsRecurrent').checked, installments: parseInt($('#editInstallments').value) || 1, notes: $('#editNotes').value.trim(), }; const success = await updateTransaction(id, updates); if (success) closeModal('editModal');
    };
    const handleSaveCard = async (event) => { /* ... (código mantido igual) ... */ 
        event.preventDefault(); const name = $('#cardName').value.trim(); const limit = parseFloat($('#cardLimit').value); const closingDay = parseInt($('#cardClosingDay').value); const dueDay = parseInt($('#cardDueDay').value); if (!name || !limit || isNaN(limit) || limit <= 0 || !closingDay || isNaN(closingDay) || closingDay < 1 || closingDay > 31 || !dueDay || isNaN(dueDay) || dueDay < 1 || dueDay > 31) { showToast('Preencha os campos do cartão.', 'error'); return; } const cardData = { name, limit, closingDay, dueDay }; await saveCard(cardData, state.currentCard?.id); state.currentCard = null; closeModal('newCardModal');
    };
    const handleSaveCategoryOrMethod = async (event) => { /* ... (código mantido igual) ... */ 
        event.preventDefault(); if (!state.currentCategory) return; const name = $('#editCategoryName').value.trim(); if (!name) { showToast('O nome é obrigatório.', 'error'); return; } const updates = { name, icon: $('#editCategoryIconInput').value.trim() || null }; await saveCategoryOrMethod(updates, state.currentCategory.id, state.currentCategory.type); state.currentCategory = null; closeModal('editCategoryModal');
    };
    const handleDeleteTransaction = async () => { /* ... (código mantido igual) ... */ 
        if (!state.currentTransaction) return; const deleteOption = $('#deleteAllFuture')?.checked ? 'future' : 'single'; await deleteTransaction(state.currentTransaction.id, deleteOption); state.currentTransaction = null; closeModal('deleteConfirmModal');
    };
    const handlePayInvoice = async () => { /* ... (código mantido igual) ... */ 
        if (!state.currentCard) return; openModal('payInvoiceConfirmModal');
    };
    const handleConfirmPayInvoice = async () => { /* ... (código mantido igual) ... */ 
        if (!state.currentCard) return; await payCardInvoice(state.currentCard.id);
    };
    const handleAddCategory = async (event, type) => { /* ... (código mantido igual) ... */ 
        event.preventDefault(); const nameInput = $(`#new${type === 'income' ? 'Income' : 'Expense'}CategoryInput`); const iconInput = $(`#new${type === 'income' ? 'Income' : 'Expense'}CategoryIconInput`); const name = nameInput.value.trim(); if (!name) { showToast('Informe o nome.', 'error'); return; } const data = { name, icon: iconInput.value.trim() || null }; await saveCategoryOrMethod(data, null, type); nameInput.value = ''; iconInput.value = ''; $(`#new${type === 'income' ? 'Income' : 'Expense'}CategoryIconPreview`).innerHTML = `<svg width="24" height="24"><use href="#${type === 'income' ? 'icon-money' : 'icon-shopping'}"></use></svg>`;
    };
    const handleAddPaymentMethod = async (event) => { /* ... (código mantido igual) ... */ 
        event.preventDefault(); const nameInput = $(`#newPaymentMethodInput`); const iconInput = $(`#newPaymentMethodIconInput`); const name = nameInput.value.trim(); if (!name) { showToast('Informe o nome.', 'error'); return; } const data = { name, icon: iconInput.value.trim() || null }; await saveCategoryOrMethod(data, null, 'payment'); nameInput.value = ''; iconInput.value = ''; $(`#newPaymentMethodIconPreview`).innerHTML = `<svg width="24" height="24"><use href="#icon-money"></use></svg>`;
    };
    const setupEventListeners = () => { /* ... (código mantido igual, adiciona submit aos forms) ... */ 
        $('#yearSelect')?.addEventListener('change', e => { state.year = parseInt(e.target.value); filterTransactionsByMonth(); }); $('#monthSelect')?.addEventListener('change', e => { state.month = parseInt(e.target.value); filterTransactionsByMonth(); });
        $('#newIncomeBtn')?.addEventListener('click', openNewIncomeModal); $('#newExpenseBtn')?.addEventListener('click', openNewExpenseModal); $('#cardsBtn')?.addEventListener('click', () => openModal('cardsListModal')); $('#categoriesBtn')?.addEventListener('click', openCategoriesModal);
        $('#incomeForm')?.addEventListener('submit', handleSaveIncome); $('#cancelIncomeBtn')?.addEventListener('click', () => closeModal('incomeModal')); $('#closeIncomeModal')?.addEventListener('click', () => closeModal('incomeModal')); $('#incomeIsRecurrent')?.addEventListener('change', e => { $('#incomeRecurrenceGroup').style.display = e.target.checked ? 'block' : 'none'; });
        $('#expenseForm')?.addEventListener('submit', handleSaveExpense); $('#cancelExpenseBtn')?.addEventListener('click', () => closeModal('expenseModal')); $('#closeExpenseModal')?.addEventListener('click', () => closeModal('expenseModal')); $('#expenseIsRecurrent')?.addEventListener('change', e => { $('#expenseRecurrenceGroup').style.display = e.target.checked ? 'block' : 'none'; }); $('#expensePaymentMethod')?.addEventListener('change', e => { const isCredit = e.target.value === 'credito'; $('#creditCardGroup').style.display = isCredit ? 'block' : 'none'; $('#expenseDueDateGroup').style.display = isCredit ? 'none' : 'block'; }); $$('input[name="expenseStatus"]').forEach(radio => radio.addEventListener('change', e => { $('#scheduledDateGroup').style.display = e.target.value === 'scheduled' ? 'block' : 'none'; }));
        $('#editForm')?.addEventListener('submit', handleSaveEdit); $('#cancelEditBtn')?.addEventListener('click', () => closeModal('editModal')); $('#closeEditModal')?.addEventListener('click', () => closeModal('editModal'));
        $('#newCardBtn')?.addEventListener('click', openNewCardModal); $('#closeCardsListModal')?.addEventListener('click', () => closeModal('cardsListModal'));
        $('#cardForm')?.addEventListener('submit', handleSaveCard); $('#cancelCardBtn')?.addEventListener('click', () => { state.currentCard = null; closeModal('newCardModal'); }); $('#closeNewCardModal')?.addEventListener('click', () => { state.currentCard = null; closeModal('newCardModal'); });
        $('#payInvoiceBtn')?.addEventListener('click', handlePayInvoice); $('#backToCardsBtn')?.addEventListener('click', () => { closeModal('cardInvoiceModal'); openModal('cardsListModal'); }); $('#closeCardInvoiceModal')?.addEventListener('click', () => closeModal('cardInvoiceModal'));
        $('#confirmPayInvoiceBtn')?.addEventListener('click', handleConfirmPayInvoice); $('#cancelPayInvoiceBtn')?.addEventListener('click', () => closeModal('payInvoiceConfirmModal')); $('#closePayInvoiceConfirmModal')?.addEventListener('click', () => closeModal('payInvoiceConfirmModal'));
        $('#closeCategoriesModal')?.addEventListener('click', () => closeModal('categoriesModal')); $('#closeCategoriesBtn')?.addEventListener('click', () => closeModal('categoriesModal')); $('#income-cat-tab')?.addEventListener('click', () => handleToggleCategoryTab('income-cat')); $('#expense-cat-tab')?.addEventListener('click', () => handleToggleCategoryTab('expense-cat')); $('#payment-methods-tab')?.addEventListener('click', () => handleToggleCategoryTab('payment-methods')); $('#addIncomeCategoryForm')?.addEventListener('submit', (e) => handleAddCategory(e, 'income')); $('#addExpenseCategoryForm')?.addEventListener('submit', (e) => handleAddCategory(e, 'expense')); $('#addPaymentMethodForm')?.addEventListener('submit', handleAddPaymentMethod);
        $('#editCategoryForm')?.addEventListener('submit', handleSaveCategoryOrMethod); $('#cancelEditCategoryBtn')?.addEventListener('click', () => { state.currentCategory = null; closeModal('editCategoryModal'); }); $('#closeEditCategoryModal')?.addEventListener('click', () => { state.currentCategory = null; closeModal('editCategoryModal'); });
        $('#confirmDeleteBtn')?.addEventListener('click', handleDeleteTransaction); $('#cancelDeleteBtn')?.addEventListener('click', () => { state.currentTransaction = null; closeModal('deleteConfirmModal'); }); $('#closeDeleteConfirmModal')?.addEventListener('click', () => { state.currentTransaction = null; closeModal('deleteConfirmModal'); });
        $('#commitmentsHeader')?.addEventListener('click', toggleCommitments); setupIconPreviewListeners();
        $$('.modal-backdrop').forEach(backdrop => { backdrop.addEventListener('click', (e) => { if (e.target === backdrop) { closeModal(backdrop.id); } }); });
    };
    const setupIconPreviewListeners = () => { /* ... (código mantido igual) ... */ 
        const iconInputs = $$('input[id$="IconInput"]'); iconInputs.forEach(input => { const previewId = input.id.replace('Input', 'Preview'); const preview = $(`#${previewId}`); if (!preview) return; const defaultIconId = input.id.includes('Income') ? 'icon-money' : input.id.includes('Expense') ? 'icon-shopping' : input.id.includes('Payment') ? 'icon-money' : 'icon-default'; preview.innerHTML = `<svg width="24" height="24"><use href="#${defaultIconId}"></use></svg>`; input.addEventListener('input', (e) => { const value = e.target.value.trim(); if (value) { preview.innerHTML = value; } else { preview.innerHTML = `<svg width="24" height="24"><use href="#${defaultIconId}"></use></svg>`; } }); });
    };
    const setupTableActionListeners = () => { /* ... (código mantido igual) ... */ 
        $$('.transaction-paid-checkbox').forEach(checkbox => { checkbox.removeEventListener('change', handleTransactionPaidChange); checkbox.addEventListener('change', handleTransactionPaidChange); }); $$('.edit-transaction-btn').forEach(btn => { btn.removeEventListener('click', handleEditTransactionClick); btn.addEventListener('click', handleEditTransactionClick); }); $$('.delete-transaction-btn').forEach(btn => { btn.removeEventListener('click', handleDeleteTransactionClick); btn.addEventListener('click', handleDeleteTransactionClick); });
    };
    const handleTransactionPaidChange = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.target.dataset.id; const transaction = state.transactions.find(t => t.id === id); if (transaction) { const newStatus = e.target.checked ? (transaction.type === 'income' ? 'received' : 'paid') : 'pending'; updateTransactionStatus(id, newStatus); }
    };
    const handleEditTransactionClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; const transaction = state.transactions.find(t => t.id === id); if (transaction) openEditTransactionModal(transaction);
    };
    const handleDeleteTransactionClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; const transaction = state.transactions.find(t => t.id === id); if (transaction) openDeleteConfirmModal(transaction);
    };
    const setupCardActionListeners = () => { /* ... (código mantido igual) ... */ 
        $$('.edit-card-btn').forEach(btn => { btn.removeEventListener('click', handleEditCardClick); btn.addEventListener('click', handleEditCardClick); }); $$('.delete-card-btn').forEach(btn => { btn.removeEventListener('click', handleDeleteCardClick); btn.addEventListener('click', handleDeleteCardClick); }); $$('.view-invoice-btn').forEach(btn => { btn.removeEventListener('click', handleViewInvoiceClick); btn.addEventListener('click', handleViewInvoiceClick); });
    };
    const handleEditCardClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; const card = state.cards.find(c => c.id === id); if (card) openEditCardModal(card);
    };
    const handleDeleteCardClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; if (confirm('Tem certeza?')) { deleteCard(id); }
    };
    const handleViewInvoiceClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; openCardInvoiceModal(id);
    };
    const setupCategoryActionListeners = () => { /* ... (código mantido igual) ... */ 
        $$('.edit-category-btn').forEach(btn => { btn.removeEventListener('click', handleEditCategoryClick); btn.addEventListener('click', handleEditCategoryClick); }); $$('.delete-category-btn').forEach(btn => { btn.removeEventListener('click', handleDeleteCategoryClick); btn.addEventListener('click', handleDeleteCategoryClick); });
    };
    const handleEditCategoryClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; const type = e.currentTarget.dataset.type; const list = type === 'income' ? state.categories.income : state.categories.expense; const category = list.find(c => c.id === id); if (category) openEditCategoryModal(category, type);
    };
    const handleDeleteCategoryClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; const type = e.currentTarget.dataset.type; deleteCategoryOrMethod(id, type);
    };
    const setupPaymentMethodActionListeners = () => { /* ... (código mantido igual) ... */ 
        $$('.edit-payment-method-btn').forEach(btn => { btn.removeEventListener('click', handleEditPaymentMethodClick); btn.addEventListener('click', handleEditPaymentMethodClick); }); $$('.delete-payment-method-btn').forEach(btn => { btn.removeEventListener('click', handleDeletePaymentMethodClick); btn.addEventListener('click', handleDeletePaymentMethodClick); });
    };
    const handleEditPaymentMethodClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; const method = state.paymentMethods.find(m => m.id === id); if (method) openEditCategoryModal(method, 'payment');
    };
    const handleDeletePaymentMethodClick = (e) => { /* ... (código mantido igual) ... */ 
        const id = e.currentTarget.dataset.id; deleteCategoryOrMethod(id, 'payment');
    };
    const handleToggleCategoryTab = (tabId) => { /* ... (código mantido igual) ... */ 
        $$('.nav-link').forEach(tab => tab.classList.remove('active')); $$('.tab-pane').forEach(pane => pane.classList.remove('show', 'active')); $(`#${tabId}-tab`)?.classList.add('active'); $(`#${tabId}`)?.classList.add('show', 'active');
    };
    const toggleCommitments = () => { /* ... (código mantido igual) ... */ 
        const content = $('#commitmentsContent'); const headerIcon = $('#commitmentsHeader svg use'); if (!content || !headerIcon) return; if (content.style.maxHeight && content.style.maxHeight !== '0px') { content.style.maxHeight = '0px'; headerIcon.setAttribute('href', '#icon-chevron-down'); } else { content.style.maxHeight = content.scrollHeight + 'px'; headerIcon.setAttribute('href', '#icon-chevron-up'); }
    };
    // ===== FIM: BLOCO 5.11 - Handlers de Eventos =====

    // ===== INÍCIO: BLOCO 5.12 - Inicialização da Aplicação =====
    const init = async () => {
      console.log('Inicializando Calculadora da Família v1.2 (Estilo Apple)...');
      initTheme();
      updateYearOptions(); 
      setMonthYearSelectors(); 
      setupEventListeners(); 

      try {
        showToast('Carregando dados...', 'info');
        await Promise.all([ loadCategoriesAndPaymentMethods(), loadCards() ]);
        await loadTransactions(); 
        createTransactionFilters(); 
        createCharts(); // Cria instâncias dos gráficos
        // filterTransactionsByMonth() já é chamado em loadTransactions e atualiza o resto
        showToast('Pronto!', 'success');
      } catch (error) {
        console.error('Erro inicialização:', error);
        showToast('Falha ao carregar dados.', 'error');
      }
    };
    document.addEventListener('DOMContentLoaded', init);
    // ===== FIM: BLOCO 5.12 - Inicialização da Aplicação =====
  </script>
  <!-- ===== FIM: BLOCO 5 - JavaScript Completo ===== -->
</body>
</html>
