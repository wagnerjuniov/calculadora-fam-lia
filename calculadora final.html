<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Gestão Financeira da Família - Controle financeiro simplificado">
  <title>Gestão Financeira da Família</title>
  
  <!-- Fonte Inter via Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- ApexCharts para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <!-- Scripts CDN: Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
  
  <style>
    /* ---------- DESIGN TOKENS ---------- */
    :root {
      /* Cores base - Proposta Clean & Elegante */
      --color-background: #F5F5F7; /* Fundo estilo Apple */
      --color-surface: #FFFFFF;    /* Branco puro para cards */
      --color-surface-hover: #F9F9FB; /* Hover suave */
      --color-surface-variant: #F5F5F7; /* Variante de superfície */
      --color-on-surface: #000000;    /* Texto preto em superfícies claras */
      --color-on-surface-variant: #86868B; /* Texto secundário estilo Apple */
      --color-on-surface-muted: #98989D; /* Texto terciário */
      --color-on-surface-disabled: #AEAEB2; /* Texto desabilitado */
      --color-outline: #C6C6C8;       /* Bordas estilo iOS */
      --color-divider: #E5E5EA;       /* Divisores estilo iOS */
      
      /* Cores semânticas - Estilo iOS */
      --color-primary: #007AFF; /* iOS Blue */
      --color-primary-dark: #0062CC; /* iOS Blue dark */
      --color-primary-light: #47A9FF; /* iOS Blue light */
      --color-primary-bg: #F2F7FC; /* Azul muito claro para backgrounds */
      
      --color-on-primary: #FFFFFF;
      --color-success: #34C759; /* iOS Green */
      --color-success-light: #E8F8EE; /* Fundo verde claro */
      --color-warning: #FF9500; /* iOS Orange */
      --color-warning-light: #FFF7EC; /* Fundo laranja claro */
      --color-error: #FF3B30; /* iOS Red */
      --color-error-light: #FFEEEC; /* Fundo vermelho claro */
      --color-info: #5AC8FA; /* iOS Light Blue */
      --color-info-light: #ECF8FE; /* Fundo azul claro */
      
      /* Cores para receitas e despesas */
      --color-income: #34C759; /* iOS Green */
      --color-expense: #FF3B30; /* iOS Red */
      --color-card-invoice: #AF52DE; /* iOS Purple */
      
      /* Tipografia */
      --font-sans: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
      --font-display: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
      
      --font-size-xs: 0.75rem;   /* 12px */
      --font-size-sm: 0.875rem;  /* 14px */
      --font-size-md: 1rem;      /* 16px */
      --font-size-lg: 1.125rem;  /* 18px */
      --font-size-xl: 1.25rem;   /* 20px */
      --font-size-2xl: 1.5rem;   /* 24px */
      --font-size-3xl: 1.75rem;  /* 28px */
      --font-size-4xl: 2rem;     /* 32px */
      
      --font-weight-light: 300;
      --font-weight-regular: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      --line-height-tight: 1.2;
      --line-height-normal: 1.4;
      --line-height-relaxed: 1.6;
      
      /* Espaçamento */
      --spacing-1: 0.25rem;  /* 4px */
      --spacing-2: 0.5rem;   /* 8px */
      --spacing-3: 0.75rem;  /* 12px */
      --spacing-4: 1rem;     /* 16px */
      --spacing-5: 1.25rem;  /* 20px */
      --spacing-6: 1.5rem;   /* 24px */
      --spacing-8: 2rem;     /* 32px */
      --spacing-10: 2.5rem;  /* 40px */
      --spacing-12: 3rem;    /* 48px */
      --spacing-16: 4rem;    /* 64px */
      
      /* Bordas e raios */
      --radius-sm: 0.25rem;     /* 4px */
      --radius-md: 0.5rem;      /* 8px */
      --radius-lg: 0.75rem;     /* 12px */
      --radius-xl: 1rem;        /* 16px */
      --radius-2xl: 1.25rem;    /* 20px */
      --radius-full: 9999px;    /* Circular */
      
      /* Sombras */
      --shadow-sm: 0px 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0px 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0px 4px 8px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0px 10px 15px rgba(0, 0, 0, 0.05);
      
      /* Transições */
      --transition-fast: 150ms cubic-bezier(0.25, 0.1, 0.25, 1);
      --transition-normal: 250ms cubic-bezier(0.25, 0.1, 0.25, 1);
      --transition-slow: 350ms cubic-bezier(0.25, 0.1, 0.25, 1);
      
      /* Z-index levels */
      --z-index-dropdown: 10;
      --z-index-sticky: 20;
      --z-index-fixed: 30;
      --z-index-modal-backdrop: 40;
      --z-index-modal: 50;
      --z-index-popover: 60;
      --z-index-tooltip: 70;
    }
    
    /* Dark mode overrides - Estilo iOS Dark Mode */
    [data-theme="dark"] {
      --color-background: #000000;      /* iOS Dark Mode Background */
      --color-surface: #1C1C1E;         /* iOS Dark Gray */
      --color-surface-hover: #2C2C2E;   /* Hover em dark mode */
      --color-surface-variant: #2C2C2E; /* iOS Secondary Dark Gray */
      
      --color-on-surface: #FFFFFF;      /* Texto branco */
      --color-on-surface-variant: #AEAEB2; /* iOS Gray 5 */
      --color-on-surface-muted: #98989D;   /* iOS Gray 4 */
      --color-on-surface-disabled: #636366; /* iOS Gray 3 */
      
      --color-divider: #38383A;         /* iOS Gray Divider Dark Mode */
      --color-outline: #48484A;         /* iOS Gray Outline Dark Mode */
      
      --color-primary: #0A84FF;         /* iOS Blue Dark Mode */
      --color-primary-dark: #007AFF;    /* iOS Blue */
      --color-primary-light: #409CFF;   /* Lighter Blue */
      --color-primary-bg: #1C1C1E;      /* Dark Background */
      
      --color-success: #30D158;         /* iOS Green Dark Mode */
      --color-success-light: #1C2A22;   /* Verde escuro para fundo */
      --color-warning: #FF9F0A;         /* iOS Orange Dark Mode */
      --color-warning-light: #2C2622;   /* Laranja escuro para fundo */
      --color-error: #FF453A;           /* iOS Red Dark Mode */
      --color-error-light: #2C211F;     /* Vermelho escuro para fundo */
      --color-info: #64D2FF;            /* iOS Light Blue Dark Mode */
      --color-info-light: #1C2A2F;      /* Azul escuro para fundo */
      
      --color-income: #30D158;          /* iOS Green Dark Mode */
      --color-expense: #FF453A;         /* iOS Red Dark Mode */
      --color-card-invoice: #BF5AF2;    /* iOS Purple Dark Mode */
      
      /* Ajuste de sombras para dark mode */
      --shadow-sm: 0px 1px 2px rgba(0, 0, 0, 0.4);
      --shadow-md: 0px 2px 4px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0px 4px 8px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0px 10px 15px rgba(0, 0, 0, 0.4);
    }
    
    /* ---------- BASE STYLES ---------- */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }
    
    body {
      font-family: var(--font-sans);
      font-size: var(--font-size-md);
      line-height: var(--line-height-normal);
      color: var(--color-on-surface);
      background-color: var(--color-background);
      transition: background-color var(--transition-normal), color var(--transition-normal);
      overflow-x: hidden;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-display);
      font-weight: var(--font-weight-semibold);
      line-height: var(--line-height-tight);
      color: var(--color-on-surface);
      margin-bottom: var(--spacing-4);
    }
    
    h1 {
      font-size: var(--font-size-4xl);
      letter-spacing: -0.02em;
    }
    
    h2 {
      font-size: var(--font-size-3xl);
      letter-spacing: -0.02em;
    }
    
    h3 {
      font-size: var(--font-size-2xl);
      letter-spacing: -0.01em;
    }
    
    h4 {
      font-size: var(--font-size-xl);
    }
    
    h5 {
      font-size: var(--font-size-lg);
    }
    
    h6 {
      font-size: var(--font-size-md);
    }
    
    p {
      margin-bottom: var(--spacing-4);
    }
    
    a {
      color: var(--color-primary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }
    
    a:hover {
      color: var(--color-primary-dark);
    }
    
    img, svg {
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    /* Form elements */
    input,
    select,
    textarea,
    button {
      font-family: var(--font-sans);
      font-size: var(--font-size-md);
      color: var(--color-on-surface);
    }
    
    input,
    select,
    textarea {
      width: 100%;
      padding: var(--spacing-2) var(--spacing-3);
      background-color: var(--color-surface);
      border: 1px solid var(--color-outline);
      border-radius: var(--radius-lg);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px var(--color-primary-bg);
    }
    
    input[type="date"] {
      padding-right: var(--spacing-8);
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2386868b'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right var(--spacing-3) center;
      background-size: 18px;
      padding-right: var(--spacing-8);
    }
    
    input[disabled],
    select[disabled],
    textarea[disabled] {
      background-color: var(--color-surface-variant);
      border-color: var(--color-outline);
      color: var(--color-on-surface-disabled);
      cursor: not-allowed;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-2);
      padding: var(--spacing-2) var(--spacing-4);
      border-radius: var(--radius-lg);
      font-weight: var(--font-weight-medium);
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
      text-decoration: none;
      line-height: 1.5;
      min-height: 2.25rem;
      border: none;
    }
    
    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-on-primary);
    }
    
    .btn-primary:hover {
      filter: brightness(1.05);
    }
    
    .btn-success {
      background-color: var(--color-success);
      color: var(--color-on-primary);
    }
    
    .btn-success:hover {
      filter: brightness(1.05);
    }
    
    .btn-error, .btn-danger {
      background-color: var(--color-error);
      color: var(--color-on-primary);
    }
    
    .btn-error:hover, .btn-danger:hover {
      filter: brightness(1.05);
    }
    
    .btn-outline {
      background-color: transparent;
      color: var(--color-on-surface);
      border: 1px solid var(--color-outline);
    }
    
    .btn-outline:hover {
      background-color: var(--color-surface-variant);
    }
    
    .btn-ghost {
      background-color: transparent;
      color: var(--color-primary);
    }
    
    .btn-ghost:hover {
      background-color: var(--color-primary-bg);
    }
    
    .btn-icon {
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      border-radius: var(--radius-full);
    }
    
    .btn-sm {
      padding: var(--spacing-1) var(--spacing-3);
      font-size: var(--font-size-sm);
      min-height: 1.75rem;
    }
    
    .btn-lg {
      padding: var(--spacing-3) var(--spacing-6);
      font-size: var(--font-size-lg);
      min-height: 2.75rem;
    }
    
    /* ---------- LAYOUT ---------- */
    .container {
      width: 100%;
      max-width: 1140px;
      margin: 0 auto;
      padding: 0 var(--spacing-4);
    }
    
    .row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 calc(var(--spacing-4) * -1);
    }
    
    .col {
      flex: 1 0 0%;
      padding: 0 var(--spacing-4);
    }
    
    .col-auto {
      flex: 0 0 auto;
      width: auto;
      padding: 0 var(--spacing-4);
    }
    
    .col-12 {
      flex: 0 0 auto;
      width: 100%;
      padding: 0 var(--spacing-4);
    }
    
    .col-6 {
      flex: 0 0 auto;
      width: 50%;
      padding: 0 var(--spacing-4);
    }
    
    .col-4 {
      flex: 0 0 auto;
      width: 33.33333%;
      padding: 0 var(--spacing-4);
    }
    
    .col-3 {
      flex: 0 0 auto;
      width: 25%;
      padding: 0 var(--spacing-4);
    }
    
    @media (max-width: 768px) {
      .col-md-12 {
        flex: 0 0 auto;
        width: 100%;
      }
      
      .col-md-6 {
        flex: 0 0 auto;
        width: 50%;
      }
    }
    
    @media (max-width: 576px) {
      .col-sm-12 {
        flex: 0 0 auto;
        width: 100%;
      }
    }
    
    .grid {
      display: grid;
      gap: var(--spacing-6);
    }
    
    .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
    
    @media (max-width: 1024px) {
      .lg-grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
      .md-grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
      .md-grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
    }
    
    @media (max-width: 576px) {
      .sm-grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
    }
    
    .flex {
      display: flex;
    }
    
    .flex-col {
      flex-direction: column;
    }
    
    .items-center {
      align-items: center;
    }
    
    .items-start {
      align-items: flex-start;
    }
    
    .items-end {
      align-items: flex-end;
    }
    
    .justify-center {
      justify-content: center;
    }
    
    .justify-between {
      justify-content: space-between;
    }
    
    .justify-end {
      justify-content: flex-end;
    }
    
    .flex-wrap {
      flex-wrap: wrap;
    }
    
    .gap-1 { gap: var(--spacing-1); }
    .gap-2 { gap: var(--spacing-2); }
    .gap-3 { gap: var(--spacing-3); }
    .gap-4 { gap: var(--spacing-4); }
    .gap-6 { gap: var(--spacing-6); }
    .gap-8 { gap: var(--spacing-8); }
    
    /* ---------- COMPONENTS ---------- */
    
    /* Header - Estilo iOS/macOS */
    .header {
      background-color: var(--color-surface);
      border-bottom: 1px solid var(--color-divider);
      padding: var(--spacing-4) 0;
      position: sticky;
      top: 0;
      z-index: var(--z-index-sticky);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: all var(--transition-normal);
    }
    
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-4);
    }
    
    .header-filters {
      display: flex;
      gap: var(--spacing-3);
      align-items: center;
    }
    
    .header-filters .filter-select {
      min-width: 120px;
      background-color: var(--color-background);
      border-radius: var(--radius-lg);
    }
    
    .header-actions {
      display: flex;
      gap: var(--spacing-3);
      align-items: center;
    }
    
    @media (max-width: 992px) {
      .header-container {
        flex-direction: column;
        gap: var(--spacing-4);
      }
      
      .header-actions {
        justify-content: center;
        flex-wrap: wrap;
      }
    }
    
    @media (max-width: 768px) {
      .header-filters {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
      }
      
      .header-actions {
        flex-wrap: wrap;
        justify-content: center;
      }
    }
    
    /* Hero */
    .hero {
      padding: var(--spacing-10) 0;
      text-align: center;
    }
    
    .hero-title {
      font-size: var(--font-size-4xl);
      color: var(--color-on-surface);
      margin-bottom: var(--spacing-2);
      letter-spacing: -0.02em;
    }
    
    .hero-subtitle {
      font-size: var(--font-size-lg);
      color: var(--color-on-surface-variant);
      max-width: 700px;
      margin: 0 auto var(--spacing-6);
    }
    
    /* Cards */
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: transform var(--transition-normal), box-shadow var(--transition-normal);
      height: 100%;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .card-header {
      padding: var(--spacing-6);
      border-bottom: 1px solid var(--color-divider);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin: 0;
    }
    
    .card-body {
      padding: var(--spacing-6);
    }
    
    .card-footer {
      padding: var(--spacing-6);
      border-top: 1px solid var(--color-divider);
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-2);
    }
    
    /* KPI cards */
    .kpi-grid {
      margin-bottom: var(--spacing-8);
    }
    
    .kpi-card {
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--spacing-6);
      height: 100%;
      box-shadow: var(--shadow-md);
      transition: transform var(--transition-normal), box-shadow var(--transition-normal);
      display: flex;
      flex-direction: column;
      border-top: 4px solid var(--color-primary);
    }
    
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .kpi-income {
      border-top-color: var(--color-income);
    }
    
    .kpi-expense {
      border-top-color: var(--color-expense);
    }
    
    .kpi-balance {
      border-top-color: var(--color-primary);
    }
    
    .kpi-card-invoice {
      border-top-color: var(--color-card-invoice);
    }
    
    .kpi-title {
      font-family: var(--font-sans);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-2);
    }
    
    .kpi-value {
      font-family: var(--font-display);
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-on-surface);
      margin-bottom: var(--spacing-2);
    }
    
    .kpi-subtitle {
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-muted);
      display: flex;
      align-items: center;
      gap: var(--spacing-1);
      margin-top: auto;
      padding-top: var(--spacing-2);
    }
    
    /* Charts container */
    .chart-container {
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-6);
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .chart-header {
      margin-bottom: var(--spacing-4);
    }
    
    .chart-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin: 0;
    }
    
    .chart-wrapper {
      flex: 1;
      min-height: 300px;
      position: relative;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: var(--spacing-3);
      margin-top: var(--spacing-4);
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      font-size: var(--font-size-sm);
      cursor: pointer;
      padding: var(--spacing-1) var(--spacing-3);
      border-radius: var(--radius-full);
      background-color: var(--color-surface-variant);
      transition: opacity var(--transition-fast);
      white-space: nowrap;
    }
    
    .chart-legend-item.inactive {
      opacity: 0.5;
    }
    
    .chart-legend-color {
      width: 12px;
      height: 12px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
    }
    
    /* Donut chart center text */
    .limit-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .limit-display {
      text-align: center;
      width: 100px;
      height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .limit-value {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-on-surface);
      line-height: 1;
      margin-bottom: var(--spacing-1);
    }
    
    .limit-label {
      font-size: var(--font-size-xs);
      color: var(--color-on-surface-variant);
    }
    
    /* Insights */
    .insights-container {
      margin-bottom: var(--spacing-8);
    }
    
    .insight-banner {
      display: flex;
      align-items: center;
      gap: var(--spacing-4);
      padding: var(--spacing-4) var(--spacing-6);
      border-radius: var(--radius-xl);
      background-color: var(--color-surface);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-4);
      border-left: 4px solid var(--color-primary);
      transition: transform var(--transition-fast);
    }
    
    .insight-banner:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .insight-danger { 
      border-left-color: var(--color-error);
      background-color: var(--color-error-light);
    }
    
    .insight-warning { 
      border-left-color: var(--color-warning);
      background-color: var(--color-warning-light);
    }
    
    .insight-success { 
      border-left-color: var(--color-success);
      background-color: var(--color-success-light);
    }
    
    .insight-info { 
      border-left-color: var(--color-info);
      background-color: var(--color-info-light);
    }
    
    .insight-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      font-size: 20px;
      color: var(--color-on-surface);
      flex-shrink: 0;
    }
    
    .insight-content {
      flex: 1;
    }
    
    .insight-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-1);
      margin: 0;
    }
    
    .insight-text {
      color: var(--color-on-surface-variant);
    }
    
    /* Commitments */
    .commitments {
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-bottom: var(--spacing-8);
    }
    
    .commitments-header {
      padding: var(--spacing-6);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }
    
    .commitments-header:hover {
      background-color: var(--color-surface-hover);
    }
    
    .commitments-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin: 0;
    }
    
    .commitments-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-normal);
    }
    
    .commitments-content.expanded {
      max-height: 1000px;
    }
    
    .commitment-list {
      padding: 0 var(--spacing-6) var(--spacing-6);
    }
    
    .commitment-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-4);
      padding: var(--spacing-4);
      border-radius: var(--radius-lg);
      background-color: var(--color-surface-variant);
      margin-bottom: var(--spacing-2);
    }
    
    .commitment-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      color: var(--color-on-primary);
      flex-shrink: 0;
    }
    
    .commitment-content {
      flex: 1;
    }
    
    .commitment-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-2);
    }
    
    .commitment-name {
      font-weight: var(--font-weight-medium);
    }
    
    .commitment-amount {
      font-weight: var(--font-weight-semibold);
    }
    
    .commitment-details {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-muted);
      margin-bottom: var(--spacing-2);
    }
    
    .commitment-progress {
      height: 8px;
      background-color: var(--color-surface);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .commitment-progress-bar {
      height: 100%;
      border-radius: var(--radius-full);
      transition: width var(--transition-normal);
    }
    
    /* Transactions */
    .transactions-container {
      margin-bottom: var(--spacing-8);
    }
    
    .transactions-card {
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }
    
    .transactions-header {
      padding: var(--spacing-6);
      border-bottom: 1px solid var(--color-divider);
    }
    
    .transactions-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin: 0 0 var(--spacing-4);
    }
    
    .transactions-filters {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-2);
    }
    
    .transactions-table-container {
      overflow-x: auto;
    }
    
    .transactions-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .transactions-table th,
    .transactions-table td {
      padding: var(--spacing-4) var(--spacing-3);
      text-align: left;
      border-bottom: 1px solid var(--color-divider);
    }
    
    .transactions-table th {
      background-color: var(--color-surface-variant);
      font-weight: var(--font-weight-semibold);
      color: var(--color-on-surface-variant);
      position: sticky;
      top: 0;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color var(--transition-fast);
      text-align: center;
    }
    
    .transactions-table th:hover {
      background-color: var(--color-divider);
    }
    
    .transactions-table th.sorted-asc::after {
      content: "↑";
      margin-left: var(--spacing-1);
    }
    
    .transactions-table th.sorted-desc::after {
      content: "↓";
      margin-left: var(--spacing-1);
    }
    
    .transactions-table tr:hover {
      background-color: var(--color-surface-hover);
    }
    
    .transactions-table td {
      vertical-align: middle;
    }
    
    .transaction-name-cell {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      font-weight: var(--font-weight-medium);
    }
    
    .transaction-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      background-color: var(--color-surface-variant);
      flex-shrink: 0;
    }
    
    .transaction-actions {
      display: flex;
      gap: var(--spacing-1);
      justify-content: flex-end;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-1) var(--spacing-3);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-radius: var(--radius-full);
      white-space: nowrap;
    }
    
    .badge-success {
      background-color: var(--color-success-light);
      color: var(--color-success);
    }
    
    .badge-warning {
      background-color: var(--color-warning-light);
      color: var(--color-warning);
    }
    
    .badge-danger {
      background-color: var(--color-error-light);
      color: var(--color-error);
    }
    
    .badge-info {
      background-color: var(--color-info-light);
      color: var(--color-info);
    }
    
    /* Checkbox and Radio */
    .form-check {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      margin-bottom: var(--spacing-4);
      cursor: pointer;
    }
    
    .form-check input[type="checkbox"],
    .form-check input[type="radio"] {
      width: 18px;
      height: 18px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--color-primary);
    }
    
    .form-check-label {
      font-size: var(--font-size-md);
      cursor: pointer;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background-color: transparent;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-on-surface-variant);
      cursor: pointer;
      transition: background-color var(--transition-fast), color var(--transition-fast);
    }
    
    .theme-toggle:hover {
      background-color: var(--color-surface-variant);
      color: var(--color-on-surface);
    }
    
    [data-theme="light"] .fa-moon { display: none; }
    [data-theme="dark"] .fa-sun { display: none; }
    
    /* Modal backdrop and content */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: var(--z-index-modal-backdrop);
      transition: opacity var(--transition-normal);
    }
    
    .modal-backdrop.active {
      display: flex;
      opacity: 1;
    }
    
    .modal {
      width: 90%;
      max-width: 500px;
      background-color: var(--color-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      animation: modal-slide-in 0.3s ease-out;
    }
    
    @keyframes modal-slide-in {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-6);
      border-bottom: 1px solid var(--color-divider);
    }
    
    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin: 0;
    }
    
    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--color-on-surface-variant);
      transition: color var(--transition-fast);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
    }
    
    .modal-close:hover {
      color: var(--color-on-surface);
      background-color: var(--color-surface-variant);
    }
    
    .modal-body {
      padding: var(--spacing-6);
      overflow-y: auto;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-2);
      padding: var(--spacing-6);
      border-top: 1px solid var(--color-divider);
    }
    
    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: var(--spacing-4);
      right: var(--spacing-4);
      z-index: var(--z-index-tooltip);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-2);
      max-width: 320px;
    }
    
    .toast {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-4);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      animation: toast-in 0.3s ease-out;
      border-left: 4px solid var(--color-primary);
    }
    
    @keyframes toast-in {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .toast-success {
      border-left-color: var(--color-success);
    }
    
    .toast-error {
      border-left-color: var(--color-error);
    }
    
    .toast-warning {
      border-left-color: var(--color-warning);
    }
    
    .toast-info {
      border-left-color: var(--color-info);
    }
    
    .toast-icon {
      font-size: 1.25rem;
    }
    
    .toast-content {
      flex: 1;
    }
    
    .toast-close {
      background: transparent;
      border: none;
      color: var(--color-on-surface-variant);
      cursor: pointer;
      font-size: 1rem;
    }
    
    /* Select wrapper */
    .select-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .select-wrapper select {
      padding-right: 2.5rem;
    }
    
    .select-wrapper::after {
      content: "";
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      width: 0.75rem;
      height: 0.75rem;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2386868b'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      pointer-events: none;
    }
    
    /* Utility classes */
    .mt-1 { margin-top: var(--spacing-1); }
    .mt-2 { margin-top: var(--spacing-2); }
    .mt-4 { margin-top: var(--spacing-4); }
    .mt-6 { margin-top: var(--spacing-6); }
    .mt-8 { margin-top: var(--spacing-8); }
    
    .mb-1 { margin-bottom: var(--spacing-1); }
    .mb-2 { margin-bottom: var(--spacing-2); }
    .mb-4 { margin-bottom: var(--spacing-4); }
    .mb-6 { margin-bottom: var(--spacing-6); }
    .mb-8 { margin-bottom: var(--spacing-8); }
    
    .mx-auto { margin-left: auto; margin-right: auto; }
    
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    
    .w-full { width: 100%; }
    .h-full { height: 100%; }
    
    .text-sm { font-size: var(--font-size-sm); }
    .text-lg { font-size: var(--font-size-lg); }
    .text-xl { font-size: var(--font-size-xl); }
    
    .font-medium { font-weight: var(--font-weight-medium); }
    .font-semibold { font-weight: var(--font-weight-semibold); }
    .font-bold { font-weight: var(--font-weight-bold); }
    
    .text-primary { color: var(--color-primary); }
    .text-success { color: var(--color-success); }
    .text-warning { color: var(--color-warning); }
    .text-error { color: var(--color-error); }
    .text-muted { color: var(--color-on-surface-muted); }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .hide-on-mobile {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-container">
        <div class="header-filters">
          <div class="select-wrapper">
            <select id="yearSelect" class="filter-select">
              <!-- Options will be populated by JS -->
            </select>
          </div>
          
          <div class="select-wrapper">
            <select id="monthSelect" class="filter-select">
              <option value="0">Janeiro</option>
              <option value="1">Fevereiro</option>
              <option value="2">Março</option>
              <option value="3">Abril</option>
              <option value="4">Maio</option>
              <option value="5">Junho</option>
              <option value="6">Julho</option>
              <option value="7">Agosto</option>
              <option value="8">Setembro</option>
              <option value="9">Outubro</option>
              <option value="10">Novembro</option>
              <option value="11">Dezembro</option>
            </select>
          </div>
        </div>
        
        <div class="header-actions">
          <button id="newIncomeBtn" class="btn btn-success">
            <i class="fas fa-plus"></i>
            Nova Receita
          </button>
          
          <button id="newExpenseBtn" class="btn btn-error">
            <i class="fas fa-minus"></i>
            Nova Despesa
          </button>
          
          <button id="cardsBtn" class="btn btn-outline">
            <i class="fas fa-credit-card"></i>
            Cartões
          </button>
          
          <button id="categoriesBtn" class="btn btn-outline">
            <i class="fas fa-tag"></i>
            Categorias
          </button>
          
          <button id="investmentsBtn" class="btn btn-outline">
            <i class="fas fa-chart-line"></i>
            Investimentos
          </button>

          <button id="themeToggle" class="theme-toggle">
            <i class="fas fa-sun"></i>
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <h1 class="hero-title">Wagner. Bárbara. Joaquim.</h1>
      <p class="hero-subtitle">Porque o futuro que sonhamos começa com o que fazemos hoje.</p>
    </div>
  </section>
  
  <div class="container">
    <!-- KPI Cards -->
    <div class="grid grid-cols-4 md-grid-cols-2 sm-grid-cols-1 kpi-grid">
      <div class="kpi-card kpi-balance">
        <div class="kpi-title">Saldo Real (Caixa)</div>
        <div class="kpi-value" id="balanceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <i class="fas fa-info-circle text-primary"></i>
          <span>Saldo comprometido: R$ 0,00</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-income">
        <div class="kpi-title">Receitas</div>
        <div class="kpi-value" id="incomeValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="incomeReceivedValue">R$ 0,00 recebidos</span> /
          <span id="incomePendingValue">R$ 0,00 pendentes</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-expense">
        <div class="kpi-title">Despesas</div>
        <div class="kpi-value" id="expenseValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="expensePaidValue">R$ 0,00 pagos</span> /
          <span id="expensePendingValue">R$ 0,00 pendentes</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-card-invoice">
        <div class="kpi-title">Fatura do Mês</div>
        <div class="kpi-value" id="invoiceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <i class="fas fa-credit-card"></i>
          <span>Vencimento: <span id="invoiceDueDate">--/--/----</span></span>
        </div>
      </div>
    </div>
    
    <!-- Insights -->
    <div class="insights-container" id="insightsBannerContainer">
      <!-- Insights serão inseridos aqui dinamicamente -->
    </div>
    
    <!-- Charts -->
    <section class="mb-8">
      <h2 class="mb-6">Resumo Financeiro</h2>
      
      <div class="grid grid-cols-2 md-grid-cols-1 gap-6 mb-6">
        <!-- Despesas por Categoria -->
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Despesas por Categoria</h3>
          </div>
          <div class="chart-wrapper">
            <div id="categoryExpensesChart"></div>
          </div>
        </div>
        
        <!-- Uso do Limite (Cartões) -->
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Uso do Limite (Cartões)</h3>
          </div>
          <div class="chart-wrapper">
            <div id="cardUsageDonutChart"></div>
            <div class="limit-container">
              <div class="limit-display">
                <div class="limit-value">0%</div>
                <div class="limit-label">utilizado</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-2 md-grid-cols-1 gap-6 mb-6">
        <!-- Despesas Fixas vs Variáveis -->
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Despesas Fixas vs Variáveis</h3>
          </div>
          <div class="chart-wrapper">
            <div id="fixedVsVariableChart"></div>
          </div>
          <div class="chart-legend">
            <div class="chart-legend-item">
              <div class="chart-legend-color" style="background-color: var(--color-success);"></div>
              <span>Fixas</span>
            </div>
            <div class="chart-legend-item">
              <div class="chart-legend-color" style="background-color: var(--color-card-invoice);"></div>
              <span>Variáveis</span>
            </div>
          </div>
        </div>
        
        <!-- Despesas por Pessoa -->
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Despesas por Pessoa</h3>
          </div>
          <div class="chart-wrapper">
            <div id="personAnalysisChart"></div>
          </div>
        </div>
      </div>
      
      <!-- Receitas x Despesas (12 meses) -->
      <div class="chart-container mb-8">
        <div class="chart-header">
          <h3 class="chart-title">Receitas x Despesas (12 meses)</h3>
        </div>
        <div class="chart-wrapper">
          <div id="annualBarsChart"></div>
        </div>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <div class="chart-legend-color" style="background-color: var(--color-income);"></div>
            <span>Receitas</span>
          </div>
          <div class="chart-legend-item">
            <div class="chart-legend-color" style="background-color: var(--color-expense);"></div>
            <span>Despesas</span>
          </div>
          <div class="chart-legend-item">
            <div class="chart-legend-color" style="background-color: var(--color-primary);"></div>
            <span>Saldo</span>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Compromissos -->
    <div class="commitments mb-8">
      <div class="commitments-header" id="commitmentsHeader">
        <h3 class="commitments-title">Compromissos Longos</h3>
        <i class="fas fa-chevron-up" id="commitmentToggleIcon"></i>
      </div>
      <div class="commitments-content" id="commitmentsContent">
        <!-- Compromissos serão inseridos aqui dinamicamente -->
      </div>
    </div>
    
    <!-- Transações -->
    <section class="transactions-container">
      <div class="transactions-card">
        <div class="transactions-header">
          <h3 class="transactions-title">Transações</h3>
          
          <div class="transactions-filters" id="transaction-filters">
            <!-- Filtros serão inseridos aqui dinamicamente -->
          </div>
        </div>
        
        <div class="transactions-table-container">
          <table class="transactions-table" id="transactionsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="name">Nome</th>
                <th class="sortable" data-sort="person">Pessoa</th>
                <th class="sortable" data-sort="date">Data</th>
                <th class="sortable" data-sort="dueDate">Vencimento</th>
                <th class="sortable" data-sort="amount">Valor</th>
                <th class="sortable" data-sort="status">Status</th>
                <th class="sortable" data-sort="paymentMethod">Pagamento</th>
                <th>Pago?</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <!-- Transações serão inseridas aqui dinamicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
  
  <!-- Modal de Nova Receita -->
  <div class="modal-backdrop" id="incomeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Nova Receita</h2>
        <button class="modal-close" id="closeIncomeModal" aria-label="Fechar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="incomeForm">
          <div class="form-group">
            <label class="form-label" for="incomeName">Nome</label>
            <input type="text" class="form-control" id="incomeName" placeholder="Nome da receita">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeAmount">Valor</label>
            <input type="number" class="form-control" id="incomeAmount" placeholder="0,00" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeCategory">Categoria</label>
            <div class="select-wrapper">
              <select class="select" id="incomeCategory"></select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeDate">Data de Lançamento</label>
            <input type="date" class="form-control" id="incomeDate">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomePaymentMethod">Forma de Recebimento</label>
            <div class="select-wrapper">
              <select class="select" id="incomePaymentMethod"></select>
            </div>
          </div>
          <div class="form-group checkbox-wrapper">
            <input type="checkbox" class="checkbox" id="incomeIsRecurrent">
            <label class="checkbox-label" for="incomeIsRecurrent">Receita Recorrente</label>
          </div>
          <div class="form-group" id="incomeRecurrenceGroup" style="display: none;">
            <label class="form-label" for="incomeInstallments">Quantidade de Parcelas</label>
            <input type="number" class="form-control" id="incomeInstallments" min="2" value="2">
          </div>
          <div class="form-group" id="incomeStatusGroup">
            <label class="form-label">Status</label>
            <div class="radio-group">
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusReceived" name="incomeStatus" value="received" checked>
                <label class="radio-label" for="incomeStatusReceived">Recebido</label>
              </div>
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusPending" name="incomeStatus" value="pending">
                <label class="radio-label" for="incomeStatusPending">A Receber</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeNotes">Observação (opcional)</label>
            <textarea class="form-control" id="incomeNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelIncomeBtn">Cancelar</button>
        <button class="btn btn-success" id="saveIncomeBtn">Salvar Receita</button>
      </div>
    </div>
  </div>

 <!-- Modal de Nova Despesa -->
 <div class="modal-backdrop" id="expenseModal">
   <div class="modal">
     <div class="modal-header">
       <h2 class="modal-title">Nova Despesa</h2>
       <button class="modal-close" id="closeExpenseModal" aria-label="Fechar">
         <i class="fas fa-times"></i>
       </button>
     </div>
     <div class="modal-body">
       <form id="expenseForm">
         <div class="form-group">
           <label class="form-label" for="expenseName">Nome</label>
           <input type="text" class="form-control" id="expenseName" placeholder="Nome da despesa">
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseAmount">Valor</label>
           <input type="number" class="form-control" id="expenseAmount" placeholder="0,00" min="0" step="0.01">
         </div>
         <div class="form-group">
           <label class="form-label" for="expensePaymentMethod">Forma de Pagamento</label>
           <div class="select-wrapper">
             <select class="select" id="expensePaymentMethod"></select>
           </div>
         </div>
         <div class="form-group" id="creditCardGroup" style="display: none;">
           <label class="form-label" for="expenseCreditCard">Cartão de Crédito</label>
           <div class="select-wrapper">
             <select class="select" id="expenseCreditCard"></select>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseCategory">Categoria</label>
           <div class="select-wrapper">
             <select class="select" id="expenseCategory"></select>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expensePerson">Pessoa</label>
           <div class="select-wrapper">
             <select class="select" id="expensePerson"></select>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label">Tipo de Despesa</label>
           <div class="radio-group">
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseTypeFixed" name="expenseType" value="fixed" required>
               <label class="radio-label" for="expenseTypeFixed">Fixa</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseTypeVariable" name="expenseType" value="variable" required>
               <label class="radio-label" for="expenseTypeVariable">Variável</label>
             </div>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseDate">Data de Lançamento</label>
           <input type="date" class="form-control" id="expenseDate">
         </div>
         <div class="form-group" id="expenseDueDateGroup">
           <label class="form-label" for="expenseDueDate">Data de Vencimento</label>
           <input type="date" class="form-control" id="expenseDueDate">
         </div>
         <div class="form-group checkbox-wrapper">
           <input type="checkbox" class="checkbox" id="expenseIsRecurrent">
           <label class="checkbox-label" for="expenseIsRecurrent">Despesa Recorrente</label>
         </div>
         <div class="form-group" id="expenseRecurrenceGroup" style="display: none;">
           <label class="form-label" for="expenseInstallments">Quantidade de Parcelas</label>
           <input type="number" class="form-control" id="expenseInstallments" min="2" value="2">
         </div>
         <div class="form-group" id="expenseStatusGroup">
           <label class="form-label">Status</label>
           <div class="radio-group">
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusPaid" name="expenseStatus" value="paid">
               <label class="radio-label" for="expenseStatusPaid">Pago</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusPending" name="expenseStatus" value="pending" checked>
               <label class="radio-label" for="expenseStatusPending">Pendente</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusScheduled" name="expenseStatus" value="scheduled">
               <label class="radio-label" for="expenseStatusScheduled">Agendado</label>
             </div>
           </div>
         </div>
         <div class="form-group" id="scheduledDateGroup" style="display: none;">
           <label class="form-label" for="expenseScheduledDate">Data de Agendamento</label>
           <input type="date" class="form-control" id="expenseScheduledDate">
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseNotes">Observação (opcional)</label>
           <textarea class="form-control" id="expenseNotes" rows="3"></textarea>
         </div>
       </form>
     </div>
     <div class="modal-footer">
       <button class="btn btn-outline" id="cancelExpenseBtn">Cancelar</button>
       <button class="btn btn-danger" id="saveExpenseBtn">Salvar Despesa</button>
     </div>
   </div>
 </div>

 <!-- Modal de Edição de Transação -->
 <div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="editModalTitle">Editar Transação</h2>
      <button class="modal-close" id="closeEditModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <input type="hidden" id="editTransactionId">
        <input type="hidden" id="editTransactionType">
        <div class="form-group">
          <label class="form-label" for="editName">Nome</label>
          <input type="text" class="form-control" id="editName">
        </div>
        <div class="form-group">
          <label class="form-label" for="editAmount">Valor</label>
          <input type="number" class="form-control" id="editAmount" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="editCategory">Categoria</label>
          <div class="select-wrapper">
            <select class="select" id="editCategory" data-type=""></select>
          </div>
        </div>
        <div class="form-group" id="editPersonGroup">
          <label class="form-label" for="editPerson">Pessoa</label>
          <div class="select-wrapper">
            <select class="select" id="editPerson"></select>
          </div>
        </div>
        <div class="form-group" id="editExpenseTypeGroup" style="display: none;">
          <label class="form-label">Tipo de Despesa</label>
          <div class="radio-group">
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="editExpenseTypeFixed" name="editExpenseType" value="fixed">
              <label class="radio-label" for="editExpenseTypeFixed">Fixa</label>
            </div>
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="editExpenseTypeVariable" name="editExpenseType" value="variable">
              <label class="radio-label" for="editExpenseTypeVariable">Variável</label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="editDate">Data de Lançamento</label>
          <input type="date" class="form-control" id="editDate">
        </div>
        <div class="form-group" id="editDueDateGroup">
          <label class="form-label" for="editDueDate">Data de Vencimento</label>
          <input type="date" class="form-control" id="editDueDate">
        </div>
        <div class="form-group">
          <label class="form-label" for="editPaymentMethod">Forma de Pagamento</label>
          <div class="select-wrapper">
            <select class="select" id="editPaymentMethod"></select>
          </div>
        </div>
        <div class="form-group" id="editCreditCardGroup" style="display: none;">
          <label class="form-label" for="editCreditCard">Cartão de Crédito</label>
          <div class="select-wrapper">
            <select class="select" id="editCreditCard"></select>
          </div>
        </div>
        <div class="form-group checkbox-wrapper">
          <input type="checkbox" class="checkbox" id="editIsRecurrent">
          <label class="checkbox-label" for="editIsRecurrent">Transação Recorrente</label>
        </div>
        <div class="form-group" id="editRecurrenceGroup" style="display: none;">
          <label class="form-label" for="editInstallments">Quantidade de Parcelas</label>
          <input type="number" class="form-control" id="editInstallments" min="2" value="2">
        </div>
        <div class="form-group" id="editStatusOuterGroup"> 
          <label class="form-label">Status</label>
          <div class="radio-group" id="editStatusGroup">
            <!-- Opções de status serão inseridas dinamicamente -->
          </div>
        </div>
        <div class="form-group" id="editScheduledDateGroup" style="display: none;">
          <label class="form-label" for="editScheduledDate">Data de Agendamento</label>
          <input type="date" class="form-control" id="editScheduledDate">
        </div>
        <div class="form-group">
          <label class="form-label" for="editNotes">Observação (opcional)</label>
          <textarea class="form-control" id="editNotes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelEditBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveEditBtn">Salvar Alterações</button>
    </div>
  </div>
 </div>

 <!-- Modal de Cartões -->
 <div class="modal-backdrop" id="cardsListModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Cartões</h2>
      <button class="modal-close" id="closeCardsListModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="cardsList">
        <!-- Cards serão inseridos aqui dinamicamente -->
      </div>
      <button class="btn btn-primary" id="newCardBtn" style="margin-top: var(--spacing-4);">
        <i class="fas fa-plus"></i>
        Novo Cartão
      </button>
    </div>
  </div>
 </div>

 <!-- Modal de Novo Cartão -->
 <div class="modal-backdrop" id="newCardModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Novo Cartão</h2>
      <button class="modal-close" id="closeNewCardModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="cardForm">
        <div class="form-group">
          <label class="form-label" for="cardName">Nome do Cartão</label>
          <input type="text" class="form-control" id="cardName" placeholder="Ex: Nubank">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardLimit">Limite Total</label>
          <input type="number" class="form-control" id="cardLimit" placeholder="0,00" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardClosingDay">Dia de Fechamento</label>
          <input type="number" class="form-control" id="cardClosingDay" placeholder="1-31" min="1" max="31">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardDueDay">Dia de Vencimento</label>
          <input type="number" class="form-control" id="cardDueDay" placeholder="1-31" min="1" max="31">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelCardBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveCardBtn">Salvar Cartão</button>
    </div>
  </div>
 </div>

 <!-- Modal de Fatura do Cartão -->
 <div class="modal-backdrop" id="cardInvoiceModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="cardInvoiceTitle">Fatura do Cartão</h2>
      <button class="modal-close" id="closeCardInvoiceModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="card" style="margin-bottom: var(--spacing-4);">
        <div id="cardInvoiceDetails">
          <!-- Detalhes da fatura serão inseridos aqui dinamicamente -->
        </div>
      </div>
      <h3>Despesas desta Fatura</h3>
      <div class="transactions-table-container">
        <table class="transactions-table" id="cardInvoiceTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Data</th>
              <th>Valor</th>
              <th>Pago?</th>
            </tr>
          </thead>
          <tbody id="cardInvoiceTableBody">
            <!-- Despesas da fatura serão inseridas aqui dinamicamente -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="backToCardsBtn">Voltar</button>
      <button class="btn btn-primary" id="payInvoiceBtn">Pagar Fatura</button>
    </div>
  </div>
 </div>

 <!-- Modal de Confirmação de Exclusão -->
 <div class="modal-backdrop" id="deleteConfirmModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
        Confirmar Exclusão
      </h2>
      <button class="modal-close" id="closeDeleteConfirmModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Você deseja realmente excluir esta transação? Esta ação é irreversível.</p>
      <div id="recurrenceDeleteOptions" style="display: none; margin-top: var(--spacing-4);">
        <p><strong>Esta é uma transação recorrente. O que deseja fazer?</strong></p>
        <div class="radio-group" style="flex-direction: column; gap: var(--spacing-2);">
          <div class="radio-wrapper">
            <input type="radio" class="radio" id="deleteSingle" name="deleteOption" value="single" checked>
            <label class="radio-label" for="deleteSingle">Excluir apenas esta parcela</label>
          </div>
          <div class="radio-wrapper">
            <input type="radio" class="radio" id="deleteAllFuture" name="deleteOption" value="future">
            <label class="radio-label" for="deleteAllFuture">Excluir esta e todas as parcelas futuras</label>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelDeleteBtn">Cancelar</button>
      <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
    </div>
  </div>
 </div>

 <!-- Modal de Confirmação de Pagamento de Fatura -->
 <div class="modal-backdrop" id="payInvoiceConfirmModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-credit-card" style="margin-right: 8px;"></i>
        Pagar Fatura do Cartão
      </h2>
      <button class="modal-close" id="closePayInvoiceConfirmModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Confirmar pagamento de todas as despesas desta fatura?</p>
      <p style="margin-top: var(--spacing-1);">Total: <strong id="invoiceConfirmAmount">R$ 0,00</strong></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelPayInvoiceBtn">Cancelar</button>
      <button class="btn btn-primary" id="confirmPayInvoiceBtn">Pagar</button>
    </div>
  </div>
 </div>

 <!-- Modal de Categorias -->
 <div class="modal-backdrop" id="categoriesModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Gerenciar Categorias</h2>
      <button class="modal-close" id="closeCategoriesModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body categories-container">
      <ul class="nav-tabs" id="categoryTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="income-cat-tab" data-toggle="tab" href="#income-cat" role="tab">Receitas</a></li>
        <li class="nav-item"><a class="nav-link" id="expense-cat-tab" data-toggle="tab" href="#expense-cat" role="tab">Despesas</a></li>
        <li class="nav-item"><a class="nav-link" id="payment-methods-tab" data-toggle="tab" href="#payment-methods" role="tab">Pagamentos</a></li>
        <li class="nav-item"><a class="nav-link" id="people-tab" data-toggle="tab" href="#people" role="tab">Pessoas</a></li>
        <li class="nav-item"><a class="nav-link" id="investment-cat-tab" data-toggle="tab" href="#investment-cat" role="tab">Investimentos</a></li>
      </ul>
      <div class="tab-content" id="categoryTabContent">
        <div class="tab-pane fade show active" id="income-cat" role="tabpanel">
          <div class="category-list" id="incomeCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newIncomeCategoryIconPreview">💰</div><input type="text" class="form-control" id="newIncomeCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newIncomeCategoryInput" placeholder="Nova categoria de receita">
            <button type="button" class="btn btn-primary" id="addIncomeCategoryBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="expense-cat" role="tabpanel">
          <div class="category-list" id="expenseCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newExpenseCategoryIconPreview">🛍️</div><input type="text" class="form-control" id="newExpenseCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newExpenseCategoryInput" placeholder="Nova categoria de despesa">
            <button type="button" class="btn btn-primary" id="addExpenseCategoryBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="payment-methods" role="tabpanel">
          <div class="category-list" id="paymentMethodsList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newPaymentMethodIconPreview">💳</div><input type="text" class="form-control" id="newPaymentMethodIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newPaymentMethodInput" placeholder="Nova forma de pagamento">
            <button type="button" class="btn btn-primary" id="addPaymentMethodBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="people" role="tabpanel">
          <div class="category-list" id="peopleList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newPersonIconPreview">👤</div><input type="text" class="form-control" id="newPersonIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newPersonInput" placeholder="Nome da pessoa">
            <button type="button" class="btn btn-primary" id="addPersonBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="investment-cat" role="tabpanel">
          <div class="category-list" id="investmentCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newInvestmentCategoryIconPreview">📈</div><input type="text" class="form-control" id="newInvestmentCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newInvestmentCategoryInput" placeholder="Nova categoria de investimento">
            <button type="button" class="btn btn-primary" id="addInvestmentCategoryBtn">Adicionar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeCategoriesBtn">Fechar</button>
    </div>
  </div>
 </div>

 <!-- Modal de Edição de Categoria/Item -->
 <div class="modal-backdrop" id="editCategoryModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title" id="editCategoryTitle">Editar Item</h2>
      <button class="modal-close" id="closeEditCategoryModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="editCategoryForm">
        <input type="hidden" id="editCategoryId">
        <input type="hidden" id="editCategoryType">
        <div class="form-group">
          <label class="form-label">Ícone</label>
          <div class="custom-icon-input">
            <div class="custom-icon-preview" id="editCategoryIconPreview">ℹ️</div>
            <input type="text" class="form-control" id="editCategoryIconInput" placeholder="Emoji ou ícone">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="editCategoryName">Nome</label>
          <input type="text" class="form-control" id="editCategoryName" placeholder="Nome">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelEditCategoryBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveEditCategoryBtn">Salvar</button>
    </div>
  </div>
 </div>

 <!-- Modal Principal de Investimentos -->
 <div class="modal-backdrop" id="investmentsModal">
  <div class="modal" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title">Investimentos</h2>
      <button class="modal-close" id="closeInvestmentsModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
        <h3>Seus Investimentos</h3>
        <button class="btn btn-primary" id="newInvestmentBtn">
          <i class="fas fa-plus"></i>
          Novo Investimento
        </button>
      </div>
      <div class="grid grid-cols-3 md-grid-cols-2 sm-grid-cols-1 gap-6" id="investmentsGrid">
        <!-- Cards de investimentos -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeInvestmentsBtn">Fechar</button>
    </div>
  </div>
 </div>

 <!-- Modal para Detalhe do Investimento -->
 <div class="modal-backdrop" id="investmentDetailModal">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h2 class="modal-title" id="investmentDetailTitle" style="display: flex; align-items: center; gap: var(--spacing-2);">
        <button class="btn btn-icon btn-outline" id="backToInvestmentsBtn" aria-label="Voltar">
          <i class="fas fa-arrow-left"></i>
        </button>
        <span id="investmentDetailName">Nome do Investimento</span>
      </h2>
      <button class="modal-close" id="closeInvestmentDetailModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="investment-detail">
        <div class="grid grid-cols-3 sm-grid-cols-1 gap-4 mb-4">
          <div class="card">
            <div class="card-body">
              <div class="text-sm font-medium text-muted">Guardado</div>
              <div class="text-xl font-bold" id="investmentDetailSaved">R$ 0,00</div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="text-sm font-medium text-muted">Meta</div>
              <div class="text-xl font-bold" id="investmentDetailGoal">R$ 0,00</div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="text-sm font-medium text-muted">Progresso</div>
              <div class="text-xl font-bold" id="investmentDetailProgress">0%</div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-3 sm-grid-cols-1 gap-4 mb-4">
          <div>
            <div class="text-sm font-medium text-muted">Categoria</div>
            <div id="investmentDetailCategory">Viagem</div>
          </div>
          <div>
            <div class="text-sm font-medium text-muted">Criado em</div>
            <div id="investmentDetailCreatedAt">01/01/2025</div>
          </div>
          <div>
            <div class="text-sm font-medium text-muted">Objetivo</div>
            <div id="investmentDetailTarget">Julho de 2026</div>
          </div>
        </div>
        
        <div class="mb-6">
          <div class="text-sm font-medium text-muted">Observação</div>
          <div id="investmentDetailNotes">-</div>
        </div>
      </div>
      
      <div class="investment-history">
        <div class="flex justify-between items-center mb-4">
          <h3 class="investment-history-title">Histórico de Aportes</h3>
          <button class="btn btn-primary" id="addInvestmentContributionBtn">
            <i class="fas fa-plus"></i>
            Adicionar Aporte
          </button>
        </div>
        <div class="transactions-table-container">
          <table class="transactions-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Valor</th>
                <th>Descrição</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="investmentHistoryTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="deleteInvestmentBtn">Excluir Investimento</button>
      <button class="btn btn-primary" id="editInvestmentBtn">Editar Investimento</button>
    </div>
  </div>
 </div>

 <!-- Modal de Novo Investimento -->
 <div class="modal-backdrop" id="newInvestmentModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="newInvestmentModalTitle">Novo Investimento</h2>
      <button class="modal-close" id="closeNewInvestmentModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="investmentForm">
        <div class="form-group">
          <label class="form-label" for="investmentName">Nome do objetivo</label>
          <input type="text" class="form-control" id="investmentName" placeholder="Ex: Viagem em Família">
        </div>
        <div class="form-group">
          <label class="form-label" for="investmentAmount">Valor inicial</label>
          <input type="number" class="form-control" id="investmentAmount" placeholder="0,00" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="investmentGoal">Meta final (opcional)</label>
          <input type="number" class="form-control" id="investmentGoal" placeholder="0,00" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="investmentCategory">Tipo/Categoria</label>
          <div class="select-wrapper">
            <select class="select" id="investmentCategorySelect"></select> 
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="investmentTargetDate">Data-alvo (opcional)</label>
          <input type="date" class="form-control" id="investmentTargetDate">
        </div>
        <div class="form-group">
          <label class="form-label" for="investmentNotes">Observações (opcional)</label>
          <textarea class="form-control" id="investmentNotes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelInvestmentBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveInvestmentBtn">Salvar Investimento</button>
    </div>
  </div>
 </div>

 <!-- Modal para Adicionar Aporte -->
 <div class="modal-backdrop" id="newContributionModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title" id="newContributionModalTitle">Adicionar Novo Valor</h2>
      <button class="modal-close" id="closeNewContributionModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="contributionForm">
        <input type="hidden" id="contributionInvestmentId">
        <div class="form-group">
          <label class="form-label" for="contributionAmount">Valor</label>
          <input type="number" class="form-control" id="contributionAmount" placeholder="0,00" min="0" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="contributionDate">Data</label>
          <input type="date" class="form-control" id="contributionDate" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="contributionDescription">Descrição</label>
          <input type="text" class="form-control" id="contributionDescription" placeholder="Ex: Depósito mensal">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelContributionBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveContributionBtn">Adicionar</button>
    </div>
  </div>
 </div>

 <!-- Modal para detalhes de contas vencidas/a vencer -->
 <div class="modal-backdrop" id="dueTransactionsModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="dueTransactionsModalTitle">
        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;" id="dueTransactionsModalIcon"></i>
        <span id="dueTransactionsModalTitleText">Contas</span>
      </h2>
      <button class="modal-close" id="closeDueTransactionsModal" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="transactions-table-container">
        <table class="transactions-table" id="dueTransactionsTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Vencimento</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="dueTransactionsTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeDueTransactionsBtn">Fechar</button>
      <button class="btn btn-primary" id="payAllDueBtn" style="display:none;">Pagar Todas</button>
    </div>
  </div>
 </div>

 <div class="toast-container" id="toastContainer"></div>

 <script>
  
  const $ = selector => document.querySelector(selector);
  const $$ = selector => Array.from(document.querySelectorAll(selector));

  const state = {
    year: new Date().getFullYear(),
    month: new Date().getMonth(),
    transactions: [],
    cards: [],
    filteredTransactions: [],
    insights: [],
    sortColumn: 'dueDate', 
    sortDirection: 'asc', 
    filters: {
      category: '',
      status: '',
      paymentMethod: '',
      person: '',
      transactionType: '' 
    },
    categories: {
      income: [
        { id: 'salario', name: 'Salário', icon: '💰', type: 'income' },
        { id: 'investimentos_income', name: 'Rend. Investimentos', icon: '📈', type: 'income' },
        { id: 'freelance', name: 'Freelance', icon: '💻', type: 'income' },
        { id: 'presente', name: 'Presente', icon: '🎁', type: 'income' },
        { id: 'outros_income', name: 'Outros', icon: 'ℹ️', type: 'income' }
      ],
      expense: [
        { id: 'alimentacao', name: 'Alimentação', icon: '🍔', type: 'expense' },
        { id: 'moradia', name: 'Moradia', icon: '🏠', type: 'expense' },
        { id: 'transporte', name: 'Transporte', icon: '🚗', type: 'expense' },
        { id: 'saude', name: 'Saúde', icon: '⚕️', type: 'expense' },
        { id: 'educacao', name: 'Educação', icon: '📚', type: 'expense' },
        { id: 'lazer', name: 'Lazer', icon: '🎮', type: 'expense' },
        { id: 'compras', name: 'Compras', icon: '🛍️', type: 'expense' },
        { id: 'contas', name: 'Contas e serviços', icon: '📝', type: 'expense' },
        { id: 'impostos', name: 'Impostos', icon: '💸', type: 'expense' },
        { id: 'outros_expense', name: 'Outros', icon: 'ℹ️', type: 'expense' }
      ],
      investment: [
        { id: 'viagem', name: 'Viagem', icon: '✈️', type: 'investment' },
        { id: 'emergencia', name: 'Emergência', icon: '🚨', type: 'investment' },
        { id: 'filho', name: 'Filho', icon: '👶', type: 'investment' },
        { id: 'tesouro', name: 'Tesouro Direto', icon: '🏛️', type: 'investment' },
        { id: 'acoes', name: 'Ações', icon: '📊', type: 'investment' },
        { id: 'outro_investment', name: 'Outro', icon: '💰', type: 'investment' }
      ]
    },
    paymentMethods: [
      { id: 'dinheiro', name: 'Dinheiro', icon: '💵' },
      { id: 'pix', name: 'Pix', icon: '⚡' },
      { id: 'debito', name: 'Débito', icon: '💳' },
      { id: 'debito_conta', name: 'Débito em Conta', icon: '🏦' },
      { id: 'transferencia', name: 'Transferência Bancária', icon: '🔄' },
      { id: 'boleto', name: 'Boleto', icon: '📄' },
      { id: 'credito', name: 'Cartão de Crédito', icon: '💳' }
    ],
    people: [
      { id: 'familia', name: 'Família', icon: '👨‍👩‍👧‍👦' },
      { id: 'wagner', name: 'Wagner', icon: '👨‍💻' },
      { id: 'barbara', name: 'Bárbara', icon: '👩‍🎨' },
      { id: 'joaquim', name: 'Joaquim', icon: '👶' }
    ],
    investments: [],
    investmentContributions: [],
    currentTransaction: null,
    currentCard: null,
    currentCategory: null,
    currentInvestment: null,
    currentContribution: null,
    themePreference: 'light'
  };

  const formatCurrency = value => {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
  };

  const parseLocalDateString = (dateInput) => {
    if (dateInput instanceof Date && !isNaN(dateInput)) return new Date(Date.UTC(dateInput.getFullYear(), dateInput.getMonth(), dateInput.getDate()));
    if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
      const [year, month, day] = dateInput.split('-').map(Number);
      return new Date(Date.UTC(year, month - 1, day)); 
    }
    return null;
  };
  
  const formatDate = (date, options = {}) => {
    const dateObj = parseLocalDateString(date);
    if (!dateObj) return '--/--/----';
    return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC', ...options });
  };

  const localDateToISOString = (date) => {
    if (!date) return null;
    const d = date instanceof Date ? date : parseLocalDateString(date);
    if (!d) return null;
    const year = d.getUTCFullYear();
    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
    const day = String(d.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // Funções auxiliares para gráficos com ApexCharts
  const showTooltip = (chart, content, event) => {
    // Função implementada pelo próprio ApexCharts
  };

  const hideTooltip = () => {
    // Função implementada pelo próprio ApexCharts
  };

  const toggleTheme = () => {
    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    state.themePreference = newTheme;
    localStorage.setItem('themePreference', newTheme);
    updateChartColors();
  };

  const initTheme = () => {
    const savedTheme = localStorage.getItem('themePreference') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', savedTheme);
    state.themePreference = savedTheme;
    $('#themeToggle').addEventListener('click', toggleTheme);
  };

  const firebaseConfig = {
    apiKey: "AIzaSyDvL_nYWhv_8rPouejiWbDZtDCKHYOQyEY",
    authDomain: "calculadora-da-familia.firebaseapp.com",
    projectId: "calculadora-da-familia",
    storageBucket: "calculadora-da-familia.appspot.com",
    messagingSenderId: "69721783786",
    appId: "1:69721783786:web:c4703b5c182e3681e8c693",
    measurementId: "G-YM5TR661S6"
  };

  let db;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    db.enablePersistence({experimentalForceOwningTab: true}).catch(err => console.warn('Firebase persistence error:', err.code));
    console.log('Firebase inicializado.');
  } catch (error) {
    console.error('Erro Firebase:', error);
    showToast('Erro de conexão com o Firebase.', 'error');
    db = { collection: () => ({ get: () => Promise.resolve({ docs: [], empty: true }), doc: () => ({ get: () => Promise.resolve({ exists: false, data: () => ({}) }), set: () => Promise.resolve(), update: () => Promise.resolve(), delete: () => Promise.resolve() }), add: () => Promise.resolve({ id: 'temp-id' }) }) };
  }

  const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

  const showToast = (message, type = 'success') => {
    const container = $('#toastContainer');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    let iconClass = 'info-circle';
    if (type === 'success') iconClass = 'check-circle';
    if (type === 'error') iconClass = 'times-circle';
    if (type === 'warning') iconClass = 'exclamation-triangle';
    
    toast.innerHTML = `
      <div class="toast-icon">
        <i class="fas fa-${iconClass}"></i>
      </div>
      <div class="toast-content">${message}</div>
      <button class="toast-close">
        <i class="fas fa-times"></i>
      </button>
    `;
    
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    
    toast.querySelector('.toast-close').addEventListener('click', () => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    });
    
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  };

  const openModal = modalId => {
    const modal = $(`#${modalId}`);
    if (modal) {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  };
  
  const closeModal = modalId => {
    const modal = $(`#${modalId}`);
    if (modal) {
      modal.classList.remove('active');
      if (!$$('.modal-backdrop.active').length) { 
        document.body.style.overflow = '';
      }
    }
  };
  
  const closeAllModals = () => {
    $$('.modal-backdrop.active').forEach(modal => closeModal(modal.id));
  };

  const setDateInputValue = (inputId, date) => {
    const input = $(`#${inputId}`);
    if (input) input.value = localDateToISOString(date);
  };
  
  const getDateInputValue = inputId => {
    const input = $(`#${inputId}`);
    return input && input.value ? parseLocalDateString(input.value) : null;
  };

  const updateYearOptions = () => {
    const yearSelect = $('#yearSelect');
    if (yearSelect) {
      yearSelect.innerHTML = '';
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 2; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        option.selected = year === state.year;
        yearSelect.appendChild(option);
      }
    }
  };

  const calcularVencimentoReal = (dataCompraInput, cartao) => {
    if (!dataCompraInput || !cartao || !cartao.closingDay || !cartao.dueDay) return null;
    
    const compraDate = parseLocalDateString(dataCompraInput);
    if (!compraDate) return null;

    const compraDay = compraDate.getUTCDate();
    let mesFechamentoFatura = compraDate.getUTCMonth(); 
    let anoFechamentoFatura = compraDate.getUTCFullYear();

    if (compraDay > cartao.closingDay) {
        mesFechamentoFatura++;
        if (mesFechamentoFatura > 11) {
            mesFechamentoFatura = 0;
            anoFechamentoFatura++;
        }
    }

    let mesVencimentoFinal = mesFechamentoFatura;
    let anoVencimentoFinal = anoFechamentoFatura;

    if (cartao.dueDay < cartao.closingDay) {
        mesVencimentoFinal++;
        if (mesVencimentoFinal > 11) {
            mesVencimentoFinal = 0;
            anoVencimentoFinal++;
        }
    }
    return new Date(Date.UTC(anoVencimentoFinal, mesVencimentoFinal, cartao.dueDay));
  };
  
  const calcularMelhorDiaCompras = (cartao) => {
    if (!cartao || !cartao.closingDay) return null;
    const dataFechamentoNoMesAtual = new Date(Date.UTC(state.year, state.month, cartao.closingDay));
    const dataMelhorDia = new Date(dataFechamentoNoMesAtual);
    dataMelhorDia.setUTCDate(dataFechamentoNoMesAtual.getUTCDate() + 1);
    return dataMelhorDia.getUTCDate();
  };

  const handleStatusField = (formPrefix) => {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const isRecurrentEl = $(`#${formPrefix}IsRecurrent`);
    const statusGroupEl = $(`#${formPrefix}StatusGroup`);
    const statusPendingRadio = $(`#${formPrefix}StatusPending`); 

    if (!paymentMethodEl || !statusGroupEl || !statusPendingRadio) return;
    
    const isCreditCard = paymentMethodEl.value === 'credito';
    const isRecurrent = isRecurrentEl ? isRecurrentEl.checked : false;

    if (isCreditCard || (isRecurrent && formPrefix.includes('expense'))) { 
        statusGroupEl.style.display = 'none';
        statusPendingRadio.checked = true;
    } else if (isRecurrent && formPrefix.includes('income')) { 
        statusGroupEl.style.display = 'none';
        statusPendingRadio.checked = true; 
    } else {
        statusGroupEl.style.display = 'block'; 
    }
  };
  
  async function updateCardLimits(cardId, transactionAmount, operation, oldTransactionAmount = 0) {
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;

    let amountChange = 0;
    if (operation === 'add') {
        amountChange = transactionAmount;
    } else if (operation === 'subtract') {
        amountChange = -transactionAmount;
    } else if (operation === 'update') {
        amountChange = transactionAmount - oldTransactionAmount;
    }

    card.currentInvoice = (card.currentInvoice || 0) + amountChange;
    card.currentInvoice = Math.max(0, card.currentInvoice); 
    card.availableLimit = card.limit - card.currentInvoice;

    try {
        await db.collection('cards').doc(card.id).update({
            currentInvoice: card.currentInvoice, 
            availableLimit: card.availableLimit
        });
    } catch (error) {
        console.error("Error updating card limits in DB:", error);
        showToast('Erro ao atualizar limite do cartão.', 'error');
    }
    updateCreditCardSelects();
  }


  const loadCategoriesAndPaymentMethods = async () => {
    try {
      const collectionsToLoad = [
        { name: 'categories', stateKey: 'categories', defaultKey: true, typeField: 'type' },
        { name: 'paymentMethods', stateKey: 'paymentMethods', defaultKey: false },
        { name: 'people', stateKey: 'people', defaultKey: false }
      ];

      for (const coll of collectionsToLoad) {
        const snapshot = await db.collection(coll.name).get();
        if (!snapshot.empty) {
          if (coll.defaultKey) { 
            state[coll.stateKey].income = [];
            state[coll.stateKey].expense = [];
            state[coll.stateKey].investment = [];
            snapshot.docs.forEach(doc => {
              const item = { id: doc.id, ...doc.data() };
              if (item[coll.typeField] === 'income') state[coll.stateKey].income.push(item);
              else if (item[coll.typeField] === 'expense') state[coll.stateKey].expense.push(item);
              else if (item[coll.typeField] === 'investment') state[coll.stateKey].investment.push(item);
            });
          } else {
            state[coll.stateKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          }
        } else if (state[coll.stateKey]) { 
          const batch = db.batch();
          if (coll.defaultKey) {
            Object.values(state[coll.stateKey]).flat().forEach(item => {
              const docRef = db.collection(coll.name).doc(item.id);
              batch.set(docRef, item); 
            });
          } else {
            state[coll.stateKey].forEach(item => {
              const docRef = db.collection(coll.name).doc(item.id);
              batch.set(docRef, item);
            });
          }
          await batch.commit();
        }
      }
      updateAllSelectsAndLists();
    } catch (error) {
      console.error('Erro ao carregar dados iniciais:', error);
      showToast('Erro ao carregar dados. Tente novamente.', 'error');
    }
  };
  
  const updateAllSelectsAndLists = () => {
    updateCategorySelects();
    updatePaymentMethodSelects();
    updatePeopleSelects();
    updateInvestmentCategorySelects(); 
    renderCategoriesList(); 
    renderPaymentMethodsList();
    renderInvestmentCategoriesList();
    updatePeopleList();
  };

  const updateCategorySelects = () => {
    const populateSelect = (selectEl, categories) => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = `${category.icon || ''} ${category.name}`; 
          selectEl.appendChild(option);
        });
        if (categories.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    };
    populateSelect($('#incomeCategory'), state.categories.income);
    populateSelect($('#expenseCategory'), state.categories.expense);
    
    const editCategorySelect = $('#editCategory');
    if (editCategorySelect && state.currentTransaction) {
        const categories = state.currentTransaction.type === 'income' ? state.categories.income : state.categories.expense;
        populateSelect(editCategorySelect, categories);
        editCategorySelect.value = state.currentTransaction.category;
    }
  };

  const updatePaymentMethodSelects = () => {
    const selects = [$('#incomePaymentMethod'), $('#expensePaymentMethod'), $('#editPaymentMethod')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        state.paymentMethods.forEach(method => {
          const option = document.createElement('option');
          option.value = method.id;
          option.textContent = `${method.icon || ''} ${method.name}`;
          selectEl.appendChild(option);
        });
         if (state.paymentMethods.find(m => m.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };

  const updatePeopleSelects = () => {
    const selects = [$('#expensePerson'), $('#editPerson')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Ninguém</option>'; 
        state.people.forEach(person => {
          const option = document.createElement('option');
          option.value = person.id;
          option.textContent = `${person.icon || ''} ${person.name}`;
          selectEl.appendChild(option);
        });
        if (state.people.find(p => p.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };

  const updateInvestmentCategorySelects = () => {
    const selectEl = $('#investmentCategorySelect'); 
    if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        state.categories.investment.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = `${category.icon || ''} ${category.name}`;
            selectEl.appendChild(option);
        });
        if (state.categories.investment.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
    }
  };


  const loadCards = async () => {
    try {
      const snapshot = await db.collection('cards').get();
      state.cards = snapshot.docs.map(doc => {
          const card = { id: doc.id, ...doc.data() };
          card.currentInvoice = card.currentInvoice || 0; 
          card.availableLimit = card.limit - card.currentInvoice;
          return card;
      });
      updateCardsList();
      updateCreditCardSelects();
    } catch (error) {
      console.error('Erro ao carregar cartões:', error);
      showToast('Erro ao carregar cartões.', 'error');
    }
  };

  const addCard = async (cardData) => {
    try {
      const card = {
        ...cardData,
        currentInvoice: 0, 
        availableLimit: cardData.limit, 
        createdAt: localDateToISOString(new Date())
      };
      const docRef = await db.collection('cards').add(card);
      card.id = docRef.id;
      state.cards.push(card);
      await fullUIRefresh(); 
      showToast('Cartão adicionado!', 'success');
    } catch (error) {
      console.error('Erro ao adicionar cartão:', error);
      showToast('Erro ao adicionar cartão.', 'error');
    }
  };

  const updateCard = async (cardId, updates) => {
    try {
      if (updates.limit !== undefined) {
        const card = state.cards.find(c => c.id === cardId);
        if (card) {
            updates.availableLimit = updates.limit - (card.currentInvoice || 0);
        }
      }
      await db.collection('cards').doc(cardId).update(updates);
      const index = state.cards.findIndex(c => c.id === cardId);
      if (index !== -1) state.cards[index] = { ...state.cards[index], ...updates };
      await fullUIRefresh(); 
      showToast('Cartão atualizado!', 'success');
    } catch (error) {
      console.error('Erro ao atualizar cartão:', error);
      showToast('Erro ao atualizar cartão.', 'error');
    }
  };

  const deleteCard = async (cardId) => {
    try {
      if (!confirm('Tem certeza que deseja excluir este cartão? Transações associadas não serão alteradas, mas perderão o vínculo com este cartão.')) return;

      await db.collection('cards').doc(cardId).delete();
      state.cards = state.cards.filter(c => c.id !== cardId);
      const batch = db.batch();
      let changed = false;
      state.transactions.forEach(t => {
        if (t.creditCardId === cardId) {
            batch.update(db.collection('transactions').doc(t.id), { creditCardId: null, creditCardName: null });
            t.creditCardId = null; t.creditCardName = null;
            changed = true;
        }
      });
      if (changed) await batch.commit();

      await fullUIRefresh(); 
      showToast('Cartão excluído!', 'success');
    } catch (error) {
      console.error('Erro ao excluir cartão:', error);
      showToast('Erro ao excluir cartão.', 'error');
    }
  };

  const payCardInvoice = async (cardId) => {
    try {
      const card = state.cards.find(c => c.id === cardId);
      if (!card) return;

      const faturaVencimentoRef = new Date(Date.UTC(state.year, state.month, card.dueDay));
      const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoRef);

      const batch = db.batch();
      let totalFaturaPagaEsteMes = 0;

      state.transactions.forEach(t => {
        if (t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === cardId) {
          const dataCompra = parseLocalDateString(t.date);
          if (dataCompra >= previousClosing && dataCompra < currentClosingDate && t.status !== 'paid') {
            const docRef = db.collection('transactions').doc(t.id);
            batch.update(docRef, { status: 'paid' });
            t.status = 'paid'; 
            totalFaturaPagaEsteMes += parseFloat(t.amount);
          }
        }
      });
      
      if (totalFaturaPagaEsteMes > 0) {
        card.currentInvoice = Math.max(0, (card.currentInvoice || 0) - totalFaturaPagaEsteMes);
        card.availableLimit = card.limit - card.currentInvoice;
        batch.update(db.collection('cards').doc(card.id), {
            currentInvoice: card.currentInvoice,
            availableLimit: card.availableLimit
        });
      }
      
      await batch.commit();
      await fullUIRefresh(); 
      closeModal('payInvoiceConfirmModal');
      showToast('Fatura paga com sucesso!', 'success');
    } catch (error) {
      console.error('Erro ao pagar fatura:', error);
      showToast('Erro ao pagar fatura.', 'error');
    }
  };

  const updateCreditCardSelects = () => {
    const selects = [$('#expenseCreditCard'), $('#editCreditCard')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '';
        if (state.cards.length === 0) {
          selectEl.innerHTML = '<option value="" disabled selected>Nenhum cartão</option>';
        } else {
          selectEl.innerHTML = '<option value="">Selecione o cartão...</option>';
          state.cards.forEach(card => {
            const option = document.createElement('option');
            option.value = card.id;
            option.textContent = `${card.name} (Disp: ${formatCurrency(card.availableLimit)})`;
            selectEl.appendChild(option);
          });
        }
        if (state.cards.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };
  
  const loadInvestments = async () => {
    try {
      const [invSnapshot, contribSnapshot] = await Promise.all([
        db.collection('investments').get(),
        db.collection('investmentContributions').get()
      ]);
      state.investments = invSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      state.investmentContributions = contribSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderInvestmentCards();
    } catch (error) {
      console.error('Erro ao carregar investimentos:', error);
      showToast('Erro ao carregar investimentos.', 'error');
    }
  };

  const renderInvestmentCards = () => {
    const grid = $('#investmentsGrid');
    if (!grid) return;
    grid.innerHTML = '';
    if (state.investments.length === 0) {
      grid.innerHTML = '<p style="text-align: center; padding: var(--spacing-4);">Nenhum investimento.</p>';
      return;
    }
    state.investments.forEach(inv => {
      const contributions = state.investmentContributions.filter(c => c.investmentId === inv.id);
      const totalContributed = contributions.reduce((sum, c) => sum + parseFloat(c.amount), 0) + parseFloat(inv.amount || 0);
      const category = state.categories.investment.find(c => c.id === inv.category);
      const hasGoal = inv.goal && parseFloat(inv.goal) > 0;
      const progress = hasGoal ? Math.min(100, (totalContributed / parseFloat(inv.goal)) * 100) : 0;

      const cardEl = document.createElement('div');
      cardEl.className = 'card'; 
      cardEl.dataset.id = inv.id;
      cardEl.style.cursor = 'pointer';
      
      cardEl.innerHTML = `
        <div class="card-body">
          <div class="flex justify-between items-center mb-2">
            <h3 class="card-title">${inv.name}</h3>
            <span class="badge" style="background-color: var(--color-primary-bg); color: var(--color-primary);">
              ${category ? `${category.icon} ${category.name}` : 'N/A'}
            </span>
          </div>
          <div class="mb-2">Guardado: <strong>${formatCurrency(totalContributed)}</strong></div>
          ${hasGoal ? `<div class="mb-2">Meta: <strong>${formatCurrency(inv.goal)}</strong></div>` : ''}
          ${hasGoal ? `
            <div class="mb-2">
              <div style="height: 8px; background-color: var(--color-surface-variant); border-radius: var(--radius-full); overflow: hidden;">
                <div style="height: 100%; width: ${progress.toFixed(0)}%; background-color: var(--color-primary); border-radius: var(--radius-full);"></div>
              </div>
              <div class="flex justify-between text-sm text-muted mt-1">
                <span>${progress.toFixed(0)}%</span>
                ${inv.targetDate ? `<span>Até: ${formatDate(inv.targetDate)}</span>` : ''}
              </div>
            </div>` : ''}
          <div class="flex justify-between items-center mt-4">
            <small class="text-muted">Criado em: ${formatDate(inv.createdAt)}</small>
            <div>
              <button class="btn btn-icon btn-sm btn-outline edit-investment-btn" aria-label="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-icon btn-sm btn-outline delete-investment-btn" aria-label="Excluir">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>`;
      
      cardEl.addEventListener('click', (e) => {
        if (!e.target.closest('.edit-investment-btn') && !e.target.closest('.delete-investment-btn')) {
          openInvestmentDetail(inv.id);
        }
      });
      
      grid.appendChild(cardEl);
    });
    
    $$('#investmentsGrid .edit-investment-btn').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); 
        openEditInvestmentModal(e.currentTarget.closest('.card').dataset.id);
    }));
    
    $$('#investmentsGrid .delete-investment-btn').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); 
        if (confirm('Excluir este investimento e todos os aportes?')) 
          deleteInvestment(e.currentTarget.closest('.card').dataset.id);
    }));
  };
  
  const openInvestmentDetail = (investmentId) => {
    const investment = state.investments.find(i => i.id === investmentId);
    if (!investment) return;
    state.currentInvestment = investment;
    const contributions = state.investmentContributions.filter(c => c.investmentId === investment.id);
    const totalContributed = contributions.reduce((sum, c) => sum + parseFloat(c.amount), 0) + parseFloat(investment.amount || 0);
    const category = state.categories.investment.find(c => c.id === investment.category);
    const hasGoal = investment.goal && parseFloat(investment.goal) > 0;
    const progress = hasGoal ? Math.min(100, (totalContributed / parseFloat(investment.goal)) * 100) : 0;

    $('#investmentDetailName').textContent = investment.name;
    $('#investmentDetailSaved').textContent = formatCurrency(totalContributed);
    $('#investmentDetailGoal').textContent = hasGoal ? formatCurrency(investment.goal) : 'N/A';
    $('#investmentDetailProgress').textContent = hasGoal ? `${progress.toFixed(0)}%` : 'N/A';
    $('#investmentDetailCategory').textContent = category ? `${category.icon} ${category.name}` : 'N/A';
    $('#investmentDetailCreatedAt').textContent = formatDate(investment.createdAt);
    $('#investmentDetailTarget').textContent = investment.targetDate ? formatDate(investment.targetDate) : 'N/A';
    $('#investmentDetailNotes').textContent = investment.notes || '-';
    renderInvestmentContributions(investmentId);
    closeModal('investmentsModal');
    openModal('investmentDetailModal');
  };

  const renderInvestmentContributions = (investmentId) => {
    const tableBody = $('#investmentHistoryTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '';
    const investment = state.investments.find(i => i.id === investmentId);
    let allContributions = [];
    if (investment && parseFloat(investment.amount) > 0) {
        allContributions.push({ id: 'initial', date: investment.createdAt, amount: investment.amount, description: 'Depósito inicial', isInitial: true });
    }
    allContributions = allContributions.concat(state.investmentContributions.filter(c => c.investmentId === investmentId));
    allContributions.sort((a, b) => parseLocalDateString(b.date) - parseLocalDateString(a.date));

    if (allContributions.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum aporte.</td></tr>';
      return;
    }
    allContributions.forEach(c => {
      const row = tableBody.insertRow();
      row.innerHTML = `
        <td>${formatDate(c.date)}</td>
        <td>${formatCurrency(c.amount)}</td>
        <td>${c.description || '-'}</td>
        <td class="transaction-actions">
          ${c.isInitial ? '-' : `
            <button class="btn btn-icon btn-sm btn-outline edit-contribution-btn" data-id="${c.id}" aria-label="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-icon btn-sm btn-outline delete-contribution-btn" data-id="${c.id}" aria-label="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          `}
        </td>`;
    });
    $$('#investmentHistoryTableBody .edit-contribution-btn').forEach(btn => btn.addEventListener('click', (e) => openEditContributionModal(e.currentTarget.dataset.id)));
    $$('#investmentHistoryTableBody .delete-contribution-btn').forEach(btn => btn.addEventListener('click', (e) => { if (confirm('Excluir este aporte?')) deleteContribution(e.currentTarget.dataset.id); }));
  };

  const addInvestment = async (data) => {
    try {
      const investment = { ...data, createdAt: localDateToISOString(new Date()) };
      const docRef = await db.collection('investments').add(investment);
      investment.id = docRef.id;
      state.investments.push(investment);
      await fullUIRefresh(); 
      showToast('Investimento adicionado!', 'success');
      return investment;
    } catch (e) { console.error(e); showToast('Erro ao adicionar investimento.', 'error'); return null; }
  };
  const updateInvestment = async (id, data) => {
    try {
      await db.collection('investments').doc(id).update(data);
      const index = state.investments.findIndex(i => i.id === id);
      if (index !== -1) state.investments[index] = { ...state.investments[index], ...data };
      await fullUIRefresh(); 
      showToast('Investimento atualizado!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar investimento.', 'error'); return false; }
  };
  const deleteInvestment = async (id) => {
    try {
      const batch = db.batch();
      batch.delete(db.collection('investments').doc(id));
      state.investmentContributions.filter(c => c.investmentId === id).forEach(c => batch.delete(db.collection('investmentContributions').doc(c.id)));
      await batch.commit();
      state.investments = state.investments.filter(i => i.id !== id);
      state.investmentContributions = state.investmentContributions.filter(c => c.investmentId !== id);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === id) {
        closeModal('investmentDetailModal');
        openModal('investmentsModal');
      }
      showToast('Investimento excluído!', 'success');
    } catch (e) { console.error(e); showToast('Erro ao excluir investimento.', 'error'); }
  };
  const addContribution = async (data) => {
    try {
      const contribution = { ...data, createdAt: localDateToISOString(new Date()) };
      const docRef = await db.collection('investmentContributions').add(contribution);
      contribution.id = docRef.id;
      state.investmentContributions.push(contribution);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === data.investmentId) {
        renderInvestmentContributions(data.investmentId); 
        openInvestmentDetail(data.investmentId); 
      }
      showToast('Aporte adicionado!', 'success'); return contribution;
    } catch (e) { console.error(e); showToast('Erro ao adicionar aporte.', 'error'); return null; }
  };
  const updateContribution = async (id, data) => {
    try {
      await db.collection('investmentContributions').doc(id).update(data);
      const index = state.investmentContributions.findIndex(c => c.id === id);
      if (index !== -1) state.investmentContributions[index] = { ...state.investmentContributions[index], ...data };
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === data.investmentId) {
        renderInvestmentContributions(data.investmentId);
        openInvestmentDetail(data.investmentId);
      }
      showToast('Aporte atualizado!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar aporte.', 'error'); return false; }
  };
  const deleteContribution = async (id) => {
    try {
      const contribToDelete = state.investmentContributions.find(c => c.id === id);
      if (!contribToDelete) return;
      await db.collection('investmentContributions').doc(id).delete();
      state.investmentContributions = state.investmentContributions.filter(c => c.id !== id);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === contribToDelete.investmentId) {
        renderInvestmentContributions(contribToDelete.investmentId);
        openInvestmentDetail(contribToDelete.investmentId);
      }
      showToast('Aporte excluído!', 'success');
    } catch (e) { console.error(e); showToast('Erro ao excluir aporte.', 'error'); }
  };

  const openNewInvestmentModal = () => {
    $('#investmentForm').reset();
    setDateInputValue('investmentTargetDate', new Date());
    $('#newInvestmentModalTitle').textContent = 'Novo Investimento';
    $('#saveInvestmentBtn').textContent = 'Salvar Investimento';
    $('#saveInvestmentBtn').dataset.action = 'add';
    $('#saveInvestmentBtn').removeAttribute('data-id');
    updateInvestmentCategorySelects(); 
    closeModal('investmentsModal'); 
    openModal('newInvestmentModal');
  };
  const openEditInvestmentModal = (id) => {
    const inv = state.investments.find(i => i.id === id);
    if (!inv) return;
    state.currentInvestment = inv;
    $('#investmentName').value = inv.name;
    $('#investmentAmount').value = inv.amount || 0;
    $('#investmentGoal').value = inv.goal || '';
    updateInvestmentCategorySelects(); 
    $('#investmentCategorySelect').value = inv.category || '';
    if (inv.targetDate) setDateInputValue('investmentTargetDate', inv.targetDate); else $('#investmentTargetDate').value = '';
    $('#investmentNotes').value = inv.notes || '';
    $('#newInvestmentModalTitle').textContent = 'Editar Investimento';
    $('#saveInvestmentBtn').textContent = 'Atualizar Investimento';
    $('#saveInvestmentBtn').dataset.action = 'update';
    $('#saveInvestmentBtn').dataset.id = id;
    closeModal('investmentDetailModal'); 
    openModal('newInvestmentModal');
  };
  const openNewContributionModal = () => {
    $('#contributionForm').reset();
    setDateInputValue('contributionDate', new Date());
    $('#contributionInvestmentId').value = state.currentInvestment?.id || '';
    $('#newContributionModalTitle').textContent = 'Adicionar Novo Valor';
    $('#saveContributionBtn').textContent = 'Adicionar';
    $('#saveContributionBtn').dataset.action = 'add';
    $('#saveContributionBtn').removeAttribute('data-id');
    openModal('newContributionModal');
  };
  const openEditContributionModal = (id) => {
    const contrib = state.investmentContributions.find(c => c.id === id);
    if (!contrib) return;
    state.currentContribution = contrib;
    $('#contributionInvestmentId').value = contrib.investmentId;
    $('#contributionAmount').value = contrib.amount;
    setDateInputValue('contributionDate', contrib.date);
    $('#contributionDescription').value = contrib.description || '';
    $('#newContributionModalTitle').textContent = 'Editar Aporte';
    $('#saveContributionBtn').textContent = 'Atualizar';
    $('#saveContributionBtn').dataset.action = 'update';
    $('#saveContributionBtn').dataset.id = id;
    openModal('newContributionModal');
  };

  const loadTransactions = async () => {
    try {
      const snapshot = await db.collection('transactions').get();
      state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      await fullUIRefresh(); 
    } catch (error) {
      console.error('Erro ao carregar transações:', error);
      showToast('Erro ao carregar transações.', 'error');
    }
  };

  const getInvoicePeriod = (card, invoiceDueDateRef) => {
    const refDate = parseLocalDateString(invoiceDueDateRef);
    if (!refDate || !card) return { previousClosing: null, currentClosingDate: null };

    let closingDay = card.closingDay;
    let dueDay = card.dueDay;

    let currentClosingYear = refDate.getUTCFullYear();
    let currentClosingMonth = refDate.getUTCMonth(); 

    if (dueDay >= closingDay) {
        currentClosingMonth--;
        if (currentClosingMonth < 0) {
            currentClosingMonth = 11;
            currentClosingYear--;
        }
    }
    const currentClosingDate = new Date(Date.UTC(currentClosingYear, currentClosingMonth, closingDay));
    
    let previousClosingMonth = currentClosingMonth - 1;
    let previousClosingYear = currentClosingYear;
    if (previousClosingMonth < 0) {
        previousClosingMonth = 11;
        previousClosingYear--;
    }
    const previousClosing = new Date(Date.UTC(previousClosingYear, previousClosingMonth, closingDay));
    
    return { previousClosing, currentClosingDate }; 
  };


  const filterTransactionsByMonth = () => {
    state.filteredTransactions = state.transactions.filter(transaction => {
        const transactionLaunchDate = parseLocalDateString(transaction.date); 
        if (!transactionLaunchDate) return false;

        let effectiveDateForFilter = transactionLaunchDate;

        if (transaction.type === 'expense') { 
            if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
                const card = state.cards.find(c => c.id === transaction.creditCardId);
                if (card) {
                    const realDueDate = calcularVencimentoReal(transactionLaunchDate, card);
                    if (realDueDate) effectiveDateForFilter = realDueDate;
                }
            } else if (transaction.dueDate) { 
                const explicitDueDate = parseLocalDateString(transaction.dueDate);
                if (explicitDueDate) effectiveDateForFilter = explicitDueDate;
            }
        }
        
        return effectiveDateForFilter.getUTCMonth() === state.month && 
               effectiveDateForFilter.getUTCFullYear() === state.year;
    });
  };


  const updateMonthYearTitle = () => {
    // O título agora é implícito pelos selects de ano/mês
  };

  const updateKPIs = () => {
    filterTransactionsByMonth(); 
    const currentMonthTransactions = state.filteredTransactions;

    const totalIncome = currentMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const totalExpense = currentMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const incomeReceived = currentMonthTransactions.filter(t => t.type === 'income' && t.status === 'received').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const incomePending = totalIncome - incomeReceived;
    const expensePaid = currentMonthTransactions.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const expensePending = totalExpense - expensePaid;

    const saldoReal = incomeReceived - expensePaid;
    const saldoComprometido = totalIncome - totalExpense;

    $('#incomeValue').textContent = formatCurrency(totalIncome);
    $('#expenseValue').textContent = formatCurrency(totalExpense); 
    $('#balanceValue').textContent = formatCurrency(saldoReal);
    $('.kpi-balance .kpi-subtitle span').textContent = `Saldo comprometido: ${formatCurrency(saldoComprometido)}`;
    $('#incomeReceivedValue').textContent = `${formatCurrency(incomeReceived)} recebidos`;
    $('#incomePendingValue').textContent = `${formatCurrency(incomePending)} pendentes`;
    $('#expensePaidValue').textContent = `${formatCurrency(expensePaid)} pagos`;
    $('#expensePendingValue').textContent = `${formatCurrency(expensePending)} pendentes`;

    let totalCardDueThisMonth = 0; 
    let earliestCardDueDateThisMonth = null; 

    state.transactions.forEach(t => {
        if (t.type === 'expense' && t.paymentMethod === 'credito') {
            const effectiveDueDate = getEffectiveDueDateForSort(t); 
            if (effectiveDueDate &&
                effectiveDueDate.getUTCMonth() === state.month &&
                effectiveDueDate.getUTCFullYear() === state.year) {
                totalCardDueThisMonth += parseFloat(t.amount);
                if (!earliestCardDueDateThisMonth || effectiveDueDate < earliestCardDueDateThisMonth) {
                    earliestCardDueDateThisMonth = effectiveDueDate;
                }
            }
        }
    });
    $('#invoiceValue').textContent = formatCurrency(totalCardDueThisMonth); 
    $('#invoiceDueDate').textContent = earliestCardDueDateThisMonth ? formatDate(earliestCardDueDateThisMonth) : '--/--/----';
  };

  const updateCardsList = () => {
    const listEl = $('#cardsList');
    if (!listEl) return;
    listEl.innerHTML = '';
    if (state.cards.length === 0) {
      listEl.innerHTML = '<p style="text-align: center;">Nenhum cartão cadastrado.</p>';
      return;
    }
    state.cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card'; 
        cardEl.style.marginBottom = 'var(--spacing-4)';
        
        const faturaVencimentoNoMesSelecionado = new Date(Date.UTC(state.year, state.month, card.dueDay));
        const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoNoMesSelecionado);

        let currentInvoiceAmountForMonth = 0;
        if (previousClosing && currentClosingDate) {
            const currentInvoiceTransactions = state.transactions.filter(t => {
                const tLaunchDate = parseLocalDateString(t.date);
                return t.type === 'expense' &&
                       t.paymentMethod === 'credito' &&
                       t.creditCardId === card.id &&
                       tLaunchDate >= previousClosing &&
                       tLaunchDate < currentClosingDate;
            });
            currentInvoiceAmountForMonth = currentInvoiceTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        }

        const limitPercentage = card.limit > 0 ? ((card.limit - card.availableLimit) / card.limit) * 100 : 0;
        const melhorDia = calcularMelhorDiaCompras(card);
        const nomeMesFatura = new Date(state.year, state.month).toLocaleDateString('pt-BR', {month: 'long'});


        cardEl.innerHTML = `
            <div class="card-body">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="card-title">${card.name}</h3>
                    <div>
                        <button class="btn btn-icon btn-sm btn-outline edit-card-btn" data-id="${card.id}" aria-label="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-icon btn-sm btn-outline delete-card-btn" data-id="${card.id}" aria-label="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-2">Limite: ${formatCurrency(card.limit)} | Disponível: ${formatCurrency(card.availableLimit)}</div>
                <div class="mb-2">
                    <div style="height: 8px; background-color: var(--color-surface-variant); border-radius: var(--radius-full); overflow: hidden;">
                        <div style="height: 100%; width: ${limitPercentage.toFixed(0)}%; background-color: ${limitPercentage > 80 ? 'var(--color-error)' : 'var(--color-primary)'}; border-radius: var(--radius-full);"></div>
                    </div>
                </div>
                <div class="mb-2 text-sm">Sua Fatura fecha: dia ${card.closingDay} | Vencimento: dia ${card.dueDay}</div>
                <div class="mb-2 text-sm">Fatura de ${nomeMesFatura}: ${formatCurrency(currentInvoiceAmountForMonth)}</div>
                ${melhorDia ? `<div class="mb-2 text-sm text-info"><i class="fas fa-info-circle"></i> Melhor dia p/ compra: dia ${melhorDia}</div>` : ''}
                <button class="btn btn-primary view-invoice-btn w-full mt-2" data-id="${card.id}">
                    Ver Fatura de ${new Date(state.year, state.month).toLocaleDateString('pt-BR', {month: 'short'})}
                </button>
            </div>
        `;
        listEl.appendChild(cardEl);
    });
    $$('#cardsList .edit-card-btn').forEach(btn => btn.addEventListener('click', e => {
        const cardToEdit = state.cards.find(c => c.id === e.currentTarget.dataset.id);
        if(cardToEdit) openEditCardModal(cardToEdit);
    }));
    $$('#cardsList .delete-card-btn').forEach(btn => btn.addEventListener('click', e => deleteCard(e.currentTarget.dataset.id)));
    $$('#cardsList .view-invoice-btn').forEach(btn => btn.addEventListener('click', e => openCardInvoice(e.currentTarget.dataset.id)));
  };

  const openCardInvoice = (cardId) => {
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;
    state.currentCard = card; 

    const faturaVencimentoNoMesSelecionado = new Date(Date.UTC(state.year, state.month, card.dueDay));

    $('#cardInvoiceTitle').textContent = `Fatura ${card.name} - Venc. ${formatDate(faturaVencimentoNoMesSelecionado)}`;

    let currentInvoiceSum = 0;
    const invoiceTransactions = state.transactions.filter(t => {
        if (t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === cardId) {
            const effectiveDueDate = getEffectiveDueDateForSort(t); 
            return effectiveDueDate &&
                   effectiveDueDate.getUTCMonth() === state.month &&
                   effectiveDueDate.getUTCFullYear() === state.year;
        }
        return false; 
    }).sort((a,b) => parseLocalDateString(a.date) - parseLocalDateString(b.date)); 

    currentInvoiceSum = invoiceTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);

    const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoNoMesSelecionado);
    let endOfPurchasePeriod = null;
    if (currentClosingDate) {
        endOfPurchasePeriod = new Date(currentClosingDate.getTime());
        endOfPurchasePeriod.setUTCDate(currentClosingDate.getUTCDate() - 1);
    }

    $('#cardInvoiceDetails').innerHTML = `
        <div class="card-body">
            <p><strong>Período de Compras (Referência):</strong> ${previousClosing ? formatDate(previousClosing) : 'N/A'} - ${endOfPurchasePeriod ? formatDate(endOfPurchasePeriod) : 'N/A'}</p>
            <p><strong>Vencimento desta Fatura:</strong> ${formatDate(faturaVencimentoNoMesSelecionado)}</p>
            <p><strong>Limite Total:</strong> ${formatCurrency(card.limit)} | <strong>Disponível:</strong> ${formatCurrency(card.availableLimit)}</p>
            <p><strong>Valor desta Fatura:</strong> <span id="currentInvoiceValueDisplay">${formatCurrency(currentInvoiceSum)}</span></p>
        </div>
    `;

    const tableBody = $('#cardInvoiceTableBody');
    tableBody.innerHTML = '';

    if (invoiceTransactions.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhuma despesa nesta fatura.</td></tr>';
    } else {
      invoiceTransactions.forEach(t => {
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${t.name} ${t.isRecurrent && t.installments > 1 ? `(${t.installmentNumber}/${t.installments})` : ''}</td>
          <td>${formatDate(t.date)}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td>
            <div class="form-check">
              <input type="checkbox" class="invoice-paid-checkbox" id="invoice-paid-${t.id}"
                     data-id="${t.id}" ${t.status === 'paid' ? 'checked' : ''}>
              <label class="form-check-label" for="invoice-paid-${t.id}"></label>
            </div>
          </td>`;
      });
      $$('.invoice-paid-checkbox').forEach(cb => cb.addEventListener('change', async (e) => {
          await updateTransactionStatus(e.target.dataset.id, e.target.checked ? 'paid' : 'pending');
          openCardInvoice(cardId);
      }));
    }
    $('#invoiceConfirmAmount').textContent = formatCurrency(currentInvoiceSum);
    closeModal('cardsListModal'); 
    openModal('cardInvoiceModal');
  };

  let categoryExpensesChart, cardUsageDonutChart, annualBarsChart, fixedVsVariableChart, personAnalysisChart;
  
  const createCharts = () => {
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface-variant').trim();
    const gridColor = isDarkTheme ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)';
    
    // Chart 1: Despesas por Categoria (Barras verticais)
    const categoryExpensesOptions = {
      series: [{
        name: 'Valor',
        data: []
      }],
      chart: {
        type: 'bar',
        height: 350,
        toolbar: {
          show: false
        },
        fontFamily: 'var(--font-sans)'
      },
      plotOptions: {
        bar: {
          borderRadius: 8,
          columnWidth: '60%',
          distributed: true,
          dataLabels: {
            position: 'top'
          }
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function (val, opts) {
          const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
          return total > 0 ? Math.round((val / total) * 100) + '%' : '0%';
        },
        offsetY: -20,
        style: {
          fontSize: '12px',
          fontFamily: 'var(--font-sans)',
          colors: [textColor]
        }
      },
      colors: ['#3498db', '#5AC8FA', '#34C759', '#FF9500', '#FF3B30', '#AF52DE', '#FF2D55', '#007AFF', '#30D158', '#5856D6'],
      xaxis: {
        categories: [],
        labels: {
          style: {
            colors: textColor,
            fontSize: '12px',
            fontFamily: 'var(--font-sans)'
          }
        },
        axisBorder: {
          show: false
        },
        axisTicks: {
          show: false
        }
      },
      yaxis: {
        title: {
          text: 'Valor (R$)',
          style: {
            color: textColor,
            fontFamily: 'var(--font-sans)'
          }
        },
        labels: {
          formatter: function (val) {
            return 'R$ ' + val.toFixed(0);
          },
          style: {
            colors: textColor,
            fontFamily: 'var(--font-sans)'
          }
        }
      },
      grid: {
        borderColor: gridColor,
        strokeDashArray: 4
      },
      tooltip: {
        y: {
          formatter: function (val, opts) {
            const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
            return `${formatCurrency(val)} (${total > 0 ? Math.round((val / total) * 100) : 0}%)`;
          }
        },
        theme: isDarkTheme ? 'dark' : 'light'
      }
    };
    
    // Chart 2: Uso do Limite (Cartões) - Donut
    const cardUsageDonutOptions = {
      series: [0, 0],
      chart: {
        type: 'donut',
        height: 350,
        fontFamily: 'var(--font-sans)'
      },
      labels: ['Utilizado', 'Disponível'],
      colors: ['var(--color-error)', 'var(--color-primary)'],
      plotOptions: {
        pie: {
          donut: {
            size: '70%',
            labels: {
              show: false
            }
          }
        }
      },
      dataLabels: {
        enabled: false
      },
      legend: {
        show: false
      },
      responsive: [{
        breakpoint: 480,
        options: {
          chart: {
            height: 300
          }
        }
      }],
      stroke: {
        width: 0
      },
      tooltip: {
        y: {
          formatter: function(val, opts) {
            const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
            return `${formatCurrency(val)} (${total > 0 ? Math.round((val / total) * 100) : 0}%)`;
          }
        },
        theme: isDarkTheme ? 'dark' : 'light'
      }
    };
    
    // Chart 3: Despesas Fixas vs Variáveis - Donut
    const fixedVsVariableOptions = {
      series: [0, 0],
      chart: {
        type: 'donut',
        height: 350,
        fontFamily: 'var(--font-sans)'
      },
      labels: ['Fixas', 'Variáveis'],
      colors: ['var(--color-success)', 'var(--color-card-invoice)'],
      plotOptions: {
        pie: {
          donut: {
            size: '60%',
            labels: {
              show: true,
              name: {
                show: true
              },
              value: {
                show: true,
                formatter: function(val, opts) {
                  const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                  return total > 0 ? Math.round((val / total) * 100) + '%' : '0%';
                }
              },
              total: {
                show: true,
                label: 'Total',
                formatter: function(w) {
                  const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                  return formatCurrency(total);
                }
              }
            }
          }
        }
      },
      dataLabels: {
        enabled: false
      },
      legend: {
        show: false
      },
      responsive: [{
        breakpoint: 480,
        options: {
          chart: {
            height: 300
          }
        }
      }],
      stroke: {
        width: 0
      },
      tooltip: {
        y: {
          formatter: function(val, opts) {
            const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
            return `${formatCurrency(val)} (${total > 0 ? Math.round((val / total) * 100) : 0}%)`;
          }
        },
        theme: isDarkTheme ? 'dark' : 'light'
      }
    };
    
    // Chart 4: Despesas por Pessoa - Barras horizontais
    const personAnalysisOptions = {
      series: [{
        name: 'Valor',
        data: []
      }],
      chart: {
        type: 'bar',
        height: 350,
        toolbar: {
          show: false
        },
        fontFamily: 'var(--font-sans)'
      },
      plotOptions: {
        bar: {
          horizontal: true,
          borderRadius: 8,
          dataLabels: {
            position: 'right'
          }
        }
      },
      colors: ['var(--color-primary)', 'var(--color-success)', 'var(--color-warning)'],
      dataLabels: {
        enabled: true,
        formatter: function (val, opts) {
          const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
          return total > 0 ? Math.round((val / total) * 100) + '%' : '0%';
        },
        offsetX: 10,
        style: {
          fontSize: '12px',
          fontFamily: 'var(--font-sans)',
          colors: [textColor]
        }
      },
      xaxis: {
        categories: [],
        labels: {
          formatter: function (val) {
            return 'R$ ' + val.toFixed(0);
          },
          style: {
            colors: textColor,
            fontSize: '12px',
            fontFamily: 'var(--font-sans)'
          }
        }
      },
      yaxis: {
        labels: {
          style: {
            colors: textColor,
            fontSize: '12px',
            fontFamily: 'var(--font-sans)'
          }
        }
      },
      grid: {
        borderColor: gridColor,
        strokeDashArray: 4
      },
      tooltip: {
        y: {
          formatter: function (val, opts) {
            const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
            return `${formatCurrency(val)} (${total > 0 ? Math.round((val / total) * 100) : 0}%)`;
          }
        },
        theme: isDarkTheme ? 'dark' : 'light'
      }
    };
    
    // Chart 5: Receitas x Despesas (12 meses) - Barras + Linha
    const annualBarsOptions = {
      series: [
        {
          name: 'Receitas',
          type: 'column',
          data: []
        }, 
        {
          name: 'Despesas',
          type: 'column',
          data: []
        }, 
        {
          name: 'Saldo',
          type: 'line',
          data: []
        }
      ],
      chart: {
        height: 350,
        type: 'line',
        stacked: false,
        toolbar: {
          show: false
        },
        fontFamily: 'var(--font-sans)'
      },
      stroke: {
        width: [0, 0, 3]
      },
      plotOptions: {
        bar: {
          borderRadius: 6,
          columnWidth: '60%'
        }
      },
      colors: ['var(--color-income)', 'var(--color-expense)', 'var(--color-primary)'],
      fill: {
        opacity: [0.85, 0.85, 1],
        gradient: {
          inverseColors: false,
          shade: 'light',
          type: "vertical",
          opacityFrom: 0.85,
          opacityTo: 0.55,
          stops: [0, 100, 100, 100]
        }
      },
      labels: [],
      markers: {
        size: 4
      },
      legend: {
        show: false
      },
      xaxis: {
        labels: {
          style: {
            colors: textColor,
            fontFamily: 'var(--font-sans)'
          }
        }
      },
      yaxis: {
        title: {
          text: 'Valor (R$)',
          style: {
            color: textColor,
            fontFamily: 'var(--font-sans)'
          }
        },
        labels: {
          formatter: function (val) {
            return 'R$ ' + val.toFixed(0);
          },
          style: {
            colors: textColor,
            fontFamily: 'var(--font-sans)'
          }
        }
      },
      tooltip: {
        shared: true,
        intersect: false,
        y: {
          formatter: function (y) {
            if (typeof y !== "undefined") {
              return "R$ " + y.toFixed(2);
            }
            return y;
          }
        },
        theme: isDarkTheme ? 'dark' : 'light'
      },
      grid: {
        borderColor: gridColor,
        strokeDashArray: 4
      }
    };
    
    // Inicializa os gráficos
    if ($('#categoryExpensesChart')) categoryExpensesChart = new ApexCharts($('#categoryExpensesChart'), categoryExpensesOptions);
    if ($('#cardUsageDonutChart')) cardUsageDonutChart = new ApexCharts($('#cardUsageDonutChart'), cardUsageDonutOptions);
    if ($('#fixedVsVariableChart')) fixedVsVariableChart = new ApexCharts($('#fixedVsVariableChart'), fixedVsVariableOptions);
    if ($('#personAnalysisChart')) personAnalysisChart = new ApexCharts($('#personAnalysisChart'), personAnalysisOptions);
    if ($('#annualBarsChart')) annualBarsChart = new ApexCharts($('#annualBarsChart'), annualBarsOptions);
    
    // Renderiza os gráficos
    if (categoryExpensesChart) categoryExpensesChart.render();
    if (cardUsageDonutChart) cardUsageDonutChart.render();
    if (fixedVsVariableChart) fixedVsVariableChart.render();
    if (personAnalysisChart) personAnalysisChart.render();
    if (annualBarsChart) annualBarsChart.render();
  };
  
  const updateChartColors = () => {
    // Esta função será chamada quando o tema for alterado
    if (!categoryExpensesChart) return; // Verifica se os gráficos já foram criados
    
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface-variant').trim();
    const gridColor = isDarkTheme ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)';
    
    // Atualização básica das cores dos gráficos com base no tema
    const chartsToUpdate = [categoryExpensesChart, cardUsageDonutChart, fixedVsVariableChart, personAnalysisChart, annualBarsChart];
    
    chartsToUpdate.forEach(chart => {
      if (!chart) return;
      
      // Atualiza cores dos eixos e labels
      if (chart.w.config.xaxis) {
        chart.updateOptions({
          xaxis: {
            labels: {
              style: {
                colors: textColor
              }
            }
          }
        });
      }
      
      if (chart.w.config.yaxis) {
        chart.updateOptions({
          yaxis: {
            title: {
              style: {
                color: textColor
              }
            },
            labels: {
              style: {
                colors: textColor
              }
            }
          }
        });
      }
      
      // Atualiza cores das grades
      chart.updateOptions({
        grid: {
          borderColor: gridColor
        },
        tooltip: {
          theme: isDarkTheme ? 'dark' : 'light'
        }
      });
    });
    
    // Atualizações específicas para cada gráfico
    if (cardUsageDonutChart) {
      cardUsageDonutChart.updateOptions({
        colors: ['var(--color-error)', 'var(--color-primary)']
      });
      
      // Atualiza o texto central com a porcentagem
      if (cardUsageDonutChart.w.globals.series[0] !== undefined) {
        const usado = cardUsageDonutChart.w.globals.series[0];
        const total = cardUsageDonutChart.w.globals.series.reduce((a, b) => a + b, 0);
        const percentual = total > 0 ? Math.round((usado / total) * 100) : 0;
        
        $('.limit-value').textContent = `${percentual}%`;
        
        if (percentual > 80) {
          $('.limit-value').style.color = 'var(--color-error)';
        } else if (percentual > 60) {
          $('.limit-value').style.color = 'var(--color-warning)';
        } else {
          $('.limit-value').style.color = 'var(--color-on-surface)';
        }
      }
    }
    
    if (fixedVsVariableChart) {
      fixedVsVariableChart.updateOptions({
        colors: ['var(--color-success)', 'var(--color-card-invoice)']
      });
    }
    
    if (annualBarsChart) {
      annualBarsChart.updateOptions({
        colors: ['var(--color-income)', 'var(--color-expense)', 'var(--color-primary)']
      });
    }
  };

  const updateCharts = () => {
    if (!categoryExpensesChart) createCharts(); // Garante que os gráficos sejam criados na primeira chamada
    const currentMonthTransactions = state.filteredTransactions;

    // 1. Atualiza o gráfico de despesas por categoria
    const expenseCategories = currentMonthTransactions
      .filter(t => t.type === 'expense')
      .reduce((acc, t) => {
        const catName = state.categories.expense.find(c => c.id === t.category)?.name || t.categoryName || 'Outros';
        const catIcon = state.categories.expense.find(c => c.id === t.category)?.icon || '';
        const displayName = catIcon ? `${catIcon} ${catName}` : catName;
        acc[displayName] = (acc[displayName] || 0) + parseFloat(t.amount);
        return acc;
      }, {});
      
    const sortedCategories = Object.entries(expenseCategories)
      .sort((a, b) => b[1] - a[1])
      .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});

    if (categoryExpensesChart) {
      categoryExpensesChart.updateOptions({
        xaxis: {
          categories: Object.keys(sortedCategories)
        }
      });
      
      categoryExpensesChart.updateSeries([{
        name: 'Valor',
        data: Object.values(sortedCategories)
      }]);
    }

    // 2. Atualiza o gráfico de uso do cartão de crédito
    const totalLimitAllCards = state.cards.reduce((sum, c) => sum + parseFloat(c.limit || 0), 0);
    const totalAvailableAllCards = state.cards.reduce((sum, c) => sum + parseFloat(c.availableLimit || 0), 0);
    const totalUsedAllCards = totalLimitAllCards - totalAvailableAllCards;
    
    if (cardUsageDonutChart) {
      if (totalLimitAllCards > 0) {
        cardUsageDonutChart.updateSeries([totalUsedAllCards, totalAvailableAllCards]);
        
        const percentUsed = totalLimitAllCards > 0 ? Math.round((totalUsedAllCards / totalLimitAllCards) * 100) : 0;
        $('.limit-value').textContent = `${percentUsed}%`;
        
        if (percentUsed > 80) {
          $('.limit-value').style.color = 'var(--color-error)';
        } else if (percentUsed > 60) {
          $('.limit-value').style.color = 'var(--color-warning)';
        } else {
          $('.limit-value').style.color = 'var(--color-on-surface)';
        }
      } else {
        cardUsageDonutChart.updateSeries([1]);
        $('.limit-value').textContent = `0%`;
        $('.limit-value').style.color = 'var(--color-on-surface)';
      }
    }
    
    // 3. Atualiza o gráfico de despesas fixas vs variáveis
    const fixed = currentMonthTransactions
      .filter(t => t.type === 'expense' && t.isFixed === 'fixed')
      .reduce((s, t) => s + parseFloat(t.amount), 0);
      
    const variable = currentMonthTransactions
      .filter(t => t.type === 'expense' && t.isFixed === 'variable')
      .reduce((s, t) => s + parseFloat(t.amount), 0);
    
    if (fixedVsVariableChart) {
      fixedVsVariableChart.updateSeries([fixed, variable]);
    }
    
    // 4. Atualiza o gráfico de despesas por pessoa
    const personExpenses = currentMonthTransactions
      .filter(t => t.type === 'expense' && t.person)
      .reduce((acc, t) => {
        const person = state.people.find(p => p.id === t.person);
        const personName = person ? `${person.icon || ''} ${person.name}` : 'Não atribuído';
        acc[personName] = (acc[personName] || 0) + parseFloat(t.amount);
        return acc;
      }, {});
      
    const sortedPersons = Object.entries(personExpenses)
      .sort((a, b) => b[1] - a[1])
      .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
    
    if (personAnalysisChart) {
      personAnalysisChart.updateOptions({
        yaxis: {
          categories: Object.keys(sortedPersons)
        }
      });
      
      personAnalysisChart.updateSeries([{
        name: 'Valor',
        data: Object.values(sortedPersons)
      }]);
    }
    
    // 5. Atualiza o gráfico anual de receitas x despesas
    const annualData = Array(12).fill(null).map(() => ({ income: 0, expense: 0 }));
    const todayForAnnual = new Date(Date.UTC(state.year, state.month, 1));
    
    state.transactions.forEach(t => {
      const tLaunchDate = parseLocalDateString(t.date);
      if (!tLaunchDate) return;
      
      let effectiveDateForAnnualChart = tLaunchDate;
      
      if (t.type === 'expense') {
        if (t.paymentMethod === 'credito' && t.creditCardId) {
          const card = state.cards.find(c => c.id === t.creditCardId);
          if (card) {
            const realDueDate = calcularVencimentoReal(tLaunchDate, card);
            if (realDueDate) effectiveDateForAnnualChart = realDueDate;
          }
        } else if (t.dueDate) {
          const explicitDueDate = parseLocalDateString(t.dueDate);
          if (explicitDueDate) effectiveDateForAnnualChart = explicitDueDate;
        }
      }
      
      const monthDiff = (todayForAnnual.getUTCFullYear() - effectiveDateForAnnualChart.getUTCFullYear()) * 12 + 
                      (todayForAnnual.getUTCMonth() - effectiveDateForAnnualChart.getUTCMonth());
      
      if (monthDiff >= 0 && monthDiff < 12) {
        const indexInAnnualArray = 11 - monthDiff;
        if (t.type === 'income') annualData[indexInAnnualArray].income += parseFloat(t.amount);
        else if (t.type === 'expense') annualData[indexInAnnualArray].expense += parseFloat(t.amount);
      }
    });
    
    const labels = Array(12).fill(null).map((_, i) => {
      const d = new Date(todayForAnnual);
      d.setUTCMonth(todayForAnnual.getUTCMonth() - (11 - i));
      return d.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit', timeZone: 'UTC' });
    });
    
    const incomeData = annualData.map(d => d.income);
    const expenseData = annualData.map(d => d.expense);
    const balanceData = annualData.map(d => d.income - d.expense);
    
    if (annualBarsChart) {
      annualBarsChart.updateOptions({
        labels: labels
      });
      
      annualBarsChart.updateSeries([
        {
          name: 'Receitas',
          type: 'column',
          data: incomeData
        },
        {
          name: 'Despesas',
          type: 'column',
          data: expenseData
        },
        {
          name: 'Saldo',
          type: 'line',
          data: balanceData
        }
      ]);
    }
    
    updateChartColors();
  };

  const toggleCommitments = () => {
    const content = $('#commitmentsContent');
    const icon = $('#commitmentToggleIcon');
    if (!content || !icon) return;
    
    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
      content.style.maxHeight = '0px';
      icon.className = 'fas fa-chevron-down';
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      icon.className = 'fas fa-chevron-up';
    }
  };

  const generateInsights = () => {
    const container = $('#insightsBannerContainer');
    if (!container) return;
    container.innerHTML = '';
    state.insights = [];
    const today = new Date(); today.setUTCHours(0,0,0,0); 

    const overdue = state.transactions.filter(t => {
        if (t.type !== 'expense' || t.status === 'paid') return false;
        
        let effectiveDueDate = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c => c.id === t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if (card && launchDate) effectiveDueDate = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDate = parseLocalDateString(t.dueDate);
        }
        
        if (!effectiveDueDate) return false;
        
        return effectiveDueDate < today;
    });

    if (overdue.length > 0) {
      state.insights.push({ 
        id: 'overdue', 
        level: 'danger', 
        icon: 'exclamation-triangle', 
        message: `Você tem ${overdue.length} conta(s) vencida(s).`, 
        actionText: 'Ver Detalhes', 
        action: () => openDueTransactionsModal(overdue, 'Contas Vencidas', 'danger') 
      });
    }

    const upcomingDateLimit = new Date(today); upcomingDateLimit.setUTCDate(today.getUTCDate() + 5);
    const upcoming = state.transactions.filter(t => {
        if (t.type !== 'expense' || t.status === 'paid') return false;
        
        let effectiveDueDate = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c => c.id === transaction.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if (card && launchDate) effectiveDueDate = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDate = parseLocalDateString(t.dueDate);
        }
        if (!effectiveDueDate) return false;

        return effectiveDueDate >= today && effectiveDueDate <= upcomingDateLimit;
    });
    
    if (upcoming.length > 0) {
      state.insights.push({ 
        id: 'upcoming', 
        level: 'warning', 
        icon: 'calendar-alt', 
        message: `Você tem ${upcoming.length} conta(s) a vencer nos próximos 5 dias.`, 
        actionText: 'Ver Detalhes', 
        action: () => openDueTransactionsModal(upcoming, 'Contas a Vencer', 'warning') 
      }); 
    }
    
    state.cards.filter(c => c.availableLimit < (c.limit * 0.2)).forEach(c => {
        state.insights.push({ 
          id: `low-limit-${c.id}`, 
          level: 'info', 
          icon: 'credit-card', 
          message: `Limite baixo no cartão ${c.name}.`, 
          actionText: 'Ver Cartão', 
          action: () => { 
            closeModal('insightsBannerContainer'); 
            openModal('cardsListModal'); 
            openCardInvoice(c.id); 
          } 
        });
    });

    state.insights.forEach(insight => {
      const el = document.createElement('div');
      el.className = `insight-banner insight-${insight.level}`;
      el.innerHTML = `
        <div class="insight-icon">
          <i class="fas fa-${insight.icon}"></i>
        </div>
        <div class="insight-content">
          <div class="insight-title">${insight.message}</div>
        </div>
        <button class="btn btn-outline insight-action" data-id="${insight.id}">${insight.actionText}</button>`;
      container.appendChild(el);
    });
    
    $$('.insight-action').forEach(btn => btn.addEventListener('click', e => {
      const insight = state.insights.find(i => i.id === e.currentTarget.dataset.id);
      if (insight && insight.action) insight.action();
    }));
  };
  
  const openDueTransactionsModal = (transactions, title, type) => {
    $('#dueTransactionsModalTitleText').textContent = title;
    const iconEl = $('#dueTransactionsModalIcon');
    iconEl.className = type === 'danger' ? 'fas fa-exclamation-triangle' : 'fas fa-calendar-alt';
    
    const tableBody = $('#dueTransactionsTableBody');
    tableBody.innerHTML = '';
    if (transactions.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma conta encontrada.</td></tr>`;
    } else {
      transactions.sort((a,b) => {
        let dueDateA_effective = null;
        if (a.paymentMethod === 'credito' && a.creditCardId) {
            const cardA = state.cards.find(c=>c.id===a.creditCardId);
            if(cardA) dueDateA_effective = calcularVencimentoReal(parseLocalDateString(a.date), cardA);
        } else if (a.dueDate) {
            dueDateA_effective = parseLocalDateString(a.dueDate);
        }

        let dueDateB_effective = null;
        if (b.paymentMethod === 'credito' && b.creditCardId) {
            const cardB = state.cards.find(c=>c.id===b.creditCardId);
            if(cardB) dueDateB_effective = calcularVencimentoReal(parseLocalDateString(b.date), cardB);
        } else if (b.dueDate) {
            dueDateB_effective = parseLocalDateString(b.dueDate);
        }
        
        if (!dueDateA_effective && !dueDateB_effective) return 0;
        if (!dueDateA_effective) return 1;
        if (!dueDateB_effective) return -1;
        return dueDateA_effective - dueDateB_effective;

      }).forEach(t => {
        const cat = state.categories.expense.find(c => c.id === t.category);
        let effectiveDueDateForDisplay = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c=>c.id===t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if(card && launchDate) effectiveDueDateForDisplay = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDateForDisplay = parseLocalDateString(t.dueDate);
        }

        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${t.name}</td>
          <td>${cat ? `${cat.icon} ${cat.name}` : (t.categoryName || t.category)}</td>
          <td>${effectiveDueDateForDisplay ? formatDate(effectiveDueDateForDisplay) : formatDate(t.date)}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td class="transaction-actions">
            <button class="btn btn-success btn-sm mark-paid-due-btn" data-id="${t.id}">
              <i class="fas fa-check"></i> Pagar
            </button>
            <button class="btn btn-outline btn-sm edit-due-btn" data-id="${t.id}">
              <i class="fas fa-edit"></i> Editar
            </button>
          </td>`;
      });
      $$('.mark-paid-due-btn').forEach(btn => btn.addEventListener('click', async e => {
          await updateTransactionStatus(e.target.dataset.id, 'paid');
          const remaining = transactions.filter(tr => tr.id !== e.target.dataset.id && tr.status !== 'paid'); 
          if (remaining.length > 0) openDueTransactionsModal(remaining, title, type);
          else closeModal('dueTransactionsModal');
          generateInsights(); 
      }));
      $$('.edit-due-btn').forEach(btn => btn.addEventListener('click', e => {
          const transaction = state.transactions.find(t => t.id === e.target.dataset.id);
          if (transaction) {
              closeModal('dueTransactionsModal');
              openEditModal(transaction);
          }
      }));
    }
    $('#payAllDueBtn').style.display = type === 'danger' && transactions.length > 0 ? 'inline-flex' : 'none';
    openModal('dueTransactionsModal');
  };


  const renderCommitments = () => {
    const content = $('#commitmentsContent');
    if (!content) return;
    content.innerHTML = '';
    const recurrent = state.transactions.filter(t => t.isRecurrent && t.installments && t.installmentNumber && t.installments > t.installmentNumber);
    if (recurrent.length === 0) {
      content.innerHTML = '<p style="text-align: center; padding: var(--spacing-4);">Nenhum compromisso longo.</p>';
      return;
    }
    const grouped = recurrent.reduce((acc, t) => {
        const key = t.recurrenceId || t.id; 
        if (!acc[key] || acc[key].installmentNumber > t.installmentNumber) { 
            acc[key] = t;
        }
        return acc;
    }, {});

    const commitmentList = document.createElement('div');
    commitmentList.className = 'commitment-list';
    
    Object.values(grouped).sort((a,b) => (a.installmentNumber/a.installments) - (b.installmentNumber/b.installments)).forEach(c => {
      const progress = (c.installmentNumber / c.installments) * 100;
      const cat = c.type === 'income' ? state.categories.income.find(cat=>cat.id===c.category) : state.categories.expense.find(cat=>cat.id===c.category);
      
      const item = document.createElement('div');
      item.className = 'commitment-item';
      item.innerHTML = `
        <div class="commitment-icon" style="background-color: ${c.type==='income'?'var(--color-income)':'var(--color-expense)'}; color: var(--color-on-primary);">
          <i class="fas fa-${cat?.icon.startsWith('fa-') ? cat.icon.substring(3) : 'money-bill'}"></i>
        </div>
        <div class="commitment-content">
          <div class="commitment-info">
            <span class="commitment-name">${c.name}</span>
            <span class="commitment-amount">${formatCurrency(c.amount)}</span>
          </div>
          <div class="commitment-details">
            <span>${cat?.name || c.categoryName || c.category}</span>
            <span>${c.installmentNumber}/${c.installments}</span>
          </div>
          <div class="commitment-progress">
            <div class="commitment-progress-bar" style="width:${progress}%; background-color:${c.type==='income'?'var(--color-income)':'var(--color-expense)'};"></div>
          </div>
        </div>`;
      commitmentList.appendChild(item);
    });
    
    content.appendChild(commitmentList);
    
    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
        content.style.maxHeight = content.scrollHeight + 'px';
    }
  };

  const createTransactionFilters = () => {
    const container = $('#transaction-filters');
    if (!container) return;
    container.innerHTML = ''; 

    const typeSelect = document.createElement('div');
    typeSelect.className = 'select-wrapper';
    typeSelect.innerHTML = `
      <select id="filter-transaction-type" class="filter-select">
        <option value="">Todos os Tipos</option>
        <option value="income">Receitas</option>
        <option value="expense">Despesas</option>
      </select>`;
    container.appendChild(typeSelect);
    $('#filter-transaction-type').addEventListener('change', e => { state.filters.transactionType = e.target.value; updateTransactionsTable(); });
    
    const commonFilters = [
        { id: 'filter-category', label: 'Todas as categorias', options: [...state.categories.income, ...state.categories.expense].map(c => ({value: c.id, text: `${c.icon||''} ${c.name}`})) },
        { id: 'filter-status', label: 'Todos os status', options: [{value:'paid',text:'Pago'},{value:'pending',text:'Pendente'},{value:'scheduled',text:'Agendado'},{value:'received',text:'Recebido'}] },
        { id: 'filter-payment-method', label: 'Todos os pagamentos', options: state.paymentMethods.map(p => ({value: p.id, text: `${p.icon||''} ${p.name}`})) },
        { id: 'filter-person', label: 'Todas as pessoas', options: state.people.map(p => ({value: p.id, text: `${p.icon||''} ${p.name}`})) },
    ];
    
    commonFilters.forEach(f => {
        const selWrap = document.createElement('div');
        selWrap.className = 'select-wrapper';
        let optionsHTML = `<option value="">${f.label}</option>`;
        f.options.forEach(opt => optionsHTML += `<option value="${opt.value}">${opt.text}</option>`);
        selWrap.innerHTML = `<select id="${f.id}" class="filter-select">${optionsHTML}</select>`;
        container.appendChild(selWrap);
        $(`#${f.id}`).addEventListener('change', e => { state.filters[f.id.split('-')[1]] = e.target.value; updateTransactionsTable(); });
    });
  };

  const setupSortableColumns = () => {
    $$('#transactionsTable th.sortable').forEach(header => {
      header.addEventListener('click', () => {
        const column = header.dataset.sort;
        if (state.sortColumn === column) {
          state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortColumn = column;
          if (column === 'date' || column === 'dueDate') {
            state.sortDirection = 'asc'; 
          } else if (column === 'amount') {
            state.sortDirection = 'desc'; 
          } else {
            state.sortDirection = 'asc'; 
          }
        }
        $$('#transactionsTable th.sortable').forEach(h => {
          h.classList.remove('sorted-asc', 'sorted-desc');
          if (h.dataset.sort === state.sortColumn) {
            h.classList.add(`sorted-${state.sortDirection}`);
          }
        });
        updateTransactionsTable();
      });
    });
  };

  const getEffectiveDueDateForSort = (transaction) => {
    let effectiveDate = parseLocalDateString(transaction.date); 

    if (transaction.type === 'expense') {
        if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
            const card = state.cards.find(c => c.id === transaction.creditCardId);
            if (card) {
                const realCardDueDate = calcularVencimentoReal(parseLocalDateString(transaction.date), card);
                if (realCardDueDate) effectiveDate = realCardDueDate;
            }
        } else if (transaction.dueDate) {
            const explicitDueDate = parseLocalDateString(transaction.dueDate);
            if (explicitDueDate) effectiveDate = explicitDueDate;
        }
    }
    return effectiveDate;
  };


  const updateTransactionsTable = () => {
    const tableBody = $('#transactionsTableBody');
    if (!tableBody) return;
    if (!$('#filter-transaction-type')) createTransactionFilters(); 
    const sortableHeaders = $$('#transactionsTable th.sortable');
    if (sortableHeaders.length > 0 && !sortableHeaders[0].classList.contains('has-listener')) { 
        setupSortableColumns();
        sortableHeaders.forEach(h => h.classList.add('has-listener'));
    }

    let transactionsToDisplay = [...state.filteredTransactions]; 
    if (state.filters.transactionType) transactionsToDisplay = transactionsToDisplay.filter(t => t.type === state.filters.transactionType);
    if (state.filters.category) transactionsToDisplay = transactionsToDisplay.filter(t => t.category === state.filters.category);
    if (state.filters.status) transactionsToDisplay = transactionsToDisplay.filter(t => t.status === state.filters.status);
    if (state.filters.paymentMethod) transactionsToDisplay = transactionsToDisplay.filter(t => t.paymentMethod === state.filters.paymentMethod);
    if (state.filters.person) transactionsToDisplay = transactionsToDisplay.filter(t => t.person === state.filters.person);

    transactionsToDisplay.sort((a, b) => {
      let valA, valB;
      
      switch(state.sortColumn) {
        case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
        case 'person': 
            valA = (state.people.find(p=>p.id===a.person)?.name || '').toLowerCase(); 
            valB = (state.people.find(p=>p.id===b.person)?.name || '').toLowerCase(); 
            break;
        case 'date': 
            valA = parseLocalDateString(a.date); 
            valB = parseLocalDateString(b.date); 
            break; 
        case 'dueDate': 
            valA = getEffectiveDueDateForSort(a);
            valB = getEffectiveDueDateForSort(b);
            if (valA === null && valB !== null) return state.sortDirection === 'asc' ? 1 : -1; 
            if (valA !== null && valB === null) return state.sortDirection === 'asc' ? -1 : 1; 
            if (valA === null && valB === null) return 0;
            break;
        case 'amount': valA = parseFloat(a.amount); valB = parseFloat(b.amount); break;
        case 'status': valA = a.status; valB = b.status; break;
        case 'paymentMethod': 
            valA = (state.paymentMethods.find(p=>p.id===a.paymentMethod)?.name || '').toLowerCase(); 
            valB = (state.paymentMethods.find(p=>p.id===b.paymentMethod)?.name || '').toLowerCase(); 
            break;
        default: 
            valA = getEffectiveDueDateForSort(a); 
            valB = getEffectiveDueDateForSort(b);
      }
      const comparison = valA < valB ? -1 : (valA > valB ? 1 : 0);
      return state.sortDirection === 'desc' ? -comparison : comparison;
    });

    tableBody.innerHTML = '';
    if (transactionsToDisplay.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: var(--spacing-4);">Nenhuma transação para este mês/filtros.</td></tr>`;
      return;
    }
    
    transactionsToDisplay.forEach(t => {
      const row = tableBody.insertRow();
      const cat = t.type === 'income' ? state.categories.income.find(c=>c.id===t.category) : state.categories.expense.find(c=>c.id===t.category);
      const person = state.people.find(p=>p.id===t.person);
      const payment = state.paymentMethods.find(p=>p.id===t.paymentMethod);
      
      let statusText = t.status;
      let statusClass = 'badge-info';
      if (t.type === 'income') {
          if (t.status === 'received') { statusText = 'Recebido'; statusClass = 'badge-success'; }
          else { statusText = 'A Receber'; statusClass = 'badge-warning'; }
      } else { 
          if (t.status === 'paid') { statusText = 'Pago'; statusClass = 'badge-success'; }
          else if (t.status === 'scheduled') { statusText = 'Agendado'; statusClass = 'badge-info'; }
          else { statusText = 'Pendente'; statusClass = 'badge-warning'; }
      }
      
      const effectiveDueDateForDisplay = getEffectiveDueDateForSort(t);
      
      row.innerHTML = `
        <td>
          <div class="transaction-name-cell">
            <div class="transaction-icon" style="background-color: ${t.type==='income'?'var(--color-income)':'var(--color-expense)'}20; color: ${t.type==='income'?'var(--color-income)':'var(--color-expense)'};">
              <i class="fas fa-${cat?.icon?.startsWith('fa-') ? cat.icon.substring(3) : (t.type === 'income' ? 'money-bill' : 'shopping-bag')}"></i>
            </div>
            ${t.name} ${t.isRecurrent && t.installments > 1 ? `(${t.installmentNumber}/${t.installments})` : ''}
          </div>
        </td>
        <td>${person ? `${person.icon||''} ${person.name}` : '-'}</td>
        <td>${formatDate(t.date)}</td> 
        <td>${effectiveDueDateForDisplay ? formatDate(effectiveDueDateForDisplay) : '-'}</td> 
        <td>${formatCurrency(t.amount)}</td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td>${payment ? `${payment.icon||''} ${payment.name}` : (t.paymentMethodName || t.paymentMethod || '-')}</td>
        <td>
          <div class="form-check">
            <input type="checkbox" class="transaction-paid-checkbox" id="paid-${t.id}" 
                   data-id="${t.id}" data-type="${t.type}" 
                   ${t.status === (t.type === 'income' ? 'received' : 'paid') ? 'checked' : ''}>
            <label class="form-check-label" for="paid-${t.id}"></label>
          </div>
        </td>
        <td class="transaction-actions">
          <button class="btn btn-icon btn-sm btn-outline edit-transaction-btn" data-id="${t.id}" aria-label="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-icon btn-sm btn-outline delete-transaction-btn" data-id="${t.id}" aria-label="Excluir">
            <i class="fas fa-trash"></i>
          </button>
        </td>`;
    });
    
    $$('.transaction-paid-checkbox').forEach(cb => cb.addEventListener('change', e => updateTransactionStatus(e.target.dataset.id, e.target.checked ? (e.target.dataset.type === 'income' ? 'received' : 'paid') : 'pending')));
    $$('.edit-transaction-btn').forEach(btn => btn.addEventListener('click', e => openEditModal(state.transactions.find(t => t.id === e.currentTarget.dataset.id))));
    $$('.delete-transaction-btn').forEach(btn => btn.addEventListener('click', e => openDeleteConfirmModal(state.transactions.find(t => t.id === e.currentTarget.dataset.id))));
  };

  const updateTransactionStatus = async (id, status) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return;
      
      const oldStatus = transaction.status;
      transaction.status = status; 
      
      await db.collection('transactions').doc(id).update({ status });

      if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        if (card) {
            let amountChange = 0;
            if (status === 'paid' && oldStatus !== 'paid') { 
                amountChange = -parseFloat(transaction.amount);
            } else if (status !== 'paid' && oldStatus === 'paid') { 
                amountChange = parseFloat(transaction.amount);
            }

            if (amountChange !== 0) {
                card.currentInvoice = Math.max(0, (card.currentInvoice || 0) + amountChange);
                card.availableLimit = card.limit - card.currentInvoice;
                await db.collection('cards').doc(card.id).update({
                    currentInvoice: card.currentInvoice,
                    availableLimit: card.availableLimit
                });
            }
        }
      }
      await fullUIRefresh(); 
      showToast('Status da transação atualizado!', 'success');
    } catch (error) {
      console.error('Erro ao atualizar status:', error);
      showToast('Erro ao atualizar status.', 'error');
    }
  };

  const addTransaction = async (transactionData) => {
    try {
      const transaction = { ...transactionData, createdAt: localDateToISOString(new Date()) };
      const catList = transaction.type === 'income' ? state.categories.income : state.categories.expense;
      const category = catList.find(c => c.id === transaction.category);
      if (category) { transaction.categoryName = category.name; transaction.categoryIcon = category.icon; }
      
      const payment = state.paymentMethods.find(p => p.id === transaction.paymentMethod);
      if (payment) { transaction.paymentMethodName = payment.name; transaction.paymentMethodIcon = payment.icon; }

      if (transaction.person) {
          const personObj = state.people.find(p => p.id === transaction.person);
          if (personObj) { transaction.personName = personObj.name; transaction.personIcon = personObj.icon; }
      }

      if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId && !transaction.isRecurrent) {
        await updateCardLimits(transaction.creditCardId, parseFloat(transaction.amount), 'add');
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        if (card) transaction.creditCardName = card.name;
      }

      const docRef = await db.collection('transactions').add(transaction);
      transaction.id = docRef.id;
      state.transactions.push(transaction);
      await fullUIRefresh(); 
      showToast(`${transaction.type === 'income' ? 'Receita' : 'Despesa'} adicionada!`, 'success');
      return transaction;
    } catch (e) { console.error(e); showToast('Erro ao adicionar transação.', 'error'); return null; }
  };

  const addRecurrentTransactions = async (baseTransaction, installments) => {
    try {
      const recurrenceId = generateId();
      const batch = db.batch();
      const transactionsToAdd = [];
      const installmentAmount = parseFloat(baseTransaction.amount) / installments; 
      const totalPurchaseAmount = parseFloat(baseTransaction.amount);


      for (let i = 0; i < installments; i++) {
        const currentInstallmentLaunchDate = parseLocalDateString(baseTransaction.date);
        currentInstallmentLaunchDate.setUTCMonth(currentInstallmentLaunchDate.getUTCMonth() + i);
        
        let currentEffectiveDueDate = null;
        if (baseTransaction.paymentMethod === 'credito' && baseTransaction.creditCardId) {
            const card = state.cards.find(c => c.id === baseTransaction.creditCardId);
            if (card) {
                currentEffectiveDueDate = calcularVencimentoReal(currentInstallmentLaunchDate, card);
            }
        } else if (baseTransaction.dueDate) { 
            currentEffectiveDueDate = parseLocalDateString(baseTransaction.dueDate);
            currentEffectiveDueDate.setUTCMonth(currentEffectiveDueDate.getUTCMonth() + i);
        }


        const installment = { 
          ...baseTransaction, 
          amount: installmentAmount, 
          date: localDateToISOString(currentInstallmentLaunchDate), 
          dueDate: currentEffectiveDueDate ? localDateToISOString(currentEffectiveDueDate) : null, 
          recurrenceId, 
          installmentNumber: i + 1, 
          installments,
          isRecurrent: true 
        };
        delete installment.id; 

        const docRef = db.collection('transactions').doc(); 
        batch.set(docRef, installment);
        installment.id = docRef.id; 
        transactionsToAdd.push(installment);
      }
      
      if (baseTransaction.type === 'expense' && baseTransaction.paymentMethod === 'credito' && baseTransaction.creditCardId) {
          await updateCardLimits(baseTransaction.creditCardId, totalPurchaseAmount, 'add'); 
      }

      await batch.commit();
      state.transactions.push(...transactionsToAdd);
      await fullUIRefresh(); 
      showToast('Transação parcelada adicionada!', 'success');
      return transactionsToAdd;
    } catch (e) { console.error(e); showToast('Erro ao adicionar parcelas.', 'error'); return null; }
  };

  const updateTransaction = async (id, updates) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return;

      const oldAmount = parseFloat(transaction.amount);
      const oldPaymentMethod = transaction.paymentMethod;
      const oldCardId = transaction.creditCardId;
      const oldIsRecurrent = transaction.isRecurrent;

      if (updates.category) {
        const catList = updates.type === 'income' ? state.categories.income : state.categories.expense;
        const cat = catList.find(c => c.id === updates.category);
        if (cat) { updates.categoryName = cat.name; updates.categoryIcon = cat.icon; }
      }
      if (updates.paymentMethod) {
        const pay = state.paymentMethods.find(p => p.id === updates.paymentMethod);
        if (pay) { updates.paymentMethodName = pay.name; updates.paymentMethodIcon = pay.icon; }
      }
      if (updates.person) {
        const pers = state.people.find(p => p.id === updates.person);
        if (pers) { updates.personName = pers.name; updates.personIcon = pers.icon; }
      }
      if (updates.creditCardId) {
        const cardUpd = state.cards.find(c => c.id === updates.creditCardId);
        if (cardUpd) updates.creditCardName = cardUpd.name;
      }


      const newAmount = updates.amount !== undefined ? parseFloat(updates.amount) : oldAmount;
      const newPaymentMethod = updates.paymentMethod || oldPaymentMethod;
      const newCardId = updates.creditCardId || oldCardId;

      if (!oldIsRecurrent) { 
        if (oldPaymentMethod === 'credito' && newPaymentMethod === 'credito') { 
          if (oldCardId === newCardId) { 
            if (newAmount !== oldAmount) {
              await updateCardLimits(oldCardId, newAmount, 'update', oldAmount);
            }
          } else { 
            if (oldCardId) await updateCardLimits(oldCardId, oldAmount, 'subtract');
            if (newCardId) await updateCardLimits(newCardId, newAmount, 'add');
          }
        }
        else if (oldPaymentMethod !== 'credito' && newPaymentMethod === 'credito') { 
          if (newCardId) await updateCardLimits(newCardId, newAmount, 'add');
        }
        else if (oldPaymentMethod === 'credito' && newPaymentMethod !== 'credito') { 
          if (oldCardId) await updateCardLimits(oldCardId, oldAmount, 'subtract');
          updates.creditCardId = null; updates.creditCardName = null; 
        }
      }
      
      if (updates.date && updates.date instanceof Date) updates.date = localDateToISOString(updates.date);
      if (updates.dueDate && updates.dueDate instanceof Date) updates.dueDate = localDateToISOString(updates.dueDate);
      if (updates.scheduledDate && updates.scheduledDate instanceof Date) updates.scheduledDate = localDateToISOString(updates.scheduledDate);


      await db.collection('transactions').doc(id).update(updates);
      Object.assign(transaction, updates); 
      await fullUIRefresh(); 
      showToast('Transação atualizada!', 'success');
      return transaction;
    } catch (e) { console.error(e); showToast('Erro ao atualizar transação.', 'error'); return null; }
  };

  const deleteTransaction = async (id, options = {}) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return;

      const isRecurrentSeries = transaction.isRecurrent && transaction.recurrenceId;
      
      if (isRecurrentSeries && options.deleteOption === 'future') {
        const futureParcels = state.transactions.filter(t => t.recurrenceId === transaction.recurrenceId && t.installmentNumber >= transaction.installmentNumber);
        const batch = db.batch();
        
        if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
            const firstParcelInSeries = state.transactions.find(t_series => 
                t_series.recurrenceId === transaction.recurrenceId && t_series.installmentNumber === 1
            );
            if (firstParcelInSeries) { 
                const totalPurchaseAmount = parseFloat(firstParcelInSeries.amount) * firstParcelInSeries.installments;
                await updateCardLimits(transaction.creditCardId, totalPurchaseAmount, 'subtract');
            }
        }

        futureParcels.forEach(parcel => {
          batch.delete(db.collection('transactions').doc(parcel.id));
        });
        await batch.commit();
        state.transactions = state.transactions.filter(t => !(t.recurrenceId === transaction.recurrenceId && t.installmentNumber >= transaction.installmentNumber));
      } else { 
        if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
            if (transaction.isRecurrent && transaction.recurrenceId) {
                await updateCardLimits(transaction.creditCardId, parseFloat(transaction.amount), 'subtract');
            } else { 
                 await updateCardLimits(transaction.creditCardId, parseFloat(transaction.amount), 'subtract');
            }
        }
        await db.collection('transactions').doc(id).delete();
        state.transactions = state.transactions.filter(t => t.id !== id);
      }
      await fullUIRefresh(); 
      showToast('Transação excluída!', 'success');
      return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir transação.', 'error'); return false; }
  };

  const openEditModal = (transaction) => {
    if (!transaction) return;
    state.currentTransaction = transaction;
    $('#editTransactionId').value = transaction.id;
    $('#editTransactionType').value = transaction.type;
    $('#editName').value = transaction.name;
    $('#editAmount').value = transaction.amount;

    const categorySelect = $('#editCategory');
    categorySelect.dataset.type = transaction.type; 
    updateCategorySelects(); 
    categorySelect.value = transaction.category;

    $('#editPerson').value = transaction.person || '';
    
    const expenseTypeGroup = $('#editExpenseTypeGroup');
    if (transaction.type === 'expense') {
        expenseTypeGroup.style.display = 'block';
        if (transaction.isFixed === 'fixed') $('#editExpenseTypeFixed').checked = true;
        else $('#editExpenseTypeVariable').checked = true;
    } else {
        expenseTypeGroup.style.display = 'none';
    }

    setDateInputValue('editDate', transaction.date); 
    
    const dueDateGroup = $('#editDueDateGroup');
    const dueDateInput = $('#editDueDate');

    let effectiveDueDateForEdit = transaction.dueDate ? parseLocalDateString(transaction.dueDate) : null; 
    if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        const launchDate = parseLocalDateString(transaction.date);
        if (card && launchDate) {
            const realCardDueDate = calcularVencimentoReal(launchDate, card);
            if (realCardDueDate) effectiveDueDateForEdit = realCardDueDate;
        }
    }
    
    if (effectiveDueDateForEdit) {
        dueDateGroup.style.display = 'block';
        setDateInputValue('editDueDate', effectiveDueDateForEdit);
    } else { 
        dueDateGroup.style.display = 'block'; 
        setDateInputValue('editDueDate', transaction.date); 
    }
    dueDateInput.disabled = (transaction.type === 'expense' && transaction.paymentMethod === 'credito');


    $('#editPaymentMethod').value = transaction.paymentMethod;
    handleEditCreditCardVisibility(); 
    if (transaction.paymentMethod === 'credito') {
        $('#editCreditCard').value = transaction.creditCardId || '';
        handleEditDueDateForCard(); 
    }
    
    $('#editIsRecurrent').checked = transaction.isRecurrent || false;
    const isParcelOfSeries = !!transaction.recurrenceId;
    $('#editIsRecurrent').disabled = isParcelOfSeries;
    $('#editInstallments').disabled = !transaction.isRecurrent || isParcelOfSeries; 
    
    handleEditRecurrenceGroupVisibility();
    if (transaction.isRecurrent) {
      $('#editInstallments').value = transaction.installments || 2;
    }

    const statusGroup = $('#editStatusGroup');
    statusGroup.innerHTML = ''; 
    if (transaction.type === 'income') {
      statusGroup.innerHTML = `
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusReceived" name="editStatus" value="received"><label class="radio-label" for="editStatusReceived">Recebido</label></div>
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPendingIncome" name="editStatus" value="pending"><label class="radio-label" for="editStatusPendingIncome">A Receber</label></div>`;
      if (transaction.status === 'received') $('#editStatusReceived').checked = true; else $('#editStatusPendingIncome').checked = true;
    } else { 
      statusGroup.innerHTML = `
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPaid" name="editStatus" value="paid"><label class="radio-label" for="editStatusPaid">Pago</label></div>
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPendingExpense" name="editStatus" value="pending"><label class="radio-label" for="editStatusPendingExpense">Pendente</label></div>
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusScheduled" name="editStatus" value="scheduled"><label class="radio-label" for="editStatusScheduled">Agendado</label></div>`;
      if (transaction.status === 'paid') $('#editStatusPaid').checked = true;
      else if (transaction.status === 'scheduled') $('#editStatusScheduled').checked = true;
      else $('#editStatusPendingExpense').checked = true;
    }
    handleEditStatusFieldVisibility(); 
    handleEditScheduledDateVisibility();

    if (transaction.status === 'scheduled' && transaction.scheduledDate) {
      setDateInputValue('editScheduledDate', transaction.scheduledDate);
    }

    $('#editNotes').value = transaction.notes || '';
    $('#editModalTitle').textContent = transaction.type === 'income' ? 'Editar Receita' : 'Editar Despesa';
    openModal('editModal');
  };

  const openDeleteConfirmModal = (transaction) => {
    if (!transaction) return;
    state.currentTransaction = transaction;
    const reccOptions = $('#recurrenceDeleteOptions');
    const isPartOfRecurrentSeries = transaction.isRecurrent && transaction.recurrenceId && transaction.installments > 1;
    reccOptions.style.display = isPartOfRecurrentSeries ? 'block' : 'none';
    if (isPartOfRecurrentSeries) $('#deleteSingle').checked = true;
    openModal('deleteConfirmModal');
  };

  const openEditCardModal = (card) => {
    if (!card) return;
    state.currentCard = card;
    $('#cardName').value = card.name;
    $('#cardLimit').value = card.limit;
    $('#cardClosingDay').value = card.closingDay;
    $('#cardDueDay').value = card.dueDay;
    $('.modal-title', $('#newCardModal')).textContent = 'Editar Cartão';
    $('#saveCardBtn').textContent = 'Salvar Alterações';
    $('#saveCardBtn').dataset.id = card.id;
    closeModal('cardsListModal');
    openModal('newCardModal');
  };

  const renderGenericList = (containerId, items, type, editFn, deleteFn, nameField = 'name', iconField = 'icon') => {
    const listEl = $(`#${containerId}`);
    if (!listEl) return;
    listEl.innerHTML = '';
    items.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'category-item';
      itemEl.dataset.id = item.id;
      itemEl.dataset.type = type;
      itemEl.innerHTML = `
        <div class="category-item-content">
          <div class="category-item-icon">${item[iconField] || '●'}</div>
          <div>${item[nameField]}</div>
        </div>
        <div class="category-item-actions">
          <button class="btn btn-icon btn-sm btn-outline edit-item-btn" aria-label="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-icon btn-sm btn-outline delete-item-btn" aria-label="Excluir">
            <i class="fas fa-trash"></i>
          </button>
        </div>`;
      listEl.appendChild(itemEl);
      itemEl.querySelector('.edit-item-btn').addEventListener('click', () => editFn(item, type));
      itemEl.querySelector('.delete-item-btn').addEventListener('click', () => deleteFn(item.id, type));
    });
  };
  const renderCategoriesList = () => renderGenericList('incomeCategoriesList', state.categories.income, 'income', openEditCategoryModal, deleteCategory);
  const renderExpenseCategoriesList = () => renderGenericList('expenseCategoriesList', state.categories.expense, 'expense', openEditCategoryModal, deleteCategory); 
  const renderInvestmentCategoriesList = () => renderGenericList('investmentCategoriesList', state.categories.investment, 'investment', openEditCategoryModal, deleteCategory);
  const renderPaymentMethodsList = () => renderGenericList('paymentMethodsList', state.paymentMethods, 'paymentMethod', openEditCategoryModal, deletePaymentMethod);
  const updatePeopleList = () => renderGenericList('peopleList', state.people, 'person', openEditCategoryModal, deletePerson);

  const openEditCategoryModal = (item, type) => {
    state.currentCategory = item; 
    $('#editCategoryId').value = item.id;
    $('#editCategoryType').value = type; 
    $('#editCategoryName').value = item.name;
    $('#editCategoryIconInput').value = item.icon || '';
    $('#editCategoryIconPreview').innerHTML = item.icon || '●';
    const titles = {'income':'Editar Categoria de Receita', 'expense':'Editar Categoria de Despesa', 'investment':'Editar Categoria de Investimento', 'paymentMethod':'Editar Forma de Pagamento', 'person':'Editar Pessoa'};
    $('#editCategoryTitle').textContent = titles[type] || 'Editar Item';
    openModal('editCategoryModal');
  };

  const addCategory = async (name, icon, type) => {
    if (!name.trim()) { showToast('Nome não pode ser vazio.', 'error'); return null; }
    const id = `${name.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${generateId().substring(0,6)}`;
    const category = { id, name, icon, type }; 
    try {
      await db.collection('categories').doc(id).set(category);
      if (type === 'income') state.categories.income.push(category);
      else if (type === 'expense') state.categories.expense.push(category);
      else if (type === 'investment') state.categories.investment.push(category);
      await fullUIRefresh(); 
      showToast('Categoria adicionada!', 'success'); return category;
    } catch (e) { console.error(e); showToast('Erro ao adicionar categoria.', 'error'); return null; }
  };
  const addPaymentMethod = async (name, icon) => {
    if (!name.trim()) { showToast('Nome não pode ser vazio.', 'error'); return null; }
    const id = `${name.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${generateId().substring(0,6)}`;
    const method = { id, name, icon };
    try {
      await db.collection('paymentMethods').doc(id).set(method);
      state.paymentMethods.push(method);
      await fullUIRefresh(); 
      showToast('Forma de pagamento adicionada!', 'success'); return method;
    } catch (e) { console.error(e); showToast('Erro ao adicionar forma de pagamento.', 'error'); return null; }
  };
  const addPerson = async (name, icon) => {
    if (!name.trim()) { showToast('Nome não pode ser vazio.', 'error'); return null; }
    const id = `${name.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${generateId().substring(0,6)}`;
    const person = { id, name, icon };
    try {
      await db.collection('people').doc(id).set(person);
      state.people.push(person);
      await fullUIRefresh(); 
      showToast('Pessoa adicionada!', 'success'); return person;
    } catch (e) { console.error(e); showToast('Erro ao adicionar pessoa.', 'error'); return null; }
  };

  const updateCategory = async (id, updates, type) => {
    try {
      await db.collection('categories').doc(id).update(updates);
      let listToUpdate;
      if (type === 'income') listToUpdate = state.categories.income;
      else if (type === 'expense') listToUpdate = state.categories.expense;
      else if (type === 'investment') listToUpdate = state.categories.investment;
      
      const index = listToUpdate.findIndex(c => c.id === id);
      if (index !== -1) listToUpdate[index] = { ...listToUpdate[index], ...updates };
      
      const batch = db.batch();
      let transactionsUpdated = false;
      state.transactions.forEach(t => {
        if (t.category === id) {
          batch.update(db.collection('transactions').doc(t.id), { categoryName: updates.name, categoryIcon: updates.icon });
          t.categoryName = updates.name; t.categoryIcon = updates.icon; 
          transactionsUpdated = true;
        }
      });
      if (transactionsUpdated) await batch.commit();
      
      await fullUIRefresh(); 
      showToast('Categoria atualizada!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar categoria.', 'error'); return false; }
  };
  const updatePaymentMethod = async (id, updates) => {
    try {
      await db.collection('paymentMethods').doc(id).update(updates);
      const index = state.paymentMethods.findIndex(m => m.id === id);
      if (index !== -1) state.paymentMethods[index] = { ...state.paymentMethods[index], ...updates };
      
      const batch = db.batch();
      let transactionsUpdated = false;
      state.transactions.forEach(t => {
        if (t.paymentMethod === id) {
          batch.update(db.collection('transactions').doc(t.id), { paymentMethodName: updates.name, paymentMethodIcon: updates.icon });
          t.paymentMethodName = updates.name; t.paymentMethodIcon = updates.icon;
          transactionsUpdated = true;
        }
      });
      if (transactionsUpdated) await batch.commit();

      await fullUIRefresh(); 
      showToast('Forma de pagamento atualizada!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar forma de pagamento.', 'error'); return false; }
  };
  const updatePerson = async (id, updates) => {
    try {
      await db.collection('people').doc(id).update(updates);
      const index = state.people.findIndex(p => p.id === id);
      if (index !== -1) state.people[index] = { ...state.people[index], ...updates };

      const batch = db.batch();
      let transactionsUpdated = false;
      state.transactions.forEach(t => {
        if (t.person === id) {
          batch.update(db.collection('transactions').doc(t.id), { personName: updates.name, personIcon: updates.icon });
          t.personName = updates.name; t.personIcon = updates.icon;
          transactionsUpdated = true;
        }
      });
      if (transactionsUpdated) await batch.commit();

      await fullUIRefresh(); 
      showToast('Pessoa atualizada!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar pessoa.', 'error'); return false; }
  };

  const deleteCategory = async (id, type) => {
    if (!confirm(`Excluir esta categoria? Transações associadas perderão esta categoria.`)) return false;
    try {
      await db.collection('categories').doc(id).delete();
      if (type === 'income') state.categories.income = state.categories.income.filter(c => c.id !== id);
      else if (type === 'expense') state.categories.expense = state.categories.expense.filter(c => c.id !== id);
      else if (type === 'investment') state.categories.investment = state.categories.investment.filter(c => c.id !== id);
      state.transactions.forEach(t => { if (t.category === id) { t.category = null; t.categoryName = 'Sem Categoria'; t.categoryIcon = '❓'; }});
      await fullUIRefresh(); 
      showToast('Categoria excluída!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir categoria.', 'error'); return false; }
  };
  const deletePaymentMethod = async (id) => {
    if (!confirm(`Excluir esta forma de pagamento? Transações associadas perderão esta forma de pagamento.`)) return false;
    try {
      await db.collection('paymentMethods').doc(id).delete();
      state.paymentMethods = state.paymentMethods.filter(m => m.id !== id);
      state.transactions.forEach(t => { if (t.paymentMethod === id) { t.paymentMethod = null; t.paymentMethodName = 'N/A'; t.paymentMethodIcon = '❓'; }});
      await fullUIRefresh(); 
      showToast('Forma de pagamento excluída!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir forma de pagamento.', 'error'); return false; }
  };
  const deletePerson = async (id) => {
    if (!confirm(`Excluir esta pessoa? Transações associadas perderão esta pessoa.`)) return false;
    try {
      await db.collection('people').doc(id).delete();
      state.people = state.people.filter(p => p.id !== id);
      state.transactions.forEach(t => { if (t.person === id) { t.person = null; t.personName = 'N/A'; t.personIcon = '❓'; }});
      await fullUIRefresh(); 
      showToast('Pessoa excluída!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir pessoa.', 'error'); return false; }
  };

  async function fullUIRefresh() {
    filterTransactionsByMonth(); 
    updateTransactionsTable(); 
    updateKPIs();             
    updateCharts();           
    updateCardsList();             
    updateCreditCardSelects();     
    renderCommitments();           
    generateInsights();            
    renderCategoriesList();        
    renderExpenseCategoriesList(); 
    renderInvestmentCategoriesList(); 
    renderPaymentMethodsList();    
    updatePeopleList();            
    updateCategorySelects();
    updatePaymentMethodSelects();
    updatePeopleSelects();
    updateInvestmentCategorySelects();
  }

  function handleDueDateForCard(formPrefix) {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const creditCardEl = $(`#${formPrefix}CreditCard`);
    const dateEl = $(`#${formPrefix}Date`); 
    const dueDateEl = $(`#${formPrefix}DueDate`); 
    const dueDateGroupEl = $(`#${formPrefix}DueDateGroup`);

    if (!paymentMethodEl || !dueDateEl || !dueDateGroupEl) return;

    if (paymentMethodEl.value === 'credito') {
        dueDateGroupEl.style.display = 'block'; 
        dueDateEl.disabled = true; 
        if (creditCardEl && creditCardEl.value && dateEl && dateEl.value) {
            const card = state.cards.find(c => c.id === creditCardEl.value);
            const launchDate = getDateInputValue(`${formPrefix}Date`);
            if (card && launchDate) {
                const realDueDate = calcularVencimentoReal(launchDate, card);
                if (realDueDate) setDateInputValue(`${formPrefix}DueDate`, realDueDate);
            } else {
                 setDateInputValue(`${formPrefix}DueDate`, null); 
            }
        } else {
            setDateInputValue(`${formPrefix}DueDate`, null); 
        }
    } else { 
        dueDateEl.disabled = false;
        dueDateGroupEl.style.display = 'block';
        if (!dueDateEl.value && formPrefix !== 'edit') { 
            if (dateEl && dateEl.value) {
                setDateInputValue(`${formPrefix}DueDate`, getDateInputValue(`${formPrefix}Date`));
            }
        }
    }
  }
  
  function handleStatusFieldVisibility(formPrefix) {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const isRecurrentEl = $(`#${formPrefix}IsRecurrent`);
    const statusGroupEl = $(`#${formPrefix}StatusGroup`);
    const statusPendingRadio = $(`#${formPrefix}StatusPending`); 
    const scheduledDateGroup = $(`#${formPrefix}ScheduledDateGroup`);
    const statusScheduledRadio = $(`#${formPrefix}StatusScheduled`);

    if (!paymentMethodEl || !statusGroupEl) return;
    
    const isCreditCard = paymentMethodEl.value === 'credito';
    const isRecurrent = isRecurrentEl ? isRecurrentEl.checked : false;

    if (isCreditCard || (isRecurrent && formPrefix.includes('expense'))) { 
        statusGroupEl.style.display = 'none';
        statusPendingRadio.checked = true;
    } else if (isRecurrent && formPrefix.includes('income')) { 
        statusGroupEl.style.display = 'none';
        if (statusPendingRadio) statusPendingRadio.checked = true; 
    } else {
        statusGroupEl.style.display = 'block'; 
    }

    // Gerenciar visibilidade do campo de data agendada se existir
    if (scheduledDateGroup && statusScheduledRadio) {
        scheduledDateGroup.style.display = statusScheduledRadio.checked ? 'block' : 'none';
    }
  }

  function handleRecurrenceGroupVisibility(formPrefix) {
    const isRecurrentEl = $(`#${formPrefix}IsRecurrent`);
    const recurrenceGroupEl = $(`#${formPrefix}RecurrenceGroup`);
    
    if (!isRecurrentEl || !recurrenceGroupEl) return;
    
    recurrenceGroupEl.style.display = isRecurrentEl.checked ? 'block' : 'none';
  }

  function handleEditRecurrenceGroupVisibility() {
    const isRecurrentEl = $('#editIsRecurrent');
    const recurrenceGroupEl = $('#editRecurrenceGroup');
    
    if (!isRecurrentEl || !recurrenceGroupEl) return;
    
    recurrenceGroupEl.style.display = isRecurrentEl.checked ? 'block' : 'none';
  }

  function handleEditDueDateForCard() {
    const paymentMethodEl = $('#editPaymentMethod');
    const creditCardEl = $('#editCreditCard');
    const dateEl = $('#editDate');
    const dueDateEl = $('#editDueDate');
    const dueDateGroupEl = $('#editDueDateGroup');
    
    if (!paymentMethodEl || !dueDateEl || !dueDateGroupEl) return;
    
    if (paymentMethodEl.value === 'credito') {
        dueDateGroupEl.style.display = 'block';
        dueDateEl.disabled = true;
        
        if (creditCardEl && creditCardEl.value && dateEl && dateEl.value) {
            const card = state.cards.find(c => c.id === creditCardEl.value);
            const launchDate = getDateInputValue('editDate');
            
            if (card && launchDate) {
                const realDueDate = calcularVencimentoReal(launchDate, card);
                if (realDueDate) setDateInputValue('editDueDate', realDueDate);
            } else {
                setDateInputValue('editDueDate', null);
            }
        } else {
            setDateInputValue('editDueDate', null);
        }
    } else {
        dueDateEl.disabled = false;
        dueDateGroupEl.style.display = 'block';
    }
  }

  function handleEditCreditCardVisibility() {
    const paymentMethodEl = $('#editPaymentMethod');
    const creditCardGroupEl = $('#editCreditCardGroup');
    
    if (!paymentMethodEl || !creditCardGroupEl) return;
    
    if (paymentMethodEl.value === 'credito') {
        creditCardGroupEl.style.display = 'block';
        handleEditDueDateForCard();
    } else {
        creditCardGroupEl.style.display = 'none';
    }
  }

  function handleEditStatusFieldVisibility() {
    const paymentMethodEl = $('#editPaymentMethod');
    const isRecurrentEl = $('#editIsRecurrent');
    const statusGroupEl = $('#editStatusGroup');
    const statusOuterGroupEl = $('#editStatusOuterGroup');
    
    if (!paymentMethodEl || !statusGroupEl || !statusOuterGroupEl) return;
    
    const isCreditCard = paymentMethodEl.value === 'credito';
    const isRecurrent = isRecurrentEl ? isRecurrentEl.checked : false;
    const transactionType = $('#editTransactionType').value;
    
    if (isCreditCard) {
        statusOuterGroupEl.style.display = 'none';
    } else {
        statusOuterGroupEl.style.display = 'block';
    }
  }

  function handleEditScheduledDateVisibility() {
    const statusScheduledRadio = $('#editStatusScheduled');
    const scheduledDateGroupEl = $('#editScheduledDateGroup');
    
    if (!statusScheduledRadio || !scheduledDateGroupEl) return;
    
    scheduledDateGroupEl.style.display = statusScheduledRadio.checked ? 'block' : 'none';
  }

  function handleCreditCardGroupVisibility(formPrefix) {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const creditCardGroupEl = $(`#${formPrefix}CreditCardGroup`);
    
    if (!paymentMethodEl || !creditCardGroupEl) return;
    
    const isCreditCard = paymentMethodEl.value === 'credito';
    creditCardGroupEl.style.display = isCreditCard ? 'block' : 'none';
    
    if (isCreditCard) {
        handleDueDateForCard(formPrefix);
    }
  }

  function handleScheduledDateVisibility(formPrefix) {
    const statusScheduledRadio = $(`#${formPrefix}StatusScheduled`);
    const scheduledDateGroupEl = $(`#${formPrefix}ScheduledDateGroup`);
    
    if (!statusScheduledRadio || !scheduledDateGroupEl) return;
    
    scheduledDateGroupEl.style.display = statusScheduledRadio.checked ? 'block' : 'none';
  }

  // Setup dos ouvintes de eventos
  function setupEventListeners() {
    // Filtros de cabeçalho
    $('#yearSelect').addEventListener('change', e => {
      state.year = parseInt(e.target.value);
      fullUIRefresh();
    });
    
    $('#monthSelect').addEventListener('change', e => {
      state.month = parseInt(e.target.value);
      fullUIRefresh();
    });
    
    // Header actions
    $('#newIncomeBtn').addEventListener('click', () => openModal('incomeModal'));
    $('#newExpenseBtn').addEventListener('click', () => openModal('expenseModal'));
    $('#cardsBtn').addEventListener('click', () => openModal('cardsListModal'));
    $('#categoriesBtn').addEventListener('click', () => openModal('categoriesModal'));
    $('#investmentsBtn').addEventListener('click', () => openModal('investmentsModal'));
    
    // Compromissos
    $('#commitmentsHeader').addEventListener('click', toggleCommitments);
    
    // Modal de Nova Receita
    $('#closeIncomeModal').addEventListener('click', () => closeModal('incomeModal'));
    $('#cancelIncomeBtn').addEventListener('click', () => closeModal('incomeModal'));
    $('#saveIncomeBtn').addEventListener('click', handleSaveIncome);
    $('#incomePaymentMethod').addEventListener('change', () => handleStatusField('income'));
    $('#incomeIsRecurrent').addEventListener('change', () => {
      handleRecurrenceGroupVisibility('income');
      handleStatusField('income');
    });
    
    // Modal de Nova Despesa
    $('#closeExpenseModal').addEventListener('click', () => closeModal('expenseModal'));
    $('#cancelExpenseBtn').addEventListener('click', () => closeModal('expenseModal'));
    $('#saveExpenseBtn').addEventListener('click', handleSaveExpense);
    $('#expensePaymentMethod').addEventListener('change', () => {
      handleCreditCardGroupVisibility('expense');
      handleStatusField('expense');
    });
    $('#expenseIsRecurrent').addEventListener('change', () => {
      handleRecurrenceGroupVisibility('expense');
      handleStatusField('expense');
    });
    $('#expenseStatusScheduled').addEventListener('change', () => handleScheduledDateVisibility('expense'));
    $('#expenseCreditCard').addEventListener('change', () => handleDueDateForCard('expense'));
    
    // Modal de Edição de Transação
    $('#closeEditModal').addEventListener('click', () => closeModal('editModal'));
    $('#cancelEditBtn').addEventListener('click', () => closeModal('editModal'));
    $('#saveEditBtn').addEventListener('click', handleSaveEdit);
    $('#editPaymentMethod').addEventListener('change', () => {
      handleEditCreditCardVisibility();
      handleEditStatusFieldVisibility();
    });
    $('#editIsRecurrent').addEventListener('change', () => {
      handleEditRecurrenceGroupVisibility();
      handleEditStatusFieldVisibility();
    });
    $('#editCreditCard').addEventListener('change', handleEditDueDateForCard);
    
    // Modal de Cartões
    $('#closeCardsListModal').addEventListener('click', () => closeModal('cardsListModal'));
    $('#newCardBtn').addEventListener('click', () => {
      state.currentCard = null;
      $('#cardForm').reset();
      $('.modal-title', $('#newCardModal')).textContent = 'Novo Cartão';
      $('#saveCardBtn').textContent = 'Salvar Cartão';
      $('#saveCardBtn').removeAttribute('data-id');
      closeModal('cardsListModal');
      openModal('newCardModal');
    });
    
    // Modal de Novo Cartão
    $('#closeNewCardModal').addEventListener('click', () => closeModal('newCardModal'));
    $('#cancelCardBtn').addEventListener('click', () => closeModal('newCardModal'));
    $('#saveCardBtn').addEventListener('click', handleSaveCard);
    
    // Modal de Fatura de Cartão
    $('#closeCardInvoiceModal').addEventListener('click', () => closeModal('cardInvoiceModal'));
    $('#backToCardsBtn').addEventListener('click', () => {
      closeModal('cardInvoiceModal');
      openModal('cardsListModal');
    });
    $('#payInvoiceBtn').addEventListener('click', handlePayInvoice);
    
    // Modal de Confirmação de Exclusão
    $('#closeDeleteConfirmModal').addEventListener('click', () => closeModal('deleteConfirmModal'));
    $('#cancelDeleteBtn').addEventListener('click', () => closeModal('deleteConfirmModal'));
    $('#confirmDeleteBtn').addEventListener('click', handleConfirmDelete);
    
    // Modal de Confirmação de Pagamento de Fatura
    $('#closePayInvoiceConfirmModal').addEventListener('click', () => closeModal('payInvoiceConfirmModal'));
    $('#cancelPayInvoiceBtn').addEventListener('click', () => closeModal('payInvoiceConfirmModal'));
    $('#confirmPayInvoiceBtn').addEventListener('click', handleConfirmPayInvoice);
    
    // Modal de Categorias
    $('#closeCategoriesModal').addEventListener('click', () => closeModal('categoriesModal'));
    $('#closeCategoriesBtn').addEventListener('click', () => closeModal('categoriesModal'));
    
    // Navegação por abas nas categorias
    $$('#categoryTabs .nav-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        $$('#categoryTabs .nav-link').forEach(l => l.classList.remove('active'));
        $$('#categoryTabContent .tab-pane').forEach(p => {
          p.classList.remove('show', 'active');
        });
        e.target.classList.add('active');
        const tabId = e.target.getAttribute('href').substring(1);
        $(`#${tabId}`).classList.add('show', 'active');
      });
    });
    
    // Adição de categorias
    $('#addIncomeCategoryBtn').addEventListener('click', () => {
      const name = $('#newIncomeCategoryInput').value.trim();
      const icon = $('#newIncomeCategoryIconInput').value.trim() || '💰';
      if (name) {
        addCategory(name, icon, 'income').then(() => {
          $('#newIncomeCategoryInput').value = '';
          $('#newIncomeCategoryIconInput').value = '';
        });
      }
    });
    
    $('#addExpenseCategoryBtn').addEventListener('click', () => {
      const name = $('#newExpenseCategoryInput').value.trim();
      const icon = $('#newExpenseCategoryIconInput').value.trim() || '🛍️';
      if (name) {
        addCategory(name, icon, 'expense').then(() => {
          $('#newExpenseCategoryInput').value = '';
          $('#newExpenseCategoryIconInput').value = '';
        });
      }
    });
    
    $('#addInvestmentCategoryBtn').addEventListener('click', () => {
      const name = $('#newInvestmentCategoryInput').value.trim();
      const icon = $('#newInvestmentCategoryIconInput').value.trim() || '📈';
      if (name) {
        addCategory(name, icon, 'investment').then(() => {
          $('#newInvestmentCategoryInput').value = '';
          $('#newInvestmentCategoryIconInput').value = '';
        });
      }
    });
    
    $('#addPaymentMethodBtn').addEventListener('click', () => {
      const name = $('#newPaymentMethodInput').value.trim();
      const icon = $('#newPaymentMethodIconInput').value.trim() || '💳';
      if (name) {
        addPaymentMethod(name, icon).then(() => {
          $('#newPaymentMethodInput').value = '';
          $('#newPaymentMethodIconInput').value = '';
        });
      }
    });
    
    $('#addPersonBtn').addEventListener('click', () => {
      const name = $('#newPersonInput').value.trim();
      const icon = $('#newPersonIconInput').value.trim() || '👤';
      if (name) {
        addPerson(name, icon).then(() => {
          $('#newPersonInput').value = '';
          $('#newPersonIconInput').value = '';
        });
      }
    });
    
    // Modal de Edição de Categoria
    $('#closeEditCategoryModal').addEventListener('click', () => closeModal('editCategoryModal'));
    $('#cancelEditCategoryBtn').addEventListener('click', () => closeModal('editCategoryModal'));
    $('#saveEditCategoryBtn').addEventListener('click', handleSaveEditCategory);
    
    // Preview de ícones
    ['newIncomeCategory', 'newExpenseCategory', 'newInvestmentCategory', 'newPaymentMethod', 'newPerson', 'editCategory'].forEach(prefix => {
      const input = $(`#${prefix}IconInput`);
      const preview = $(`#${prefix}IconPreview`);
      if (input && preview) {
        input.addEventListener('input', () => {
          preview.textContent = input.value || '●';
        });
      }
    });

    // Modal de Investimentos
    $('#closeInvestmentsModal').addEventListener('click', () => closeModal('investmentsModal'));
    $('#closeInvestmentsBtn').addEventListener('click', () => closeModal('investmentsModal'));
    $('#newInvestmentBtn').addEventListener('click', openNewInvestmentModal);
    
    // Modal de Novo Investimento
    $('#closeNewInvestmentModal').addEventListener('click', () => closeModal('newInvestmentModal'));
    $('#cancelInvestmentBtn').addEventListener('click', () => closeModal('newInvestmentModal'));
    $('#saveInvestmentBtn').addEventListener('click', handleSaveInvestment);
    
    // Modal de Detalhe do Investimento
    $('#closeInvestmentDetailModal').addEventListener('click', () => closeModal('investmentDetailModal'));
    $('#backToInvestmentsBtn').addEventListener('click', () => {
      closeModal('investmentDetailModal');
      openModal('investmentsModal');
    });
    $('#editInvestmentBtn').addEventListener('click', () => {
      if (state.currentInvestment) openEditInvestmentModal(state.currentInvestment.id);
    });
    $('#deleteInvestmentBtn').addEventListener('click', () => {
      if (state.currentInvestment && confirm('Tem certeza que deseja excluir este investimento e todos os seus aportes?')) {
        deleteInvestment(state.currentInvestment.id);
      }
    });
    $('#addInvestmentContributionBtn').addEventListener('click', openNewContributionModal);
    
    // Modal de Novo Aporte
    $('#closeNewContributionModal').addEventListener('click', () => closeModal('newContributionModal'));
    $('#cancelContributionBtn').addEventListener('click', () => closeModal('newContributionModal'));
    $('#saveContributionBtn').addEventListener('click', handleSaveContribution);
    
    // Modal de Contas Vencidas/A Vencer
    $('#closeDueTransactionsModal').addEventListener('click', () => closeModal('dueTransactionsModal'));
    $('#closeDueTransactionsBtn').addEventListener('click', () => closeModal('dueTransactionsModal'));
    $('#payAllDueBtn').addEventListener('click', handlePayAllDue);
  }

  function handleSaveIncome() {
    const data = {
      name: $('#incomeName').value,
      amount: parseFloat($('#incomeAmount').value),
      category: $('#incomeCategory').value,
      date: getDateInputValue('incomeDate'),
      paymentMethod: $('#incomePaymentMethod').value,
      isRecurrent: $('#incomeIsRecurrent').checked,
      type: 'income'
    };
    
    if (!data.name || !data.amount || !data.category || !data.date || !data.paymentMethod) {
      showToast('Preencha todos os campos obrigatórios', 'error');
      return;
    }
    
    if (data.isRecurrent) {
      data.installments = parseInt($('#incomeInstallments').value);
      if (data.installments < 2) {
        showToast('Para recorrência, informe pelo menos 2 parcelas', 'error');
        return;
      }
      addRecurrentTransactions(data, data.installments).then(() => {
        closeModal('incomeModal');
        $('#incomeForm').reset();
      });
    } else {
      data.status = $('input[name="incomeStatus"]:checked').value;
      data.notes = $('#incomeNotes').value;
      addTransaction(data).then(() => {
        closeModal('incomeModal');
        $('#incomeForm').reset();
      });
    }
  }

  function handleSaveExpense() {
    const data = {
      name: $('#expenseName').value,
      amount: parseFloat($('#expenseAmount').value),
      category: $('#expenseCategory').value,
      date: getDateInputValue('expenseDate'),
      dueDate: getDateInputValue('expenseDueDate'),
      paymentMethod: $('#expensePaymentMethod').value,
      person: $('#expensePerson').value,
      isFixed: $('input[name="expenseType"]:checked').value,
      isRecurrent: $('#expenseIsRecurrent').checked,
      type: 'expense'
    };
    
    if (!data.name || !data.amount || !data.category || !data.date || !data.paymentMethod) {
      showToast('Preencha todos os campos obrigatórios', 'error');
      return;
    }
    
    if (data.paymentMethod === 'credito') {
      data.creditCardId = $('#expenseCreditCard').value;
      if (!data.creditCardId) {
        showToast('Selecione o cartão de crédito', 'error');
        return;
      }
      data.status = 'pending';
    } else {
      data.status = $('input[name="expenseStatus"]:checked').value;
    }
    
    if (data.status === 'scheduled') {
      data.scheduledDate = getDateInputValue('expenseScheduledDate');
      if (!data.scheduledDate) {
        showToast('Informe a data de agendamento', 'error');
        return;
      }
    }
    
    data.notes = $('#expenseNotes').value;
    
    if (data.isRecurrent) {
      data.installments = parseInt($('#expenseInstallments').value);
      if (data.installments < 2) {
        showToast('Para recorrência, informe pelo menos 2 parcelas', 'error');
        return;
      }
      addRecurrentTransactions(data, data.installments).then(() => {
        closeModal('expenseModal');
        $('#expenseForm').reset();
      });
    } else {
      addTransaction(data).then(() => {
        closeModal('expenseModal');
        $('#expenseForm').reset();
      });
    }
  }

  function handleSaveEdit() {
    const id = $('#editTransactionId').value;
    const type = $('#editTransactionType').value;
    
    const updates = {
      name: $('#editName').value,
      amount: parseFloat($('#editAmount').value),
      category: $('#editCategory').value,
      date: getDateInputValue('editDate'),
      paymentMethod: $('#editPaymentMethod').value
    };
    
    if (type === 'expense') {
      updates.dueDate = getDateInputValue('editDueDate');
      updates.person = $('#editPerson').value;
      updates.isFixed = $('input[name="editExpenseType"]:checked').value;
      
      if (updates.paymentMethod === 'credito') {
        updates.creditCardId = $('#editCreditCard').value;
        updates.status = 'pending';
      } else {
        updates.status = $('input[name="editStatus"]:checked').value;
      }
    } else {
      updates.status = $('input[name="editStatus"]:checked').value;
    }
    
    if (updates.status === 'scheduled') {
      updates.scheduledDate = getDateInputValue('editScheduledDate');
    }
    
    updates.isRecurrent = $('#editIsRecurrent').checked;
    if (updates.isRecurrent) {
      updates.installments = parseInt($('#editInstallments').value);
    }
    
    updates.notes = $('#editNotes').value;
    
    updateTransaction(id, updates).then(() => {
      closeModal('editModal');
    });
  }

  function handleSaveCard() {
    const data = {
      name: $('#cardName').value,
      limit: parseFloat($('#cardLimit').value),
      closingDay: parseInt($('#cardClosingDay').value),
      dueDay: parseInt($('#cardDueDay').value)
    };
    
    if (!data.name || !data.limit || !data.closingDay || !data.dueDay) {
      showToast('Preencha todos os campos', 'error');
      return;
    }
    
    if (data.closingDay < 1 || data.closingDay > 31 || data.dueDay < 1 || data.dueDay > 31) {
      showToast('Informe dias válidos (1-31)', 'error');
      return;
    }
    
    const cardId = $('#saveCardBtn').dataset.id;
    if (cardId) {
      updateCard(cardId, data).then(() => {
        closeModal('newCardModal');
        openModal('cardsListModal');
      });
    } else {
      addCard(data).then(() => {
        closeModal('newCardModal');
        openModal('cardsListModal');
      });
    }
  }

  function handlePayInvoice() {
    if (!state.currentCard) return;
    $('#invoiceConfirmAmount').textContent = $('#currentInvoiceValueDisplay').textContent;
    openModal('payInvoiceConfirmModal');
  }

  function handleConfirmPayInvoice() {
    if (!state.currentCard) return;
    payCardInvoice(state.currentCard.id);
  }

  function handleConfirmDelete() {
    if (!state.currentTransaction) return;
    
    const options = {};
    if (state.currentTransaction.isRecurrent && state.currentTransaction.recurrenceId) {
      options.deleteOption = $('input[name="deleteOption"]:checked').value;
    }
    
    deleteTransaction(state.currentTransaction.id, options).then(() => {
      closeModal('deleteConfirmModal');
    });
  }

  function handleSaveEditCategory() {
    const id = $('#editCategoryId').value;
    const type = $('#editCategoryType').value;
    
    const updates = {
      name: $('#editCategoryName').value,
      icon: $('#editCategoryIconInput').value || '●'
    };
    
    if (!updates.name) {
      showToast('Nome não pode ser vazio', 'error');
      return;
    }
    
    if (type === 'income' || type === 'expense' || type === 'investment') {
      updateCategory(id, updates, type).then(() => {
        closeModal('editCategoryModal');
      });
    } else if (type === 'paymentMethod') {
      updatePaymentMethod(id, updates).then(() => {
        closeModal('editCategoryModal');
      });
    } else if (type === 'person') {
      updatePerson(id, updates).then(() => {
        closeModal('editCategoryModal');
      });
    }
  }

  function handleSaveInvestment() {
    const data = {
      name: $('#investmentName').value,
      amount: parseFloat($('#investmentAmount').value) || 0,
      goal: parseFloat($('#investmentGoal').value) || 0,
      category: $('#investmentCategorySelect').value,
      targetDate: getDateInputValue('investmentTargetDate'),
      notes: $('#investmentNotes').value
    };
    
    if (!data.name) {
      showToast('Informe um nome para o investimento', 'error');
      return;
    }
    
    const action = $('#saveInvestmentBtn').dataset.action;
    const id = $('#saveInvestmentBtn').dataset.id;
    
    if (action === 'update' && id) {
      updateInvestment(id, data).then(() => {
        closeModal('newInvestmentModal');
        if ($('#investmentDetailModal').classList.contains('active')) {
          openInvestmentDetail(id);
        } else {
          openModal('investmentsModal');
        }
      });
    } else {
      addInvestment(data).then(investment => {
        closeModal('newInvestmentModal');
        openModal('investmentsModal');
      });
    }
  }

  function handleSaveContribution() {
    const data = {
      investmentId: $('#contributionInvestmentId').value,
      amount: parseFloat($('#contributionAmount').value),
      date: getDateInputValue('contributionDate'),
      description: $('#contributionDescription').value
    };
    
    if (!data.investmentId || !data.amount || !data.date) {
      showToast('Preencha todos os campos obrigatórios', 'error');
      return;
    }
    
    const action = $('#saveContributionBtn').dataset.action;
    const id = $('#saveContributionBtn').dataset.id;
    
    if (action === 'update' && id) {
      updateContribution(id, data).then(() => {
        closeModal('newContributionModal');
      });
    } else {
      addContribution(data).then(() => {
        closeModal('newContributionModal');
      });
    }
  }

  function handlePayAllDue() {
    const rows = $$('#dueTransactionsTableBody tr');
    if (rows.length === 0) return;
    
    const batch = [];
    rows.forEach(row => {
      const btnId = row.querySelector('.mark-paid-due-btn').dataset.id;
      if (btnId) batch.push(updateTransactionStatus(btnId, 'paid'));
    });
    
    Promise.all(batch).then(() => {
      closeModal('dueTransactionsModal');
      showToast('Todas as contas foram pagas!', 'success');
    });
  }

  // Inicialização da aplicação
  async function init() {
    try {
      initTheme();
      updateYearOptions();
      
      // Mês e ano atual como default
      const currentDate = new Date();
      state.year = currentDate.getFullYear();
      state.month = currentDate.getMonth();
      
      $('#yearSelect').value = state.year;
      $('#monthSelect').value = state.month;
      
      // Setup de todos os event listeners
      setupEventListeners();
      
      // Carregamento dos dados iniciais
      await loadCategoriesAndPaymentMethods();
      await loadCards();
      await loadInvestments();
      await loadTransactions();
      
      // Configurar os valores iniciais para inputs de data
      setDateInputValue('incomeDate', new Date());
      setDateInputValue('expenseDate', new Date());
      setDateInputValue('expenseDueDate', new Date());
      
      showToast('Aplicativo inicializado com sucesso!', 'success');
    } catch (error) {
      console.error('Erro ao inicializar aplicativo:', error);
      showToast('Erro ao inicializar. Verifique o console.', 'error');
    }
  }

  // Iniciar a aplicação quando o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', init);

  // Adicionar listener para salvar tema quando mudar
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    const newTheme = e.matches ? 'dark' : 'light';
    if (!localStorage.getItem('themePreference')) {
      document.documentElement.setAttribute('data-theme', newTheme);
    }
  });

</script>
</body>
</html>
