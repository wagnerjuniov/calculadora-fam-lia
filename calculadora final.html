
<!-- ===== INICIO: PARTE 1 - CABEÇALHO ================================ -->
<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Calculadora da Família - Controle financeiro com estilo Apple">
  <title>Calculadora da Família</title>
  
  <!-- Fonte Inter via Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Scripts CDN: Chart.js 4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Scripts CDN: Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
  
  <style>
    /* Design-tokens em :root */
    :root {
      /* Cores neutras */
      --color-background: #ffffff;
      --color-surface: #f5f5f7;
      --color-surface-variant: #e8e8ed;
      --color-on-surface: #1d1d1f;
      --color-on-surface-variant: #86868b;
      --color-outline: #d2d2d7;
      
      /* Cores semânticas */
      --color-primary: #0071e3;
      --color-on-primary: #ffffff;
      --color-success: #34c759;
      --color-on-success: #ffffff;
      --color-warning: #ff9500;
      --color-on-warning: #ffffff;
      --color-error: #ff3b30;
      --color-on-error: #ffffff;
      --color-info: #007aff;
      --color-on-info: #ffffff;
      
      /* Cores para receitas e despesas */
      --color-income: #34c759;
      --color-expense: #ff3b30;
      
      /* Cores de cartões */
      --color-card-blue: #007aff;
      --color-card-green: #34c759;
      --color-card-orange: #ff9500;
      --color-card-red: #ff3b30;
      --color-card-purple: #af52de;
      
      /* Tipografia */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-md: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      --font-weight-light: 300;
      --font-weight-regular: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Espaçamento */
      --spacing-2xs: 0.25rem;
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      
      /* Bordas e raios */
      --radius-sm: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --radius-full: 9999px;
      
      /* Sombras */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.05), 0 4px 6px rgba(0, 0, 0, 0.05);
      
      /* Animações */
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Tema escuro */
    [data-theme="dark"] {
      --color-background: #000000;
      --color-surface: #1c1c1e;
      --color-surface-variant: #2c2c2e;
      --color-on-surface: #f5f5f7;
      --color-on-surface-variant: #8e8e93;
      --color-outline: #38383a;
    }
    
    /* Reset básico */
    @layer reset {
      *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      html, body {
        height: 100%;
        font-family: var(--font-family);
        background-color: var(--color-background);
        color: var(--color-on-surface);
        font-size: var(--font-size-md);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color var(--transition-normal), color var(--transition-normal);
      }
      
      img, picture, video, canvas, svg {
        display: block;
        max-width: 100%;
      }
      
      input, button, textarea, select {
        font: inherit;
        color: inherit;
      }
      
      button {
        background: none;
        border: none;
        cursor: pointer;
      }
      
      a {
        color: inherit;
        text-decoration: none;
      }
      
      table {
        border-collapse: collapse;
        width: 100%;
      }
    }
</style>
</head>
<!-- ===== FIM: PARTE 1 - CABEÇALHO ================================ -->

<!-- ===== INICIO: PARTE 2 - CSS DE LAYOUT E COMPONENTES ================================ -->
  <style>
    /* Layout principal */
    @layer layout {
      /* Container principal */
      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-md);
      }
      
      /* Header */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) 0;
        margin-bottom: var(--spacing-xl);
        position: sticky;
        top: 0;
        background-color: var(--color-background);
        z-index: 100;
        transition: background-color var(--transition-normal);
      }
      
      .header-filters {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
      }
      
      .header-actions {
        display: flex;
        gap: var(--spacing-md);
      }
      
      /* Área de KPIs */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
      }
      
      /* Insights banner */
      .insights-banner {
        margin-bottom: var(--spacing-xl);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }
      
      /* Gráficos */
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
      }
      
      .chart-container {
        position: relative;
        height: 300px;
        border-radius: var(--radius-lg);
        background-color: var(--color-surface);
        padding: var(--spacing-md);
        box-shadow: var(--shadow-sm);
      }
      
      /* Compromissos longos */
      .commitments {
        margin-bottom: var(--spacing-xl);
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        box-shadow: var(--shadow-sm);
      }
      
      .commitments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        cursor: pointer;
      }
      
      .commitments-content {
        overflow: hidden;
        transition: max-height var(--transition-normal);
      }
      
      .commitment-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) 0;
        border-bottom: 1px solid var(--color-outline);
      }
      
      .commitment-progress {
        flex: 1;
        height: 8px;
        background-color: var(--color-surface-variant);
        border-radius: var(--radius-full);
        overflow: hidden;
      }
      
      .commitment-progress-bar {
        height: 100%;
        background-color: var(--color-primary);
      }
      
      /* Tabela de transações */
      .transactions {
        margin-bottom: var(--spacing-xl);
      }
      
      .transactions-table {
        width: 100%;
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
      }
      
      .transactions-table th {
        text-align: left;
        padding: var(--spacing-md);
        font-weight: var(--font-weight-medium);
        color: var(--color-on-surface-variant);
        background-color: var(--color-surface);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      
      .transactions-table td {
        padding: var(--spacing-md);
        border-top: 1px solid var(--color-outline);
      }
      
      .transactions-table tr:hover {
        background-color: var(--color-surface-variant);
      }
      
      .transaction-icon {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: var(--radius-full);
        background-color: var(--color-surface-variant);
      }
      
      .actions-cell {
        display: flex;
        gap: var(--spacing-xs);
        justify-content: flex-end;
      }
      
      /* Responsividade */
      @media (max-width: 992px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }
      
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-md);
        }
        
        .header-filters, .header-actions {
          width: 100%;
          justify-content: space-between;
        }
        
        .transactions-table {
          display: block;
          overflow-x: auto;
        }
      }
      
      @media (max-width: 576px) {
        .kpi-grid {
          grid-template-columns: 1fr;
        }
        
        .header-filters {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .transactions-table-wrapper {
          margin: 0 calc(-1 * var(--spacing-md));
        }
        
        .transaction-responsive-card {
          display: flex;
          flex-direction: column;
          background-color: var(--color-surface);
          margin-bottom: var(--spacing-md);
          border-radius: var(--radius-lg);
          overflow: hidden;
          padding: var(--spacing-md);
        }
      }
    }
    
    /* Componentes */
    @layer components {
      /* Botões */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-full);
        font-weight: var(--font-weight-medium);
        transition: all var(--transition-normal);
        white-space: nowrap;
      }
      
      .btn-primary {
        background-color: var(--color-primary);
        color: var(--color-on-primary);
      }
      
      .btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      
      .btn-primary:active {
        transform: translateY(0);
      }
      
      .btn-success {
        background-color: var(--color-success);
        color: var(--color-on-success);
      }
      
      .btn-success:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      
      .btn-danger {
        background-color: var(--color-error);
        color: var(--color-on-error);
      }
      
      .btn-danger:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      
      .btn-outline {
        border: 1px solid var(--color-outline);
        background-color: transparent;
      }
      
      .btn-outline:hover {
        background-color: var(--color-surface-variant);
      }
      
      .btn-icon {
        width: 2.5rem;
        height: 2.5rem;
        padding: 0;
        border-radius: var(--radius-full);
      }
      
      /* Select personalizado */
      .select-wrapper {
        position: relative;
        display: inline-block;
      }
      
      .select {
        appearance: none;
        -webkit-appearance: none;
        padding: var(--spacing-xs) var(--spacing-xl) var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-full);
        border: 1px solid var(--color-outline);
        background-color: var(--color-surface);
        cursor: pointer;
        transition: border-color var(--transition-normal);
      }
      
      .select:focus {
        outline: none;
        border-color: var(--color-primary);
      }
      
      .select-icon {
        position: absolute;
        right: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
      }
      
      /* Cards */
      .card {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        box-shadow: var(--shadow-sm);
        transition: transform var(--transition-normal), box-shadow var(--transition-normal);
      }
      
      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }
      
      /* KPI Cards */
      .kpi-card {
        display: flex;
        flex-direction: column;
        background-color: var(--color-surface);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        transition: transform var(--transition-normal), box-shadow var(--transition-normal);
      }
      
      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }
      
      .kpi-title {
        font-size: var(--font-size-sm);
        color: var(--color-on-surface-variant);
        margin-bottom: var(--spacing-xs);
      }
      
      .kpi-value {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--spacing-xs);
      }
      
      .kpi-subtitle {
        font-size: var(--font-size-xs);
        color: var(--color-on-surface-variant);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }
      
      .kpi-income {
        border-left: 4px solid var(--color-income);
      }
      
      .kpi-expense {
        border-left: 4px solid var(--color-expense);
      }
      
      .kpi-balance {
        border-left: 4px solid var(--color-primary);
      }
      
      .kpi-card-invoice {
        border-left: 4px solid var(--color-card-blue);
      }
      
      /* Insights */
      .insight-banner {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-md);
      }
      
      .insight-icon {
        font-size: 1.5rem;
      }
      
      .insight-content {
        flex: 1;
      }
      
      .insight-title {
        font-weight: var(--font-weight-medium);
        margin-bottom: var(--spacing-2xs);
      }
      
      .insight-danger {
        background-color: rgba(255, 59, 48, 0.1);
        border-left: 4px solid var(--color-error);
      }
      
      .insight-warning {
        background-color: rgba(255, 149, 0, 0.1);
        border-left: 4px solid var(--color-warning);
      }
      
      .insight-info {
        background-color: rgba(0, 122, 255, 0.1);
        border-left: 4px solid var(--color-info);
      }
      
      .insight-success {
        background-color: rgba(52, 199, 89, 0.1);
        border-left: 4px solid var(--color-success);
      }
      
      /* Checkbox personalizado */
      .checkbox-wrapper {
        position: relative;
        display: inline-block;
      }
      
      .checkbox {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .checkbox-label {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--color-outline);
        background-color: var(--color-surface);
        cursor: pointer;
        transition: all var(--transition-normal);
      }
      
      .checkbox:checked + .checkbox-label {
        background-color: var(--color-primary);
        border-color: var(--color-primary);
      }
      
      .checkbox:checked + .checkbox-label:after {
        content: '';
        position: absolute;
        left: 7px;
        top: 3px;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }
      
      /* Badge */
      .badge {
        display: inline-block;
        padding: var(--spacing-2xs) var(--spacing-xs);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
      }
      
      .badge-success {
        background-color: rgba(52, 199, 89, 0.1);
        color: var(--color-success);
      }
      
      .badge-warning {
        background-color: rgba(255, 149, 0, 0.1);
        color: var(--color-warning);
      }
      
      .badge-danger {
        background-color: rgba(255, 59, 48, 0.1);
        color: var(--color-error);
      }
      
      .badge-info {
        background-color: rgba(0, 122, 255, 0.1);
        color: var(--color-info);
      }
      
      /* Modais */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-normal), visibility var(--transition-normal);
        backdrop-filter: blur(4px);
      }
      
      .modal-backdrop.active {
        opacity: 1;
        visibility: visible;
      }
      
      .modal {
        width: 90%;
        max-width: 500px;
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity var(--transition-normal), transform var(--transition-normal);
      }
      
      .modal-backdrop.active .modal {
        opacity: 1;
        transform: translateY(0);
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--color-outline);
      }
      
      .modal-title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
      }
      
      .modal-close {
        font-size: var(--font-size-xl);
        color: var(--color-on-surface-variant);
        cursor: pointer;
      }
      
      .modal-body {
        padding: var(--spacing-md);
        max-height: 70vh;
        overflow-y: auto;
      }
      
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        border-top: 1px solid var(--color-outline);
      }
      
      /* Toast */
      .toast-container {
        position: fixed;
        top: var(--spacing-md);
        right: var(--spacing-md);
        z-index: 2000;
      }
      
      .toast {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        background-color: var(--color-surface);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        box-shadow: var(--shadow-md);
        min-width: 300px;
        max-width: 400px;
        transform: translateX(120%);
        transition: transform var(--transition-normal);
      }
      
      .toast.show {
        transform: translateX(0);
      }
      
      .toast-icon {
        font-size: 1.5rem;
      }
      
      .toast-content {
        flex: 1;
      }
      
      .toast-close {
        font-size: var(--font-size-lg);
        color: var(--color-on-surface-variant);
        cursor: pointer;
      }
      
      .toast-success {
        border-left: 4px solid var(--color-success);
      }
      
      .toast-error {
        border-left: 4px solid var(--color-error);
      }
      
      .toast-warning {
        border-left: 4px solid var(--color-warning);
      }
      
      .toast-info {
        border-left: 4px solid var(--color-info);
      }
      
      /* Inputs */
      .form-group {
        margin-bottom: var(--spacing-md);
      }
      
      .form-label {
        display: block;
        font-size: var(--font-size-sm);
        color: var(--color-on-surface-variant);
        margin-bottom: var(--spacing-xs);
      }
      
      .form-control {
        width: 100%;
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-outline);
        background-color: var(--color-surface);
        transition: border-color var(--transition-normal);
      }
      
      .form-control:focus {
        outline: none;
        border-color: var(--color-primary);
      }
      
      .icon-picker {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-md);
      }
      
      .icon-option {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-outline);
        cursor: pointer;
        transition: all var(--transition-normal);
      }
      
      .icon-option:hover {
        background-color: var(--color-surface-variant);
      }
      
      .icon-option.selected {
        border-color: var(--color-primary);
        background-color: rgba(0, 113, 227, 0.1);
      }
      
      /* Radio buttons */
      .radio-group {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
      }
      
      .radio-wrapper {
        position: relative;
      }
      
      .radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .radio-label {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-full);
        border: 1px solid var(--color-outline);
        cursor: pointer;
        transition: all var(--transition-normal);
      }
      
      .radio:checked + .radio-label {
        border-color: var(--color-primary);
        background-color: rgba(0, 113, 227, 0.1);
      }
      
      .radio-circle {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1px solid var(--color-outline);
        position: relative;
      }
      
      .radio:checked + .radio-label .radio-circle:after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--color-primary);
      }
      
      /* Animações */
      @keyframes pop {
        0% {
          transform: scale(0.95);
          opacity: 0;
        }
        70% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      
      .animate-pop {
        animation: pop 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }
      
      /* Tema Toggle */
      .theme-toggle {
        position: relative;
        width: 50px;
        height: 26px;
        border-radius: var(--radius-full);
        background-color: var(--color-surface-variant);
        cursor: pointer;
        transition: background-color var(--transition-normal);
      }
      
      .theme-toggle::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: var(--color-surface);
        box-shadow: var(--shadow-sm);
        transition: transform var(--transition-normal);
      }
      
      [data-theme="dark"] .theme-toggle {
        background-color: var(--color-primary);
      }
      
      [data-theme="dark"] .theme-toggle::after {
        transform: translateX(24px);
      }
    }
  </style>
<!-- ===== FIM: PARTE 2 - CSS DE LAYOUT E COMPONENTES ================================ -->

<!-- ===== INICIO: PARTE 3 - CORPO + ESTRUTURA HTML ================================ -->
<body>
  <!-- SVG Sprite de ícones (HeroIcons) -->
  <svg style="display: none;">
    <!-- Ícones de navegação -->
    <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
    </symbol>
    <symbol id="icon-credit-card" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </symbol>
    
    <!-- Ícones de ações -->
    <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
    </symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
    </symbol>
    <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
    </symbol>
    <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </symbol>
    <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </symbol>
    <symbol id="icon-chevron-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
    </symbol>
    
    <!-- Ícones para categorias -->
    <symbol id="icon-shopping" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
    </symbol>
    <symbol id="icon-food" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
    </symbol>
    <symbol id="icon-home-category" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </symbol>
    <symbol id="icon-transport" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
    </symbol>
    <symbol id="icon-health" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
    </symbol>
    <symbol id="icon-education" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
    </symbol>
    <symbol id="icon-entertainment" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    <symbol id="icon-bill" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </symbol>
    <symbol id="icon-tax" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
    </symbol>
    <symbol id="icon-gift" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112.83 2.83l-2.83 2.83a2 2 0 01-2.83-2.83L12 8zm0 0V5.5A2.5 2.5 0 109.5 8H12zm0 0V5.5A2.5 2.5 0 1114.5 8H12zm0 0v0a2 2 0 114 0v0M6 8h.01M6 16h.01M2 8h.01M2 16h.01M18 8h.01M18 16h.01M22 8h.01M22 16h.01" />
    </symbol>
    
    <!-- Ícones para alertas e notificações -->
    <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </symbol>
    <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    <symbol id="icon-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
    </symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
    </symbol>
    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
    </symbol>
  </svg>

  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-filters">
        <div class="select-wrapper">
          <select id="yearSelect" class="select">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <svg class="select-icon" width="16" height="16">
            <use href="#icon-chevron-down"></use>
          </svg>
        </div>
        
        <div class="select-wrapper">
          <select id="monthSelect" class="select">
            <option value="0">Janeiro</option>
            <option value="1">Fevereiro</option>
            <option value="2">Março</option>
            <option value="3">Abril</option>
            <option value="4" selected>Maio</option>
            <option value="5">Junho</option>
            <option value="6">Julho</option>
            <option value="7">Agosto</option>
            <option value="8">Setembro</option>
            <option value="9">Outubro</option>
            <option value="10">Novembro</option>
            <option value="11">Dezembro</option>
          </select>
          <svg class="select-icon" width="16" height="16">
            <use href="#icon-chevron-down"></use>
          </svg>
        </div>
      </div>
      
      <div class="header-actions">
        <button id="newIncomeBtn" class="btn btn-success">
          <svg width="16" height="16">
            <use href="#icon-plus"></use>
          </svg>
          Nova Receita
        </button>
        
        <button id="newExpenseBtn" class="btn btn-danger">
          <svg width="16" height="16">
            <use href="#icon-plus"></use>
          </svg>
          Nova Despesa
        </button>
        
        <button id="cardsBtn" class="btn btn-outline">
          <svg width="16" height="16">
            <use href="#icon-credit-card"></use>
          </svg>
          Cartões
        </button>
        
        <div id="themeToggle" class="theme-toggle" role="button" aria-label="Alternar tema"></div>
      </div>
    </header>
    
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card kpi-balance">
        <div class="kpi-title">Saldo Atual</div>
        <div class="kpi-value" id="balanceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <svg width="16" height="16">
            <use href="#icon-info"></use>
          </svg>
          <span>Receitas recebidas - Despesas pagas</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-income">
        <div class="kpi-title">Receitas</div>
        <div class="kpi-value" id="incomeValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="incomeReceivedValue">R$ 0,00 recebidos</span> /
          <span id="incomePendingValue">R$ 0,00 pendentes</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-expense">
        <div class="kpi-title">Despesas</div>
        <div class="kpi-value" id="expenseValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="expensePaidValue">R$ 0,00 pagos</span> /
          <span id="expensePendingValue">R$ 0,00 pendentes</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-card-invoice">
        <div class="kpi-title">Fatura Atual</div>
        <div class="kpi-value" id="invoiceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <svg width="16" height="16">
            <use href="#icon-credit-card"></use>
          </svg>
          <span>Vencimento: <span id="invoiceDueDate">15/05/2025</span></span>
        </div>
      </div>
    </div>
    
    <!-- Insights Banner -->
    <div class="insights-banner" id="insightsBanner">
      <!-- Insights serão inseridos aqui dinamicamente -->
    </div>
    
    <!-- Charts Grid -->
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Despesas por Categoria</h3>
        <canvas id="catPie"></canvas>
      </div>
      
      <div class="chart-container">
        <h3>Limite do Cartão</h3>
        <canvas id="cardArea"></canvas>
      </div>
    </div>
    
    <!-- Annual Bars Chart -->
    <div class="chart-container">
      <h3>Receitas x Despesas (12 meses)</h3>
      <canvas id="annualBars"></canvas>
    </div>
    
    <!-- Compromissos Longos -->
    <div class="commitments">
      <div class="commitments-header" id="commitmentsHeader">
        <h3>Compromissos Longos</h3>
        <svg width="20" height="20">
          <use href="#icon-chevron-down"></use>
        </svg>
      </div>
      
      <div class="commitments-content" id="commitmentsContent">
        <!-- Compromissos serão inseridos aqui dinamicamente -->
      </div>
    </div>
    
    <!-- Tabela de Transações -->
    <div class="transactions">
      <h3>Transações</h3>
      <div class="transactions-table-wrapper">
        <table class="transactions-table" id="transactionsTable">
          <thead>
            <tr>
              <th></th>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Data</th>
              <th>Vencimento</th>
              <th>Valor</th>
              <th>Status</th>
              <th>Pagamento</th>
              <th>Pago?</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody">
            <!-- Transações serão inseridas aqui dinamicamente -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Modais -->
  <!-- Modal de Nova Receita -->
  <div class="modal-backdrop" id="incomeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Nova Receita</h2>
        <span class="modal-close" id="closeIncomeModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <form id="incomeForm">
          <div class="form-group">
            <label class="form-label">Ícone</label>
            <div class="icon-picker" id="incomeIconPicker">
              <div class="icon-option selected" data-icon="icon-gift">
                <svg width="20" height="20">
                  <use href="#icon-gift"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-home-category">
                <svg width="20" height="20">
                  <use href="#icon-home-category"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-tax">
                <svg width="20" height="20">
                  <use href="#icon-tax"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-info">
                <svg width="20" height="20">
                  <use href="#icon-info"></use>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="incomeName">Nome</label>
            <input type="text" class="form-control" id="incomeName" placeholder="Nome da receita">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="incomeAmount">Valor</label>
            <input type="number" class="form-control" id="incomeAmount" placeholder="0,00" min="0" step="0.01">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="incomeCategory">Categoria</label>
            <div class="select-wrapper">
              <select class="select" id="incomeCategory">
                <option value="salario">Salário</option>
                <option value="investimentos">Investimentos</option>
                <option value="freelance">Freelance</option>
                <option value="presente">Presente</option>
                <option value="outros">Outros</option>
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="incomeDate">Data de Lançamento</label>
            <input type="date" class="form-control" id="incomeDate">
          </div>
          
          <div class="form-group">
            <label class="form-label">Status</label>
            <div class="radio-group">
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusReceived" name="incomeStatus" value="received" checked>
                <label class="radio-label" for="incomeStatusReceived">
                  <span class="radio-circle"></span>
                  Recebido
                </label>
              </div>
              
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusPending" name="incomeStatus" value="pending">
                <label class="radio-label" for="incomeStatusPending">
                  <span class="radio-circle"></span>
                  A Receber
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="incomePaymentMethod">Forma de Recebimento</label>
            <div class="select-wrapper">
              <select class="select" id="incomePaymentMethod">
                <option value="pix">Pix</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="transferencia">Transferência Bancária</option>
                <option value="outros">Outros</option>
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="incomeIsRecurrent">
              <label class="checkbox-label" for="incomeIsRecurrent"></label>
            </div>
            <label class="form-label" for="incomeIsRecurrent" style="display: inline-block; margin-left: 8px;">Receita Recorrente</label>
          </div>
          
          <div class="form-group" id="incomeRecurrenceGroup" style="display: none;">
            <label class="form-label" for="incomeInstallments">Quantidade de Parcelas</label>
            <input type="number" class="form-control" id="incomeInstallments" min="2" value="2">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="incomeNotes">Observação (opcional)</label>
            <textarea class="form-control" id="incomeNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelIncomeBtn">Cancelar</button>
        <button class="btn btn-success" id="saveIncomeBtn">Salvar Receita</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Nova Despesa -->
  <div class="modal-backdrop" id="expenseModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Nova Despesa</h2>
        <span class="modal-close" id="closeExpenseModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <form id="expenseForm">
          <div class="form-group">
            <label class="form-label">Ícone</label>
            <div class="icon-picker" id="expenseIconPicker">
              <div class="icon-option selected" data-icon="icon-shopping">
                <svg width="20" height="20">
                  <use href="#icon-shopping"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-food">
                <svg width="20" height="20">
                  <use href="#icon-food"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-home-category">
                <svg width="20" height="20">
                  <use href="#icon-home-category"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-transport">
                <svg width="20" height="20">
                  <use href="#icon-transport"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-health">
                <svg width="20" height="20">
                  <use href="#icon-health"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-education">
                <svg width="20" height="20">
                  <use href="#icon-education"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-entertainment">
                <svg width="20" height="20">
                  <use href="#icon-entertainment"></use>
                </svg>
              </div>
              <div class="icon-option" data-icon="icon-bill">
                <svg width="20" height="20">
                  <use href="#icon-bill"></use>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="expenseName">Nome</label>
            <input type="text" class="form-control" id="expenseName" placeholder="Nome da despesa">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="expenseAmount">Valor</label>
            <input type="number" class="form-control" id="expenseAmount" placeholder="0,00" min="0" step="0.01">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="expenseCategory">Categoria</label>
            <div class="select-wrapper">
              <select class="select" id="expenseCategory">
                <option value="alimentacao">Alimentação</option>
                <option value="moradia">Moradia</option>
                <option value="transporte">Transporte</option>
                <option value="saude">Saúde</option>
                <option value="educacao">Educação</option>
                <option value="lazer">Lazer</option>
                <option value="compras">Compras</option>
                <option value="contas">Contas e serviços</option>
                <option value="impostos">Impostos</option>
                <option value="outros">Outros</option>
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="expenseDate">Data de Lançamento</label>
            <input type="date" class="form-control" id="expenseDate">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="expenseDueDate">Data de Vencimento</label>
            <input type="date" class="form-control" id="expenseDueDate">
          </div>
          
          <div class="form-group">
            <label class="form-label">Status</label>
            <div class="radio-group">
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="expenseStatusPaid" name="expenseStatus" value="paid">
                <label class="radio-label" for="expenseStatusPaid">
                  <span class="radio-circle"></span>
                  Pago
                </label>
              </div>
              
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="expenseStatusPending" name="expenseStatus" value="pending" checked>
                <label class="radio-label" for="expenseStatusPending">
                  <span class="radio-circle"></span>
                  Pendente
                </label>
              </div>
              
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="expenseStatusScheduled" name="expenseStatus" value="scheduled">
                <label class="radio-label" for="expenseStatusScheduled">
                  <span class="radio-circle"></span>
                  Agendado
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-group" id="scheduledDateGroup" style="display: none;">
            <label class="form-label" for="expenseScheduledDate">Data de Agendamento</label>
            <input type="date" class="form-control" id="expenseScheduledDate">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="expensePaymentMethod">Forma de Pagamento</label>
            <div class="select-wrapper">
              <select class="select" id="expensePaymentMethod">
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">Pix</option>
                <option value="debito">Débito</option>
                <option value="debito_conta">Débito em Conta</option>
                <option value="transferencia">Transferência Bancária</option>
                <option value="boleto">Boleto</option>
                <option value="credito">Crédito</option>
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group" id="creditCardGroup" style="display: none;">
            <label class="form-label" for="expenseCreditCard">Cartão de Crédito</label>
            <div class="select-wrapper">
              <select class="select" id="expenseCreditCard">
                <!-- Opções de cartões serão inseridas dinamicamente -->
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="expenseIsRecurrent">
              <label class="checkbox-label" for="expenseIsRecurrent"></label>
            </div>
            <label class="form-label" for="expenseIsRecurrent" style="display: inline-block; margin-left: 8px;">Despesa Recorrente</label>
          </div>
          
          <div class="form-group" id="expenseRecurrenceGroup" style="display: none;">
            <label class="form-label" for="expenseInstallments">Quantidade de Parcelas</label>
            <input type="number" class="form-control" id="expenseInstallments" min="2" value="2">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="expenseNotes">Observação (opcional)</label>
            <textarea class="form-control" id="expenseNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelExpenseBtn">Cancelar</button>
        <button class="btn btn-danger" id="saveExpenseBtn">Salvar Despesa</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Edição de Transação -->
  <div class="modal-backdrop" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="editModalTitle">Editar Transação</h2>
        <span class="modal-close" id="closeEditModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="editTransactionId">
          <input type="hidden" id="editTransactionType">
          
          <div class="form-group">
            <label class="form-label">Ícone</label>
            <div class="icon-picker" id="editIconPicker">
              <!-- Opções de ícones serão inseridas dinamicamente -->
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="editName">Nome</label>
            <input type="text" class="form-control" id="editName">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="editAmount">Valor</label>
            <input type="number" class="form-control" id="editAmount" min="0" step="0.01">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="editCategory">Categoria</label>
            <div class="select-wrapper">
              <select class="select" id="editCategory">
                <!-- Opções de categorias serão inseridas dinamicamente -->
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="editDate">Data de Lançamento</label>
            <input type="date" class="form-control" id="editDate">
          </div>
          
          <div class="form-group" id="editDueDateGroup">
            <label class="form-label" for="editDueDate">Data de Vencimento</label>
            <input type="date" class="form-control" id="editDueDate">
          </div>
          
          <div class="form-group">
            <label class="form-label">Status</label>
            <div class="radio-group" id="editStatusGroup">
              <!-- Opções de status serão inseridas dinamicamente -->
            </div>
          </div>
          
          <div class="form-group" id="editScheduledDateGroup" style="display: none;">
            <label class="form-label" for="editScheduledDate">Data de Agendamento</label>
            <input type="date" class="form-control" id="editScheduledDate">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="editPaymentMethod">Forma de Pagamento</label>
            <div class="select-wrapper">
              <select class="select" id="editPaymentMethod">
                <!-- Opções de formas de pagamento serão inseridas dinamicamente -->
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group" id="editCreditCardGroup" style="display: none;">
            <label class="form-label" for="editCreditCard">Cartão de Crédito</label>
            <div class="select-wrapper">
              <select class="select" id="editCreditCard">
                <!-- Opções de cartões serão inseridas dinamicamente -->
              </select>
              <svg class="select-icon" width="16" height="16">
                <use href="#icon-chevron-down"></use>
              </svg>
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="editIsRecurrent">
              <label class="checkbox-label" for="editIsRecurrent"></label>
            </div>
            <label class="form-label" for="editIsRecurrent" style="display: inline-block; margin-left: 8px;">Transação Recorrente</label>
          </div>
          
          <div class="form-group" id="editRecurrenceGroup" style="display: none;">
            <label class="form-label" for="editInstallments">Quantidade de Parcelas</label>
            <input type="number" class="form-control" id="editInstallments" min="2" value="2">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="editNotes">Observação (opcional)</label>
            <textarea class="form-control" id="editNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelEditBtn">Cancelar</button>
        <button class="btn btn-primary" id="saveEditBtn">Salvar Alterações</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Cartões -->
  <div class="modal-backdrop" id="cardsListModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Cartões</h2>
        <span class="modal-close" id="closeCardsListModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <div id="cardsList">
          <!-- Cards serão inseridos aqui dinamicamente -->
        </div>
        
        <button class="btn btn-primary" id="newCardBtn" style="margin-top: var(--spacing-md);">
          <svg width="16" height="16">
            <use href="#icon-plus"></use>
          </svg>
          Novo Cartão
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Novo Cartão -->
  <div class="modal-backdrop" id="newCardModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Novo Cartão</h2>
        <span class="modal-close" id="closeNewCardModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <form id="cardForm">
          <div class="form-group">
            <label class="form-label" for="cardName">Nome do Cartão</label>
            <input type="text" class="form-control" id="cardName" placeholder="Ex: Nubank">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="cardLimit">Limite Total</label>
            <input type="number" class="form-control" id="cardLimit" placeholder="0,00" min="0" step="0.01">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="cardClosingDay">Dia de Fechamento</label>
            <input type="number" class="form-control" id="cardClosingDay" placeholder="1-31" min="1" max="31">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="cardDueDay">Dia de Vencimento</label>
            <input type="number" class="form-control" id="cardDueDay" placeholder="1-31" min="1" max="31">
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelCardBtn">Cancelar</button>
        <button class="btn btn-primary" id="saveCardBtn">Salvar Cartão</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Fatura do Cartão -->
  <div class="modal-backdrop" id="cardInvoiceModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title" id="cardInvoiceTitle">Fatura do Cartão</h2>
        <span class="modal-close" id="closeCardInvoiceModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <div class="card" style="margin-bottom: var(--spacing-md);">
          <div id="cardInvoiceDetails">
            <!-- Detalhes da fatura serão inseridos aqui dinamicamente -->
          </div>
        </div>
        
        <h3>Despesas desta Fatura</h3>
        <table class="transactions-table" id="cardInvoiceTable">
          <thead>
            <tr>
              <th></th>
              <th>Nome</th>
              <th>Data</th>
              <th>Valor</th>
              <th>Pago?</th>
            </tr>
          </thead>
          <tbody id="cardInvoiceTableBody">
            <!-- Despesas da fatura serão inseridas aqui dinamicamente -->
          </tbody>
        </table>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" id="backToCardsBtn">Voltar</button>
        <button class="btn btn-primary" id="payInvoiceBtn">Pagar Fatura</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Confirmação de Exclusão -->
  <div class="modal-backdrop" id="deleteConfirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">
          <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;">
            <use href="#icon-alert"></use>
          </svg>
          Confirmar Exclusão
        </h2>
        <span class="modal-close" id="closeDeleteConfirmModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <p>Você deseja realmente excluir esta transação? Esta ação é irreversível.</p>
        
        <div id="recurrenceDeleteOptions" style="display: none; margin-top: var(--spacing-md);">
          <p><strong>Esta é uma transação recorrente. O que deseja fazer?</strong></p>
          
          <div class="radio-group" style="flex-direction: column; gap: var(--spacing-sm);">
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="deleteSingle" name="deleteOption" value="single" checked>
              <label class="radio-label" for="deleteSingle">
                <span class="radio-circle"></span>
                Excluir apenas esta parcela
              </label>
            </div>
            
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="deleteAllFuture" name="deleteOption" value="future">
              <label class="radio-label" for="deleteAllFuture">
                <span class="radio-circle"></span>
                Excluir todas as parcelas futuras
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelDeleteBtn">Cancelar</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Confirmação de Pagamento de Fatura -->
  <div class="modal-backdrop" id="payInvoiceConfirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">
          <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;">
            <use href="#icon-credit-card"></use>
          </svg>
          Pagar Fatura do Cartão
        </h2>
        <span class="modal-close" id="closePayInvoiceConfirmModal">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </span>
      </div>
      
      <div class="modal-body">
        <p>Confirmar pagamento de todas as despesas desta fatura?</p>
        <p style="margin-top: var(--spacing-xs);">Total: <strong id="invoiceConfirmAmount">R$ 0,00</strong></p>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelPayInvoiceBtn">Cancelar</button>
        <button class="btn btn-primary" id="confirmPayInvoiceBtn">Pagar</button>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer">
    <!-- Toasts serão inseridos aqui dinamicamente -->
  </div>
<!-- ===== FIM: PARTE 3 - CORPO + ESTRUTURA HTML ================================ -->

<!-- ===== INICIO: PARTE 4 - INÍCIO DO SCRIPT ================================ -->
<script>
  // Helpers DOM
  const $ = selector => document.querySelector(selector);
  const $$ = selector => document.querySelectorAll(selector);
  
  // Estado global da aplicação
  const state = {
    year: 2025,
    month: 4, // Maio (0-indexed)
    transactions: [],
    cards: [],
    filteredTransactions: [],
    insights: [],
    currentTransaction: null,
    currentCard: null,
    themePreference: 'light',
    icons: {
      income: {
        "salario": "icon-tax",
        "investimentos": "icon-chart",
        "freelance": "icon-tax",
        "presente": "icon-gift",
        "outros": "icon-info"
      },
      expense: {
        "alimentacao": "icon-food",
        "moradia": "icon-home-category",
        "transporte": "icon-transport",
        "saude": "icon-health",
        "educacao": "icon-education",
        "lazer": "icon-entertainment",
        "compras": "icon-shopping",
        "contas": "icon-bill",
        "impostos": "icon-tax",
        "outros": "icon-info"
      }
    }
  };
  
  // Formatadores
  const formatCurrency = value => {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value);
  };
  
  const formatDate = (date, options = {}) => {
    const dateObj = date instanceof Date ? date : new Date(date);
    return dateObj.toLocaleDateString('pt-BR', options);
  };
  
  // Função de tema claro/escuro
  const toggleTheme = () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    state.themePreference = newTheme;
    
    // Armazenar preferência em localStorage
    localStorage.setItem('themePreference', newTheme);
    
    // Atualizar gráficos com as cores corretas
    updateCharts();
  };
  
  // Verificar a preferência de tema do usuário
  const initTheme = () => {
    const savedTheme = localStorage.getItem('themePreference');
    if (savedTheme) {
      document.documentElement.setAttribute('data-theme', savedTheme);
      state.themePreference = savedTheme;
    } else {
      // Verificar preferência do sistema
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
        state.themePreference = 'dark';
      }
    }
    
    // Listener para o botão de alternar tema
    $('#themeToggle').addEventListener('click', toggleTheme);
  };
  
  // Configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDvL_nYWhv_8rPouejiWbDZtDCKHYOQyEY",
    authDomain: "calculadora-da-familia.firebaseapp.com",
    projectId: "calculadora-da-familia",
    storageBucket: "calculadora-da-familia.appspot.com",
    messagingSenderId: "69721783786",
    appId: "1:69721783786:web:c4703b5c182e3681e8c693",
    measurementId: "G-YM5TR661S6"
  };
  
  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  // IDs únicos
  const generateId = () => {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  };
  
  // Toast notifications
  const showToast = (message, type = 'success') => {
    const toastContainer = $('#toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    let iconName = '';
    switch (type) {
      case 'success':
        iconName = 'icon-check';
        break;
      case 'error':
        iconName = 'icon-x';
        break;
      case 'warning':
        iconName = 'icon-alert';
        break;
      case 'info':
        iconName = 'icon-info';
        break;
    }
    
    toast.innerHTML = `
      <div class="toast-icon">
        <svg width="24" height="24">
          <use href="#${iconName}"></use>
        </svg>
      </div>
      <div class="toast-content">${message}</div>
      <span class="toast-close">
        <svg width="16" height="16">
          <use href="#icon-x"></use>
        </svg>
      </span>
    `;
    
    toastContainer.appendChild(toast);
    
    // Animação
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);
    
    // Fechar toast ao clicar no X
    toast.querySelector('.toast-close').addEventListener('click', () => {
      toast.classList.remove('show');
      setTimeout(() => {
        toast.remove();
      }, 300);
    });
    
    // Auto fechar após 5 segundos
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }
    }, 5000);
  };
  
  // Funções para manipulação de modais
  const openModal = modalId => {
    const modal = $(`#${modalId}`);
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  };
  
  const closeModal = modalId => {
    const modal = $(`#${modalId}`);
    modal.classList.remove('active');
    document.body.style.overflow = '';
  };
  
  const closeAllModals = () => {
    $$('.modal-backdrop').forEach(modal => {
      modal.classList.remove('active');
    });
    document.body.style.overflow = '';
  };
  
  // Manipulação de date inputs
  const setDateInputValue = (inputId, date) => {
    const input = $(`#${inputId}`);
    const dateObj = date instanceof Date ? date : new Date(date);
    
    // Formato YYYY-MM-DD para inputs de data
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    
    input.value = `${year}-${month}-${day}`;
  };
  
  const getDateInputValue = inputId => {
    const input = $(`#${inputId}`);
    return input.value ? new Date(input.value) : null;
  };
  
  // CRUD de transações no Firestore
  const loadTransactions = async () => {
    try {
      const snapshot = await db.collection('transactions').get();
      state.transactions = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      filterTransactionsByMonth();
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
      renderCommitments();
      generateInsights();
      
    } catch (error) {
      console.error('Erro ao carregar transações:', error);
      showToast('Erro ao carregar transações. Tente novamente.', 'error');
    }
  };
  
  const addTransaction = async transaction => {
    try {
      // Adicionar ID único
      transaction.id = generateId();
      
      // Adicionar data de criação
      transaction.createdAt = new Date();
      
      // Salvar no Firestore
      await db.collection('transactions').doc(transaction.id).set(transaction);
      
      // Adicionar ao state
      state.transactions.push(transaction);
      
      // Atualizar a UI
      filterTransactionsByMonth();
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
      renderCommitments();
      generateInsights();
      
      // Feedback
      showToast(
        transaction.type === 'income' 
          ? 'Receita adicionada com sucesso!' 
          : 'Despesa adicionada com sucesso!',
        'success'
      );
      
      return transaction;
      
    } catch (error) {
      console.error('Erro ao adicionar transação:', error);
      showToast('Erro ao salvar. Tente novamente.', 'error');
      return null;
    }
  };
  
  const updateTransaction = async (id, updates) => {
    try {
      // Atualizar no Firestore
      await db.collection('transactions').doc(id).update(updates);
      
      // Atualizar no state
      const index = state.transactions.findIndex(t => t.id === id);
      if (index !== -1) {
        state.transactions[index] = { ...state.transactions[index], ...updates };
      }
      
      // Atualizar a UI
      filterTransactionsByMonth();
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
      renderCommitments();
      generateInsights();
      
      // Feedback
      showToast('Transação atualizada com sucesso!', 'success');
      
      return true;
      
    } catch (error) {
      console.error('Erro ao atualizar transação:', error);
      showToast('Erro ao atualizar. Tente novamente.', 'error');
      return false;
    }
  };
  
  const deleteTransaction = async (id, deleteOption = 'single') => {
    try {
      // Buscar transação
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return false;
      
      // Se for recorrente e a opção for excluir todas futuras
      if (transaction.isRecurrent && transaction.recurrenceId && deleteOption === 'future') {
        // Encontrar todas as transações futuras com o mesmo ID de recorrência
        const currentDate = new Date();
        const futureTransactions = state.transactions.filter(t => 
          t.recurrenceId === transaction.recurrenceId && 
          new Date(t.date) >= currentDate
        );
        
        // Excluir todas as transações futuras
        const batch = db.batch();
        futureTransactions.forEach(t => {
          batch.delete(db.collection('transactions').doc(t.id));
        });
        
        await batch.commit();
        
        // Remover do state
        state.transactions = state.transactions.filter(t => 
          !(t.recurrenceId === transaction.recurrenceId && new Date(t.date) >= currentDate)
        );
        
      } else {
        // Excluir apenas a transação selecionada
        await db.collection('transactions').doc(id).delete();
        
        // Remover do state
        state.transactions = state.transactions.filter(t => t.id !== id);
      }
      
      // Atualizar a UI
      filterTransactionsByMonth();
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
      renderCommitments();
      generateInsights();
      
      // Feedback
      showToast('Transação excluída com sucesso!', 'success');
      
      return true;
      
    } catch (error) {
      console.error('Erro ao excluir transação:', error);
      showToast('Erro ao excluir. Tente novamente.', 'error');
      return false;
    }
  };
  
  // CRUD de cartões no Firestore
  const loadCards = async () => {
    try {
      const snapshot = await db.collection('cards').get();
      state.cards = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      updateCardSelects();
      updateCardsList();
      
    } catch (error) {
      console.error('Erro ao carregar cartões:', error);
      showToast('Erro ao carregar cartões. Tente novamente.', 'error');
    }
  };
  
  const addCard = async card => {
    try {
      // Adicionar ID único
      card.id = generateId();
      
      // Inicializar limite disponível igual ao limite total
      card.availableLimit = card.limit;
      
      // Adicionar data de criação
      card.createdAt = new Date();
      
      // Salvar no Firestore
      await db.collection('cards').doc(card.id).set(card);
      
      // Adicionar ao state
      state.cards.push(card);
      
      // Atualizar a UI
      updateCardSelects();
      updateCardsList();
      
      // Feedback
      showToast('Cartão adicionado com sucesso!', 'success');
      
      return card;
      
    } catch (error) {
      console.error('Erro ao adicionar cartão:', error);
      showToast('Erro ao salvar cartão. Tente novamente.', 'error');
      return null;
    }
  };
  
  const updateCard = async (id, updates) => {
    try {
      // Atualizar no Firestore
      await db.collection('cards').doc(id).update(updates);
      
      // Atualizar no state
      const index = state.cards.findIndex(c => c.id === id);
      if (index !== -1) {
        state.cards[index] = { ...state.cards[index], ...updates };
      }
      
      // Atualizar a UI
      updateCardSelects();
      updateCardsList();
      
      // Feedback
      showToast('Cartão atualizado com sucesso!', 'success');
      
      return true;
      
    } catch (error) {
      console.error('Erro ao atualizar cartão:', error);
      showToast('Erro ao atualizar cartão. Tente novamente.', 'error');
      return false;
    }
  };
  
  const deleteCard = async id => {
    try {
      // Verificar se existem transações associadas ao cartão
      const hasTransactions = state.transactions.some(t => 
        t.paymentMethod === 'credito' && t.creditCardId === id
      );
      
      if (hasTransactions) {
        showToast('Não é possível excluir um cartão com transações associadas.', 'error');
        return false;
      }
      
      // Excluir do Firestore
      await db.collection('cards').doc(id).delete();
      
      // Remover do state
      state.cards = state.cards.filter(c => c.id !== id);
      
      // Atualizar a UI
      updateCardSelects();
      updateCardsList();
      
      // Feedback
      showToast('Cartão excluído com sucesso!', 'success');
      
      return true;
      
    } catch (error) {
      console.error('Erro ao excluir cartão:', error);
      showToast('Erro ao excluir cartão. Tente novamente.', 'error');
      return false;
    }
  };
<!-- ===== FIM: PARTE 4 - INÍCIO DO SCRIPT ================================ -->

<!-- ===== INICIO: PARTE 5A - LÓGICA JAVASCRIPT ================================ -->
  // Filtrar transações pelo mês e ano selecionados
  const filterTransactionsByMonth = () => {
    const startDate = new Date(state.year, state.month, 1);
    const endDate = new Date(state.year, state.month + 1, 0);
    
    state.filteredTransactions = state.transactions.filter(transaction => {
      // Se for agendado, filtrar pela data de agendamento
      if (transaction.status === 'scheduled') {
        const scheduledDate = new Date(transaction.scheduledDate);
        return (
          scheduledDate.getMonth() === state.month &&
          scheduledDate.getFullYear() === state.year
        );
      }
      
      // Caso contrário, filtrar pela data de lançamento
      const transactionDate = new Date(transaction.date);
      return (
        transactionDate.getMonth() === state.month &&
        transactionDate.getFullYear() === state.year
      );
    });
  };
  
  // Atualizar o título do mês e ano
  const updateMonthYearTitle = () => {
    const months = [
      'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    
    $('#monthSelect').value = state.month;
    $('#yearSelect').value = state.year;
  };
  
  // Atualizar os KPIs
  const updateKPIs = () => {
    // Calcular totais
    const totals = state.filteredTransactions.reduce((acc, transaction) => {
      if (transaction.type === 'income') {
        acc.income += parseFloat(transaction.amount);
        
        if (transaction.status === 'received' || transaction.status === 'paid') {
          acc.incomeReceived += parseFloat(transaction.amount);
        } else {
          acc.incomePending += parseFloat(transaction.amount);
        }
      } else {
        acc.expense += parseFloat(transaction.amount);
        
        if (transaction.status === 'paid') {
          acc.expensePaid += parseFloat(transaction.amount);
        } else {
          acc.expensePending += parseFloat(transaction.amount);
        }
      }
      
      return acc;
    }, {
      income: 0,
      incomeReceived: 0,
      incomePending: 0,
      expense: 0,
      expensePaid: 0,
      expensePending: 0
    });
    
    // Calcular saldo atual (receitas recebidas - despesas pagas)
    const balance = totals.incomeReceived - totals.expensePaid;
    
    // Atualizar os valores na UI
    $('#balanceValue').textContent = formatCurrency(balance);
    $('#incomeValue').textContent = formatCurrency(totals.income);
    $('#incomeReceivedValue').textContent = formatCurrency(totals.incomeReceived) + ' recebidos';
    $('#incomePendingValue').textContent = formatCurrency(totals.incomePending) + ' pendentes';
    $('#expenseValue').textContent = formatCurrency(totals.expense);
    $('#expensePaidValue').textContent = formatCurrency(totals.expensePaid) + ' pagos';
    $('#expensePendingValue').textContent = formatCurrency(totals.expensePending) + ' pendentes';
    
    // Atualizar classe dos valores com base no saldo
    if (balance > 0) {
      $('#balanceValue').classList.add('text-success');
      $('#balanceValue').classList.remove('text-danger');
    } else if (balance < 0) {
      $('#balanceValue').classList.add('text-danger');
      $('#balanceValue').classList.remove('text-success');
    } else {
      $('#balanceValue').classList.remove('text-success', 'text-danger');
    }
    
    // Calcular faturas dos cartões
    calculateCardInvoices();
  };
  
  // Calcular faturas de todos os cartões
  const calculateCardInvoices = () => {
    if (state.cards.length === 0) {
      $('#invoiceValue').textContent = formatCurrency(0);
      $('#invoiceDueDate').textContent = 'N/A';
      return;
    }
    
    // Reset available limits
    state.cards.forEach(card => {
      card.availableLimit = card.limit;
      card.currentInvoice = 0;
    });
    
    // Calculate credit card expenses
    state.transactions.forEach(transaction => {
      if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        if (card) {
          const amount = parseFloat(transaction.amount);
          
          // Update available limit
          if (transaction.status !== 'paid') {
            card.availableLimit = Math.max(0, card.availableLimit - amount);
          }
          
          // Check if transaction is in current invoice
          const transactionDate = new Date(transaction.date);
          const today = new Date();
          
          // Set closing date for current month
          const closingDate = new Date(today.getFullYear(), today.getMonth(), card.closingDay);
          
          // If today is after closing day, the due date will be next month
          if (today > closingDate) {
            closingDate.setMonth(closingDate.getMonth() + 1);
          }
          
          // Previous month closing date
          const previousClosing = new Date(closingDate);
          previousClosing.setMonth(previousClosing.getMonth() - 1);
          
          // Check if transaction is in current invoice period
          if (transactionDate >= previousClosing && transactionDate < closingDate) {
            card.currentInvoice += amount;
          }
        }
      }
    });
    
    // Update UI with first card's information
    const mainCard = state.cards[0];
    if (mainCard) {
      $('#invoiceValue').textContent = formatCurrency(mainCard.currentInvoice);
      
      // Calculate due date
      const today = new Date();
      let dueDate = new Date(today.getFullYear(), today.getMonth(), mainCard.dueDay);
      
      // If today is after due day, the due date will be next month
      if (today.getDate() > mainCard.dueDay) {
        dueDate.setMonth(dueDate.getMonth() + 1);
      }
      
      $('#invoiceDueDate').textContent = formatDate(dueDate);
      
      // Update cards in Firebase
      updateCardsInFirestore();
    }
  };
  
  // Atualizar cartões no Firestore
  const updateCardsInFirestore = async () => {
    try {
      const batch = db.batch();
      
      state.cards.forEach(card => {
        const cardRef = db.collection('cards').doc(card.id);
        batch.update(cardRef, {
          availableLimit: card.availableLimit,
          currentInvoice: card.currentInvoice
        });
      });
      
      await batch.commit();
    } catch (error) {
      console.error('Erro ao atualizar cartões:', error);
    }
  };
  
  // Atualizar a tabela de transações
  const updateTransactionsTable = () => {
    const tableBody = $('#transactionsTableBody');
    tableBody.innerHTML = '';
    
    // Ordenar transações por data (mais recentes primeiro)
    const sortedTransactions = [...state.filteredTransactions].sort((a, b) => {
      return new Date(b.date) - new Date(a.date);
    });
    
    if (sortedTransactions.length === 0) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = `
        <td colspan="10" style="text-align: center; padding: var(--spacing-xl);">
          Nenhuma transação encontrada para este mês.
        </td>
      `;
      tableBody.appendChild(emptyRow);
      return;
    }
    
    sortedTransactions.forEach(transaction => {
      const row = document.createElement('tr');
      
      // Verificar se está vencida e não está paga
      const isDue = transaction.type === 'expense' && 
                   transaction.status !== 'paid' && 
                   new Date(transaction.dueDate) < new Date();
      
      // Determinar o ícone com base na categoria
      const iconMap = transaction.type === 'income' ? state.icons.income : state.icons.expense;
      const iconKey = transaction.icon || (iconMap[transaction.category] || 'icon-info');
      
      // Status badge
      let statusBadgeClass = '';
      let statusText = '';
      
      if (transaction.type === 'income') {
        if (transaction.status === 'received' || transaction.status === 'paid') {
          statusBadgeClass = 'badge-success';
          statusText = 'Recebido';
        } else {
          statusBadgeClass = 'badge-warning';
          statusText = 'A Receber';
        }
      } else {
        if (transaction.status === 'paid') {
          statusBadgeClass = 'badge-success';
          statusText = 'Pago';
        } else if (transaction.status === 'scheduled') {
          statusBadgeClass = 'badge-info';
          statusText = 'Agendado';
        } else {
          statusBadgeClass = isDue ? 'badge-danger' : 'badge-warning';
          statusText = isDue ? 'Vencido' : 'Pendente';
        }
      }
      
      row.innerHTML = `
        <td>
          <div class="transaction-icon" style="background-color: ${transaction.type === 'income' ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; color: ${transaction.type === 'income' ? 'var(--color-income)' : 'var(--color-expense)'};">
            <svg width="20" height="20">
              <use href="#${iconKey}"></use>
            </svg>
          </div>
        </td>
        <td>${transaction.name}</td>
        <td>${transaction.category}</td>
        <td>${formatDate(transaction.date)}</td>
        <td>${transaction.dueDate ? formatDate(transaction.dueDate) : '-'}</td>
        <td style="${isDue ? 'color: var(--color-error);' : ''}">${formatCurrency(transaction.amount)}${isDue ? ' 🔔' : ''}</td>
        <td><span class="badge ${statusBadgeClass}">${statusText}</span></td>
        <td>${transaction.paymentMethod}${transaction.paymentMethod === 'credito' && transaction.creditCardName ? ` (${transaction.creditCardName})` : ''}</td>
        <td>
          <div class="checkbox-wrapper">
            <input type="checkbox" class="checkbox transaction-paid-checkbox" id="paid-${transaction.id}" 
                  ${(transaction.status === 'paid' || transaction.status === 'received') ? 'checked' : ''}
                  data-id="${transaction.id}" data-type="${transaction.type}">
            <label class="checkbox-label" for="paid-${transaction.id}"></label>
          </div>
        </td>
        <td class="actions-cell">
          <button class="btn btn-icon btn-outline edit-transaction-btn" data-id="${transaction.id}">
            <svg width="16" height="16">
              <use href="#icon-edit"></use>
            </svg>
          </button>
          <button class="btn btn-icon btn-outline delete-transaction-btn" data-id="${transaction.id}" data-recurrent="${transaction.isRecurrent}">
            <svg width="16" height="16">
              <use href="#icon-trash"></use>
            </svg>
          </button>
        </td>
      `;
      
      tableBody.appendChild(row);
    });
    
    // Adicionar event listeners para os botões de ação
    addTableActionListeners();
  };
  
  // Adicionar event listeners para os botões da tabela de transações
  const addTableActionListeners = () => {
    // Checkboxes de pagamento
    $$('.transaction-paid-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', e => {
        const id = e.target.dataset.id;
        const type = e.target.dataset.type;
        const isChecked = e.target.checked;
        
        const status = type === 'income' 
          ? (isChecked ? 'received' : 'pending')
          : (isChecked ? 'paid' : 'pending');
        
        updateTransaction(id, { status });
      });
    });
    
    // Botões de edição
    $$('.edit-transaction-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const transaction = state.transactions.find(t => t.id === id);
        
        if (transaction) {
          state.currentTransaction = transaction;
          openEditModal(transaction);
        }
      });
    });
    
    // Botões de exclusão
    $$('.delete-transaction-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const isRecurrent = e.currentTarget.dataset.recurrent === 'true';
        
        state.currentTransaction = state.transactions.find(t => t.id === id);
        
        // Exibir opções de recorrência se aplicável
        $('#recurrenceDeleteOptions').style.display = isRecurrent ? 'block' : 'none';
        
        openModal('deleteConfirmModal');
      });
    });
  };
  
  // Gerar insights
  const generateInsights = () => {
    state.insights = [];
    const today = new Date();
    
    // Verificar cartões com fatura > 70% do limite
    state.cards.forEach(card => {
      if ((card.currentInvoice / card.limit) >= 0.7) {
        state.insights.push({
          id: generateId(),
          level: 'danger',
          message: `Fatura do cartão ${card.name} está em ${Math.round((card.currentInvoice / card.limit) * 100)}% do limite`,
          actionText: 'Ver fatura',
          action: () => openCardInvoice(card.id),
          icon: 'icon-credit-card',
          seen: false
        });
      }
    });
    
    // Verificar receitas pendentes vencidas
    const overdueIncomes = state.transactions.filter(t => 
      t.type === 'income' && 
      t.status !== 'received' && 
      new Date(t.dueDate) < today
    );
    
    if (overdueIncomes.length > 0) {
      state.insights.push({
        id: generateId(),
        level: 'danger',
        message: `Você tem ${overdueIncomes.length} receita${overdueIncomes.length > 1 ? 's' : ''} pendente${overdueIncomes.length > 1 ? 's' : ''} vencida${overdueIncomes.length > 1 ? 's' : ''}`,
        actionText: 'Marcar recebido',
        action: () => filterPendingIncomes(),
        icon: 'icon-alert',
        seen: false
      });
    }
    
    // Verificar despesas duplicadas suspeitas
    const groupedExpenses = state.transactions.reduce((acc, t) => {
      if (t.type === 'expense') {
        const key = `${t.name}-${t.amount}-${t.date}`;
        if (!acc[key]) {
          acc[key] = [];
        }
        acc[key].push(t);
      }
      return acc;
    }, {});
    
    const duplicates = Object.values(groupedExpenses).filter(group => group.length > 1);
    
    if (duplicates.length > 0) {
      state.insights.push({
        id: generateId(),
        level: 'warning',
        message: `Encontradas ${duplicates.length} possíveis despesas duplicadas`,
        actionText: 'Verificar',
        action: () => showDuplicatesModal(duplicates),
        icon: 'icon-alert',
        seen: false
      });
    }
    
    // Calcular gasto médio diário
    const currentMonthExpenses = state.filteredTransactions.filter(t => 
      t.type === 'expense' && t.status === 'paid'
    ).reduce((sum, t) => sum + parseFloat(t.amount), 0);
    
    const daysInMonth = new Date(state.year, state.month + 1, 0).getDate();
    const dayOfMonth = Math.min(today.getDate(), daysInMonth);
    const dailyAverage = dayOfMonth > 0 ? currentMonthExpenses / dayOfMonth : 0;
    
    // Calcular média de 90 dias (3 meses anteriores)
    let last90DaysTotal = 0;
    let daysCount = 0;
    
    for (let i = 1; i <= 3; i++) {
      const prevMonth = new Date(state.year, state.month - i, 1);
      const prevMonthYear = prevMonth.getFullYear();
      const prevMonthMonth = prevMonth.getMonth();
      
      const prevMonthExpenses = state.transactions.filter(t => 
        t.type === 'expense' && 
        t.status === 'paid' &&
        new Date(t.date).getMonth() === prevMonthMonth &&
        new Date(t.date).getFullYear() === prevMonthYear
      ).reduce((sum, t) => sum + parseFloat(t.amount), 0);
      
      const daysInPrevMonth = new Date(prevMonthYear, prevMonthMonth + 1, 0).getDate();
      last90DaysTotal += prevMonthExpenses;
      daysCount += daysInPrevMonth;
    }
    
    const daily90Average = daysCount > 0 ? last90DaysTotal / daysCount : 0;
    
    if (dailyAverage > (daily90Average * 1.25) && daily90Average > 0) {
      state.insights.push({
        id: generateId(),
        level: 'warning',
        message: `Seu gasto médio diário está 25% acima da média dos últimos 3 meses`,
        actionText: 'Ver análise',
        action: () => showSpendingAnalysisModal(),
        icon: 'icon-chart',
        seen: false
      });
    }
    
    // Verificar concentração de método de pagamento
    const paymentMethods = state.filteredTransactions
      .filter(t => t.type === 'expense')
      .reduce((acc, t) => {
        if (!acc[t.paymentMethod]) {
          acc[t.paymentMethod] = 0;
        }
        acc[t.paymentMethod]++;
        return acc;
      }, {});
    
    const totalPayments = Object.values(paymentMethods).reduce((sum, count) => sum + count, 0);
    
    for (const [method, count] of Object.entries(paymentMethods)) {
      if (count / totalPayments >= 0.9 && totalPayments >= 5) {
        state.insights.push({
          id: generateId(),
          level: 'info',
          message: `${Math.round((count / totalPayments) * 100)}% das suas transações usam ${method}`,
          actionText: 'Dicas de cashback',
          action: () => showCashbackTipsModal(),
          icon: 'icon-info',
          seen: false
        });
        break;
      }
    }
    
    // Verificar parcelas recorrentes prestes a acabar
    const almostFinishedRecurrences = state.transactions.filter(t => 
      t.isRecurrent && 
      t.currentInstallment && 
      t.installments && 
      (t.installments - t.currentInstallment <= 1)
    );
    
    if (almostFinishedRecurrences.length > 0) {
      state.insights.push({
        id: generateId(),
        level: 'success',
        message: `Você tem ${almostFinishedRecurrences.length} recorrência${almostFinishedRecurrences.length > 1 ? 's' : ''} prestes a terminar`,
        actionText: 'Quitar',
        action: () => showFinishingRecurrencesModal(almostFinishedRecurrences),
        icon: 'icon-check',
        seen: false
      });
    }
    
    // Renderizar insights na UI
    renderInsights();
  };
  
  // Renderizar insights na UI
  const renderInsights = () => {
    const insightsBanner = $('#insightsBanner');
    insightsBanner.innerHTML = '';
    
    // Ordenar insights por nível de prioridade
    const priorityOrder = { 'danger': 1, 'warning': 2, 'info': 3, 'success': 4 };
    const sortedInsights = [...state.insights].sort((a, b) => {
      return priorityOrder[a.level] - priorityOrder[b.level];
    });
    
    // Exibir apenas os 2 primeiros insights
    const topInsights = sortedInsights.slice(0, 2);
    
    if (topInsights.length === 0) {
      insightsBanner.style.display = 'none';
      return;
    }
    
    insightsBanner.style.display = 'block';
    
    topInsights.forEach(insight => {
      const insightElement = document.createElement('div');
      insightElement.className = `insight-banner insight-${insight.level}`;
      
      insightElement.innerHTML = `
        <div class="insight-icon">
          <svg width="24" height="24">
            <use href="#${insight.icon}"></use>
          </svg>
        </div>
        <div class="insight-content">
          <div class="insight-title">${insight.message}</div>
        </div>
        <button class="btn btn-outline insight-action" data-id="${insight.id}">${insight.actionText}</button>
      `;
      
      insightsBanner.appendChild(insightElement);
    });
    
    // Adicionar event listeners para os botões de ação dos insights
    $$('.insight-action').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const insight = state.insights.find(i => i.id === id);
        
        if (insight && typeof insight.action === 'function') {
          insight.action();
          insight.seen = true;
        }
      });
    });
  };
  
  // Gerar lançamentos recorrentes
  const generateRecurrentTransactions = transaction => {
    const recurrenceId = generateId();
    const transactions = [];
    
    // Adicionar a transação atual com ID de recorrência
    const currentTransaction = {
      ...transaction,
      recurrenceId,
      currentInstallment: 1,
      isRecurrent: true
    };
    
    transactions.push(currentTransaction);
    
    // Gerar as parcelas futuras
    for (let i = 1; i < transaction.installments; i++) {
      const date = new Date(transaction.date);
      date.setMonth(date.getMonth() + i);
      
      let dueDate = null;
      if (transaction.dueDate) {
        dueDate = new Date(transaction.dueDate);
        dueDate.setMonth(dueDate.getMonth() + i);
      }
      
      const futureTransaction = {
        ...transaction,
        id: generateId(),
        recurrenceId,
        date: date.toISOString(),
        dueDate: dueDate ? dueDate.toISOString() : null,
        currentInstallment: i + 1,
        isRecurrent: true,
        status: 'pending' // Todas as parcelas futuras começam como pendentes
      };
      
      transactions.push(futureTransaction);
    }
    
    return transactions;
  };
  
  // Salvar multiple transações no Firestore
  const saveMultipleTransactions = async transactions => {
    try {
      const batch = db.batch();
      
      transactions.forEach(transaction => {
        const docRef = db.collection('transactions').doc(transaction.id);
        batch.set(docRef, transaction);
      });
      
      await batch.commit();
      
      // Adicionar ao state
      state.transactions = [...state.transactions, ...transactions];
      
      // Atualizar a UI
      filterTransactionsByMonth();
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
      renderCommitments();
      generateInsights();
      
      return true;
    } catch (error) {
      console.error('Erro ao salvar transações recorrentes:', error);
      showToast('Erro ao salvar transações recorrentes. Tente novamente.', 'error');
      return false;
    }
  };
  
  // Renderizar compromissos longos
  const renderCommitments = () => {
    const content = $('#commitmentsContent');
    content.innerHTML = '';
    
    // Buscar todas as transações recorrentes
    const recurrentTransactions = state.transactions.filter(t => 
      t.isRecurrent && t.recurrenceId && t.installments > 3
    );
    
    // Agrupar por ID de recorrência
    const grouped = recurrentTransactions.reduce((acc, t) => {
      if (!acc[t.recurrenceId]) {
        acc[t.recurrenceId] = [];
      }
      acc[t.recurrenceId].push(t);
      return acc;
    }, {});
    
    // Converter para array e ordenar
    const commitments = Object.values(grouped).map(group => {
      // Ordenar por número da parcela
      group.sort((a, b) => a.currentInstallment - b.currentInstallment);
      
      // Verificar parcela atual
      const currentInstallment = group[0].currentInstallment || 1;
      const totalInstallments = group[0].installments || 1;
      
      // Calcular valor restante
      const paidInstallments = group.filter(t => t.status === 'paid').length;
      const remainingInstallments = totalInstallments - paidInstallments;
      const installmentValue = parseFloat(group[0].amount);
      const remainingValue = remainingInstallments * installmentValue;
      
      // Calcular data final
      const lastTransaction = group[group.length - 1];
      const endDate = lastTransaction ? new Date(lastTransaction.date) : new Date();
      
      return {
        id: group[0].recurrenceId,
        name: group[0].name,
        currentInstallment,
        totalInstallments,
        progress: (currentInstallment / totalInstallments) * 100,
        remainingValue,
        endDate,
        icon: group[0].icon || (state.icons[group[0].type][group[0].category] || 'icon-info')
      };
    });
    
    if (commitments.length === 0) {
      content.innerHTML = '<p style="text-align: center; padding: var(--spacing-md);">Nenhum compromisso de longo prazo encontrado.</p>';
      return;
    }
    
    // Ordenar por progresso (menos completos primeiro)
    commitments.sort((a, b) => a.progress - b.progress);
    
    // Renderizar os 5 primeiros compromissos
    commitments.slice(0, 5).forEach(commitment => {
      const item = document.createElement('div');
      item.className = 'commitment-item';
      
      item.innerHTML = `
        <div class="transaction-icon" style="background-color: rgba(0, 113, 227, 0.1); color: var(--color-primary);">
          <svg width="20" height="20">
            <use href="#${commitment.icon}"></use>
          </svg>
        </div>
        <div style="flex: 1;">
          <div style="display: flex; justify-content: space-between;">
            <strong>${commitment.name}</strong>
            <span>${commitment.currentInstallment}/${commitment.totalInstallments}</span>
          </div>
          <div class="commitment-progress">
            <div class="commitment-progress-bar" style="width: ${commitment.progress}%;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-on-surface-variant);">
            <span>Faltam ${formatCurrency(commitment.remainingValue)}</span>
            <span>Término: ${formatDate(commitment.endDate)}</span>
          </div>
        </div>
      `;
      
      content.appendChild(item);
    });
  };
  
  // Toggle do dropdown de compromissos
  const toggleCommitments = () => {
    const content = $('#commitmentsContent');
    const header = $('#commitmentsHeader');
    const chevron = header.querySelector('svg');
    
    if (content.style.maxHeight) {
      content.style.maxHeight = null;
      chevron.innerHTML = '<use href="#icon-chevron-down"></use>';
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      chevron.innerHTML = '<use href="#icon-chevron-up"></use>';
    }
  };
  
  // Atualizar os selects de cartões
  const updateCardSelects = () => {
    const cardSelects = [
      $('#expenseCreditCard'),
      $('#editCreditCard')
    ];
    
    cardSelects.forEach(select => {
      if (select) {
        select.innerHTML = '';
        
        if (state.cards.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'Nenhum cartão cadastrado';
          select.appendChild(option);
          select.disabled = true;
          return;
        }
        
        select.disabled = false;
        
        state.cards.forEach(card => {
          const option = document.createElement('option');
          option.value = card.id;
          option.textContent = `${card.name} (Disponível: ${formatCurrency(card.availableLimit)})`;
          select.appendChild(option);
        });
      }
    });
  };
  
  // Atualizar a lista de cartões
  const updateCardsList = () => {
    const cardsList = $('#cardsList');
    cardsList.innerHTML = '';
    
    if (state.cards.length === 0) {
      cardsList.innerHTML = '<p style="text-align: center; padding: var(--spacing-md);">Nenhum cartão cadastrado.</p>';
      return;
    }
    
    state.cards.forEach(card => {
      const cardElement = document.createElement('div');
      cardElement.className = 'card';
      cardElement.style.marginBottom = 'var(--spacing-md)';
      
      // Calcular datas de fechamento e vencimento
      const today = new Date();
      let closingDate = new Date(today.getFullYear(), today.getMonth(), card.closingDay);
      
      // Se hoje é após o dia de fechamento, a data de fechamento será no próximo mês
      if (today.getDate() > card.closingDay) {
        closingDate.setMonth(closingDate.getMonth() + 1);
      }
      
      let dueDate = new Date(today.getFullYear(), today.getMonth(), card.dueDay);
      
      // Se hoje é após o dia de vencimento, a data de vencimento será no próximo mês
      if (today.getDate() > card.dueDay) {
        dueDate.setMonth(dueDate.getMonth() + 1);
      }
      
      // Calcular a porcentagem do limite utilizado
      const limitPercentage = card.limit > 0 ? ((card.limit - card.availableLimit) / card.limit) * 100 : 0;
      
      cardElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
          <h3>${card.name}</h3>
          <div style="display: flex; gap: var(--spacing-xs);">
            <button class="btn btn-icon btn-outline edit-card-btn" data-id="${card.id}">
              <svg width="16" height="16">
                <use href="#icon-edit"></use>
              </svg>
            </button>
            <button class="btn btn-icon btn-outline delete-card-btn" data-id="${card.id}">
              <svg width="16" height="16">
                <use href="#icon-trash"></use>
              </svg>
            </button>
          </div>
        </div>
        
        <div style="margin-bottom: var(--spacing-xs);">
          <div style="display: flex; justify-content: space-between;">
            <span>Limite Total:</span>
            <strong>${formatCurrency(card.limit)}</strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Limite Disponível:</span>
            <strong>${formatCurrency(card.availableLimit)}</strong>
          </div>
        </div>
        
        <div class="commitment-progress" style="margin-bottom: var(--spacing-md);">
          <div class="commitment-progress-bar" style="width: ${limitPercentage}%; background-color: ${limitPercentage > 70 ? 'var(--color-error)' : 'var(--color-primary)'}"></div>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
          <div>
            <small>Fechamento:</small>
            <div>${card.closingDay} (${formatDate(closingDate)})</div>
          </div>
          <div>
            <small>Vencimento:</small>
            <div>${card.dueDay} (${formatDate(dueDate)})</div>
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <small>Fatura Atual:</small>
            <div>${formatCurrency(card.currentInvoice || 0)}</div>
          </div>
          <button class="btn btn-primary view-invoice-btn" data-id="${card.id}">Ver Fatura</button>
        </div>
      `;
      
      cardsList.appendChild(cardElement);
    });
    
    // Adicionar event listeners
    $$('.edit-card-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const card = state.cards.find(c => c.id === id);
        
        if (card) {
          openEditCardModal(card);
        }
      });
    });
    
    $$('.delete-card-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        deleteCard(id);
      });
    });
    
    $$('.view-invoice-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        openCardInvoice(id);
      });
    });
  };
  
  // Abrir o modal de fatura do cartão
  const openCardInvoice = cardId => {
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;
    
    state.currentCard = card;
    
    // Calcular período da fatura
    const today = new Date();
    let closingDate = new Date(today.getFullYear(), today.getMonth(), card.closingDay);
    
    // Se hoje é após o dia de fechamento, a data de fechamento será no próximo mês
    if (today.getDate() > card.closingDay) {
      closingDate.setMonth(closingDate.getMonth() + 1);
    }
    
    // Data de fechamento anterior
    const previousClosing = new Date(closingDate);
    previousClosing.setMonth(previousClosing.getMonth() - 1);
    
    // Data de vencimento
    let dueDate = new Date(closingDate);
    dueDate.setDate(card.dueDay);
    
    // Título do modal
    $('#cardInvoiceTitle').textContent = `Fatura do Cartão - ${card.name}`;
    
    // Detalhes da fatura
    $('#cardInvoiceDetails').innerHTML = `
      <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
        <div>
          <strong>Período:</strong> ${formatDate(previousClosing)} - ${formatDate(closingDate)}
        </div>
        <div>
          <strong>Vencimento:</strong> ${formatDate(dueDate)}
        </div>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <div>
          <strong>Limite Total:</strong> ${formatCurrency(card.limit)}
        </div>
        <div>
          <strong>Limite Disponível:</strong> ${formatCurrency(card.availableLimit)}
        </div>
      </div>
      <div style="margin-top: var(--spacing-xs);">
        <strong>Valor da Fatura:</strong> ${formatCurrency(card.currentInvoice || 0)}
      </div>
    `;
    
    // Buscar transações do período
    const invoiceTransactions = state.transactions.filter(t => 
      t.type === 'expense' && 
      t.paymentMethod === 'credito' && 
      t.creditCardId === card.id &&
      new Date(t.date) >= previousClosing &&
      new Date(t.date) < closingDate
    );
    
    // Ordenar por data
    invoiceTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Renderizar tabela
    const tableBody = $('#cardInvoiceTableBody');
    tableBody.innerHTML = '';
    
    if (invoiceTransactions.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; padding: var(--spacing-xl);">
            Nenhuma despesa para esta fatura.
          </td>
        </tr>
      `;
    } else {
      invoiceTransactions.forEach(transaction => {
        const iconKey = transaction.icon || (state.icons.expense[transaction.category] || 'icon-info');
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="transaction-icon" style="background-color: rgba(255, 59, 48, 0.1); color: var(--color-expense);">
              <svg width="20" height="20">
                <use href="#${iconKey}"></use>
              </svg>
            </div>
          </td>
          <td>${transaction.name}</td>
          <td>${formatDate(transaction.date)}</td>
          <td>${formatCurrency(transaction.amount)}</td>
          <td>
            <div class="checkbox-wrapper">
              <input type="checkbox" class="checkbox invoice-paid-checkbox" id="invoice-paid-${transaction.id}" 
                    ${transaction.status === 'paid' ? 'checked' : ''}
                    data-id="${transaction.id}">
              <label class="checkbox-label" for="invoice-paid-${transaction.id}"></label>
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Adicionar event listeners para os checkboxes de pagamento
      $$('.invoice-paid-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', e => {
          const id = e.target.dataset.id;
          const isChecked = e.target.checked;
          
          updateTransaction(id, { status: isChecked ? 'paid' : 'pending' });
        });
      });
    }
    
    // Configurar o botão de pagar fatura
    $('#invoiceConfirmAmount').textContent = formatCurrency(card.currentInvoice || 0);
    
    // Exibir o modal
    closeModal('cardsListModal');
    openModal('cardInvoiceModal');
  };
  
  // Pagar fatura do cartão
  const payCardInvoice = async cardId => {
    try {
      const card = state.cards.find(c => c.id === cardId);
      if (!card) return false;
      
      // Calcular período da fatura
      const today = new Date();
      let closingDate = new Date(today.getFullYear(), today.getMonth(), card.closingDay);
      
      // Se hoje é após o dia de fechamento, a data de fechamento será no próximo mês
      if (today.getDate() > card.closingDay) {
        closingDate.setMonth(closingDate.getMonth() + 1);
      }
      
      // Data de fechamento anterior
      const previousClosing = new Date(closingDate);
      previousClosing.setMonth(previousClosing.getMonth() - 1);
      
      // Buscar transações do período
      const invoiceTransactions = state.transactions.filter(t => 
        t.type === 'expense' && 
        t.paymentMethod === 'credito' && 
        t.creditCardId === card.id &&
        new Date(t.date) >= previousClosing &&
        new Date(t.date) < closingDate &&
        t.status !== 'paid'
      );
      
      if (invoiceTransactions.length === 0) {
        showToast('Não há despesas pendentes nesta fatura.', 'info');
        return false;
      }
      
      // Marcar todas as transações como pagas
      const batch = db.batch();
      
      invoiceTransactions.forEach(transaction => {
        const docRef = db.collection('transactions').doc(transaction.id);
        batch.update(docRef, { status: 'paid' });
        
        // Atualizar no state
        const index = state.transactions.findIndex(t => t.id === transaction.id);
        if (index !== -1) {
          state.transactions[index].status = 'paid';
        }
      });
      
      // Restaurar limite disponível
      const cardRef = db.collection('cards').doc(card.id);
      batch.update(cardRef, { 
        availableLimit: card.limit,
        currentInvoice: 0
      });
      
      // Atualizar no state
      const cardIndex = state.cards.findIndex(c => c.id === card.id);
      if (cardIndex !== -1) {
        state.cards[cardIndex].availableLimit = card.limit;
        state.cards[cardIndex].currentInvoice = 0;
      }
      
      // Executar o batch
      await batch.commit();
      
      // Feedback
      showToast('Fatura paga com sucesso!', 'success');
      
      // Atualizar a UI
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
      updateCardsList();
      
      // Fechar modais
      closeAllModals();
      
      return true;
      
    } catch (error) {
      console.error('Erro ao pagar fatura:', error);
      showToast('Erro ao pagar fatura. Tente novamente.', 'error');
      return false;
    }
  };
<!-- ===== FIM: PARTE 5A - LÓGICA JAVASCRIPT ================================ -->

<!-- ===== INICIO: PARTE 5B - LÓGICA DE GRÁFICOS E EVENT LISTENERS ================================ -->
  // Funções para gráficos
  let pieChart = null;
  let barChart = null;
  let areaChart = null;
  
  const createCharts = () => {
    // Configurações de cores baseadas no tema atual
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    
    const textColor = isDarkTheme ? '#f5f5f7' : '#1d1d1f';
    const gridColor = isDarkTheme ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    // Cores para categorias (compatíveis com tema claro e escuro)
    const categoryColors = [
      '#0071e3', // azul
      '#34c759', // verde
      '#ff9500', // laranja
      '#ff3b30', // vermelho
      '#af52de', // roxo
      '#5e5ce6', // azul índigo
      '#ff2d55', // rosa
      '#ff9f0a', // amarelo
      '#64d2ff', // azul claro
      '#30b0c7', // azul esverdeado
    ];
    
    // Configurações comuns para todos os gráficos
    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
    
    // Gráfico de Pizza - Despesas por Categoria
    const pieCtx = $('#catPie').getContext('2d');
    pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: categoryColors,
          borderColor: isDarkTheme ? '#000000' : '#ffffff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${formatCurrency(value)} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
    
    // Gráfico de Barras - Receitas x Despesas (12 meses)
    const barCtx = $('#annualBars').getContext('2d');
    barChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Receitas',
            data: [],
            backgroundColor: 'rgba(52, 199, 89, 0.7)',
            borderColor: 'rgba(52, 199, 89, 1)',
            borderWidth: 1
          },
          {
            label: 'Despesas',
            data: [],
            backgroundColor: 'rgba(255, 59, 48, 0.7)',
            borderColor: 'rgba(255, 59, 48, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            grid: {
              display: false
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return formatCurrency(value);
              }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
              }
            }
          }
        }
      }
    });
    
    // Gráfico de Área - Limite do Cartão
    const areaCtx = $('#cardArea').getContext('2d');
    areaChart = new Chart(areaCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Fatura',
            data: [],
            fill: true,
            backgroundColor: 'rgba(0, 113, 227, 0.2)',
            borderColor: 'rgba(0, 113, 227, 1)',
            borderWidth: 2,
            tension: 0.4
          },
          {
            label: 'Limite',
            data: [],
            fill: false,
            borderColor: 'rgba(255, 59, 48, 0.8)',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            grid: {
              display: false
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return formatCurrency(value);
              }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
              }
            }
          }
        }
      }
    });
  };
  
  // Atualizar os gráficos com dados recentes
  const updateCharts = () => {
    // Se os gráficos ainda não foram criados, criar agora
    if (!pieChart || !barChart || !areaChart) {
      createCharts();
    }
    
    // Atualizar cores se o tema mudou
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDarkTheme ? '#f5f5f7' : '#1d1d1f';
    const gridColor = isDarkTheme ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    
    // 1. Atualizar gráfico de pizza - Despesas por categoria
    const categoryTotals = state.filteredTransactions
      .filter(t => t.type === 'expense')
      .reduce((acc, t) => {
        if (!acc[t.category]) {
          acc[t.category] = 0;
        }
        acc[t.category] += parseFloat(t.amount);
        return acc;
      }, {});
    
    // Converter para arrays para o gráfico
    const categories = Object.keys(categoryTotals);
    const categoryValues = categories.map(c => categoryTotals[c]);
    
    // Atualizar dados do gráfico de pizza
    pieChart.data.labels = categories;
    pieChart.data.datasets[0].data = categoryValues;
    pieChart.update();
    
    // 2. Atualizar gráfico de barras - Receitas x Despesas (12 meses)
    const months = [];
    const incomeData = [];
    const expenseData = [];
    
    // Obter os últimos 12 meses
    const today = new Date();
    for (let i = 11; i >= 0; i--) {
      const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const monthName = date.toLocaleString('pt-BR', { month: 'short' });
      const year = date.getFullYear();
      const monthYear = `${monthName}/${year.toString().substr(2, 2)}`;
      
      months.push(monthYear);
      
      // Filtrar transações para este mês
      const monthTransactions = state.transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear();
      });
      
      // Calcular totais
      const monthlyIncome = monthTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
      
      const monthlyExpense = monthTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
      
      incomeData.push(monthlyIncome);
      expenseData.push(monthlyExpense);
    }
    
    // Atualizar dados do gráfico de barras
    barChart.data.labels = months;
    barChart.data.datasets[0].data = incomeData;
    barChart.data.datasets[1].data = expenseData;
    barChart.update();
    
    // 3. Atualizar gráfico de área - Limite do Cartão
    // Se não houver cartões, mostrar mensagem
    if (state.cards.length === 0) {
      areaChart.data.labels = ['Nenhum cartão cadastrado'];
      areaChart.data.datasets[0].data = [0];
      areaChart.data.datasets[1].data = [0];
      areaChart.update();
      return;
    }
    
    // Usar o primeiro cartão para o gráfico
    const card = state.cards[0];
    
    // Obter os dias do mês atual
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const daysLabels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
    
    // Calcular a fatura acumulada para cada dia
    const invoiceByDay = daysLabels.map(day => {
      // Data atual para este dia
      const dayDate = new Date(today.getFullYear(), today.getMonth(), day);
      
      // Se o dia já passou, usar transações reais
      if (dayDate <= today) {
        return state.transactions
          .filter(t => {
            const tDate = new Date(t.date);
            return t.type === 'expense' && 
                  t.paymentMethod === 'credito' && 
                  t.creditCardId === card.id &&
                  tDate.getDate() <= day &&
                  tDate.getMonth() === today.getMonth() &&
                  tDate.getFullYear() === today.getFullYear();
          })
          .reduce((sum, t) => sum + parseFloat(t.amount), 0);
      }
      
      // Para dias futuros, usar o valor atual
      return card.currentInvoice || 0;
    });
    
    // Linha do limite constante
    const limitLine = daysLabels.map(() => card.limit);
    
    // Atualizar dados do gráfico de área
    areaChart.data.labels = daysLabels;
    areaChart.data.datasets[0].data = invoiceByDay;
    areaChart.data.datasets[1].data = limitLine;
    areaChart.update();
  };
  
  // Event listeners para ações da UI
  const setupEventListeners = () => {
    // Seletores de mês e ano
    $('#monthSelect').addEventListener('change', e => {
      state.month = parseInt(e.target.value);
      filterTransactionsByMonth();
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
    });
    
    $('#yearSelect').addEventListener('change', e => {
      state.year = parseInt(e.target.value);
      filterTransactionsByMonth();
      updateKPIs();
      updateCharts();
      updateTransactionsTable();
    });
    
    // Toggle de compromissos
    $('#commitmentsHeader').addEventListener('click', toggleCommitments);
    
    // Botão Nova Receita
    $('#newIncomeBtn').addEventListener('click', () => {
      // Resetar o formulário
      $('#incomeForm').reset();
      
      // Definir data atual
      setDateInputValue('incomeDate', new Date());
      
      // Exibir o modal
      openModal('incomeModal');
    });
    
    // Botão Nova Despesa
    $('#newExpenseBtn').addEventListener('click', () => {
      // Resetar o formulário
      $('#expenseForm').reset();
      
      // Definir data atual
      setDateInputValue('expenseDate', new Date());
      setDateInputValue('expenseDueDate', new Date());
      
      // Exibir o modal
      openModal('expenseModal');
    });
    
    // Botão Cartões
    $('#cardsBtn').addEventListener('click', () => {
      openModal('cardsListModal');
    });
    
    // Fechar modal de receita
    $('#closeIncomeModal').addEventListener('click', () => {
      closeModal('incomeModal');
    });
    
    $('#cancelIncomeBtn').addEventListener('click', () => {
      closeModal('incomeModal');
    });
    
    // Fechar modal de despesa
    $('#closeExpenseModal').addEventListener('click', () => {
      closeModal('expenseModal');
    });
    
    $('#cancelExpenseBtn').addEventListener('click', () => {
      closeModal('expenseModal');
    });
    
    // Fechar modal de edição
    $('#closeEditModal').addEventListener('click', () => {
      closeModal('editModal');
    });
    
    $('#cancelEditBtn').addEventListener('click', () => {
      closeModal('editModal');
    });
    
    // Fechar modal de cartões
    $('#closeCardsListModal').addEventListener('click', () => {
      closeModal('cardsListModal');
    });
    
    // Fechar modal de novo cartão
    $('#closeNewCardModal').addEventListener('click', () => {
      closeModal('newCardModal');
    });
    
    $('#cancelCardBtn').addEventListener('click', () => {
      closeModal('newCardModal');
    });
    
    // Fechar modal de fatura
    $('#closeCardInvoiceModal').addEventListener('click', () => {
      closeModal('cardInvoiceModal');
    });
    
    $('#backToCardsBtn').addEventListener('click', () => {
      closeModal('cardInvoiceModal');
      openModal('cardsListModal');
    });
    
    // Fechar modal de exclusão
    $('#closeDeleteConfirmModal').addEventListener('click', () => {
      closeModal('deleteConfirmModal');
    });
    
    $('#cancelDeleteBtn').addEventListener('click', () => {
      closeModal('deleteConfirmModal');
    });
    
    // Fechar modal de pagar fatura
    $('#closePayInvoiceConfirmModal').addEventListener('click', () => {
      closeModal('payInvoiceConfirmModal');
    });
    
    $('#cancelPayInvoiceBtn').addEventListener('click', () => {
      closeModal('payInvoiceConfirmModal');
    });
    
    // Salvar nova receita
    $('#saveIncomeBtn').addEventListener('click', async () => {
      // Obter valores do formulário
      const name = $('#incomeName').value.trim();
      const amount = parseFloat($('#incomeAmount').value);
      const category = $('#incomeCategory').value;
      const date = getDateInputValue('incomeDate');
      const status = $('input[name="incomeStatus"]:checked').value;
      const paymentMethod = $('#incomePaymentMethod').value;
      const isRecurrent = $('#incomeIsRecurrent').checked;
      const installments = isRecurrent ? parseInt($('#incomeInstallments').value) : 1;
      const notes = $('#incomeNotes').value.trim();
      
      // Validação básica
      if (!name) {
        showToast('Por favor, informe o nome da receita.', 'error');
        return;
      }
      
      if (isNaN(amount) || amount <= 0) {
        showToast('Por favor, informe um valor válido.', 'error');
        return;
      }
      
      if (!date) {
        showToast('Por favor, informe a data de lançamento.', 'error');
        return;
      }
      
      // Ícone selecionado
      const iconPicker = $('#incomeIconPicker');
      const selectedIcon = iconPicker.querySelector('.icon-option.selected');
      const icon = selectedIcon ? selectedIcon.dataset.icon : null;
      
      // Criar objeto da transação
      const transaction = {
        type: 'income',
        name,
        amount,
        category,
        date: date.toISOString(),
        status,
        paymentMethod,
        isRecurrent,
        installments: isRecurrent ? installments : null,
        notes,
        icon
      };
      
      // Se for recorrente, gerar as parcelas
      if (isRecurrent && installments > 1) {
        const transactions = generateRecurrentTransactions(transaction);
        await saveMultipleTransactions(transactions);
      } else {
        // Caso contrário, salvar como transação única
        await addTransaction(transaction);
      }
      
      // Fechar o modal
      closeModal('incomeModal');
    });
    
    // Salvar nova despesa
    $('#saveExpenseBtn').addEventListener('click', async () => {
      // Obter valores do formulário
      const name = $('#expenseName').value.trim();
      const amount = parseFloat($('#expenseAmount').value);
      const category = $('#expenseCategory').value;
      const date = getDateInputValue('expenseDate');
      const dueDate = getDateInputValue('expenseDueDate');
      const status = $('input[name="expenseStatus"]:checked').value;
      const paymentMethod = $('#expensePaymentMethod').value;
      const isRecurrent = $('#expenseIsRecurrent').checked;
      const installments = isRecurrent ? parseInt($('#expenseInstallments').value) : 1;
      const notes = $('#expenseNotes').value.trim();
      
      // Campos específicos para status agendado
      let scheduledDate = null;
      if (status === 'scheduled') {
        scheduledDate = getDateInputValue('expenseScheduledDate');
        
        if (!scheduledDate) {
          showToast('Por favor, informe a data de agendamento.', 'error');
          return;
        }
      }
      
      // Campos específicos para cartão de crédito
      let creditCardId = null;
      let creditCardName = null;
      
      if (paymentMethod === 'credito') {
        creditCardId = $('#expenseCreditCard').value;
        
        if (!creditCardId) {
          showToast('Por favor, selecione um cartão de crédito.', 'error');
          return;
        }
        
        const card = state.cards.find(c => c.id === creditCardId);
        if (card) {
          creditCardName = card.name;
          
          // Verificar limite disponível
          if (amount > card.availableLimit) {
            showToast('O valor excede o limite disponível do cartão.', 'error');
            return;
          }
        }
      }
      
      // Validação básica
      if (!name) {
        showToast('Por favor, informe o nome da despesa.', 'error');
        return;
      }
      
      if (isNaN(amount) || amount <= 0) {
        showToast('Por favor, informe um valor válido.', 'error');
        return;
      }
      
      if (!date) {
        showToast('Por favor, informe a data de lançamento.', 'error');
        return;
      }
      
      if (!dueDate) {
        showToast('Por favor, informe a data de vencimento.', 'error');
        return;
      }
      
      // Ícone selecionado
      const iconPicker = $('#expenseIconPicker');
      const selectedIcon = iconPicker.querySelector('.icon-option.selected');
      const icon = selectedIcon ? selectedIcon.dataset.icon : null;
      
      // Criar objeto da transação
      const transaction = {
        type: 'expense',
        name,
        amount,
        category,
        date: date.toISOString(),
        dueDate: dueDate.toISOString(),
        status,
        scheduledDate: scheduledDate ? scheduledDate.toISOString() : null,
        paymentMethod,
        creditCardId,
        creditCardName,
        isRecurrent,
        installments: isRecurrent ? installments : null,
        notes,
        icon
      };
      
      // Se for recorrente, gerar as parcelas
      if (isRecurrent && installments > 1) {
        const transactions = generateRecurrentTransactions(transaction);
        await saveMultipleTransactions(transactions);
      } else {
        // Caso contrário, salvar como transação única
        await addTransaction(transaction);
      }
      
      // Fechar o modal
      closeModal('expenseModal');
    });
    
    // Salvar edição de transação
    $('#saveEditBtn').addEventListener('click', async () => {
      if (!state.currentTransaction) return;
      
      // Obter valores do formulário
      const name = $('#editName').value.trim();
      const amount = parseFloat($('#editAmount').value);
      const category = $('#editCategory').value;
      const date = getDateInputValue('editDate');
      const status = $('input[name="editStatus"]:checked').value;
      const paymentMethod = $('#editPaymentMethod').value;
      const isRecurrent = $('#editIsRecurrent').checked;
      const installments = isRecurrent ? parseInt($('#editInstallments').value) : null;
      const notes = $('#editNotes').value.trim();
      
      // Campos para despesas
      let dueDate = null;
      let scheduledDate = null;
      
      if (state.currentTransaction.type === 'expense') {
        dueDate = getDateInputValue('editDueDate');
        
        if (status === 'scheduled') {
          scheduledDate = getDateInputValue('editScheduledDate');
          
          if (!scheduledDate) {
            showToast('Por favor, informe a data de agendamento.', 'error');
            return;
          }
        }
      }
      
      // Campos específicos para cartão de crédito
      let creditCardId = null;
      let creditCardName = null;
      
      if (paymentMethod === 'credito') {
        creditCardId = $('#editCreditCard').value;
        
        if (!creditCardId) {
          showToast('Por favor, selecione um cartão de crédito.', 'error');
          return;
        }
        
        const card = state.cards.find(c => c.id === creditCardId);
        if (card) {
          creditCardName = card.name;
          
          // Verificar limite disponível apenas se for uma nova despesa de crédito
          // ou se o valor for maior que o original
          if (
            (state.currentTransaction.paymentMethod !== 'credito' || state.currentTransaction.creditCardId !== creditCardId) && 
            amount > card.availableLimit
          ) {
            showToast('O valor excede o limite disponível do cartão.', 'error');
            return;
          }
          
          // Se estiver mudando o cartão ou aumentando o valor, verificar disponibilidade
          if (
            (state.currentTransaction.creditCardId !== creditCardId || amount > parseFloat(state.currentTransaction.amount)) && 
            amount > card.availableLimit
          ) {
            showToast('O valor excede o limite disponível do cartão.', 'error');
            return;
          }
        }
      }
      
      // Validação básica
      if (!name) {
        showToast('Por favor, informe o nome da transação.', 'error');
        return;
      }
      
      if (isNaN(amount) || amount <= 0) {
        showToast('Por favor, informe um valor válido.', 'error');
        return;
      }
      
      if (!date) {
        showToast('Por favor, informe a data de lançamento.', 'error');
        return;
      }
      
      if (state.currentTransaction.type === 'expense' && !dueDate) {
        showToast('Por favor, informe a data de vencimento.', 'error');
        return;
      }
      
      // Ícone selecionado
      const iconPicker = $('#editIconPicker');
      const selectedIcon = iconPicker.querySelector('.icon-option.selected');
      const icon = selectedIcon ? selectedIcon.dataset.icon : null;
      
      // Criar objeto de atualização
      const updates = {
        name,
        amount,
        category,
        date: date.toISOString(),
        status,
        paymentMethod,
        isRecurrent,
        installments,
        notes,
        icon
      };
      
      // Campos adicionais para despesas
      if (state.currentTransaction.type === 'expense') {
        updates.dueDate = dueDate.toISOString();
        updates.scheduledDate = scheduledDate ? scheduledDate.toISOString() : null;
        updates.creditCardId = creditCardId;
        updates.creditCardName = creditCardName;
      }
      
      // Atualizar a transação
      await updateTransaction(state.currentTransaction.id, updates);
      
      // Fechar o modal
      closeModal('editModal');
    });
    
    // Confirmar exclusão de transação
    $('#confirmDeleteBtn').addEventListener('click', async () => {
      if (!state.currentTransaction) return;
      
      const isRecurrent = state.currentTransaction.isRecurrent;
      let deleteOption = 'single';
      
      if (isRecurrent) {
        deleteOption = $('input[name="deleteOption"]:checked').value;
      }
      
      // Excluir a transação
      await deleteTransaction(state.currentTransaction.id, deleteOption);
      
      // Fechar o modal
      closeModal('deleteConfirmModal');
    });
    
    // Adicionar novo cartão
    $('#newCardBtn').addEventListener('click', () => {
      // Resetar o formulário
      $('#cardForm').reset();
      
      // Exibir o modal
      openModal('newCardModal');
    });
    
    // Salvar novo cartão
    $('#saveCardBtn').addEventListener('click', async () => {
      // Obter valores do formulário
      const name = $('#cardName').value.trim();
      const limit = parseFloat($('#cardLimit').value);
      const closingDay = parseInt($('#cardClosingDay').value);
      const dueDay = parseInt($('#cardDueDay').value);
      
      // Validação básica
      if (!name) {
        showToast('Por favor, informe o nome do cartão.', 'error');
        return;
      }
      
      if (isNaN(limit) || limit <= 0) {
        showToast('Por favor, informe um limite válido.', 'error');
        return;
      }
      
      if (isNaN(closingDay) || closingDay < 1 || closingDay > 31) {
        showToast('Por favor, informe um dia de fechamento válido (1-31).', 'error');
        return;
      }
      
      if (isNaN(dueDay) || dueDay < 1 || dueDay > 31) {
        showToast('Por favor, informe um dia de vencimento válido (1-31).', 'error');
        return;
      }
      
      // Criar objeto do cartão
      const card = {
        name,
        limit,
        closingDay,
        dueDay,
        availableLimit: limit,
        currentInvoice: 0
      };
      
      // Salvar o cartão
      await addCard(card);
      
      // Fechar o modal
      closeModal('newCardModal');
    });
    
    // Pagar fatura
    $('#payInvoiceBtn').addEventListener('click', () => {
      if (!state.currentCard) return;
      
      // Exibir o modal de confirmação
      openModal('payInvoiceConfirmModal');
    });
    
    // Confirmar pagamento da fatura
    $('#confirmPayInvoiceBtn').addEventListener('click', async () => {
      if (!state.currentCard) return;
      
      // Pagar a fatura
      await payCardInvoice(state.currentCard.id);
      
      // Fechar o modal
      closeModal('payInvoiceConfirmModal');
    });
    
    // Toggle de campos condicionais no formulário de despesa
    $('input[name="expenseStatus"]').forEach(radio => {
      radio.addEventListener('change', e => {
        const status = e.target.value;
        
        // Mostrar campo de data de agendamento apenas se status for 'scheduled'
        $('#scheduledDateGroup').style.display = status === 'scheduled' ? 'block' : 'none';
      });
    });
    
    // Toggle de campos de cartão de crédito
    $('#expensePaymentMethod').addEventListener('change', e => {
      const method = e.target.value;
      
      // Mostrar campo de cartão de crédito apenas se método for 'credito'
      $('#creditCardGroup').style.display = method === 'credito' ? 'block' : 'none';
    });
    
    // Toggle de campos de recorrência no formulário de receita
    $('#incomeIsRecurrent').addEventListener('change', e => {
      const isRecurrent = e.target.checked;
      
      // Mostrar campo de parcelas apenas se for recorrente
      $('#incomeRecurrenceGroup').style.display = isRecurrent ? 'block' : 'none';
    });
    
    // Toggle de campos de recorrência no formulário de despesa
    $('#expenseIsRecurrent').addEventListener('change', e => {
      const isRecurrent = e.target.checked;
      
      // Mostrar campo de parcelas apenas se for recorrente
      $('#expenseRecurrenceGroup').style.display = isRecurrent ? 'block' : 'none';
    });
    
    // Icon Picker (Receita)
    $$('#incomeIconPicker .icon-option').forEach(option => {
      option.addEventListener('click', e => {
        // Remover seleção anterior
        $$('#incomeIconPicker .icon-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Adicionar seleção ao clicado
        e.currentTarget.classList.add('selected');
      });
    });
    
    // Icon Picker (Despesa)
    $$('#expenseIconPicker .icon-option').forEach(option => {
      option.addEventListener('click', e => {
        // Remover seleção anterior
        $$('#expenseIconPicker .icon-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Adicionar seleção ao clicado
        e.currentTarget.classList.add('selected');
      });
    });
  };
<!-- ===== FIM: PARTE 5B - LÓGICA DE GRÁFICOS E EVENT LISTENERS ================================ -->

<!-- ===== INICIO: PARTE 6 - ENCERRAMENTO ================================ -->
  // Abrir modal de edição de transação
  const openEditModal = transaction => {
    if (!transaction) return;
    
    // Definir o título do modal
    $('#editModalTitle').textContent = transaction.type === 'income' ? 'Editar Receita' : 'Editar Despesa';
    
    // Preencher os campos com os dados da transação
    $('#editTransactionId').value = transaction.id;
    $('#editTransactionType').value = transaction.type;
    $('#editName').value = transaction.name;
    $('#editAmount').value = transaction.amount;
    $('#editCategory').value = transaction.category;
    setDateInputValue('editDate', new Date(transaction.date));
    
    // Obter status atual (nome diferente para receitas/despesas)
    let statusValue = transaction.status;
    if (transaction.type === 'income') {
      statusValue = statusValue === 'received' ? 'received' : 'pending';
    }
    
    // Preencher campos específicos de tipo
    if (transaction.type === 'expense') {
      // Mostrar campo de data de vencimento
      $('#editDueDateGroup').style.display = 'block';
      setDateInputValue('editDueDate', new Date(transaction.dueDate));
      
      // Preencher o status
      $('#editStatusGroup').innerHTML = `
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusPaid" name="editStatus" value="paid" ${statusValue === 'paid' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusPaid">
            <span class="radio-circle"></span>
            Pago
          </label>
        </div>
        
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusPending" name="editStatus" value="pending" ${statusValue === 'pending' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusPending">
            <span class="radio-circle"></span>
            Pendente
          </label>
        </div>
        
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusScheduled" name="editStatus" value="scheduled" ${statusValue === 'scheduled' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusScheduled">
            <span class="radio-circle"></span>
            Agendado
          </label>
        </div>
      `;
      
      // Mostrar campo de data de agendamento se aplicável
      $('#editScheduledDateGroup').style.display = statusValue === 'scheduled' ? 'block' : 'none';
      if (transaction.scheduledDate) {
        setDateInputValue('editScheduledDate', new Date(transaction.scheduledDate));
      }
      
      // Preencher opções de categoria para despesas
      $('#editCategory').innerHTML = `
        <option value="alimentacao" ${transaction.category === 'alimentacao' ? 'selected' : ''}>Alimentação</option>
        <option value="moradia" ${transaction.category === 'moradia' ? 'selected' : ''}>Moradia</option>
        <option value="transporte" ${transaction.category === 'transporte' ? 'selected' : ''}>Transporte</option>
        <option value="saude" ${transaction.category === 'saude' ? 'selected' : ''}>Saúde</option>
        <option value="educacao" ${transaction.category === 'educacao' ? 'selected' : ''}>Educação</option>
        <option value="lazer" ${transaction.category === 'lazer' ? 'selected' : ''}>Lazer</option>
        <option value="compras" ${transaction.category === 'compras' ? 'selected' : ''}>Compras</option>
        <option value="contas" ${transaction.category === 'contas' ? 'selected' : ''}>Contas e serviços</option>
        <option value="impostos" ${transaction.category === 'impostos' ? 'selected' : ''}>Impostos</option>
        <option value="outros" ${transaction.category === 'outros' ? 'selected' : ''}>Outros</option>
      `;
      
      // Preencher opções de forma de pagamento para despesas
      $('#editPaymentMethod').innerHTML = `
        <option value="dinheiro" ${transaction.paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
        <option value="pix" ${transaction.paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
        <option value="debito" ${transaction.paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
        <option value="debito_conta" ${transaction.paymentMethod === 'debito_conta' ? 'selected' : ''}>Débito em Conta</option>
        <option value="transferencia" ${transaction.paymentMethod === 'transferencia' ? 'selected' : ''}>Transferência Bancária</option>
        <option value="boleto" ${transaction.paymentMethod === 'boleto' ? 'selected' : ''}>Boleto</option>
        <option value="credito" ${transaction.paymentMethod === 'credito' ? 'selected' : ''}>Crédito</option>
      `;
      
      // Mostrar campo de cartão de crédito se aplicável
      $('#editCreditCardGroup').style.display = transaction.paymentMethod === 'credito' ? 'block' : 'none';
      if (transaction.creditCardId) {
        $('#editCreditCard').value = transaction.creditCardId;
      }
      
    } else {
      // É uma receita
      
      // Esconder campo de data de vencimento
      $('#editDueDateGroup').style.display = 'none';
      
      // Preencher o status
      $('#editStatusGroup').innerHTML = `
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusReceived" name="editStatus" value="received" ${statusValue === 'received' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusReceived">
            <span class="radio-circle"></span>
            Recebido
          </label>
        </div>
        
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusPending" name="editStatus" value="pending" ${statusValue === 'pending' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusPending">
            <span class="radio-circle"></span>
            A Receber
          </label>
        </div>
      `;
      
      // Esconder campo de data de agendamento
      $('#editScheduledDateGroup').style.display = 'none';
      
      // Preencher opções de categoria para receitas
      $('#editCategory').innerHTML = `
        <option value="salario" ${transaction.category === 'salario' ? 'selected' : ''}>Salário</option>
        <option value="investimentos" ${transaction.category === 'investimentos' ? 'selected' : ''}>Investimentos</option>
        <option value="freelance" ${transaction.category === 'freelance' ? 'selected' : ''}>Freelance</option>
        <option value="presente" ${transaction.category === 'presente' ? 'selected' : ''}>Presente</option>
        <option value="outros" ${transaction.category === 'outros' ? 'selected' : ''}>Outros</option>
      `;
      
      // Preencher opções de forma de pagamento para receitas
      $('#editPaymentMethod').innerHTML = `
        <option value="pix" ${transaction.paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
        <option value="dinheiro" ${transaction.paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
        <option value="transferencia" ${transaction.paymentMethod === 'transferencia' ? 'selected' : ''}>Transferência Bancária</option>
        <option value="outros" ${transaction.paymentMethod === 'outros' ? 'selected' : ''}>Outros</option>
      `;
      
      // Esconder campo de cartão de crédito
      $('#editCreditCardGroup').style.display = 'none';
    }
    
    // Preencher campo de recorrência
    $('#editIsRecurrent').checked = transaction.isRecurrent;
    $('#editRecurrenceGroup').style.display = transaction.isRecurrent ? 'block' : 'none';
    
    if (transaction.installments) {
      $('#editInstallments').value = transaction.installments;
    }
    
    // Preencher campo de observação
    if (transaction.notes) {
      $('#editNotes').value = transaction.notes;
    }
    
    // Preencher o icon picker
    const iconPickerEdit = $('#editIconPicker');
    iconPickerEdit.innerHTML = '';
    
    // Determinar os ícones corretos com base no tipo de transação
    const iconMap = transaction.type === 'income' ? state.icons.income : state.icons.expense;
    
    // Adicionar opções de ícones
    Object.entries(iconMap).forEach(([category, iconName]) => {
      const iconOption = document.createElement('div');
      iconOption.className = 'icon-option';
      iconOption.dataset.icon = iconName;
      
      // Marcar como selecionado se for o ícone atual
      if (transaction.icon === iconName) {
        iconOption.classList.add('selected');
      }
      
      iconOption.innerHTML = `
        <svg width="20" height="20">
          <use href="#${iconName}"></use>
        </svg>
      `;
      
      iconOption.addEventListener('click', e => {
        // Remover seleção anterior
        iconPickerEdit.querySelectorAll('.icon-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Adicionar seleção ao clicado
        e.currentTarget.classList.add('selected');
      });
      
      iconPickerEdit.appendChild(iconOption);
    });
    
    // Adicionar event listeners para campos condicionais
    if (transaction.type === 'expense') {
      // Status (mostrar campo de data de agendamento se aplicável)
      $$('input[name="editStatus"]').forEach(radio => {
        radio.addEventListener('change', e => {
          const status = e.target.value;
          $('#editScheduledDateGroup').style.display = status === 'scheduled' ? 'block' : 'none';
        });
      });
      
      // Forma de pagamento (mostrar campo de cartão de crédito se aplicável)
      $('#editPaymentMethod').addEventListener('change', e => {
        const method = e.target.value;
        $('#editCreditCardGroup').style.display = method === 'credito' ? 'block' : 'none';
      });
    }
    
    // Toggle de campos de recorrência
    $('#editIsRecurrent').addEventListener('change', e => {
      const isRecurrent = e.target.checked;
      $('#editRecurrenceGroup').style.display = isRecurrent ? 'block' : 'none';
    });
    
    // Exibir o modal
    openModal('editModal');
  };
  
  // Função para inicialização
  const init = async () => {
    console.log('Inicializando Calculadora da Família...');
    
    // Inicializar o tema
    initTheme();
    
    // Configurar event listeners
    setupEventListeners();
    
    // Carregar dados do Firebase
    try {
      await loadCards();
      await loadTransactions();
      
      // Atualizar UI inicial
      updateMonthYearTitle();
      
      // Mostrar mensagem de boas-vindas
      showToast('Bem-vindo à Calculadora da Família!', 'success');
      
    } catch (error) {
      console.error('Erro na inicialização:', error);
      showToast('Erro ao carregar dados. Verifique sua conexão e tente novamente.', 'error');
    }
  };
  
  // Iniciar a aplicação quando o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', init);
</script>
<!-- ===== FIM: PARTE 6 - ENCERRAMENTO ================================ -->
</body>
</html>
