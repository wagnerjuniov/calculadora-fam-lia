<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Familiar Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <style>
    /* ===== Variáveis e Temas (Estilo Apple/Google) ===== */
    :root {
      --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem; /* 12px */
      --radius: 1.125rem; /* 18px */
      --radius-lg: 1.5rem; /* 24px */
      --shadow: 0 4px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.09), 0 2px 6px rgba(0,0,0,0.07);
      --shadow-dropdown: 0 5px 20px rgba(0,0,0,0.12);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

      /* Cores Light */
      --bg: #F9F9FB; /* Slightly off-white */
      --bg-rgb: 249, 249, 251; /* Para usar com opacidade */
      --card-bg: #FFFFFF;
      --input-bg: rgba(118, 118, 128, 0.12); /* System Gray 5 (0.12 alpha) */
      --text: #1C1C1E; /* Almost Black */
      --text-secondary: #8A8A8E; /* System Gray */
      --primary: #007AFF; /* Blue */
      --primary-light: #5856D6; /* Indigo for accents if needed */
      --success: #34C759; /* Green */
      --warning: #FF9500; /* Orange */
      --danger: #FF3B30; /* Red */
      --info: #5AC8FA; /* Teal */
      --border: rgba(60, 60, 67, 0.15); /* Lighter border */
      --chart-grid: rgba(60, 60, 67, 0.08); /* Lighter grid */
      --menu-bg: rgba(255, 255, 255, 0.9); /* More opaque */
      --insight-bg: rgba(0, 122, 255, 0.06); /* Subtler blue */
      --importance-extrema: #FF3B30; /* Red */
      --importance-urgente: #FF9500; /* Orange */
      --importance-importante: #FFCC00; /* Yellow */
      --hover-bg: rgba(0, 0, 0, 0.03); /* Subtle hover */
    }

    [data-theme="dark"] {
      /* Cores Dark */
      --bg: #000000; /* True Black for OLED */
      --bg-rgb: 0, 0, 0; /* Para usar com opacidade */
      --card-bg: #1C1C1E; /* Gray 6 */
      --input-bg: rgba(118, 118, 128, 0.24); /* System Gray 5 (0.24 alpha) */
      --text: #FFFFFF;
      --text-secondary: #8E8E93; /* Gray */
      --primary: #0A84FF; /* Blue */
      --primary-light: #5E5CE6; /* Indigo */
      --success: #30D158; /* Green */
      --warning: #FF9F0A; /* Orange */
      --danger: #FF453A; /* Red */
      --info: #64D2FF; /* Teal */
      --border: rgba(84, 84, 88, 0.35); /* Lighter border */
      --chart-grid: rgba(84, 84, 88, 0.15); /* Lighter grid */
      --menu-bg: rgba(28, 28, 30, 0.9); /* More opaque */
      --insight-bg: rgba(10, 132, 255, 0.12); /* Subtler blue */
      --importance-extrema: #FF453A; /* Red */
      --importance-urgente: #FF9F0A; /* Orange */
      --importance-importante: #FFD60A; /* Yellow */
      --hover-bg: rgba(255, 255, 255, 0.05); /* Subtle hover */
    }

    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
    html { font-size: 16px; }
    body { font-family: var(--font-sans); background: var(--bg); color: var(--text); transition: background 0.3s ease, color 0.3s ease; line-height: 1.5; width: 100%; overflow-x: hidden;}

    /* ===== Layout e Componentes ===== */
    .container { max-width: 1360px; margin: 0 auto; padding: 2rem; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .header-title { display: flex; align-items: center; gap: 0.75rem; }
    h1 { font-size: 1.875rem; font-weight: 700; margin: 0; letter-spacing: -0.03em; }
    .header-right { display: flex; align-items: center; gap: 1rem; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 2rem; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;}
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 0.875rem 1.5rem; font-weight: 600; font-size: 0.9375rem; color: var(--text-secondary); cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; transition: var(--transition); margin-bottom: -1px; border-radius: 6px 6px 0 0; }
    .tab:hover { color: var(--text); background-color: var(--hover-bg); }
    .tab.active { color: var(--primary); border-color: var(--primary); background-color: var(--card-bg); }
    [data-theme="dark"] .tab.active { background-color: var(--card-bg); }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* KPIs Card */
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; transition: var(--transition); overflow: hidden; position: relative; }
    .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .kpi-card { display: flex; flex-direction: column; gap: 0.5rem; min-height: 150px; }
    .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
    .kpi-title { font-size: 0.9375rem; font-weight: 500; color: var(--text-secondary); }
    .kpi-icon { color: var(--text-secondary); opacity: 0.6; flex-shrink: 0; width: 22px; height: 22px; }
    .kpi-icon svg { display: block; width: 100%; height: 100%; }
    .kpi-value { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.02em; line-height: 1.2; margin-top: 0.25rem; }
    .kpi-footer { display: flex; align-items: center; gap: 0.5rem; margin-top: auto; padding-top: 0.75rem; font-size: 0.8125rem; color: var(--text-secondary); }
    .kpi-trend { display: flex; align-items: center; gap: 0.25rem; font-weight: 500; }
    .kpi-trend.up { color: var(--success); } .kpi-trend.down { color: var(--danger); } .kpi-trend.neutral { color: var(--text-secondary); }
    .kpi-trend svg { width: 14px; height: 14px; flex-shrink: 0; }
    .kpi-trend svg path { stroke-width: 2.5; } /* Apply stroke width to path */
    .kpi-trend svg .up-path { fill: currentColor; stroke: none; }
    .kpi-trend svg .down-path { fill: currentColor; stroke: none; }
    .kpi-trend svg .neutral-path { stroke: currentColor; fill: none; }

    /* Progress container/bar */
    .progress-container { width: 100%; height: 6px; background-color: var(--input-bg); border-radius: 3px; overflow: hidden; margin-top: 0.5rem; }
    .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; background-color: var(--primary); }
    .progress-bar.success { background-color: var(--success); } .progress-bar.warning { background-color: var(--warning); } .progress-bar.danger { background-color: var(--danger); }

    /* Gráficos */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .chart-container { position: relative; margin-top: 1rem; height: 280px; min-height: 280px; }
    .chart-title { font-size: 1.125rem; font-weight: 600; letter-spacing: -0.01em; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .chart-title-actions { display: flex; gap: 0.75rem; }
    .full-width { grid-column: 1 / -1; }
    .full-width .chart-container { height: 320px; min-height: 320px; }

    /* Análise Mensal - Filtros Atualizados */
    .analysis-header { display: flex; flex-wrap: wrap; gap: 1rem 1.5rem; align-items: flex-end; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    .filters { display: flex; flex-wrap: wrap; gap: 1rem 1.5rem; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .filter-group label { font-size: 0.8125rem; color: var(--text-secondary); font-weight: 500; padding-left: 0.25rem; }
    .category-filter-group { display: flex; gap: 0.5rem; align-items: center; }
    .category-filter-group select { min-width: 200px; }
    .btn-icon-small { padding: 0.5rem; min-width: auto; height: calc(1.5em + 1.5rem + 2px); background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
    .btn-icon-small:hover { background-color: var(--hover-bg); border-color: rgba(60, 60, 67, 0.4); }
    .btn-icon-small svg { width: 1rem; height: 1rem; flex-shrink: 0; }
    .btn-delete-category { color: var(--danger); }
    .btn-delete-category:hover { background-color: rgba(255, 59, 48, 0.1); }

    /* Indicadores */
    .analysis-indicators { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .indicator-card { background-color: var(--card-bg); border-radius: var(--radius); padding: 1.25rem; text-align: center; box-shadow: var(--shadow); transition: var(--transition); display: flex; flex-direction: column; justify-content: center; min-height: 120px; }
    .indicator-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .indicator-title { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .indicator-value { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.01em; line-height: 1.2; margin-bottom: 0.25rem; }
    .indicator-value.positive { color: var(--success); } .indicator-value.negative { color: var(--danger); } .indicator-value.neutral { color: var(--text); }
    .indicator-comparison { font-size: 0.75rem; color: var(--text-secondary); margin-top: auto; }

    /* Conteúdo Análise */
    .analysis-content { display: grid; grid-template-columns: 1fr 320px; gap: 2rem; }
    .analysis-main { display: flex; flex-direction: column; gap: 1.5rem; }
    .analysis-sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
    .insights-feed { background: var(--card-bg); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); }
    .insights-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--primary); }
    .insights-title svg { flex-shrink: 0; }
    .insights-list { display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem; }
    .insight-item { display: flex; gap: 0.75rem; padding: 0.75rem 1rem; background-color: var(--insight-bg); border-radius: var(--radius-sm); font-size: 0.875rem; align-items: flex-start; line-height: 1.4; border-left-width: 3px; border-left-style: solid; }
    .insight-icon { flex-shrink: 0; margin-top: 2px; font-size: 1rem; }
    .insight-item.alert { color: var(--danger); background-color: rgba(255, 59, 48, 0.08); border-left-color: var(--danger); }
    .insight-item.warning { color: var(--warning); background-color: rgba(255, 149, 0, 0.08); border-left-color: var(--warning); }
    .insight-item.success { color: var(--success); background-color: rgba(52, 199, 89, 0.08); border-left-color: var(--success); }
    .insight-item.info { color: var(--primary); background-color: rgba(0, 122, 255, 0.08); border-left-color: var(--primary); }
    .insight-item.neutral { color: var(--text-secondary); background-color: var(--input-bg); border-left-color: var(--text-secondary); }

    /* Transaction List Refined */
    .transaction-list-container { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0; display: flex; flex-direction: column; }
    .transaction-list-title { font-size: 1.125rem; font-weight: 600; padding: 1.5rem 1.5rem 1rem 1.5rem; flex-shrink: 0; border-bottom: 1px solid var(--border); }
    .transaction-list { display: flex; flex-direction: column; gap: 0px; max-height: 500px; overflow-y: auto; padding: 0 0.5rem 0 1.5rem; flex-grow: 1; }
    #analysis-no-transactions { padding: 2rem 1.5rem; text-align: center; color: var(--text-secondary); }
    .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 0.875rem 1rem 0.875rem 0; border-bottom: 1px solid var(--border); transition: background-color 0.15s ease; cursor: pointer; position: relative; }
    .transaction-item:last-child { border-bottom: none; }
    .transaction-item:hover { background-color: var(--hover-bg); border-radius: var(--radius-sm); }
    .transaction-item .delete-transaction-btn { display: none; position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); padding: 0.3rem; border-radius: 50%; background: var(--input-bg); border: 1px solid var(--border); cursor: pointer; color: var(--text-secondary); line-height: 0; transition: var(--transition); }
    .transaction-item:hover .delete-transaction-btn { display: inline-flex; align-items: center; justify-content: center; }
    .transaction-item .delete-transaction-btn:hover { background: rgba(255, 59, 48, 0.1); color: var(--danger); border-color: rgba(255, 59, 48, 0.2); }
    .transaction-item .delete-transaction-btn svg { width: 14px; height: 14px; }
    .transaction-item:hover .transaction-item-right { padding-right: 3rem; }
    .transaction-item-left { display: flex; align-items: center; gap: 1rem; flex-grow: 1; min-width: 0; }
    .transaction-icon { width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; color: #fff; }
    .transaction-info { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; gap: 0.1rem; }
    .transaction-description { font-weight: 500; font-size: 0.9375rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
    .transaction-category { font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.3; }
    .transaction-item-right { text-align: right; flex-shrink: 0; padding-left: 1rem; transition: padding-right 0.15s ease; }
    .transaction-amount { font-weight: 600; font-size: 0.9375rem; white-space: nowrap; display: flex; align-items: center; justify-content: flex-end; gap: 0.3rem; }
    .transaction-amount.income { color: var(--success); } .transaction-amount.expense { color: var(--danger); }
    .transaction-date { font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.1rem; }
    .transaction-importance { display: inline-block; width: 8px; height: 8px; border-radius: 50%; vertical-align: middle; flex-shrink: 0; }
    .transaction-importance.extrema { background-color: var(--importance-extrema); } .transaction-importance.urgente { background-color: var(--importance-urgente); } .transaction-importance.importante { background-color: var(--importance-importante); }

    /* Botões */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.9375rem; cursor: pointer; transition: var(--transition); border: none; color: #fff; background-color: var(--primary); text-decoration: none; white-space: nowrap; }
    .btn:hover { opacity: 0.85; transform: translateY(-1px); } .btn:active { transform: translateY(0); opacity: 0.75; } .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-primary { background-color: var(--primary); } .btn-success { background-color: var(--success); } .btn-warning { background-color: var(--warning); color: #333; } .btn-danger { background-color: var(--danger); }
    .btn-secondary { background-color: var(--input-bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background-color: var(--hover-bg); }
    .btn svg { width: 1rem; height: 1rem; flex-shrink: 0; }

    /* Theme Toggle */
    .theme-toggle { background: var(--input-bg); border: none; border-radius: 50%; width: 2.75rem; height: 2.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); transition: var(--transition); flex-shrink: 0; }
    .theme-toggle:hover { background-color: var(--hover-bg); }
    .theme-toggle svg { width: 1.25rem; height: 1.25rem; }

    /* Select */
    select { appearance: none; -webkit-appearance: none; padding: 0.75rem 2.25rem 0.75rem 1rem; height: calc(1.5em + 1.5rem + 2px); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238A8A8E' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E") no-repeat; background-position: right 0.875rem center; color: var(--text); font-family: var(--font-sans); font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: var(--transition); min-width: 120px; line-height: 1.5; }
    [data-theme="dark"] select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238E8E93' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E"); background-color: var(--card-bg); }
    select:hover { border-color: rgba(60, 60, 67, 0.4); }
    select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); }
    select option { background-color: var(--card-bg); color: var(--text); }

    /* Modal */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; padding: 1rem; }
    .modal.active { opacity: 1; pointer-events: all; }
    .modal-content { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 550px; max-height: calc(100vh - 4rem); overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; opacity: 0; }
    .modal.active .modal-content { opacity: 1; transform: scale(1) translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
    .modal-close { background: var(--input-bg); border: none; width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: var(--transition); flex-shrink: 0; }
    .modal-close:hover { background-color: var(--hover-bg); color: var(--text); }
    .modal-close svg { width: 1rem; height: 1rem; flex-shrink: 0; }
    .modal-body { padding: 1.75rem; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
    .modal-footer { padding: 1.25rem 1.75rem; display: flex; justify-content: flex-end; gap: 0.75rem; border-top: 1px solid var(--border); background-color: rgba(var(--bg-rgb), 0.8); flex-shrink: 0; backdrop-filter: blur(3px); }
    [data-theme="dark"] .modal-footer { background-color: rgba(var(--bg-rgb), 0.8); }

    /* Forms in Modal */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; } .form-grid.single-col { grid-template-columns: 1fr; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
    .form-control { width: 100%; padding: 0.875rem 1rem; font-size: 0.9375rem; height: calc(1.5em + 1.75rem + 2px); border-radius: var(--radius-sm); border: 1px solid var(--border); background-color: var(--input-bg); color: var(--text); transition: var(--transition); font-family: var(--font-sans); line-height: 1.5; }
    input[type="color"].form-control { padding: 0.25rem; height: calc(1.5em + 1.75rem + 2px); }
    input[type="date"].form-control { line-height: normal; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--card-bg); }
    textarea.form-control { line-height: 1.4; min-height: 80px; height: auto; }

    /* Transaction Modal */
    #transaction-modal .modal-content { max-width: 500px; }
    .input-group { display: flex; align-items: center; }
    .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; flex-grow: 1; height: calc(1.5em + 1.75rem + 2px); }
    .input-group-append { flex-shrink: 0; }
    .input-group-append .btn-icon-small { border-top-left-radius: 0; border-bottom-left-radius: 0; height: calc(1.5em + 1.75rem + 2px); margin-left: -1px; }
    #advanced-fields { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border); display: none; animation: slideDown 0.3s ease-out forwards; }
    #advanced-fields.visible { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); max-height: 0; overflow: hidden;} to { opacity: 1; transform: translateY(0); max-height: 1000px; overflow: visible;} }
    .btn-link { background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; font-size: 0.875rem; font-weight: 500; text-align: left; display: inline-flex; align-items: center; gap: 0.25rem; }
    .btn-link:hover { text-decoration: underline; } .btn-link svg { transition: transform 0.2s ease; }
    #advanced-fields.visible + .btn-link svg { transform: rotate(180deg); }
    .importance-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .importance-group input[type="radio"] { opacity: 0; position: fixed; width: 0; }
    .importance-group label { display: inline-block; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); font-size: 0.875rem; font-weight: 500; border-left-width: 4px; border-left-color: transparent; margin-bottom: 0; }
    .importance-group input[type="radio"]:checked + label { background-color: var(--primary); color: #fff; border-color: var(--primary); }
    .importance-group input[type="radio"]:focus-visible + label { box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); outline: none; }
    .importance-group label[for="importance-extrema"] { border-left-color: var(--importance-extrema); } .importance-group label[for="importance-urgente"] { border-left-color: var(--importance-urgente); } .importance-group label[for="importance-importante"] { border-left-color: var(--importance-importante); }
    .importance-group input[type="radio"]:checked + label[for="importance-extrema"] { background-color: var(--importance-extrema); border-color: var(--importance-extrema); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-urgente"] { background-color: var(--importance-urgente); border-color: var(--importance-urgente); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-importante"] { background-color: var(--importance-importante); border-color: var(--importance-importante); color: #333; }

    /* Category & Confirm Modals */
    #category-modal .modal-content { max-width: 400px; }
    #confirm-modal .modal-content { max-width: 450px; }
    #confirm-modal-message { margin-bottom: 1rem; line-height: 1.4; font-weight: 500; }
    #confirm-modal-extra-info { margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary); }
    #confirm-modal-extra-info label { display: block; margin-bottom: 0.75rem; cursor: pointer; }
    #confirm-modal-extra-info input[type="radio"] { margin-right: 0.5rem; accent-color: var(--primary); }

    /* Loading Indicator */
    .loading-indicator { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(3px); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .loading-indicator.active { opacity: 1; pointer-events: all; }
    .spinner { width: 2.5rem; height: 2.5rem; border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; }
    [data-theme="dark"] .spinner { border-color: rgba(255, 255, 255, 0.1); border-top-color: #aaa; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast Notifications */
    .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; }
    .toast { background-color: var(--card-bg); color: var(--text); padding: 0.875rem 1.25rem; border-radius: var(--radius-sm); box-shadow: var(--shadow-dropdown); display: flex; align-items: center; gap: 0.75rem; min-width: 250px; max-width: 400px; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000); border-left: 4px solid var(--primary); }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast-icon { font-size: 1.25rem; flex-shrink: 0; }
    .toast.success { border-left-color: var(--success); } .toast.warning { border-left-color: var(--warning); } .toast.danger { border-left-color: var(--danger); } .toast.info { border-left-color: var(--primary); }

    /* Responsividade */
    @media (max-width: 1200px) { .analysis-content { grid-template-columns: 1fr; } .analysis-sidebar { grid-row: 2; } }
    @media (max-width: 992px) { .container { padding: 1.5rem; } .header { flex-direction: column; align-items: flex-start; } .header-right { width: 100%; justify-content: space-between; } .charts-grid { grid-template-columns: 1fr; } .chart-container { height: 260px; } .full-width .chart-container { height: 300px; } .analysis-header, .filters { gap: 1rem; } }
    @media (max-width: 768px) { h1 { font-size: 1.625rem; } .kpis { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .analysis-indicators { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } .btn { padding: 0.625rem 1.25rem; font-size: 0.875rem; } select, .form-control, .btn-icon-small { height: calc(1.5em + 1.25rem + 2px); } select { padding: 0.625rem 2rem 0.625rem 0.875rem; font-size: 0.875rem; } .form-grid { grid-template-columns: 1fr; } .transaction-item { flex-direction: column; align-items: flex-start; gap: 0.25rem; padding: 0.75rem 0.75rem 0.75rem 0; } .transaction-item-left { width: 100%; } .transaction-item-right { text-align: left; margin-top: 0.25rem; width: 100%; display: flex; justify-content: space-between; align-items: center; padding-left: 0; } .transaction-list { padding: 0 0.5rem 0 1rem; } .modal-content { width: 95%; max-height: calc(100vh - 2rem); } .modal-body, .modal-header, .modal-footer { padding: 1.25rem; } .tabs { margin-bottom: 1.5rem; } .tab { padding: 0.75rem 1rem; font-size: 0.875rem; } .analysis-content { grid-template-columns: 1fr; gap: 1.5rem; } .analysis-sidebar { order: 1; } .analysis-main { order: 2; } }
    @media (max-width: 576px) { .container { padding: 1rem; } h1 { font-size: 1.5rem; } .kpis { grid-template-columns: 1fr; } .analysis-indicators { grid-template-columns: 1fr; } .header-right { flex-direction: column; align-items: stretch; gap: 0.75rem; } .analysis-header { padding-bottom: 1rem; margin-bottom: 1rem;} .filters { flex-direction: column; align-items: stretch; gap: 0.75rem; } .filter-group { width: 100%; } select { width: 100%; } .category-filter-group { width: 100%; } .category-filter-group select { flex-grow: 1; } .header-right .btn { width: 100%; } .theme-toggle { align-self: flex-end; margin-top: 0.5rem; } .importance-group { gap: 0.25rem; } .importance-group label { padding: 0.4rem 0.8rem; } .toast-container { right: 1rem; bottom: 1rem; left: 1rem; align-items: stretch; } .toast { width: 100%; } .transaction-description { font-size: 0.875rem;} .transaction-amount { font-size: 0.875rem;} .transaction-item:hover .transaction-item-right { padding-right: 2.5rem; } .transaction-item .delete-transaction-btn { right: 0.5rem; } }

    /* Print styles */
    @media print { body { background-color: #fff; color: #000; } .header, .tabs, .theme-toggle, .btn, .modal, .loading-indicator, .toast-container, .analysis-sidebar, .delete-transaction-btn { display: none !important; } .container { max-width: 100%; padding: 0; } .card, .kpi-card, .indicator-card, .transaction-list-container, .insights-feed { box-shadow: none; border: 1px solid #ddd; border-radius: 0; padding: 1rem; page-break-inside: avoid; background-color: #fff !important; } .kpis, .charts-grid, .analysis-indicators, .analysis-content, .analysis-main { grid-template-columns: 1fr !important; gap: 1rem; } canvas { max-width: 100%; } select { border: none; appearance: none; -webkit-appearance: none; padding-right: 1rem; background: none; } .transaction-item { border-bottom: 1px solid #eee; } .transaction-item:hover { background-color: transparent; margin: 0; padding: 1rem 0; border-radius: 0; } .transaction-item-right { padding-right: 0 !important; } :root { --text: #000; --text-secondary: #555; --success: #008000; --danger: #D00000; --primary: #0000FF; --warning: #FFA500; --bg: #fff; --card-bg: #fff; --input-bg: #eee; } .indicator-value.positive, .kpi-trend.up, .transaction-amount.income { color: var(--success) !important; } .indicator-value.negative, .kpi-trend.down, .transaction-amount.expense { color: var(--danger) !important; } .progress-bar { background-color: #ccc !important; } }

  </style>
</head>
<body>
    <!-- HTML Estrutural Completo -->
     <div class="container">
         <!-- Header -->
         <div class="header">
             <div class="header-title"><h1>Calculadora Financeira</h1></div>
             <div class="header-right">
                 <button class="btn btn-primary" id="btn-new-transaction">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                         <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                     </svg>
                     Nova Transação
                 </button>
                 <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema"><svg id="theme-icon"><!-- Icon --></svg></button>
             </div>
         </div>
         <!-- Tabs -->
         <div class="tabs">
             <div class="tab active" data-tab="overview">Visão Geral</div>
             <div class="tab" data-tab="analysis">Análise Mensal</div>
         </div>
         <!-- Conteúdo Tabs -->
         <div id="tab-contents">
              <!-- Aba Visão Geral -->
              <div class="tab-content active" id="tab-overview">
                 <div class="kpis" id="overview-kpis">
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Saldo Atual</div><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-wallet2" viewBox="0 0 16 16"><path d="M12.136.326A1.5 1.5 0 0 1 14 1.78V3h.5A1.5 1.5 0 0 1 16 4.5v7a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 11.5v-7A1.5 1.5 0 0 1 1.5 3H2V1.78a1.5 1.5 0 0 1 1.404-1.454l8.732 0zM13 3v-.22c0-.414-.18-.74-.368-.834l-8.646 0c-.188.094-.36.42-.36.834V3h9.374z"/><path d="M1 4.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5H1z"/></svg></div></div><div class="kpi-value" id="kpi-balance">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="balance-trend-indicator"><svg viewBox="0 0 24 24" width="14" height="14"><path class="neutral-path"></path></svg><span id="balance-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Receitas (Mês)</div><div class="kpi-icon" style="color: var(--success);"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-arrow-up-circle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"/></svg></div></div><div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="income-trend-indicator"><svg viewBox="0 0 24 24" width="14" height="14"><path class="neutral-path"></path></svg><span id="income-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Despesas (Mês)</div><div class="kpi-icon" style="color: var(--danger);"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-arrow-down-circle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/></svg></div></div><div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div><div class="kpi-footer"><div class="kpi-trend neutral" id="expenses-trend-indicator"><svg viewBox="0 0 24 24" width="14" height="14"><path class="neutral-path"></path></svg><span id="expenses-trend">--%</span></div><span>vs. mês anterior</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Economia do Mês</div><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-piggy-bank" viewBox="0 0 16 16"><path d="M5 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0zm1.138-1.496A6.613 6.613 0 0 1 7.964 4.5c.666 0 1.303.097 1.893.273a.5.5 0 0 0 .286-.958A7.602 7.602 0 0 0 7.964 3.5c-.734 0-1.441.103-2.102.292a.5.5 0 1 0 .276.962z"/><path fill-rule="evenodd" d="M7.964 1.527c-2.977 0-5.571 1.704-6.32 4.125h-.55A1 1 0 0 0 .11 6.824l.254 1.46a1.5 1.5 0 0 0 1.478 1.243h.263c.3.513.688.978 1.145 1.382l-.729 2.477a.5.5 0 0 0 .48.641h2a.5.5 0 0 0 .471-.332l.482-1.351c.635.173 1.31.267 2.011.267.707 0 1.388-.095 2.028-.272l.543 1.372a.5.5 0 0 0 .465.316h2a.5.5 0 0 0 .478-.645l-.761-2.506C13.81 9.895 14.5 8.559 14.5 7.069c0-.145-.007-.29-.02-.431.261-.11.508-.266.705-.444.315.306.815.306.815-.417 0 .223-.5.223-.461-.026a.95.95 0 0 0 .09-.255.7.7 0 0 0-.202-.645.58.58 0 0 0-.707-.098.735.735 0 0 0-.375.562c-.024.243.082.48.32.654a2.112 2.112 0 0 1-.259.153c-.534-2.664-3.284-4.595-6.442-4.595zM2.516 6.26c.455-2.066 2.667-3.733 5.448-3.733 3.146 0 5.536 2.114 5.536 4.542 0 1.254-.624 2.41-1.67 3.248a.5.5 0 0 0-.165.535l.66 2.175h-.985l-.59-1.487a.5.5 0 0 0-.629-.288c-.661.23-1.39.359-2.158.359-.761 0-1.484-.128-2.118-.355a.5.5 0 0 0-.635.304l-.525 1.471h-.979l.633-2.15a.5.5 0 0 0-.17-.534 4.649 4.649 0 0 1-1.284-1.541H1.518l-.254-1.46h.933a.5.5 0 1 0 0-1H1.518l-.044-.254C1.588 6.84 2.053 6.42 2.516 6.26z"/></svg></div></div><div class="kpi-value" id="kpi-savings">R$ 0,00</div><div class="progress-container"><div class="progress-bar" id="savings-progress" style="width: 0%"></div></div><div class="kpi-footer"><span id="savings-status">Calculando...</span></div></div>
                     <div class="card kpi-card"><div class="kpi-header"><div class="kpi-title">Projeção de Gastos (Mês)</div><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-calendar-check" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg></div></div><div class="kpi-value" id="kpi-projection">R$ 0,00</div><div class="kpi-footer"><span id="projection-status">--</span></div></div>
                 </div>
                  <!-- Gráficos Visão Geral -->
                  <div class="charts-grid">
                      <div class="card"><div class="chart-title"><span>Receitas vs Despesas (Últimos 12 Meses)</span></div><div class="chart-container"><canvas id="overview-income-expense-chart"></canvas></div></div>
                      <div class="card"><div class="chart-title"><span>Despesas por Categoria (Últimos 30 dias)</span></div><div class="chart-container"><canvas id="overview-category-chart"></canvas></div></div>
                      <div class="card full-width"><div class="chart-title"><span>Fluxo de Caixa Mensal (Ano Atual)</span></div><div class="chart-container"><canvas id="overview-cashflow-chart"></canvas></div></div>
                      <div class="card"><div class="chart-title"><span>Fixas vs Variáveis (Mês Atual)</span></div><div class="chart-container"><canvas id="overview-fixed-variable-chart"></canvas></div></div>
                      <div class="card"><div class="chart-title"><span>Tendência Geral de Gastos (Últimos 6 Meses)</span></div><div class="chart-container"><canvas id="overview-trend-chart"></canvas></div></div>
                  </div>
              </div>
              <!-- Aba Análise Mensal -->
              <div class="tab-content" id="tab-analysis">
                  <!-- Filtros -->
                  <div class="analysis-header">
                      <div class="filters">
                          <div class="filter-group"><label for="analysis-year">Ano</label><select id="analysis-year"></select></div>
                          <div class="filter-group"><label for="analysis-month">Mês</label><select id="analysis-month"></select></div>
                          <div class="filter-group"><label for="analysis-category">Categoria</label><div class="category-filter-group"><select id="analysis-category"><option value="all">Todas</option></select><button class="btn-icon-small" id="btn-add-category" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/></svg></button><button class="btn-icon-small btn-delete-category" id="btn-delete-category" title="Excluir Categoria" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div></div>
                          <div class="filter-group"><label for="analysis-importance">Importância</label><select id="analysis-importance"><option value="all">Todas</option><option value="extrema">Extrema</option><option value="urgente">Urgente</option><option value="importante">Importante</option><option value="none">Nenhuma</option></select></div>
                      </div>
                  </div>
                  <!-- Indicadores -->
                  <div class="analysis-indicators">
                      <div class="indicator-card"><div class="indicator-title">Receitas Totais</div><div class="indicator-value positive" id="analysis-total-income">R$ 0,00</div><div class="indicator-comparison" id="analysis-income-comparison">-- vs mês anterior</div></div>
                      <div class="indicator-card"><div class="indicator-title">Despesas Totais</div><div class="indicator-value negative" id="analysis-total-expenses">R$ 0,00</div><div class="indicator-comparison" id="analysis-expense-comparison">-- vs mês anterior</div></div>
                      <div class="indicator-card"><div class="indicator-title">Saldo Final</div><div class="indicator-value neutral" id="analysis-final-balance">R$ 0,00</div><div class="indicator-comparison" id="analysis-balance-comparison">-- vs mês anterior</div></div>
                      <div class="indicator-card"><div class="indicator-title">Status do Mês</div><div class="indicator-value neutral" id="analysis-month-status">--</div><div class="indicator-comparison" id="analysis-days-left">-- dias restantes</div></div>
                      <div class="indicator-card"><div class="indicator-title">Maior Gasto</div><div class="indicator-value neutral" id="analysis-top-category">--</div><div class="indicator-comparison" id="analysis-top-category-value">R$ 0,00</div></div>
                  </div>
                  <!-- Conteúdo Principal e Sidebar -->
                  <div class="analysis-content">
                      <div class="analysis-main">
                          <div class="charts-grid">
                              <div class="card"><div class="chart-title">Distribuição de Despesas</div><div class="chart-container"><canvas id="analysis-category-pie-chart"></canvas></div></div>
                              <div class="card"><div class="chart-title">Evolução do Saldo no Mês</div><div class="chart-container"><canvas id="analysis-balance-line-chart"></canvas></div></div>
                          </div>
                          <div class="transaction-list-container">
                              <div class="transaction-list-title">Transações do Mês</div>
                              <div id="analysis-transaction-list" class="transaction-list">
                                  <div id="analysis-no-transactions" style="display: block; text-align: center; padding: 2rem 1.5rem; color: var(--text-secondary);">Carregando transações...</div>
                                  <!-- Itens carregados via JS -->
                              </div>
                          </div>
                      </div>
                      <aside class="analysis-sidebar">
                          <div class="insights-feed card">
                              <div class="insights-title"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16"><path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13h-5a.5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6 8.5a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1h.5a.5.5 0 0 1 .5.5z"/></svg>Insights Rápidos</div>
                              <div class="insights-list" id="analysis-insights-list">
                                  <div id="analysis-no-insights" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">Analisando seus dados...</div>
                                  <!-- Insights carregados via JS -->
                              </div>
                          </div>
                      </aside>
                  </div>
              </div>
         </div>
     </div>

     <!-- Modais -->
     <div class="modal" id="transaction-modal">
         <div class="modal-content">
             <form id="transaction-form">
                  <!-- Conteúdo do form de transação -->
                 <input type="hidden" id="transaction-id">
                 <input type="hidden" id="transaction-recurring-base-id">
                 <div class="modal-header"><h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div>
                 <div class="modal-body">
                     <div class="form-group"><label for="transaction-amount">Valor (R$)</label><input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required></div>
                     <div class="form-group"><label for="transaction-category">Categoria</label><div class="input-group"><select class="form-control" id="transaction-category" required></select><div class="input-group-append"><button type="button" class="btn-icon-small" id="btn-add-category-modal" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/></svg></button></div></div></div>
                     <div class="form-grid"><div class="form-group"><label for="transaction-date">Data</label><input type="date" class="form-control" id="transaction-date" required></div><div class="form-group"><label for="transaction-type">Tipo</label><select class="form-control" id="transaction-type" required><option value="expense" selected>Despesa</option><option value="income">Receita</option></select></div></div>
                     <div class="form-group"><label>Importância</label><div class="importance-group"><input type="radio" id="importance-extrema" name="transaction-importance" value="extrema"><label for="importance-extrema">Extrema</label><input type="radio" id="importance-urgente" name="transaction-importance" value="urgente"><label for="importance-urgente">Urgente</label><input type="radio" id="importance-importante" name="transaction-importance" value="importante"><label for="importance-importante">Importante</label></div></div>
                     <button type="button" class="btn-link" id="btn-toggle-advanced" style="margin-top: 1rem;">Mostrar opções avançadas <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg></button>
                     <div id="advanced-fields">
                          <div class="form-group"><label for="transaction-description">Descrição <small>(Opcional)</small></label><input type="text" class="form-control" id="transaction-description" placeholder="Ex: Supermercado da semana, Salário..."></div>
                          <div class="form-grid"><div class="form-group"><label for="transaction-status">Status</label><select class="form-control" id="transaction-status" required><option value="paid" selected>Pago</option><option value="pending">Pendente</option><option value="scheduled">Agendado</option></select></div><div class="form-group"><label for="transaction-payment-method">Forma de Pagamento</label><select class="form-control" id="transaction-payment-method"><option value="">Nenhuma</option><option value="cash">Dinheiro</option><option value="credit_card">Cartão de Crédito</option><option value="debit_card">Cartão de Débito</option><option value="bank_transfer">Transferência</option><option value="pix">PIX</option><option value="boleto">Boleto</option><option value="other">Outro</option></select></div></div>
                          <div class="form-group"><label for="transaction-notes">Observações</label><textarea class="form-control" id="transaction-notes" rows="3" placeholder="Ex: Parcela 2/12, Referente ao projeto X..."></textarea></div>
                          <div id="recurring-transaction-container"><div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;"><input type="checkbox" id="transaction-recurring" style="width: auto; height: auto; transform: scale(1.2);"><label for="transaction-recurring" style="margin-bottom: 0; font-weight: 500;">É uma transação recorrente?</label></div><div id="recurring-options" style="display: none;"><div class="form-grid"><div class="form-group"><label for="transaction-frequency">Frequência</label><select class="form-control" id="transaction-frequency"><option value="daily">Diária</option><option value="weekly">Semanal</option><option value="biweekly">Quinzenal</option><option value="monthly" selected>Mensal</option><option value="bimonthly">Bimestral</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="annual">Anual</option></select></div><div class="form-group"><label for="transaction-installments">Número de Parcelas</label><input type="number" min="2" step="1" class="form-control" id="transaction-installments" placeholder="Ex: 12"><small style="color: var(--text-secondary); font-size: 0.75rem;">Deixe em branco se for contínuo.</small></div></div><div id="edit-recurring-options" style="margin-top:1rem; padding: 1rem; background-color: var(--input-bg); border-radius: var(--radius-sm); display: none;"><p style="font-weight: 500; margin-bottom: 0.5rem;">Editando transação recorrente:</p><div style="display: flex; flex-direction: column; gap: 0.5rem;"><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="this" checked> Somente esta ocorrência</label><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="future"> Esta e futuras ocorrências</label></div></div></div></div>
                     </div>
                 </div>
                 <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="transaction-modal-save">Salvar Transação</button></div>
             </form>
         </div>
     </div>
     <div class="modal" id="category-modal">
         <div class="modal-content">
             <form id="category-form">
                 <div class="modal-header"><h3 class="modal-title" id="category-modal-title">Nova Categoria</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div>
                 <div class="modal-body"><div class="form-group"><label for="category-name">Nome</label><input type="text" class="form-control" id="category-name" required></div><div class="form-group"><label for="category-type">Tipo</label><select class="form-control" id="category-type" required><option value="expense" selected>Despesa</option><option value="income">Receita</option></select></div><div class="form-group"><label for="category-icon">Ícone (Emoji)</label><input type="text" class="form-control" id="category-icon" maxlength="2"></div><div class="form-group"><label for="category-color">Cor</label><input type="color" class="form-control" id="category-color" value="#8A8A8E"></div></div>
                 <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="category-modal-save">Salvar</button></div>
             </form>
         </div>
     </div>
      <div class="modal" id="confirm-modal">
          <div class="modal-content">
              <div class="modal-header"><h3 class="modal-title" id="confirm-modal-title">Confirmação</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div>
              <div class="modal-body"><p id="confirm-modal-message">Tem certeza?</p><div id="confirm-modal-extra-info"></div></div>
              <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button></div>
          </div>
      </div>

      <!-- Loading Indicator -->
      <div class="loading-indicator" id="loading"><div class="spinner"></div></div>
      <!-- Toast Container -->
      <div class="toast-container" id="toast-container"></div>

    <script>
    // ===== Configurações Globais e Firebase =====
    const root = document.documentElement;
    const loading = document.getElementById('loading');
    moment.locale('pt-br');

    // Configuração Firebase - COPIADA DO SEU ARQUIVO .TXT FUNCIONAL
     const firebaseConfig = {
        apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY",
        authDomain: "calculadora-da-familia.firebaseapp.com",
        projectId: "calculadora-da-familia",
        storageBucket: "calculadora-da-familia.appspot.com",
        messagingSenderId: "69721783786",
        appId: "1:69721783786:web:c4703b5c182e3681e8c693",
        measurementId: "G-YM5TR661S6"
    };

    // Inicializar Firebase - MANTENDO A LÓGICA DO SEU ARQUIVO .TXT FUNCIONAL
    let app;
    let db;
    try {
         console.log("Tentando inicializar Firebase com a config:", firebaseConfig); // Log da config
         if (!firebaseConfig.projectId || typeof firebaseConfig.projectId === 'undefined') { // Verificação mais explícita
             throw new Error("FirebaseError: 'projectId' ausente ou indefinido no objeto firebaseConfig.");
         }
         // Verifica se já foi inicializado para evitar erros de re-inicialização
         if (!firebase.apps.length) {
             app = firebase.initializeApp(firebaseConfig);
         } else {
             app = firebase.app(); // Pega a instância existente
         }
         db = firebase.firestore();
         console.log("Firebase inicializado com sucesso!");
     } catch (error) {
         console.error("Erro CRÍTICO ao inicializar Firebase:", error);
         const loadingIndicator = document.getElementById('loading');
         // Tenta usar showToast, se falhar, usa alert
         try { showToast(`Erro crítico: ${error.message}.`, "danger", 15000); }
         catch { alert(`Erro crítico ao conectar: ${error.message}.`); }

         if (loadingIndicator) {
              // Adiciona uma mensagem mais clara ao loading
              loadingIndicator.innerHTML = `<div style="color: white; text-align: center; padding: 1rem; background: var(--danger); border-radius: var(--radius-sm);">Falha na conexão com o banco de dados.<br>Verifique o console (F12) para detalhes.</div>`;
              loadingIndicator.classList.add('active'); // Garante que fique visível
         }
         // Impede a execução do restante do script se o Firebase falhar
         throw new Error("Falha na inicialização do Firebase. Execução interrompida.");
     }

    // Coleções Firestore (só define se db foi inicializado com sucesso)
    const transactionsCollection = db.collection('transactions');
    const categoriesCollection = db.collection('categories');

    // ===== Estados da Aplicação =====
    let transactions = [];
    let categories = [];
    let currentTab = 'overview';
    let currentAnalysisMonth = moment().month(); // 0-11
    let currentAnalysisYear = moment().year();
    let currentAnalysisCategory = 'all';
    let currentAnalysisImportance = 'all';
    let unsubscribeTransactions = null;
    let unsubscribeCategories = null;
    let isUpdatingAnalysis = false;
    let chartInstances = {}; // Mover declaração para escopo global

    // ===== Constantes e Mapas =====
    const TRANSACTION_TYPES = { income: { name: 'Receita', icon: '💰', colorClass: 'positive' }, expense: { name: 'Despesa', icon: '💸', colorClass: 'negative' } };
    const PAYMENT_METHODS = { 'cash': 'Dinheiro', 'credit_card': 'Cartão de Crédito', 'debit_card': 'Cartão de Débito', 'bank_transfer': 'Transferência', 'pix': 'PIX', 'boleto': 'Boleto', 'other': 'Outro' };
    const TRANSACTION_STATUS = { 'paid': { name: 'Pago', class: 'status-paid' }, 'pending': { name: 'Pendente', class: 'status-pending' }, 'scheduled': { name: 'Agendado', class: 'status-scheduled' } };
    const RECURRENCE_FREQUENCY = { 'daily': { name: 'Diária', momentUnit: 'days', momentStep: 1 }, 'weekly': { name: 'Semanal', momentUnit: 'weeks', momentStep: 1 }, 'biweekly': { name: 'Quinzenal', momentUnit: 'weeks', momentStep: 2 }, 'monthly': { name: 'Mensal', momentUnit: 'months', momentStep: 1 }, 'bimonthly': { name: 'Bimestral', momentUnit: 'months', momentStep: 2 }, 'quarterly': { name: 'Trimestral', momentUnit: 'months', momentStep: 3 }, 'semiannual': { name: 'Semestral', momentUnit: 'months', momentStep: 6 }, 'annual': { name: 'Anual', momentUnit: 'years', momentStep: 1 } };
    const DEFAULT_EXPENSE_CATEGORIES = [ { id: 'moradia', name: 'Moradia', type: 'expense', color: '#FF9500', icon: '🏠', isDefault: true }, { id: 'alimentacao', name: 'Alimentação', type: 'expense', color: '#34C759', icon: '🍔', isDefault: true }, { id: 'transporte', name: 'Transporte', type: 'expense', color: '#007AFF', icon: '🚗', isDefault: true }, { id: 'contas', name: 'Contas Fixas', type: 'expense', color: '#5AC8FA', icon: '💡', isDefault: true }, { id: 'lazer', name: 'Lazer', type: 'expense', color: '#AF52DE', icon: '🎮', isDefault: true }, { id: 'saude', name: 'Saúde', type: 'expense', color: '#FF3B30', icon: '🏥', isDefault: true }, { id: 'compras', name: 'Compras', type: 'expense', color: '#FFCC00', icon: '🛍️', isDefault: true }, { id: 'educacao', name: 'Educação', type: 'expense', color: '#5856D6', icon: '📚', isDefault: true }, { id: 'outros_despesas', name: 'Outras Despesas', type: 'expense', color: '#8E8E93', icon: '📋', isDefault: true } ];
    const DEFAULT_INCOME_CATEGORIES = [ { id: 'salario', name: 'Salário', type: 'income', color: '#34C759', icon: '💰', isDefault: true }, { id: 'freelance', name: 'Freelance/Extra', type: 'income', color: '#007AFF', icon: '💼', isDefault: true }, { id: 'investimentos', name: 'Investimentos', type: 'income', color: '#AF52DE', icon: '📈', isDefault: true }, { id: 'outros_receitas', name: 'Outras Receitas', type: 'income', color: '#8E8E93', icon: '💸', isDefault: true } ];

    // ===== Utilitários =====
    const formatCurrency = (value) => value?.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) ?? 'R$ 0,00';
    const formatDate = (dateString) => dateString ? moment(dateString).format('DD/MM/YYYY') : '--';
    const formatDateForInput = (date = new Date()) => moment(date).format('YYYY-MM-DD');
    const showLoading = () => loading?.classList.add('active');
    const hideLoading = () => loading?.classList.remove('active');
    // Implementação do showToast (mantida da versão anterior)
    function showToast(message, type = 'info', duration = 3000) { const toastContainer = document.getElementById('toast-container'); if (!toastContainer) return; const toastId = `toast-${Date.now()}`; const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.id = toastId; let icon = {'info': 'ℹ️', 'success': '✅', 'warning': '⚠️', 'danger': '❌'}[type] || 'ℹ️'; toast.innerHTML = `<span class="toast-icon">${icon}</span><span class="toast-message">${message}</span>`; toastContainer.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); const removeToast = () => { if(toast.parentNode) toast.parentNode.removeChild(toast); }; toast.addEventListener('transitionend', removeToast, { once: true }); setTimeout(removeToast, 500); }, duration); }
    function updateThemeIcon(theme) { const themeIcon = document.getElementById('theme-icon'); if(!themeIcon) return; if (theme === 'dark') { themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.708l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707z"/></svg>`; } else { themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>`; } }
    function setupTheme() { const savedTheme = localStorage.getItem('theme'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; const theme = savedTheme || (prefersDark ? 'dark' : 'light'); root.setAttribute('data-theme', theme); updateThemeIcon(theme); }
    function toggleTheme() { const currentTheme = root.getAttribute('data-theme'); const newTheme = currentTheme === 'light' ? 'dark' : 'light'; root.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); updateThemeIcon(newTheme); updateAllChartsTheme(); }

    // ===== Gerenciamento de Dados (Firestore) =====
    async function loadCategories() { if (!db) return Promise.reject("DB not init"); return new Promise(async (resolve, reject) => { try { const snapshot = await categoriesCollection.get(); let loadedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (loadedCategories.length === 0) { console.log("Adding default categories..."); const batch = db.batch(); const defaultCategories = [...DEFAULT_INCOME_CATEGORIES, ...DEFAULT_EXPENSE_CATEGORIES]; defaultCategories.forEach(cat => { const docRef = categoriesCollection.doc(cat.id); batch.set(docRef, cat); }); await batch.commit(); loadedCategories = defaultCategories; } categories = loadedCategories.sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); resolve(); } catch (error) { console.error("Error loading/ensuring categories:", error); showToast("Erro ao carregar categorias.", "danger"); categories = [...DEFAULT_INCOME_CATEGORIES, ...DEFAULT_EXPENSE_CATEGORIES].sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); reject(error); } }); }
    async function addCategory(name, type, icon, color) { if (!db) return Promise.reject("DB not init"); showLoading(); try { const newCategory = { name: name.trim(), type: type, icon: icon || (type === 'income' ? '💰' : '💸'), color: color || '#8E8E93', isDefault: false }; const docRef = await categoriesCollection.add(newCategory); showToast("Categoria adicionada!", "success"); return true; } catch (error) { console.error("Error adding category: ", error); showToast("Erro ao salvar categoria.", "danger"); return false; } finally { hideLoading();} }
    async function deleteCategory(categoryId) { if (!db) return Promise.reject("DB not init"); showLoading(); try { const categoryToDelete = categories.find(c => c.id === categoryId); if (categoryToDelete?.isDefault) { showToast("Categorias padrão não podem ser excluídas.", "warning"); hideLoading(); return false; } const querySnapshot = await transactionsCollection.where('category', '==', categoryId).limit(1).get(); if (!querySnapshot.empty) { showToast("Existem transações associadas a esta categoria.", "warning", 5000); hideLoading(); return false; } await categoriesCollection.doc(categoryId).delete(); showToast("Categoria excluída!", "success"); return true; } catch (error) { console.error("Error deleting category: ", error); showToast("Erro ao excluir categoria.", "danger"); return false; } finally { hideLoading();} }
    function processTransactionSnapshot(snapshot) { transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); transactions.sort((a, b) => moment(b.date).diff(moment(a.date))); updateDashboard(); }
    function processCategorySnapshot(snapshot) { categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); categories.sort((a, b) => a.name.localeCompare(b.name)); populateCategoryFilters(); if (currentTab === 'analysis') updateMonthlyAnalysis(); else if (currentTab === 'overview') updateOverviewCharts(); }
    function setupFirestoreListeners() { if (!db) { console.error("DB not init for listeners"); return; } stopFirestoreListeners(); unsubscribeTransactions = transactionsCollection?.onSnapshot(processTransactionSnapshot, handleListenerError("transações")); unsubscribeCategories = categoriesCollection?.onSnapshot(processCategorySnapshot, handleListenerError("categorias")); }
    function stopFirestoreListeners() { if (unsubscribeTransactions) unsubscribeTransactions(); if (unsubscribeCategories) unsubscribeCategories(); unsubscribeTransactions = null; unsubscribeCategories = null; }
    function handleListenerError(collectionName) { return (error) => { console.error(`Erro no listener de ${collectionName}:`, error); showToast(`Erro ao sincronizar ${collectionName}.`, "danger"); }; }

    // ===== Lógica de Transações =====
    function openTransactionModal(transaction = null) { const form = document.getElementById('transaction-form'); form.reset(); const modalTitle = document.getElementById('transaction-modal-title'); const transactionIdInput = document.getElementById('transaction-id'); const advancedFields = document.getElementById('advanced-fields'); const toggleAdvancedButton = document.getElementById('btn-toggle-advanced'); const recurringOptions = document.getElementById('recurring-options'); const editRecurringOptions = document.getElementById('edit-recurring-options'); const recurringBaseIdInput = document.getElementById('transaction-recurring-base-id'); advancedFields.classList.remove('visible'); toggleAdvancedButton.innerHTML = `Mostrar opções avançadas <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>`; recurringOptions.style.display = 'none'; document.getElementById('transaction-recurring').checked = false; document.getElementById('transaction-installments').value = ''; recurringBaseIdInput.value = ''; editRecurringOptions.style.display = 'none'; document.getElementById('transaction-date').value = formatDateForInput(); document.getElementById('transaction-type').value = 'expense'; document.getElementById('transaction-status').value = 'paid'; populateCategorySelect('expense'); const importanceRadios = document.querySelectorAll('input[name="transaction-importance"]'); importanceRadios.forEach(radio => radio.checked = false); if (transaction) { modalTitle.textContent = 'Editar Transação'; transactionIdInput.value = transaction.id; document.getElementById('transaction-amount').value = transaction.amount; document.getElementById('transaction-date').value = transaction.date; document.getElementById('transaction-type').value = transaction.type; populateCategorySelect(transaction.type); document.getElementById('transaction-category').value = transaction.category; if (transaction.importance) { const importanceRadio = document.getElementById(`importance-${transaction.importance}`); if(importanceRadio) importanceRadio.checked = true; } let showAdvanced = false; if (transaction.description) { document.getElementById('transaction-description').value = transaction.description; showAdvanced = true; } if (transaction.status !== 'paid') { document.getElementById('transaction-status').value = transaction.status; showAdvanced = true; } if (transaction.paymentMethod) { document.getElementById('transaction-payment-method').value = transaction.paymentMethod; showAdvanced = true; } if (transaction.notes) { document.getElementById('transaction-notes').value = transaction.notes; showAdvanced = true; } if (transaction.recurringInfo) { recurringBaseIdInput.value = transaction.recurringInfo.baseId; document.getElementById('transaction-recurring').checked = true; recurringOptions.style.display = 'block'; document.getElementById('transaction-frequency').value = transaction.recurringInfo.frequency; document.getElementById('transaction-installments').value = transaction.recurringInfo.totalInstallments || ''; showAdvanced = true; editRecurringOptions.style.display = 'block'; document.querySelector('input[name="edit-recurring-scope"][value="this"]').checked = true; } else { recurringBaseIdInput.value = ''; editRecurringOptions.style.display = 'none'; } if (showAdvanced) { advancedFields.classList.add('visible'); toggleAdvancedButton.innerHTML = `Ocultar opções avançadas <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;"><path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>`; } } else { modalTitle.textContent = 'Nova Transação'; transactionIdInput.value = ''; recurringBaseIdInput.value = ''; editRecurringOptions.style.display = 'none'; } openModal(document.getElementById('transaction-modal')); setTimeout(() => document.getElementById('transaction-amount').focus(), 100); }
    async function saveTransaction(event) { if (!db) return; event.preventDefault(); showLoading(); try { const transactionId = document.getElementById('transaction-id').value; const amount = parseFloat(document.getElementById('transaction-amount').value); const category = document.getElementById('transaction-category').value; const date = document.getElementById('transaction-date').value; const type = document.getElementById('transaction-type').value; const importanceRadio = document.querySelector('input[name="transaction-importance"]:checked'); const importance = importanceRadio ? importanceRadio.value : null; const description = document.getElementById('transaction-description').value.trim(); const status = document.getElementById('transaction-status').value; const paymentMethod = document.getElementById('transaction-payment-method').value || null; const notes = document.getElementById('transaction-notes').value.trim(); const isRecurring = document.getElementById('transaction-recurring').checked; const frequency = document.getElementById('transaction-frequency').value; const installmentsInput = document.getElementById('transaction-installments').value; const totalInstallments = installmentsInput ? parseInt(installmentsInput) : null; if (isNaN(amount) || amount <= 0 || !category || !date) { showToast("Valor, Categoria e Data são obrigatórios.", "warning"); hideLoading(); return; } if(isRecurring && !frequency) { showToast("Selecione a frequência da recorrência.", "warning"); hideLoading(); return; } if(isRecurring && totalInstallments !== null && totalInstallments < 2) { showToast("O número de parcelas deve ser 2 ou maior.", "warning"); hideLoading(); return; } const baseTransactionData = { amount, category, date, type, importance, description: description || null, status, paymentMethod, notes: notes || null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }; const isEditing = !!transactionId; const recurringBaseId = document.getElementById('transaction-recurring-base-id').value; const isEditingRecurring = isEditing && !!recurringBaseId; if (isEditingRecurring) { const editScope = document.querySelector('input[name="edit-recurring-scope"]:checked').value; if (editScope === 'this') { const transactionRef = transactionsCollection.doc(transactionId); const updateData = { ...baseTransactionData, recurringInfo: firebase.firestore.FieldValue.delete(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }; await transactionRef.update(updateData); showToast("Ocorrência atualizada.", "success"); } else { const originalTransaction = transactions.find(t => t.id === transactionId); if (!originalTransaction) throw new Error("Transação original não encontrada."); const batch = db.batch(); const currentRef = transactionsCollection.doc(transactionId); batch.update(currentRef, { ...baseTransactionData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); const futureQuery = transactionsCollection.where('recurringInfo.baseId', '==', recurringBaseId).where('date', '>', originalTransaction.date).orderBy('date', 'asc'); const futureSnapshot = await futureQuery.get(); futureSnapshot.docs.forEach(doc => { const futureData = { ...baseTransactionData }; delete futureData.date; delete futureData.status; futureData.updatedAt = firebase.firestore.FieldValue.serverTimestamp(); if(isRecurring && doc.data().recurringInfo) { futureData.recurringInfo = { ...doc.data().recurringInfo, frequency: frequency, totalInstallments: totalInstallments }} else if (!isRecurring && doc.data().recurringInfo) { futureData.recurringInfo = firebase.firestore.FieldValue.delete(); } batch.update(doc.ref, futureData); }); await batch.commit(); showToast("Esta e futuras ocorrências atualizadas.", "success"); } } else if (isEditing && !isRecurring) { await transactionsCollection.doc(transactionId).update({ ...baseTransactionData, recurringInfo: firebase.firestore.FieldValue.delete(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); showToast("Transação atualizada.", "success"); } else if (isEditing && isRecurring) { const baseId = uuid.v4(); const firstInstallmentData = { ...baseTransactionData, recurringInfo: { baseId: baseId, frequency: frequency, currentInstallment: 1, totalInstallments: totalInstallments }, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }; const batch = db.batch(); batch.update(transactionsCollection.doc(transactionId), firstInstallmentData); await generateFutureInstallments(batch, baseTransactionData, baseId, frequency, totalInstallments, date, 1); await batch.commit(); showToast("Transação atualizada e recorrência criada.", "success"); } else if (!isEditing && isRecurring) { const baseId = uuid.v4(); const firstInstallmentData = { ...baseTransactionData, recurringInfo: { baseId: baseId, frequency: frequency, currentInstallment: 1, totalInstallments: totalInstallments } }; const batch = db.batch(); const firstDocRef = transactionsCollection.doc(); batch.set(firstDocRef, firstInstallmentData); await generateFutureInstallments(batch, baseTransactionData, baseId, frequency, totalInstallments, date, 1); await batch.commit(); showToast(`Transação ${totalInstallments ? 'parcelada' : 'recorrente'} criada.`, "success"); } else { await transactionsCollection.add(baseTransactionData); showToast("Transação adicionada.", "success"); } closeModal(document.getElementById('transaction-modal')); } catch (error) { console.error("Erro ao salvar transação: ", error); showToast("Erro ao salvar. Verifique o console.", "danger"); } finally { hideLoading();} }
    async function generateFutureInstallments(batch, baseData, baseId, frequency, totalInstallments, startDate, startInstallmentNum) { if (!db) return; const freqInfo = RECURRENCE_FREQUENCY[frequency]; if (!freqInfo) return; const maxInstallments = totalInstallments ?? 24; const limitDate = moment(startDate).add(2, 'years'); let currentDate = moment(startDate); for (let i = startInstallmentNum + 1; i <= maxInstallments; i++) { currentDate = currentDate.add(freqInfo.momentStep, freqInfo.momentUnit); if(!totalInstallments && currentDate.isAfter(limitDate)) { console.warn("Limite de 2 anos atingido."); break; } const futureInstallmentData = { ...baseData, date: currentDate.format('YYYY-MM-DD'), status: 'scheduled', description: `${baseData.description || 'Recorrência'} ${totalInstallments ? `(${i}/${totalInstallments})` : ''}`.trim(), recurringInfo: { baseId: baseId, frequency: frequency, currentInstallment: i, totalInstallments: totalInstallments }, createdAt: baseData.createdAt, updatedAt: baseData.updatedAt }; delete futureInstallmentData.id; const futureDocRef = transactionsCollection.doc(); batch.set(futureDocRef, futureInstallmentData); } }
    async function deleteTransaction(transactionId, recurringBaseId = null, deleteScope = 'this') { if (!db) return; showLoading(); try { if (recurringBaseId && deleteScope !== 'this') { const batch = db.batch(); const originalTransaction = transactions.find(t => t.id === transactionId); if (!originalTransaction) throw new Error("Transação original não encontrada."); batch.delete(transactionsCollection.doc(transactionId)); const futureQuery = transactionsCollection.where('recurringInfo.baseId', '==', recurringBaseId).where('date', '>=', originalTransaction.date); const futureSnapshot = await futureQuery.get(); futureSnapshot.docs.forEach(doc => { if (doc.id !== transactionId) { batch.delete(doc.ref); } }); await batch.commit(); showToast("Esta e futuras ocorrências excluídas.", "success"); } else { await transactionsCollection.doc(transactionId).delete(); showToast("Transação excluída.", "success"); } } catch (error) { console.error("Erro ao excluir transação: ", error); showToast("Erro ao excluir transação.", "danger"); } finally { hideLoading(); const confirmM = document.getElementById('confirm-modal'); if(confirmM?.classList.contains('active')) { closeModal(confirmM); } } }

    // ===== Interface e Interação =====
    function openModal(modalElement) { modalElement?.classList.add('active'); }
    function closeModal(modalElement) { modalElement?.classList.remove('active'); }
    function initTabs() { const tabLinks = document.querySelectorAll('.tab'); const tabContents = document.querySelectorAll('.tab-content'); tabLinks.forEach(tab => { tab.addEventListener('click', () => { const targetTabId = tab.dataset.tab; if (currentTab === targetTabId || isUpdatingAnalysis) return; showLoading(); tabLinks.forEach(t => t.classList.remove('active')); tabContents.forEach(c => c.classList.remove('active')); tab.classList.add('active'); const targetContent = document.getElementById(`tab-${targetTabId}`); if(targetContent) targetContent.classList.add('active'); currentTab = targetTabId; setTimeout(async () => { try { if (targetTabId === 'analysis') { await updateMonthlyAnalysis(); } else { updateOverviewCharts(); updateKPIs(); } } catch (error) { console.error(`Erro ao atualizar aba ${targetTabId}:`, error); showToast("Erro ao carregar dados.", "danger"); } finally { hideLoading(); } }, 50); }); }); }
    function populateCategoryFilters() { const analysisCategorySelect = document.getElementById('analysis-category'); const transactionCategorySelect = document.getElementById('transaction-category'); const selectedAnalysisCategory = analysisCategorySelect.value; analysisCategorySelect.innerHTML = '<option value="all">Todas as Categorias</option>'; transactionCategorySelect.innerHTML = ''; categories.forEach(cat => { const option = document.createElement('option'); option.value = cat.id; option.textContent = `${cat.icon || ''} ${cat.name}`; analysisCategorySelect.appendChild(option.cloneNode(true)); }); populateCategorySelect(document.getElementById('transaction-type').value); analysisCategorySelect.value = selectedAnalysisCategory; toggleDeleteCategoryButton(); }
    function populateCategorySelect(type = 'expense') { const select = document.getElementById('transaction-category'); select.innerHTML = ''; const filteredCategories = categories.filter(cat => cat.type === type); if (filteredCategories.length === 0) { const option = document.createElement('option'); option.value = ""; option.textContent = `Nenhuma categoria de ${type === 'income' ? 'receita' : 'despesa'} encontrada`; option.disabled = true; select.appendChild(option); } else { filteredCategories.forEach(cat => { const option = document.createElement('option'); option.value = cat.id; option.textContent = `${cat.icon || ''} ${cat.name}`; select.appendChild(option); }); } }
    function toggleDeleteCategoryButton() { const select = document.getElementById('analysis-category'); const deleteButton = document.getElementById('btn-delete-category'); if (!select || !deleteButton) return; if (select.value !== 'all') { const category = categories.find(c => c.id === select.value); deleteButton.style.display = (category && !category.isDefault) ? 'inline-flex' : 'none'; } else { deleteButton.style.display = 'none'; } }
    function populateMonthYearFilter() { const monthSelect = document.getElementById('analysis-month'); const yearSelect = document.getElementById('analysis-year'); monthSelect.innerHTML = ''; yearSelect.innerHTML = ''; moment.months().forEach((monthName, index) => { const option = document.createElement('option'); option.value = index; option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1); monthSelect.appendChild(option); }); const currentYear = moment().year(); const startYear = currentYear - 3; const endYear = currentYear + 5; for (let year = endYear; year >= startYear; year--) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } monthSelect.value = moment().month(); yearSelect.value = currentYear; currentAnalysisMonth = parseInt(monthSelect.value); currentAnalysisYear = parseInt(yearSelect.value); }
    function setupEventListeners() { document.getElementById('btn-new-transaction')?.addEventListener('click', () => openTransactionModal()); document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme); document.getElementById('transaction-form')?.addEventListener('submit', saveTransaction); document.getElementById('transaction-type')?.addEventListener('change', (e) => populateCategorySelect(e.target.value)); document.getElementById('btn-toggle-advanced')?.addEventListener('click', toggleAdvancedFields); document.getElementById('transaction-recurring')?.addEventListener('change', (e) => { document.getElementById('recurring-options').style.display = e.target.checked ? 'block' : 'none'; }); document.getElementById('analysis-month')?.addEventListener('change', (e) => { currentAnalysisMonth = parseInt(e.target.value); if (!isUpdatingAnalysis) updateMonthlyAnalysis(); }); document.getElementById('analysis-year')?.addEventListener('change', (e) => { currentAnalysisYear = parseInt(e.target.value); if (!isUpdatingAnalysis) updateMonthlyAnalysis(); }); document.getElementById('analysis-category')?.addEventListener('change', (e) => { currentAnalysisCategory = e.target.value; toggleDeleteCategoryButton(); if (!isUpdatingAnalysis) updateMonthlyAnalysis(); }); document.getElementById('analysis-importance')?.addEventListener('change', (e) => { currentAnalysisImportance = e.target.value; if (!isUpdatingAnalysis) updateMonthlyAnalysis(); }); document.getElementById('btn-add-category')?.addEventListener('click', () => openCategoryModal()); document.getElementById('btn-add-category-modal')?.addEventListener('click', () => openCategoryModal()); document.getElementById('btn-delete-category')?.addEventListener('click', () => { const categoryId = document.getElementById('analysis-category').value; if (categoryId && categoryId !== 'all') { confirmDeleteCategory(categoryId); } }); document.getElementById('category-form')?.addEventListener('submit', handleSaveCategory); document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => { btn.addEventListener('click', () => { const modalToClose = btn.closest('.modal'); if (modalToClose) closeModal(modalToClose); }); }); document.getElementById('confirm-modal-confirm')?.addEventListener('click', () => { const action = document.getElementById('confirm-modal-confirm')._action; if (action && typeof action === 'function') { action(); } else { closeModal(document.getElementById('confirm-modal')); } }); }
    function toggleAdvancedFields() { const advancedFields = document.getElementById('advanced-fields'); const button = document.getElementById('btn-toggle-advanced'); const isVisible = advancedFields.classList.toggle('visible'); button.innerHTML = isVisible ? `Ocultar opções avançadas <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;"><path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>` : `Mostrar opções avançadas <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>`; }
    function openCategoryModal() { document.getElementById('category-form').reset(); document.getElementById('category-modal-title').textContent = "Nova Categoria"; document.getElementById('category-color').value = '#8A8A8E'; openModal(document.getElementById('category-modal')); setTimeout(() => document.getElementById('category-name').focus(), 100); }
    async function handleSaveCategory(event) { event.preventDefault(); const name = document.getElementById('category-name').value; const type = document.getElementById('category-type').value; const icon = document.getElementById('category-icon').value; const color = document.getElementById('category-color').value; if (!name || !type) { showToast("Nome e Tipo são obrigatórios.", "warning"); return; } const success = await addCategory(name, type, icon, color); if (success) closeModal(document.getElementById('category-modal')); }
    function confirmDeleteCategory(categoryId) { const category = categories.find(c => c.id === categoryId); if (!category) return; if (category.isDefault) { showToast("Categorias padrão não podem ser excluídas.", "warning"); return; } const confirmModalElement = document.getElementById('confirm-modal'); document.getElementById('confirm-modal-title').textContent = "Excluir Categoria"; document.getElementById('confirm-modal-message').textContent = `Tem certeza que deseja excluir a categoria "${category.name}"?`; document.getElementById('confirm-modal-extra-info').textContent = "Atenção: Apenas categorias sem transações associadas podem ser excluídas."; document.getElementById('confirm-modal-confirm').textContent = "Excluir"; document.getElementById('confirm-modal-confirm').className = 'btn btn-danger'; document.getElementById('confirm-modal-confirm')._action = () => deleteCategory(categoryId); openModal(confirmModalElement); }
    function confirmDeleteTransaction(transactionId) { const transaction = transactions.find(t => t.id === transactionId); if (!transaction) return; const confirmModalElement = document.getElementById('confirm-modal'); document.getElementById('confirm-modal-title').textContent = "Excluir Transação"; const description = transaction.description || `Transação de ${formatCurrency(transaction.amount)}`; let message = `Tem certeza que deseja excluir "${description}" de ${formatDate(transaction.date)}?`; let extraInfo = "Esta ação não pode ser desfeita."; let deleteScope = 'this'; const recurringBaseId = transaction.recurringInfo?.baseId; if(recurringBaseId) { message = `Esta é uma transação recorrente. O que deseja excluir?`; extraInfo = `<div style="display: flex; flex-direction: column; gap: 0.75rem;"><label><input type="radio" name="delete-scope" value="this" checked> Somente esta ocorrência (${formatDate(transaction.date)})</label><label><input type="radio" name="delete-scope" value="future"> Esta e futuras ocorrências</label></div>`; const radios = confirmModalElement.querySelectorAll('input[name="delete-scope"]'); radios.forEach(radio => { radio.onchange = (e) => { deleteScope = e.target.value; }; }); } document.getElementById('confirm-modal-message').textContent = message; document.getElementById('confirm-modal-extra-info').innerHTML = extraInfo; document.getElementById('confirm-modal-confirm').textContent = "Excluir"; document.getElementById('confirm-modal-confirm').className = 'btn btn-danger'; document.getElementById('confirm-modal-confirm')._action = () => deleteTransaction(transactionId, recurringBaseId, deleteScope); openModal(confirmModalElement); }


    // ===== Atualização da UI =====
    function updateDashboard() { updateKPIs(); if (currentTab === 'overview') { updateOverviewCharts(); } else if (currentTab === 'analysis' && !isUpdatingAnalysis) { updateMonthlyAnalysis(); } }
    function updateKPIs() { const totalIncome = transactions.filter(t => t.type === 'income' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0); const totalExpenses = transactions.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0); const currentBalance = totalIncome - totalExpenses; document.getElementById('kpi-balance').textContent = formatCurrency(currentBalance); const currentMonthStart = moment().startOf('month'); const currentMonthEnd = moment().endOf('month'); const currentMonthIncome = transactions.filter(t => t.type === 'income' && moment(t.date).isBetween(currentMonthStart, currentMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); const currentMonthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(currentMonthStart, currentMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); document.getElementById('kpi-income').textContent = formatCurrency(currentMonthIncome); document.getElementById('kpi-expenses').textContent = formatCurrency(currentMonthExpenses); const currentMonthSavings = currentMonthIncome - currentMonthExpenses; const savingsEl = document.getElementById('kpi-savings'); savingsEl.textContent = formatCurrency(currentMonthSavings); savingsEl.style.color = currentMonthSavings >= 0 ? 'var(--success)' : 'var(--danger)'; const savingsProgress = document.getElementById('savings-progress'); const savingsStatus = document.getElementById('savings-status'); let savingsPercentage = 0; if (currentMonthIncome > 0) { savingsPercentage = Math.max(0, (currentMonthSavings / currentMonthIncome) * 100); savingsProgress.style.width = `${savingsPercentage}%`; savingsProgress.className = `progress-bar ${currentMonthSavings >= 0 ? 'success' : 'danger'}`; savingsStatus.textContent = `${currentMonthSavings >= 0 ? 'Positiva' : 'Negativa'} (${savingsPercentage.toFixed(0)}% da receita)`; } else { savingsProgress.style.width = '0%'; savingsProgress.className = 'progress-bar'; savingsStatus.textContent = currentMonthExpenses > 0 ? 'Apenas despesas' : 'Sem movimentação'; } const scheduledExpenses = transactions.filter(t => t.type === 'expense' && t.status !== 'paid' && moment(t.date).isBetween(currentMonthStart, currentMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); const projectedExpenses = currentMonthExpenses + scheduledExpenses; document.getElementById('kpi-projection').textContent = formatCurrency(projectedExpenses); document.getElementById('projection-status').textContent = `Realizado: ${formatCurrency(currentMonthExpenses)} | Previsto: ${formatCurrency(scheduledExpenses)}`; const lastMonthStart = moment().subtract(1, 'month').startOf('month'); const lastMonthEnd = moment().subtract(1, 'month').endOf('month'); const lastMonthIncome = transactions.filter(t => t.type === 'income' && moment(t.date).isBetween(lastMonthStart, lastMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); const lastMonthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(lastMonthStart, lastMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); const lastMonthBalance = lastMonthIncome - lastMonthExpenses; const updateTrend = (current, previous, elementId, indicatorElementId) => { const trendElement = document.getElementById(elementId); const indicatorElement = document.getElementById(indicatorElementId); const svgElement = indicatorElement?.querySelector('svg'); if(!trendElement || !indicatorElement || !svgElement) return; let percentage = 0; let trendClass = 'neutral'; let iconPathD = 'M4 12 L20 12'; if (previous !== 0) { percentage = ((current - previous) / Math.abs(previous)) * 100; } else if (current !== 0) { percentage = 100 * Math.sign(current); } const isExpense = elementId.includes('expenses'); if (percentage > 0.1) { trendClass = isExpense ? 'down' : 'up'; iconPathD = 'M12 4 L20 12 L4 12 Z'; } else if (percentage < -0.1) { trendClass = isExpense ? 'up' : 'down'; iconPathD = 'M12 20 L4 12 L20 12 Z'; } trendElement.textContent = `${Math.abs(percentage).toFixed(0)}%`; indicatorElement.className = `kpi-trend ${trendClass}`; const pathElement = svgElement.querySelector('path'); if (pathElement) { pathElement.setAttribute('d', iconPathD); if (trendClass !== 'neutral') { pathElement.style.fill = 'currentColor'; pathElement.style.stroke = 'none'; } else { pathElement.style.fill = 'none'; pathElement.style.stroke = 'currentColor'; pathElement.style.strokeWidth = '2.5'; } } }; updateTrend(currentBalance, lastMonthBalance, 'balance-trend', 'balance-trend-indicator'); updateTrend(currentMonthIncome, lastMonthIncome, 'income-trend', 'income-trend-indicator'); updateTrend(currentMonthExpenses, lastMonthExpenses, 'expenses-trend', 'expenses-trend-indicator'); }

    // ===== Lógica da Análise Mensal =====
    async function updateMonthlyAnalysis() { if (isUpdatingAnalysis) return; isUpdatingAnalysis = true; showLoading(); const selectedMonth = currentAnalysisMonth; const selectedYear = currentAnalysisYear; const selectedCategory = currentAnalysisCategory; const selectedImportance = currentAnalysisImportance; const selectedMonthMoment = moment().year(selectedYear).month(selectedMonth); const startOfMonth = selectedMonthMoment.startOf('month'); const endOfMonth = selectedMonthMoment.endOf('month'); try { const monthlyTransactions = transactions.filter(t => { const transactionMoment = moment(t.date); const isSameMonth = transactionMoment.isBetween(startOfMonth, endOfMonth, 'day', '[]'); const isSameCategory = (selectedCategory === 'all' || t.category === selectedCategory); const isSameImportance = ( selectedImportance === 'all' || (selectedImportance === 'none' && !t.importance) || t.importance === selectedImportance ); return isSameMonth && isSameCategory && isSameImportance; }); calculateMonthlyIndicators(monthlyTransactions, selectedMonthMoment); renderMonthlyTransactionList(monthlyTransactions); generateAndRenderInsights(monthlyTransactions, selectedMonthMoment); updateAnalysisCharts(monthlyTransactions); } catch (error) { console.error("Erro updateMonthlyAnalysis:", error); showToast("Erro ao processar análise.", "danger"); } finally { hideLoading(); isUpdatingAnalysis = false; } }
    function calculateMonthlyIndicators(monthlyTransactions, selectedMonthMoment) { const income = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const expenses = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); const balance = income - expenses; document.getElementById('analysis-total-income').textContent = formatCurrency(income); document.getElementById('analysis-total-expenses').textContent = formatCurrency(expenses); const balanceEl = document.getElementById('analysis-final-balance'); balanceEl.textContent = formatCurrency(balance); balanceEl.className = `indicator-value ${balance >= 0 ? 'positive' : 'negative'}`; const today = moment(); const endOfMonth = selectedMonthMoment.clone().endOf('month'); const daysLeft = endOfMonth.diff(today, 'days'); const statusEl = document.getElementById('analysis-month-status'); const daysLeftEl = document.getElementById('analysis-days-left'); if (selectedMonthMoment.isSame(today, 'month')) { statusEl.textContent = 'Em Andamento'; daysLeftEl.textContent = `${Math.max(0, daysLeft)} dias restantes`; } else if (selectedMonthMoment.isBefore(today, 'month')) { statusEl.textContent = 'Fechado'; daysLeftEl.textContent = 'Mês encerrado'; } else { statusEl.textContent = 'Futuro'; daysLeftEl.textContent = 'Mês futuro'; } const lastMonthMoment = selectedMonthMoment.clone().subtract(1, 'month'); const lastMonthStart = lastMonthMoment.startOf('month'); const lastMonthEnd = lastMonthMoment.endOf('month'); const lastMonthTransactions = transactions.filter(t => { const transactionMoment = moment(t.date); const isSameMonth = transactionMoment.isBetween(lastMonthStart, lastMonthEnd, 'day', '[]'); const isSameCategory = (currentAnalysisCategory === 'all' || t.category === currentAnalysisCategory); const isSameImportance = ( currentAnalysisImportance === 'all' || (currentAnalysisImportance === 'none' && !t.importance) || t.importance === currentAnalysisImportance ); return isSameMonth && isSameCategory && isSameImportance; }); const lastMonthIncome = lastMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const lastMonthExpenses = lastMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); const lastMonthBalance = lastMonthIncome - lastMonthExpenses; const formatComparison = (current, previous) => { if (previous === 0 && current === 0) return "--"; if (previous === 0) return current > 0 ? "+100%" : (current < 0 ? "-100%" : "--"); const diff = current - previous; const percentage = ((diff / Math.abs(previous)) * 100); if (Math.abs(percentage) < 0.1) return "0% vs mês anterior"; return `${percentage >= 0 ? '+' : ''}${percentage.toFixed(0)}% vs mês anterior`; }; document.getElementById('analysis-income-comparison').textContent = formatComparison(income, lastMonthIncome); document.getElementById('analysis-expense-comparison').textContent = formatComparison(expenses, lastMonthExpenses); document.getElementById('analysis-balance-comparison').textContent = formatComparison(balance, lastMonthBalance); const expensesByCategory = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {}); const topCategoryEntry = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a)[0]; const topCategoryEl = document.getElementById('analysis-top-category'); const topCategoryValueEl = document.getElementById('analysis-top-category-value'); if (topCategoryEntry) { const [categoryId, amount] = topCategoryEntry; const category = categories.find(c => c.id === categoryId); topCategoryEl.textContent = category ? `${category.icon || ''} ${category.name}`.trim() : 'Desconhecida'; topCategoryValueEl.textContent = formatCurrency(amount); } else { topCategoryEl.textContent = '--'; topCategoryValueEl.textContent = formatCurrency(0); } }
    function renderMonthlyTransactionList(monthlyTransactions) { const listContainer = document.getElementById('analysis-transaction-list'); const noTransactionsMessage = document.getElementById('analysis-no-transactions'); listContainer.innerHTML = ''; if (monthlyTransactions.length === 0) { noTransactionsMessage.style.display = 'block'; listContainer.appendChild(noTransactionsMessage); return; } noTransactionsMessage.style.display = 'none'; monthlyTransactions.forEach(t => { const category = categories.find(c => c.id === t.category) || { name: '?', icon: '❓', color: '#8E8E93' }; const item = document.createElement('div'); item.className = 'transaction-item'; item.addEventListener('click', (e) => { if (!e.target.closest('.delete-transaction-btn')) openTransactionModal(t); }); const amountPrefix = t.type === 'income' ? '+' : '-'; const importanceClass = t.importance ? `transaction-importance ${t.importance}` : ''; item.innerHTML = `<div class="transaction-item-left"><div class="transaction-icon" style="background-color: ${category.color};">${category.icon}</div><div class="transaction-info"><div class="transaction-description">${t.description || category.name}</div><div class="transaction-category">${category.name}</div></div></div><div class="transaction-item-right"><div class="transaction-amount ${t.type}">${amountPrefix} ${formatCurrency(t.amount)}${importanceClass ? `<span class="${importanceClass}" title="Importância: ${t.importance}"></span>` : ''}</div><div class="transaction-date">${formatDate(t.date)}</div></div><button class="delete-transaction-btn" title="Excluir Transação"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16"><path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/></svg></button>`; item.querySelector('.delete-transaction-btn').addEventListener('click', (e) => { e.stopPropagation(); confirmDeleteTransaction(t.id); }); listContainer.appendChild(item); }); }
    function generateAndRenderInsights(monthlyTransactions, selectedMonthMoment) { const insightsList = document.getElementById('analysis-insights-list'); const noInsightsMessage = document.getElementById('analysis-no-insights'); insightsList.innerHTML = ''; const insights = []; const income = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const expenses = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); const balance = income - expenses; const lastMonthMoment = selectedMonthMoment.clone().subtract(1, 'month'); const lastMonthStart = lastMonthMoment.startOf('month'); const lastMonthEnd = lastMonthMoment.endOf('month'); const lastMonthTransactions = transactions.filter(t => moment(t.date).isBetween(lastMonthStart, lastMonthEnd, 'day', '[]')); const lastMonthExpenses = lastMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); if (lastMonthExpenses > 0) { const expenseChange = ((expenses - lastMonthExpenses) / lastMonthExpenses) * 100; if (expenseChange > 15) insights.push({ type: 'warning', text: `🚨 Atenção: Despesas totais aumentaram ${expenseChange.toFixed(0)}% vs mês anterior.` }); else if (expenseChange < -10) insights.push({ type: 'success', text: `✅ Ótimo! Despesas totais diminuíram ${Math.abs(expenseChange).toFixed(0)}% este mês.` }); } else if (expenses > 0) insights.push({ type: 'info', text: `ℹ️ Primeiro mês com registro de despesas.` }); if (balance > 0) insights.push({ type: 'success', text: `👍 Parabéns! Saldo positivo de ${formatCurrency(balance)}.` }); else if (balance < 0) insights.push({ type: 'alert', text: `📉 Cuidado! Saldo negativo de ${formatCurrency(Math.abs(balance))}.` }); else insights.push({ type: 'neutral', text: `⚖️ Saldo final do mês foi zero.` }); const expensesByCategory = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {}); const lastMonthExpensesByCategory = lastMonthTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {}); const sortedCategories = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a); if (sortedCategories.length > 0) { const [topCategoryId, topAmount] = sortedCategories[0]; const topCategory = categories.find(c => c.id === topCategoryId); insights.push({ type: 'info', text: `🔍 Maior despesa: ${topCategory?.name || '?'} (${formatCurrency(topAmount)}).` }); } sortedCategories.slice(0, 5).forEach(([categoryId, currentAmount]) => { const lastAmount = lastMonthExpensesByCategory[categoryId] || 0; if (lastAmount > 0) { const change = ((currentAmount - lastAmount) / lastAmount) * 100; const category = categories.find(c => c.id === categoryId); if (change > 25) insights.push({ type: 'warning', text: `📈 Gastos com ${category?.name || '?'} subiram ${change.toFixed(0)}%.` }); else if (change < -20) insights.push({ type: 'success', text: `📉 Gastos com ${category?.name || '?'} diminuíram ${Math.abs(change).toFixed(0)}%.` }); } }); const expensesByDayOfWeek = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { const day = moment(t.date).day(); acc[day] = (acc[day] || 0) + 1; return acc; }, {}); const busiestDayEntry = Object.entries(expensesByDayOfWeek).sort(([, a], [, b]) => b - a)[0]; if (busiestDayEntry) { const dayIndex = parseInt(busiestDayEntry[0]); const dayName = moment().day(dayIndex).format('dddd'); if (busiestDayEntry[1] > monthlyTransactions.length * 0.3 && monthlyTransactions.length > 5) { insights.push({ type: 'neutral', text: `🔄 Padrão: ${dayName} parece ser seu dia de maior volume de gastos.` }); } } if (insights.length > 0) { noInsightsMessage.style.display = 'none'; insights.forEach(insight => { const item = document.createElement('div'); item.className = `insight-item ${insight.type}`; let icon = {'alert':'🚨','warning':'⚠️','success':'✅','info':'ℹ️','neutral':'🔍'}[insight.type] || '💬'; item.innerHTML = `<span class="insight-icon">${icon}</span><span class="insight-text">${insight.text}</span>`; insightsList.appendChild(item); }); } else { noInsightsMessage.textContent = "Nenhum insight relevante."; noInsightsMessage.style.display = 'block'; } }

    // ===== Gráficos =====
    function getChartCommonOptions(isDarkMode) { const textColor = isDarkMode ? '#E0E0E0' : '#333333'; const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.07)'; const tooltipBg = isDarkMode ? 'rgba(40, 40, 40, 0.85)' : 'rgba(255, 255, 255, 0.9)'; const tooltipText = isDarkMode ? '#FFFFFF' : '#1C1C1E'; return { responsive: true, maintainAspectRatio: false, color: textColor, plugins: { legend: { position: 'bottom', align: 'center', labels: { color: textColor, boxWidth: 12, padding: 20, font: { size: 13 } } }, tooltip: { enabled: true, backgroundColor: tooltipBg, titleColor: tooltipText, bodyColor: tooltipText, borderColor: gridColor, borderWidth: 1, padding: 12, cornerRadius: 8, usePointStyle: true, boxPadding: 4, callbacks: { label: function(context) { let label = context.dataset.label || context.label || ''; if (label) label += ': '; let value = context.parsed.y ?? context.parsed.x ?? context.parsed; if (value !== null && typeof value === 'number') label += formatCurrency(value); return label; }, labelPointStyle: function(context) { return { pointStyle: 'circle', rotation: 0 }; }, footer: function(tooltipItems) { if (tooltipItems[0]?.chart?.config?.type?.match(/pie|doughnut/)) { const sum = tooltipItems[0].dataset.data.reduce((a, b) => a + b, 0); const value = tooltipItems[0].parsed; if (sum === 0) return 'Percentual: 0.0%'; const percentage = ((value / sum) * 100).toFixed(1) + '%'; return `Percentual: ${percentage}`; } return ''; } } } }, scales: { x: { grid: { color: gridColor, drawBorder: false }, ticks: { color: textColor, font: { size: 12 } } }, y: { grid: { color: gridColor, drawBorder: false }, ticks: { color: textColor, font: { size: 12 }, callback: function(value) { return formatCurrency(value); } }, beginAtZero: true } } }; }
    function initCharts() { const isDark = root.getAttribute('data-theme') === 'dark'; const commonOptions = getChartCommonOptions(isDark); Object.values(chartInstances).forEach(chart => chart?.destroy()); chartInstances = {}; const chartConfigs = { 'overview-income-expense-chart': { type: 'bar', options: commonOptions }, 'overview-category-chart': { type: 'doughnut', options: {...commonOptions, cutout: '65%'} }, 'overview-cashflow-chart': { type: 'bar', options: commonOptions }, 'overview-fixed-variable-chart': { type: 'pie', options: commonOptions }, 'overview-trend-chart': { type: 'line', options: {...commonOptions, tension: 0.3, pointRadius: 3, pointHoverRadius: 5 } }, 'analysis-category-pie-chart': { type: 'pie', options: commonOptions }, 'analysis-balance-line-chart': { type: 'line', options: {...commonOptions, tension: 0.1, pointRadius: 3, pointHoverRadius: 5 } } }; for (const [canvasId, config] of Object.entries(chartConfigs)) { const ctx = document.getElementById(canvasId)?.getContext('2d'); if (ctx) { try { chartInstances[canvasId] = new Chart(ctx, { type: config.type, data: { labels: [], datasets: [] }, options: config.options }); } catch (e) { console.error(`Erro inicializando ${canvasId}:`, e); } } } }
    function getChartInstance(canvasId) { return chartInstances[canvasId]; }
    function updateAllChartsTheme() { const isDark = root.getAttribute('data-theme') === 'dark'; const newOptions = getChartCommonOptions(isDark); Object.values(chartInstances).forEach(chart => { if (chart?.options) { const specificOptions = { cutout: chart.options.cutout, tension: chart.options.tension, pointRadius: chart.options.pointRadius, pointHoverRadius: chart.options.pointHoverRadius, indexAxis: chart.options.indexAxis }; Object.keys(specificOptions).forEach(key => specificOptions[key] === undefined && delete specificOptions[key]); chart.options = { ...chart.options, ...newOptions, ...specificOptions }; if(chart.options.plugins?.legend?.labels) chart.options.plugins.legend.labels.color = newOptions.color; if(chart.options.plugins?.tooltip) { chart.options.plugins.tooltip.backgroundColor = newOptions.plugins.tooltip.backgroundColor; chart.options.plugins.tooltip.titleColor = newOptions.plugins.tooltip.titleColor; chart.options.plugins.tooltip.bodyColor = newOptions.plugins.tooltip.bodyColor; chart.options.plugins.tooltip.borderColor = newOptions.plugins.tooltip.borderColor; } if(chart.options.scales?.x?.ticks) chart.options.scales.x.ticks.color = newOptions.color; if(chart.options.scales?.x?.grid) chart.options.scales.x.grid.color = newOptions.scales.x.grid.color; if(chart.options.scales?.y?.ticks) chart.options.scales.y.ticks.color = newOptions.color; if(chart.options.scales?.y?.grid) chart.options.scales.y.grid.color = newOptions.scales.y.grid.color; chart.update(); } }); }
    function updateOverviewCharts() { const isDark = root.getAttribute('data-theme') === 'dark'; const chartIdPrefix = 'overview-'; const incomeExpenseChart = getChartInstance(`${chartIdPrefix}income-expense-chart`); if (incomeExpenseChart) { const labels = []; const incomeData = []; const expenseData = []; for (let i = 11; i >= 0; i--) { const month = moment().subtract(i, 'months'); labels.push(month.format('MMM/YY')); const start = month.startOf('month'); const end = month.endOf('month'); const monthIncome = transactions.filter(t => t.type === 'income' && moment(t.date).isBetween(start, end, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); const monthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(start, end, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); incomeData.push(monthIncome); expenseData.push(monthExpenses); } incomeExpenseChart.data = { labels, datasets: [ { label: 'Receitas', data: incomeData, backgroundColor: isDark ? '#30D158' : '#34C759', borderRadius: 4 }, { label: 'Despesas', data: expenseData, backgroundColor: isDark ? '#FF453A' : '#FF3B30', borderRadius: 4 } ] }; incomeExpenseChart.update(); } const categoryChart = getChartInstance(`${chartIdPrefix}category-chart`); if (categoryChart) { const last30DaysStart = moment().subtract(30, 'days'); const expensesLast30Days = transactions.filter(t => t.type === 'expense' && moment(t.date).isAfter(last30DaysStart)); const expensesByCategory = expensesLast30Days.reduce((acc, t) => { const category = categories.find(c => c.id === t.category) || { id: 'unknown', name: 'Desconhecida', color: '#8E8E93' }; acc[category.id] = (acc[category.id] || { name: category.name, value: 0, color: category.color }); acc[category.id].value += t.amount; return acc; }, {}); const sortedCategories = Object.values(expensesByCategory).sort((a, b) => b.value - a.value); categoryChart.data = { labels: sortedCategories.map(c => c.name), datasets: [{ data: sortedCategories.map(c => c.value), backgroundColor: sortedCategories.map(c => c.color), borderColor: isDark ? '#1C1C1E' : '#FFFFFF', borderWidth: 2 }] }; categoryChart.update(); } const cashflowChart = getChartInstance(`${chartIdPrefix}cashflow-chart`); if (cashflowChart) { const currentYear = moment().year(); const labels = []; const balanceData = []; for (let i = 0; i < 12; i++) { const month = moment().year(currentYear).month(i); labels.push(month.format('MMM')); const start = month.startOf('month'); const end = month.endOf('month'); const monthIncome = transactions.filter(t => t.type === 'income' && moment(t.date).isBetween(start, end, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); const monthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(start, end, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); balanceData.push(monthIncome - monthExpenses); } cashflowChart.data = { labels, datasets: [{ label: 'Saldo Mensal', data: balanceData, backgroundColor: balanceData.map(b => b >= 0 ? (isDark ? '#30D158' : '#34C759') : (isDark ? '#FF453A' : '#FF3B30')), borderRadius: 4 }] }; cashflowChart.update(); } const fixedVariableChart = getChartInstance(`${chartIdPrefix}fixed-variable-chart`); if (fixedVariableChart) { const currentMonthStart = moment().startOf('month'); const currentMonthEnd = moment().endOf('month'); const monthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(currentMonthStart, currentMonthEnd, 'day', '[]')); const fixed = monthExpenses.filter(t => t.recurringInfo).reduce((sum, t) => sum + t.amount, 0); const variable = monthExpenses.filter(t => !t.recurringInfo).reduce((sum, t) => sum + t.amount, 0); fixedVariableChart.data = { labels: ['Fixas', 'Variáveis'], datasets: [{ data: [fixed, variable], backgroundColor: [isDark ? '#0A84FF' : '#007AFF', isDark ? '#BF5AF2' : '#AF52DE'], borderColor: isDark ? '#1C1C1E' : '#FFFFFF', borderWidth: 2 }] }; fixedVariableChart.update(); } const trendChart = getChartInstance(`${chartIdPrefix}trend-chart`); if (trendChart) { const labels = []; const data = []; for (let i = 5; i >= 0; i--) { const month = moment().subtract(i, 'months'); labels.push(month.format('MMM/YY')); const start = month.startOf('month'); const end = month.endOf('month'); const monthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(start, end, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0); data.push(monthExpenses); } trendChart.data = { labels, datasets: [{ label: 'Despesas Totais', data: data, borderColor: isDark ? '#FF9F0A' : '#FF9500', backgroundColor: isDark ? 'rgba(255, 159, 10, 0.15)' : 'rgba(255, 149, 0, 0.1)', fill: true, tension: 0.3 }] }; trendChart.update(); } }
    function updateAnalysisCharts(monthlyTransactions) { const isDark = root.getAttribute('data-theme') === 'dark'; const chartIdPrefix = 'analysis-'; const categoryPieChart = getChartInstance(`${chartIdPrefix}category-pie-chart`); if (categoryPieChart) { const expensesByCategory = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { const category = categories.find(c => c.id === t.category) || { id: 'unknown', name: 'Desconhecida', color: '#8E8E93' }; acc[category.id] = (acc[category.id] || { name: category.name, value: 0, color: category.color }); acc[category.id].value += t.amount; return acc; }, {}); const sortedCategories = Object.values(expensesByCategory).sort((a, b) => b.value - a.value); const maxCategories = 7; let labels = sortedCategories.slice(0, maxCategories).map(c => c.name); let data = sortedCategories.slice(0, maxCategories).map(c => c.value); let colors = sortedCategories.slice(0, maxCategories).map(c => c.color); if (sortedCategories.length > maxCategories) { const otherValue = sortedCategories.slice(maxCategories).reduce((sum, c) => sum + c.value, 0); if (otherValue > 0) { labels.push("Outros"); data.push(otherValue); colors.push(isDark ? '#48484A' : '#C7C7CC'); } } categoryPieChart.data = { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderColor: isDark ? '#1C1C1E' : '#FFFFFF', borderWidth: 2 }] }; categoryPieChart.update(); } const balanceLineChart = getChartInstance(`${chartIdPrefix}balance-line-chart`); if (balanceLineChart) { const daysInMonth = moment().year(currentAnalysisYear).month(currentAnalysisMonth).daysInMonth(); const labels = Array.from({ length: daysInMonth }, (_, i) => (i + 1).toString()); const dailyBalances = []; let cumulativeBalance = 0; const startOfMonth = moment().year(currentAnalysisYear).month(currentAnalysisMonth).startOf('month'); const initialBalance = transactions.filter(t => moment(t.date).isBefore(startOfMonth, 'day') && t.status === 'paid').reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0); cumulativeBalance = initialBalance; for (let day = 1; day <= daysInMonth; day++) { const currentDay = moment().year(currentAnalysisYear).month(currentAnalysisMonth).date(day); const incomeToday = monthlyTransactions.filter(t => t.type === 'income' && moment(t.date).isSame(currentDay, 'day')).reduce((sum, t) => sum + t.amount, 0); const expensesToday = monthlyTransactions.filter(t => t.type === 'expense' && moment(t.date).isSame(currentDay, 'day')).reduce((sum, t) => sum + t.amount, 0); cumulativeBalance += incomeToday - expensesToday; dailyBalances.push(cumulativeBalance); } balanceLineChart.data = { labels, datasets: [{ label: 'Saldo Acumulado', data: dailyBalances, borderColor: isDark ? '#0A84FF' : '#007AFF', backgroundColor: isDark ? 'rgba(10, 132, 255, 0.15)' : 'rgba(0, 122, 255, 0.1)', fill: true, tension: 0.1 }] }; balanceLineChart.update(); } }

    // ===== Inicialização da Aplicação =====
    async function init() {
        showLoading();
        console.log("Iniciando aplicação...");
        if (!db) { console.error("Falha crítica: Firestore não disponível."); return; }
        try {
            setupTheme();
            await loadCategories();
            initTabs();
            populateMonthYearFilter();
            initCharts();
            setupEventListeners();
            setupFirestoreListeners(); // Inicia carregamento de dados
            console.log("Configuração inicial da UI concluída.");
            // Esconder loading após delay, mesmo que dados não tenham chegado
            setTimeout(hideLoading, 1500);
        } catch (error) {
            console.error("Erro durante a inicialização:", error);
            showToast("Erro ao iniciar a aplicação.", "danger", 10000);
            hideLoading();
        }
    }
    document.addEventListener('DOMContentLoaded', init);
    window.addEventListener('beforeunload', stopFirestoreListeners);
    </script>

</body>
</html>
