<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Controle Financeiro Familiar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
  <!-- Firebase App -->
  <script type="module">
    // Importar módulos do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      query, 
      where, 
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configuração específica do seu projeto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY",
      authDomain: "calculadora-da-familia.firebaseapp.com",
      projectId: "calculadora-da-familia",
      storageBucket: "calculadora-da-familia.appspot.com",
      messagingSenderId: "69721783786",
      appId: "1:69721783786:web:c4703b5c182e3681e8c693",
      measurementId: "G-YM5TR661S6"
    };

    // Inicializar Firebase e acessar Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Tornar o db acessível globalmente
    window.db = db;
    window.firestore = {
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      query, 
      where, 
      orderBy
    };
  </script>
  <style>
    /* ===== Variáveis e Temas Apple ===== */
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem;
      --radius: 1.125rem;
      --radius-lg: 1.5rem;
      --shadow: 0 2px 14px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.04);
      --shadow-hover: 0 4px 18px rgba(0,0,0,0.08), 0 10px 28px rgba(0,0,0,0.06);
      --shadow-dropdown: 0 4px 20px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* Cores iOS/macOS Light */
      --bg: #F5F5F7;
      --card-bg: #FFFFFF;
      --input-bg: rgba(142, 142, 147, 0.12);
      --text: #1D1D1F;
      --text-secondary: #86868B;
      --primary: #0066CC;
      --primary-light: #147CE5;
      --success: #34C759;
      --warning: #FF9F0A;
      --danger: #FF3B30;
      --info: #5AC8FA;
      --purple: #AF52DE;
      --teal: #64D2FF;
      --border: rgba(0,0,0,0.08);
      --chart-grid: rgba(0,0,0,0.04);
      --menu-bg: rgba(255, 255, 255, 0.9);
      --receipt-bg: #FBFBFD;
    }
    
    [data-theme="dark"] {
      /* Cores iOS/macOS Dark */
      --bg: #1D1D1F;
      --card-bg: #2C2C2E;
      --input-bg: rgba(142, 142, 147, 0.18);
      --text: #F5F5F7;
      --text-secondary: #98989D;
      --primary: #0A84FF;
      --primary-light: #5AC8FA;
      --success: #30D158;
      --warning: #FF9F0A;
      --danger: #FF453A;
      --info: #64D2FF;
      --purple: #BF5AF2;
      --teal: #6AC4DC;
      --border: rgba(255,255,255,0.12);
      --chart-grid: rgba(255,255,255,0.06);
      --menu-bg: rgba(44, 44, 46, 0.9);
      --receipt-bg: #323234;
    }
    
    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    html, body { 
      font-family: var(--font-sans); 
      background: var(--bg); 
      color: var(--text); 
      transition: var(--transition);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 16px;
      line-height: 1.5;
      width: 100%;
      overflow-x: hidden;
    }
    
    /* ===== Layout e Componentes ===== */
    .container { 
      max-width: 1280px; 
      margin: 0 auto; 
      padding: 2rem; 
    }
    
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 2rem; 
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    h1 { 
      font-size: 1.75rem; 
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.025em;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .filters { 
      display: flex; 
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    /* Select estilo Apple */
    select { 
      appearance: none;
      -webkit-appearance: none;
      padding: 0.625rem 2rem 0.625rem 1rem;
      border-radius: var(--radius-sm); 
      border: none;
      background: var(--input-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='6' fill='none'%3E%3Cpath fill='%2386868b' d='M6 6 0 0h12L6 6Z'/%3E%3C/svg%3E") no-repeat;
      background-position: right 0.75rem center;
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    select:hover {
      background-color: rgba(142, 142, 147, 0.18);
    }
    
    select option {
      background-color: var(--card-bg);
      color: var(--text);
    }
    
    /* Botões */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      color: #fff;
      background-color: var(--primary);
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary {
      background-color: var(--primary);
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-danger {
      background-color: var(--danger);
    }
    
    .btn-icon {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      border-radius: 50%;
      background: var(--input-bg);
      color: var(--text);
    }
    
    .btn-icon:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .btn-icon svg {
      width: 1.25rem;
      height: 1.25rem;
    }
    
    /* Botão toggle theme */
    .theme-toggle {
      background: var(--input-bg);
      border: none;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .theme-toggle:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .theme-toggle svg {
      width: 1.25rem;
      height: 1.25rem;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Cards de KPIs */
    .kpis { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
      gap: 1rem; 
      margin-bottom: 2rem; 
    }
    
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
      overflow: hidden;
      position: relative;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .kpi-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kpi-title {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .kpi-value {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    
    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .kpi-trend.up {
      color: var(--success);
    }
    
    .kpi-trend.down {
      color: var(--danger);
    }
    
    .kpi-trend svg {
      width: 0.875rem;
      height: 0.875rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .kpi-meta {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .tabs::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      padding: 0.75rem 1.25rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }
    
    .tab:hover {
      color: var(--text);
    }
    
    .tab.active {
      color: var(--primary);
      border-color: var(--primary);
    }
    
    /* Gráficos */
    .charts-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
      gap: 1.5rem; 
      margin-bottom: 2rem;
    }
    
    .chart-container {
      position: relative;
      margin-top: 0.5rem;
      height: 260px;
    }
    
    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      letter-spacing: -0.01em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chart-title-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-legend-color {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
    }
    
    .full-width { 
      grid-column: 1 / -1; 
    }
    
    .full-width .chart-container {
      height: 300px;
    }
    
    /* Tabelas */
    .table-container {
      overflow-x: auto;
      margin-bottom: 2rem;
      border-radius: var(--radius);
      background: var(--card-bg);
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9375rem;
    }
    
    thead {
      background-color: var(--input-bg);
    }
    
    th {
      padding: 1rem;
      font-weight: 600;
      text-align: left;
      color: var(--text-secondary);
    }
    
    td {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }
    
    tr:hover td {
      background-color: var(--input-bg);
    }
    
    .table-actions {
      display: flex;
      gap: 0.5rem;
      opacity: 0.5;
      transition: var(--transition);
    }
    
    tr:hover .table-actions {
      opacity: 1;
    }
    
    .table-action-btn {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--input-bg);
      border: none;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .table-action-btn:hover {
      background-color: rgba(142, 142, 147, 0.3);
    }
    
    .table-action-btn svg {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Status e Tags */
    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status.status-paid {
      background-color: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }
    
    .status.status-pending {
      background-color: rgba(255, 159, 10, 0.1);
      color: var(--warning);
    }
    
    .status.status-overdue {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }
    
    .status.status-scheduled {
      background-color: rgba(90, 200, 250, 0.1);
      color: var(--info);
    }
    
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: var(--input-bg);
      color: var(--text-secondary);
    }
    
    /* Formulário Nova Transação */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.9375rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background-color: var(--input-bg);
      color: var(--text);
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.1);
    }
    
    /* Loading Estado */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .loading-indicator.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .spinner {
      width: 2.5rem;
      height: 2.5rem;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modais */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
      letter-spacing: -0.01em;
    }
    
    .modal-close {
      background: var(--input-bg);
      border: none;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .modal-close:hover {
      background-color: rgba(142, 142, 147, 0.3);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      border-top: 1px solid var(--border);
    }
    
    /* Alertas */
    .alert {
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    
    .alert-info {
      background-color: rgba(10, 132, 255, 0.1);
      color: var(--primary);
    }
    
    .alert-success {
      background-color: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }
    
    .alert-warning {
      background-color: rgba(255, 159, 10, 0.1);
      color: var(--warning);
    }
    
    .alert-danger {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }
    
    .alert-icon {
      flex-shrink: 0;
      width: 1.25rem;
      height: 1.25rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .alert-content {
      flex: 1;
    }
    
    .alert-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    /* Menu Contexto */
    .context-menu {
      position: absolute;
      min-width: 200px;
      background: var(--menu-bg);
      backdrop-filter: blur(8px);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-dropdown);
      z-index: 100;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: all 0.2s ease;
    }
    
    .context-menu.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    
    .context-menu-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .context-menu-item:hover {
      background-color: var(--input-bg);
    }
    
    .context-menu-item svg {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .context-menu-divider {
      height: 1px;
      background-color: var(--border);
      margin: 0.25rem 0;
    }
    
    /* Fluxo de Caixa */
    .cash-flow-card {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .cash-flow-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .cash-flow-title {
      font-size: 1.125rem;
      font-weight: 600;
    }
    
    .cash-flow-balance {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .cash-flow-items {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .flow-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background-color: var(--input-bg);
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    
    .flow-item:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .flow-item-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .flow-item-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    
    .flow-item-icon.income {
      background-color: var(--success);
    }
    
    .flow-item-icon.expense {
      background-color: var(--danger);
    }
    
    .flow-item-info {
      display: flex;
      flex-direction: column;
    }
    
    .flow-item-title {
      font-weight: 500;
    }
    
    .flow-item-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .flow-item-amount {
      font-weight: 600;
    }
    
    .flow-item-amount.income {
      color: var(--success);
    }
    
    .flow-item-amount.expense {
      color: var(--danger);
    }

/* Recibo / Modal de Detalhes */
.receipt {
  background-color: var(--receipt-bg);
  border-radius: var(--radius);
  padding: 2rem;
  max-width: 400px;
  margin: 0 auto;
}

.receipt-header {
  text-align: center;
  margin-bottom: 2rem;
}

.receipt-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.receipt-date {
  color: var(--text-secondary);
  font-size: 0.875rem;
}

.receipt-body {
  margin-bottom: 2rem;
}

.receipt-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}

.receipt-item-label {
  color: var(--text-secondary);
}

.receipt-item-value {
  font-weight: 500;
}

.receipt-divider {
  height: 1px;
  background: var(--border);
  margin: 1rem 0;
}

.receipt-total {
  display: flex;
  justify-content: space-between;
  font-weight: 700;
  font-size: 1.125rem;
  margin-top: 1rem;
}

.receipt-footer {
  text-align: center;
  color: var(--text-secondary);
  font-size: 0.875rem;
  margin-top: 2rem;
}

/* Menus e Navegação */
.nav {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}

.nav-item:hover, 
.nav-item.active {
  background-color: var(--input-bg);
}

.nav-item.active {
  color: var(--primary);
}

.nav-item svg {
  width: 1.25rem;
  height: 1.25rem;
  stroke: currentColor;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* Progress & Metas */
.progress-container {
  width: 100%;
  height: 0.5rem;
  background-color: var(--input-bg);
  border-radius: 1rem;
  overflow: hidden;
  margin-top: 0.5rem;
}

.progress-bar {
  height: 100%;
  border-radius: 1rem;
  transition: width 0.5s ease;
}

.progress-bar.success {
  background-color: var(--success);
}

.progress-bar.warning {
  background-color: var(--warning);
}
 
.progress-bar.danger {
  background-color: var(--danger);
}

/* Gerenciamento de categorias */
.category-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: var(--input-bg);
  border-radius: var(--radius-sm);
  margin-bottom: 0.75rem;
}

.category-item-color {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  color: white;
  flex-shrink: 0;
}

.category-item-info {
  flex: 1;
}

.category-item-actions {
  display: flex;
  gap: 0.5rem;
}

.color-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.color-item {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
}

.color-item:hover, 
.color-item.selected {
  transform: scale(1.1);
}

.color-item.selected {
  border-color: var(--text);
}

.icon-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.icon-item {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--input-bg);
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
}

.icon-item:hover, 
.icon-item.selected {
  background-color: rgba(142, 142, 147, 0.3);
}

.icon-item.selected {
  border-color: var(--primary);
}

/* Análise mensal */
.month-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.month-selector {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.month-nav-arrow {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--input-bg);
  border: none;
  cursor: pointer;
  color: var(--text);
  transition: var(--transition);
}

.month-nav-arrow:hover {
  background-color: rgba(142, 142, 147, 0.3);
}

.month-nav-arrow svg {
  width: 1.25rem;
  height: 1.25rem;
}

.month-title {
  font-size: 1.5rem;
  font-weight: 700;
}

.month-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.month-summary-item {
  padding: 1.5rem;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.month-summary-title {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.month-summary-value {
  font-size: 1.75rem;
  font-weight: 700;
}

.month-transactions {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.month-transaction {
  display: flex;
  justify-content: space-between;
  padding: 1rem;
  background-color: var(--input-bg);
  border-radius: var(--radius-sm);
  align-items: center;
}

.month-transaction-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.month-transaction-icon {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.month-transaction-info {
  display: flex;
  flex-direction: column;
}

.month-transaction-title {
  font-weight: 500;
}

.month-transaction-date {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.month-transaction-amount {
  font-weight: 600;
}

/* Responsividade */
@media (max-width: 1024px) {
  .container {
    padding: 1.5rem;
  }
  
  .header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-right {
    width: 100%;
    justify-content: space-between;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .kpis {
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .month-summary {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 576px) {
  .container {
    padding: 1rem;
  }
  
  .kpis {
    grid-template-columns: 1fr;
  }
  
  .flow-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .flow-item-left {
    width: 100%;
    justify-content: space-between;
  }
  
  .month-transaction {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .month-transaction-left {
    width: 100%;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header e Filtros -->
    <div class="header">
      <div class="header-title">
        <h1>Controle Financeiro Familiar</h1>
      </div>
      <div class="header-right">
        <div class="filters">
          <select id="filter-year">
            <!-- Anos serão inseridos via JavaScript -->
          </select>
          <select id="filter-month">
            <!-- Meses serão inseridos via JavaScript -->
          </select>
          <select id="filter-category">
            <option value="all">Todas Categorias</option>
          </select>
          <select id="filter-type">
            <option value="all">Todos Tipos</option>
            <option value="income">Receitas</option>
            <option value="expense">Despesas</option>
          </select>
        </div>
        <button class="btn btn-primary" id="btn-new-transaction">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nova Transação
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema">
          <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" />
          </svg>
        </button>
      </div>
    </div>
<!-- KPIs -->
<div class="kpis">
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Saldo Atual</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    </div>
    <div class="kpi-value" id="kpi-balance">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span id="balance-trend">0%</span>
      </div>
      <span>vs. mês anterior</span>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Receitas</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="5 12 12 5 19 12"></polyline>
      </svg>
    </div>
    <div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span id="income-trend">0%</span>
      </div>
      <span>vs. mês anterior</span>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Despesas</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <polyline points="19 12 12 19 5 12"></polyline>
      </svg>
    </div>
    <div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
          <polyline points="17 18 23 18 23 12"></polyline>
        </svg>
        <span id="expenses-trend">0%</span>
      </div>
      <span>vs. mês anterior</span>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Economia do Mês</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="8 12 12 16 16 12"></polyline>
        <line x1="12" y1="8" x2="12" y2="16"></line>
      </svg>
    </div>
    <div class="kpi-value" id="kpi-savings">R$ 0,00</div>
    <div class="kpi-meta">
      <div>Meta: R$ <span id="savings-goal">1.000,00</span></div>
      <div class="progress-container">
        <div class="progress-bar success" id="savings-progress" style="width: 0%"></div>
      </div>
    </div>
  </div>
  
  <div class="card kpi-card">
    <div class="kpi-header">
      <div class="kpi-title">Projeção de Gastos</div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    </div>
    <div class="kpi-value" id="kpi-projection">R$ 0,00</div>
    <div class="kpi-footer">
      <div class="kpi-trend" id="projection-status">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span>No orçamento</span>
      </div>
    </div>
  </div>
</div>

<!-- Tabs de Navegação -->
<div class="tabs">
  <div class="tab active" data-tab="overview">Visão Geral</div>
  <div class="tab" data-tab="transactions">Transações</div>
  <div class="tab" data-tab="budget">Orçamento</div>
  <div class="tab" data-tab="goals">Metas</div>
  <div class="tab" data-tab="monthly">Análise Mensal</div>
  <div class="tab" data-tab="categories">Categorias</div>
  <div class="tab" data-tab="reports">Relatórios</div>
</div>

<!-- Conteúdo das Tabs -->
<div class="tab-content" id="tab-overview">
  <!-- Gráficos de Visão Geral -->
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">
        <span>Receitas vs Despesas</span>
        <div class="chart-title-actions">
          <select id="income-expense-chart-period">
            <option value="6">Últimos 6 meses</option>
            <option value="12" selected>Últimos 12 meses</option>
            <option value="24">Últimos 24 meses</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="income-expense-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Despesas por Categoria</span>
        <div class="chart-title-actions">
          <select id="category-chart-period">
            <option value="current" selected>Mês Atual</option>
            <option value="last">Mês Anterior</option>
            <option value="average">Média Anual</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="category-chart"></canvas>
      </div>
    </div>
    
    <div class="card full-width">
      <div class="chart-title">
        <span>Fluxo de Caixa Mensal</span>
        <div class="chart-title-actions">
          <select id="cashflow-chart-year">
            <!-- Anos serão inseridos via JavaScript -->
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="cashflow-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Gastos Fixos vs Variáveis</span>
      </div>
      <div class="chart-container">
        <canvas id="fixed-variable-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Tendência de Gastos</span>
        <div class="chart-title-actions">
          <select id="trend-chart-category">
            <option value="all" selected>Todas Categorias</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="trend-chart"></canvas>
      </div>
    </div>
  </div>

<!-- Atividade Recente -->
  <div class="card">
    <div class="chart-title">Transações Recentes</div>
    <div class="cash-flow-items" id="recent-transactions">
      <!-- Transações recentes serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando transações recentes...
      </div>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-transactions" style="display: none;">
  <!-- Filtros e Pesquisa -->
  <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      <select id="transactions-filter-year">
        <!-- Anos serão inseridos via JavaScript -->
      </select>
      
      <select id="transactions-filter-month">
        <!-- Meses serão inseridos via JavaScript -->
      </select>
      
      <select id="transactions-filter-type">
        <option value="all" selected>Todos Tipos</option>
        <option value="income">Receitas</option>
        <option value="expense">Despesas</option>
      </select>
      
      <select id="transactions-filter-category">
        <option value="all" selected>Todas Categorias</option>
      </select>
      
      <select id="transactions-filter-status">
        <option value="all" selected>Todos Status</option>
        <option value="paid">Pago</option>
        <option value="pending">Pendente</option>
        <option value="scheduled">Agendado</option>
      </select>
    </div>
    
    <div style="position: relative; min-width: 250px;">
      <input type="text" class="form-control" id="transactions-search" placeholder="Pesquisar transações...">
    </div>
  </div>
  
  <!-- Tabela de Transações -->
  <div class="table-container">
    <table id="transactions-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Descrição</th>
          <th>Categoria</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="transactions-table-body">
        <!-- Transações serão inseridas via JavaScript -->
        <tr>
          <td colspan="6" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Carregando transações...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
<!-- Paginação -->  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
    <div>
      <span id="transactions-showing">Mostrando 0 de 0 transações</span>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button class="btn btn-icon" id="transactions-prev">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="btn btn-icon" id="transactions-next">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-budget" style="display: none;">
  <!-- Gráficos de Orçamento -->
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">Orçamento vs Real (Mês Atual)</div>
      <div class="chart-container">
        <canvas id="budget-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">Progresso do Orçamento</div>
      <div id="budget-progress-container">
        <!-- Progresso de orçamento será inserido via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Carregando dados de orçamento...
        </div>
      </div>
    </div>
  </div>
  
<!-- Tabela de Orçamento -->  
  <div class="card">
    <div class="chart-title">
      <span>Planejamento de Orçamento</span>
      <button class="btn btn-primary" id="btn-edit-budget">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        Editar Orçamento
      </button>
    </div>
    <div class="table-container">
      <table id="budget-table">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Orçamento</th>
            <th>Gasto Atual</th>
            <th>Restante</th>
            <th>Progresso</th>
          </tr>
        </thead>
        <tbody id="budget-table-body">
          <!-- Orçamento será inserido via JavaScript -->
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
              Carregando dados de orçamento...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-goals" style="display: none;">
  <!-- Metas Financeiras -->
  <div class="charts-grid">
    <div class="card" style="grid-column: span 2;">
      <div class="chart-title">
        <span>Progresso das Metas</span>
        <button class="btn btn-primary" id="btn-add-goal">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nova Meta
        </button>
      </div>
      <div id="goals-container">
        <!-- Metas serão inseridas via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Carregando metas...
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">Projeção de Economia</div>
      <div class="chart-container">
        <canvas id="savings-projection-chart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Nova Tab: Análise Mensal -->
<div class="tab-content" id="tab-monthly" style="display: none;">
  <div class="month-nav">
    <button class="month-nav-arrow" id="prev-month">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    
    <div class="month-selector">
      <select id="monthly-analysis-year">
        <!-- Anos serão inseridos via JavaScript -->
      </select>
      <select id="monthly-analysis-month">
        <!-- Meses serão inseridos via JavaScript -->
      </select>
    </div>
    
    <button class="month-nav-arrow" id="next-month">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>
  
  <div class="month-summary">
    <div class="card">
      <div class="month-summary-title">Receitas Totais</div>
      <div class="month-summary-value" id="monthly-income" style="color: var(--success);">R$ 0,00</div>
      <div class="kpi-footer">
        <span id="monthly-income-count">0 transações</span>
      </div>
    </div>
    
    <div class="card">
      <div class="month-summary-title">Despesas Totais</div>
      <div class="month-summary-value" id="monthly-expense" style="color: var(--danger);">R$ 0,00</div>
      <div class="kpi-footer">
        <span id="monthly-expense-count">0 transações</span>
      </div>
    </div>
    
    <div class="card">
      <div class="month-summary-title">Saldo do Mês</div>
      <div class="month-summary-value" id="monthly-balance">R$ 0,00</div>
      <div class="kpi-footer">
        <span id="monthly-balance-status">Equilibrado</span>
      </div>
    </div>
  </div>
  
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">Principais Despesas por Categoria</div>
      <div class="chart-container">
        <canvas id="monthly-category-chart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">Distribuição Diária</div>
      <div class="chart-container">
        <canvas id="monthly-daily-chart"></canvas>
      </div>
    </div>
  </div>
  
  <div class="card" style="margin-bottom: 2rem;">
    <div class="chart-title">
      <span>Lista de Receitas</span>
      <button class="btn btn-success" id="btn-add-income">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nova Receita
      </button>
    </div>
    <div id="monthly-income-list" class="month-transactions">
      <!-- Receitas serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando receitas...
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="chart-title">
      <span>Lista de Despesas</span>
      <button class="btn btn-danger" id="btn-add-expense">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nova Despesa
      </button>
    </div>
    <div id="monthly-expense-list" class="month-transactions">
      <!-- Despesas serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando despesas...
      </div>
    </div>
  </div>
</div>

<!-- Nova Tab: Categorias -->
<div class="tab-content" id="tab-categories" style="display: none;">
  <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
    <h2 style="font-size: 1.5rem; margin: 0;">Gerenciamento de Categorias</h2>
    <div>
      <button class="btn btn-primary" id="btn-add-category">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nova Categoria
      </button>
    </div>
  </div>
  
  <div class="card" style="margin-bottom: 2rem;">
    <div class="chart-title">Categorias de Receita</div>
    <div id="income-categories-list">
      <!-- Categorias de receita serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando categorias de receita...
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="chart-title">Categorias de Despesa</div>
    <div id="expense-categories-list">
      <!-- Categorias de despesa serão inseridas via JavaScript -->
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Carregando categorias de despesa...
      </div>
    </div>
  </div>
</div>

<div class="tab-content" id="tab-reports" style="display: none;">
  <!-- Relatórios -->
  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">
        <span>Relatório Mensal</span>
        <div class="chart-title-actions">
          <select id="report-year">
            <!-- Anos serão inseridos via JavaScript -->
          </select>
          <select id="report-month">
            <!-- Meses serão inseridos via JavaScript -->
          </select>
          <button class="btn btn-primary" id="btn-export-report">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Exportar
          </button>
        </div>
      </div>
      <div id="monthly-report-container">
        <!-- Relatório mensal será inserido via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Selecione um mês para gerar o relatório.
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">
        <span>Análise de Gastos</span>
        <div class="chart-title-actions">
          <select id="analysis-type">
            <option value="category">Por Categoria</option>
            <option value="monthly">Mensal</option>
            <option value="yearly">Anual</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="analysis-chart"></canvas>
      </div>
    </div>
  </div>
</div>
  </div>

<!-- Modal de Nova Transação -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3>
        <button class="modal-close" id="transaction-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="transaction-form">
          <input type="hidden" id="transaction-id">
      <div class="form-grid">
        <div class="form-group">
          <label for="transaction-type">Tipo</label>
          <select class="form-control" id="transaction-type" required>
            <option value="income">Receita</option>
            <option value="expense">Despesa</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="transaction-date">Data</label>
          <input type="date" class="form-control" id="transaction-date" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="transaction-description">Descrição</label>
        <input type="text" class="form-control" id="transaction-description" placeholder="Ex: Salário, Mercado, Conta de Luz..." required>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="transaction-amount">Valor (R$)</label>
          <input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required>
        </div>
        
        <div class="form-group">
          <label for="transaction-category">Categoria</label>
          <select class="form-control" id="transaction-category" required>
            <!-- Categorias serão inseridas via JavaScript -->
          </select>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="transaction-status">Status</label>
          <select class="form-control" id="transaction-status" required>
            <option value="paid">Pago</option>
            <option value="pending">Pendente</option>
            <option value="scheduled">Agendado</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="transaction-payment-method">Forma de Pagamento</label>
          <select class="form-control" id="transaction-payment-method">
            <option value="">Selecione...</option>
            <option value="cash">Dinheiro</option>
            <option value="credit_card">Cartão de Crédito</option>
            <option value="debit_card">Cartão de Débito</option>
            <option value="bank_transfer">Transferência Bancária</option>
            <option value="pix">PIX</option>
            <option value="other">Outro</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="transaction-notes">Observações</label>
        <textarea class="form-control" id="transaction-notes" rows="3" placeholder="Detalhes adicionais..."></textarea>
      </div>
      
      <div id="recurring-transaction-container">
        <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
          <input type="checkbox" id="transaction-recurring" style="width: auto;">
          <label for="transaction-recurring" style="margin-bottom: 0;">Transação Recorrente</label>
        </div>
        
        <div id="recurring-options" style="margin-top: 1rem; display: none;">
          <div class="form-grid">
            <div class="form-group">
              <label for="transaction-frequency">Frequência</label>
              <select class="form-control" id="transaction-frequency">
                <option value="weekly">Semanal</option>
                <option value="biweekly">Quinzenal</option>
                <option value="monthly" selected>Mensal</option>
                <option value="quarterly">Trimestral</option>
                <option value="semiannual">Semestral</option>
                <option value="annual">Anual</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="transaction-end-date">Data de Término (opcional)</label>
              <input type="date" class="form-control" id="transaction-end-date">
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="transaction-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="transaction-modal-save">Salvar</button>
  </div>
</div>
  </div>

<!-- Modal de Edição de Orçamento -->
  <div class="modal" id="budget-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Orçamento</h3>
        <button class="modal-close" id="budget-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="budget-form">
          <div class="form-group">
            <label for="budget-year">Ano</label>
            <select class="form-control" id="budget-year" required>
              <!-- Anos serão inseridos via JavaScript -->
            </select>
          </div>
      <div class="form-group">
        <label for="budget-month">Mês</label>
        <select class="form-control" id="budget-month" required>
          <!-- Meses serão inseridos via JavaScript -->
        </select>
      </div>
      
      <div id="budget-categories-container">
        <!-- Categorias de orçamento serão inseridas via JavaScript -->
        <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
          Carregando categorias...
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="budget-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="budget-modal-save">Salvar</button>
  </div>
</div>
  </div>
  <!-- Modal de Nova Meta -->
  <div class="modal" id="goal-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="goal-modal-title">Nova Meta</h3>
        <button class="modal-close" id="goal-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="goal-form">
          <input type="hidden" id="goal-id">
      <div class="form-group">
        <label for="goal-name">Nome da Meta</label>
        <input type="text" class="form-control" id="goal-name" placeholder="Ex: Férias, Novo Carro, Reforma..." required>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="goal-target">Valor Alvo (R$)</label>
          <input type="number" step="0.01" min="0.01" class="form-control" id="goal-target" placeholder="0,00" required>
        </div>
        
        <div class="form-group">
          <label for="goal-current">Valor Atual (R$)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="goal-current" placeholder="0,00" required>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="goal-date">Data Alvo</label>
          <input type="date" class="form-control" id="goal-date" required>
        </div>
        
        <div class="form-group">
          <label for="goal-category">Categoria</label>
          <select class="form-control" id="goal-category" required>
            <option value="savings">Economia</option>
            <option value="investment">Investimento</option>
            <option value="debt">Pagamento de Dívida</option>
            <option value="purchase">Compra</option>
            <option value="travel">Viagem</option>
            <option value="education">Educação</option>
            <option value="other">Outro</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="goal-notes">Observações</label>
        <textarea class="form-control" id="goal-notes" rows="3" placeholder="Detalhes adicionais..."></textarea>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="goal-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="goal-modal-save">Salvar</button>
  </div>
</div>
  </div>
  <!-- Modal de Nova Categoria -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="category-modal-title">Nova Categoria</h3>
        <button class="modal-close" id="category-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <input type="hidden" id="category-id">
      <div class="form-group">
        <label for="category-name">Nome da Categoria</label>
        <input type="text" class="form-control" id="category-name" placeholder="Ex: Alimentação, Transporte, Investimentos..." required>
      </div>
      
      <div class="form-group">
        <label for="category-type">Tipo</label>
        <select class="form-control" id="category-type" required>
          <option value="expense">Despesa</option>
          <option value="income">Receita</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Cor</label>
        <div class="color-grid" id="color-grid">
          <!-- Cores serão inseridas via JavaScript -->
        </div>
      </div>
      
      <div class="form-group">
        <label>Ícone</label>
        <div class="icon-grid" id="icon-grid">
          <!-- Ícones serão inseridos via JavaScript -->
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn" id="category-modal-cancel">Cancelar</button>
    <button class="btn btn-primary" id="category-modal-save">Salvar</button>
  </div>
</div>
  </div>
  <!-- Modal de Detalhes da Transação -->
  <div class="modal" id="transaction-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Detalhes da Transação</h3>
        <button class="modal-close" id="transaction-details-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="receipt" id="transaction-receipt">
          <!-- Detalhes da transação serão inseridos via JavaScript -->
          <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Carregando detalhes da transação...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="transaction-details-delete">Excluir</button>
        <button class="btn btn-primary" id="transaction-details-edit">Editar</button>
      </div>
    </div>
  </div>
  <!-- Modal de Confirmação -->
  <div class="modal" id="confirm-modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title" id="confirm-modal-title">Confirmação</h3>
        <button class="modal-close" id="confirm-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message">Tem certeza que deseja realizar esta ação?</p>
      </div>
      <div class="modal-footer">
        <button class="btn" id="confirm-modal-cancel">Cancelar</button>
        <button class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button>
      </div>
    </div>
  </div>

<!-- Loading Indicator -->
  <div class="loading-indicator" id="loading">
    <div class="spinner"></div>
  </div>
  <script>
    // ===== Configurações e Variáveis Globais =====
    const root = document.documentElement;
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const loading = document.getElementById('loading');
    
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // Modais
    const transactionModal = document.getElementById('transaction-modal');
    const transactionForm = document.getElementById('transaction-form');
    const budgetModal = document.getElementById('budget-modal');
    const goalModal = document.getElementById('goal-modal');
    const categoryModal = document.getElementById('category-modal');
    const transactionDetailsModal = document.getElementById('transaction-details-modal');
    const confirmModal = document.getElementById('confirm-modal');
    
    // Botões
    const btnNewTransaction = document.getElementById('btn-new-transaction');
    const btnEditBudget = document.getElementById('btn-edit-budget');
    const btnAddGoal = document.getElementById('btn-add-goal');
    const btnAddCategory = document.getElementById('btn-add-category');
    const btnAddIncome = document.getElementById('btn-add-income');
    const btnAddExpense = document.getElementById('btn-add-expense');
    
    // Estados da Aplicação
    let transactions = [];
    let categories = [];
    let budgets = [];
    let goals = [];
    let currentTab = 'overview';
    
    // Configurações
    const TRANSACTION_TYPES = {
      income: {
        name: 'Receita',
        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>',
        color: 'var(--success)'
      },
      expense: {
        name: 'Despesa',
        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>',
        color: 'var(--danger)'
      }
    };
    
    // Categorias padrão (caso não haja nenhuma no banco de dados)
    const DEFAULT_EXPENSE_CATEGORIES = [
      { id: 'housing', name: 'Moradia', color: '#FF9F0A', icon: '🏠', type: 'expense' },
      { id: 'food', name: 'Alimentação', color: '#30D158', icon: '🍔', type: 'expense' },
      { id: 'transportation', name: 'Transporte', color: '#0A84FF', icon: '🚗', type: 'expense' },
      { id: 'health', name: 'Saúde', color: '#FF453A', icon: '🏥', type: 'expense' },
      { id: 'leisure', name: 'Lazer', color: '#BF5AF2', icon: '🎮', type: 'expense' },
      { id: 'education', name: 'Educação', color: '#5E5CE6', icon: '📚', type: 'expense' },
      { id: 'shopping', name: 'Compras', color: '#FF375F', icon: '🛍️', type: 'expense' },
      { id: 'bills', name: 'Contas', color: '#64D2FF', icon: '📝', type: 'expense' },
      { id: 'unexpected', name: 'Inesperadas', color: '#FF2D55', icon: '⚠️', type: 'expense' },
      { id: 'other_expenses', name: 'Outras Despesas', color: '#A0A0A0', icon: '💼', type: 'expense' }
    ];
      
    // Array de cores disponíveis para categorias
    const AVAILABLE_COLORS = [
      '#FF453A', // Vermelho
      '#FF9F0A', // Laranja
      '#FFD60A', // Amarelo
      '#30D158', // Verde
      '#64D2FF', // Azul claro
      '#0A84FF', // Azul
      '#5E5CE6', // Lilás
      '#BF5AF2', // Roxo
      '#FF375F', // Rosa
      '#AC8E68', // Marrom
      '#A0A0A0', // Cinza
      '#2C2C2E'  // Preto
    ];
    
    // Ícones disponíveis para categorias
    const AVAILABLE_ICONS = [
      '💰', '💳', '🏠', '🍔', '🚗', '🏥', '🎮', '📚', '🛍️', '📝',
      '⚠️', '✈️', '👪', '🎵', '💻', '📱', '🧾', '🎁', '💡', '🎓',
      '⛽', '🏦', '👕', '🍎', '🏋️', '🔧', '📊', '💼', '💲', '🎭',
      '🏢', '🚿', '📺', '☕', '🧹', '💊', '👶', '🐶', '💧', '🛒'
    ];
    
    // Status de pagamento
    const PAYMENT_METHODS = {
      'cash': 'Dinheiro',
      'credit_card': 'Cartão de Crédito',
      'debit_card': 'Cartão de Débito',
      'bank_transfer': 'Transferência Bancária',
      'pix': 'PIX',
      'other': 'Outro'
    };
    
    // Status de transação
    const TRANSACTION_STATUS = {
      'paid': { name: 'Pago', class: 'status-paid' },
      'pending': { name: 'Pendente', class: 'status-pending' },
      'scheduled': { name: 'Agendado', class: 'status-scheduled' },
      'overdue': { name: 'Atrasado', class: 'status-overdue' }
    };

    // ===== Firebase Integration =====

    // Referência para as coleções do Firestore
    let db; 
    let firestore;

    // Aguardar a inicialização do Firebase
    function waitForFirebase() {
      return new Promise((resolve) => {
        const checkFirebase = () => {
          if (window.db && window.firestore) {
            db = window.db;
            firestore = window.firestore;
            resolve();
          } else {
            setTimeout(checkFirebase, 100);
          }
        };
        checkFirebase();
      });
    }

    // Salvar transação no Firestore
    async function saveTransactionToFirestore(transaction) {
      try {
        showLoading();
        const transactionsRef = firestore.collection(db, 'transactions');
        
        // Se for uma atualização de transação existente
        if (transaction.id && transaction.firestoreId) {
          await firestore.updateDoc(firestore.doc(db, 'transactions', transaction.firestoreId), transaction);
          hideLoading();
          return transaction.firestoreId;
        } 
        // Se for uma nova transação
        else {
          const docRef = await firestore.addDoc(transactionsRef, transaction);
          hideLoading();
          return docRef.id;
        }
      } catch (error) {
        console.error('Erro ao salvar transação:', error);
        hideLoading();
        showAlert('Erro ao salvar transação. Tente novamente.', 'danger');
        throw error;
      }
    }

    // Carregar transações do Firestore
    async function loadTransactionsFromFirestore() {
      try {
        showLoading();
        const transactionsRef = firestore.collection(db, 'transactions');
        const snapshot = await firestore.getDocs(transactionsRef);
        
        let loadedTransactions = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          loadedTransactions.push({
            ...data,
            firestoreId: doc.id
          });
        });
        
        hideLoading();
        return loadedTransactions;
      } catch (error) {
        console.error('Erro ao carregar transações:', error);
        hideLoading();
        showAlert('Erro ao carregar transações. Tente novamente.', 'danger');
        return [];
      }
    }

    // Excluir transação do Firestore
    async function deleteTransactionFromFirestore(firestoreId) {
      try {
        showLoading();
        await firestore.deleteDoc(firestore.doc(db, 'transactions', firestoreId));
        hideLoading();
        return true;
      } catch (error) {
        console.error('Erro ao excluir transação:', error);
        hideLoading();
        showAlert('Erro ao excluir transação. Tente novamente.', 'danger');
        return false;
      }
    }

    // Salvar categoria no Firestore
    async function saveCategoryToFirestore(category) {
      try {
        showLoading();
        const categoriesRef = firestore.collection(db, 'categories');
        
        // Se for uma atualização de categoria existente
        if (category.id && category.firestoreId) {
          await firestore.updateDoc(firestore.doc(db, 'categories', category.firestoreId), category);
          hideLoading();
          return category.firestoreId;
        } 
        // Se for uma nova categoria
        else {
          const docRef = await firestore.addDoc(categoriesRef, category);
          hideLoading();
          return docRef.id;
        }
      } catch (error) {
        console.error('Erro ao salvar categoria:', error);
        hideLoading();
        showAlert('Erro ao salvar categoria. Tente novamente.', 'danger');
        throw error;
      }
    }

    // Carregar categorias do Firestore
    async function loadCategoriesFromFirestore() {
      try {
        showLoading();
        const categoriesRef = firestore.collection(db, 'categories');
        const snapshot = await firestore.getDocs(categoriesRef);
        
        let loadedCategories = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          loadedCategories.push({
            ...data,
            firestoreId: doc.id
          });
        });
        
        hideLoading();
        
        // Se não houver categorias, criar as padrões
        if (loadedCategories.length === 0) {
          loadedCategories = await createDefaultCategories();
        }
        
        return loadedCategories;
      } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        hideLoading();
        showAlert('Erro ao carregar categorias. Tente novamente.', 'danger');
        return [];
      }
    }




// Excluir categoria do Firestore
async function deleteCategoryFromFirestore(firestoreId) {
  try {
    showLoading();
    await firestore.deleteDoc(firestore.doc(db, 'categories', firestoreId));
    hideLoading();
    return true;
  } catch (error) {
    console.error('Erro ao excluir categoria:', error);
    hideLoading();
    showAlert('Erro ao excluir categoria. Tente novamente.', 'danger');
    return false;
  }
}

// Salvar orçamento no Firestore
async function saveBudgetToFirestore(budget) {
  try {
    showLoading();
    const budgetsRef = firestore.collection(db, 'budgets');
    
    // Verificar se já existe um orçamento para o mês/ano especificado
    const q = firestore.query(
      budgetsRef,
      firestore.where('year', '==', budget.year),
      firestore.where('month', '==', budget.month)
    );
    
    const querySnapshot = await firestore.getDocs(q);
    
    if (!querySnapshot.empty) {
      // Atualizar orçamento existente
      const existingBudget = querySnapshot.docs[0];
      await firestore.updateDoc(existingBudget.ref, budget);
      hideLoading();
      return existingBudget.id;
    } else {
      // Criar novo orçamento
      const docRef = await firestore.addDoc(budgetsRef, budget);
      hideLoading();
      return docRef.id;
    }
  } catch (error) {
    console.error('Erro ao salvar orçamento:', error);
    hideLoading();
    showAlert('Erro ao salvar orçamento. Tente novamente.', 'danger');
    throw error;
  }
}

// Carregar orçamentos do Firestore
async function loadBudgetsFromFirestore() {
  try {
    showLoading();
    const budgetsRef = firestore.collection(db, 'budgets');
    const snapshot = await firestore.getDocs(budgetsRef);
    
    let loadedBudgets = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      loadedBudgets.push({
        ...data,
        firestoreId: doc.id
      });
    });
    
    hideLoading();
    return loadedBudgets;
  } catch (error) {
    console.error('Erro ao carregar orçamentos:', error);
    hideLoading();
    showAlert('Erro ao carregar orçamentos. Tente novamente.', 'danger');
    return [];
  }
}

// Obter orçamento para um mês/ano específico
async function getBudgetForMonthAndYear(month, year) {
  try {
    const budgetsRef = firestore.collection(db, 'budgets');
    const q = firestore.query(
      budgetsRef,
      firestore.where('year', '==', year),
      firestore.where('month', '==', month)
    );
    
    const querySnapshot = await firestore.getDocs(q);
    
    if (!querySnapshot.empty) {
      const budgetDoc = querySnapshot.docs[0];
      return {
        ...budgetDoc.data(),
        firestoreId: budgetDoc.id
      };
    }
    
    return null;
  } catch (error) {
    console.error('Erro ao obter orçamento:', error);
    return null;
  }
}

// Salvar meta no Firestore
async function saveGoalToFirestore(goal) {
  try {
    showLoading();
    const goalsRef = firestore.collection(db, 'goals');
    
    // Se for uma atualização de meta existente
    if (goal.id && goal.firestoreId) {
      await firestore.updateDoc(firestore.doc(db, 'goals', goal.firestoreId), goal);
      hideLoading();
      return goal.firestoreId;
    } 
    // Se for uma nova meta
    else {
      const docRef = await firestore.addDoc(goalsRef, goal);
      hideLoading();
      return docRef.id;
    }
  } catch (error) {
    console.error('Erro ao salvar meta:', error);
    hideLoading();
    showAlert('Erro ao salvar meta. Tente novamente.', 'danger');
    throw error;
  }
}

// Carregar metas do Firestore
async function loadGoalsFromFirestore() {
  try {
    showLoading();
    const goalsRef = firestore.collection(db, 'goals');
    const snapshot = await firestore.getDocs(goalsRef);
    
    let loadedGoals = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      loadedGoals.push({
        ...data,
        firestoreId: doc.id
      });
    });
    
    hideLoading();
    return loadedGoals;
  } catch (error) {
    console.error('Erro ao carregar metas:', error);
    hideLoading();
    showAlert('Erro ao carregar metas. Tente novamente.', 'danger');
    return [];
  }
}

// Excluir meta do Firestore
async function deleteGoalFromFirestore(firestoreId) {
  try {
    showLoading();
    await firestore.deleteDoc(firestore.doc(db, 'goals', firestoreId));
    hideLoading();
    return true;
  } catch (error) {
    console.error('Erro ao excluir meta:', error);
    hideLoading();
    showAlert('Erro ao excluir meta. Tente novamente.', 'danger');
    return false;
  }
}

// Criar categorias padrão
async function createDefaultCategories() {
  const defaultCategories = [
    { id: 'housing', name: 'Moradia', color: '#FF9F0A', icon: '🏠', type: 'expense' },
    { id: 'food', name: 'Alimentação', color: '#30D158', icon: '🍔', type: 'expense' },
    { id: 'transportation', name: 'Transporte', color: '#0A84FF', icon: '🚗', type: 'expense' },
    { id: 'health', name: 'Saúde', color: '#FF453A', icon: '🏥', type: 'expense' },
    { id: 'leisure', name: 'Lazer', color: '#BF5AF2', icon: '🎮', type: 'expense' },
    { id: 'education', name: 'Educação', color: '#5E5CE6', icon: '📚', type: 'expense' },
    { id: 'shopping', name: 'Compras', color: '#FF375F', icon: '🛍️', type: 'expense' },
    { id: 'bills', name: 'Contas', color: '#64D2FF', icon: '📝', type: 'expense' },
    { id: 'unexpected', name: 'Inesperadas', color: '#FF2D55', icon: '⚠️', type: 'expense' },
    { id: 'other_expenses', name: 'Outras Despesas', color: '#A0A0A0', icon: '💼', type: 'expense' },
    { id: 'salary', name: 'Salário', color: '#30D158', icon: '💰', type: 'income' },
    { id: 'bonus', name: 'Bônus', color: '#5E5CE6', icon: '🎁', type: 'income' },
    { id: 'investments', name: 'Investimentos', color: '#0A84FF', icon: '📊', type: 'income' },
    { id: 'other_income', name: 'Outras Receitas', color: '#FF9F0A', icon: '💸', type: 'income' }
  ];
  
  const savedCategories = [];
  
  for (const category of defaultCategories) {
    try {
      const firestoreId = await saveCategoryToFirestore(category);
      savedCategories.push({
        ...category,
        firestoreId
      });
    } catch (error) {
      console.error('Erro ao criar categoria padrão:', error);
    }
  }
  
  return savedCategories;
}

// ===== Utilitários e Helpers =====

// Formatar moeda
function formatCurrency(value) {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value);
}

// Formatar data
function formatDate(date) {
  if (!date) return '';
  return new Intl.DateTimeFormat('pt-BR').format(new Date(date));
}

// Formatar Datas para o atributo value do input
function formatDateForInput(date) {
  if (!date) return '';
  const d = new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

// Mostrar indicador de carregamento
function showLoading() {
  loading.classList.add('active');
}

// Esconder indicador de carregamento
function hideLoading() {
  loading.classList.remove('active');
}

// Mostrar alerta
function showAlert(message, type = 'info', duration = 3000) {
  // Criar elemento de alerta
  const alertElement = document.createElement('div');
  alertElement.className = `alert alert-${type}`;
  alertElement.innerHTML = `
    <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      ${type === 'info' ? '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>' : ''}
      ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>' : ''}
      ${type === 'warning' ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' : ''}
      ${type === 'danger' ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' : ''}
    </svg>
    <div class="alert-content">${message}</div>
  `;
  
  // Adicionar ao DOM
  document.body.appendChild(alertElement);
  
  // Posicionar
  alertElement.style.position = 'fixed';
  alertElement.style.bottom = '20px';
  alertElement.style.right = '20px';
  alertElement.style.zIndex = '9999';
  alertElement.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
  alertElement.style.transform = 'translateY(100px)';
  alertElement.style.opacity = '0';
  alertElement.style.maxWidth = '400px';
  
  // Mostrar com efeito
  setTimeout(() => {
    alertElement.style.transform = 'translateY(0)';
    alertElement.style.opacity = '1';
  }, 10);
  
  // Remover após a duração
  setTimeout(() => {
    alertElement.style.transform = 'translateY(100px)';
    alertElement.style.opacity = '0';
    
    setTimeout(() => {
      document.body.removeChild(alertElement);
    }, 300);
  }, duration);
}

// Atualizar ícone do toggle de tema
function updateThemeIcon(theme) {
  if (theme === 'dark') {
    themeIcon.innerHTML = '<path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M16.95 7.05a6 6 0 1 1-8.49 8.49 6 6 0 0 1 8.49-8.49z" />';
  } else {
    themeIcon.innerHTML = '<path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" />';
  }
}

// Setup do tema baseado em preferências do sistema
function setupTheme() {
  const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
  const currentTheme = localStorage.getItem('theme');
  
  if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
    root.setAttribute('data-theme', 'dark');
    updateThemeIcon('dark');
  } else {
    root.setAttribute('data-theme', 'light');
    updateThemeIcon('light');
  }
}

// Toggle de tema claro/escuro
themeToggle.addEventListener('click', () => {
  const currentTheme = root.getAttribute('data-theme') || 'light';
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  
  root.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateThemeIcon(newTheme);
  
  // Atualizar gráficos para o novo tema
  updateCharts();
});

// ===== Gerenciamento de Dados =====

// Inicializar valores de anos para selects
function populateYearSelects() {
  const currentYear = new Date().getFullYear();
  const yearSelects = [
    document.getElementById('filter-year'),
    document.getElementById('transactions-filter-year'),
    document.getElementById('cashflow-chart-year'),
    document.getElementById('budget-year'),
    document.getElementById('report-year'),
    document.getElementById('monthly-analysis-year')
  ];
  
  // Adicionar anos (atual, 2 anos anteriores, 2 anos futuros)
  for (let i = -2; i <= 5; i++) {
    const year = currentYear + i;
    
    yearSelects.forEach(select => {
      if (select) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
      }
    });
  }
  
  // Selecionar ano atual como padrão
  yearSelects.forEach(select => {
    if (select) {
      select.value = currentYear;
    }
  });
}

// Inicializar valores de meses para selects
function populateMonthSelects() {
  const months = [
    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
  ];
  
  const currentMonth = new Date().getMonth();  // 0-11
  
  const monthSelects = [
    document.getElementById('filter-month'),
    document.getElementById('transactions-filter-month'),
    document.getElementById('budget-month'),
    document.getElementById('report-month'),
    document.getElementById('monthly-analysis-month')
  ];
  
  monthSelects.forEach(select => {
    if (select) {
      // Limpar opções existentes
      select.innerHTML = '';
      
      // Adicionar cada mês
      months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;  // 0-11
        option.textContent = month;
        select.appendChild(option);
      });
      
      // Adicionar opção para "Todos os meses" apenas em selects de filtro
      if (select.id.includes('filter')) {
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'Todos os Meses';
        select.insertBefore(allOption, select.firstChild);
      }
      
      // Selecionar mês atual como padrão
      select.value = select.id.includes('filter') ? 'all' : currentMonth;
    }
  });
}

// Filtrar transações
function filterTransactions(filters = {}) {
  let filtered = [...transactions];
  
  // Filtrar por tipo
  if (filters.type && filters.type !== 'all') {
    filtered = filtered.filter(t => t.type === filters.type);
  }
  
  // Filtrar por categoria
  if (filters.category && filters.category !== 'all') {
    filtered = filtered.filter(t => t.category === filters.category);
  }
  
  // Filtrar por status
  if (filters.status && filters.status !== 'all') {
    filtered = filtered.filter(t => t.status === filters.status);
  }
  
  // Filtrar por ano
  if (filters.year && filters.year !== 'all') {
    const year = parseInt(filters.year);
    filtered = filtered.filter(t => {
      const date = new Date(t.date);
      return date.getFullYear() === year;
    });
  }
  
  // Filtrar por mês
  if (filters.month !== undefined && filters.month !== 'all') {
    const month = parseInt(filters.month);
    filtered = filtered.filter(t => {
      const date = new Date(t.date);
      return date.getMonth() === month;
    });
  }
  
  // Pesquisar por texto
  if (filters.search) {
    const search = filters.search.toLowerCase();
    filtered = filtered.filter(t => {
      return t.description.toLowerCase().includes(search) || 
             (t.notes && t.notes.toLowerCase().includes(search));
    });
  }
  
  // Ordenar por data (mais recente primeiro)
  filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  return filtered;
}

// Obter o total de receitas, despesas e saldo para um período
function getFinanceSummary(filteredTransactions) {
  // Calcular totais
  const income = filteredTransactions
    .filter(t => t.type === 'income' && t.status !== 'scheduled')
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  const expenses = filteredTransactions
    .filter(t => t.type === 'expense' && t.status !== 'scheduled')
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  const balance = income - expenses;
  
  // Calcular valores pendentes
  const pendingIncome = filteredTransactions
    .filter(t => t.type === 'income' && t.status === 'scheduled')
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  const pendingExpenses = filteredTransactions
    .filter(t => t.type === 'expense' && t.status === 'scheduled')
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  // Retornar sumário financeiro
  return {
    income,
    expenses,
    balance,
    pendingIncome,
    pendingExpenses,
    projectedBalance: balance + pendingIncome - pendingExpenses
  };
}

// Obter despesas por categoria para um conjunto de transações
function getExpensesByCategory(filteredTransactions) {
  // Filtrar apenas transações de despesa
  const expenseTransactions = filteredTransactions.filter(t => t.type === 'expense');
  
  // Agrupar por categoria
  const expensesByCategory = {};
  
  // Inicializar categorias
  categories
    .filter(c => c.type === 'expense')
    .forEach(c => {
      expensesByCategory[c.id] = 0;
    });
  
  // Somar despesas por categoria
  expenseTransactions.forEach(t => {
    if (expensesByCategory[t.category] !== undefined) {
      expensesByCategory[t.category] += Number(t.amount);
    }
  });
  
  return expensesByCategory;
}

// Obter dados para o gráfico de receitas vs despesas por mês
function getIncomeVsExpensesByMonth(months = 12) {
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const labels = [];
  const incomeData = [];
  const expenseData = [];
  
  // Gerar dados para os meses específicos
  for (let i = months - 1; i >= 0; i--) {
    const targetMonth = currentMonth - i;
    const targetYear = currentYear + Math.floor(targetMonth / 12);
    const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
    
    // Formatar rótulo do mês
    const monthDate = new Date(targetYear, normalizedMonth, 1);
    const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
    labels.push(monthLabel);
    
    // Filtrar transações para este mês
    const monthTransactions = filterTransactions({
      year: targetYear,
      month: normalizedMonth
    });
    
    // Calcular receitas e despesas
    const summary = getFinanceSummary(monthTransactions);
    
    incomeData.push(summary.income);
    expenseDataTentar novamenteClaude atingiu o limite máximo de caracteres para uma mensagem e pausou sua resposta. Você pode escrever Continue para prosseguir com a conversa. Claude ainda não tem a capacidade de executar o código que gera.WJContinuarEditarContinuando com o código da aplicação:
<artifact identifier="finance-dashboard-firebase" title="Dashboard de Controle Financeiro Familiar com Firebase" type="text/html">
        expenseData.push(summary.expenses);
      }
  return {
    labels,
    incomeData,
    expenseData
  };
}

// Obter dados para o gráfico de fluxo de caixa
function getCashFlowData(year = new Date().getFullYear()) {
  const labels = [];
  const balanceData = [];
  
  // Gerar dados para cada mês do ano
  for (let month = 0; month < 12; month++) {
    // Formatar rótulo do mês
    const monthDate = new Date(year, month, 1);
    const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short' });
    labels.push(monthLabel);
    
    // Filtrar transações para este mês
    const monthTransactions = filterTransactions({
      year: year,
      month: month
    });
    
    // Calcular fluxo de caixa
    const summary = getFinanceSummary(monthTransactions);
    balanceData.push(summary.balance);
  }
  
  return {
    labels,
    balanceData
  };
}

// Obter orçamento atual
async function getCurrentBudget() {
  const today = new Date();
  const currentMonth = today.getMonth(); // 0-11
  const currentYear = today.getFullYear();
  
  const budget = await getBudgetForMonthAndYear(currentMonth, currentYear);
  
  // Se não encontrar, criar um novo vazio
  if (!budget) {
    const newBudget = {
      month: currentMonth,
      year: currentYear,
      categories: []
    };
    
    // Adicionar todas as categorias de despesa
    categories.filter(c => c.type === 'expense').forEach(c => {
      newBudget.categories.push({
        id: c.id,
        amount: 0
      });
    });
    
    // Salvar o novo orçamento
    const firestoreId = await saveBudgetToFirestore(newBudget);
    
    return {
      ...newBudget,
      firestoreId
    };
  }
  
  return budget;
}

// Obter despesas atuais por categoria
function getCurrentExpensesByCategory() {
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  // Filtrar transações do mês atual
  const monthTransactions = filterTransactions({
    year: currentYear,
    month: currentMonth
  });
  
  return getExpensesByCategory(monthTransactions);
}

// Calcular progresso de uma meta
function calculateGoalProgress(goal) {
  const currentAmount = Number(goal.currentAmount);
  const targetAmount = Number(goal.targetAmount);
  
  // Calcular porcentagem de progresso
  const progress = (currentAmount / targetAmount) * 100;
  
  // Calcular dias restantes
  const today = new Date();
  const targetDate = new Date(goal.targetDate);
  const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
  
  // Calcular valor restante
  const remainingAmount = targetAmount - currentAmount;
  
  // Calcular economia diária necessária
  const dailySavingsNeeded = daysRemaining > 0 ? remainingAmount / daysRemaining : 0;
  
  // Calcular economia mensal necessária
  const monthlySavingsNeeded = daysRemaining > 0 ? remainingAmount / (daysRemaining / 30) : 0;
  
  return {
    progress: Math.min(progress, 100),
    daysRemaining: Math.max(daysRemaining, 0),
    remainingAmount,
    dailySavingsNeeded,
    monthlySavingsNeeded
  };
}

// Formatar número com casas decimais específicas
function formatNumber(num, digits = 1) {
  return Number(num).toFixed(digits);
}

// ===== Inicialização de Componentes =====

// Inicializar filtros
function initFilters() {
  // Preencher categorias nos filtros
  updateCategorySelects();
  
  // Inicializar o evento de mudança de tipo de transação
  const transactionType = document.getElementById('transaction-type');
  transactionType.addEventListener('change', updateCategorySelect);
  
  // Inicialização inicial das categorias
  updateCategorySelect();
  
  // Inicializar eventos para os filtros
  document.getElementById('filter-year').addEventListener('change', updateDashboard);
  document.getElementById('filter-month').addEventListener('change', updateDashboard);
  document.getElementById('filter-category').addEventListener('change', updateDashboard);
  document.getElementById('filter-type').addEventListener('change', updateDashboard);
  
  // Inicializar filtros de transações
  document.getElementById('transactions-filter-year').addEventListener('change', updateTransactionsTable);
  document.getElementById('transactions-filter-month').addEventListener('change', updateTransactionsTable);
  document.getElementById('transactions-filter-type').addEventListener('change', updateTransactionsTable);
  document.getElementById('transactions-filter-category').addEventListener('change', updateTransactionsTable);
  document.getElementById('transactions-filter-status').addEventListener('change', updateTransactionsTable);
  document.getElementById('transactions-search').addEventListener('input', updateTransactionsTable);
  
  // Inicializar filtros de gráficos
  document.getElementById('income-expense-chart-period').addEventListener('change', updateIncomeExpenseChart);
  document.getElementById('category-chart-period').addEventListener('change', updateCategoryChart);
  document.getElementById('cashflow-chart-year').addEventListener('change', updateCashFlowChart);
  document.getElementById('trend-chart-category').addEventListener('change', updateTrendChart);
  
  // Inicializar filtros de análise mensal
  document.getElementById('monthly-analysis-year').addEventListener('change', updateMonthlyAnalysis);
  document.getElementById('monthly-analysis-month').addEventListener('change', updateMonthlyAnalysis);
  document.getElementById('prev-month').addEventListener('click', navigateToPreviousMonth);
  document.getElementById('next-month').addEventListener('click', navigateToNextMonth);
}

// Atualizar todos os selects de categorias
function updateCategorySelects() {
  const filterCategory = document.getElementById('filter-category');
  const trendChartCategory = document.getElementById('trend-chart-category');
  const transactionsFilterCategory = document.getElementById('transactions-filter-category');
  
  // Limpar opções existentes (exceto a primeira)
  [filterCategory, trendChartCategory, transactionsFilterCategory].forEach(select => {
    if (select) {
      while (select.options.length > 1) {
        select.remove(1);
      }
    }
  });
  
  // Adicionar categorias
  categories.forEach(category => {
    [filterCategory, trendChartCategory, transactionsFilterCategory].forEach(select => {
      if (select) {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        select.appendChild(option);
      }
    });
  });
}

// Atualizar select de categorias com base no tipo de transação
function updateCategorySelect() {
  const transactionType = document.getElementById('transaction-type');
  const transactionCategory = document.getElementById('transaction-category');
  const type = transactionType.value;
  
  // Limpar opções existentes
  while (transactionCategory.options.length > 0) {
    transactionCategory.remove(0);
  }
  
  // Adicionar categorias com base no tipo
  let categoriesToAdd = categories.filter(c => c.type === type);
  
  if (categoriesToAdd.length === 0) {
    // Se não houver nenhuma categoria, adicione uma opção padrão
    const option = document.createElement('option');
    option.value = "";
    option.textContent = "Nenhuma categoria disponível";
    transactionCategory.appendChild(option);
  } else {
    categoriesToAdd.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      transactionCategory.appendChild(option);
    });
  }
}

// Inicializar modais
function initModals() {
  // Modal de Nova Transação
  btnNewTransaction.addEventListener('click', () => openTransactionModal());
  document.getElementById('transaction-modal-close').addEventListener('click', () => closeModal(transactionModal));
  document.getElementById('transaction-modal-cancel').addEventListener('click', () => closeModal(transactionModal));
  document.getElementById('transaction-modal-save').addEventListener('click', saveTransaction);
  
  // Checkbox de transação recorrente
  document.getElementById('transaction-recurring').addEventListener('change', function() {
    document.getElementById('recurring-options').style.display = this.checked ? 'block' : 'none';
  });
  
  // Modal de Edição de Orçamento
  btnEditBudget.addEventListener('click', openBudgetModal);
  document.getElementById('budget-modal-close').addEventListener('click', () => closeModal(budgetModal));
  document.getElementById('budget-modal-cancel').addEventListener('click', () => closeModal(budgetModal));
  document.getElementById('budget-modal-save').addEventListener('click', saveBudget);
  
  // Modal de Nova Meta
  btnAddGoal.addEventListener('click', () => openGoalModal());
  document.getElementById('goal-modal-close').addEventListener('click', () => closeModal(goalModal));
  document.getElementById('goal-modal-cancel').addEventListener('click', () => closeModal(goalModal));
  document.getElementById('goal-modal-save').addEventListener('click', saveGoal);
  
  // Modal de Nova Categoria
  btnAddCategory.addEventListener('click', () => openCategoryModal());
  document.getElementById('category-modal-close').addEventListener('click', () => closeModal(categoryModal));
  document.getElementById('category-modal-cancel').addEventListener('click', () => closeModal(categoryModal));
  document.getElementById('category-modal-save').addEventListener('click', saveCategory);
  
  // Modal de Detalhes da Transação
  document.getElementById('transaction-details-modal-close').addEventListener('click', () => closeModal(transactionDetailsModal));
  document.getElementById('transaction-details-edit').addEventListener('click', editTransactionFromDetails);
  document.getElementById('transaction-details-delete').addEventListener('click', confirmDeleteTransaction);
  
  // Modal de Confirmação
  document.getElementById('confirm-modal-close').addEventListener('click', () => closeModal(confirmModal));
  document.getElementById('confirm-modal-cancel').addEventListener('click', () => closeModal(confirmModal));
  
  // Botões de adicionar na análise mensal
  btnAddIncome.addEventListener('click', () => openTransactionModal(null, 'income'));
  btnAddExpense.addEventListener('click', () => openTransactionModal(null, 'expense'));
  
  // Inicializar grade de cores e ícones no modal de categoria
  initColorGrid();
  initIconGrid();
}

// Inicializar a grade de cores para seleção de categoria
function initColorGrid() {
  const colorGrid = document.getElementById('color-grid');
  colorGrid.innerHTML = '';
  
  AVAILABLE_COLORS.forEach(color => {
    const colorItem = document.createElement('div');
    colorItem.className = 'color-item';
    colorItem.style.backgroundColor = color;
    colorItem.dataset.color = color;
    
    colorItem.addEventListener('click', () => {
      // Remover seleção atual
      document.querySelectorAll('.color-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Adicionar seleção ao item clicado
      colorItem.classList.add('selected');
    });
    
    colorGrid.appendChild(colorItem);
  });
}

// Inicializar a grade de ícones para seleção de categoria
function initIconGrid() {
  const iconGrid = document.getElementById('icon-grid');
  iconGrid.innerHTML = '';
  
  AVAILABLE_ICONS.forEach(icon => {
    const iconItem = document.createElement('div');
    iconItem.className = 'icon-item';
    iconItem.innerHTML = icon;
    iconItem.dataset.icon = icon;
    
    iconItem.addEventListener('click', () => {
      // Remover seleção atual
      document.querySelectorAll('.icon-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Adicionar seleção ao item clicado
      iconItem.classList.add('selected');
    });
    
    iconGrid.appendChild(iconItem);
  });
}

// Abrir modal
function openModal(modal) {
  modal.classList.add('active');
}

// Fechar modal
function closeModal(modal) {
  modal.classList.remove('active');
}

// Abrir modal de transação
function openTransactionModal(transaction = null, defaultType = null) {
  const modalTitle = document.getElementById('transaction-modal-title');
  const form = document.getElementById('transaction-form');
  
  // Resetar formulário
  form.reset();
  
  // Definir data atual no campo de data
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('transaction-date').value = today;
  
  // Se tiver um tipo padrão, definir
  if (defaultType) {
    document.getElementById('transaction-type').value = defaultType;
    updateCategorySelect();
  }
  
  // Atualizar título e dados do formulário
  if (transaction) {
    modalTitle.textContent = 'Editar Transação';
    
    // Preencher formulário com dados da transação
    document.getElementById('transaction-id').value = transaction.id || '';
    document.getElementById('transaction-type').value = transaction.type;
    document.getElementById('transaction-date').value = transaction.date;
    document.getElementById('transaction-description').value = transaction.description;
    document.getElementById('transaction-amount').value = transaction.amount;
    document.getElementById('transaction-status').value = transaction.status;
    
    // Atualizar select de categorias e selecionar a categoria correta
    updateCategorySelect();
    document.getElementById('transaction-category').value = transaction.category;
    
    // Preencher forma de pagamento se existir
    if (transaction.paymentMethod) {
      document.getElementById('transaction-payment-method').value = transaction.paymentMethod;
    }
    
    // Preencher observações se existirem
    if (transaction.notes) {
      document.getElementById('transaction-notes').value = transaction.notes;
    }
    
    // Configurar opções recorrentes se aplicável
    if (transaction.recurring) {
      document.getElementById('transaction-recurring').checked = true;
      document.getElementById('recurring-options').style.display = 'block';
      document.getElementById('transaction-frequency').value = transaction.frequency;
      
      if (transaction.endDate) {
        document.getElementById('transaction-end-date').value = transaction.endDate;
      }
    } else {
      document.getElementById('transaction-recurring').checked = false;
      document.getElementById('recurring-options').style.display = 'none';
    }
  } else {
    modalTitle.textContent = 'Nova Transação';
    document.getElementById('transaction-id').value = '';
    document.getElementById('transaction-recurring').checked = false;
    document.getElementById('recurring-options').style.display = 'none';
  }
  
  // Abrir modal
  openModal(transactionModal);
}

// Salvar transação
async function saveTransaction() {
  try {
    // Obter valores do formulário
    const id = document.getElementById('transaction-id').value || uuid.v4();
    const type = document.getElementById('transaction-type').value;
    const date = document.getElementById('transaction-date').value;
    const description = document.getElementById('transaction-description').value;
    const amount = parseFloat(document.getElementById('transaction-amount').value);
    const category = document.getElementById('transaction-category').value;
    const status = document.getElementById('transaction-status').value;
    const paymentMethod = document.getElementById('transaction-payment-method').value;
    const notes = document.getElementById('transaction-notes').value;
    const recurring = document.getElementById('transaction-recurring').checked;
    
    // Validar campos obrigatórios
    if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
      showAlert('Por favor, preencha todos os campos obrigatórios.', 'warning');
      return;
    }
    
    // Criar objeto de transação
    const transaction = {
      id,
      type,
      date,
      description,
      amount,
      category,
      status,
      paymentMethod,
      notes
    };
    
    // Adicionar campos recorrentes se aplicável
    if (recurring) {
      transaction.recurring = true;
      transaction.frequency = document.getElementById('transaction-frequency').value;
      
      const endDate = document.getElementById('transaction-end-date').value;
      if (endDate) {
        transaction.endDate = endDate;
      }
    }
    
    // Verificar se é uma edição ou nova transação
    const existingIndex = transactions.findIndex(t => t.id === id);
    
    if (existingIndex >= 0) {
      // Atualizar transação existente
      transaction.firestoreId = transactions[existingIndex].firestoreId;
      
      // Salvar no Firestore
      await saveTransactionToFirestore(transaction);
      
      // Atualizar no array local
      transactions[existingIndex] = transaction;
      
      showAlert('Transação atualizada com sucesso!', 'success');
    } else {
      // Adicionar nova transação
      const firestoreId = await saveTransactionToFirestore(transaction);
      
      // Adicionar ao array local com o ID do Firestore
      transactions.push({
        ...transaction,
        firestoreId
      });
      
      showAlert('Transação adicionada com sucesso!', 'success');
    }
    
    // Fechar modal
    closeModal(transactionModal);
    
    // Atualizar dashboard
    updateDashboard();
    
  } catch (error) {
    console.error('Erro ao salvar transação:', error);
    showAlert('Erro ao salvar transação. Tente novamente.', 'danger');
  }
}

// Abrir modal de orçamento
async function openBudgetModal() {
  try {
    // Verificar se já temos os dados das categorias
    if (categories.length === 0) {
      showAlert('Carregando categorias. Tente novamente em alguns instantes.', 'info');
      return;
    }
    
    // Obtém o ano e mês selecionados nos filtros
    const selectedYear = parseInt(document.getElementById('filter-year').value);
    const selectedMonth = document.getElementById('filter-month').value === 'all' 
      ? new Date().getMonth() 
      : parseInt(document.getElementById('filter-month').value);
    
    // Preencher campos de ano e mês
    document.getElementById('budget-year').value = selectedYear;
    document.getElementById('budget-month').value = selectedMonth;
    
    // Verificar se já existe um orçamento para este mês/ano
    const budget = await getBudgetForMonthAndYear(selectedMonth, selectedYear);
    
    // Atualizar container de categorias
    const categoriesContainer = document.getElementById('budget-categories-container');
    categoriesContainer.innerHTML = '';
    
    // Obter apenas categorias de despesa
    const expenseCategories = categories.filter(c => c.type === 'expense');
    
    expenseCategories.forEach(category => {
      // Verificar se existe uma configuração de orçamento para esta categoria
      let budgetAmount = 0;
      
      if (budget && budget.categories) {
        const budgetCategory = budget.categories.find(bc => bc.id === category.id);
        if (budgetCategory) {
          budgetAmount = budgetCategory.amount;
        }
      }
      
      // Criar elemento de formulário para a categoria
      const categoryElement = document.createElement('div');
      categoryElement.className = 'form-group';
      categoryElement.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
          <div style="width: 1.5rem; height: 1.5rem; border-radius: 50%; background-color: ${category.color}; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: white;">${category.icon}</div>
          <label for="budget-category-${category.id}">${category.name}</label>
        </div>
        <input type="number" min="0" step="0.01" class="form-control" id="budget-category-${category.id}" 
               name="budget-category-${category.id}" value="${budgetAmount}" 
               data-category-id="${category.id}" placeholder="0,00">
      `;
      
      categoriesContainer.appendChild(categoryElement);
    });
    
    // Abrir modal
    openModal(budgetModal);
    
  } catch (error) {
    console.error('Erro ao abrir modal de orçamento:', error);
    showAlert('Erro ao carregar orçamento. Tente novamente.', 'danger');
  }
}

// Salvar orçamento
async function saveBudget() {
  try {
    // Obter valores do formulário
    const year = parseInt(document.getElementById('budget-year').value);
    const month = parseInt(document.getElementById('budget-month').value);
    
    // Obter valores de orçamento por categoria
    const categories = [];
    const inputs = document.querySelectorAll('#budget-categories-container input');
    
    inputs.forEach(input => {
      const categoryId = input.dataset.categoryId;
      const amount = parseFloat(input.value) || 0;
      
      categories.push({
        id: categoryId,
        amount
      });
    });
    
    // Criar objeto de orçamento
    const budget = {
      year,
      month,
      categories
    };
    
    // Salvar no Firestore
    await saveBudgetToFirestore(budget);
    
    // Fechar modal
    closeModal(budgetModal);
    
    // Atualizar tab de orçamento
    if (currentTab === 'budget') {
      updateBudgetTab();
    }
    
    showAlert('Orçamento salvo com sucesso!', 'success');
    
  } catch (error) {
    console.error('Erro ao salvar orçamento:', error);
    showAlert('Erro ao salvar orçamento. Tente novamente.', 'danger');
  }
}

// Abrir modal de meta
function openGoalModal(goal = null) {
  const modalTitle = document.getElementById('goal-modal-title');
  const form = document.getElementById('goal-form');
  
  // Resetar formulário
  form.reset();
  
  // Definir data futura padrão (fim do ano atual)
  const today = new Date();
  const endOfYear = new Date(today.getFullYear(), 11, 31);
  document.getElementById('goal-date').value = endOfYear.toISOString().split('T')[0];
  
  // Atualizar título e dados do formulário
  if (goal) {
    modalTitle.textContent = 'Editar Meta';
    
    // Preencher formulário com dados da meta
    document.getElementById('goal-id').value = goal.id || '';
    document.getElementById('goal-name').value = goal.name;
    document.getElementById('goal-target').value = goal.targetAmount;
    document.getElementById('goal-current').value = goal.currentAmount;
    document.getElementById('goal-date').value = goal.targetDate;
    document.getElementById('goal-category').value = goal.category;
    
    if (goal.notes) {
      document.getElementById('goal-notes').value = goal.notes;
    }
  } else {
    modalTitle.textContent = 'Nova Meta';
    document.getElementById('goal-id').value = '';
  }
  
  // Abrir modal
  openModal(goalModal);
}

// Salvar meta
async function saveGoal() {
  try {
    // Obter valores do formulário
    const id = document.getElementById('goal-id').value || uuid.v4();
    const name = document.getElementById('goal-name').value;
    const targetAmount = parseFloat(document.getElementById('goal-target').value);
    const currentAmount = parseFloat(document.getElementById('goal-current').value);
    const targetDate = document.getElementById('goal-date').value;
    const category = document.getElementById('goal-category').value;
    const notes = document.getElementById('goal-notes').value;
    
    // Validar campos obrigatórios
    if (!name || isNaN(targetAmount) || targetAmount <= 0 || isNaN(currentAmount) || !targetDate) {
      showAlert('Por favor, preencha todos os campos obrigatórios.', 'warning');
      return;
    }
    
    // Criar objeto de meta
    const goal = {
      id,
      name,
      targetAmount,
      currentAmount,
      targetDate,
      category,
      notes
    };
    
    // Verificar se é uma edição ou nova meta
    const existingIndex = goals.findIndex(g => g.id === id);
    
    if (existingIndex >= 0) {
      // Atualizar meta existente
      goal.firestoreId = goals[existingIndex].firestoreId;
      
      // Salvar no Firestore
      await saveGoalToFirestore(goal);
      
      // Atualizar no array local
      goals[existingIndex] = goal;
      
      showAlert('Meta atualizada com sucesso!', 'success');
    } else {
      // Adicionar nova meta
      const firestoreId = await saveGoalToFirestore(goal);
      
      // Adicionar ao array local com o ID do Firestore
      goals.push({
        ...goal,
        firestoreId
      });
      
      showAlert('Meta adicionada com sucesso!', 'success');
    }
    
    // Fechar modal
    closeModal(goalModal);
    
    // Atualizar aba de metas
    if (currentTab === 'goals') {
      updateGoalsTab();
    }
    
  } catch (error) {
    console.error('Erro ao salvar meta:', error);
    showAlert('Erro ao salvar meta. Tente novamente.', 'danger');
  }
}

// Abrir modal de categoria
function openCategoryModal(category = null) {
  const modalTitle = document.getElementById('category-modal-title');
  const form = document.getElementById('category-form');
  
  // Resetar formulário e seleções
  form.reset();
  document.querySelectorAll('.color-item.selected, .icon-item.selected').forEach(item => {
    item.classList.remove('selected');
  });
  
  // Atualizar título e dados do formulário
  if (category) {
    modalTitle.textContent = 'Editar Categoria';
    
    // Preencher formulário com dados da categoria
    document.getElementById('category-id').value = category.id || '';
    document.getElementById('category-name').value = category.name;
    document.getElementById('category-type').value = category.type;
    
    // Selecionar cor
    const colorItem = document.querySelector(`.color-item[data-color="${category.color}"]`);
    if (colorItem) {
      colorItem.classList.add('selected');
    }
    
    // Selecionar ícone
    const iconItem = document.querySelector(`.icon-item[data-icon="${category.icon}"]`);
    if (iconItem) {
      iconItem.classList.add('selected');
    }
  } else {
    modalTitle.textContent = 'Nova Categoria';
    document.getElementById('category-id').value = '';
    
    // Selecionar a primeira cor e ícone por padrão
    const firstColor = document.querySelector('.color-item');
    if (firstColor) {
      firstColor.classList.add('selected');
    }
    
    const firstIcon = document.querySelector('.icon-item');
    if (firstIcon) {
      firstIcon.classList.add('selected');
    }
  }
  
  // Abrir modal
  openModal(categoryModal);
}

// Salvar categoria
async function saveCategory() {
  try {
    // Obter valores do formulário
    const id = document.getElementById('category-id').value || uuid.v4();
    const name = document.getElementById('category-name').value;
    const type = document.getElementById('category-type').value;
    
    // Obter cor e ícone selecionados
    const selectedColor = document.querySelector('.color-item.selected');
    const selectedIcon = document.querySelector('.icon-item.selected');
    
    if (!selectedColor || !selectedIcon) {
      showAlert('Por favor, selecione uma cor e um ícone.', 'warning');
      return;
    }
    
    const color = selectedColor.dataset.color;
    const icon = selectedIcon.dataset.icon;
    
    // Validar campos obrigatórios
    if (!name || !type || !color || !icon) {
      showAlert('Por favor, preencha todos os campos obrigatórios.', 'warning');
      return;
    }
    
    // Criar objeto de categoria
    const category = {
      id,
      name,
      type,
      color,
      icon
    };
    
    // Verificar se é uma edição ou nova categoria
    const existingIndex = categories.findIndex(c => c.id === id);
    
    if (existingIndex >= 0) {
      // Atualizar categoria existente
      category.firestoreId = categories[existingIndex].firestoreId;
      
      // Salvar no Firestore
      await saveCategoryToFirestore(category);
      
      // Atualizar no array local
      categories[existingIndex] = category;
      
      showAlert('Categoria atualizada com sucesso!', 'success');
    } else {
      // Adicionar nova categoria
      const firestoreId = await saveCategoryToFirestore(category);
      
      // Adicionar ao array local com o ID do Firestore
      categories.push({
        ...category,
        firestoreId
      });
      
      showAlert('Categoria adicionada com sucesso!', 'success');
    }
    
    // Fechar modal
    closeModal(categoryModal);
    
    // Atualizar selects de categoria
    updateCategorySelects();
    
    // Atualizar aba de categorias
    if (currentTab === 'categories') {
      updateCategoriesTab();
    }
    
  } catch (error) {
    console.error('Erro ao salvar categoria:', error);
    showAlert('Erro ao salvar categoria. Tente novamente.Tentar novamenteClaude atingiu o limite máximo de caracteres para uma mensagem e pausou sua resposta. Você pode escrever Continue para prosseguir com a conversa. Claude ainda não tem a capacidade de executar o código que gera.WJContinuarEditarContinuando com o código da aplicação:
<artifact identifier="finance-dashboard-firebase" title="Dashboard de Controle Financeiro Familiar com Firebase" type="text/html">
        showAlert('Erro ao salvar categoria. Tente novamente.', 'danger');
      }
    }
// Mostrar detalhes da transação
async function showTransactionDetails(transactionId) {
  try {
    // Encontrar transação
    const transaction = transactions.find(t => t.id === transactionId);
    
    if (!transaction) {
      showAlert('Transação não encontrada.', 'danger');
      return;
    }
    
    // Preencher recibo
    const receipt = document.getElementById('transaction-receipt');
    
    // Encontrar categoria
    const categoryData = categories.find(c => c.id === transaction.category) || 
      { name: 'Categoria Desconhecida', color: '#999', icon: '📋' };
    
    // Formatar data
    const date = new Date(transaction.date);
    const formattedDate = date.toLocaleDateString('pt-BR', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    // Construir HTML do recibo
    receipt.innerHTML = `
      <div class="receipt-header">
        <div class="receipt-title">${transaction.type === 'income' ? 'Receita' : 'Despesa'}</div>
        <div class="receipt-date">${formattedDate}</div>
      </div>
      
      <div class="receipt-body">
        <div class="receipt-item">
          <div class="receipt-item-label">Descrição:</div>
          <div class="receipt-item-value">${transaction.description}</div>
        </div>
        
        <div class="receipt-item">
          <div class="receipt-item-label">Categoria:</div>
          <div class="receipt-item-value">
            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
              <span style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${categoryData.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">${categoryData.icon}</span>
              ${categoryData.name}
            </span>
          </div>
        </div>
        
        <div class="receipt-item">
          <div class="receipt-item-label">Data:</div>
          <div class="receipt-item-value">${formatDate(transaction.date)}</div>
        </div>
        
        <div class="receipt-item">
          <div class="receipt-item-label">Status:</div>
          <div class="receipt-item-value">${TRANSACTION_STATUS[transaction.status].name}</div>
        </div>
        
        ${transaction.paymentMethod ? `
        <div class="receipt-item">
          <div class="receipt-item-label">Forma de Pagamento:</div>
          <div class="receipt-item-value">${PAYMENT_METHODS[transaction.paymentMethod] || transaction.paymentMethod}</div>
        </div>
        ` : ''}
        
        ${transaction.recurring ? `
        <div class="receipt-item">
          <div class="receipt-item-label">Recorrência:</div>
          <div class="receipt-item-value">${transaction.frequency === 'monthly' ? 'Mensal' : 
                                        transaction.frequency === 'weekly' ? 'Semanal' : 
                                        transaction.frequency === 'biweekly' ? 'Quinzenal' :
                                        transaction.frequency === 'quarterly' ? 'Trimestral' :
                                        transaction.frequency === 'semiannual' ? 'Semestral' :
                                        transaction.frequency === 'annual' ? 'Anual' : transaction.frequency}</div>
        </div>
        ` : ''}
        
        ${transaction.notes ? `
        <div class="receipt-item">
          <div class="receipt-item-label">Observações:</div>
          <div class="receipt-item-value">${transaction.notes}</div>
        </div>
        ` : ''}
        
        <div class="receipt-divider"></div>
        
        <div class="receipt-total">
          <div>Total:</div>
          <div style="color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'}">
            ${formatCurrency(transaction.amount)}
          </div>
        </div>
      </div>
      
      <div class="receipt-footer">
        <div>Transação #${transaction.id.substring(0, 8)}</div>
      </div>
    `;
    
    // Configurar botões de ação
    document.getElementById('transaction-details-edit').onclick = () => {
      closeModal(transactionDetailsModal);
      openTransactionModal(transaction);
    };
    
    document.getElementById('transaction-details-delete').onclick = () => {
      confirmDeleteTransaction(transaction.id);
    };
    
    // Abrir modal
    openModal(transactionDetailsModal);
    
  } catch (error) {
    console.error('Erro ao mostrar detalhes da transação:', error);
    showAlert('Erro ao carregar detalhes da transação. Tente novamente.', 'danger');
  }
}

// Editar transação a partir da modal de detalhes
function editTransactionFromDetails() {
  // Esta função é configurada dinamicamente em showTransactionDetails
}

// Confirmar exclusão de transação
function confirmDeleteTransaction(transactionId) {
  const transaction = transactions.find(t => t.id === transactionId);
  
  if (!transaction) {
    showAlert('Transação não encontrada.', 'danger');
    return;
  }
  
  // Configurar modal de confirmação
  document.getElementById('confirm-modal-title').textContent = 'Excluir Transação';
  document.getElementById('confirm-modal-message').textContent = `Tem certeza que deseja excluir a transação "${transaction.description}"?`;
  
  // Configurar botão de confirmação
  document.getElementById('confirm-modal-confirm').onclick = async () => {
    await deleteTransaction(transactionId);
    closeModal(confirmModal);
    
    // Fechar modal de detalhes se estiver aberta
    if (transactionDetailsModal.classList.contains('active')) {
      closeModal(transactionDetailsModal);
    }
  };
  
  // Abrir modal de confirmação
  openModal(confirmModal);
}

// Excluir transação
async function deleteTransaction(transactionId) {
  try {
    // Encontrar transação
    const index = transactions.findIndex(t => t.id === transactionId);
    
    if (index >= 0) {
      // Excluir do Firestore
      const success = await deleteTransactionFromFirestore(transactions[index].firestoreId);
      
      if (success) {
        // Remover do array local
        transactions.splice(index, 1);
        
        // Atualizar dashboard
        updateDashboard();
        
        showAlert('Transação excluída com sucesso!', 'success');
      }
    } else {
      showAlert('Transação não encontrada.', 'danger');
    }
  } catch (error) {
    console.error('Erro ao excluir transação:', error);
    showAlert('Erro ao excluir transação. Tente novamente.', 'danger');
  }
}

// Confirmar exclusão de categoria
function confirmDeleteCategory(categoryId) {
  // Verificar se a categoria existe
  const category = categories.find(c => c.id === categoryId);
  
  if (!category) {
    showAlert('Categoria não encontrada.', 'danger');
    return;
  }
  
  // Verificar se há transações utilizando esta categoria
  const transactionsUsingCategory = transactions.filter(t => t.category === categoryId);
  
  if (transactionsUsingCategory.length > 0) {
    showAlert(`Não é possível excluir a categoria "${category.name}" pois existem ${transactionsUsingCategory.length} transações utilizando esta categoria.`, 'warning');
    return;
  }
  
  // Configurar modal de confirmação
  document.getElementById('confirm-modal-title').textContent = 'Excluir Categoria';
  document.getElementById('confirm-modal-message').textContent = `Tem certeza que deseja excluir a categoria "${category.name}"?`;
  
  // Configurar botão de confirmação
  document.getElementById('confirm-modal-confirm').onclick = async () => {
    await deleteCategory(categoryId);
    closeModal(confirmModal);
  };
  
  // Abrir modal de confirmação
  openModal(confirmModal);
}

// Excluir categoria
async function deleteCategory(categoryId) {
  try {
    // Encontrar categoria
    const index = categories.findIndex(c => c.id === categoryId);
    
    if (index >= 0) {
      // Excluir do Firestore
      const success = await deleteCategoryFromFirestore(categories[index].firestoreId);
      
      if (success) {
        // Remover do array local
        categories.splice(index, 1);
        
        // Atualizar selects de categoria
        updateCategorySelects();
        
        // Atualizar aba de categorias
        if (currentTab === 'categories') {
          updateCategoriesTab();
        }
        
        showAlert('Categoria excluída com sucesso!', 'success');
      }
    } else {
      showAlert('Categoria não encontrada.', 'danger');
    }
  } catch (error) {
    console.error('Erro ao excluir categoria:', error);
    showAlert('Erro ao excluir categoria. Tente novamente.', 'danger');
  }
}

// Confirmar exclusão de meta
function confirmDeleteGoal(goalId) {
  // Verificar se a meta existe
  const goal = goals.find(g => g.id === goalId);
  
  if (!goal) {
    showAlert('Meta não encontrada.', 'danger');
    return;
  }
  
  // Configurar modal de confirmação
  document.getElementById('confirm-modal-title').textContent = 'Excluir Meta';
  document.getElementById('confirm-modal-message').textContent = `Tem certeza que deseja excluir a meta "${goal.name}"?`;
  
  // Configurar botão de confirmação
  document.getElementById('confirm-modal-confirm').onclick = async () => {
    await deleteGoal(goalId);
    closeModal(confirmModal);
  };
  
  // Abrir modal de confirmação
  openModal(confirmModal);
}

// Excluir meta
async function deleteGoal(goalId) {
  try {
    // Encontrar meta
    const index = goals.findIndex(g => g.id === goalId);
    
    if (index >= 0) {
      // Excluir do Firestore
      const success = await deleteGoalFromFirestore(goals[index].firestoreId);
      
      if (success) {
        // Remover do array local
        goals.splice(index, 1);
        
        // Atualizar aba de metas
        if (currentTab === 'goals') {
          updateGoalsTab();
        }
        
        showAlert('Meta excluída com sucesso!', 'success');
      }
    } else {
      showAlert('Meta não encontrada.', 'danger');
    }
  } catch (error) {
    console.error('Erro ao excluir meta:', error);
    showAlert('Erro ao excluir meta. Tente novamente.', 'danger');
  }
}

// Abrir modal para atualizar saldo da meta
function openUpdateGoalBalanceModal(goal) {
  // Configurar modal de confirmação para atualização de saldo
  document.getElementById('confirm-modal-title').textContent = 'Atualizar Saldo da Meta';
  document.getElementById('confirm-modal-message').innerHTML = `
    <div>
      <p>Meta: <strong>${goal.name}</strong></p>
      <p>Saldo atual: ${formatCurrency(goal.currentAmount)}</p>
      <div class="form-group">
        <label for="new-goal-amount">Novo saldo:</label>
        <input type="number" id="new-goal-amount" class="form-control" value="${goal.currentAmount}" min="0" step="0.01">
      </div>
    </div>
  `;
  
  // Configurar botão de confirmação
  document.getElementById('confirm-modal-confirm').textContent = 'Atualizar';
  document.getElementById('confirm-modal-confirm').onclick = async () => {
    await updateGoalBalance(goal.id, parseFloat(document.getElementById('new-goal-amount').value));
    closeModal(confirmModal);
  };
  
  // Abrir modal de confirmação
  openModal(confirmModal);
}

// Atualizar saldo da meta
async function updateGoalBalance(goalId, newAmount) {
  try {
    if (isNaN(newAmount) || newAmount < 0) {
      showAlert('Por favor, insira um valor válido.', 'warning');
      return;
    }
    
    // Encontrar meta
    const goalIndex = goals.findIndex(g => g.id === goalId);
    
    if (goalIndex >= 0) {
      // Atualizar saldo
      goals[goalIndex].currentAmount = newAmount;
      
      // Salvar no Firestore
      await saveGoalToFirestore(goals[goalIndex]);
      
      // Atualizar aba de metas
      if (currentTab === 'goals') {
        updateGoalsTab();
      }
      
      showAlert('Saldo da meta atualizado com sucesso!', 'success');
    } else {
      showAlert('Meta não encontrada.', 'danger');
    }
  } catch (error) {
    console.error('Erro ao atualizar saldo da meta:', error);
    showAlert('Erro ao atualizar saldo da meta. Tente novamente.', 'danger');
  }
}

// ===== Inicialização de Gráficos =====

// Configurações comuns para todos os gráficos
function getChartCommonOptions() {
  const isDark = root.getAttribute('data-theme') === 'dark';
  const textColor = isDark ? '#F5F5F7' : '#1D1D1F';
  const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)';
  
  return {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
        align: 'end',
        labels: {
          boxWidth: 12,
          usePointStyle: true,
          pointStyle: 'circle',
          color: textColor,
          font: {
            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
            size: 12
          }
        }
      },
      tooltip: {
        backgroundColor: isDark ? 'rgba(44, 44, 46, 0.9)' : 'rgba(255, 255, 255, 0.9)',
        titleColor: textColor,
        bodyColor: textColor,
        borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)',
        borderWidth: 1,
        cornerRadius: 8,
        padding: 12,
        boxPadding: 6,
        usePointStyle: true,
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';
            if (label) {
              label += ': ';
            }
            if (context.parsed.y !== null) {
              label += formatCurrency(context.parsed.y);
            }
            return label;
          }
        },
        titleFont: {
          family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
          size: 13,
          weight: 'bold'
        },
        bodyFont: {
          family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
          size: 12
        }
      }
    },
    scales: {
      x: {
        grid: {
          color: gridColor
        },
        ticks: {
          color: textColor,
          font: {
            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
            size: 11
          }
        }
      },
      y: {
        grid: {
          color: gridColor
        },
        ticks: {
          color: textColor,
          font: {
            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
            size: 11
          },
          callback: function(value) {
            return formatCurrency(value);
          }
        }
      }
    }
  };
}

let incomeExpenseChart;

// Inicializar gráfico de receitas x despesas
function initIncomeExpenseChart() {
  const ctx = document.getElementById('income-expense-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Obter dados para o gráfico
  const { labels, incomeData, expenseData } = getIncomeVsExpensesByMonth();
  
  // Criar gráfico
  incomeExpenseChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Receitas',
          data: incomeData,
          backgroundColor: getComputedStyle(root).getPropertyValue('--success').trim(),
          borderColor: getComputedStyle(root).getPropertyValue('--success').trim(),
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 35
        },
        {
          label: 'Despesas',
          data: expenseData,
          backgroundColor: getComputedStyle(root).getPropertyValue('--danger').trim(),
          borderColor: getComputedStyle(root).getPropertyValue('--danger').trim(),
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 35
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        ...commonOptions.scales
      }
    }
  });
}

// Atualizar gráfico de receitas x despesas
function updateIncomeExpenseChart() {
  if (!incomeExpenseChart) return;
  
  // Obter período selecionado
  const periodSelect = document.getElementById('income-expense-chart-period');
  const months = parseInt(periodSelect.value);
  
  // Obter dados atualizados
  const { labels, incomeData, expenseData } = getIncomeVsExpensesByMonth(months);
  
  // Atualizar dados do gráfico
  incomeExpenseChart.data.labels = labels;
  incomeExpenseChart.data.datasets[0].data = incomeData;
  incomeExpenseChart.data.datasets[1].data = expenseData;
  
  // Atualizar cores com base no tema
  incomeExpenseChart.data.datasets[0].backgroundColor = getComputedStyle(root).getPropertyValue('--success').trim();
  incomeExpenseChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--success').trim();
  incomeExpenseChart.data.datasets[1].backgroundColor = getComputedStyle(root).getPropertyValue('--danger').trim();
  incomeExpenseChart.data.datasets[1].borderColor = getComputedStyle(root).getPropertyValue('--danger').trim();
  
  // Atualizar opções comuns
  incomeExpenseChart.options = { ...getChartCommonOptions() };
  
  incomeExpenseChart.update();
}

let categoryChart;

// Inicializar gráfico de despesas por categoria
function initCategoryChart() {
  const ctx = document.getElementById('category-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Obter dados para o gráfico
  const currentMonth = new Date().getMonth();
  const currentYear = new Date().getFullYear();
  
  const filteredTransactions = filterTransactions({
    month: currentMonth,
    year: currentYear
  });
  
  const expensesByCategory = getExpensesByCategory(filteredTransactions);
  
  // Preparar dados para o gráfico
  const labels = [];
  const data = [];
  const backgroundColors = [];
  
  // Ordenar categorias por valor (maior para menor)
  const sortedCategories = Object.entries(expensesByCategory)
    .filter(([categoryId, amount]) => amount > 0)
    .sort((a, b) => b[1] - a[1]);
  
  // Adicionar dados ordenados
  sortedCategories.forEach(([categoryId, amount]) => {
    const category = categories.find(c => c.id === categoryId);
    if (category) {
      labels.push(category.name);
      data.push(amount);
      backgroundColors.push(category.color);
    }
  });
  
  // Criar gráfico
  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [
        {
          data: data,
          backgroundColor: backgroundColors,
          borderColor: getComputedStyle(root).getPropertyValue('--card-bg').trim(),
          borderWidth: 2,
          borderRadius: 4,
          hoverOffset: 6
        }
      ]
    },
    options: {
      ...commonOptions,
      cutout: '70%',
      plugins: {
        ...commonOptions.plugins,
        tooltip: {
          ...commonOptions.plugins.tooltip,
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
              const percentage = Math.round((value / total) * 100);
              return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

// Atualizar gráfico de despesas por categoria
function updateCategoryChart() {
  if (!categoryChart) return;
  
  // Obter período selecionado
  const periodSelect = document.getElementById('category-chart-period');
  const period = periodSelect.value;
  
  let filteredTransactions;
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  // Filtrar por período selecionado
  switch(period) {
    case 'current':
      filteredTransactions = filterTransactions({
        month: currentMonth,
        year: currentYear
      });
      break;
    case 'last':
      // Mês anterior
      const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
      const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
      
      filteredTransactions = filterTransactions({
        month: lastMonth,
        year: lastMonthYear
      });
      break;
    case 'average':
      // Média anual (todos os meses do ano atual)
      filteredTransactions = filterTransactions({
        year: currentYear
      });
      break;
    default:
      filteredTransactions = filterTransactions({
        month: currentMonth,
        year: currentYear
      });
  }
  
  // Obter despesas por categoria
  const expensesByCategory = getExpensesByCategory(filteredTransactions);
  
  // Preparar dados para o gráfico
  const labels = [];
  const data = [];
  const backgroundColors = [];
  
  // Ordenar categorias por valor (maior para menor)
  const sortedCategories = Object.entries(expensesByCategory)
    .filter(([categoryId, amount]) => amount > 0)
    .sort((a, b) => b[1] - a[1]);
  
  // Adicionar dados ordenados
  sortedCategories.forEach(([categoryId, amount]) => {
    const category = categories.find(c => c.id === categoryId);
    if (category) {
      labels.push(category.name);
      data.push(amount);
      backgroundColors.push(category.color);
    }
  });
  
  // Atualizar dados do gráfico
  categoryChart.data.labels = labels;
  categoryChart.data.datasets[0].data = data;
  categoryChart.data.datasets[0].backgroundColor = backgroundColors;
  
  // Atualizar cor da borda com base no tema
  categoryChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--card-bg').trim();
  
  // Atualizar opções comuns
  categoryChart.options = { 
    ...getChartCommonOptions(),
    cutout: '70%',
    plugins: {
      ...getChartCommonOptions().plugins,
      tooltip: {
        ...getChartCommonOptions().plugins.tooltip,
        callbacks: {
          label: function(context) {
            const value = context.parsed;
            const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
            const percentage = Math.round((value / total) * 100);
            return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
          }
        }
      }
    }
  };
  
  categoryChart.update();
}

let cashflowChart;

// Inicializar gráfico de fluxo de caixa
function initCashFlowChart() {
  const ctx = document.getElementById('cashflow-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Obter ano atual
  const currentYear = new Date().getFullYear();
  
  // Obter dados para o gráfico
  const { labels, balanceData } = getCashFlowData(currentYear);
  
  // Determinar cores para cada barra (verde para positivo, vermelho para negativo)
  const barColors = balanceData.map(value => 
    value >= 0 ? getComputedStyle(root).getPropertyValue('--success').trim() : 
                getComputedStyle(root).getPropertyValue('--danger').trim()
  );
  
  // Criar gráfico
  cashflowChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Balanço Mensal',
          data: balanceData,
          backgroundColor: barColors,
          borderColor: barColors,
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 35
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        ...commonOptions.scales
      }
    }
  });
}

// Atualizar gráfico de fluxo de caixa
function updateCashFlowChart() {
  if (!cashflowChart) return;
  
  // Obter ano selecionado
  const yearSelect = document.getElementById('cashflow-chart-year');
  const year = parseInt(yearSelect.value);
  
  // Obter dados atualizados
  const { labels, balanceData } = getCashFlowData(year);
  
  // Determinar cores para cada barra (verde para positivo, vermelho para negativo)
  const barColors = balanceData.map(value => 
    value >= 0 ? getComputedStyle(root).getPropertyValue('--success').trim() : 
                getComputedStyle(root).getPropertyValue('--danger').trim()
  );
  
  // Atualizar dados do gráfico
  cashflowChart.data.labels = labels;
  cashflowChart.data.datasets[0].data = balanceData;
  cashflowChart.data.datasets[0].backgroundColor = barColors;
  cashflowChart.data.datasets[0].borderColor = barColors;
  
  // Atualizar opções comuns
  cashflowChart.options = { ...getChartCommonOptions() };
  
  cashflowChart.update();
}

let fixedVariableChart;

// Inicializar gráfico de gastos fixos vs variáveis
function initFixedVariableChart() {
  const ctx = document.getElementById('fixed-variable-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Filtrar transações de despesa do mês atual
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const monthExpenses = filterTransactions({
    year: currentYear,
    month: currentMonth,
    type: 'expense'
  });
  
  // Separar em fixas e variáveis (consideramos recorrentes como fixas)
  const fixedExpenses = monthExpenses
    .filter(t => t.recurring)
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  const variableExpenses = monthExpenses
    .filter(t => !t.recurring)
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  // Criar gráfico
  fixedVariableChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Despesas Fixas', 'Despesas Variáveis'],
      datasets: [
        {
          data: [fixedExpenses, variableExpenses],
          backgroundColor: [
            getComputedStyle(root).getPropertyValue('--primary').trim(),
            getComputedStyle(root).getPropertyValue('--purple').trim()
          ],
          borderColor: getComputedStyle(root).getPropertyValue('--card-bg').trim(),
          borderWidth: 2,
          borderRadius: 4,
          hoverOffset: 6
        }
      ]
    },
    options: {
      ...commonOptions,
      plugins: {
        ...commonOptions.plugins,
        tooltip: {
          ...commonOptions.plugins.tooltip,
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
              const percentage = Math.round((value / total) * 100);
              return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

// Atualizar gráfico de gastos fixos vs variáveis
function updateFixedVariTentar novamenteClaude atingiu o limite máximo de caracteres para uma mensagem e pausou sua resposta. Você pode escrever Continue para prosseguir com a conversa. Claude ainda não tem a capacidade de executar o código que gera.WJContinuarEditarContinuando com o código da aplicação:
<artifact identifier="finance-dashboard-firebase" title="Dashboard de Controle Financeiro Familiar com Firebase" type="text/html">
    // Atualizar gráfico de gastos fixos vs variáveis
    function updateFixedVariableChart() {
      if (!fixedVariableChart) return;
  // Filtrar transações de despesa do mês atual
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const monthExpenses = filterTransactions({
    year: currentYear,
    month: currentMonth,
    type: 'expense'
  });
  
  // Separar em fixas e variáveis (consideramos recorrentes como fixas)
  const fixedExpenses = monthExpenses
    .filter(t => t.recurring)
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  const variableExpenses = monthExpenses
    .filter(t => !t.recurring)
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  // Atualizar dados do gráfico
  fixedVariableChart.data.datasets[0].data = [fixedExpenses, variableExpenses];
  
  // Atualizar cores com base no tema
  fixedVariableChart.data.datasets[0].backgroundColor = [
    getComputedStyle(root).getPropertyValue('--primary').trim(),
    getComputedStyle(root).getPropertyValue('--purple').trim()
  ];
  fixedVariableChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--card-bg').trim();
  
  // Atualizar opções comuns
  fixedVariableChart.options = { 
    ...getChartCommonOptions(),
    plugins: {
      ...getChartCommonOptions().plugins,
      tooltip: {
        ...getChartCommonOptions().plugins.tooltip,
        callbacks: {
          label: function(context) {
            const value = context.parsed;
            const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
            const percentage = Math.round((value / total) * 100);
            return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
          }
        }
      }
    }
  };
  
  fixedVariableChart.update();
}

let trendChart;

// Inicializar gráfico de tendência de gastos
function initTrendChart() {
  const ctx = document.getElementById('trend-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Obter dados para os últimos 6 meses
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const labels = [];
  const data = [];
  
  // Gerar dados para os últimos 6 meses
  for (let i = 5; i >= 0; i--) {
    const targetMonth = currentMonth - i;
    const targetYear = currentYear + Math.floor(targetMonth / 12);
    const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
    
    // Formatar rótulo do mês
    const monthDate = new Date(targetYear, normalizedMonth, 1);
    const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short' });
    labels.push(monthLabel);
    
    // Filtrar transações para este mês
    const monthTransactions = filterTransactions({
      year: targetYear,
      month: normalizedMonth,
      type: 'expense'
    });
    
    // Calcular total de despesas
    const totalExpenses = monthTransactions.reduce((sum, t) => sum + Number(t.amount), 0);
    data.push(totalExpenses);
  }
  
  // Criar gráfico
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Despesas Totais',
          data: data,
          borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
          backgroundColor: 'rgba(10, 132, 255, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        ...commonOptions.scales
      }
    }
  });
}

// Atualizar gráfico de tendência de gastos
function updateTrendChart() {
  if (!trendChart) return;
  
  // Obter categoria selecionada
  const categorySelect = document.getElementById('trend-chart-category');
  const categoryId = categorySelect.value;
  
  // Obter dados para os últimos 6 meses
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const labels = [];
  const data = [];
  
  // Gerar dados para os últimos 6 meses
  for (let i = 5; i >= 0; i--) {
    const targetMonth = currentMonth - i;
    const targetYear = currentYear + Math.floor(targetMonth / 12);
    const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
    
    // Formatar rótulo do mês
    const monthDate = new Date(targetYear, normalizedMonth, 1);
    const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short' });
    labels.push(monthLabel);
    
    // Filtrar transações para este mês e categoria (se especificada)
    let monthTransactions = filterTransactions({
      year: targetYear,
      month: normalizedMonth,
      type: 'expense'
    });
    
    // Filtrar por categoria específica
    if (categoryId !== 'all') {
      monthTransactions = monthTransactions.filter(t => t.category === categoryId);
    }
    
    // Calcular total de despesas
    const totalExpenses = monthTransactions.reduce((sum, t) => sum + Number(t.amount), 0);
    data.push(totalExpenses);
  }
  
  // Encontrar categoria para atualizar o nome
  let label = 'Despesas Totais';
  if (categoryId !== 'all') {
    const category = categories.find(c => c.id === categoryId);
    if (category) {
      label = `Despesas: ${category.name}`;
    }
  }
  
  // Atualizar dados do gráfico
  trendChart.data.labels = labels;
  trendChart.data.datasets[0].data = data;
  trendChart.data.datasets[0].label = label;
  
  // Atualizar cores com base no tema
  trendChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--primary').trim();
  trendChart.data.datasets[0].backgroundColor = 'rgba(10, 132, 255, 0.1)';
  
  // Atualizar opções comuns
  trendChart.options = { ...getChartCommonOptions() };
  
  trendChart.update();
}

let budgetChart;

// Inicializar gráfico de orçamento
async function initBudgetChart() {
  const ctx = document.getElementById('budget-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Obter orçamento e despesas atuais
  const budget = await getCurrentBudget();
  const expensesByCategory = getCurrentExpensesByCategory();
  
  // Preparar dados para o gráfico
  const labels = [];
  const budgetData = [];
  const expenseData = [];
  
  // Adicionar apenas categorias com orçamento definido
  if (budget && budget.categories) {
    budget.categories.forEach(budgetCategory => {
      if (budgetCategory.amount > 0) {
        const category = categories.find(c => c.id === budgetCategory.id);
        if (category) {
          labels.push(category.name);
          budgetData.push(budgetCategory.amount);
          expenseData.push(expensesByCategory[budgetCategory.id] || 0);
        }
      }
    });
  }
  
  // Criar gráfico
  budgetChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Orçamento',
          data: budgetData,
          backgroundColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
          borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 35
        },
        {
          label: 'Gasto Atual',
          data: expenseData,
          backgroundColor: getComputedStyle(root).getPropertyValue('--warning').trim(),
          borderColor: getComputedStyle(root).getPropertyValue('--warning').trim(),
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 35
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        ...commonOptions.scales
      }
    }
  });
}

// Atualizar gráfico de orçamento
async function updateBudgetChart() {
  if (!budgetChart) return;
  
  // Obter orçamento e despesas atuais
  const budget = await getCurrentBudget();
  const expensesByCategory = getCurrentExpensesByCategory();
  
  // Preparar dados para o gráfico
  const labels = [];
  const budgetData = [];
  const expenseData = [];
  
  // Adicionar apenas categorias com orçamento definido
  if (budget && budget.categories) {
    budget.categories.forEach(budgetCategory => {
      if (budgetCategory.amount > 0) {
        const category = categories.find(c => c.id === budgetCategory.id);
        if (category) {
          labels.push(category.name);
          budgetData.push(budgetCategory.amount);
          expenseData.push(expensesByCategory[budgetCategory.id] || 0);
        }
      }
    });
  }
  
  // Atualizar dados do gráfico
  budgetChart.data.labels = labels;
  budgetChart.data.datasets[0].data = budgetData;
  budgetChart.data.datasets[1].data = expenseData;
  
  // Atualizar cores com base no tema
  budgetChart.data.datasets[0].backgroundColor = getComputedStyle(root).getPropertyValue('--primary').trim();
  budgetChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--primary').trim();
  budgetChart.data.datasets[1].backgroundColor = getComputedStyle(root).getPropertyValue('--warning').trim();
  budgetChart.data.datasets[1].borderColor = getComputedStyle(root).getPropertyValue('--warning').trim();
  
  // Atualizar opções comuns
  budgetChart.options = { ...getChartCommonOptions() };
  
  budgetChart.update();
}

let savingsProjectionChart;

// Inicializar gráfico de projeção de economia
function initSavingsProjectionChart() {
  const ctx = document.getElementById('savings-projection-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Configurar dados de projeção
  const today = new Date();
  const labels = [];
  const projectedData = [];
  
  // Considerar economias como receitas - despesas dos últimos 3 meses
  const savings = [];
  
  for (let i = 2; i >= 0; i--) {
    const targetMonth = today.getMonth() - i;
    const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
    const normalizedMonth = ((targetMonth % 12) + 12) % 12;
    
    // Filtrar transações para este mês
    const monthTransactions = filterTransactions({
      year: targetYear,
      month: normalizedMonth
    });
    
    // Calcular saldo do mês
    const summary = getFinanceSummary(monthTransactions);
    const monthlySavings = summary.balance;
    savings.push(monthlySavings);
  }
  
  // Calcular média de economia mensal (se não houver dados, usar 0)
  const avgMonthlySavings = savings.length > 0 
    ? savings.reduce((sum, value) => sum + value, 0) / savings.length 
    : 0;
  
  // Projetar para os próximos 12 meses
  let projectedSavings = 0;
  
  for (let i = 0; i < 12; i++) {
    const targetMonth = today.getMonth() + i;
    const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
    const normalizedMonth = targetMonth % 12;
    
    // Formatar rótulo do mês
    const monthDate = new Date(targetYear, normalizedMonth, 1);
    const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: i % 3 === 0 ? 'numeric' : undefined });
    labels.push(monthLabel);
    
    // Acumular economia projetada
    projectedSavings += avgMonthlySavings;
    projectedData.push(projectedSavings);
  }
  
  // Criar gráfico
  savingsProjectionChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Economia Projetada',
          data: projectedData,
          borderColor: getComputedStyle(root).getPropertyValue('--success').trim(),
          backgroundColor: 'rgba(52, 199, 89, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        ...commonOptions.scales
      }
    }
  });
}

// Atualizar gráfico de projeção de economia
function updateSavingsProjectionChart() {
  if (!savingsProjectionChart) return;
  
  // Configurar dados de projeção
  const today = new Date();
  const labels = [];
  const projectedData = [];
  
  // Considerar economias como receitas - despesas dos últimos 3 meses
  const savings = [];
  
  for (let i = 2; i >= 0; i--) {
    const targetMonth = today.getMonth() - i;
    const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
    const normalizedMonth = ((targetMonth % 12) + 12) % 12;
    
    // Filtrar transações para este mês
    const monthTransactions = filterTransactions({
      year: targetYear,
      month: normalizedMonth
    });
    
    // Calcular saldo do mês
    const summary = getFinanceSummary(monthTransactions);
    const monthlySavings = summary.balance;
    savings.push(monthlySavings);
  }
  
  // Calcular média de economia mensal (se não houver dados, usar 0)
  const avgMonthlySavings = savings.length > 0 
    ? savings.reduce((sum, value) => sum + value, 0) / savings.length 
    : 0;
  
  // Projetar para os próximos 12 meses
  let projectedSavings = 0;
  
  for (let i = 0; i < 12; i++) {
    const targetMonth = today.getMonth() + i;
    const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
    const normalizedMonth = targetMonth % 12;
    
    // Formatar rótulo do mês
    const monthDate = new Date(targetYear, normalizedMonth, 1);
    const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: i % 3 === 0 ? 'numeric' : undefined });
    labels.push(monthLabel);
    
    // Acumular economia projetada
    projectedSavings += avgMonthlySavings;
    projectedData.push(projectedSavings);
  }
  
  // Atualizar dados do gráfico
  savingsProjectionChart.data.labels = labels;
  savingsProjectionChart.data.datasets[0].data = projectedData;
  
  // Atualizar cores com base no tema
  savingsProjectionChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--success').trim();
  savingsProjectionChart.data.datasets[0].backgroundColor = 'rgba(52, 199, 89, 0.1)';
  
  // Atualizar opções comuns
  savingsProjectionChart.options = { ...getChartCommonOptions() };
  
  savingsProjectionChart.update();
}

let analysisChart;

// Inicializar gráfico de análise
function initAnalysisChart() {
  const ctx = document.getElementById('analysis-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Configurar dados iniciais (por categoria)
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const monthTransactions = filterTransactions({
    year: currentYear,
    month: currentMonth,
    type: 'expense'
  });
  
  const expensesByCategory = getExpensesByCategory(monthTransactions);
  
  // Preparar dados para o gráfico
  const labels = [];
  const data = [];
  const backgroundColors = [];
  
  // Ordenar categorias por valor (maior para menor)
  const sortedCategories = Object.entries(expensesByCategory)
    .filter(([categoryId, amount]) => amount > 0)
    .sort((a, b) => b[1] - a[1]);
  
  // Adicionar dados ordenados
  sortedCategories.forEach(([categoryId, amount]) => {
    const category = categories.find(c => c.id === categoryId);
    if (category) {
      labels.push(category.name);
      data.push(amount);
      backgroundColors.push(category.color);
    }
  });
  
  // Criar gráfico
  analysisChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Despesas por Categoria',
          data: data,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors,
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 35
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        ...commonOptions.scales
      },
      indexAxis: 'y'
    }
  });
}

// Atualizar gráfico de análise
function updateAnalysisChart() {
  if (!analysisChart) return;
  
  // Obter tipo de análise selecionado
  const analysisType = document.getElementById('analysis-type').value;
  
  // Configurar dados com base no tipo
  let chartType = 'bar';
  let indexAxis = 'y';
  let labels = [];
  let datasets = [];
  
  switch (analysisType) {
    case 'category':
      // Análise por categoria
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      const monthTransactions = filterTransactions({
        year: currentYear,
        month: currentMonth,
        type: 'expense'
      });
      
      const expensesByCategory = getExpensesByCategory(monthTransactions);
      
      // Preparar dados para o gráfico
      const categoryData = [];
      const backgroundColors = [];
      
      // Ordenar categorias por valor (maior para menor)
      const sortedCategories = Object.entries(expensesByCategory)
        .filter(([categoryId, amount]) => amount > 0)
        .sort((a, b) => b[1] - a[1]);
      
      // Adicionar dados ordenados
      sortedCategories.forEach(([categoryId, amount]) => {
        const category = categories.find(c => c.id === categoryId);
        if (category) {
          labels.push(category.name);
          categoryData.push(amount);
          backgroundColors.push(category.color);
        }
      });
      
      datasets = [
        {
          label: 'Despesas por Categoria',
          data: categoryData,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors,
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 35
        }
      ];
      
      break;
      
    case 'monthly':
      // Análise mensal
      chartType = 'line';
      indexAxis = 'x';
      
      // Obter dados para os últimos 12 meses
      const date = new Date();
      const month = date.getMonth();
      const year = date.getFullYear();
      
      const monthlyData = [];
      
      // Gerar dados para os últimos 12 meses
      for (let i = 11; i >= 0; i--) {
        const targetMonth = month - i;
        const targetYear = year + Math.floor(targetMonth / 12);
        const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
        
        // Formatar rótulo do mês
        const monthDate = new Date(targetYear, normalizedMonth, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: i % 3 === 0 ? 'numeric' : undefined });
        labels.push(monthLabel);
        
        // Filtrar transações para este mês
        const monthTransactions = filterTransactions({
          year: targetYear,
          month: normalizedMonth,
          type: 'expense'
        });
        
        // Calcular total de despesas
        const totalExpenses = monthTransactions.reduce((sum, t) => sum + Number(t.amount), 0);
        monthlyData.push(totalExpenses);
      }
      
      datasets = [
        {
          label: 'Despesas Mensais',
          data: monthlyData,
          borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
          backgroundColor: 'rgba(10, 132, 255, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true
        }
      ];
      
      break;
      
    case 'yearly':
      // Análise anual
      chartType = 'bar';
      indexAxis = 'x';
      
      // Obter ano atual
      const currentYearForYearly = new Date().getFullYear();
      const yearlyData = [];
      
      // Considerar os últimos 3 anos
      for (let i = 2; i >= 0; i--) {
        const year = currentYearForYearly - i;
        labels.push(year.toString());
        
        // Filtrar transações para este ano
        const yearTransactions = filterTransactions({
          year: year,
          type: 'expense'
        });
        
        // Calcular total de despesas
        const totalExpenses = yearTransactions.reduce((sum, t) => sum + Number(t.amount), 0);
        yearlyData.push(totalExpenses);
      }
      
      datasets = [
        {
          label: 'Despesas Anuais',
          data: yearlyData,
          backgroundColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
          borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 50
        }
      ];
      
      break;
  }
  
  // Atualizar tipo e configurações do gráfico
  analysisChart.config.type = chartType;
  analysisChart.options.indexAxis = indexAxis;
  
  // Atualizar dados do gráfico
  analysisChart.data.labels = labels;
  analysisChart.data.datasets = datasets;
  
  // Atualizar opções comuns
  analysisChart.options = { 
    ...getChartCommonOptions(),
    indexAxis: indexAxis
  };
  
  analysisChart.update();
}

// Gráficos da análise mensal
let monthlyCategoryChart;
let monthlyDailyChart;

// Inicializar gráficos da análise mensal
function initMonthlyAnalysisCharts() {
  // Gráfico de categorias do mês
  const categoryCtx = document.getElementById('monthly-category-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  monthlyCategoryChart = new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [
        {
          data: [],
          backgroundColor: [],
          borderColor: getComputedStyle(root).getPropertyValue('--card-bg').trim(),
          borderWidth: 2,
          borderRadius: 4,
          hoverOffset: 6
        }
      ]
    },
    options: {
      ...commonOptions,
      cutout: '65%',
      plugins: {
        ...commonOptions.plugins,
        tooltip: {
          ...commonOptions.plugins.tooltip,
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
              const percentage = Math.round((value / total) * 100);
              return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
  
  // Gráfico de distribuição diária
  const dailyCtx = document.getElementById('monthly-daily-chart').getContext('2d');
  
  monthlyDailyChart = new Chart(dailyCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Receitas',
          data: [],
          backgroundColor: getComputedStyle(root).getPropertyValue('--success').trim(),
          borderColor: getComputedStyle(root).getPropertyValue('--success').trim(),
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 20
        },
        {
          label: 'Despesas',
          data: [],
          backgroundColor: getComputedStyle(root).getPropertyValue('--danger').trim(),
          borderColor: getComputedStyle(root).getPropertyValue('--danger').trim(),
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 20
        }
      ]
    },
    options: {
      ...commonOptions,
      scales: {
        ...commonOptions.scales
      }
    }
  });
}

// Atualizar gráficos da análise mensal
function updateMonthlyAnalysisCharts() {
  if (!monthlyCategoryChart || !monthlyDailyChart) return;
  
  // Obter o mês/ano selecionado
  const yearSelect = document.getElementById('monthly-analysis-year');
  const monthSelect = document.getElementById('monthly-analysis-month');
  
  const selectedYear = parseInt(yearSelect.value);
  const selectedMonth = parseInt(monthSelect.value);
  
  // Filtrar transações para o mês/ano selecionado
  const monthTransactions = filterTransactions({
    year: selectedYear,
    month: selectedMonth
  });
  
  // Atualizar gráfico de categorias
  
  // Obter despesas por categoria
  const expensesByCategory = getExpensesByCategory(monthTransactions);
  
  // Preparar dados para o gráfico
  const categoryLabels = [];
  const categoryData = [];
  const backgroundColors = [];
  
  // Ordenar categorias por valor (maior para menor)
  const sortedCategories = Object.entries(expensesByCategory)
    .filter(([categoryId, amount]) => amount > 0)
    .sort((a, b) => b[1] - a[1]);
  
  // Adicionar dados ordenados (limitado às 5 maiores categorias)
  const topCategories = sortedCategories.slice(0, 5);
  
  // Se houver mais de 5 categorias, adicionar "Outras" com o somatório
  if (sortedCategories.length > 5) {
    const otherSum = sortedCategories.slice(5).reduce((sum, [,amount]) => sum + amount, 0);
    
    topCategories.forEach(([categoryId, amount]) => {
      const category = categories.find(c => c.id === categoryId);
      if (category) {
        categoryLabels.push(category.name);
        categoryData.push(amount);
        backgroundColors.push(category.color);
      }
    });
    
    if (otherSum > 0) {
      categoryLabels.push('Outras');
      categoryData.push(otherSum);
      backgroundColors.push('#86868B');
    }
  } else {
    // Se houver 5 ou menos categorias, mostrar todas
    sortedCategories.forEach(([categoryId, amount]) => {
      const category = categories.find(c => c.id === categoryId);
      if (category) {
        categoryLabels.push(category.name);
        categoryData.push(amount);
        backgroundColors.push(category.color);
      }
    });
  }
  
  // Atualizar dados do gráfico
  monthlyCategoryChart.data.labels = categoryLabels;
  monthlyCategoryChart.data.datasets[0].data = categoryData;
  monthlyCategoryChart.data.datasets[0].backgroundColor = backgroundColors;
  
  // Atualizar cor da borda com base no tema
  monthlyCategoryChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--card-bg').trim();
  
  // Atualizar opções comuns
  monthlyCategoryChart.options = { 
    ...getChartCommonOptions(),
    cutout: '65%',
    plugins: {
      ...getChartCommonOptions().plugins,
      tooltip: {
        ...getChartCommonOptions().plugins.tooltip,
        callbacks: {
          label: function(context) {
            const value = context.parsed;
            const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
            constTentar novamenteClaude atingiu o limite máximo de caracteres para uma mensagem e pausou sua resposta. Você pode escrever Continue para prosseguir com a conversa. Claude ainda não tem a capacidade de executar o código que gera.WJContinuarEditarContinuando com o código da aplicação:
<artifact identifier="finance-dashboard-firebase" title="Dashboard de Controle Financeiro Familiar com Firebase" type="text/html">
                const percentage = Math.round((value / total) * 100);
                return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
              }
            }
          }
        }
      };
  monthlyCategoryChart.update();
  
  // Atualizar gráfico de distribuição diária
  
  // Determinar o número de dias no mês
  const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
  
  // Preparar arrays para os dados diários
  const dailyLabels = [];
  const dailyIncomeData = Array(daysInMonth).fill(0);
  const dailyExpenseData = Array(daysInMonth).fill(0);
  
  // Preencher labels de dias
  for (let day = 1; day <= daysInMonth; day++) {
    dailyLabels.push(day);
  }
  
  // Preencher dados de receitas e despesas por dia
  monthTransactions.forEach(transaction => {
    const date = new Date(transaction.date);
    const day = date.getDate();
    
    // Verificar se a transação é deste mês/ano
    if (date.getMonth() === selectedMonth && date.getFullYear() === selectedYear) {
      // O índice do array é day - 1 porque os dias começam do 1, mas os arrays começam do 0
      if (transaction.type === 'income') {
        dailyIncomeData[day - 1] += Number(transaction.amount);
      } else {
        dailyExpenseData[day - 1] += Number(transaction.amount);
      }
    }
  });
  
  // Atualizar dados do gráfico
  monthlyDailyChart.data.labels = dailyLabels;
  monthlyDailyChart.data.datasets[0].data = dailyIncomeData;
  monthlyDailyChart.data.datasets[1].data = dailyExpenseData;
  
  // Atualizar cores com base no tema
  monthlyDailyChart.data.datasets[0].backgroundColor = getComputedStyle(root).getPropertyValue('--success').trim();
  monthlyDailyChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--success').trim();
  monthlyDailyChart.data.datasets[1].backgroundColor = getComputedStyle(root).getPropertyValue('--danger').trim();
  monthlyDailyChart.data.datasets[1].borderColor = getComputedStyle(root).getPropertyValue('--danger').trim();
  
  // Atualizar opções comuns
  monthlyDailyChart.options = { ...getChartCommonOptions() };
  
  monthlyDailyChart.update();
}

// Inicializar todos os gráficos
async function initCharts() {
  try {
    initIncomeExpenseChart();
    initCategoryChart();
    initCashFlowChart();
    initFixedVariableChart();
    initTrendChart();
    await initBudgetChart();
    initSavingsProjectionChart();
    initAnalysisChart();
    initMonthlyAnalysisCharts();
  } catch (error) {
    console.error('Erro ao inicializar gráficos:', error);
    showAlert('Alguns gráficos não puderam ser inicializados. Tente recarregar a página.', 'warning');
  }
}

// Atualizar todos os gráficos
async function updateCharts() {
  try {
    updateIncomeExpenseChart();
    updateCategoryChart();
    updateCashFlowChart();
    updateFixedVariableChart();
    updateTrendChart();
    await updateBudgetChart();
    updateSavingsProjectionChart();
    updateAnalysisChart();
    
    if (currentTab === 'monthly') {
      updateMonthlyAnalysisCharts();
    }
  } catch (error) {
    console.error('Erro ao atualizar gráficos:', error);
  }
}

// ===== Interface e Interação =====

// Inicializar navegação por tabs
function initTabs() {
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remover classe active de todas as tabs
      tabs.forEach(t => t.classList.remove('active'));
      
      // Adicionar classe active à tab clicada
      tab.classList.add('active');
      
      // Obter id da tab
      const tabId = tab.dataset.tab;
      currentTab = tabId;
      
      // Esconder todos os conteúdos de tab
      tabContents.forEach(content => {
        content.style.display = 'none';
      });
      
      // Mostrar conteúdo da tab selecionada
      document.getElementById(`tab-${tabId}`).style.display = 'block';
      
      // Atualizar conteúdo específico da tab
      switch (tabId) {
        case 'transactions':
          updateTransactionsTable();
          break;
        case 'budget':
          updateBudgetTab();
          break;
        case 'goals':
          updateGoalsTab();
          break;
        case 'monthly':
          updateMonthlyAnalysis();
          break;
        case 'categories':
          updateCategoriesTab();
          break;
        case 'reports':
          updateReportsTab();
          break;
      }
    });
  });
}

// Atualizar KPIs do dashboard
function updateKPIs() {
  // Obter ano e mês selecionados
  const yearSelect = document.getElementById('filter-year');
  const monthSelect = document.getElementById('filter-month');
  
  const selectedYear = yearSelect.value;
  const selectedMonth = monthSelect.value;
  
  // Filtrar transações com base nos filtros selecionados
  const filteredTransactions = filterTransactions({
    year: selectedYear === 'all' ? null : selectedYear,
    month: selectedMonth === 'all' ? null : selectedMonth
  });
  
  // Obter resumo financeiro
  const summary = getFinanceSummary(filteredTransactions);
  
  // Atualizar valores dos KPIs
  document.getElementById('kpi-balance').textContent = formatCurrency(summary.balance);
  document.getElementById('kpi-income').textContent = formatCurrency(summary.income);
  document.getElementById('kpi-expenses').textContent = formatCurrency(summary.expenses);
  
  // Calcular economia (receitas - despesas)
  const savings = summary.balance;
  document.getElementById('kpi-savings').textContent = formatCurrency(savings);
  
  // Atualizar barra de progresso de economia
  const savingsGoalEl = document.getElementById('savings-goal');
  const savingsGoal = 1000; // Valor fixo para simplificar
  savingsGoalEl.textContent = formatNumber(savingsGoal, 2);
  
  const savingsProgress = document.getElementById('savings-progress');
  const savingsPercentage = Math.min(100, Math.max(0, (savings / savingsGoal) * 100));
  savingsProgress.style.width = `${savingsPercentage}%`;
  
  // Ajustar cor da barra de progresso com base no percentual
  if (savingsPercentage >= 75) {
    savingsProgress.className = 'progress-bar success';
  } else if (savingsPercentage >= 40) {
    savingsProgress.className = 'progress-bar warning';
  } else {
    savingsProgress.className = 'progress-bar danger';
  }
  
  // Atualizar projeção de gastos (despesas atuais + pendentes)
  const projection = summary.expenses + summary.pendingExpenses;
  document.getElementById('kpi-projection').textContent = formatCurrency(projection);
  
  // Verificar se a projeção está dentro do orçamento
  // Somar todos os orçamentos definidos para o mês atual
  let totalBudget = 0;
  
  // Verificar se estamos filtrando para um mês específico
  if (selectedMonth !== 'all') {
    // Buscar orçamento para o mês/ano selecionado
    const budget = budgets.find(b => 
      b.month === parseInt(selectedMonth) && 
      b.year === parseInt(selectedYear)
    );
    
    if (budget) {
      // Somar todos os valores de orçamento
      totalBudget = budget.categories.reduce(
        (sum, cat) => sum + Number(cat.amount), 
        0
      );
    }
  }
  
  const projectionStatus = document.getElementById('projection-status');
  
  if (totalBudget === 0) {
    // Se não houver orçamento definido
    projectionStatus.className = 'kpi-trend';
    projectionStatus.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>Sem orçamento definido</span>
    `;
  } else if (projection <= totalBudget * 0.8) {
    projectionStatus.className = 'kpi-trend up';
    projectionStatus.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      <span>No orçamento</span>
    `;
  } else if (projection <= totalBudget) {
    projectionStatus.className = 'kpi-trend';
    projectionStatus.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>Próximo do limite</span>
    `;
  } else {
    projectionStatus.className = 'kpi-trend down';
    projectionStatus.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>Acima do orçamento</span>
    `;
  }
  
  // Atualizar tendências
  // Para simplificar, usamos o mês anterior como comparação
  // mesmo quando filtros diferentes são selecionados
  
  // Obter dados do mês anterior para comparação
  const today = new Date();
  const lastMonthIndex = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
  const lastMonthYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
  
  const lastMonthTransactions = filterTransactions({
    year: lastMonthYear,
    month: lastMonthIndex
  });
  
  const lastMonthSummary = getFinanceSummary(lastMonthTransactions);
  
  // Obter dados do mês atual
  const currentMonthTransactions = filterTransactions({
    year: today.getFullYear(),
    month: today.getMonth()
  });
  
  const currentMonthSummary = getFinanceSummary(currentMonthTransactions);
  
  // Calcular variação percentual
  const balanceVariation = lastMonthSummary.balance !== 0 
    ? ((currentMonthSummary.balance - lastMonthSummary.balance) / Math.abs(lastMonthSummary.balance)) * 100 
    : 100;
  
  const incomeVariation = lastMonthSummary.income !== 0 
    ? ((currentMonthSummary.income - lastMonthSummary.income) / lastMonthSummary.income) * 100 
    : 100;
  
  const expensesVariation = lastMonthSummary.expenses !== 0 
    ? ((currentMonthSummary.expenses - lastMonthSummary.expenses) / lastMonthSummary.expenses) * 100 
    : 100;
  
  // Atualizar elementos HTML
  const balanceTrend = document.getElementById('balance-trend');
  const incomeTrend = document.getElementById('income-trend');
  const expensesTrend = document.getElementById('expenses-trend');
  
  // Formatar e definir classes com base na variação
  balanceTrend.textContent = formatNumber(balanceVariation) + '%';
  balanceTrend.parentElement.className = balanceVariation >= 0 ? 'kpi-trend up' : 'kpi-trend down';
  
  incomeTrend.textContent = formatNumber(incomeVariation) + '%';
  incomeTrend.parentElement.className = incomeVariation >= 0 ? 'kpi-trend up' : 'kpi-trend down';
  
  expensesTrend.textContent = formatNumber(expensesVariation) + '%';
  expensesTrend.parentElement.className = expensesVariation <= 0 ? 'kpi-trend up' : 'kpi-trend down';
}

// Atualizar transações recentes
function updateRecentTransactions() {
  const recentTransactionsContainer = document.getElementById('recent-transactions');
  
  // Limpar conteúdo
  recentTransactionsContainer.innerHTML = '';
  
  // Obter transações recentes (últimas 5)
  const recentTransactions = [...transactions]
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 5);
  
  // Verificar se há transações
  if (recentTransactions.length === 0) {
    recentTransactionsContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma transação encontrada. Adicione sua primeira transação!
      </div>
    `;
    return;
  }
  
  // Adicionar cada transação ao container
  recentTransactions.forEach(transaction => {
    // Encontrar categoria
    const category = categories.find(c => c.id === transaction.category) || 
      { name: 'Categoria', color: '#999', icon: '📋' };
    
    // Criar elemento de transação
    const transactionElement = document.createElement('div');
    transactionElement.className = 'flow-item';
    transactionElement.innerHTML = `
      <div class="flow-item-left">
        <div class="flow-item-icon ${transaction.type}" style="background-color: ${category.color};">
          ${category.icon}
        </div>
        <div class="flow-item-info">
          <div class="flow-item-title">${transaction.description}</div>
          <div class="flow-item-meta">${formatDate(transaction.date)} · ${category.name}</div>
        </div>
      </div>
      <div class="flow-item-amount ${transaction.type}">
        ${transaction.type === 'income' ? '+' : '-'} ${formatCurrency(transaction.amount)}
      </div>
    `;
    
    // Adicionar evento de clique para ver detalhes
    transactionElement.addEventListener('click', () => {
      showTransactionDetails(transaction.id);
    });
    
    recentTransactionsContainer.appendChild(transactionElement);
  });
}

// Variáveis para paginação
let currentPage = 1;
const itemsPerPage = 10;
let filteredTransactionsList = [];

// Atualizar tabela de transações
function updateTransactionsTable() {
  // Obter elementos
  const tableBody = document.getElementById('transactions-table-body');
  const showingText = document.getElementById('transactions-showing');
  const prevButton = document.getElementById('transactions-prev');
  const nextButton = document.getElementById('transactions-next');
  
  // Obter filtros
  const yearFilter = document.getElementById('transactions-filter-year').value;
  const monthFilter = document.getElementById('transactions-filter-month').value;
  const typeFilter = document.getElementById('transactions-filter-type').value;
  const categoryFilter = document.getElementById('transactions-filter-category').value;
  const statusFilter = document.getElementById('transactions-filter-status').value;
  const searchText = document.getElementById('transactions-search').value;
  
  // Aplicar filtros
  filteredTransactionsList = filterTransactions({
    year: yearFilter !== 'all' ? yearFilter : null,
    month: monthFilter !== 'all' ? monthFilter : null,
    type: typeFilter !== 'all' ? typeFilter : null,
    category: categoryFilter !== 'all' ? categoryFilter : null,
    status: statusFilter !== 'all' ? statusFilter : null,
    search: searchText
  });
  
  // Calcular número total de páginas
  const totalPages = Math.ceil(filteredTransactionsList.length / itemsPerPage);
  
  // Ajustar página atual se necessário
  if (currentPage > totalPages) {
    currentPage = totalPages > 0 ? totalPages : 1;
  }
  
  // Calcular índices para a página atual
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, filteredTransactionsList.length);
  
  // Obter transações para a página atual
  const pageTransactions = filteredTransactionsList.slice(startIndex, endIndex);
  
  // Atualizar texto de informação
  showingText.textContent = `Mostrando ${filteredTransactionsList.length > 0 ? startIndex + 1 : 0}-${endIndex} de ${filteredTransactionsList.length} transações`;
  
  // Habilitar/desabilitar botões de navegação
  prevButton.disabled = currentPage <= 1;
  nextButton.disabled = currentPage >= totalPages;
  
  // Limpar tabela
  tableBody.innerHTML = '';
  
  // Verificar se há transações
  if (pageTransactions.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `
      <td colspan="6" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma transação encontrada com os filtros atuais.
      </td>
    `;
    tableBody.appendChild(emptyRow);
    return;
  }
  
  // Adicionar transações à tabela
  pageTransactions.forEach(transaction => {
    const row = document.createElement('tr');
    
    // Encontrar categoria
    const category = categories.find(c => c.id === transaction.category) || 
      { name: 'Categoria Desconhecida', color: '#999', icon: '📋' };
    
    // Status da transação
    const status = TRANSACTION_STATUS[transaction.status] || { name: 'Desconhecido', class: '' };
    
    // Formatação de valor com cor
    const amountColor = transaction.type === 'income' ? 'var(--success)' : 'var(--danger)';
    const amountPrefix = transaction.type === 'income' ? '+' : '-';
    
    row.innerHTML = `
      <td>${formatDate(transaction.date)}</td>
      <td>${transaction.description}</td>
      <td>
        <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
          <span style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${category.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">${category.icon}</span>
          ${category.name}
        </span>
      </td>
      <td style="color: ${amountColor}; font-weight: 600;">${amountPrefix} ${formatCurrency(transaction.amount)}</td>
      <td><span class="status ${status.class}">${status.name}</span></td>
      <td>
        <div class="table-actions">
          <button class="table-action-btn btn-view" title="Ver Detalhes">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          </button>
          <button class="table-action-btn btn-edit" title="Editar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <button class="table-action-btn btn-delete" title="Excluir">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </td>
    `;
    
    // Adicionar eventos aos botões
    row.querySelector('.btn-view').addEventListener('click', () => {
      showTransactionDetails(transaction.id);
    });
    
    row.querySelector('.btn-edit').addEventListener('click', () => {
      openTransactionModal(transaction);
    });
    
    row.querySelector('.btn-delete').addEventListener('click', () => {
      confirmDeleteTransaction(transaction.id);
    });
    
    tableBody.appendChild(row);
  });
  
  // Configurar eventos de paginação
  prevButton.onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      updateTransactionsTable();
    }
  };
  
  nextButton.onclick = () => {
    if (currentPage < totalPages) {
      currentPage++;
      updateTransactionsTable();
    }
  };
}

// Atualizar aba de orçamento
async function updateBudgetTab() {
  try {
    // Atualizar gráfico de orçamento
    await updateBudgetChart();
    
    // Atualizar tabela de progresso do orçamento
    await updateBudgetProgress();
  } catch (error) {
    console.error('Erro ao atualizar aba de orçamento:', error);
    showAlert('Erro ao atualizar informações de orçamento.', 'danger');
  }
}

// Atualizar progresso do orçamento
async function updateBudgetProgress() {
  try {
    const progressContainer = document.getElementById('budget-progress-container');
    const budgetTableBody = document.getElementById('budget-table-body');
    
    // Limpar containers
    progressContainer.innerHTML = '';
    budgetTableBody.innerHTML = '';
    
    // Obter orçamento atual
    const budget = await getCurrentBudget();
    
    // Verificar se há categorias com orçamento
    const hasBudget = budget && budget.categories && budget.categories.some(bc => bc.amount > 0);
    
    if (!hasBudget) {
      progressContainer.innerHTML = `
        <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
          Nenhum orçamento definido. Clique em "Editar Orçamento" para configurar.
        </div>
      `;
      
      budgetTableBody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Nenhum orçamento definido.
          </td>
        </tr>
      `;
      return;
    }
    
    // Obter despesas atuais por categoria
    const expensesByCategory = getCurrentExpensesByCategory();
    
    // Adicionar barra de progresso para cada categoria com orçamento
    budget.categories.forEach(budgetCategory => {
      if (budgetCategory.amount > 0) {
        const category = categories.find(c => c.id === budgetCategory.id);
        if (!category) return;
        
        const spent = expensesByCategory[budgetCategory.id] || 0;
        const budgetAmount = budgetCategory.amount;
        const remaining = budgetAmount - spent;
        const percentage = Math.min(100, Math.max(0, (spent / budgetAmount) * 100));
        
        // Determinar cor com base no percentual gasto
        let statusClass = 'success';
        if (percentage >= 90) {
          statusClass = 'danger';
        } else if (percentage >= 75) {
          statusClass = 'warning';
        }
        
        // Criar elemento de progresso
        const progressElement = document.createElement('div');
        progressElement.style.marginBottom = '1.25rem';
        progressElement.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${category.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">${category.icon}</div>
              <span>${category.name}</span>
            </div>
            <div>
              <span style="font-weight: 600;">${formatCurrency(spent)}</span> de 
              <span>${formatCurrency(budgetAmount)}</span>
              <span style="margin-left: 0.5rem; color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'};">
                (${remaining >= 0 ? `Restam ${formatCurrency(remaining)}` : `Excedido em ${formatCurrency(Math.abs(remaining))}`})
              </span>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-bar ${statusClass}" style="width: ${percentage}%"></div>
          </div>
        `;
        
        progressContainer.appendChild(progressElement);
        
        // Adicionar linha na tabela
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${category.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">${category.icon}</div>
              ${category.name}
            </div>
          </td>
          <td>${formatCurrency(budgetAmount)}</td>
          <td>${formatCurrency(spent)}</td>
          <td style="color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'};">
            ${remaining >= 0 ? formatCurrency(remaining) : `- ${formatCurrency(Math.abs(remaining))}`}
          </td>
          <td>
            <div class="progress-container" style="margin: 0;">
              <div class="progress-bar ${statusClass}" style="width: ${percentage}%"></div>
            </div>
          </td>
        `;
        
        budgetTableBody.appendChild(row);
      }
    });
  } catch (error) {
    console.error('Erro ao atualizar progresso do orçamento:', error);
    showAlert('Erro ao atualizar progresso do orçamento.', 'danger');
  }
}

// Atualizar aba de metas
function updateGoalsTab() {
  const goalsContainer = document.getElementById('goals-container');
  goalsContainer.innerHTML = '';
  
  // Verificar se há metas
  if (goals.length === 0) {
    goalsContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma meta encontrada. Adicione sua primeira meta!
      </div>
    `;
    return;
  }
  
  // Ordenar metas por data alvo (mais próximas primeiro)
  const sortedGoals = [...goals].sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate));
  
  // Adicionar cada meta ao container
  sortedGoals.forEach(goal => {
    // Calcular progresso
    const progress = calculateGoalProgress(goal);
    
    // Determinar cor com base no progresso
    let statusClass = 'success';
    if (progress.progress < 30) {
      statusClass = 'danger';
    } elseTentar novamenteClaude atingiu o limite máximo de caracteres para uma mensagem e pausou sua resposta. Você pode escrever Continue para prosseguir com a conversa. Claude ainda não tem a capacidade de executar o código que gera.WJContinuarEditarContinuando com o código da aplicação:
<artifact identifier="finance-dashboard-firebase" title="Dashboard de Controle Financeiro Familiar com Firebase" type="text/html">
        if (progress.progress < 30) {
          statusClass = 'danger';
        } else if (progress.progress < 60) {
          statusClass = 'warning';
        }
    // Criar elemento de meta
    const goalElement = document.createElement('div');
    goalElement.className = 'card';
    goalElement.style.marginBottom = '1rem';
    
    goalElement.innerHTML = `
      <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
        <div>
          <h3 style="margin: 0; font-size: 1.25rem;">${goal.name}</h3>
          <div style="color: var(--text-secondary); font-size: 0.875rem;">
            Data alvo: ${formatDate(goal.targetDate)} (${progress.daysRemaining} dias restantes)
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 1.25rem; font-weight: 600;">
            ${formatCurrency(goal.currentAmount)} / ${formatCurrency(goal.targetAmount)}
          </div>
          <div style="color: var(--text-secondary); font-size: 0.875rem;">
            Faltam: ${formatCurrency(progress.remainingAmount)}
          </div>
        </div>
      </div>
      
      <div class="progress-container">
        <div class="progress-bar ${statusClass}" style="width: ${progress.progress}%"></div>
      </div>
      
      <div style="display: flex; justify-content: space-between; margin-top: 0.75rem; color: var(--text-secondary); font-size: 0.875rem;">
        <div>${progress.progress.toFixed(1)}% concluído</div>
        <div>Economia necessária: ${formatCurrency(progress.monthlySavingsNeeded)}/mês</div>
      </div>
      
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
        <button class="btn btn-edit-goal" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Editar
        </button>
        <button class="btn btn-update-goal" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 9l-7 7-7-7"></path>
          </svg>
          Atualizar Saldo
        </button>
        <button class="btn btn-danger btn-delete-goal" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Excluir
        </button>
      </div>
    `;
    
    // Adicionar eventos aos botões
    goalElement.querySelector('.btn-edit-goal').addEventListener('click', () => {
      openGoalModal(goal);
    });
    
    goalElement.querySelector('.btn-update-goal').addEventListener('click', () => {
      openUpdateGoalBalanceModal(goal);
    });
    
    goalElement.querySelector('.btn-delete-goal').addEventListener('click', () => {
      confirmDeleteGoal(goal.id);
    });
    
    goalsContainer.appendChild(goalElement);
  });
  
  // Atualizar gráfico de projeção de economia
  updateSavingsProjectionChart();
}

// Atualizar aba da análise mensal
function updateMonthlyAnalysis() {
  try {
    // Obter o ano e mês selecionados
    const yearSelect = document.getElementById('monthly-analysis-year');
    const monthSelect = document.getElementById('monthly-analysis-month');
    
    const selectedYear = parseInt(yearSelect.value);
    const selectedMonth = parseInt(monthSelect.value);
    
    // Obter transações para o mês/ano selecionado
    const monthTransactions = filterTransactions({
      year: selectedYear,
      month: selectedMonth
    });
    
    // Calcular totais
    const income = monthTransactions
      .filter(t => t.type === 'income')
      .reduce((sum, t) => sum + Number(t.amount), 0);
    
    const incomeCount = monthTransactions.filter(t => t.type === 'income').length;
    
    const expenses = monthTransactions
      .filter(t => t.type === 'expense')
      .reduce((sum, t) => sum + Number(t.amount), 0);
    
    const expenseCount = monthTransactions.filter(t => t.type === 'expense').length;
    
    const balance = income - expenses;
    
    // Atualizar valores na interface
    document.getElementById('monthly-income').textContent = formatCurrency(income);
    document.getElementById('monthly-income-count').textContent = `${incomeCount} transações`;
    
    document.getElementById('monthly-expense').textContent = formatCurrency(expenses);
    document.getElementById('monthly-expense-count').textContent = `${expenseCount} transações`;
    
    document.getElementById('monthly-balance').textContent = formatCurrency(balance);
    
    // Atualizar status do saldo
    const balanceStatus = document.getElementById('monthly-balance-status');
    
    if (balance > 0) {
      document.getElementById('monthly-balance').style.color = 'var(--success)';
      balanceStatus.textContent = 'Saldo positivo';
      balanceStatus.style.color = 'var(--success)';
    } else if (balance < 0) {
      document.getElementById('monthly-balance').style.color = 'var(--danger)';
      balanceStatus.textContent = 'Saldo negativo';
      balanceStatus.style.color = 'var(--danger)';
    } else {
      document.getElementById('monthly-balance').style.color = 'var(--text)';
      balanceStatus.textContent = 'Balanço neutro';
      balanceStatus.style.color = 'var(--text-secondary)';
    }
    
    // Atualizar gráficos
    updateMonthlyAnalysisCharts();
    
    // Atualizar listas de transações
    updateMonthlyTransactionLists(monthTransactions);
    
  } catch (error) {
    console.error('Erro ao atualizar análise mensal:', error);
    showAlert('Erro ao atualizar análise mensal.', 'danger');
  }
}

// Atualizar listas de transações da análise mensal
function updateMonthlyTransactionLists(monthTransactions) {
  // Obter containers
  const incomeList = document.getElementById('monthly-income-list');
  const expenseList = document.getElementById('monthly-expense-list');
  
  // Limpar listas
  incomeList.innerHTML = '';
  expenseList.innerHTML = '';
  
  // Separar transações por tipo
  const incomeTransactions = monthTransactions.filter(t => t.type === 'income');
  const expenseTransactions = monthTransactions.filter(t => t.type === 'expense');
  
  // Ordenar por data (mais recente primeiro)
  incomeTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
  expenseTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Verificar se há receitas
  if (incomeTransactions.length === 0) {
    incomeList.innerHTML = `
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma receita encontrada neste mês. Adicione sua primeira receita!
      </div>
    `;
  } else {
    // Adicionar cada receita à lista
    incomeTransactions.forEach(transaction => {
      // Encontrar categoria
      const category = categories.find(c => c.id === transaction.category) || 
        { name: 'Categoria', color: '#999', icon: '📋' };
      
      const transactionItem = document.createElement('div');
      transactionItem.className = 'month-transaction';
      transactionItem.innerHTML = `
        <div class="month-transaction-left">
          <div class="month-transaction-icon" style="background-color: ${category.color};">
            ${category.icon}
          </div>
          <div class="month-transaction-info">
            <div class="month-transaction-title">${transaction.description}</div>
            <div class="month-transaction-date">${formatDate(transaction.date)}</div>
          </div>
        </div>
        <div class="month-transaction-amount" style="color: var(--success);">
          ${formatCurrency(transaction.amount)}
        </div>
      `;
      
      // Adicionar evento de clique para ver detalhes
      transactionItem.addEventListener('click', () => {
        showTransactionDetails(transaction.id);
      });
      
      incomeList.appendChild(transactionItem);
    });
  }
  
  // Verificar se há despesas
  if (expenseTransactions.length === 0) {
    expenseList.innerHTML = `
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma despesa encontrada neste mês. Adicione sua primeira despesa!
      </div>
    `;
  } else {
    // Adicionar cada despesa à lista
    expenseTransactions.forEach(transaction => {
      // Encontrar categoria
      const category = categories.find(c => c.id === transaction.category) || 
        { name: 'Categoria', color: '#999', icon: '📋' };
      
      const transactionItem = document.createElement('div');
      transactionItem.className = 'month-transaction';
      transactionItem.innerHTML = `
        <div class="month-transaction-left">
          <div class="month-transaction-icon" style="background-color: ${category.color};">
            ${category.icon}
          </div>
          <div class="month-transaction-info">
            <div class="month-transaction-title">${transaction.description}</div>
            <div class="month-transaction-date">${formatDate(transaction.date)}</div>
          </div>
        </div>
        <div class="month-transaction-amount" style="color: var(--danger);">
          ${formatCurrency(transaction.amount)}
        </div>
      `;
      
      // Adicionar evento de clique para ver detalhes
      transactionItem.addEventListener('click', () => {
        showTransactionDetails(transaction.id);
      });
      
      expenseList.appendChild(transactionItem);
    });
  }
}

// Navegar para o mês anterior
function navigateToPreviousMonth() {
  const yearSelect = document.getElementById('monthly-analysis-year');
  const monthSelect = document.getElementById('monthly-analysis-month');
  
  let selectedYear = parseInt(yearSelect.value);
  let selectedMonth = parseInt(monthSelect.value);
  
  // Ajustar mês e ano
  selectedMonth--;
  if (selectedMonth < 0) {
    selectedMonth = 11;
    selectedYear--;
  }
  
  // Atualizar selects
  yearSelect.value = selectedYear;
  monthSelect.value = selectedMonth;
  
  // Atualizar análise
  updateMonthlyAnalysis();
}

// Navegar para o próximo mês
function navigateToNextMonth() {
  const yearSelect = document.getElementById('monthly-analysis-year');
  const monthSelect = document.getElementById('monthly-analysis-month');
  
  let selectedYear = parseInt(yearSelect.value);
  let selectedMonth = parseInt(monthSelect.value);
  
  // Ajustar mês e ano
  selectedMonth++;
  if (selectedMonth > 11) {
    selectedMonth = 0;
    selectedYear++;
  }
  
  // Atualizar selects
  yearSelect.value = selectedYear;
  monthSelect.value = selectedMonth;
  
  // Atualizar análise
  updateMonthlyAnalysis();
}

// Atualizar aba de categorias
function updateCategoriesTab() {
  const incomeContainer = document.getElementById('income-categories-list');
  const expenseContainer = document.getElementById('expense-categories-list');
  
  // Limpar containers
  incomeContainer.innerHTML = '';
  expenseContainer.innerHTML = '';
  
  // Separar categorias por tipo
  const incomeCategories = categories.filter(c => c.type === 'income');
  const expenseCategories = categories.filter(c => c.type === 'expense');
  
  // Verificar se há categorias de receita
  if (incomeCategories.length === 0) {
    incomeContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma categoria de receita encontrada. Adicione sua primeira categoria!
      </div>
    `;
  } else {
    // Adicionar cada categoria de receita
    incomeCategories.forEach(category => {
      const categoryItem = document.createElement('div');
      categoryItem.className = 'category-item';
      categoryItem.innerHTML = `
        <div class="category-item-color" style="background-color: ${category.color};">
          ${category.icon}
        </div>
        <div class="category-item-info">
          <div>${category.name}</div>
        </div>
        <div class="category-item-actions">
          <button class="table-action-btn btn-edit" title="Editar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <button class="table-action-btn btn-delete" title="Excluir">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;
      
      // Adicionar eventos
      categoryItem.querySelector('.btn-edit').addEventListener('click', () => {
        openCategoryModal(category);
      });
      
      categoryItem.querySelector('.btn-delete').addEventListener('click', () => {
        confirmDeleteCategory(category.id);
      });
      
      incomeContainer.appendChild(categoryItem);
    });
  }
  
  // Verificar se há categorias de despesa
  if (expenseCategories.length === 0) {
    expenseContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma categoria de despesa encontrada. Adicione sua primeira categoria!
      </div>
    `;
  } else {
    // Adicionar cada categoria de despesa
    expenseCategories.forEach(category => {
      const categoryItem = document.createElement('div');
      categoryItem.className = 'category-item';
      categoryItem.innerHTML = `
        <div class="category-item-color" style="background-color: ${category.color};">
          ${category.icon}
        </div>
        <div class="category-item-info">
          <div>${category.name}</div>
        </div>
        <div class="category-item-actions">
          <button class="table-action-btn btn-edit" title="Editar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <button class="table-action-btn btn-delete" title="Excluir">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;
      
      // Adicionar eventos
      categoryItem.querySelector('.btn-edit').addEventListener('click', () => {
        openCategoryModal(category);
      });
      
      categoryItem.querySelector('.btn-delete').addEventListener('click', () => {
        confirmDeleteCategory(category.id);
      });
      
      expenseContainer.appendChild(categoryItem);
    });
  }
}

// Atualizar aba de relatórios
function updateReportsTab() {
  // Preencher selects de mês e ano
  const reportMonth = document.getElementById('report-month');
  const reportYear = document.getElementById('report-year');
  
  // Limpar opções existentes
  reportMonth.innerHTML = '';
  reportYear.innerHTML = '';
  
  // Adicionar meses
  const months = [
    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
  ];
  
  const currentMonth = new Date().getMonth();
  
  months.forEach((month, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = month;
    reportMonth.appendChild(option);
  });
  
  // Selecionar mês atual
  reportMonth.value = currentMonth;
  
  // Adicionar anos (ano atual e 2 anos anteriores)
  const currentYear = new Date().getFullYear();
  
  for (let i = 0; i < 5; i++) {
    const year = currentYear - i;
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    reportYear.appendChild(option);
  }
  
  // Selecionar ano atual
  reportYear.value = currentYear;
  
  // Gerar relatório para o mês/ano selecionado
  generateMonthlyReport();
  
  // Atualizar gráfico de análise
  updateAnalysisChart();
  
  // Adicionar eventos para atualização do relatório
  reportMonth.addEventListener('change', generateMonthlyReport);
  reportYear.addEventListener('change', generateMonthlyReport);
  
  // Botão de exportar relatório
  document.getElementById('btn-export-report').addEventListener('click', exportMonthlyReport);
}

// Gerar relatório mensal
function generateMonthlyReport() {
  const monthIndex = parseInt(document.getElementById('report-month').value);
  const year = parseInt(document.getElementById('report-year').value);
  const reportContainer = document.getElementById('monthly-report-container');
  
  // Filtrar transações para o mês/ano selecionado
  const monthTransactions = filterTransactions({
    year: year,
    month: monthIndex
  });
  
  // Verificar se há transações
  if (monthTransactions.length === 0) {
    reportContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
        Nenhuma transação encontrada para o período selecionado.
      </div>
    `;
    return;
  }
  
  // Calcular resumo financeiro
  const income = monthTransactions
    .filter(t => t.type === 'income')
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  const expenses = monthTransactions
    .filter(t => t.type === 'expense')
    .reduce((sum, t) => sum + Number(t.amount), 0);
  
  const balance = income - expenses;
  
  // Agrupar despesas por categoria
  const expensesByCategory = getExpensesByCategory(monthTransactions);
  
  // Ordenar categorias por valor (maior para menor)
  const sortedCategories = Object.entries(expensesByCategory)
    .filter(([categoryId, amount]) => amount > 0)
    .sort((a, b) => b[1] - a[1]);
  
  // Construir relatório
  reportContainer.innerHTML = `
    <div class="card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
      <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem;">Resumo Financeiro - ${months[monthIndex]} ${year}</h3>
      
      <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
        <div style="flex: 1;">
          <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Receitas</div>
          <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">
            ${formatCurrency(income)}
          </div>
        </div>
        <div style="flex: 1;">
          <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Despesas</div>
          <div style="font-size: 1.25rem; font-weight: 600; color: var(--danger);">
            ${formatCurrency(expenses)}
          </div>
        </div>
        <div style="flex: 1;">
          <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Saldo</div>
          <div style="font-size: 1.25rem; font-weight: 600; color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'};">
            ${formatCurrency(balance)}
          </div>
        </div>
      </div>
      
      <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1rem;">Despesas por Categoria</h4>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        ${sortedCategories.map(([categoryId, amount]) => {
          const category = categories.find(c => c.id === categoryId);
          if (!category) return '';
          
          const percentage = (amount / expenses) * 100;
          
          return `
            <div style="background-color: var(--input-bg); padding: 1rem; border-radius: var(--radius-sm);">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${category.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">${category.icon}</span>
                  <span>${category.name}</span>
                </div>
                <div style="font-weight: 600;">${formatCurrency(amount)}</div>
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem; text-align: right;">
                ${percentage.toFixed(1)}% do total
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
    
    <div class="card">
      <div class="chart-title">Distribuição de Despesas</div>
      <div style="height: 250px;">
        <canvas id="report-pie-chart"></canvas>
      </div>
    </div>
  `;
  
  // Inicializar gráfico de pizza para o relatório
  const ctx = document.getElementById('report-pie-chart').getContext('2d');
  const commonOptions = getChartCommonOptions();
  
  // Preparar dados para o gráfico
  const labels = [];
  const data = [];
  const backgroundColors = [];
  
  // Adicionar dados ordenados
  sortedCategories.forEach(([categoryId, amount]) => {
    const category = categories.find(c => c.id === categoryId);
    if (category) {
      labels.push(category.name);
      data.push(amount);
      backgroundColors.push(category.color);
    }
  });
  
  // Criar gráfico
  const reportPieChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [
        {
          data: data,
          backgroundColor: backgroundColors,
          borderColor: getComputedStyle(root).getPropertyValue('--card-bg').trim(),
          borderWidth: 2,
          borderRadius: 4,
          hoverOffset: 6
        }
      ]
    },
    options: {
      ...commonOptions,
      plugins: {
        ...commonOptions.plugins,
        tooltip: {
          ...commonOptions.plugins.tooltip,
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
              const percentage = Math.round((value / total) * 100);
              return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

// Exportar relatório mensal (simulação)
function exportMonthlyReport() {
  const monthIndex = parseInt(document.getElementById('report-month').value);
  const year = parseInt(document.getElementById('report-year').value);
  
  const months = [
    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
  ];
  
  showAlert(`Relatório de ${months[monthIndex]} ${year} exportado com sucesso!`, 'success');
}

// Atualizar dashboard
function updateDashboard() {
  updateKPIs();
  updateCharts();
  updateRecentTransactions();
  
  // Verificar tab atual e atualizar conteúdo específico
  switch (currentTab) {
    case 'transactions':
      updateTransactionsTable();
      break;
    case 'budget':
      updateBudgetTab();
      break;
    case 'goals':
      updateGoalsTab();
      break;
    case 'monthly':
      updateMonthlyAnalysis();
      break;
    case 'categories':
      updateCategoriesTab();
      break;
    case 'reports':
      updateReportsTab();
      break;
  }
}

    // ===== Inicialização da Aplicação =====
    async function init() {
        console.log("App Init: Iniciando...");
        showLoading();
        moment.locale('pt-br');

        // Seleciona elementos DOM principais AQUI DENTRO
        themeToggle = document.getElementById('theme-toggle');
        themeIcon = document.getElementById('theme-icon');
        loading = document.getElementById('loading');
        tabs = document.querySelectorAll('.tab');
        tabContents = document.querySelectorAll('.tab-content');
        transactionModal = document.getElementById('transaction-modal');
        transactionForm = document.getElementById('transaction-form');
        budgetModal = document.getElementById('budget-modal');
        goalModal = document.getElementById('goal-modal');
        categoryModal = document.getElementById('category-modal');
        transactionDetailsModal = document.getElementById('transaction-details-modal');
        confirmModal = document.getElementById('confirm-modal');
        btnNewTransaction = document.getElementById('btn-new-transaction');
        btnEditBudget = document.getElementById('btn-edit-budget');
        btnAddGoal = document.getElementById('btn-add-goal');
        btnAddCategory = document.getElementById('btn-add-category');
        btnAddIncome = document.getElementById('btn-add-income');
        btnAddExpense = document.getElementById('btn-add-expense');

        // Verifica se elementos cruciais existem
        if (!themeToggle || !loading || !tabs.length || !btnNewTransaction) {
             console.error("Erro Crítico: Elementos essenciais da UI não encontrados no DOM!");
             // Tenta mostrar um alerta, mas a função pode não estar disponível se o erro for muito cedo
             try { showAlert("Erro fatal ao carregar interface. Recarregue a página.", "danger", 30000); } catch(e){}
             hideLoading(); // Tenta esconder o loading
             return;
        }
        console.log("App Init: Elementos DOM selecionados.");

        try {
            setupTheme(); // Configura tema inicial
             // Adiciona listener do tema AQUI
             themeToggle.addEventListener('click', () => {
                 const newTheme = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                 root.setAttribute('data-theme', newTheme);
                 localStorage.setItem('theme', newTheme);
                 updateThemeIcon(newTheme);
                 updateCharts();
             });
            console.log("App Init: Tema configurado.");

            await waitForFirebase(); // Espera conexão Firebase
            console.log("App Init: Firebase pronto.");

            // Carrega dados na ordem correta
            categories = await loadCategoriesFromFirestore();
            transactions = await loadTransactionsFromFirestore();
            budgets = await loadBudgetsFromFirestore();
            goals = await loadGoalsFromFirestore();
            console.log("App Init: Dados carregados.");


            populateYearSelects();
            populateMonthSelects();
            console.log("App Init: Selects populados.");

            initFilters(); // Configura listeners dos filtros
            console.log("App Init: Filtros inicializados.");

            initModals(); // Configura listeners dos modais
            console.log("App Init: Modais inicializados.");

            await initCharts(); // Cria instâncias iniciais dos gráficos
            console.log("App Init: Gráficos inicializados.");

            initTabs(); // Configura listeners das tabs E ativa a primeira
            console.log("App Init: Tabs inicializadas.");

            // A chamada a initTabs() já dispara a atualização inicial via clique simulado

            console.log("Aplicação inicializada com sucesso!");

        } catch (error) {
            console.error("Erro crítico durante a inicialização:", error);
            showAlert(`Falha grave ao inicializar: ${error.message}. Recarregue a página.`, "danger", 30000);
        } finally {
            hideLoading(); // Garante que o loading saia
        }
    }

    // Ponto de Entrada: Inicia quando o DOM está pronto
    document.addEventListener('DOMContentLoaded', init);
</script>
