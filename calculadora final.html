<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Familiar Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <style>
    /* ===== Variáveis e Temas (Estilo Apple/Google) ===== */
    :root {
      /* ... (Variáveis inalteradas da versão anterior) ... */
      --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem; /* 12px */
      --radius: 1.125rem; /* 18px */
      --radius-lg: 1.5rem; /* 24px */
      --shadow: 0 4px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.09), 0 2px 6px rgba(0,0,0,0.07);
      --shadow-dropdown: 0 5px 20px rgba(0,0,0,0.12);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

      /* Cores Light */
      --bg: #F9F9FB; /* Slightly off-white */
      --bg-rgb: 249, 249, 251; /* Para usar com opacidade */
      --card-bg: #FFFFFF;
      --input-bg: rgba(118, 118, 128, 0.12); /* System Gray 5 (0.12 alpha) */
      --text: #1C1C1E; /* Almost Black */
      --text-secondary: #8A8A8E; /* System Gray */
      --primary: #007AFF; /* Blue */
      --primary-light: #5856D6; /* Indigo for accents if needed */
      --success: #34C759; /* Green */
      --warning: #FF9500; /* Orange */
      --danger: #FF3B30; /* Red */
      --info: #5AC8FA; /* Teal */
      --border: rgba(60, 60, 67, 0.15); /* Lighter border */
      --chart-grid: rgba(60, 60, 67, 0.08); /* Lighter grid */
      --menu-bg: rgba(255, 255, 255, 0.9); /* More opaque */
      --insight-bg: rgba(0, 122, 255, 0.06); /* Subtler blue */
      --importance-extrema: #FF3B30; /* Red */
      --importance-urgente: #FF9500; /* Orange */
      --importance-importante: #FFCC00; /* Yellow */
      --hover-bg: rgba(0, 0, 0, 0.03); /* Subtle hover */
    }

    [data-theme="dark"] {
      /* Cores Dark */
      --bg: #000000; /* True Black for OLED */
      --bg-rgb: 0, 0, 0; /* Para usar com opacidade */
      --card-bg: #1C1C1E; /* Gray 6 */
      --input-bg: rgba(118, 118, 128, 0.24); /* System Gray 5 (0.24 alpha) */
      --text: #FFFFFF;
      --text-secondary: #8E8E93; /* Gray */
      --primary: #0A84FF; /* Blue */
      --primary-light: #5E5CE6; /* Indigo */
      --success: #30D158; /* Green */
      --warning: #FF9F0A; /* Orange */
      --danger: #FF453A; /* Red */
      --info: #64D2FF; /* Teal */
      --border: rgba(84, 84, 88, 0.35); /* Lighter border */
      --chart-grid: rgba(84, 84, 88, 0.15); /* Lighter grid */
      --menu-bg: rgba(28, 28, 30, 0.9); /* More opaque */
      --insight-bg: rgba(10, 132, 255, 0.12); /* Subtler blue */
      --importance-extrema: #FF453A; /* Red */
      --importance-urgente: #FF9F0A; /* Orange */
      --importance-importante: #FFD60A; /* Yellow */
      --hover-bg: rgba(255, 255, 255, 0.05); /* Subtle hover */
    }

    /* ===== Reset e Configurações Base ===== */
    /* ... (Reset inalterado) ... */
     *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
     html { font-size: 16px; }
     body { font-family: var(--font-sans); background: var(--bg); color: var(--text); transition: background 0.3s ease, color 0.3s ease; line-height: 1.5; width: 100%; overflow-x: hidden;}

    /* ===== Layout e Componentes ===== */
    /* ... (Container, Header, H1, Header-Right - inalterados) ... */
      .container { max-width: 1360px; margin: 0 auto; padding: 2rem; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
      .header-title { display: flex; align-items: center; gap: 0.75rem; }
      h1 { font-size: 1.875rem; font-weight: 700; margin: 0; letter-spacing: -0.03em; }
      .header-right { display: flex; align-items: center; gap: 1rem; }

    /* Tabs */
    /* ... (Tabs, Tab, Tab:hover, Tab.active, Tab-content, Keyframes - inalterados) ... */
    .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 2rem; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;}
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 0.875rem 1.5rem; font-weight: 600; font-size: 0.9375rem; color: var(--text-secondary); cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; transition: var(--transition); margin-bottom: -1px; border-radius: 6px 6px 0 0; }
    .tab:hover { color: var(--text); background-color: var(--hover-bg); }
    .tab.active { color: var(--primary); border-color: var(--primary); background-color: var(--card-bg); }
    [data-theme="dark"] .tab.active { background-color: var(--card-bg); }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* KPIs Card */
    /* ... (KPIs grid, Card, Card:hover, KPI Card structure - inalterados) ... */
      .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
      .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; transition: var(--transition); overflow: hidden; position: relative; }
      .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
      .kpi-card { display: flex; flex-direction: column; gap: 0.5rem; min-height: 150px; } /* Added min-height */
      .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
      .kpi-title { font-size: 0.9375rem; font-weight: 500; color: var(--text-secondary); }
      .kpi-icon { color: var(--text-secondary); opacity: 0.6; flex-shrink: 0; width: 22px; height: 22px; }
      .kpi-icon svg { display: block; width: 100%; height: 100%; }
      .kpi-value { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.02em; line-height: 1.2; margin-top: 0.25rem; }
      .kpi-footer { display: flex; align-items: center; gap: 0.5rem; margin-top: auto; padding-top: 0.75rem; font-size: 0.8125rem; color: var(--text-secondary); }
      .kpi-trend { display: flex; align-items: center; gap: 0.25rem; font-weight: 500; }
      .kpi-trend.up { color: var(--success); }
      .kpi-trend.down { color: var(--danger); }
      .kpi-trend.neutral { color: var(--text-secondary); }
      .kpi-trend svg { width: 14px; height: 14px; /*stroke-width: 2.5;*/ /* Removed stroke-width for fill */ flex-shrink: 0; }
      /* Paths agora usam fill */
      .kpi-trend svg .up-path { fill: currentColor; stroke: none; }
      .kpi-trend svg .down-path { fill: currentColor; stroke: none; }
      .kpi-trend svg .neutral-path { stroke: currentColor; stroke-width: 2.5; fill: none; } /* Mantem stroke pro traço */

     /* ... (Progress container/bar - inalterados) ... */
     .progress-container { width: 100%; height: 6px; background-color: var(--input-bg); border-radius: 3px; overflow: hidden; margin-top: 0.5rem; }
     .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; background-color: var(--primary); }
     .progress-bar.success { background-color: var(--success); } .progress-bar.warning { background-color: var(--warning); } .progress-bar.danger { background-color: var(--danger); }

    /* Gráficos */
    /* ... (Charts grid, container, title, actions, full-width - inalterados) ... */
     .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
     .chart-container { position: relative; margin-top: 1rem; height: 280px; }
     .chart-title { font-size: 1.125rem; font-weight: 600; letter-spacing: -0.01em; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
     .chart-title-actions { display: flex; gap: 0.75rem; }
     .full-width { grid-column: 1 / -1; }
     .full-width .chart-container { height: 320px; }

    /* Análise Mensal - Filtros Atualizados */
    .analysis-header {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem 1.5rem;
        align-items: flex-end;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem 1.5rem;
        align-items: flex-end;
    }
    .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .filter-group label { font-size: 0.8125rem; color: var(--text-secondary); font-weight: 500; padding-left: 0.25rem; }
    .category-filter-group { display: flex; gap: 0.5rem; align-items: center; }
    .category-filter-group select { min-width: 200px; }
    .btn-icon-small { padding: 0.5rem; min-width: auto; height: calc(1.5em + 1.5rem + 2px); background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
    .btn-icon-small:hover { background-color: var(--hover-bg); border-color: rgba(60, 60, 67, 0.4); }
    .btn-icon-small svg { width: 1rem; height: 1rem; flex-shrink: 0; }
    .btn-delete-category { color: var(--danger); }
    .btn-delete-category:hover { background-color: rgba(255, 59, 48, 0.1); }

     /* ... (Analysis Indicators, Content, Main, Sidebar, Insights Feed/Title/List/Item - inalterados) ... */
     .analysis-indicators { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
     .indicator-card { background-color: var(--card-bg); border-radius: var(--radius); padding: 1.25rem; text-align: center; box-shadow: var(--shadow); transition: var(--transition); display: flex; flex-direction: column; justify-content: center; min-height: 120px; }
     .indicator-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
     .indicator-title { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
     .indicator-value { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.01em; line-height: 1.2; margin-bottom: 0.25rem; }
     .indicator-value.positive { color: var(--success); } .indicator-value.negative { color: var(--danger); } .indicator-value.neutral { color: var(--text); }
     .indicator-comparison { font-size: 0.75rem; color: var(--text-secondary); margin-top: auto; }
     .analysis-content { display: grid; grid-template-columns: 1fr 320px; gap: 2rem; }
     .analysis-main { display: flex; flex-direction: column; gap: 1.5rem; }
     .analysis-sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
     .insights-feed { background: var(--card-bg); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); }
     .insights-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--primary); }
     .insights-title svg { flex-shrink: 0; }
     .insights-list { display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem; }
     .insight-item { display: flex; gap: 0.75rem; padding: 0.75rem 1rem; background-color: var(--insight-bg); border-radius: var(--radius-sm); font-size: 0.875rem; align-items: flex-start; line-height: 1.4; border-left-width: 3px; border-left-style: solid; }
     .insight-icon { flex-shrink: 0; margin-top: 2px; font-size: 1rem; }
     .insight-item.alert { color: var(--danger); background-color: rgba(255, 59, 48, 0.08); border-left-color: var(--danger); }
     .insight-item.warning { color: var(--warning); background-color: rgba(255, 149, 0, 0.08); border-left-color: var(--warning); }
     .insight-item.success { color: var(--success); background-color: rgba(52, 199, 89, 0.08); border-left-color: var(--success); }
     .insight-item.info { color: var(--primary); background-color: rgba(0, 122, 255, 0.08); border-left-color: var(--primary); }
     .insight-item.neutral { color: var(--text-secondary); background-color: var(--input-bg); border-left-color: var(--text-secondary); }

    /* Simple Transaction List (Análise Mensal) - Refinado com Botão Delete */
    /* ... (Container, Title, List structure - inalterados) ... */
     .transaction-list-container { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0; display: flex; flex-direction: column; }
     .transaction-list-title { font-size: 1.125rem; font-weight: 600; padding: 1.5rem 1.5rem 1rem 1.5rem; flex-shrink: 0; border-bottom: 1px solid var(--border); }
     .transaction-list { display: flex; flex-direction: column; gap: 0px; max-height: 500px; overflow-y: auto; padding: 0 0.5rem 0 1.5rem; flex-grow: 1; }
     #analysis-no-transactions { padding: 2rem 1.5rem; text-align: center; color: var(--text-secondary); }

    .transaction-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.875rem 1rem 0.875rem 0; border-bottom: 1px solid var(--border);
        transition: background-color 0.15s ease; cursor: pointer; position: relative;
    }
    .transaction-item:last-child { border-bottom: none; }
    .transaction-item:hover { background-color: var(--hover-bg); border-radius: var(--radius-sm); }
    .transaction-item .delete-transaction-btn {
        display: none; position: absolute; right: 0.75rem; /* Adjusted position */ top: 50%; transform: translateY(-50%);
        padding: 0.3rem; border-radius: 50%; background: var(--input-bg); /* Use input-bg */
        border: 1px solid var(--border); /* Add border */
        cursor: pointer; color: var(--text-secondary); line-height: 0; transition: var(--transition);
    }
    .transaction-item:hover .delete-transaction-btn { display: inline-flex; align-items: center; justify-content: center; }
    .transaction-item .delete-transaction-btn:hover { background: rgba(255, 59, 48, 0.1); color: var(--danger); border-color: rgba(255, 59, 48, 0.2); }
    .transaction-item .delete-transaction-btn svg { width: 14px; height: 14px; }
    .transaction-item:hover .transaction-item-right { padding-right: 3rem; } /* Increased space for delete */

    .transaction-item-left { display: flex; align-items: center; gap: 1rem; flex-grow: 1; min-width: 0; }
    .transaction-icon { width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; color: #fff; }
    .transaction-info { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; gap: 0.1rem; }
    .transaction-description { font-weight: 500; font-size: 0.9375rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
    .transaction-category { font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.3; }
    .transaction-item-right { text-align: right; flex-shrink: 0; padding-left: 1rem; transition: padding-right 0.15s ease; }
    .transaction-amount { font-weight: 600; font-size: 0.9375rem; white-space: nowrap; display: flex; align-items: center; justify-content: flex-end; gap: 0.3rem; }
    .transaction-amount.income { color: var(--success); } .transaction-amount.expense { color: var(--danger); }
    .transaction-date { font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.1rem; }
    .transaction-importance { display: inline-block; width: 8px; height: 8px; border-radius: 50%; vertical-align: middle; flex-shrink: 0; }
    .transaction-importance.extrema { background-color: var(--importance-extrema); } .transaction-importance.urgente { background-color: var(--importance-urgente); } .transaction-importance.importante { background-color: var(--importance-importante); }


    /* Botões */
    /* ... (Botão, btn:hover, active, disabled, variants - inalterados) ... */
     .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.9375rem; cursor: pointer; transition: var(--transition); border: none; color: #fff; background-color: var(--primary); text-decoration: none; white-space: nowrap; }
     .btn:hover { opacity: 0.85; transform: translateY(-1px); }
     .btn:active { transform: translateY(0); opacity: 0.75; }
     .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
     .btn-primary { background-color: var(--primary); } .btn-success { background-color: var(--success); } .btn-warning { background-color: var(--warning); color: #333; } .btn-danger { background-color: var(--danger); }
     .btn-secondary { background-color: var(--input-bg); color: var(--text); border: 1px solid var(--border); }
     .btn-secondary:hover { background-color: var(--hover-bg); }
     .btn svg { width: 1rem; height: 1rem; flex-shrink: 0; }

    /* Botão toggle theme */
    /* ... (Theme toggle, hover, svg - inalterados) ... */
    .theme-toggle { background: var(--input-bg); border: none; border-radius: 50%; width: 2.75rem; height: 2.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); transition: var(--transition); flex-shrink: 0; }
    .theme-toggle:hover { background-color: var(--hover-bg); }
    .theme-toggle svg { width: 1.25rem; height: 1.25rem; }


    /* Select estilo Apple */
    /* ... (Select, dark theme, hover, focus, option - inalterados) ... */
     select { appearance: none; -webkit-appearance: none; padding: 0.75rem 2.25rem 0.75rem 1rem; height: calc(1.5em + 1.5rem + 2px); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238A8A8E' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E") no-repeat; background-position: right 0.875rem center; color: var(--text); font-family: var(--font-sans); font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: var(--transition); min-width: 120px; line-height: 1.5; }
     [data-theme="dark"] select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238E8E93' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E"); background-color: var(--card-bg); }
     select:hover { border-color: rgba(60, 60, 67, 0.4); }
     select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); }
     select option { background-color: var(--card-bg); color: var(--text); }


    /* Modal */
    /* ... (Modal, active, content, header, title, close, footer - inalterados) ... */
    /* Modal Body com scroll aprimorado */
     .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; padding: 1rem; }
     .modal.active { opacity: 1; pointer-events: all; }
     .modal-content { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 550px; max-height: calc(100vh - 4rem); overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; opacity: 0; }
     .modal.active .modal-content { opacity: 1; transform: scale(1) translateY(0); }
     .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
     .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
     .modal-close { background: var(--input-bg); border: none; width: 2.25rem; height: 2.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: var(--transition); flex-shrink: 0; }
     .modal-close:hover { background-color: var(--hover-bg); color: var(--text); }
     .modal-close svg { width: 1rem; height: 1rem; flex-shrink: 0; }
     .modal-body { padding: 1.75rem; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
     .modal-footer { padding: 1.25rem 1.75rem; display: flex; justify-content: flex-end; gap: 0.75rem; border-top: 1px solid var(--border); background-color: rgba(var(--bg-rgb), 0.8); flex-shrink: 0; backdrop-filter: blur(3px); }
     [data-theme="dark"] .modal-footer { background-color: rgba(var(--bg-rgb), 0.8); }


    /* Formulários dentro do Modal */
    /* ... (Form grid, group, label, control, focus, textarea - inalterados) ... */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; } .form-grid.single-col { grid-template-columns: 1fr; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
    .form-control { width: 100%; padding: 0.875rem 1rem; font-size: 0.9375rem; height: calc(1.5em + 1.75rem + 2px); border-radius: var(--radius-sm); border: 1px solid var(--border); background-color: var(--input-bg); color: var(--text); transition: var(--transition); font-family: var(--font-sans); line-height: 1.5; }
    input[type="color"].form-control { padding: 0.25rem; height: calc(1.5em + 1.75rem + 2px); }
    input[type="date"].form-control { line-height: normal; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--card-bg); }
    textarea.form-control { line-height: 1.4; min-height: 80px; height: auto; }


    /* Transaction Modal Specifics */
    /* ... (Modal width, input group, advanced fields, btn-link, importance - inalterados) ... */
    #transaction-modal .modal-content { max-width: 500px; }
    .input-group { display: flex; align-items: center; }
    .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; flex-grow: 1; height: calc(1.5em + 1.75rem + 2px); }
    .input-group-append { flex-shrink: 0; }
    .input-group-append .btn-icon-small { border-top-left-radius: 0; border-bottom-left-radius: 0; height: calc(1.5em + 1.75rem + 2px); margin-left: -1px; }
    #advanced-fields { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border); display: none; animation: slideDown 0.3s ease-out forwards; }
    #advanced-fields.visible { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); max-height: 0; overflow: hidden;} to { opacity: 1; transform: translateY(0); max-height: 1000px; overflow: visible;} }
    .btn-link { background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; font-size: 0.875rem; font-weight: 500; text-align: left; display: inline-flex; align-items: center; gap: 0.25rem; }
    .btn-link:hover { text-decoration: underline; } .btn-link svg { transition: transform 0.2s ease; }
    #advanced-fields.visible + .btn-link svg { transform: rotate(180deg); }
    .importance-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .importance-group input[type="radio"] { opacity: 0; position: fixed; width: 0; }
    .importance-group label { display: inline-block; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); font-size: 0.875rem; font-weight: 500; border-left-width: 4px; border-left-color: transparent; margin-bottom: 0; }
    .importance-group input[type="radio"]:checked + label { background-color: var(--primary); color: #fff; border-color: var(--primary); }
    .importance-group input[type="radio"]:focus-visible + label { box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); outline: none; }
    .importance-group label[for="importance-extrema"] { border-left-color: var(--importance-extrema); } .importance-group label[for="importance-urgente"] { border-left-color: var(--importance-urgente); } .importance-group label[for="importance-importante"] { border-left-color: var(--importance-importante); }
    .importance-group input[type="radio"]:checked + label[for="importance-extrema"] { background-color: var(--importance-extrema); border-color: var(--importance-extrema); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-urgente"] { background-color: var(--importance-urgente); border-color: var(--importance-urgente); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-importante"] { background-color: var(--importance-importante); border-color: var(--importance-importante); color: #333; }

    /* Category & Confirm Modal Specifics */
    /* ... (Widths, message/extra info styles - inalterados) ... */
     #category-modal .modal-content { max-width: 400px; }
     #confirm-modal .modal-content { max-width: 450px; }
     #confirm-modal-message { margin-bottom: 1rem; line-height: 1.4; font-weight: 500; }
     #confirm-modal-extra-info { margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary); }
     #confirm-modal-extra-info label { display: block; margin-bottom: 0.75rem; cursor: pointer; }
     #confirm-modal-extra-info input[type="radio"] { margin-right: 0.5rem; accent-color: var(--primary); }


    /* Loading Estado */
    /* ... (Loading indicator, spinner, keyframes - inalterados) ... */
     .loading-indicator { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(3px); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
     .loading-indicator.active { opacity: 1; pointer-events: all; }
     .spinner { width: 2.5rem; height: 2.5rem; border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; }
     [data-theme="dark"] .spinner { border-color: rgba(255, 255, 255, 0.1); border-top-color: #aaa; }
     @keyframes spin { to { transform: rotate(360deg); } }


    /* Alertas / Toast Notifications */
    /* ... (Toast container, toast, show, icon, variants - inalterados) ... */
     .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; }
     .toast { background-color: var(--card-bg); color: var(--text); padding: 0.875rem 1.25rem; border-radius: var(--radius-sm); box-shadow: var(--shadow-dropdown); display: flex; align-items: center; gap: 0.75rem; min-width: 250px; max-width: 400px; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000); border-left: 4px solid var(--primary); }
     .toast.show { opacity: 1; transform: translateX(0); }
     .toast-icon { font-size: 1.25rem; flex-shrink: 0; }
     .toast.success { border-left-color: var(--success); } .toast.warning { border-left-color: var(--warning); } .toast.danger { border-left-color: var(--danger); } .toast.info { border-left-color: var(--primary); }


    /* Responsividade */
    /* ... (Media queries com ajustes pontuais, incluindo theme-toggle mobile - revisados) ... */
     @media (max-width: 1200px) { .analysis-content { grid-template-columns: 1fr; } .analysis-sidebar { grid-row: 2; } }
     @media (max-width: 992px) { .container { padding: 1.5rem; } .header { flex-direction: column; align-items: flex-start; } .header-right { width: 100%; justify-content: space-between; } .charts-grid { grid-template-columns: 1fr; } .chart-container { height: 260px; } .full-width .chart-container { height: 300px; } .analysis-header, .filters { gap: 1rem; } }
     @media (max-width: 768px) { h1 { font-size: 1.625rem; } .kpis { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .analysis-indicators { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } .btn { padding: 0.625rem 1.25rem; font-size: 0.875rem; } select, .form-control, .btn-icon-small { height: calc(1.5em + 1.25rem + 2px); } select { padding: 0.625rem 2rem 0.625rem 0.875rem; font-size: 0.875rem; } .form-grid { grid-template-columns: 1fr; } .transaction-item { flex-direction: column; align-items: flex-start; gap: 0.25rem; padding: 0.75rem 0.75rem 0.75rem 0; } .transaction-item-left { width: 100%; } .transaction-item-right { text-align: left; margin-top: 0.25rem; width: 100%; display: flex; justify-content: space-between; align-items: center; padding-left: 0; } .transaction-list { padding: 0 0.5rem 0 1rem; } .modal-content { width: 95%; max-height: calc(100vh - 2rem); } .modal-body, .modal-header, .modal-footer { padding: 1.25rem; } .tabs { margin-bottom: 1.5rem; } .tab { padding: 0.75rem 1rem; font-size: 0.875rem; } .analysis-content { grid-template-columns: 1fr; gap: 1.5rem; } .analysis-sidebar { order: 1; } .analysis-main { order: 2; } }
     @media (max-width: 576px) { .container { padding: 1rem; } h1 { font-size: 1.5rem; } .kpis { grid-template-columns: 1fr; } .analysis-indicators { grid-template-columns: 1fr; } .header-right { flex-direction: column; align-items: stretch; gap: 0.75rem; } .analysis-header { padding-bottom: 1rem; margin-bottom: 1rem;} .filters { flex-direction: column; align-items: stretch; gap: 0.75rem; } .filter-group { width: 100%; } select { width: 100%; } .category-filter-group { width: 100%; } .category-filter-group select { flex-grow: 1; } .header-right .btn { width: 100%; } .theme-toggle { align-self: flex-end; margin-top: 0.5rem; } .importance-group { gap: 0.25rem; } .importance-group label { padding: 0.4rem 0.8rem; } .toast-container { right: 1rem; bottom: 1rem; left: 1rem; align-items: stretch; } .toast { width: 100%; } .transaction-description { font-size: 0.875rem;} .transaction-amount { font-size: 0.875rem;} .transaction-item:hover .transaction-item-right { padding-right: 2.5rem; } .transaction-item .delete-transaction-btn { right: 0.5rem; } }


    /* Print styles */
    /* ... (Print styles inalterados) ... */
     @media print { body { background-color: #fff; color: #000; } .header, .tabs, .theme-toggle, .btn, .modal, .loading-indicator, .toast-container, .analysis-sidebar, .delete-transaction-btn { display: none !important; } .container { max-width: 100%; padding: 0; } .card, .kpi-card, .indicator-card, .transaction-list-container, .insights-feed { box-shadow: none; border: 1px solid #ddd; border-radius: 0; padding: 1rem; page-break-inside: avoid; background-color: #fff !important; } .kpis, .charts-grid, .analysis-indicators, .analysis-content, .analysis-main { grid-template-columns: 1fr !important; gap: 1rem; } canvas { max-width: 100%; } select { border: none; appearance: none; -webkit-appearance: none; padding-right: 1rem; background: none; } .transaction-item { border-bottom: 1px solid #eee; } .transaction-item:hover { background-color: transparent; margin: 0; padding: 1rem 0; border-radius: 0; } .transaction-item-right { padding-right: 0 !important; } :root { --text: #000; --text-secondary: #555; --success: #008000; --danger: #D00000; --primary: #0000FF; --warning: #FFA500; --bg: #fff; --card-bg: #fff; --input-bg: #eee; } .indicator-value.positive, .kpi-trend.up, .transaction-amount.income { color: var(--success) !important; } .indicator-value.negative, .kpi-trend.down, .transaction-amount.expense { color: var(--danger) !important; } .progress-bar { background-color: #ccc !important; } }

  </style>
</head>
<body>
    <!-- O HTML é idêntico à versão anterior, apenas com a adição do filtro de importância -->
     <!-- HTML -->
     <div class="container">
         <!-- Header -->
         <div class="header">
             <div class="header-title"><h1>Calculadora Financeira</h1></div>
             <div class="header-right">
                 <button class="btn btn-primary" id="btn-new-transaction"><svg><!-- plus --></svg>Nova Transação</button>
                 <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema"><svg id="theme-icon"><!-- moon/sun --></svg></button>
             </div>
         </div>
         <!-- Tabs -->
         <div class="tabs">
             <div class="tab active" data-tab="overview">Visão Geral</div>
             <div class="tab" data-tab="analysis">Análise Mensal</div>
         </div>
         <!-- Conteúdo Tabs -->
         <div id="tab-contents">
              <!-- Aba Visão Geral -->
              <div class="tab-content active" id="tab-overview">
                 <!-- KPIs -->
                 <div class="kpis"><!-- KPIs aqui --></div>
                 <!-- Gráficos -->
                 <div class="charts-grid"><!-- Gráficos aqui --></div>
              </div>
              <!-- Aba Análise Mensal -->
              <div class="tab-content" id="tab-analysis">
                  <!-- Filtros -->
                  <div class="analysis-header">
                      <div class="filters">
                          <div class="filter-group"><label for="analysis-year">Ano</label><select id="analysis-year"></select></div>
                          <div class="filter-group"><label for="analysis-month">Mês</label><select id="analysis-month"></select></div>
                          <div class="filter-group"><label for="analysis-category">Categoria</label><div class="category-filter-group"><select id="analysis-category"><option value="all">Todas</option></select><button class="btn-icon-small" id="btn-add-category" title="Nova Categoria"><svg><!-- plus --></svg></button><button class="btn-icon-small btn-delete-category" id="btn-delete-category" title="Excluir Categoria" style="display: none;"><svg><!-- trash --></svg></button></div></div>
                          <div class="filter-group"><label for="analysis-importance">Importância</label><select id="analysis-importance"><option value="all">Todas</option><option value="extrema">Extrema</option><option value="urgente">Urgente</option><option value="importante">Importante</option><option value="none">Nenhuma</option></select></div>
                      </div>
                  </div>
                  <!-- Indicadores -->
                  <div class="analysis-indicators"><!-- Indicadores aqui --></div>
                  <!-- Conteúdo Principal e Sidebar -->
                  <div class="analysis-content">
                      <div class="analysis-main">
                          <div class="charts-grid"><!-- Gráficos Análise --></div>
                          <div class="transaction-list-container">
                              <div class="transaction-list-title">Transações do Mês</div>
                              <div id="analysis-transaction-list" class="transaction-list"><!-- Lista --></div>
                          </div>
                      </div>
                      <aside class="analysis-sidebar">
                          <div class="insights-feed card">
                              <div class="insights-title"><svg><!-- insight icon --></svg>Insights Rápidos</div>
                              <div class="insights-list" id="analysis-insights-list"><!-- Insights --></div>
                          </div>
                      </aside>
                  </div>
              </div>
         </div>
     </div>
     <!-- Modais (Transaction, Category, Confirm) -->
     <!-- ... -->
      <!-- Loading Indicator -->
      <div class="loading-indicator" id="loading"><div class="spinner"></div></div>
      <!-- Toast Container -->
      <div class="toast-container" id="toast-container"></div>

    <script>
    // ===== Configurações Globais e Firebase =====
    const root = document.documentElement;
    const loading = document.getElementById('loading');
    moment.locale('pt-br');

    // Configuração Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDvL_nYWhy_8rPouejiWbDZtDCKHYOQyEY",
        authDomain: "calculadora-da-familia.firebaseapp.com",
        projectId: "calculadora-da-familia",
        storageBucket: "calculadora-da-familia.appspot.com",
        messagingSenderId: "69721783786",
        appId: "1:69721783786:web:c4703b5c182e3681e8c693",
        measurementId: "G-YM5TR661S6"
    };

    // Inicializar Firebase
    let app;
    let db;
    try {
        // Verifica se o objeto firebaseConfig está completo
        if (!firebaseConfig.projectId) {
             throw new Error("FirebaseError: 'projectId' não encontrado no objeto de configuração.");
        }
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase inicializado com sucesso!");
    } catch (error) {
        console.error("Erro CRÍTICO ao inicializar Firebase:", error);
        console.error("Configuração usada:", firebaseConfig); // Loga a config para depuração
        // Usa alert como fallback seguro, pois o Toast pode depender de JS não carregado
        alert(`Erro crítico ao conectar com o banco de dados: ${error.message}. A aplicação não funcionará corretamente.`);
         // Opcional: Desabilitar botões principais para evitar mais erros
         document.getElementById('btn-new-transaction').disabled = true;
         document.querySelectorAll('.tab').forEach(tab => tab.style.pointerEvents = 'none');
    }

    // Coleções Firestore (só define se db foi inicializado)
    let transactionsCollection = db ? db.collection('transactions') : null;
    let categoriesCollection = db ? db.collection('categories') : null;

    // ===== Estados da Aplicação =====
    let transactions = [];
    let categories = [];
    let currentTab = 'overview';
    let currentAnalysisMonth = moment().month(); // 0-11
    let currentAnalysisYear = moment().year();
    let currentAnalysisCategory = 'all';
    let currentAnalysisImportance = 'all';
    let unsubscribeTransactions = null;
    let unsubscribeCategories = null;
    let isUpdatingAnalysis = false; // Flag para evitar múltiplas atualizações
    let chartInstances = {}; // Armazena instâncias dos gráficos

    // ===== Constantes e Mapas =====
     const TRANSACTION_TYPES = { income: { name: 'Receita', icon: '💰', colorClass: 'positive' }, expense: { name: 'Despesa', icon: '💸', colorClass: 'negative' } };
     const PAYMENT_METHODS = { 'cash': 'Dinheiro', 'credit_card': 'Cartão de Crédito', 'debit_card': 'Cartão de Débito', 'bank_transfer': 'Transferência', 'pix': 'PIX', 'boleto': 'Boleto', 'other': 'Outro' };
     const TRANSACTION_STATUS = { 'paid': { name: 'Pago', class: 'status-paid' }, 'pending': { name: 'Pendente', class: 'status-pending' }, 'scheduled': { name: 'Agendado', class: 'status-scheduled' } };
     const RECURRENCE_FREQUENCY = { 'daily': { name: 'Diária', momentUnit: 'days', momentStep: 1 }, 'weekly': { name: 'Semanal', momentUnit: 'weeks', momentStep: 1 }, 'biweekly': { name: 'Quinzenal', momentUnit: 'weeks', momentStep: 2 }, 'monthly': { name: 'Mensal', momentUnit: 'months', momentStep: 1 }, 'bimonthly': { name: 'Bimestral', momentUnit: 'months', momentStep: 2 }, 'quarterly': { name: 'Trimestral', momentUnit: 'months', momentStep: 3 }, 'semiannual': { name: 'Semestral', momentUnit: 'months', momentStep: 6 }, 'annual': { name: 'Anual', momentUnit: 'years', momentStep: 1 } };
     const DEFAULT_EXPENSE_CATEGORIES = [ { id: 'moradia', name: 'Moradia', type: 'expense', color: '#FF9500', icon: '🏠', isDefault: true }, { id: 'alimentacao', name: 'Alimentação', type: 'expense', color: '#34C759', icon: '🍔', isDefault: true }, { id: 'transporte', name: 'Transporte', type: 'expense', color: '#007AFF', icon: '🚗', isDefault: true }, { id: 'contas', name: 'Contas Fixas', type: 'expense', color: '#5AC8FA', icon: '💡', isDefault: true }, { id: 'lazer', name: 'Lazer', type: 'expense', color: '#AF52DE', icon: '🎮', isDefault: true }, { id: 'saude', name: 'Saúde', type: 'expense', color: '#FF3B30', icon: '🏥', isDefault: true }, { id: 'compras', name: 'Compras', type: 'expense', color: '#FFCC00', icon: '🛍️', isDefault: true }, { id: 'educacao', name: 'Educação', type: 'expense', color: '#5856D6', icon: '📚', isDefault: true }, { id: 'outros_despesas', name: 'Outras Despesas', type: 'expense', color: '#8E8E93', icon: '📋', isDefault: true } ];
     const DEFAULT_INCOME_CATEGORIES = [ { id: 'salario', name: 'Salário', type: 'income', color: '#34C759', icon: '💰', isDefault: true }, { id: 'freelance', name: 'Freelance/Extra', type: 'income', color: '#007AFF', icon: '💼', isDefault: true }, { id: 'investimentos', name: 'Investimentos', type: 'income', color: '#AF52DE', icon: '📈', isDefault: true }, { id: 'outros_receitas', name: 'Outras Receitas', type: 'income', color: '#8E8E93', icon: '💸', isDefault: true } ];


    // ===== Utilitários =====
    const formatCurrency = (value) => value?.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) ?? 'R$ 0,00';
    const formatDate = (dateString) => dateString ? moment(dateString).format('DD/MM/YYYY') : '--';
    const formatDateForInput = (date = new Date()) => moment(date).format('YYYY-MM-DD');
    const showLoading = () => loading?.classList.add('active');
    const hideLoading = () => loading?.classList.remove('active');
    // Implementação do showToast (mantida da versão anterior)
    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        const toastId = `toast-${Date.now()}`;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = toastId;
        let icon = {'info': 'ℹ️', 'success': '✅', 'warning': '⚠️', 'danger': '❌'}[type] || 'ℹ️';
        toast.innerHTML = `<span class="toast-icon">${icon}</span><span class="toast-message">${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            const removeToast = () => { if(toast.parentNode) toast.parentNode.removeChild(toast); };
            toast.addEventListener('transitionend', removeToast, { once: true });
            setTimeout(removeToast, 500); // Failsafe
        }, duration);
    }
    function updateThemeIcon(theme) { /* ... (Implementação inalterada) ... */ }
    function setupTheme() { /* ... (Implementação inalterada) ... */ }
    function toggleTheme() { /* ... (Implementação inalterada) ... */ }

    // ===== Gerenciamento de Dados (Firestore) =====
    async function loadCategories() {
         if (!categoriesCollection) return Promise.reject("Firestore não inicializado");
         // ... (Restante da lógica inalterada) ...
          return new Promise(async (resolve, reject) => { /* ... */ });
     }
    async function addCategory(name, type, icon, color) {
        if (!categoriesCollection) return Promise.reject("Firestore não inicializado");
        // ... (Restante da lógica inalterada) ...
         showLoading(); try { /* ... */ } catch(e) { /* ... */ } finally { hideLoading(); }
    }
    async function deleteCategory(categoryId) {
        if (!categoriesCollection || !transactionsCollection) return Promise.reject("Firestore não inicializado");
         // ... (Restante da lógica inalterada) ...
         showLoading(); try { /* ... */ } catch(e) { /* ... */ } finally { hideLoading(); }
    }
    function processTransactionSnapshot(snapshot) {
        transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        transactions.sort((a, b) => moment(b.date).diff(moment(a.date)));
        console.log(`Transações atualizadas: ${transactions.length} encontradas.`);
        updateDashboard(); // Atualiza UI com novos dados
    }
    function processCategorySnapshot(snapshot) {
        let loadedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        categories = loadedCategories.sort((a, b) => a.name.localeCompare(b.name));
        console.log(`Categorias atualizadas: ${categories.length} encontradas.`);
        populateCategoryFilters();
        // Atualiza a aba ativa se necessário
        if (currentTab === 'analysis') updateMonthlyAnalysis();
        else if (currentTab === 'overview') updateOverviewCharts();
    }
    function setupFirestoreListeners() {
        if (!db) {
             console.error("Não é possível configurar listeners: Firestore não inicializado.");
             return;
         }
        stopFirestoreListeners(); // Limpa listeners antigos
        unsubscribeTransactions = transactionsCollection?.onSnapshot(processTransactionSnapshot, handleListenerError("transações"));
        unsubscribeCategories = categoriesCollection?.onSnapshot(processCategorySnapshot, handleListenerError("categorias"));
    }
    function stopFirestoreListeners() {
        if (unsubscribeTransactions) unsubscribeTransactions();
        if (unsubscribeCategories) unsubscribeCategories();
        unsubscribeTransactions = null;
        unsubscribeCategories = null;
        // console.log("Listeners do Firestore desligados."); // Reduzido o log
    }
     // Função auxiliar para tratar erros dos listeners
     function handleListenerError(collectionName) {
         return (error) => {
             console.error(`Erro no listener de ${collectionName}:`, error);
             showToast(`Erro ao sincronizar ${collectionName}. Alguns dados podem estar desatualizados.`, "danger");
         };
     }

    // ===== Lógica de Transações =====
     // ... (openTransactionModal, saveTransaction, generateFutureInstallments, deleteTransaction - inalterados, mas com verificações de 'db') ...
     function openTransactionModal(transaction = null) { /* ... (Verificar se 'categories' está populado) ... */ }
     async function saveTransaction(event) { if (!db) return; /* ... */ }
     async function generateFutureInstallments(batch, baseData, baseId, frequency, totalInstallments, startDate, startInstallmentNum) { if (!db) return; /* ... */ }
     async function deleteTransaction(transactionId, recurringBaseId = null, deleteScope = 'this') { if (!db) return; /* ... */ }


    // ===== Interface e Interação =====
     // ... (openModal, closeModal - inalterados) ...
     function openModal(modalElement) { /* ... */ }
     function closeModal(modalElement) { /* ... */ }

    // Inicializar Navegação por Tabs (Com gestão de loading aprimorada)
     function initTabs() { /* ... (Implementação da versão anterior, já aprimorada) ... */ }

    // Popular selects de categoria (Inalterado)
     function populateCategoryFilters() { /* ... */ }
    // Popular select de categoria no Modal (Inalterado)
     function populateCategorySelect(type = 'expense') { /* ... */ }
    // Habilitar/desabilitar botão delete (Inalterado)
     function toggleDeleteCategoryButton() { /* ... */ }

    // Popular selects de Mês e Ano (Inalterado - já estava separado)
     function populateMonthYearFilter() { /* ... */ }

    // Setup dos Event Listeners (Inalterado - já incluía Importance)
     function setupEventListeners() { /* ... */ }

    // Mostrar/Ocultar campos avançados (Inalterado)
     function toggleAdvancedFields() { /* ... */ }
    // Abrir Modal Nova Categoria (Inalterado)
     function openCategoryModal() { /* ... */ }
    // Salvar Categoria (Handler) (Inalterado)
     async function handleSaveCategory(event) { /* ... */ }
    // Confirmar Exclusão de Categoria (Inalterado)
     function confirmDeleteCategory(categoryId) { /* ... */ }
    // Confirmar Exclusão de Transação (Inalterado)
     function confirmDeleteTransaction(transactionId) { /* ... */ }

    // ===== Atualização da UI =====
     // Atualizar Dashboard Completo (Inalterado)
     function updateDashboard() { /* ... */ }
     // Atualizar KPIs (Inalterado - CSS/SVG já revisados)
     function updateKPIs() { /* ... */ }

    // ===== Lógica da Análise Mensal =====
     // (updateMonthlyAnalysis, calculateMonthlyIndicators, generateAndRenderInsights - Inalterados, já consideravam importance)
     // (renderMonthlyTransactionList - Inalterado, já tinha o botão delete)
     async function updateMonthlyAnalysis() { /* ... */ }
     function calculateMonthlyIndicators(monthlyTransactions, selectedMonthMoment) { /* ... */ }
     function renderMonthlyTransactionList(monthlyTransactions) { /* ... (Botão delete já estava aqui) ... */ }
     function generateAndRenderInsights(monthlyTransactions, selectedMonthMoment) { /* ... */ }

    // ===== Gráficos =====
     // ... (getChartCommonOptions, initCharts, updateAllChartsTheme, updateOverviewCharts, updateAnalysisCharts - inalterados) ...
     // A função initCharts agora usa chartInstances para armazenar referências
     function initCharts() {
         const isDark = root.getAttribute('data-theme') === 'dark';
         const commonOptions = getChartCommonOptions(isDark);

         // Destruir gráficos antigos antes de recriar
         Object.values(chartInstances).forEach(chart => chart?.destroy());
         chartInstances = {};

         const chartConfigs = {
             'overview-income-expense-chart': { type: 'bar', options: commonOptions },
             'overview-category-chart': { type: 'doughnut', options: {...commonOptions, cutout: '65%'} },
             'overview-cashflow-chart': { type: 'bar', options: commonOptions },
             'overview-fixed-variable-chart': { type: 'pie', options: commonOptions },
             'overview-trend-chart': { type: 'line', options: {...commonOptions, tension: 0.3, pointRadius: 3, pointHoverRadius: 5 } },
             'analysis-category-pie-chart': { type: 'pie', options: commonOptions },
             'analysis-balance-line-chart': { type: 'line', options: {...commonOptions, tension: 0.1, pointRadius: 3, pointHoverRadius: 5 } }
         };

         for (const [canvasId, config] of Object.entries(chartConfigs)) {
             const ctx = document.getElementById(canvasId)?.getContext('2d');
             if (ctx) {
                 try {
                    chartInstances[canvasId] = new Chart(ctx, {
                         type: config.type,
                         data: { labels: [], datasets: [] }, // Dados vazios inicialmente
                         options: config.options
                     });
                 } catch (e) {
                      console.error(`Erro ao inicializar gráfico ${canvasId}:`, e);
                 }
             } else {
                 // console.warn(`Canvas com ID ${canvasId} não encontrado.`);
             }
         }
         console.log("Gráficos inicializados/re-inicializados.");
     }

     function getChartInstance(canvasId) {
         return chartInstances[canvasId];
     }

     function updateAllChartsTheme() {
         const isDark = root.getAttribute('data-theme') === 'dark';
         const newOptions = getChartCommonOptions(isDark);
         Object.values(chartInstances).forEach(chart => {
             if (chart?.options) {
                 // Merge inteligente para preservar opções específicas (cutout, tension, etc.)
                 // que não estão nas commonOptions base.
                 const specificOptions = {
                     cutout: chart.options.cutout,
                     tension: chart.options.tension,
                     pointRadius: chart.options.pointRadius,
                     pointHoverRadius: chart.options.pointHoverRadius,
                     indexAxis: chart.options.indexAxis
                 };
                 // Remove undefined para não sobrescrever com undefined
                 Object.keys(specificOptions).forEach(key => specificOptions[key] === undefined && delete specificOptions[key]);

                 chart.options = { ...chart.options, ...newOptions, ...specificOptions };

                 // Atualiza cores que podem não estar cobertas
                 if(chart.options.plugins?.legend?.labels) chart.options.plugins.legend.labels.color = newOptions.color;
                 if(chart.options.plugins?.tooltip) { /* ... atualiza cores tooltip ... */ }
                 if(chart.options.scales?.x?.ticks) chart.options.scales.x.ticks.color = newOptions.color;
                 if(chart.options.scales?.x?.grid) chart.options.scales.x.grid.color = newOptions.scales.x.grid.color;
                 if(chart.options.scales?.y?.ticks) chart.options.scales.y.ticks.color = newOptions.color;
                 if(chart.options.scales?.y?.grid) chart.options.scales.y.grid.color = newOptions.scales.y.grid.color;
                 // ... etc para outras escalas ...

                 chart.update();
             }
         });
         // console.log("Temas dos gráficos atualizados."); // Reduzido o log
     }

     function updateOverviewCharts() {
         const isDark = root.getAttribute('data-theme') === 'dark';
         const chartIdPrefix = 'overview-';

         // Receitas vs Despesas (12m)
         const incomeExpenseChart = getChartInstance(`${chartIdPrefix}income-expense-chart`);
         if (incomeExpenseChart) { /* ... (Lógica de dados inalterada) ... */ incomeExpenseChart.update(); }

         // Categorias (30d)
         const categoryChart = getChartInstance(`${chartIdPrefix}category-chart`);
         if (categoryChart) { /* ... (Lógica de dados inalterada) ... */ categoryChart.update(); }

         // Fluxo Caixa (Ano Atual)
         const cashflowChart = getChartInstance(`${chartIdPrefix}cashflow-chart`);
         if (cashflowChart) { /* ... (Lógica de dados inalterada) ... */ cashflowChart.update(); }

         // Fixas vs Variáveis (Mês Atual)
         const fixedVariableChart = getChartInstance(`${chartIdPrefix}fixed-variable-chart`);
         if (fixedVariableChart) { /* ... (Lógica de dados inalterada) ... */ fixedVariableChart.update(); }

         // Tendência Gastos (6m)
         const trendChart = getChartInstance(`${chartIdPrefix}trend-chart`);
         if (trendChart) { /* ... (Lógica de dados inalterada) ... */ trendChart.update(); }
     }

     function updateAnalysisCharts(monthlyTransactions) {
         const isDark = root.getAttribute('data-theme') === 'dark';
         const chartIdPrefix = 'analysis-';

          // Distribuição de Despesas (Pizza)
         const categoryPieChart = getChartInstance(`${chartIdPrefix}category-pie-chart`);
         if (categoryPieChart) { /* ... (Lógica de dados inalterada) ... */ categoryPieChart.update(); }

          // Evolução do Saldo no Mês (Linha)
         const balanceLineChart = getChartInstance(`${chartIdPrefix}balance-line-chart`);
         if (balanceLineChart) { /* ... (Lógica de dados inalterada) ... */ balanceLineChart.update(); }
     }

    // ===== Inicialização da Aplicação =====
    async function init() {
        showLoading();
        console.log("Iniciando aplicação...");

        // Verifica se o Firebase foi inicializado corretamente
         if (!db) {
             console.error("Falha crítica: Firestore não está disponível. Interrompendo inicialização.");
             // Não precisa esconder loading aqui, pois a UI principal não carregará
             return; // Interrompe a execução da init
         }

        try {
            setupTheme();
            await loadCategories(); // Espera carregar categorias
            initTabs();
            populateMonthYearFilter();
            setupEventListeners();
            initCharts(); // Inicializa gráficos após elementos estarem no DOM
            setupFirestoreListeners(); // Configura listeners APÓS UI inicial estar pronta

            console.log("Aplicação inicializada.");
        } catch (error) {
            console.error("Erro durante a inicialização pós-Firebase:", error);
            showToast("Ocorreu um erro ao carregar alguns componentes da aplicação.", "danger", 10000);
        } finally {
             // Esconder loading após um pequeno delay para garantir renderização inicial
             setTimeout(hideLoading, 500);
        }
    }

    // --- Ponto de Entrada ---
    document.addEventListener('DOMContentLoaded', init);

    // --- Limpeza ao Sair ---
    window.addEventListener('beforeunload', stopFirestoreListeners);

    </script>

</body>
</html>
