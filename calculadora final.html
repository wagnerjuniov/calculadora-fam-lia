<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Familiar Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <style>
    /* ===== Variáveis e Temas (Estilo Apple/Google) ===== */
    :root {
      --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem; /* 12px */
      --radius: 1.125rem; /* 18px */
      --radius-lg: 1.5rem; /* 24px */
      --shadow: 0 4px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.09), 0 2px 6px rgba(0,0,0,0.07);
      --shadow-dropdown: 0 5px 20px rgba(0,0,0,0.12);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

      /* Cores Light */
      --bg: #F9F9FB; /* Slightly off-white */
      --card-bg: #FFFFFF;
      --input-bg: rgba(118, 118, 128, 0.12); /* System Gray 5 (0.12 alpha) */
      --text: #1C1C1E; /* Almost Black */
      --text-secondary: #8A8A8E; /* System Gray */
      --primary: #007AFF; /* Blue */
      --primary-light: #5856D6; /* Indigo for accents if needed */
      --success: #34C759; /* Green */
      --warning: #FF9500; /* Orange */
      --danger: #FF3B30; /* Red */
      --info: #5AC8FA; /* Teal */
      --border: rgba(60, 60, 67, 0.15); /* Lighter border */
      --chart-grid: rgba(60, 60, 67, 0.08); /* Lighter grid */
      --menu-bg: rgba(255, 255, 255, 0.9); /* More opaque */
      --insight-bg: rgba(0, 122, 255, 0.06); /* Subtler blue */
      --importance-extrema: #FF3B30; /* Red */
      --importance-urgente: #FF9500; /* Orange */
      --importance-importante: #FFCC00; /* Yellow */
      --hover-bg: rgba(0, 0, 0, 0.03); /* Subtle hover */
    }

    [data-theme="dark"] {
      /* Cores Dark */
      --bg: #000000; /* True Black for OLED */
      --card-bg: #1C1C1E; /* Gray 6 */
      --input-bg: rgba(118, 118, 128, 0.24); /* System Gray 5 (0.24 alpha) */
      --text: #FFFFFF;
      --text-secondary: #8E8E93; /* Gray */
      --primary: #0A84FF; /* Blue */
      --primary-light: #5E5CE6; /* Indigo */
      --success: #30D158; /* Green */
      --warning: #FF9F0A; /* Orange */
      --danger: #FF453A; /* Red */
      --info: #64D2FF; /* Teal */
      --border: rgba(84, 84, 88, 0.35); /* Lighter border */
      --chart-grid: rgba(84, 84, 88, 0.15); /* Lighter grid */
      --menu-bg: rgba(28, 28, 30, 0.9); /* More opaque */
      --insight-bg: rgba(10, 132, 255, 0.12); /* Subtler blue */
      --importance-extrema: #FF453A; /* Red */
      --importance-urgente: #FF9F0A; /* Orange */
      --importance-importante: #FFD60A; /* Yellow */
      --hover-bg: rgba(255, 255, 255, 0.05); /* Subtle hover */
    }

    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html {
      font-size: 16px; /* Base font size */
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
      line-height: 1.5;
      width: 100%;
      overflow-x: hidden;
    }

    /* ===== Layout e Componentes ===== */
    .container {
      max-width: 1360px; /* Max width increased slightly */
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    h1 {
      font-size: 1.875rem; /* 30px */
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.03em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2rem;
      overflow-x: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE */
    }
    .tabs::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

    .tab {
      padding: 0.875rem 1.5rem; /* Slightly taller */
      font-weight: 600; /* Bolder */
      font-size: 0.9375rem; /* 15px */
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      margin-bottom: -1px; /* Overlap border */
      border-radius: 6px 6px 0 0; /* Subtle top radius */
    }

    .tab:hover {
      color: var(--text);
      background-color: var(--hover-bg);
    }

    .tab.active {
      color: var(--primary);
      border-color: var(--primary);
      background-color: var(--card-bg); /* Active tab bg matches card bg */
    }
    [data-theme="dark"] .tab.active {
        background-color: var(--card-bg);
    }


    .tab-content {
        display: none; /* Hide all by default */
        animation: fadeIn 0.4s ease-out;
    }

    .tab-content.active {
        display: block; /* Show active */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }


    /* KPIs Card */
     .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
      overflow: hidden;
      position: relative;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .kpi-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Center aligns title and icon */
      margin-bottom: 0.25rem;
    }

    .kpi-title {
      font-size: 0.9375rem; /* 15px */
      font-weight: 500;
      color: var(--text-secondary);
    }

    .kpi-icon {
        color: var(--text-secondary);
        opacity: 0.6; /* Slightly less prominent */
        flex-shrink: 0; /* Prevent icon distortion */
        width: 22px; /* Explicit size */
        height: 22px;
    }
    .kpi-icon svg { /* Ensure SVG inside scales correctly */
        display: block;
        width: 100%;
        height: 100%;
    }

    .kpi-value {
      font-size: 1.75rem; /* 28px */
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
      margin-top: 0.25rem; /* Add small space */
    }

    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: auto; /* Push footer to bottom */
      padding-top: 0.75rem; /* Space above footer */
      font-size: 0.8125rem; /* 13px */
      color: var(--text-secondary);
    }


    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 500;
    }

    .kpi-trend.up { color: var(--success); }
    .kpi-trend.down { color: var(--danger); }
    .kpi-trend.neutral { color: var(--text-secondary); }

    .kpi-trend svg {
      width: 14px; /* Consistent size */
      height: 14px;
      stroke-width: 2.5;
      fill: none; /* Use stroke for outline */
      stroke: currentColor; /* Use stroke for outlined arrows */
      flex-shrink: 0;
    }
    /* Specific SVG paths for better arrows */
    .kpi-trend svg .up-path { d: path("M4 12 L12 4 L20 12"); }
    .kpi-trend svg .down-path { d: path("M4 4 L12 12 L20 4"); }
    .kpi-trend svg .neutral-path { d: path("M4 8 L20 8"); }


    .progress-container {
      width: 100%;
      height: 6px; /* Thinner */
      background-color: var(--input-bg);
      border-radius: 3px; /* Match height/2 */
      overflow: hidden;
      margin-top: 0.5rem; /* Space above progress */
    }

    .progress-bar {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
      background-color: var(--primary); /* Default to primary */
    }
    .progress-bar.success { background-color: var(--success); }
    .progress-bar.warning { background-color: var(--warning); }
    .progress-bar.danger { background-color: var(--danger); }


    /* Gráficos */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr)); /* Slightly smaller min */
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

     .chart-container {
      position: relative;
      margin-top: 1rem;
      height: 280px;
    }

    .chart-title {
      font-size: 1.125rem; /* 18px */
      font-weight: 600;
      letter-spacing: -0.01em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .chart-title-actions {
      display: flex;
      gap: 0.75rem;
    }

    .full-width {
      grid-column: 1 / -1;
    }
    .full-width .chart-container {
      height: 320px;
    }


    /* Análise Mensal */
    .analysis-header {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem 1.5rem; /* More horizontal gap */
        align-items: flex-end; /* Align items to bottom for better label alignment */
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem 1.5rem;
        align-items: flex-end;
    }

    .filter-group { /* Wrapper for label and select */
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    .filter-group label {
        font-size: 0.8125rem; /* 13px */
        color: var(--text-secondary);
        font-weight: 500;
        padding-left: 0.25rem; /* Align with select padding */
    }


    .category-filter-group {
        display: flex;
        gap: 0.5rem;
        align-items: center; /* Center buttons with select */
    }
    .category-filter-group select {
        min-width: 200px; /* Ensure category select has enough width */
    }


    .btn-icon-small {
        padding: 0.5rem;
        min-width: auto;
        height: calc(1.5em + 1.5rem + 2px); /* Match select height */
        background: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }
    .btn-icon-small:hover {
        background-color: var(--hover-bg);
        border-color: rgba(60, 60, 67, 0.4);
    }
    .btn-icon-small svg {
        width: 1rem; /* 16px */
        height: 1rem;
        flex-shrink: 0;
    }

    .btn-delete-category {
        color: var(--danger);
    }
    .btn-delete-category:hover {
        background-color: rgba(255, 59, 48, 0.1);
    }

    .analysis-indicators {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

     .indicator-card {
        background-color: var(--card-bg);
        border-radius: var(--radius); /* More rounded */
        padding: 1.25rem;
        text-align: center;
        box-shadow: var(--shadow);
        transition: var(--transition);
        display: flex; /* Use flex for better control */
        flex-direction: column;
        justify-content: center; /* Center content vertically */
        min-height: 120px; /* Ensure consistent height */
    }
    .indicator-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
    }

    .indicator-title {
        font-size: 0.875rem; /* 14px */
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .indicator-value {
        font-size: 1.5rem; /* 24px */
        font-weight: 600;
        letter-spacing: -0.01em;
        line-height: 1.2;
        margin-bottom: 0.25rem; /* Space before comparison */
    }
    .indicator-value.positive { color: var(--success); }
    .indicator-value.negative { color: var(--danger); }
    .indicator-value.neutral { color: var(--text); }

    .indicator-comparison {
        font-size: 0.75rem; /* 12px */
        color: var(--text-secondary);
        margin-top: auto; /* Push to bottom if needed */
    }

    .analysis-content {
        display: grid;
        grid-template-columns: 1fr 320px; /* Main content and sidebar */
        gap: 2rem;
    }

    .analysis-main {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .analysis-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .insights-feed {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
    }

    .insights-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary);
    }
    .insights-title svg {
        flex-shrink: 0;
    }

    .insights-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 400px; /* Limit height */
        overflow-y: auto;
        padding-right: 0.5rem; /* Space for scrollbar */
    }

    .insight-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background-color: var(--insight-bg);
        border-radius: var(--radius-sm);
        font-size: 0.875rem; /* 14px */
        align-items: flex-start;
        line-height: 1.4;
    }

    .insight-icon {
        flex-shrink: 0;
        margin-top: 2px;
        font-size: 1rem;
    }

    .insight-item.alert { color: var(--danger); background-color: rgba(255, 59, 48, 0.08); border-left: 3px solid var(--danger); }
    .insight-item.warning { color: var(--warning); background-color: rgba(255, 149, 0, 0.08); border-left: 3px solid var(--warning); }
    .insight-item.success { color: var(--success); background-color: rgba(52, 199, 89, 0.08); border-left: 3px solid var(--success); }
    .insight-item.info { color: var(--primary); background-color: rgba(0, 122, 255, 0.08); border-left: 3px solid var(--primary); }
    .insight-item.neutral { color: var(--text-secondary); background-color: var(--input-bg); border-left: 3px solid var(--text-secondary); }


    /* Simple Transaction List (Análise Mensal) - Refined */
    .transaction-list-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0; /* Padding applied to title/list */
      display: flex;
      flex-direction: column; /* Allow list to scroll independently */
    }

    .transaction-list-title {
        font-size: 1.125rem;
        font-weight: 600;
        padding: 1.5rem 1.5rem 1rem 1.5rem; /* Consistent padding */
        flex-shrink: 0; /* Title shouldn't shrink */
        border-bottom: 1px solid var(--border); /* Separate title */
    }

    .transaction-list {
        display: flex;
        flex-direction: column;
        gap: 0px;
        max-height: 500px;
        overflow-y: auto;
        padding: 0 0.5rem 0 1.5rem; /* Left padding for alignment, right for scroll */
        flex-grow: 1; /* Allow list to take available space */
    }

    #analysis-no-transactions {
        padding: 2rem 1.5rem; /* Padding for the message */
        text-align: center;
        color: var(--text-secondary);
    }


    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 1rem 0.875rem 0; /* Reduced vertical padding, right padding for delete button */
        border-bottom: 1px solid var(--border);
        transition: background-color 0.15s ease;
        cursor: pointer;
        position: relative; /* For absolute positioning of delete button */
    }
    .transaction-item:last-child { border-bottom: none; }

    .transaction-item:hover {
        background-color: var(--hover-bg);
        /* margin/padding adjustment needed if hover bg should extend */
        /* Example: margin: 0 -1rem 0 0; padding-right: 1rem; */
         border-radius: var(--radius-sm);
    }
    .transaction-item .delete-transaction-btn { /* Style for delete button */
        display: none; /* Hidden by default */
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        padding: 0.3rem;
        border-radius: 50%;
        background: rgba(0,0,0,0.05);
        border: none;
        cursor: pointer;
        color: var(--text-secondary);
        line-height: 0; /* Remove extra space */
    }
    .transaction-item:hover .delete-transaction-btn {
        display: inline-flex; /* Show on hover */
        align-items: center;
        justify-content: center;
    }
    .transaction-item .delete-transaction-btn:hover {
        background: rgba(255, 59, 48, 0.1); /* Red background on hover */
        color: var(--danger);
    }
     .transaction-item .delete-transaction-btn svg {
        width: 14px;
        height: 14px;
     }
     /* Adjust right content padding when delete button is visible */
     .transaction-item:hover .transaction-item-right {
        padding-right: 2.5rem; /* Make space for delete button */
     }



    .transaction-item-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-grow: 1; /* Allow left side to take space */
        min-width: 0; /* Prevent overflow issues */
    }

    .transaction-icon {
        width: 2.25rem; /* 36px */
        height: 2.25rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
        color: #fff; /* Icon color */
    }

    .transaction-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        min-width: 0;
        gap: 0.1rem; /* Small gap between lines */
    }

    .transaction-description {
        font-weight: 500;
        font-size: 0.9375rem; /* 15px */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* Add ellipsis for long descriptions */
        line-height: 1.3; /* Adjust line height */
    }

    .transaction-category {
        font-size: 0.8125rem; /* 13px */
        color: var(--text-secondary);
        line-height: 1.3;
    }

     .transaction-item-right {
        text-align: right;
        flex-shrink: 0; /* Prevent right side from shrinking */
        padding-left: 1rem; /* Space between info and amount */
        transition: padding-right 0.15s ease; /* Smooth padding transition */
    }

    .transaction-amount {
        font-weight: 600;
        font-size: 0.9375rem;
        white-space: nowrap; /* Prevent amount wrapping */
        display: flex; /* Align amount and importance */
        align-items: center;
        justify-content: flex-end;
        gap: 0.3rem;
    }
    .transaction-amount.income { color: var(--success); }
    .transaction-amount.expense { color: var(--danger); }

    .transaction-date {
        font-size: 0.8125rem; /* 13px */
        color: var(--text-secondary);
        margin-top: 0.1rem; /* Small space above date */
    }

    .transaction-importance {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        /* margin-left: 5px; -> Replaced by gap in parent */
        vertical-align: middle;
        flex-shrink: 0;
    }
    .transaction-importance.extrema { background-color: var(--importance-extrema); }
    .transaction-importance.urgente { background-color: var(--importance-urgente); }
    .transaction-importance.importante { background-color: var(--importance-importante); }


    /* Botões */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem; /* More padding */
      border-radius: var(--radius-sm);
      font-weight: 600; /* Bolder */
      font-size: 0.9375rem; /* 15px */
      cursor: pointer;
      transition: var(--transition);
      border: none;
      color: #fff;
      background-color: var(--primary);
      text-decoration: none; /* For potential <a> tags */
      white-space: nowrap;
    }

    .btn:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }
    .btn:active {
        transform: translateY(0);
        opacity: 0.75;
    }
     .btn:disabled { /* Style for disabled buttons */
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
     }

    .btn-primary { background-color: var(--primary); }
    .btn-success { background-color: var(--success); }
    .btn-warning { background-color: var(--warning); color: #333; } /* Ensure text contrast */
    .btn-danger { background-color: var(--danger); }
    .btn-secondary {
        background-color: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--border);
    }
     .btn-secondary:hover {
        background-color: var(--hover-bg);
    }

    .btn svg {
        width: 1rem; /* 16px */
        height: 1rem;
        flex-shrink: 0;
    }

    /* Botão toggle theme */
    .theme-toggle {
      background: var(--input-bg);
      border: none;
      border-radius: 50%;
      width: 2.75rem; /* 44px */
      height: 2.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
      flex-shrink: 0; /* Prevent distortion in flex layouts */
    }

    .theme-toggle:hover {
      background-color: var(--hover-bg);
    }

    .theme-toggle svg {
      width: 1.25rem; /* 20px */
      height: 1.25rem;
    }

    /* Select estilo Apple */
    select {
      appearance: none;
      -webkit-appearance: none;
      padding: 0.75rem 2.25rem 0.75rem 1rem; /* More padding */
      height: calc(1.5em + 1.5rem + 2px); /* Consistent height */
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238A8A8E' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E") no-repeat;
      background-position: right 0.875rem center;
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      min-width: 120px; /* Minimum width */
      line-height: 1.5; /* Ensure text is vertically centered */
    }
    [data-theme="dark"] select {
       background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='8' fill='none'%3E%3Cpath fill='%238E8E93' d='M7 8 .938 2 0 1.063 7 0l7 1.063L13.062 2 7 8Z'/%3E%3C/svg%3E");
       background-color: var(--card-bg); /* Ensure dark background */
    }


    select:hover {
      border-color: rgba(60, 60, 67, 0.4);
    }
    select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
    }

    select option {
      background-color: var(--card-bg);
      color: var(--text);
    }


    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6); /* Darker backdrop */
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      padding: 1rem; /* Add padding for small screens */
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-lg); /* Larger radius */
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%; /* Use 100% width */
      max-width: 550px; /* Default max width */
      max-height: calc(100vh - 4rem); /* Limit height with padding */
      overflow: hidden; /* Prevent content overflow before scroll */
      display: flex;
      flex-direction: column;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 0;
    }
    .modal.active .modal-content {
        opacity: 1;
        transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.75rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .modal-title {
      font-size: 1.25rem; /* 20px */
      font-weight: 600;
      margin: 0;
    }

    .modal-close {
      background: var(--input-bg);
      border: none;
      width: 2.25rem; /* 36px */
      height: 2.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: var(--transition);
      flex-shrink: 0;
    }

    .modal-close:hover {
      background-color: var(--hover-bg);
      color: var(--text);
    }
    .modal-close svg { width: 1rem; height: 1rem; flex-shrink: 0; }

    .modal-body {
      padding: 1.75rem;
      overflow-y: auto; /* Enable scroll only for body */
      flex-grow: 1;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }

    .modal-footer {
      padding: 1.25rem 1.75rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      border-top: 1px solid var(--border);
      background-color: rgba(var(--bg-rgb, 249, 249, 251), 0.8); /* Subtle background - use RGB for opacity */
       [data-theme="dark"] & {
           background-color: rgba(var(--bg-rgb, 0, 0, 0), 0.8);
       }
      flex-shrink: 0;
      backdrop-filter: blur(3px); /* Subtle blur on footer */
    }

    /* Formulários dentro do Modal */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .form-grid.single-col {
        grid-template-columns: 1fr;
    }


    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem; /* 14px */
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-control {
      width: 100%;
      padding: 0.875rem 1rem; /* Larger padding */
      font-size: 0.9375rem;
      height: calc(1.5em + 1.75rem + 2px); /* Match select height */
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background-color: var(--input-bg);
      color: var(--text);
      transition: var(--transition);
      font-family: var(--font-sans); /* Ensure consistent font */
       line-height: 1.5; /* Ensure text is vertically centered */
    }
     input[type="color"].form-control { /* Specific height for color input */
        padding: 0.25rem;
        height: calc(1.5em + 1.75rem + 2px);
     }
     input[type="date"].form-control {
         line-height: normal; /* Fix date input vertical alignment */
     }


    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
      background-color: var(--card-bg); /* Change bg on focus */
    }
    textarea.form-control {
        line-height: 1.4;
        min-height: 80px;
        height: auto; /* Allow textarea to grow */
    }

    /* Transaction Modal Specifics */
    #transaction-modal .modal-content { max-width: 500px; } /* Smaller modal */

    .input-group {
        display: flex;
        align-items: center; /* Vertically align items */
    }
    .input-group .form-control {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: none; /* Remove border between */
        flex-grow: 1; /* Allow select to take space */
         height: calc(1.5em + 1.75rem + 2px); /* Explicit height */
    }
    .input-group-append {
        flex-shrink: 0; /* Prevent button from shrinking */
    }
     .input-group-append .btn-icon-small {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        height: calc(1.5em + 1.75rem + 2px); /* Match input height */
        margin-left: -1px; /* Overlap border slightly */
     }


     #advanced-fields {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px dashed var(--border);
        display: none; /* Hidden by default */
        animation: slideDown 0.3s ease-out forwards; /* Use forwards to keep state */
     }
     #advanced-fields.visible {
        display: block;
     }

     @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); max-height: 0; overflow: hidden;}
        to { opacity: 1; transform: translateY(0); max-height: 1000px; /* Adjust as needed */ overflow: visible;}
     }

    .btn-link {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        padding: 0;
        font-size: 0.875rem;
        font-weight: 500;
        text-align: left;
        display: inline-flex; /* Align icon nicely */
        align-items: center;
        gap: 0.25rem;
    }
    .btn-link:hover {
        text-decoration: underline;
    }
     .btn-link svg {
        transition: transform 0.2s ease;
     }
     #advanced-fields.visible + .btn-link svg { /* Style chevron when open */
        transform: rotate(180deg);
     }


    /* Importance Radio Buttons */
    .importance-group {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    .importance-group input[type="radio"] {
        opacity: 0;
        position: fixed;
        width: 0;
    }
    .importance-group label {
        display: inline-block;
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
        font-weight: 500;
        border-left-width: 4px; /* Space for color hint */
        border-left-color: transparent; /* Default no color hint */
        margin-bottom: 0; /* Override default label margin */
    }
    .importance-group input[type="radio"]:checked + label {
        background-color: var(--primary);
        color: #fff;
        border-color: var(--primary);
    }
    .importance-group input[type="radio"]:focus-visible + label { /* Use focus-visible */
         box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
         outline: none;
    }
     /* Color hints for importance */
    .importance-group label[for="importance-extrema"] { border-left-color: var(--importance-extrema); }
    .importance-group label[for="importance-urgente"] { border-left-color: var(--importance-urgente); }
    .importance-group label[for="importance-importante"] { border-left-color: var(--importance-importante); }

    .importance-group input[type="radio"]:checked + label[for="importance-extrema"] { background-color: var(--importance-extrema); border-color: var(--importance-extrema); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-urgente"] { background-color: var(--importance-urgente); border-color: var(--importance-urgente); color: #fff;}
    .importance-group input[type="radio"]:checked + label[for="importance-importante"] { background-color: var(--importance-importante); border-color: var(--importance-importante); color: #333; } /* Yellow needs dark text */


    /* Category Modal Specifics */
    #category-modal .modal-content { max-width: 400px; }

    /* Confirm Modal Specifics */
    #confirm-modal .modal-content { max-width: 450px; } /* Slightly wider for radio buttons */
    #confirm-modal-message { margin-bottom: 1rem; line-height: 1.4; font-weight: 500; }
    #confirm-modal-extra-info { margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary); }
    #confirm-modal-extra-info label { display: block; margin-bottom: 0.75rem; cursor: pointer; } /* Make label clickable */
    #confirm-modal-extra-info input[type="radio"] { margin-right: 0.5rem; accent-color: var(--primary); }


    /* Loading Estado */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loading-indicator.active {
      opacity: 1;
      pointer-events: all;
    }

    .spinner {
      width: 2.5rem; /* 40px */
      height: 2.5rem;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite; /* Use linear for smoother spin */
    }
    [data-theme="dark"] .spinner {
        border-color: rgba(255, 255, 255, 0.1); /* Darker base */
        border-top-color: #aaa; /* Lighter top */
    }


    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Alertas / Toast Notifications */
    .toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 1050;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.75rem;
    }

    .toast {
        background-color: var(--card-bg);
        color: var(--text);
        padding: 0.875rem 1.25rem;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-dropdown);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        min-width: 250px;
        max-width: 400px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000); /* EaseOutBack */
        border-left: 4px solid var(--primary); /* Default */
    }

    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }

    .toast-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .toast.success { border-left-color: var(--success); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.danger { border-left-color: var(--danger); }
    .toast.info { border-left-color: var(--primary); }


    /* Responsividade */
    @media (max-width: 1200px) {
        .analysis-content {
            grid-template-columns: 1fr; /* Stack sidebar below */
        }
        .analysis-sidebar {
            grid-row: 2; /* Move sidebar down */
        }
    }

    @media (max-width: 992px) {
      .container { padding: 1.5rem; }
      .header { flex-direction: column; align-items: flex-start; }
      .header-right { width: 100%; justify-content: space-between; }
      .charts-grid { grid-template-columns: 1fr; } /* Single column charts */
      .chart-container { height: 260px; }
      .full-width .chart-container { height: 300px; }
       .analysis-header, .filters { gap: 1rem; } /* Reduce gap */
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.625rem; } /* 26px */
      .kpis { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .analysis-indicators { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
      .btn { padding: 0.625rem 1.25rem; font-size: 0.875rem; }
      select, .form-control, .btn-icon-small { height: calc(1.5em + 1.25rem + 2px); } /* Slightly smaller height */
      select { padding: 0.625rem 2rem 0.625rem 0.875rem; font-size: 0.875rem; }
      .form-grid { grid-template-columns: 1fr; } /* Stack form fields */
      .transaction-item { flex-direction: column; align-items: flex-start; gap: 0.25rem; padding: 0.75rem 0.75rem 0.75rem 0; }
      .transaction-item-left { width: 100%; }
      .transaction-item-right { text-align: left; margin-top: 0.25rem; width: 100%; display: flex; justify-content: space-between; align-items: center; padding-left: 0; }
      .transaction-list { padding: 0 0.5rem 0 1rem; }
      .modal-content { width: 95%; max-height: calc(100vh - 2rem); } /* Adjust modal height */
      .modal-body, .modal-header, .modal-footer { padding: 1.25rem; }
      .tabs { margin-bottom: 1.5rem; }
      .tab { padding: 0.75rem 1rem; font-size: 0.875rem; }
      .analysis-content { grid-template-columns: 1fr; gap: 1.5rem; }
      .analysis-sidebar { order: 1; } /* Move insights above list on mobile */
      .analysis-main { order: 2; }
    }

    @media (max-width: 576px) {
        .container { padding: 1rem; }
        h1 { font-size: 1.5rem; } /* 24px */
        .kpis { grid-template-columns: 1fr; }
        .analysis-indicators { grid-template-columns: 1fr; }
        .header-right { flex-direction: column; align-items: stretch; gap: 0.75rem; }
        .analysis-header { padding-bottom: 1rem; margin-bottom: 1rem;}
        .filters { flex-direction: column; align-items: stretch; gap: 0.75rem; }
        .filter-group { width: 100%; }
        select { width: 100%; }
        .category-filter-group { width: 100%; }
        .category-filter-group select { flex-grow: 1; }
        .header-right .btn { width: 100%; }
        .theme-toggle { align-self: flex-end; margin-top: 0.5rem; } /* Corrected mobile theme toggle position */
        .importance-group { gap: 0.25rem; } /* Tighter gap */
        .importance-group label { padding: 0.4rem 0.8rem; }
        .toast-container { right: 1rem; bottom: 1rem; left: 1rem; align-items: stretch; }
        .toast { width: 100%; }
        .transaction-description { font-size: 0.875rem;}
        .transaction-amount { font-size: 0.875rem;}
        .transaction-item:hover .transaction-item-right { padding-right: 2.5rem; } /* Ensure padding works */
        .transaction-item .delete-transaction-btn { right: 0.5rem; } /* Adjust delete button position */
    }

    /* Print styles */
    @media print {
        body { background-color: #fff; color: #000; }
        .header, .tabs, .theme-toggle, .btn, .modal, .loading-indicator, .toast-container, .analysis-sidebar, .delete-transaction-btn { display: none !important; }
        .container { max-width: 100%; padding: 0; }
        .card, .kpi-card, .indicator-card, .transaction-list-container, .insights-feed {
            box-shadow: none;
            border: 1px solid #ddd;
            border-radius: 0;
            padding: 1rem;
            page-break-inside: avoid;
            background-color: #fff !important;
        }
        .kpis, .charts-grid, .analysis-indicators, .analysis-content, .analysis-main { grid-template-columns: 1fr !important; gap: 1rem; }
        canvas { max-width: 100%; }
        select { border: none; appearance: none; -webkit-appearance: none; padding-right: 1rem; background: none; }
        .transaction-item { border-bottom: 1px solid #eee; }
        .transaction-item:hover { background-color: transparent; margin: 0; padding: 1rem 0; border-radius: 0; }
        .transaction-item-right { padding-right: 0 !important; } /* Remove extra padding for print */

        :root { /* Override colors for print */
            --text: #000;
            --text-secondary: #555;
            --success: #008000;
            --danger: #D00000;
            --primary: #0000FF;
            --warning: #FFA500;
            --bg: #fff;
            --card-bg: #fff;
            --input-bg: #eee;
        }
        .indicator-value.positive, .kpi-trend.up, .transaction-amount.income { color: var(--success) !important; }
        .indicator-value.negative, .kpi-trend.down, .transaction-amount.expense { color: var(--danger) !important; }
        .progress-bar { background-color: #ccc !important; } /* Simple progress bar */
    }

  </style>
</head>
<body>
    <!-- O HTML é idêntico à versão anterior, exceto pela modificação nos filtros -->
    <!-- HTML (Header, Tabs, Abas, Modais) -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>Calculadora Financeira</h1>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" id="btn-new-transaction">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Nova Transação
                </button>
                <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                         <!-- Icon updated by JS -->
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tabs de Navegação -->
        <div class="tabs">
            <div class="tab active" data-tab="overview">Visão Geral</div>
            <div class="tab" data-tab="analysis">Análise Mensal</div>
        </div>

        <!-- Conteúdo das Tabs -->
        <div id="tab-contents">
            <!-- Aba Visão Geral -->
             <div class="tab-content active" id="tab-overview">
                <!-- KPIs -->
                <div class="kpis">
                    <div class="card kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-title">Saldo Atual</div>
                             <div class="kpi-icon">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                                     <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3.21l-1.854 1.113a.5.5 0 0 0 .375.926l2.146-.858A.5.5 0 0 0 9.5 8.5v-4z"/>
                                 </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpi-balance">R$ 0,00</div>
                        <div class="kpi-footer">
                            <div class="kpi-trend neutral" id="balance-trend-indicator">
                                <svg viewBox="0 0 24 24" width="14" height="14">
                                    <path class="neutral-path" stroke="currentColor" stroke-width="2.5" fill="none" d="M4 12 L20 12"></path>
                                </svg>
                                <span id="balance-trend">--%</span>
                            </div>
                            <span>vs. mês anterior</span>
                        </div>
                    </div>

                    <div class="card kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-title">Receitas (Mês)</div>
                            <div class="kpi-icon" style="color: var(--success);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div>
                        <div class="kpi-footer">
                            <div class="kpi-trend neutral" id="income-trend-indicator">
                                 <svg viewBox="0 0 24 24" width="14" height="14">
                                      <path class="neutral-path" stroke="currentColor" stroke-width="2.5" fill="none" d="M4 12 L20 12"></path>
                                 </svg>
                                <span id="income-trend">--%</span>
                            </div>
                            <span>vs. mês anterior</span>
                        </div>
                    </div>

                    <div class="card kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-title">Despesas (Mês)</div>
                            <div class="kpi-icon" style="color: var(--danger);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                                </svg>
                             </div>
                        </div>
                        <div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div>
                        <div class="kpi-footer">
                            <div class="kpi-trend neutral" id="expenses-trend-indicator">
                                 <svg viewBox="0 0 24 24" width="14" height="14">
                                      <path class="neutral-path" stroke="currentColor" stroke-width="2.5" fill="none" d="M4 12 L20 12"></path>
                                 </svg>
                                <span id="expenses-trend">--%</span>
                            </div>
                            <span>vs. mês anterior</span>
                        </div>
                    </div>

                     <div class="card kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-title">Economia do Mês</div>
                             <div class="kpi-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                                     <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-8.5 3a.5.5 0 0 1-1 0V5.707L5.354 6.854a.5.5 0 1 1-.708-.708l2.5-2.5a.5.5 0 0 1 .708 0l2.5 2.5a.5.5 0 0 1-.708.708L8.5 5.707V11z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpi-savings">R$ 0,00</div>
                         <div class="progress-container">
                            <div class="progress-bar" id="savings-progress" style="width: 0%"></div>
                        </div>
                        <div class="kpi-footer">
                            <span id="savings-status">Calculando...</span>
                        </div>
                    </div>

                     <div class="card kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-title">Projeção de Gastos (Mês)</div>
                            <div class="kpi-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                                     <path d="M5.5 10.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5z"/>
                                     <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"/>
                                     <path d="M2.5 4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5V4z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpi-projection">R$ 0,00</div>
                        <div class="kpi-footer">
                             <span id="projection-status">--</span>
                        </div>
                    </div>
                </div> <!-- Fim KPIs -->

                 <!-- Gráficos Visão Geral -->
                 <div class="charts-grid">
                    <!-- Gráficos aqui... -->
                     <div class="card">
                         <div class="chart-title">
                             <span>Receitas vs Despesas (Últimos 12 Meses)</span>
                         </div>
                         <div class="chart-container">
                             <canvas id="overview-income-expense-chart"></canvas>
                         </div>
                     </div>
                     <div class="card">
                         <div class="chart-title">
                             <span>Despesas por Categoria (Últimos 30 dias)</span>
                         </div>
                         <div class="chart-container">
                             <canvas id="overview-category-chart"></canvas>
                         </div>
                     </div>
                     <div class="card full-width">
                         <div class="chart-title">
                             <span>Fluxo de Caixa Mensal (Ano Atual)</span>
                         </div>
                         <div class="chart-container">
                             <canvas id="overview-cashflow-chart"></canvas>
                         </div>
                     </div>
                     <div class="card">
                         <div class="chart-title">
                             <span>Fixas vs Variáveis (Mês Atual)</span>
                         </div>
                         <div class="chart-container">
                             <canvas id="overview-fixed-variable-chart"></canvas>
                         </div>
                     </div>
                     <div class="card">
                         <div class="chart-title">
                             <span>Tendência Geral de Gastos (Últimos 6 Meses)</span>
                         </div>
                         <div class="chart-container">
                             <canvas id="overview-trend-chart"></canvas>
                         </div>
                     </div>
                 </div>
             </div> <!-- Fim #tab-overview -->


            <!-- Aba Análise Mensal -->
            <div class="tab-content" id="tab-analysis">
                <!-- Filtros Inteligentes -->
                <div class="analysis-header">
                    <div class="filters">
                        <!-- Filtro de Ano -->
                        <div class="filter-group">
                             <label for="analysis-year">Ano</label>
                             <select id="analysis-year">
                                 <!-- Anos carregados via JS -->
                             </select>
                         </div>
                         <!-- Filtro de Mês -->
                        <div class="filter-group">
                            <label for="analysis-month">Mês</label>
                            <select id="analysis-month">
                                <!-- Meses carregados via JS -->
                            </select>
                        </div>
                         <!-- Filtro de Categoria -->
                        <div class="filter-group">
                            <label for="analysis-category">Categoria</label>
                            <div class="category-filter-group">
                                <select id="analysis-category">
                                    <option value="all">Todas as Categorias</option>
                                    <!-- Categorias carregadas via JS -->
                                </select>
                                <button class="btn-icon-small" id="btn-add-category" title="Nova Categoria">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                    </svg>
                                </button>
                                <button class="btn-icon-small btn-delete-category" id="btn-delete-category" title="Excluir Categoria Selecionada" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                         <!-- Filtro de Importância -->
                        <div class="filter-group">
                             <label for="analysis-importance">Importância</label>
                             <select id="analysis-importance">
                                 <option value="all">Todas</option>
                                 <option value="extrema">Extrema</option>
                                 <option value="urgente">Urgente</option>
                                 <option value="importante">Importante</option>
                                 <option value="none">Nenhuma</option> <!-- Opção para sem importância -->
                             </select>
                         </div>
                    </div>
                </div>

                 <!-- Indicadores -->
                 <div class="analysis-indicators">
                     <!-- Indicadores aqui... -->
                     <div class="indicator-card">
                         <div class="indicator-title">Receitas Totais</div>
                         <div class="indicator-value positive" id="analysis-total-income">R$ 0,00</div>
                         <div class="indicator-comparison" id="analysis-income-comparison">-- vs mês anterior</div>
                     </div>
                     <div class="indicator-card">
                         <div class="indicator-title">Despesas Totais</div>
                         <div class="indicator-value negative" id="analysis-total-expenses">R$ 0,00</div>
                         <div class="indicator-comparison" id="analysis-expense-comparison">-- vs mês anterior</div>
                     </div>
                     <div class="indicator-card">
                         <div class="indicator-title">Saldo Final</div>
                         <div class="indicator-value neutral" id="analysis-final-balance">R$ 0,00</div>
                         <div class="indicator-comparison" id="analysis-balance-comparison">-- vs mês anterior</div>
                     </div>
                     <div class="indicator-card">
                         <div class="indicator-title">Status do Mês</div>
                         <div class="indicator-value neutral" id="analysis-month-status">--</div>
                         <div class="indicator-comparison" id="analysis-days-left">-- dias restantes</div>
                     </div>
                     <div class="indicator-card">
                         <div class="indicator-title">Maior Gasto</div>
                         <div class="indicator-value neutral" id="analysis-top-category">--</div>
                         <div class="indicator-comparison" id="analysis-top-category-value">R$ 0,00</div>
                     </div>
                 </div>

                 <!-- Conteúdo Principal e Sidebar -->
                <div class="analysis-content">
                     <!-- Conteúdo Principal -->
                     <div class="analysis-main">
                          <!-- Gráficos -->
                         <div class="charts-grid">
                              <div class="card">
                                 <div class="chart-title">Distribuição de Despesas</div>
                                 <div class="chart-container">
                                     <canvas id="analysis-category-pie-chart"></canvas>
                                 </div>
                             </div>
                             <div class="card">
                                 <div class="chart-title">Evolução do Saldo no Mês</div>
                                 <div class="chart-container">
                                     <canvas id="analysis-balance-line-chart"></canvas>
                                 </div>
                             </div>
                         </div>
                          <!-- Lista Transações -->
                         <div class="transaction-list-container">
                             <div class="transaction-list-title">Transações do Mês</div>
                             <div id="analysis-transaction-list" class="transaction-list">
                                 <div id="analysis-no-transactions" style="display: block; text-align: center; padding: 2rem 1.5rem; color: var(--text-secondary);">
                                     Nenhuma transação encontrada para este período/filtros.
                                 </div>
                                 <!-- Itens carregados via JS -->
                             </div>
                         </div>
                     </div>
                     <!-- Sidebar -->
                     <aside class="analysis-sidebar">
                         <div class="insights-feed card">
                             <div class="insights-title">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                      <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                  </svg>
                                 Insights Rápidos
                             </div>
                             <div class="insights-list" id="analysis-insights-list">
                                  <div id="analysis-no-insights" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
                                     Analisando seus dados...
                                 </div>
                                 <!-- Insights carregados via JS -->
                             </div>
                         </div>
                     </aside>
                 </div>
             </div> <!-- Fim #tab-analysis -->
        </div> <!-- Fim #tab-contents -->
    </div> <!-- Fim .container -->

     <!-- Modais -->
     <!-- Modal Nova Transação -->
     <div class="modal" id="transaction-modal">
        <div class="modal-content">
            <form id="transaction-form">
                <!-- Conteúdo do formulário (inalterado) -->
                 <input type="hidden" id="transaction-id">
                 <input type="hidden" id="transaction-recurring-base-id">
                 <div class="modal-header">
                     <h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3>
                     <button type="button" class="modal-close" data-dismiss="modal">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
                     </button>
                 </div>
                 <div class="modal-body">
                     <!-- Campos Essenciais -->
                     <div class="form-group">
                         <label for="transaction-amount">Valor (R$)</label>
                         <input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required>
                     </div>
                     <div class="form-group">
                         <label for="transaction-category">Categoria</label>
                         <div class="input-group">
                             <select class="form-control" id="transaction-category" required></select>
                             <div class="input-group-append">
                                 <button type="button" class="btn-icon-small" id="btn-add-category-modal" title="Nova Categoria"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                             </div>
                         </div>
                     </div>
                     <div class="form-grid">
                         <div class="form-group">
                             <label for="transaction-date">Data</label>
                             <input type="date" class="form-control" id="transaction-date" required>
                         </div>
                         <div class="form-group">
                             <label for="transaction-type">Tipo</label>
                             <select class="form-control" id="transaction-type" required>
                                 <option value="expense" selected>Despesa</option>
                                 <option value="income">Receita</option>
                             </select>
                         </div>
                     </div>
                     <div class="form-group">
                         <label>Importância</label>
                         <div class="importance-group">
                             <input type="radio" id="importance-extrema" name="transaction-importance" value="extrema"><label for="importance-extrema">Extrema</label>
                             <input type="radio" id="importance-urgente" name="transaction-importance" value="urgente"><label for="importance-urgente">Urgente</label>
                             <input type="radio" id="importance-importante" name="transaction-importance" value="importante"><label for="importance-importante">Importante</label>
                         </div>
                     </div>
                      <button type="button" class="btn-link" id="btn-toggle-advanced" style="margin-top: 1rem;">
                         Mostrar opções avançadas
                         <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                      </button>
                     <!-- Campos Avançados -->
                     <div id="advanced-fields">
                         <!-- Conteúdo dos campos avançados (inalterado) -->
                         <div class="form-group"><label for="transaction-description">Descrição <small>(Opcional)</small></label><input type="text" class="form-control" id="transaction-description" placeholder="Ex: Supermercado da semana, Salário..."></div>
                         <div class="form-grid"><div class="form-group"><label for="transaction-status">Status</label><select class="form-control" id="transaction-status" required><option value="paid" selected>Pago</option><option value="pending">Pendente</option><option value="scheduled">Agendado</option></select></div><div class="form-group"><label for="transaction-payment-method">Forma de Pagamento</label><select class="form-control" id="transaction-payment-method"><option value="">Nenhuma</option><option value="cash">Dinheiro</option><option value="credit_card">Cartão de Crédito</option><option value="debit_card">Cartão de Débito</option><option value="bank_transfer">Transferência</option><option value="pix">PIX</option><option value="boleto">Boleto</option><option value="other">Outro</option></select></div></div>
                         <div class="form-group"><label for="transaction-notes">Observações</label><textarea class="form-control" id="transaction-notes" rows="3" placeholder="Ex: Parcela 2/12, Referente ao projeto X..."></textarea></div>
                         <div id="recurring-transaction-container"><div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;"><input type="checkbox" id="transaction-recurring" style="width: auto; height: auto; transform: scale(1.2);"><label for="transaction-recurring" style="margin-bottom: 0; font-weight: 500;">É uma transação recorrente? (Ex: Aluguel, Parcela)</label></div><div id="recurring-options" style="display: none;"><div class="form-grid"><div class="form-group"><label for="transaction-frequency">Frequência</label><select class="form-control" id="transaction-frequency"><option value="daily">Diária</option><option value="weekly">Semanal</option><option value="biweekly">Quinzenal</option><option value="monthly" selected>Mensal</option><option value="bimonthly">Bimestral</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="annual">Anual</option></select></div><div class="form-group"><label for="transaction-installments">Número de Parcelas</label><input type="number" min="2" step="1" class="form-control" id="transaction-installments" placeholder="Ex: 12"><small style="color: var(--text-secondary); font-size: 0.75rem;">Deixe em branco se for contínuo (sem fim).</small></div></div><div id="edit-recurring-options" style="margin-top:1rem; padding: 1rem; background-color: var(--input-bg); border-radius: var(--radius-sm); display: none;"><p style="font-weight: 500; margin-bottom: 0.5rem;">Editando transação recorrente:</p><div style="display: flex; flex-direction: column; gap: 0.5rem;"><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="this" checked> Aplicar somente a esta ocorrência</label><label style="font-size: 0.875rem;"><input type="radio" name="edit-recurring-scope" value="future"> Aplicar a esta e futuras ocorrências</label></div></div></div></div>
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                     <button type="submit" class="btn btn-primary" id="transaction-modal-save">Salvar Transação</button>
                 </div>
             </form>
        </div>
    </div>

     <!-- Modal Nova Categoria -->
     <div class="modal" id="category-modal">
         <div class="modal-content">
             <form id="category-form">
                  <!-- Conteúdo do formulário (inalterado) -->
                  <div class="modal-header"><h3 class="modal-title" id="category-modal-title">Nova Categoria</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div>
                  <div class="modal-body"><div class="form-group"><label for="category-name">Nome da Nova Categoria</label><input type="text" class="form-control" id="category-name" placeholder="Ex: Assinaturas, Educação Filhos" required></div><div class="form-group"><label for="category-type">Tipo de Categoria</label><select class="form-control" id="category-type" required><option value="expense" selected>Despesa</option><option value="income">Receita</option></select></div><div class="form-group"><label for="category-icon">Ícone (Emoji)</label><input type="text" class="form-control" id="category-icon" placeholder="Ex: 🎓, 🚗" maxlength="2"></div><div class="form-group"><label for="category-color">Cor</label><input type="color" class="form-control" id="category-color" value="#8A8A8E"></div></div>
                  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="category-modal-save">Salvar Categoria</button></div>
             </form>
         </div>
     </div>

     <!-- Modal Confirmação -->
     <div class="modal" id="confirm-modal">
          <div class="modal-content">
             <!-- Conteúdo do modal (inalterado) -->
               <div class="modal-header"><h3 class="modal-title" id="confirm-modal-title">Confirmação</h3><button type="button" class="modal-close" data-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg></button></div>
               <div class="modal-body"><p id="confirm-modal-message">Tem certeza que deseja realizar esta ação?</p><div id="confirm-modal-extra-info"></div></div>
               <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button></div>
          </div>
     </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
    // ===== Configurações Globais e Firebase =====
    // ... (Firebase config, inicialização, coleções - inalterado) ...
    const root = document.documentElement;
    const loading = document.getElementById('loading');
    moment.locale('pt-br');

    const firebaseConfig = { /* ... */ }; // Sua config aqui
    let app;
    let db;
     try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase inicializado com sucesso!");
    } catch (error) {
        console.error("Erro ao inicializar Firebase:", error);
        // showToast não está definido ainda, usar alert como fallback
        alert("Erro crítico ao conectar com o banco de dados. A aplicação pode não funcionar corretamente.");
    }
    const transactionsCollection = db?.collection('transactions');
    const categoriesCollection = db?.collection('categories');


    // ===== Estados da Aplicação =====
    let transactions = [];
    let categories = [];
    let currentTab = 'overview';
    let currentAnalysisMonth = moment().month(); // 0-11
    let currentAnalysisYear = moment().year();
    let currentAnalysisCategory = 'all';
    let currentAnalysisImportance = 'all'; // Novo estado para filtro de importância
    let unsubscribeTransactions = null;
    let unsubscribeCategories = null;
    let isUpdatingAnalysis = false; // Flag para evitar múltiplas atualizações

    // ===== Constantes e Mapas =====
    // ... (TRANSACTION_TYPES, PAYMENT_METHODS, etc. - inalterado) ...
    const TRANSACTION_TYPES = {
      income: { name: 'Receita', icon: '💰', colorClass: 'positive' },
      expense: { name: 'Despesa', icon: '💸', colorClass: 'negative' }
    };
    const PAYMENT_METHODS = { /* ... */ };
    const TRANSACTION_STATUS = { /* ... */ };
    const RECURRENCE_FREQUENCY = { /* ... */ };
    const DEFAULT_EXPENSE_CATEGORIES = [ /* ... */ ];
    const DEFAULT_INCOME_CATEGORIES = [ /* ... */ ];

    // ===== Utilitários =====
    // ... (formatCurrency, formatDate, etc. - inalterado) ...
    const formatCurrency = (value) => value?.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) ?? 'R$ 0,00';
    const formatDate = (dateString) => dateString ? moment(dateString).format('DD/MM/YYYY') : '--';
    const formatDateForInput = (date = new Date()) => moment(date).format('YYYY-MM-DD');
    const showLoading = () => loading.classList.add('active');
    const hideLoading = () => loading.classList.remove('active');
    function showToast(message, type = 'info', duration = 3000) { /* ... (Implementação inalterada) ... */ }
    function updateThemeIcon(theme) { /* ... (Implementação inalterada) ... */ }
    function setupTheme() { /* ... (Implementação inalterada) ... */ }
    function toggleTheme() { /* ... (Implementação inalterada) ... */ }


    // ===== Gerenciamento de Dados (Firestore) =====
    // ... (loadCategories, addCategory, deleteCategory, process...Snapshot, setup/stop Listeners - inalterados) ...
     async function loadCategories() { /* ... */ }
     async function addCategory(name, type, icon, color) { /* ... */ }
     async function deleteCategory(categoryId) { /* ... */ }
     function processTransactionSnapshot(snapshot) { /* ... */ }
     function processCategorySnapshot(snapshot) { /* ... */ }
     function setupFirestoreListeners() { /* ... */ }
     function stopFirestoreListeners() { /* ... */ }

    // ===== Lógica de Transações =====
    // ... (openTransactionModal, saveTransaction, generateFutureInstallments, deleteTransaction - inalterados) ...
    function openTransactionModal(transaction = null) { /* ... */ }
    async function saveTransaction(event) { /* ... */ }
    async function generateFutureInstallments(batch, baseData, baseId, frequency, totalInstallments, startDate, startInstallmentNum) { /* ... */ }
    async function deleteTransaction(transactionId, recurringBaseId = null, deleteScope = 'this') { /* ... */ }

    // ===== Interface e Interação =====

    // ... (openModal, closeModal - inalterados) ...
    function openModal(modalElement) { /* ... */ }
    function closeModal(modalElement) { /* ... */ }

    // Inicializar Navegação por Tabs (Com gestão de loading aprimorada)
    function initTabs() {
        const tabLinks = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabLinks.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTabId = tab.dataset.tab;
                if (currentTab === targetTabId || isUpdatingAnalysis) return; // Previne clique na aba ativa ou durante atualização

                showLoading(); // Mostra loading imediatamente

                // Remove 'active' de todas as tabs e conteúdos
                tabLinks.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // Adiciona 'active' à tab clicada e ao conteúdo correspondente
                tab.classList.add('active');
                const targetContent = document.getElementById(`tab-${targetTabId}`);
                if(targetContent) targetContent.classList.add('active');

                currentTab = targetTabId;

                // Atualiza o conteúdo da tab selecionada de forma assíncrona
                setTimeout(async () => { // Tornar a função interna async
                    try {
                        if (targetTabId === 'analysis') {
                             // A própria updateMonthlyAnalysis gerencia seu loading agora
                             await updateMonthlyAnalysis(); // Espera a análise concluir
                        } else {
                            updateOverviewCharts();
                            updateKPIs();
                        }
                    } catch (error) {
                        console.error(`Erro ao atualizar a aba ${targetTabId}:`, error);
                        showToast("Ocorreu um erro ao carregar os dados desta aba.", "danger");
                    } finally {
                         // Garante que o loading seja escondido, mesmo se updateMonthlyAnalysis
                         // já o escondeu, não há problema em chamar de novo.
                         hideLoading();
                    }
                }, 50); // Pequeno delay para permitir a UI atualizar antes de processar
            });
        });
    }


    // Popular selects de categoria (Inalterado)
    function populateCategoryFilters() { /* ... */ }
    // Popular select de categoria no Modal de Transação (Inalterado)
    function populateCategorySelect(type = 'expense') { /* ... */ }
    // Habilitar/desabilitar botão de excluir categoria (Inalterado)
    function toggleDeleteCategoryButton() { /* ... */ }

    // Popular selects de Mês e Ano para Análise (Inalterado - já estava separado)
    function populateMonthYearFilter() { /* ... */ }

    // Setup dos Event Listeners (Adicionado listener para Importance)
    function setupEventListeners() {
        // Botão Nova Transação
        document.getElementById('btn-new-transaction').addEventListener('click', () => openTransactionModal());

        // Toggle Tema
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

        // Modal de Transação
        // document.getElementById('transaction-modal-close').addEventListener('click', () => closeModal(document.getElementById('transaction-modal'))); -> Removido, usa data-dismiss
        // document.getElementById('transaction-modal-cancel').addEventListener('click', () => closeModal(document.getElementById('transaction-modal'))); -> Removido, usa data-dismiss
        document.getElementById('transaction-form').addEventListener('submit', saveTransaction);
        document.getElementById('transaction-type').addEventListener('change', (e) => populateCategorySelect(e.target.value)); // Atualiza categorias no modal
        document.getElementById('btn-toggle-advanced').addEventListener('click', toggleAdvancedFields);
        document.getElementById('transaction-recurring').addEventListener('change', (e) => {
            document.getElementById('recurring-options').style.display = e.target.checked ? 'block' : 'none';
        });

        // Filtros Análise Mensal
        document.getElementById('analysis-month').addEventListener('change', (e) => {
            currentAnalysisMonth = parseInt(e.target.value);
             if (!isUpdatingAnalysis) updateMonthlyAnalysis(); // Só atualiza se não estiver atualizando
        });
        document.getElementById('analysis-year').addEventListener('change', (e) => {
            currentAnalysisYear = parseInt(e.target.value);
             if (!isUpdatingAnalysis) updateMonthlyAnalysis(); // Só atualiza se não estiver atualizando
        });
        document.getElementById('analysis-category').addEventListener('change', (e) => {
            currentAnalysisCategory = e.target.value;
            toggleDeleteCategoryButton();
             if (!isUpdatingAnalysis) updateMonthlyAnalysis(); // Só atualiza se não estiver atualizando
        });
         // NOVO: Listener para filtro de importância
         document.getElementById('analysis-importance').addEventListener('change', (e) => {
            currentAnalysisImportance = e.target.value;
             if (!isUpdatingAnalysis) updateMonthlyAnalysis(); // Só atualiza se não estiver atualizando
         });

         // Gerenciamento de Categorias
         document.getElementById('btn-add-category').addEventListener('click', () => openCategoryModal());
         document.getElementById('btn-add-category-modal').addEventListener('click', () => openCategoryModal()); // Botão dentro do modal de transação
         document.getElementById('btn-delete-category').addEventListener('click', () => {
            const categoryId = document.getElementById('analysis-category').value;
            if (categoryId && categoryId !== 'all') {
                confirmDeleteCategory(categoryId);
            }
        });
         document.getElementById('category-form').addEventListener('submit', handleSaveCategory);

          // Fechar Modais (Genérico)
         document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
            btn.addEventListener('click', () => {
                 const modalToClose = btn.closest('.modal');
                 if (modalToClose) {
                     closeModal(modalToClose);
                 }
             });
         });

         // Modal de Confirmação
         document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
             const action = document.getElementById('confirm-modal-confirm')._action;
             if (action && typeof action === 'function') {
                 action(); // Executa a ação definida dinamicamente
             } else {
                 console.warn("Nenhuma ação definida para confirmação.");
                 closeModal(document.getElementById('confirm-modal'));
             }
         });
    }


    // Mostrar/Ocultar campos avançados no modal de transação (Inalterado)
    function toggleAdvancedFields() { /* ... */ }
    // Abrir Modal Nova Categoria (Inalterado)
    function openCategoryModal() { /* ... */ }
    // Salvar Categoria (Handler do form) (Inalterado)
    async function handleSaveCategory(event) { /* ... */ }
    // Confirmar Exclusão de Categoria (Inalterado)
    function confirmDeleteCategory(categoryId) { /* ... */ }
    // Confirmar Exclusão de Transação (Inalterado)
    function confirmDeleteTransaction(transactionId) { /* ... */ }


    // ===== Atualização da UI =====

    // Atualizar Dashboard Completo (Inalterado)
    function updateDashboard() { /* ... */ }
    // Atualizar KPIs da Visão Geral (Refinado no CSS)
    function updateKPIs() {
         // ... (Lógica de cálculo inalterada) ...
         const totalIncome = transactions.filter(t => t.type === 'income' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0);
         const totalExpenses = transactions.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0);
         const currentBalance = totalIncome - totalExpenses;
         document.getElementById('kpi-balance').textContent = formatCurrency(currentBalance);

         const currentMonthStart = moment().startOf('month');
         const currentMonthEnd = moment().endOf('month');
         const currentMonthIncome = transactions.filter(t => t.type === 'income' && moment(t.date).isBetween(currentMonthStart, currentMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0);
         const currentMonthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(currentMonthStart, currentMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0);
         document.getElementById('kpi-income').textContent = formatCurrency(currentMonthIncome);
         document.getElementById('kpi-expenses').textContent = formatCurrency(currentMonthExpenses);

         const currentMonthSavings = currentMonthIncome - currentMonthExpenses;
         const savingsEl = document.getElementById('kpi-savings');
         savingsEl.textContent = formatCurrency(currentMonthSavings);
         savingsEl.style.color = currentMonthSavings >= 0 ? 'var(--success)' : 'var(--danger)';

         const savingsProgress = document.getElementById('savings-progress');
         const savingsStatus = document.getElementById('savings-status');
         let savingsPercentage = 0;
         if (currentMonthIncome > 0) {
             savingsPercentage = Math.max(0, (currentMonthSavings / currentMonthIncome) * 100);
             savingsProgress.style.width = `${savingsPercentage}%`;
             savingsProgress.className = `progress-bar ${currentMonthSavings >= 0 ? 'success' : 'danger'}`;
             savingsStatus.textContent = `${currentMonthSavings >= 0 ? 'Positiva' : 'Negativa'} (${savingsPercentage.toFixed(0)}% da receita)`;
         } else {
              savingsProgress.style.width = '0%';
              savingsProgress.className = 'progress-bar';
              savingsStatus.textContent = currentMonthExpenses > 0 ? 'Apenas despesas' : 'Sem movimentação';
         }

         const scheduledExpenses = transactions.filter(t => t.type === 'expense' && t.status !== 'paid' && moment(t.date).isBetween(currentMonthStart, currentMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0);
         const projectedExpenses = currentMonthExpenses + scheduledExpenses;
         document.getElementById('kpi-projection').textContent = formatCurrency(projectedExpenses);
         document.getElementById('projection-status').textContent = `Realizado: ${formatCurrency(currentMonthExpenses)} | Previsto: ${formatCurrency(scheduledExpenses)}`;

         const lastMonthStart = moment().subtract(1, 'month').startOf('month');
         const lastMonthEnd = moment().subtract(1, 'month').endOf('month');
         const lastMonthIncome = transactions.filter(t => t.type === 'income' && moment(t.date).isBetween(lastMonthStart, lastMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0);
         const lastMonthExpenses = transactions.filter(t => t.type === 'expense' && moment(t.date).isBetween(lastMonthStart, lastMonthEnd, 'day', '[]')).reduce((sum, t) => sum + t.amount, 0);
         const lastMonthBalance = lastMonthIncome - lastMonthExpenses;

         const updateTrend = (current, previous, elementId, indicatorElementId) => {
             const trendElement = document.getElementById(elementId);
             const indicatorElement = document.getElementById(indicatorElementId);
             const svgElement = indicatorElement.querySelector('svg'); // Pega o SVG
             let percentage = 0;
             let trendClass = 'neutral';
             let iconPath = 'M4 12 L20 12'; // Traço (neutral)

             if (previous !== 0) {
                 percentage = ((current - previous) / Math.abs(previous)) * 100;
             } else if (current !== 0) {
                 percentage = 100 * Math.sign(current);
             }

             const isExpense = elementId.includes('expenses');
              if (percentage > 0.1) { // Use small threshold to avoid showing arrow for tiny changes
                 trendClass = isExpense ? 'down' : 'up';
                 iconPath = 'M12 4 L20 12 L4 12 Z'; // Seta para cima (triângulo)
              } else if (percentage < -0.1) {
                 trendClass = isExpense ? 'up' : 'down';
                  iconPath = 'M12 20 L4 12 L20 12 Z'; // Seta para baixo (triângulo)
              }

             trendElement.textContent = `${Math.abs(percentage).toFixed(0)}%`;
             indicatorElement.className = `kpi-trend ${trendClass}`;
              // Atualiza o d do path dentro do SVG existente
             const pathElement = svgElement.querySelector('path');
              if (pathElement) {
                 pathElement.setAttribute('d', iconPath);
                 // Ajusta fill/stroke para setas sólidas
                 if (trendClass !== 'neutral') {
                      pathElement.style.fill = 'currentColor';
                      pathElement.style.stroke = 'none';
                 } else {
                      pathElement.style.fill = 'none';
                      pathElement.style.stroke = 'currentColor';
                 }
              }
         };

         updateTrend(currentBalance, lastMonthBalance, 'balance-trend', 'balance-trend-indicator');
         updateTrend(currentMonthIncome, lastMonthIncome, 'income-trend', 'income-trend-indicator');
         updateTrend(currentMonthExpenses, lastMonthExpenses, 'expenses-trend', 'expenses-trend-indicator');
    }


    // ===== Lógica da Análise Mensal =====

    // Modificado para incluir filtro de importância
    async function updateMonthlyAnalysis() {
        if (isUpdatingAnalysis) return;
        isUpdatingAnalysis = true;
        showLoading();

        const selectedMonth = currentAnalysisMonth;
        const selectedYear = currentAnalysisYear;
        const selectedCategory = currentAnalysisCategory;
        const selectedImportance = currentAnalysisImportance; // Usa o novo estado

        const selectedMonthMoment = moment().year(selectedYear).month(selectedMonth);
        const startOfMonth = selectedMonthMoment.startOf('month');
        const endOfMonth = selectedMonthMoment.endOf('month');

        console.log(`Atualizando análise para: ${selectedMonthMoment.format("MMMM YYYY")}, Categoria: ${selectedCategory}, Importância: ${selectedImportance}`);

        try {
            // Filtrar transações para o mês, categoria E importância selecionados
            const monthlyTransactions = transactions.filter(t => {
                const transactionMoment = moment(t.date);
                const isSameMonth = transactionMoment.isBetween(startOfMonth, endOfMonth, 'day', '[]');
                const isSameCategory = (selectedCategory === 'all' || t.category === selectedCategory);
                // Lógica do filtro de importância
                 const isSameImportance = (
                     selectedImportance === 'all' ||
                     (selectedImportance === 'none' && !t.importance) || // Filtra por "Nenhuma"
                     t.importance === selectedImportance
                 );
                return isSameMonth && isSameCategory && isSameImportance; // Adiciona condição de importância
            });

            // ... (Restante da função inalterada: calcular indicadores, renderizar lista, gerar insights, atualizar gráficos) ...
            calculateMonthlyIndicators(monthlyTransactions, selectedMonthMoment);
            renderMonthlyTransactionList(monthlyTransactions);
            generateAndRenderInsights(monthlyTransactions, selectedMonthMoment);
            updateAnalysisCharts(monthlyTransactions);

        } catch (error) {
             console.error("Erro durante a atualização da análise mensal:", error);
             showToast("Ocorreu um erro ao processar os dados da análise.", "danger");
        } finally {
            hideLoading();
            isUpdatingAnalysis = false;
        }
    }


     // Calcular Indicadores (Inalterado - filtros são aplicados antes)
    function calculateMonthlyIndicators(monthlyTransactions, selectedMonthMoment) { /* ... */ }

    // Renderizar Lista de Transações (Adicionado botão de delete)
    function renderMonthlyTransactionList(monthlyTransactions) {
        const listContainer = document.getElementById('analysis-transaction-list');
        const noTransactionsMessage = document.getElementById('analysis-no-transactions');
        listContainer.innerHTML = ''; // Limpa a lista

        if (monthlyTransactions.length === 0) {
            // Usa o elemento existente em vez de recriá-lo
            noTransactionsMessage.style.display = 'block';
            listContainer.appendChild(noTransactionsMessage);
            return;
        }
         noTransactionsMessage.style.display = 'none'; // Esconde mensagem

        monthlyTransactions.forEach(t => {
            const category = categories.find(c => c.id === t.category) || { name: '?', icon: '❓', color: '#8E8E93' };
            const item = document.createElement('div');
            item.className = 'transaction-item';
            // Evento de clique no item abre edição (exceto se clicar no botão delete)
             item.addEventListener('click', (e) => {
                 // Verifica se o clique foi no botão de deletar ou dentro dele
                 if (!e.target.closest('.delete-transaction-btn')) {
                     openTransactionModal(t);
                 }
             });


            const amountPrefix = t.type === 'income' ? '+' : '-';
            const importanceClass = t.importance ? `transaction-importance ${t.importance}` : '';


            item.innerHTML = `
                <div class="transaction-item-left">
                    <div class="transaction-icon" style="background-color: ${category.color};">
                        ${category.icon}
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-description">${t.description || category.name}</div>
                        <div class="transaction-category">${category.name}</div>
                    </div>
                </div>
                <div class="transaction-item-right">
                    <div class="transaction-amount ${t.type}">
                        ${amountPrefix} ${formatCurrency(t.amount)}
                         ${importanceClass ? `<span class="${importanceClass}" title="Importância: ${t.importance}"></span>` : ''}
                    </div>
                    <div class="transaction-date">${formatDate(t.date)}</div>
                </div>
                <button class="delete-transaction-btn" title="Excluir Transação">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>
            `;
             // Adiciona evento ao botão de deletar criado dinamicamente
             item.querySelector('.delete-transaction-btn').addEventListener('click', (e) => {
                 e.stopPropagation(); // Impede que o clique no botão acione o clique no item
                 confirmDeleteTransaction(t.id);
             });

            listContainer.appendChild(item);
        });
    }

    // Gerar e Renderizar Insights (Inalterado)
     function generateAndRenderInsights(monthlyTransactions, selectedMonthMoment) { /* ... */ }

    // ===== Gráficos =====
    // ... (Declarações de overviewCharts, analysisCharts - inalterado) ...
    let overviewCharts = {};
    let analysisCharts = {};
    // ... (getChartCommonOptions, initCharts, updateAllChartsTheme, updateOverviewCharts, updateAnalysisCharts - inalterados) ...
    function getChartCommonOptions(isDarkMode) { /* ... */ }
    function initCharts() { /* ... */ }
    function updateAllChartsTheme() { /* ... */ }
    function updateOverviewCharts() { /* ... */ }
    function updateAnalysisCharts(monthlyTransactions) { /* ... */ }


    // ===== Inicialização da Aplicação =====
    // ... (init, DOMContentLoaded, beforeunload - inalterados) ...
     async function init() { /* ... */ }
     document.addEventListener('DOMContentLoaded', init);
     window.addEventListener('beforeunload', stopFirestoreListeners);

    </script>

</body>
</html>
